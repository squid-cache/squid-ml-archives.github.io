From squid3 at treenet.co.nz  Sat Mar  1 08:31:13 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 1 Mar 2025 21:31:13 +1300
Subject: [squid-users] ACL block_user List
In-Reply-To: <e779fd4812df49b7a72d931274bb6419@hexcel.com>
References: <e779fd4812df49b7a72d931274bb6419@hexcel.com>
Message-ID: <9625900c-019c-412e-b8e3-7d3d2cb91e9c@treenet.co.nz>

On 1/03/25 03:54, Piana, Josh wrote:
> Hello,
> 
> I am attempting to setup an ACL block list based on usernames from a 
> windows AD environment.
> 
> When I have this added to my squid.conf file, all outbound connections 
> stop working:
> 
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
> 
> http_access deny block_user
> 
> I have also tried ?!block_user?.

Was that "NOT MATCHING block_user" condition used with allow or deny action?

What prior or followup http_access lines are processed when that ACL 
check results in "need login" due to lack of username value?

> 
> As you can see, I have it set so if a Windows username is on the 
> ?block_user? list, Squid will deny internet access to that user. 
> Unfortunately, this doesn?t work in practice. I have a working Kerberos 
> back-end setup, handling authentication. What am I doing wrong with this 
> setup?
> 

1) The block_user ACL you have defined is a Regular Expression test 
against the username, not a check of the exact username. So you need to 
be very careful of the specific regex patterns you are using.

(If you want me to check validity, you can post to be directly here, do 
not post actual value to this public list).

2) The block_user ACL implicitly requires authentication to have been 
performed before it can perform its check. Check your auth_param 
settings, and prior proxy_auth type ACL that perform the login.


HTH
Amos

From luhliari at redhat.com  Sun Mar  2 20:47:33 2025
From: luhliari at redhat.com (Lubos Uhliarik)
Date: Sun, 2 Mar 2025 21:47:33 +0100
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
Message-ID: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>

Hello everyone,

We have recently experienced Squid crashes when running Squid in SMP
mode with 16 workers (workers 16). While reviewing the Squid cache
logs, I noticed that assertion failures sometimes occurred (usually
during the shutdown process):

2024/10/16 17:52:44 kid10| Adaptation support is off.
2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: "EX"
2024/10/16 17:52:44 kid7| Squid plugin modules loaded: 0
2024/10/16 17:52:44 kid7| Adaptation support is off.
2024/10/16 17:52:44 kid7| assertion failed: Queue.cc:388: "EX"
2024/10/16 17:52:44 kid4| Finished loading MIME types and icons.
2024/10/16 17:52:44 kid4| HTCP Disabled.
2024/10/16 17:52:44 kid4| Squid plugin modules loaded: 0
2024/10/16 17:52:44 kid4| Adaptation support is off.
2024/10/16 17:52:44 kid4| assertion failed: Queue.cc:388: "EX"
2024/10/16 17:52:44 kid3| Finished loading MIME types and icons.
2024/10/16 17:52:44 kid2| Finished loading MIME types and icons.
2024/10/16 17:52:44 kid5| Finished loading MIME types and icons.
2024/10/16 17:52:45 kid3| HTCP Disabled.
2024/10/16 17:52:45 kid2| HTCP Disabled.
2024/10/16 17:52:45 kid5| HTCP Disabled.
2024/10/16 17:52:45 kid5| Squid plugin modules loaded: 0
2024/10/16 17:52:45 kid5| Adaptation support is off.
2024/10/16 17:52:45 kid2| Squid plugin modules loaded: 0
2024/10/16 17:52:45 kid2| Adaptation support is off.
2024/10/16 17:52:45 kid3| Squid plugin modules loaded: 0
2024/10/16 17:52:45 kid3| Adaptation support is off.
2024/10/16 17:52:45 kid5| assertion failed: Queue.cc:388: "EX"
2024/10/16 17:52:45 kid2| assertion failed: Queue.cc:388: "EX"
2024/10/16 17:52:45 kid3| assertion failed: Queue.cc:388: "EX"

I observed that each "kid" (worker) crashed once, and then Squid
successfully stopped and restarted.

Recently, however, the Squid crashes started occurring during the
start process. The crashes now happen multiple times per worker,
causing Squid to enter a crash loop. This continues until the hard
drive fills up with core dumps:

2025/02/18 10:17:17 kid4| assertion failed: Queue.cc:388: "EX"
2025/02/18 10:17:17 kid10| Current Directory is /
2025/02/18 10:17:17 kid10| Starting Squid Cache version 5.5 for
x86_64-redhat-linux-gnu...
2025/02/18 10:17:17 kid10| Service Name: squid
2025/02/18 10:17:17 kid10| Process ID 18779
2025/02/18 10:17:17 kid10| Process Roles: worker
2025/02/18 10:17:17 kid10| With 65536 file descriptors available
2025/02/18 10:17:17 kid10| Initializing IP Cache...
2025/02/18 10:17:17 kid10| DNS Socket created at [::], FD 13
2025/02/18 10:17:17 kid10| DNS Socket created at 0.0.0.0, FD 14
2025/02/18 10:17:17 kid10| Adding nameserver 127.0.0.1 from squid.conf
2025/02/18 10:17:17 kid10| Logfile: opening log /var/log/squid/access.log
2025/02/18 10:17:17 kid10| WARNING: log name now starts with a module
name. Use 'stdio:/var/log/squid/access.log'
2025/02/18 10:17:17 kid10| Local cache digest enabled; rebuild/rewrite
every 3600/3600 sec
2025/02/18 10:17:17 kid10| Store logging disabled
2025/02/18 10:17:17 kid10| Swap maxSize 0 + 262144 KB, estimated 20164 objects
2025/02/18 10:17:17 kid10| Target number of buckets: 1008
2025/02/18 10:17:17 kid10| Using 8192 Store buckets
2025/02/18 10:17:17 kid10| Max Mem  size: 262144 KB [shared]
2025/02/18 10:17:17 kid10| Max Swap size: 0 KB
2025/02/18 10:17:17 kid10| Using Least Load store dir selection
2025/02/18 10:17:17 kid10| Current Directory is /
2025/02/18 10:17:17 kid10| Finished loading MIME types and icons.
2025/02/18 10:17:17 kid10| HTCP Disabled.
2025/02/18 10:17:17 kid10| Squid plugin modules loaded: 0
2025/02/18 10:17:17 kid10| Adaptation support is off.
2025/02/18 10:17:17 kid10| assertion failed: Queue.cc:388: "EX"
2025/02/18 10:17:17 kid7| Current Directory is /

I investigated the core dump, and the code where Squid is crashing is
as follows:

#0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
Missing separate debuginfos, use: dnf debuginfo-install
glibc-2.34-125.el9_5.1.x86_64 keyutils-libs-1.6.3-1.el9.x86_64
krb5-libs-1.21.1-4.el9_5.x86_64 libcap-2.48-9.el9_2.x86_64
libcom_err-1.46.5-5.el9.x86_64 libecap-1.0.1-10.el9.x86_64
libgcc-11.5.0-2.el9.x86_64 libgcrypt-1.10.0-11.el9.x86_64
libgpg-error-1.42-5.el9.x86_64 libselinux-3.6-1.el9.x86_64
libstdc++-11.5.0-2.el9.x86_64 libtool-ltdl-2.4.6-46.el9.x86_64
libzstd-1.5.1-2.el9.x86_64 lz4-libs-1.9.3-5.el9.x86_64
openssl-libs-3.2.2-6.el9_5.x86_64 pcre2-10.40-6.el9.x86_64
sssd-client-2.9.5-4.el9_5.4.x86_64 systemd-libs-252-46.el9_5.2.x86_64
xz-libs-5.2.5-8.el9_0.x86_64 zlib-1.2.11-40.el9.x86_64
(gdb) bt
#0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
#1  0x00007f77b283e686 in raise () from /lib64/libc.so.6
#2  0x00007f77b2828833 in abort () from /lib64/libc.so.6
#3  0x0000559bbb412a9d in xassert (msg=<optimized out>,
file=<optimized out>, line=<optimized out>) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/debug.cc:624
#4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
this=0x559bbccbf6e0) at ipc/Queue.cc:388
#5  Ipc::MultiQueue::localReader (this=0x559bbccbf6e0) at ipc/Queue.cc:408
#6  0x0000559bbb74c192 in Ipc::BaseMultiQueue::localReader
(this=<optimized out>) at ipc/Queue.cc:195
#7  Ipc::BaseMultiQueue::clearAllReaderSignals (this=<optimized out>)
at ipc/Queue.cc:155
#8  0x0000559bbb486724 in CollapsedForwarding::HandleNewDataAtStart ()
at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/CollapsedForwarding.cc:151
#9  0x0000559bbb6aa50b in AsyncCallQueue::fireNext
(this=this at entry=0x559bbccd18a0) at base/../../src/base/RefCount.h:73
#10 0x0000559bbb6aa89a in AsyncCallQueue::fire (this=0x559bbccd18a0)
at base/AsyncCallQueue.cc:43
#11 0x0000559bbb490da1 in EventLoop::dispatchCalls
(this=0x7fff2d084b90) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:144
#12 EventLoop::runOnce (this=0x7fff2d084b90) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:109
#13 0x0000559bbb5929a8 in EventLoop::run (this=0x7fff2d084b90) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:83
#14 SquidMain (argc=argc at entry=5, argv=argv at entry=0x7fff2d084ea8) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1716
#15 0x0000559bbb436086 in SquidMainSafe (argv=0x7fff2d084ea8, argc=5)
at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1403
#16 main (argc=5, argv=0x7fff2d084ea8) at
/usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1391
(gdb) f 4
#4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
this=0x559bbccbf6e0) at ipc/Queue.cc:388
388        assert(validProcessId(processId));
(gdb) list
383    }
384
385    const Ipc::QueueReader &
386    Ipc::MultiQueue::reader(const int processId) const
387    {
388        assert(validProcessId(processId));
389        const int index = processId - metadata->theProcessIdOffset;
390        return readers->theReaders[index];
391    }
392
(gdb) p processId
$1 = 3
(gdb) p metadata
$15 = {<RefCount<Ipc::Mem::Object<Ipc::MultiQueue::Metadata> >> = {p_
= 0x559bbccd9f30}, <No data fields>} (gdb) p *metadata.p_
$16 = {<Lock> = {_vptr.Lock = 0x559bbb96ea30 <vtable for
Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+64>, count_ = 1},
  _vptr.Object = 0x559bbb96ea08 <vtable for
Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+24>, theSegment = {theFD =
9, theName = {static npos = 18446744073709551615, size_ = 40, len_ =
23,
      static SizeMax_ = 196607, buf_ = 0x559bbccbc460
"/squid-cf__metadata.shm"}, theMem = 0x7f77b3720000, theSize = 8,
theReserved = 0, doUnlink = false}, theObject = 0x7f77b3720000}
(gdb) p metadata.p_->theObject
$17 = (Ipc::MultiQueue::Metadata *) 0x7f77b3720000
(gdb) p *metadata.p_->theObject
$18 = {theProcessCount = 0, theProcessIdOffset = 0}
(gdb) p metadata.p_->theObject->theProcessIdOffset
$19 = 0

>From this investigation, it appears that the theProcessCount and
theProcessIdOffset variables are set to 0. However, I don't think this
is actually the case, as these variables should be shared in SHM, and
the content of those files was not included in the core dump.

Have any of you experienced similar crashes? I was trying to search
for a similar issue but without success.

The backtrace above is from Squid version 5.5. While I understand it
is an older version, I believe the IPC code hasn?t changed much since
then. Unfortunately, we don't have a reproducer or the possibility of
upgrading Squid to a newer version on the running system for testing.

It's also worth noting that after restarting Squid, which was stuck in
the crash loop, Squid started normally. I suspect it could be caused
by uninitialized SHM or something similar. What do you think?

Would it help if I set some debug options and share the output with
you? I was considering something like:

debug_options ALL,1 1,9 54,9

Thanks in advance for your response.

Regards,
Lubos


From botpena at gmail.com  Mon Mar  3 10:44:17 2025
From: botpena at gmail.com (botp)
Date: Mon, 3 Mar 2025 18:44:17 +0800
Subject: [squid-users] web page not updated
Message-ID: <CAAwHHQi6Naqa5y6z1n5KgH3xv66HYxuVyBMLsbq_s5rV+aLdmQ@mail.gmail.com>

if i go to https://www.squid-cache.org/Versions/, the new 7.0.1 version is
listed under Older Versions.

thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250303/fc0cf232/attachment.htm>

From rousskov at measurement-factory.com  Mon Mar  3 14:44:06 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 3 Mar 2025 09:44:06 -0500
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
Message-ID: <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>

On 2025-03-02 15:47, Lubos Uhliarik wrote:


> 2024/10/16 17:52:44 kid10| Adaptation support is off.
> 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: "EX"

Squid v6 has a few changes that affect SMP startup and shutdown 
sequences. Since you have ruled out upgrading to a supported version, I 
would start by turning on shared_memory_locking in hope that the problem 
lies in a problematic OS configuration.

BTW, that bogus exception text "EX" is a bug. It was fixed in Squid v6. 
Squid v5.10 has a backport of that fix (commit 31f20fda).

Alex.


> We have recently experienced Squid crashes when running Squid in SMP
> mode with 16 workers (workers 16). While reviewing the Squid cache
> logs, I noticed that assertion failures sometimes occurred (usually
> during the shutdown process):
> 
> 2024/10/16 17:52:44 kid10| Adaptation support is off.
> 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: "EX"
> 2024/10/16 17:52:44 kid7| Squid plugin modules loaded: 0
> 2024/10/16 17:52:44 kid7| Adaptation support is off.
> 2024/10/16 17:52:44 kid7| assertion failed: Queue.cc:388: "EX"
> 2024/10/16 17:52:44 kid4| Finished loading MIME types and icons.
> 2024/10/16 17:52:44 kid4| HTCP Disabled.
> 2024/10/16 17:52:44 kid4| Squid plugin modules loaded: 0
> 2024/10/16 17:52:44 kid4| Adaptation support is off.
> 2024/10/16 17:52:44 kid4| assertion failed: Queue.cc:388: "EX"
> 2024/10/16 17:52:44 kid3| Finished loading MIME types and icons.
> 2024/10/16 17:52:44 kid2| Finished loading MIME types and icons.
> 2024/10/16 17:52:44 kid5| Finished loading MIME types and icons.
> 2024/10/16 17:52:45 kid3| HTCP Disabled.
> 2024/10/16 17:52:45 kid2| HTCP Disabled.
> 2024/10/16 17:52:45 kid5| HTCP Disabled.
> 2024/10/16 17:52:45 kid5| Squid plugin modules loaded: 0
> 2024/10/16 17:52:45 kid5| Adaptation support is off.
> 2024/10/16 17:52:45 kid2| Squid plugin modules loaded: 0
> 2024/10/16 17:52:45 kid2| Adaptation support is off.
> 2024/10/16 17:52:45 kid3| Squid plugin modules loaded: 0
> 2024/10/16 17:52:45 kid3| Adaptation support is off.
> 2024/10/16 17:52:45 kid5| assertion failed: Queue.cc:388: "EX"
> 2024/10/16 17:52:45 kid2| assertion failed: Queue.cc:388: "EX"
> 2024/10/16 17:52:45 kid3| assertion failed: Queue.cc:388: "EX"
> 
> I observed that each "kid" (worker) crashed once, and then Squid
> successfully stopped and restarted.
> 
> Recently, however, the Squid crashes started occurring during the
> start process. The crashes now happen multiple times per worker,
> causing Squid to enter a crash loop. This continues until the hard
> drive fills up with core dumps:
> 
> 2025/02/18 10:17:17 kid4| assertion failed: Queue.cc:388: "EX"
> 2025/02/18 10:17:17 kid10| Current Directory is /
> 2025/02/18 10:17:17 kid10| Starting Squid Cache version 5.5 for
> x86_64-redhat-linux-gnu...
> 2025/02/18 10:17:17 kid10| Service Name: squid
> 2025/02/18 10:17:17 kid10| Process ID 18779
> 2025/02/18 10:17:17 kid10| Process Roles: worker
> 2025/02/18 10:17:17 kid10| With 65536 file descriptors available
> 2025/02/18 10:17:17 kid10| Initializing IP Cache...
> 2025/02/18 10:17:17 kid10| DNS Socket created at [::], FD 13
> 2025/02/18 10:17:17 kid10| DNS Socket created at 0.0.0.0, FD 14
> 2025/02/18 10:17:17 kid10| Adding nameserver 127.0.0.1 from squid.conf
> 2025/02/18 10:17:17 kid10| Logfile: opening log /var/log/squid/access.log
> 2025/02/18 10:17:17 kid10| WARNING: log name now starts with a module
> name. Use 'stdio:/var/log/squid/access.log'
> 2025/02/18 10:17:17 kid10| Local cache digest enabled; rebuild/rewrite
> every 3600/3600 sec
> 2025/02/18 10:17:17 kid10| Store logging disabled
> 2025/02/18 10:17:17 kid10| Swap maxSize 0 + 262144 KB, estimated 20164 objects
> 2025/02/18 10:17:17 kid10| Target number of buckets: 1008
> 2025/02/18 10:17:17 kid10| Using 8192 Store buckets
> 2025/02/18 10:17:17 kid10| Max Mem  size: 262144 KB [shared]
> 2025/02/18 10:17:17 kid10| Max Swap size: 0 KB
> 2025/02/18 10:17:17 kid10| Using Least Load store dir selection
> 2025/02/18 10:17:17 kid10| Current Directory is /
> 2025/02/18 10:17:17 kid10| Finished loading MIME types and icons.
> 2025/02/18 10:17:17 kid10| HTCP Disabled.
> 2025/02/18 10:17:17 kid10| Squid plugin modules loaded: 0
> 2025/02/18 10:17:17 kid10| Adaptation support is off.
> 2025/02/18 10:17:17 kid10| assertion failed: Queue.cc:388: "EX"
> 2025/02/18 10:17:17 kid7| Current Directory is /
> 
> I investigated the core dump, and the code where Squid is crashing is
> as follows:
> 
> #0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
> Missing separate debuginfos, use: dnf debuginfo-install
> glibc-2.34-125.el9_5.1.x86_64 keyutils-libs-1.6.3-1.el9.x86_64
> krb5-libs-1.21.1-4.el9_5.x86_64 libcap-2.48-9.el9_2.x86_64
> libcom_err-1.46.5-5.el9.x86_64 libecap-1.0.1-10.el9.x86_64
> libgcc-11.5.0-2.el9.x86_64 libgcrypt-1.10.0-11.el9.x86_64
> libgpg-error-1.42-5.el9.x86_64 libselinux-3.6-1.el9.x86_64
> libstdc++-11.5.0-2.el9.x86_64 libtool-ltdl-2.4.6-46.el9.x86_64
> libzstd-1.5.1-2.el9.x86_64 lz4-libs-1.9.3-5.el9.x86_64
> openssl-libs-3.2.2-6.el9_5.x86_64 pcre2-10.40-6.el9.x86_64
> sssd-client-2.9.5-4.el9_5.4.x86_64 systemd-libs-252-46.el9_5.2.x86_64
> xz-libs-5.2.5-8.el9_0.x86_64 zlib-1.2.11-40.el9.x86_64
> (gdb) bt
> #0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
> #1  0x00007f77b283e686 in raise () from /lib64/libc.so.6
> #2  0x00007f77b2828833 in abort () from /lib64/libc.so.6
> #3  0x0000559bbb412a9d in xassert (msg=<optimized out>,
> file=<optimized out>, line=<optimized out>) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/debug.cc:624
> #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
> this=0x559bbccbf6e0) at ipc/Queue.cc:388
> #5  Ipc::MultiQueue::localReader (this=0x559bbccbf6e0) at ipc/Queue.cc:408
> #6  0x0000559bbb74c192 in Ipc::BaseMultiQueue::localReader
> (this=<optimized out>) at ipc/Queue.cc:195
> #7  Ipc::BaseMultiQueue::clearAllReaderSignals (this=<optimized out>)
> at ipc/Queue.cc:155
> #8  0x0000559bbb486724 in CollapsedForwarding::HandleNewDataAtStart ()
> at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/CollapsedForwarding.cc:151
> #9  0x0000559bbb6aa50b in AsyncCallQueue::fireNext
> (this=this at entry=0x559bbccd18a0) at base/../../src/base/RefCount.h:73
> #10 0x0000559bbb6aa89a in AsyncCallQueue::fire (this=0x559bbccd18a0)
> at base/AsyncCallQueue.cc:43
> #11 0x0000559bbb490da1 in EventLoop::dispatchCalls
> (this=0x7fff2d084b90) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:144
> #12 EventLoop::runOnce (this=0x7fff2d084b90) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:109
> #13 0x0000559bbb5929a8 in EventLoop::run (this=0x7fff2d084b90) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:83
> #14 SquidMain (argc=argc at entry=5, argv=argv at entry=0x7fff2d084ea8) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1716
> #15 0x0000559bbb436086 in SquidMainSafe (argv=0x7fff2d084ea8, argc=5)
> at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1403
> #16 main (argc=5, argv=0x7fff2d084ea8) at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1391
> (gdb) f 4
> #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
> this=0x559bbccbf6e0) at ipc/Queue.cc:388
> 388        assert(validProcessId(processId));
> (gdb) list
> 383    }
> 384
> 385    const Ipc::QueueReader &
> 386    Ipc::MultiQueue::reader(const int processId) const
> 387    {
> 388        assert(validProcessId(processId));
> 389        const int index = processId - metadata->theProcessIdOffset;
> 390        return readers->theReaders[index];
> 391    }
> 392
> (gdb) p processId
> $1 = 3
> (gdb) p metadata
> $15 = {<RefCount<Ipc::Mem::Object<Ipc::MultiQueue::Metadata> >> = {p_
> = 0x559bbccd9f30}, <No data fields>} (gdb) p *metadata.p_
> $16 = {<Lock> = {_vptr.Lock = 0x559bbb96ea30 <vtable for
> Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+64>, count_ = 1},
>    _vptr.Object = 0x559bbb96ea08 <vtable for
> Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+24>, theSegment = {theFD =
> 9, theName = {static npos = 18446744073709551615, size_ = 40, len_ =
> 23,
>        static SizeMax_ = 196607, buf_ = 0x559bbccbc460
> "/squid-cf__metadata.shm"}, theMem = 0x7f77b3720000, theSize = 8,
> theReserved = 0, doUnlink = false}, theObject = 0x7f77b3720000}
> (gdb) p metadata.p_->theObject
> $17 = (Ipc::MultiQueue::Metadata *) 0x7f77b3720000
> (gdb) p *metadata.p_->theObject
> $18 = {theProcessCount = 0, theProcessIdOffset = 0}
> (gdb) p metadata.p_->theObject->theProcessIdOffset
> $19 = 0
> 
>  From this investigation, it appears that the theProcessCount and
> theProcessIdOffset variables are set to 0. However, I don't think this
> is actually the case, as these variables should be shared in SHM, and
> the content of those files was not included in the core dump.
> 
> Have any of you experienced similar crashes? I was trying to search
> for a similar issue but without success.
> 
> The backtrace above is from Squid version 5.5. While I understand it
> is an older version, I believe the IPC code hasn?t changed much since
> then. Unfortunately, we don't have a reproducer or the possibility of
> upgrading Squid to a newer version on the running system for testing.
> 
> It's also worth noting that after restarting Squid, which was stuck in
> the crash loop, Squid started normally. I suspect it could be caused
> by uninitialized SHM or something similar. What do you think?
> 
> Would it help if I set some debug options and share the output with
> you? I was considering something like:
> 
> debug_options ALL,1 1,9 54,9
> 
> Thanks in advance for your response.
> 
> Regards,
> Lubos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From doug.tucker at navigaglobal.com  Mon Mar  3 23:57:24 2025
From: doug.tucker at navigaglobal.com (Doug Tucker)
Date: Mon, 3 Mar 2025 23:57:24 +0000
Subject: [squid-users] windows updates
Message-ID: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>

I have read through everything I can find on this subject but still cannot seem to get around the issue of windows updates not working through the squid transparent proxy.  No matter what I try I continue to see this in the cache log and windows update will not connect.

2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)

I tried adding the info from the following doc to no avail.

https://wiki.squid-cache.org/SquidFaq/WindowsUpdate


The relevant parts of my squid.conf:

#Handling HTTPS requests
https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate step2 all

#windows update
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
ssl_bump splice NoSSLIntercept
ssl_bump peek DiscoverSNIHost
ssl_bump bump all

I ran tcpdump and added every url i could find to the allowed-sites.txt and added the 2 sites recommended tot he url.nobump.  If anyone has gotten this to work any help would be appreciated.







Doug Tucker
Sr. Director of Networking and Linux Operations

o: 817.975.5832
e: doug.tucker at navigaglobal.com


Newscycle Solutions is now Naviga. Learn more.


CONFIDENTIALITY NOTICE: The contents of this email message and any attachments are intended solely for the addressee(s) and may contain confidential and/or privileged information and may be legally protected from disclosure. If you are not the intended recipient of this message or their agent, or if this message has been addressed to you in error, please immediately alert the sender by reply email and then delete this message and any attachments. If you are not the intended recipient, you are hereby notified that any use, dissemination, copying, or storage of this message or its attachments is strictly prohibite

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250303/0c332d07/attachment-0001.htm>

From Josh.Piana at hexcel.com  Tue Mar  4 21:42:20 2025
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Tue, 4 Mar 2025 21:42:20 +0000
Subject: [squid-users] ACL block_user List
In-Reply-To: <9625900c-019c-412e-b8e3-7d3d2cb91e9c@treenet.co.nz>
References: <e779fd4812df49b7a72d931274bb6419@hexcel.com>
 <9625900c-019c-412e-b8e3-7d3d2cb91e9c@treenet.co.nz>
Message-ID: <e7fd33c02baa47649f464dc99cb659f1@hexcel.com>

Hey Amos, 

I apologize to show one issue, but now reference another. We decided to not use the "block_user" list as it?s a bit dated. A similar issue is happening now with our "mmedia_users" list. It just doesn't seem to work the way its intended. 

Users on this list are supposed to be allowed special access to sites we typically block. Such as Youtube, Reddit, Facebook, etc. Well as of right now, any changes made to the list don't seem to impact the user having access to those sites or not. 

Here's how we have it written:

# these override the general blacklists by explicitly allowing things
# exempts users from content blocking in this list
acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"

# allow exempted users to the sites in this list
acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"

# allow mmedia user to access a mmedia site, via appropriate protocols
http_access allow mmedia_sites mmedia_users

So if the user is on the "mmedia_users" list, they can access sites that are a part of the "mmedia_sites" list. 





-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Saturday, March 1, 2025 3:31 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] ACL block_user List

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 1/03/25 03:54, Piana, Josh wrote:
> Hello,
>
> I am attempting to setup an ACL block list based on usernames from a 
> windows AD environment.
>
> When I have this added to my squid.conf file, all outbound connections 
> stop working:
>
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>
> http_access deny block_user
>
> I have also tried ?!block_user?.

Was that "NOT MATCHING block_user" condition used with allow or deny action?

What prior or followup http_access lines are processed when that ACL check results in "need login" due to lack of username value?

>
> As you can see, I have it set so if a Windows username is on the 
> ?block_user? list, Squid will deny internet access to that user.
> Unfortunately, this doesn?t work in practice. I have a working 
> Kerberos back-end setup, handling authentication. What am I doing 
> wrong with this setup?
>

1) The block_user ACL you have defined is a Regular Expression test against the username, not a check of the exact username. So you need to be very careful of the specific regex patterns you are using.

(If you want me to check validity, you can post to be directly here, do not post actual value to this public list).

2) The block_user ACL implicitly requires authentication to have been performed before it can perform its check. Check your auth_param settings, and prior proxy_auth type ACL that perform the login.


HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From Josh.Piana at hexcel.com  Tue Mar  4 21:44:05 2025
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Tue, 4 Mar 2025 21:44:05 +0000
Subject: [squid-users] ACL block_user List
References: <e779fd4812df49b7a72d931274bb6419@hexcel.com>
 <9625900c-019c-412e-b8e3-7d3d2cb91e9c@treenet.co.nz> 
Message-ID: <fceb4199a97f40559dcfbbb0325572fe@hexcel.com>

The formatting was messed up in my last e-mail.  

acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
http_access allow mmedia_sites mmedia_users


-----Original Message-----
From: Piana, Josh 
Sent: Tuesday, March 4, 2025 4:42 PM
To: squid-users at lists.squid-cache.org
Subject: RE: [squid-users] ACL block_user List

Hey Amos, 

I apologize to show one issue, but now reference another. We decided to not use the "block_user" list as it?s a bit dated. A similar issue is happening now with our "mmedia_users" list. It just doesn't seem to work the way its intended. 

Users on this list are supposed to be allowed special access to sites we typically block. Such as Youtube, Reddit, Facebook, etc. Well as of right now, any changes made to the list don't seem to impact the user having access to those sites or not. 

Here's how we have it written:

# these override the general blacklists by explicitly allowing things # exempts users from content blocking in this list acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"

# allow exempted users to the sites in this list acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"

# allow mmedia user to access a mmedia site, via appropriate protocols http_access allow mmedia_sites mmedia_users

So if the user is on the "mmedia_users" list, they can access sites that are a part of the "mmedia_sites" list. 





-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Saturday, March 1, 2025 3:31 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] ACL block_user List

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 1/03/25 03:54, Piana, Josh wrote:
> Hello,
>
> I am attempting to setup an ACL block list based on usernames from a 
> windows AD environment.
>
> When I have this added to my squid.conf file, all outbound connections 
> stop working:
>
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>
> http_access deny block_user
>
> I have also tried ?!block_user?.

Was that "NOT MATCHING block_user" condition used with allow or deny action?

What prior or followup http_access lines are processed when that ACL check results in "need login" due to lack of username value?

>
> As you can see, I have it set so if a Windows username is on the 
> ?block_user? list, Squid will deny internet access to that user.
> Unfortunately, this doesn?t work in practice. I have a working 
> Kerberos back-end setup, handling authentication. What am I doing 
> wrong with this setup?
>

1) The block_user ACL you have defined is a Regular Expression test against the username, not a check of the exact username. So you need to be very careful of the specific regex patterns you are using.

(If you want me to check validity, you can post to be directly here, do not post actual value to this public list).

2) The block_user ACL implicitly requires authentication to have been performed before it can perform its check. Check your auth_param settings, and prior proxy_auth type ACL that perform the login.


HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From jonathanlee571 at gmail.com  Wed Mar  5 05:03:15 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 4 Mar 2025 21:03:15 -0800
Subject: [squid-users] ssl_engine
Message-ID: <0FE45949-AD42-44BC-B334-B9DBEB193D50@gmail.com>

Hello fellow Squid Users can you please help?

Does anyone know how to set ssl_engine to use devcrypto for use with a safexcel accelerator?

The example area is empty 

Ref:

Configuration Details:
Option Name:	ssl_engine <>
Replaces:	
Requires:	--with-openssl
Default Value:	none
Suggested Config:	
	The OpenSSL engine to use. You will need to set this if you
	would like to use hardware SSL acceleration for example.

	Not supported in builds with OpenSSL 3.0 or newer.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250304/75c5ca6a/attachment-0001.htm>

From uhlar at fantomas.sk  Wed Mar  5 09:15:44 2025
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 5 Mar 2025 10:15:44 +0100
Subject: [squid-users] ACL block_user List
In-Reply-To: <e7fd33c02baa47649f464dc99cb659f1@hexcel.com>
References: <e779fd4812df49b7a72d931274bb6419@hexcel.com>
 <9625900c-019c-412e-b8e3-7d3d2cb91e9c@treenet.co.nz>
 <e7fd33c02baa47649f464dc99cb659f1@hexcel.com>
Message-ID: <Z8gWQCksdymQgFkF@fantomas.sk>

On 04.03.25 21:42, Piana, Josh wrote:
> I apologize to show one issue, but now reference another.  We decided to 
> not use the "block_user" list as it?s a bit dated.  A similar issue is 
> happening now with our "mmedia_users" list.  It just doesn't seem to work 
> the way its intended.
>
> Users on this list are supposed to be allowed special access to sites we 
> typically block.  Such as Youtube, Reddit, Facebook, etc.  Well as of 
> right now, any changes made to the list don't seem to impact the user 
> having access to those sites or not.
>
>Here's how we have it written:
>
># these override the general blacklists by explicitly allowing things
># exempts users from content blocking in this list
>acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
>
># allow exempted users to the sites in this list
>acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
>
># allow mmedia user to access a mmedia site, via appropriate protocols
>http_access allow mmedia_sites mmedia_users
>
>So if the user is on the "mmedia_users" list, they can access sites that are a part of the "mmedia_sites" list.

And, what is the problem?
I see one possible - you aren't blocking anyone here.
In that case you need to append something like:

http_access deny mmedia_sites 

or perhaps:

http_access deny mmedia_sites !mmedia_users
deny_info http://<explanation> mmedia_users



>On 1/03/25 03:54, Piana, Josh wrote:
>> I am attempting to setup an ACL block list based on usernames from a
>> windows AD environment.
>>
>> When I have this added to my squid.conf file, all outbound connections
>> stop working:
>>
>> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>>
>> http_access deny block_user
>>
>> I have also tried ?!block_user?.

>From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
> Was that "NOT MATCHING block_user" condition used with allow or deny action?
>
> What prior or followup http_access lines are processed when that ACL check results in "need login" due to lack of username value?

>> As you can see, I have it set so if a Windows username is on the
>> ?block_user? list, Squid will deny internet access to that user.
>> Unfortunately, this doesn?t work in practice. I have a working
>> Kerberos back-end setup, handling authentication. What am I doing
>> wrong with this setup?

> 1) The block_user ACL you have defined is a Regular Expression test against 
> the username, not a check of the exact username.  So you need to be very 
> careful of the specific regex patterns you are using.
>
> (If you want me to check validity, you can post to be directly here, do not 
> post actual value to this public list).
>
> 2) The block_user ACL implicitly requires authentication to have been 
> performed before it can perform its check.  Check your auth_param 
> settings, and prior proxy_auth type ACL that perform the login.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
They that can give up essential liberty to obtain a little temporary
safety deserve neither liberty nor safety. -- Benjamin Franklin, 1759

From luhliari at redhat.com  Thu Mar  6 00:16:01 2025
From: luhliari at redhat.com (Lubos Uhliarik)
Date: Thu, 6 Mar 2025 01:16:01 +0100
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
Message-ID: <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>

Hello Alex,

Thanks for your reply!

On Mon, Mar 3, 2025 at 3:44?PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2025-03-02 15:47, Lubos Uhliarik wrote:
>
>
> > 2024/10/16 17:52:44 kid10| Adaptation support is off.
> > 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: "EX"
>
> Squid v6 has a few changes that affect SMP startup and shutdown
> sequences. Since you have ruled out upgrading to a supported version, I
> would start by turning on shared_memory_locking in hope that the problem
> lies in a problematic OS configuration.
>
> BTW, that bogus exception text "EX" is a bug. It was fixed in Squid v6.
> Squid v5.10 has a backport of that fix (commit 31f20fda).
>
>
I was able to resolve the issue, so in case someone encounters the same
backtrace,
here?s what happened:

In the end, we discovered that a customer was running two Squid instances
on the same
machine?one SMP instance with 16 workers and one single-process instance.
For a long
time, the single-process Squid instance would start first by chance,
followed by
the SMP instance, which overwrote the shared memory. However, at some
point,
the SMP instance started first, and when the single-process Squid instance
started
second, it overwrote the SHM memory (resetting theProcessCount to 1) of the
SMP instance, causing it to crash with the mentioned backtrace.

The fix is simple?just specify a service name using the -n Squid parameter
for
one of the Squid instances.

Alex.
>
>
> > We have recently experienced Squid crashes when running Squid in SMP
> > mode with 16 workers (workers 16). While reviewing the Squid cache
> > logs, I noticed that assertion failures sometimes occurred (usually
> > during the shutdown process):
> >
> > 2024/10/16 17:52:44 kid10| Adaptation support is off.
> > 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: "EX"
> > 2024/10/16 17:52:44 kid7| Squid plugin modules loaded: 0
> > 2024/10/16 17:52:44 kid7| Adaptation support is off.
> > 2024/10/16 17:52:44 kid7| assertion failed: Queue.cc:388: "EX"
> > 2024/10/16 17:52:44 kid4| Finished loading MIME types and icons.
> > 2024/10/16 17:52:44 kid4| HTCP Disabled.
> > 2024/10/16 17:52:44 kid4| Squid plugin modules loaded: 0
> > 2024/10/16 17:52:44 kid4| Adaptation support is off.
> > 2024/10/16 17:52:44 kid4| assertion failed: Queue.cc:388: "EX"
> > 2024/10/16 17:52:44 kid3| Finished loading MIME types and icons.
> > 2024/10/16 17:52:44 kid2| Finished loading MIME types and icons.
> > 2024/10/16 17:52:44 kid5| Finished loading MIME types and icons.
> > 2024/10/16 17:52:45 kid3| HTCP Disabled.
> > 2024/10/16 17:52:45 kid2| HTCP Disabled.
> > 2024/10/16 17:52:45 kid5| HTCP Disabled.
> > 2024/10/16 17:52:45 kid5| Squid plugin modules loaded: 0
> > 2024/10/16 17:52:45 kid5| Adaptation support is off.
> > 2024/10/16 17:52:45 kid2| Squid plugin modules loaded: 0
> > 2024/10/16 17:52:45 kid2| Adaptation support is off.
> > 2024/10/16 17:52:45 kid3| Squid plugin modules loaded: 0
> > 2024/10/16 17:52:45 kid3| Adaptation support is off.
> > 2024/10/16 17:52:45 kid5| assertion failed: Queue.cc:388: "EX"
> > 2024/10/16 17:52:45 kid2| assertion failed: Queue.cc:388: "EX"
> > 2024/10/16 17:52:45 kid3| assertion failed: Queue.cc:388: "EX"
> >
> > I observed that each "kid" (worker) crashed once, and then Squid
> > successfully stopped and restarted.
> >
> > Recently, however, the Squid crashes started occurring during the
> > start process. The crashes now happen multiple times per worker,
> > causing Squid to enter a crash loop. This continues until the hard
> > drive fills up with core dumps:
> >
> > 2025/02/18 10:17:17 kid4| assertion failed: Queue.cc:388: "EX"
> > 2025/02/18 10:17:17 kid10| Current Directory is /
> > 2025/02/18 10:17:17 kid10| Starting Squid Cache version 5.5 for
> > x86_64-redhat-linux-gnu...
> > 2025/02/18 10:17:17 kid10| Service Name: squid
> > 2025/02/18 10:17:17 kid10| Process ID 18779
> > 2025/02/18 10:17:17 kid10| Process Roles: worker
> > 2025/02/18 10:17:17 kid10| With 65536 file descriptors available
> > 2025/02/18 10:17:17 kid10| Initializing IP Cache...
> > 2025/02/18 10:17:17 kid10| DNS Socket created at [::], FD 13
> > 2025/02/18 10:17:17 kid10| DNS Socket created at 0.0.0.0, FD 14
> > 2025/02/18 10:17:17 kid10| Adding nameserver 127.0.0.1 from squid.conf
> > 2025/02/18 10:17:17 kid10| Logfile: opening log /var/log/squid/access.log
> > 2025/02/18 10:17:17 kid10| WARNING: log name now starts with a module
> > name. Use 'stdio:/var/log/squid/access.log'
> > 2025/02/18 10:17:17 kid10| Local cache digest enabled; rebuild/rewrite
> > every 3600/3600 sec
> > 2025/02/18 10:17:17 kid10| Store logging disabled
> > 2025/02/18 10:17:17 kid10| Swap maxSize 0 + 262144 KB, estimated 20164
> objects
> > 2025/02/18 10:17:17 kid10| Target number of buckets: 1008
> > 2025/02/18 10:17:17 kid10| Using 8192 Store buckets
> > 2025/02/18 10:17:17 kid10| Max Mem  size: 262144 KB [shared]
> > 2025/02/18 10:17:17 kid10| Max Swap size: 0 KB
> > 2025/02/18 10:17:17 kid10| Using Least Load store dir selection
> > 2025/02/18 10:17:17 kid10| Current Directory is /
> > 2025/02/18 10:17:17 kid10| Finished loading MIME types and icons.
> > 2025/02/18 10:17:17 kid10| HTCP Disabled.
> > 2025/02/18 10:17:17 kid10| Squid plugin modules loaded: 0
> > 2025/02/18 10:17:17 kid10| Adaptation support is off.
> > 2025/02/18 10:17:17 kid10| assertion failed: Queue.cc:388: "EX"
> > 2025/02/18 10:17:17 kid7| Current Directory is /
> >
> > I investigated the core dump, and the code where Squid is crashing is
> > as follows:
> >
> > #0  0x00007f77b288ba6c in __pthread_kill_implementation () from
> /lib64/libc.so.6
> > Missing separate debuginfos, use: dnf debuginfo-install
> > glibc-2.34-125.el9_5.1.x86_64 keyutils-libs-1.6.3-1.el9.x86_64
> > krb5-libs-1.21.1-4.el9_5.x86_64 libcap-2.48-9.el9_2.x86_64
> > libcom_err-1.46.5-5.el9.x86_64 libecap-1.0.1-10.el9.x86_64
> > libgcc-11.5.0-2.el9.x86_64 libgcrypt-1.10.0-11.el9.x86_64
> > libgpg-error-1.42-5.el9.x86_64 libselinux-3.6-1.el9.x86_64
> > libstdc++-11.5.0-2.el9.x86_64 libtool-ltdl-2.4.6-46.el9.x86_64
> > libzstd-1.5.1-2.el9.x86_64 lz4-libs-1.9.3-5.el9.x86_64
> > openssl-libs-3.2.2-6.el9_5.x86_64 pcre2-10.40-6.el9.x86_64
> > sssd-client-2.9.5-4.el9_5.4.x86_64 systemd-libs-252-46.el9_5.2.x86_64
> > xz-libs-5.2.5-8.el9_0.x86_64 zlib-1.2.11-40.el9.x86_64
> > (gdb) bt
> > #0  0x00007f77b288ba6c in __pthread_kill_implementation () from
> /lib64/libc.so.6
> > #1  0x00007f77b283e686 in raise () from /lib64/libc.so.6
> > #2  0x00007f77b2828833 in abort () from /lib64/libc.so.6
> > #3  0x0000559bbb412a9d in xassert (msg=<optimized out>,
> > file=<optimized out>, line=<optimized out>) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/debug.cc:624
> > #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
> > this=0x559bbccbf6e0) at ipc/Queue.cc:388
> > #5  Ipc::MultiQueue::localReader (this=0x559bbccbf6e0) at
> ipc/Queue.cc:408
> > #6  0x0000559bbb74c192 in Ipc::BaseMultiQueue::localReader
> > (this=<optimized out>) at ipc/Queue.cc:195
> > #7  Ipc::BaseMultiQueue::clearAllReaderSignals (this=<optimized out>)
> > at ipc/Queue.cc:155
> > #8  0x0000559bbb486724 in CollapsedForwarding::HandleNewDataAtStart ()
> > at
> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/CollapsedForwarding.cc:151
> > #9  0x0000559bbb6aa50b in AsyncCallQueue::fireNext
> > (this=this at entry=0x559bbccd18a0) at base/../../src/base/RefCount.h:73
> > #10 0x0000559bbb6aa89a in AsyncCallQueue::fire (this=0x559bbccd18a0)
> > at base/AsyncCallQueue.cc:43
> > #11 0x0000559bbb490da1 in EventLoop::dispatchCalls
> > (this=0x7fff2d084b90) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:144
> > #12 EventLoop::runOnce (this=0x7fff2d084b90) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:109
> > #13 0x0000559bbb5929a8 in EventLoop::run (this=0x7fff2d084b90) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:83
> > #14 SquidMain (argc=argc at entry=5, argv=argv at entry=0x7fff2d084ea8) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1716
> > #15 0x0000559bbb436086 in SquidMainSafe (argv=0x7fff2d084ea8, argc=5)
> > at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1403
> > #16 main (argc=5, argv=0x7fff2d084ea8) at
> > /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1391
> > (gdb) f 4
> > #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
> > this=0x559bbccbf6e0) at ipc/Queue.cc:388
> > 388        assert(validProcessId(processId));
> > (gdb) list
> > 383    }
> > 384
> > 385    const Ipc::QueueReader &
> > 386    Ipc::MultiQueue::reader(const int processId) const
> > 387    {
> > 388        assert(validProcessId(processId));
> > 389        const int index = processId - metadata->theProcessIdOffset;
> > 390        return readers->theReaders[index];
> > 391    }
> > 392
> > (gdb) p processId
> > $1 = 3
> > (gdb) p metadata
> > $15 = {<RefCount<Ipc::Mem::Object<Ipc::MultiQueue::Metadata> >> = {p_
> > = 0x559bbccd9f30}, <No data fields>} (gdb) p *metadata.p_
> > $16 = {<Lock> = {_vptr.Lock = 0x559bbb96ea30 <vtable for
> > Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+64>, count_ = 1},
> >    _vptr.Object = 0x559bbb96ea08 <vtable for
> > Ipc::Mem::Object<Ipc::MultiQueue::Metadata>+24>, theSegment = {theFD =
> > 9, theName = {static npos = 18446744073709551615, size_ = 40, len_ =
> > 23,
> >        static SizeMax_ = 196607, buf_ = 0x559bbccbc460
> > "/squid-cf__metadata.shm"}, theMem = 0x7f77b3720000, theSize = 8,
> > theReserved = 0, doUnlink = false}, theObject = 0x7f77b3720000}
> > (gdb) p metadata.p_->theObject
> > $17 = (Ipc::MultiQueue::Metadata *) 0x7f77b3720000
> > (gdb) p *metadata.p_->theObject
> > $18 = {theProcessCount = 0, theProcessIdOffset = 0}
> > (gdb) p metadata.p_->theObject->theProcessIdOffset
> > $19 = 0
> >
> >  From this investigation, it appears that the theProcessCount and
> > theProcessIdOffset variables are set to 0. However, I don't think this
> > is actually the case, as these variables should be shared in SHM, and
> > the content of those files was not included in the core dump.
> >
> > Have any of you experienced similar crashes? I was trying to search
> > for a similar issue but without success.
> >
> > The backtrace above is from Squid version 5.5. While I understand it
> > is an older version, I believe the IPC code hasn?t changed much since
> > then. Unfortunately, we don't have a reproducer or the possibility of
> > upgrading Squid to a newer version on the running system for testing.
> >
> > It's also worth noting that after restarting Squid, which was stuck in
> > the crash loop, Squid started normally. I suspect it could be caused
> > by uninitialized SHM or something similar. What do you think?
> >
> > Would it help if I set some debug options and share the output with
> > you? I was considering something like:
> >
> > debug_options ALL,1 1,9 54,9
> >
> > Thanks in advance for your response.
> >
> > Regards,
> > Lubos
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


Lubos
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250306/6c2f2380/attachment-0001.htm>

From squid3 at treenet.co.nz  Thu Mar  6 00:58:30 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 6 Mar 2025 13:58:30 +1300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
Message-ID: <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>

On 6/03/25 13:16, Lubos Uhliarik wrote:
> 
> In the end, we discovered that a customer was running two Squid 
> instances on the same
> machine?one SMP instance with 16 workers and one single-process 
...
> 
> The fix is simple?just specify a service name using the -n Squid 
> parameter for
> one of the Squid instances.
> 

Please be aware that "squid -n ..." is a REQUIREMENT for running 
multiple Squid instances on the same machine regardless of what features 
are used.

There are a very large number of possible error signs that may (or not) 
be visible if it is omitted.


Cheers
Amos


From squid3 at treenet.co.nz  Thu Mar  6 01:49:16 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 6 Mar 2025 14:49:16 +1300
Subject: [squid-users] ssl_engine
In-Reply-To: <0FE45949-AD42-44BC-B334-B9DBEB193D50@gmail.com>
References: <0FE45949-AD42-44BC-B334-B9DBEB193D50@gmail.com>
Message-ID: <91ad862e-3db9-459b-a0ea-9ad3e53bf516@treenet.co.nz>

[ answering because nobody else has, I have no direct experience with 
that particular setup. ]


On 5/03/25 18:03, Jonathan Lee wrote:
> Hello fellow Squid Users can you please help?
> 
> Does anyone know how to set ssl_engine to use devcrypto for use with a 
> safexcel accelerator?
> 

  ssl_engine devcryptoeng


BUT "ssl_engine" is ...

> 
> 	Not supported in builds with OpenSSL 3.0 or newer.
> 


If your Squid is built for libssl 3.0 or later, you may be able to 
configure /etc/ssl/openssl.cnf default provider to be the one you want. 
Such that Squid does not have to do anything for it to work.


I expect all the details relating to how devcrypto does its thing to be 
configured in /etc/ssl/openssl.cnf.

You may find this discussion from the OpenSSL community helpful:
  <https://github.com/openssl/openssl/issues/10701>

(FTR; the

HTH
Amos

From ankor2023 at gmail.com  Thu Mar  6 06:17:54 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Thu, 6 Mar 2025 09:17:54 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
Message-ID: <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>

Hello,

I have a similar configuration: two SMP squids running on the same OEL host.

They were built with different configurations: with different installation
path prefixes and different names of binary files: squid and squid.user and
they listen to different ports.
They are launched from two different services: squid.service and
squid.user.service with the service Type=forking:

ExecStart=/usr/sbin/squid -sYC
ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf

I have not experienced any troubles with this configuration yet.

*> Please be aware that "squid -n ..." is a REQUIREMENT for running*

*multiple Squid instances on the same machine regardless of what
featuresare used.*

Could you please tell me if I should use the -n option in the ExecStart
strings?
The arguments of the options should be the service names?

ExecStart=/usr/sbin/squid -sYC -n squid.service
ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
squid.user.service



Kind regards,
    Ankor.








??, 6 ???. 2025??. ? 04:07, Amos Jeffries <squid3 at treenet.co.nz>:

> On 6/03/25 13:16, Lubos Uhliarik wrote:
> >
> > In the end, we discovered that a customer was running two Squid
> > instances on the same
> > machine?one SMP instance with 16 workers and one single-process
> ...
> >
> > The fix is simple?just specify a service name using the -n Squid
> > parameter for
> > one of the Squid instances.
> >
>
> Please be aware that "squid -n ..." is a REQUIREMENT for running
> multiple Squid instances on the same machine regardless of what features
> are used.
>
> There are a very large number of possible error signs that may (or not)
> be visible if it is omitted.
>
>
> Cheers
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250306/b69e4933/attachment.htm>

From squid3 at treenet.co.nz  Thu Mar  6 13:59:41 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 7 Mar 2025 02:59:41 +1300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
Message-ID: <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>

On 6/03/25 19:17, Andrey K wrote:
> Hello,
> 
> I have a similar?configuration: two SMP squids running on the same OEL host.
> 
> They were built with different configurations: with different 
> installation path prefixes and different?names of binary files: squid 
> and squid.user and they listen to different ports.
> They are launched?from two different services:squid.service and 
> squid.user.service with the service Type=forking:
> 
>     ExecStart=/usr/sbin/squid -sYC
>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
> 
> I have not experienced any troubles with this configuration yet.
> 
> /> Please be aware that "squid -n ..." is a REQUIREMENT for running/
> /multiple Squid instances on the same machine regardless of what features
> are used./
> 
> Could you please?tell me if I should use the -n option in the ExecStart 
> strings?
> The arguments of the options should be the service names?
> 
>     ExecStart=/usr/sbin/squid -sYC -n squid.service
>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
>     squid.user.service
> 
Yes you should. The different ./configure options has helped you avoid 
major issues, but some may still appear.


Cheers
Amos


From rousskov at measurement-factory.com  Thu Mar  6 14:11:42 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 6 Mar 2025 09:11:42 -0500
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
Message-ID: <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>

On 2025-03-06 08:59, Amos Jeffries wrote:
> On 6/03/25 19:17, Andrey K wrote:
>> Hello,
>>
>> I have a similar?configuration: two SMP squids running on the same OEL 
>> host.
>>
>> They were built with different configurations: with different 
>> installation path prefixes and different?names of binary files: squid 
>> and squid.user and they listen to different ports.
>> They are launched?from two different services:squid.service and 
>> squid.user.service with the service Type=forking:
>>
>> ??? ExecStart=/usr/sbin/squid -sYC
>> ??? ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
>>
>> I have not experienced any troubles with this configuration yet.
>>
>> /> Please be aware that "squid -n ..." is a REQUIREMENT for running/
>> /multiple Squid instances on the same machine regardless of what features
>> are used./
>>
>> Could you please?tell me if I should use the -n option in the 
>> ExecStart strings?
>> The arguments of the options should be the service names?
>>
>> ??? ExecStart=/usr/sbin/squid -sYC -n squid.service
>> ??? ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
>> ??? squid.user.service
>>
> Yes you should. The different ./configure options has helped you avoid 
> major issues, but some may still appear.

I agree. Moreover, I do not understand how your two SMP Squids could 
work correctly without distinct service names because (on OEL) I would 
expect them to share the same shared memory segments (which they must 
not do to remain distinct instances).

What is your Squid version? Can you tell how your Squids name their 
shared memory segment "files"? For example, on some Linux OSes, those 
segments could be in /var/run/shm/ with names like 
squid-tr_map_anchors.shm  and squid-tr_spaces.shm.


Thank you,

Alex.


From ankor2023 at gmail.com  Fri Mar  7 11:50:43 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Fri, 7 Mar 2025 14:50:43 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
Message-ID: <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>

Hello,

Amos, Alex, thanks for the information!

> What is your Squid version?

The first one:
squid -v
Squid Cache: Version 6.13
Service Name: squid

This binary uses OpenSSL 1.1.1k  FIPS 25 Mar 2021. For legal restrictions
on distribution see https://www.openssl.org/source/license.html

configure options:  '--build=x86_64-redhat-linux-gnu'
'--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr'
'--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin'
'--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include'
'--libdir=/usr/lib64' '--libexecdir=/usr/libexec'
'--sharedstatedir=/var/lib' '--mandir=/usr/share/man'
'--infodir=/usr/share/info' '--exec_prefix=/usr'
'--libexecdir=/usr/lib64/squid' '--localstatedir=/var'
'--datadir=/usr/share/squid' '--sysconfdir=/etc/squid'
'--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
'--disable-dependency-tracking' '--enable-follow-x-forwarded-for'
'--enable-auth'
'--enable-auth-basic=DB,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB,getpwnam,fake'
'--enable-auth-ntlm=fake' '--enable-auth-digest=file,LDAP,eDirectory'
'--enable-auth-negotiate=kerberos,wrapper'
'--enable-external-acl-helpers=wbinfo_group,kerberos_ldap_group,LDAP_group,delayer,file_userip,SQL_session,unix_group,session,time_quota'
'--enable-cache-digests' '--enable-cachemgr-hostname=localhost'
'--enable-delay-pools' '--enable-epoll' '--enable-icap-client'
'--enable-ident-lookups' '--enable-linux-netfilter'
'--enable-removal-policies=heap,lru' '--enable-snmp'
'--enable-storeio=aufs,diskd,ufs,rock' '--enable-wccpv2' '--enable-esi'
'--enable-security-cert-generators' '--enable-security-cert-validators'
'--enable-icmp' '--with-aio' '--with-default-user=squid'
'--with-filedescriptors=16384' '--with-dl' '--with-openssl'
'--enable-ssl-crtd' '--with-pthreads' '--with-included-ltdl'
'--disable-arch-native' '--without-nettle'
'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu'
'CFLAGS=-O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2
-Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong
-grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1
-specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic
-fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection'
'LDFLAGS=-Wl,-z,relro  -Wl,-z,now
-specs=/usr/lib/rpm/redhat/redhat-hardened-ld' 'CXXFLAGS=-O2 -g -pipe -Wall
-Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS
-fexceptions -fstack-protector-strong -grecord-gcc-switches
-specs=/usr/lib/rpm/redhat/redhat-hardened-cc1
-specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic
-fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection
-fPIC' 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'
--enable-ltdl-convenience

The second one:
squid.user -v
Squid Cache: Version 6.10
Service Name: squid

This binary uses OpenSSL 1.1.1k  FIPS 25 Mar 2021. For legal restrictions
on distribution see https://www.openssl.org/source/license.html

configure options:  '--build=x86_64-redhat-linux-gnu'
'--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr'
'--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin'
'--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include'
'--libdir=/usr/lib64' '--libexecdir=/usr/libexec' '--localstatedir=/var'
'--sharedstatedir=/var/lib' '--mandir=/usr/share/man'
'--infodir=/usr/share/info' '--prefix=/data/squid.user'
'--exec-prefix=/data/squid.user' '--datadir=/data/squid.user/share'
'--sbindir=/data/squid.user/usr/sbin' '--sysconfdir=/etc/squid.user'
'--libexecdir=/data/squid.user/usr/lib/squid'
'--localstatedir=/data/squid.user/var'
'--with-logdir=/data/squid.user/var/log/squid'
'--with-pidfile=/data/squid.user/var/run/squid.pid'
'--mandir=/data/squid.user/share/man' '--bindir=/data/squid.user/usr/bin'
'--disable-arch-native' '--disable-dependency-tracking'
'--disable-maintainer-mode' '--disable-option-checking'
'--disable-silent-rules' '--disable-translation'
'--disable-strict-error-checking' '--enable-arp-acl' '--enable-async-io=8'
'--enable-auth'
'--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB,SMB_LM'
'--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper'
'--enable-auth-ntlm=SMB_LM,fake' '--enable-cache-digests'
'--enable-cachemgr-hostname=localhost' '--enable-carp'
'--enable-delay-pools' '--enable-ecap' '--enable-epoll' '--enable-esi'
'--enable-eui'
'--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,SQL_session,unix_group,wbinfo_group'
'--enable-follow-x-forwarded-for' '--enable-htcp' '--enable-icap-client'
'--enable-icmp' '--enable-ident-lookups' '--enable-inline'
'--enable-linux-netfilter' '--enable-removal-policies=lru,heap'
'--enable-security-cert-validators=fake'
'--enable-storeid-rewrite-helpers=file'
'--enable-storeio=ufs,aufs,diskd,rock' '--enable-url-rewrite-helpers=fake'
'--enable-zph-qos' '--enable-referer-log'
'--enable-removal-policies=heap,lru' '--enable-security-cert-generators'
'--enable-security-cert-validators' '--enable-snmp' '--enable-ssl-crtd'
'--enable-storeio=aufs,diskd,ufs,rock' '--enable-truncate'
'--enable-useragent-log' '--enable-wccpv2' '--with-aio'
'--with-build-environment=default' '--with-default-user=squid'
'--with-large-files' '--disable-ipv6' '--with-openssl'
'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu'
'CFLAGS=-O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2
-Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong
-grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1
-specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic
-fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection'
'LDFLAGS=-Wl,-z,relro  -Wl,-z,now
-specs=/usr/lib/rpm/redhat/redhat-hardened-ld' 'CXXFLAGS=-O2 -g -pipe -Wall
-Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS
-fexceptions -fstack-protector-strong -grecord-gcc-switches
-specs=/usr/lib/rpm/redhat/redhat-hardened-cc1
-specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic
-fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection'
'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'



> Can you tell how your Squids name their
> shared memory segment "files"? For example, on some Linux OSes,
> those segments could be in /var/run/shm/
> with names like squid-tr_map_anchors.shm  and squid-tr_spaces.shm.

Alex, I can not find these files.
There is no the  /var/run/shm/ directory in my host.
I tried running the "locate .shm" command,  but it did not find anything.

Moreover, I do not see any squid's shared memory segments when I run the "ipcs
-m" command.

There are some files in /dev/shm, which I found using lsof the main squid's
pid:
# the first instance
lsof -p 1318 | grep shm
squid   1318 root  DEL    REG               0,23            30205
/dev/shm/squid-cf__queues.shm
squid   1318 root  DEL    REG               0,23            30206
/dev/shm/squid-cf__readers.shm
squid   1318 root  DEL    REG               0,23            30204
/dev/shm/squid-cf__metadata.shm
squid   1318 root    8u   REG               0,23        8   30204
/dev/shm/squid-cf__metadata.shm (deleted)
squid   1318 root    9u   REG               0,23   525572   30205
/dev/shm/squid-cf__queues.shm (deleted)
squid   1318 root   10u   REG               0,23      136   30206
/dev/shm/squid-cf__readers.shm (deleted)

# the second instance
lsof -p 1514 | grep shm
squid.use 1514 root  mem    REG               0,23   2093368   31497
/dev/shm/squid-tls_session_cache.shm
squid.use 1514 root  mem    REG               0,23    525572   31495
/dev/shm/squid-cf__queues.shm
squid.use 1514 root  mem    REG               0,23       136   31496
/dev/shm/squid-cf__readers.shm
squid.use 1514 root  mem    REG               0,23         8   31494
/dev/shm/squid-cf__metadata.shm
squid.use 1514 root    6u   REG               0,23         8   31494
/dev/shm/squid-cf__metadata.shm
squid.use 1514 root    7u   REG               0,23    525572   31495
/dev/shm/squid-cf__queues.shm
squid.use 1514 root    8u   REG               0,23       136   31496
/dev/shm/squid-cf__readers.shm
squid.use 1514 root    9u   REG               0,23   2093368   31497
/dev/shm/squid-tls_session_cache.shm

Maybe I'm not experiencing any difficulties because I have caching turned off
on both instances?

Kind regards,
     Ankor.









??, 6 ???. 2025??. ? 17:11, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2025-03-06 08:59, Amos Jeffries wrote:
> > On 6/03/25 19:17, Andrey K wrote:
> >> Hello,
> >>
> >> I have a similar configuration: two SMP squids running on the same OEL
> >> host.
> >>
> >> They were built with different configurations: with different
> >> installation path prefixes and different names of binary files: squid
> >> and squid.user and they listen to different ports.
> >> They are launched from two different services:squid.service and
> >> squid.user.service with the service Type=forking:
> >>
> >>     ExecStart=/usr/sbin/squid -sYC
> >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
> >>
> >> I have not experienced any troubles with this configuration yet.
> >>
> >> /> Please be aware that "squid -n ..." is a REQUIREMENT for running/
> >> /multiple Squid instances on the same machine regardless of what
> features
> >> are used./
> >>
> >> Could you please tell me if I should use the -n option in the
> >> ExecStart strings?
> >> The arguments of the options should be the service names?
> >>
> >>     ExecStart=/usr/sbin/squid -sYC -n squid.service
> >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
> >>     squid.user.service
> >>
> > Yes you should. The different ./configure options has helped you avoid
> > major issues, but some may still appear.
>
> I agree. Moreover, I do not understand how your two SMP Squids could
> work correctly without distinct service names because (on OEL) I would
> expect them to share the same shared memory segments (which they must
> not do to remain distinct instances).
>
> What is your Squid version? Can you tell how your Squids name their
> shared memory segment "files"? For example, on some Linux OSes, those
> segments could be in /var/run/shm/ with names like
> squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
>
>
> Thank you,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250307/193fca01/attachment-0001.htm>

From rousskov at measurement-factory.com  Fri Mar  7 14:48:34 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 7 Mar 2025 09:48:34 -0500
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
Message-ID: <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>

On 2025-03-07 06:50, Andrey K wrote:

> Squid Cache: Version 6.13
> Service Name: squid

> Squid Cache: Version 6.10
> Service Name: squid

> # the first instance
> 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
> 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
> 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
> 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm (deleted)
> 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm (deleted)
> 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm (deleted)
> 
> # the second instance
> 1514 mem  ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
> 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
> 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
> 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
> 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
> 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
> 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
> 1514   9u ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm

As suspected, these two Squid instances use the same shared memory 
segments (e.g., /dev/shm/squid-cf*). Such shared use violates critical 
code assumptions and results in undefined behavior.


> Maybe I'm not experiencing any difficulties because I have caching turned off on 
> both instances?

Well, you _are_ experiencing at least one difficulty -- the assertion 
that started this email thread. If you have fully disabled caching, the 
difficulties you experience should not include cache corruption. 
However, it looks like at least one of the two instances does cache TLS 
sessions (in /dev/shm/squid-tls_session_cache.shm). If both instances do 
that, then all bets are off!


FWIW, related future Squid improvements may include:

* Detecting such shared memory segments clashes; refusing to start.
* Disabling shared memory use when caching is completely disabled.

Quality pull requests welcome.


Cheers,

Alex.


> ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
> 
>     On 2025-03-06 08:59, Amos Jeffries wrote:
>      > On 6/03/25 19:17, Andrey K wrote:
>      >> Hello,
>      >>
>      >> I have a similar?configuration: two SMP squids running on the
>     same OEL
>      >> host.
>      >>
>      >> They were built with different configurations: with different
>      >> installation path prefixes and different?names of binary files:
>     squid
>      >> and squid.user and they listen to different ports.
>      >> They are launched?from two different services:squid.service and
>      >> squid.user.service with the service Type=forking:
>      >>
>      >> ??? ExecStart=/usr/sbin/squid -sYC
>      >> ??? ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
>      >>
>      >> I have not experienced any troubles with this configuration yet.
>      >>
>      >> /> Please be aware that "squid -n ..." is a REQUIREMENT for running/
>      >> /multiple Squid instances on the same machine regardless of what
>     features
>      >> are used./
>      >>
>      >> Could you please?tell me if I should use the -n option in the
>      >> ExecStart strings?
>      >> The arguments of the options should be the service names?
>      >>
>      >> ??? ExecStart=/usr/sbin/squid -sYC -n squid.service
>      >> ??? ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
>      >> ??? squid.user.service
>      >>
>      > Yes you should. The different ./configure options has helped you
>     avoid
>      > major issues, but some may still appear.
> 
>     I agree. Moreover, I do not understand how your two SMP Squids could
>     work correctly without distinct service names because (on OEL) I would
>     expect them to share the same shared memory segments (which they must
>     not do to remain distinct instances).
> 
>     What is your Squid version? Can you tell how your Squids name their
>     shared memory segment "files"? For example, on some Linux OSes, those
>     segments could be in /var/run/shm/ with names like
>     squid-tr_map_anchors.shm? and squid-tr_spaces.shm.
> 
> 
>     Thank you,
> 
>     Alex.
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 


From ankor2023 at gmail.com  Sat Mar  8 05:14:26 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Sat, 8 Mar 2025 08:14:26 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
Message-ID: <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>

Hello Alex,

Thanks for the analysis.
Squid only allows alphanumeric characters in the service name, so it refuses
to use the original service name in the -n option (-n squid.user.service).
I added -n squiduser option to the ExecStart string of the second instance.
Now it looks good:

# the first instance
lsof -p 3746105 | grep shm
squid   3746105 root  mem    REG               0,23   525572 1213614834
/dev/shm/squid-cf__queues.shm
squid   3746105 root  mem    REG               0,23      136 1213614835
/dev/shm/squid-cf__readers.shm
squid   3746105 root  mem    REG               0,23        8 1213614833
/dev/shm/squid-cf__metadata.shm
squid   3746105 root    7u   REG               0,23        8 1213614833
/dev/shm/squid-cf__metadata.shm
squid   3746105 root    8u   REG               0,23   525572 1213614834
/dev/shm/squid-cf__queues.shm
squid   3746105 root    9u   REG               0,23      136 1213614835
/dev/shm/squid-cf__readers.shm

# the second instance
lsof -p 3685356 | grep shm
squid.use 3685356 root  mem    REG               0,23   2093368 1212704041
/dev/shm/squiduser-tls_session_cache.shm
squid.use 3685356 root  mem    REG               0,23    525572 1212704039
/dev/shm/squiduser-cf__queues.shm
squid.use 3685356 root  mem    REG               0,23       136 1212704040
/dev/shm/squiduser-cf__readers.shm
squid.use 3685356 root  mem    REG               0,23         8 1212704038
/dev/shm/squiduser-cf__metadata.shm
squid.use 3685356 root    6u   REG               0,23         8 1212704038
/dev/shm/squiduser-cf__metadata.shm
squid.use 3685356 root    7u   REG               0,23    525572 1212704039
/dev/shm/squiduser-cf__queues.shm
squid.use 3685356 root    8u   REG               0,23       136 1212704040
/dev/shm/squiduser-cf__readers.shm
squid.use 3685356 root    9u   REG               0,23   2093368 1212704041
/dev/shm/squiduser-tls_session_cache.shm

Kind regards,
     Ankor.





??, 7 ???. 2025??. ? 17:48, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2025-03-07 06:50, Andrey K wrote:
>
> > Squid Cache: Version 6.13
> > Service Name: squid
>
> > Squid Cache: Version 6.10
> > Service Name: squid
>
> > # the first instance
> > 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
> > 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
> > 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
> > 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm (deleted)
> > 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm (deleted)
> > 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm (deleted)
> >
> > # the second instance
> > 1514 mem  ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
> > 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
> > 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
> > 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
> > 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
> > 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
> > 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
> > 1514   9u ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
>
> As suspected, these two Squid instances use the same shared memory
> segments (e.g., /dev/shm/squid-cf*). Such shared use violates critical
> code assumptions and results in undefined behavior.
>
>
> > Maybe I'm not experiencing any difficulties because I have caching
> turned off on
> > both instances?
>
> Well, you _are_ experiencing at least one difficulty -- the assertion
> that started this email thread. If you have fully disabled caching, the
> difficulties you experience should not include cache corruption.
> However, it looks like at least one of the two instances does cache TLS
> sessions (in /dev/shm/squid-tls_session_cache.shm). If both instances do
> that, then all bets are off!
>
>
> FWIW, related future Squid improvements may include:
>
> * Detecting such shared memory segments clashes; refusing to start.
> * Disabling shared memory use when caching is completely disabled.
>
> Quality pull requests welcome.
>
>
> Cheers,
>
> Alex.
>
>
> > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
> >
> >     On 2025-03-06 08:59, Amos Jeffries wrote:
> >      > On 6/03/25 19:17, Andrey K wrote:
> >      >> Hello,
> >      >>
> >      >> I have a similar configuration: two SMP squids running on the
> >     same OEL
> >      >> host.
> >      >>
> >      >> They were built with different configurations: with different
> >      >> installation path prefixes and different names of binary files:
> >     squid
> >      >> and squid.user and they listen to different ports.
> >      >> They are launched from two different services:squid.service and
> >      >> squid.user.service with the service Type=forking:
> >      >>
> >      >>     ExecStart=/usr/sbin/squid -sYC
> >      >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
> >      >>
> >      >> I have not experienced any troubles with this configuration yet.
> >      >>
> >      >> /> Please be aware that "squid -n ..." is a REQUIREMENT for
> running/
> >      >> /multiple Squid instances on the same machine regardless of what
> >     features
> >      >> are used./
> >      >>
> >      >> Could you please tell me if I should use the -n option in the
> >      >> ExecStart strings?
> >      >> The arguments of the options should be the service names?
> >      >>
> >      >>     ExecStart=/usr/sbin/squid -sYC -n squid.service
> >      >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
> >      >>     squid.user.service
> >      >>
> >      > Yes you should. The different ./configure options has helped you
> >     avoid
> >      > major issues, but some may still appear.
> >
> >     I agree. Moreover, I do not understand how your two SMP Squids could
> >     work correctly without distinct service names because (on OEL) I
> would
> >     expect them to share the same shared memory segments (which they must
> >     not do to remain distinct instances).
> >
> >     What is your Squid version? Can you tell how your Squids name their
> >     shared memory segment "files"? For example, on some Linux OSes, those
> >     segments could be in /var/run/shm/ with names like
> >     squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
> >
> >
> >     Thank you,
> >
> >     Alex.
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250308/94f6d5ab/attachment-0001.htm>

From ankor2023 at gmail.com  Tue Mar 11 03:56:20 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 11 Mar 2025 06:56:20 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
 <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
Message-ID: <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>

Hello,

>  FWIW, related future Squid improvements may include:

>  * Detecting such shared memory segments clashes; refusing to start.
>  * Disabling shared memory use when caching is completely disabled.

>  Quality pull requests welcome.

I looked at the source code and found the detection of the presence of old
shared memory segments ("src/ipc/mem/Segment.cc"):
void
Ipc::Mem::Segment::create(const off_t aSize)
{
    assert(aSize > 0);
    assert(theFD < 0);

    int xerrno = 0;

    // Why a brand new segment? A Squid crash may leave a reusable segment,
but
    // our placement-new code requires an all-0s segment. We could truncate
and
    // resize the old segment, but OS X does not allow using O_TRUNC with
    // shm_open() and does not support ftruncate() for old segments.
    if (!createFresh(xerrno) && xerrno == EEXIST) {
        unlink();
        createFresh(xerrno);
    }

But, as the comment says, the segments may remain from the previous Squid
crash. Thus, in my opinion, it is impractical to refuse to launch the
program. I think it's enough to put a warning in the code when detecting
old segments.
Something like that:
void
Ipc::Mem::Segment::create(const off_t aSize)
{
    assert(aSize > 0);
    assert(theFD < 0);

    int xerrno = 0;

    // Why a brand new segment? A Squid crash may leave a reusable segment,
but
    // our placement-new code requires an all-0s segment. We could truncate
and
    // resize the old segment, but OS X does not allow using O_TRUNC with
    // shm_open() and does not support ftruncate() for old segments.
    if (!createFresh(xerrno) && xerrno == EEXIST) {
        *debugs(54, DBG_CRITICAL, "WARNING: there is an old shared memory
segment: '" << theName << "'. Perhaps it was left after the previous crash
of the Squid. We will remove it. Or it may be a sign that another instance
of the Squid is running.  In this case, you must launch the program with
the -n option and specify the unique name of the service.");*
        unlink();
        createFresh(xerrno);
    }
Kind regards,
Ankor.


??, 8 ???. 2025??. ? 08:14, Andrey K <ankor2023 at gmail.com>:

> Hello Alex,
>
> Thanks for the analysis.
> Squid only allows alphanumeric characters in the service name, so it
> refuses to use the original service name in the -n option (-n
> squid.user.service).
> I added -n squiduser option to the ExecStart string of the second
> instance.
> Now it looks good:
>
> # the first instance
> lsof -p 3746105 | grep shm
> squid   3746105 root  mem    REG               0,23   525572 1213614834
> /dev/shm/squid-cf__queues.shm
> squid   3746105 root  mem    REG               0,23      136 1213614835
> /dev/shm/squid-cf__readers.shm
> squid   3746105 root  mem    REG               0,23        8 1213614833
> /dev/shm/squid-cf__metadata.shm
> squid   3746105 root    7u   REG               0,23        8 1213614833
> /dev/shm/squid-cf__metadata.shm
> squid   3746105 root    8u   REG               0,23   525572 1213614834
> /dev/shm/squid-cf__queues.shm
> squid   3746105 root    9u   REG               0,23      136 1213614835
> /dev/shm/squid-cf__readers.shm
>
> # the second instance
> lsof -p 3685356 | grep shm
> squid.use 3685356 root  mem    REG               0,23   2093368 1212704041
> /dev/shm/squiduser-tls_session_cache.shm
> squid.use 3685356 root  mem    REG               0,23    525572 1212704039
> /dev/shm/squiduser-cf__queues.shm
> squid.use 3685356 root  mem    REG               0,23       136 1212704040
> /dev/shm/squiduser-cf__readers.shm
> squid.use 3685356 root  mem    REG               0,23         8 1212704038
> /dev/shm/squiduser-cf__metadata.shm
> squid.use 3685356 root    6u   REG               0,23         8 1212704038
> /dev/shm/squiduser-cf__metadata.shm
> squid.use 3685356 root    7u   REG               0,23    525572 1212704039
> /dev/shm/squiduser-cf__queues.shm
> squid.use 3685356 root    8u   REG               0,23       136 1212704040
> /dev/shm/squiduser-cf__readers.shm
> squid.use 3685356 root    9u   REG               0,23   2093368 1212704041
> /dev/shm/squiduser-tls_session_cache.shm
>
> Kind regards,
>      Ankor.
>
>
>
>
>
> ??, 7 ???. 2025??. ? 17:48, Alex Rousskov <
> rousskov at measurement-factory.com>:
>
>> On 2025-03-07 06:50, Andrey K wrote:
>>
>> > Squid Cache: Version 6.13
>> > Service Name: squid
>>
>> > Squid Cache: Version 6.10
>> > Service Name: squid
>>
>> > # the first instance
>> > 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
>> > 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
>> > 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
>> > 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm (deleted)
>> > 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm (deleted)
>> > 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm (deleted)
>> >
>> > # the second instance
>> > 1514 mem  ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
>> > 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
>> > 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
>> > 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
>> > 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
>> > 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
>> > 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
>> > 1514   9u ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
>>
>> As suspected, these two Squid instances use the same shared memory
>> segments (e.g., /dev/shm/squid-cf*). Such shared use violates critical
>> code assumptions and results in undefined behavior.
>>
>>
>> > Maybe I'm not experiencing any difficulties because I have caching
>> turned off on
>> > both instances?
>>
>> Well, you _are_ experiencing at least one difficulty -- the assertion
>> that started this email thread. If you have fully disabled caching, the
>> difficulties you experience should not include cache corruption.
>> However, it looks like at least one of the two instances does cache TLS
>> sessions (in /dev/shm/squid-tls_session_cache.shm). If both instances do
>> that, then all bets are off!
>>
>>
>> FWIW, related future Squid improvements may include:
>>
>> * Detecting such shared memory segments clashes; refusing to start.
>> * Disabling shared memory use when caching is completely disabled.
>>
>> Quality pull requests welcome.
>>
>>
>> Cheers,
>>
>> Alex.
>>
>>
>> > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
>> >
>> >     On 2025-03-06 08:59, Amos Jeffries wrote:
>> >      > On 6/03/25 19:17, Andrey K wrote:
>> >      >> Hello,
>> >      >>
>> >      >> I have a similar configuration: two SMP squids running on the
>> >     same OEL
>> >      >> host.
>> >      >>
>> >      >> They were built with different configurations: with different
>> >      >> installation path prefixes and different names of binary files:
>> >     squid
>> >      >> and squid.user and they listen to different ports.
>> >      >> They are launched from two different services:squid.service and
>> >      >> squid.user.service with the service Type=forking:
>> >      >>
>> >      >>     ExecStart=/usr/sbin/squid -sYC
>> >      >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
>> >      >>
>> >      >> I have not experienced any troubles with this configuration yet.
>> >      >>
>> >      >> /> Please be aware that "squid -n ..." is a REQUIREMENT for
>> running/
>> >      >> /multiple Squid instances on the same machine regardless of what
>> >     features
>> >      >> are used./
>> >      >>
>> >      >> Could you please tell me if I should use the -n option in the
>> >      >> ExecStart strings?
>> >      >> The arguments of the options should be the service names?
>> >      >>
>> >      >>     ExecStart=/usr/sbin/squid -sYC -n squid.service
>> >      >>     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
>> >      >>     squid.user.service
>> >      >>
>> >      > Yes you should. The different ./configure options has helped you
>> >     avoid
>> >      > major issues, but some may still appear.
>> >
>> >     I agree. Moreover, I do not understand how your two SMP Squids could
>> >     work correctly without distinct service names because (on OEL) I
>> would
>> >     expect them to share the same shared memory segments (which they
>> must
>> >     not do to remain distinct instances).
>> >
>> >     What is your Squid version? Can you tell how your Squids name their
>> >     shared memory segment "files"? For example, on some Linux OSes,
>> those
>> >     segments could be in /var/run/shm/ with names like
>> >     squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
>> >
>> >
>> >     Thank you,
>> >
>> >     Alex.
>> >
>> >     _______________________________________________
>> >     squid-users mailing list
>> >     squid-users at lists.squid-cache.org
>> >     <mailto:squid-users at lists.squid-cache.org>
>> >     https://lists.squid-cache.org/listinfo/squid-users
>> >     <https://lists.squid-cache.org/listinfo/squid-users>
>> >
>>
>>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250311/ef6812c0/attachment-0001.htm>

From rousskov at measurement-factory.com  Tue Mar 11 14:05:52 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 11 Mar 2025 10:05:52 -0400
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
 <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
 <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>
Message-ID: <85daf4e4-4387-4509-90a1-f229f17f6d34@measurement-factory.com>

On 2025-03-10 23:56, Andrey K wrote:

>  >?Alex: FWIW, related future Squid improvements may include:
>  >? * Detecting such shared memory segments clashes; refusing to start.
>  >? * Disabling shared memory use when caching is completely disabled.

> But ... segments may remain from the previous 
> Squid crash. Thus, in my opinion, it is impractical to refuse to launch 
> the program.

"Squid should overwrite segments left by a crashed Squid" does not imply 
that "detecting segment clashes among independent Squid instances is 
impractical".

The following rough examples are _not_ implementation blueprints, but 
they illustrate the lack of the above implication:

A. If Squid were to incorporate PID filename[^1] into segment names, 
then segments from different Squid instances will not clash.

B. If Squid were to write its PID filename[^1] into a shared memory 
segment, then Squid would be able to detect that another running 
instance is using the same shared memory segment (while still 
overwriting segments left by an earlier crash).


[^1]: Full Squid PID filename are already guaranteed to be unique across 
Squid instances that may overwrite each other segments because Squid 
refuses to start if another Squid instance is using its PID file. The 
only red flag I can think of here is esoteric chrooted instances, but I 
would not be surprised if those instances cannot share segments.


> I think it's enough to put a warning in the code when detecting old
> segments.

I disagree that a level-0 warning during regular/uneventful startups is 
a good idea, especially if there will be one warning for every segment. 
We should try to address the actual problem (i.e. refuse to start a 
segment-clashing concurrent instance) rather than allowing clashes but 
adding a yet another warning about a usually benign event.

Alex.


> Something like that:
> void
> Ipc::Mem::Segment::create(const off_t aSize)
> {
>  ? ? assert(aSize > 0);
>  ? ? assert(theFD < 0);
> 
>  ? ? int xerrno = 0;
> 
>  ? ? // Why a brand new segment? A Squid crash may leave a reusable 
> segment, but
>  ? ? // our placement-new code requires an all-0s segment. We could 
> truncate and
>  ? ? // resize the old segment, but OS X does not allow using O_TRUNC with
>  ? ? // shm_open() and does not support ftruncate() for old segments.
>  ? ? if (!createFresh(xerrno) && xerrno == EEXIST) {
> *debugs(54, DBG_CRITICAL, "WARNING: there is an old shared memory 
> segment: '" << theName << "'. Perhaps it was left after the previous 
> crash of the Squid. We will remove it. Or it may be a sign that another 
> instance of the Squid is running.? In this case, you must launch the 
> program with the -n option and specify the unique name of the service.");*
>  ? ? ? ? unlink();
>  ? ? ? ? createFresh(xerrno);
>  ? ? }
> Kind regards,
> Ankor.
> 
> 
> ??, 8 ???. 2025??. ? 08:14, Andrey K <ankor2023 at gmail.com 
> <mailto:ankor2023 at gmail.com>>:
> 
>     Hello Alex,
> 
>     Thanks for the analysis.
>     Squidonlyallowsalphanumericcharactersinthe servicename,
>     soitrefusesto usethe originalservice namein the -n option (-n
>     squid.user.service).
>     I added-n squiduser?option to the ExecStart string of the second
>     instance.
>     Now it looks good:
> 
>     # the first instance
>     lsof -p 3746105 | grep shm
>     squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? 525572
>     1213614834 /dev/shm/squid-cf__queues.shm
>     squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ?136
>     1213614835 /dev/shm/squid-cf__readers.shm
>     squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ? ?8
>     1213614833 /dev/shm/squid-cf__metadata.shm
>     squid ? 3746105 root ? ?7u ? REG ? ? ? ? ? ? ? 0,23 ? ? ? ?8
>     1213614833 /dev/shm/squid-cf__metadata.shm
>     squid ? 3746105 root ? ?8u ? REG ? ? ? ? ? ? ? 0,23 ? 525572
>     1213614834 /dev/shm/squid-cf__queues.shm
>     squid ? 3746105 root ? ?9u ? REG ? ? ? ? ? ? ? 0,23 ? ? ?136
>     1213614835 /dev/shm/squid-cf__readers.shm
> 
>     # the second instance
>     lsof -p 3685356 | grep shm
>     squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? 2093368
>     1212704041 /dev/shm/squiduser-tls_session_cache.shm
>     squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ?525572
>     1212704039 /dev/shm/squiduser-cf__queues.shm
>     squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ? 136
>     1212704040 /dev/shm/squiduser-cf__readers.shm
>     squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ? ? 8
>     1212704038 /dev/shm/squiduser-cf__metadata.shm
>     squid.use 3685356 root ? ?6u ? REG ? ? ? ? ? ? ? 0,23 ? ? ? ? 8
>     1212704038 /dev/shm/squiduser-cf__metadata.shm
>     squid.use 3685356 root ? ?7u ? REG ? ? ? ? ? ? ? 0,23 ? ?525572
>     1212704039 /dev/shm/squiduser-cf__queues.shm
>     squid.use 3685356 root ? ?8u ? REG ? ? ? ? ? ? ? 0,23 ? ? ? 136
>     1212704040 /dev/shm/squiduser-cf__readers.shm
>     squid.use 3685356 root ? ?9u ? REG ? ? ? ? ? ? ? 0,23 ? 2093368
>     1212704041 /dev/shm/squiduser-tls_session_cache.shm
> 
>     Kind regards,
>      ? ? ?Ankor.
> 
> 
> 
> 
> 
>     ??, 7 ???. 2025??. ? 17:48, Alex Rousskov
>     <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>:
> 
>         On 2025-03-07 06:50, Andrey K wrote:
> 
>          > Squid Cache: Version 6.13
>          > Service Name: squid
> 
>          > Squid Cache: Version 6.10
>          > Service Name: squid
> 
>          > # the first instance
>          > 1318 DEL? ...? ? ? ? ? 30205 /dev/shm/squid-cf__queues.shm
>          > 1318 DEL? ...? ? ? ? ? 30206 /dev/shm/squid-cf__readers.shm
>          > 1318 DEL? ...? ? ? ? ? 30204 /dev/shm/squid-cf__metadata.shm
>          > 1318? ?8u ...? ? ? 8? ?30204 /dev/shm/squid-cf__metadata.shm
>         (deleted)
>          > 1318? ?9u ... 525572? ?30205 /dev/shm/squid-cf__queues.shm
>         (deleted)
>          > 1318? 10u ...? ? 136? ?30206 /dev/shm/squid-cf__readers.shm
>         (deleted)
>          >
>          > # the second instance
>          > 1514 mem? ... 2093368? ?31497
>         /dev/shm/squid-tls_session_cache.shm
>          > 1514 mem? ...? 525572? ?31495 /dev/shm/squid-cf__queues.shm
>          > 1514 mem? ...? ? ?136? ?31496 /dev/shm/squid-cf__readers.shm
>          > 1514 mem? ...? ? ? ?8? ?31494 /dev/shm/squid-cf__metadata.shm
>          > 1514? ?6u ...? ? ? ?8? ?31494 /dev/shm/squid-cf__metadata.shm
>          > 1514? ?7u ...? 525572? ?31495 /dev/shm/squid-cf__queues.shm
>          > 1514? ?8u ...? ? ?136? ?31496 /dev/shm/squid-cf__readers.shm
>          > 1514? ?9u ... 2093368? ?31497
>         /dev/shm/squid-tls_session_cache.shm
> 
>         As suspected, these two Squid instances use the same shared memory
>         segments (e.g., /dev/shm/squid-cf*). Such shared use violates
>         critical
>         code assumptions and results in undefined behavior.
> 
> 
>          > Maybe I'm not experiencing any difficulties because I have
>         caching turned off on
>          > both instances?
> 
>         Well, you _are_ experiencing at least one difficulty -- the
>         assertion
>         that started this email thread. If you have fully disabled
>         caching, the
>         difficulties you experience should not include cache corruption.
>         However, it looks like at least one of the two instances does
>         cache TLS
>         sessions (in /dev/shm/squid-tls_session_cache.shm). If both
>         instances do
>         that, then all bets are off!
> 
> 
>         FWIW, related future Squid improvements may include:
> 
>         * Detecting such shared memory segments clashes; refusing to start.
>         * Disabling shared memory use when caching is completely disabled.
> 
>         Quality pull requests welcome.
> 
> 
>         Cheers,
> 
>         Alex.
> 
> 
>          > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
>          >
>          >? ? ?On 2025-03-06 08:59, Amos Jeffries wrote:
>          >? ? ? > On 6/03/25 19:17, Andrey K wrote:
>          >? ? ? >> Hello,
>          >? ? ? >>
>          >? ? ? >> I have a similar?configuration: two SMP squids
>         running on the
>          >? ? ?same OEL
>          >? ? ? >> host.
>          >? ? ? >>
>          >? ? ? >> They were built with different configurations: with
>         different
>          >? ? ? >> installation path prefixes and different?names of
>         binary files:
>          >? ? ?squid
>          >? ? ? >> and squid.user and they listen to different ports.
>          >? ? ? >> They are launched?from two different
>         services:squid.service and
>          >? ? ? >> squid.user.service with the service Type=forking:
>          >? ? ? >>
>          >? ? ? >> ??? ExecStart=/usr/sbin/squid -sYC
>          >? ? ? >> ??? ExecStart=/sbin/squid.user -f
>         /etc/squid.user/squid.conf
>          >? ? ? >>
>          >? ? ? >> I have not experienced any troubles with this
>         configuration yet.
>          >? ? ? >>
>          >? ? ? >> /> Please be aware that "squid -n ..." is a
>         REQUIREMENT for running/
>          >? ? ? >> /multiple Squid instances on the same machine
>         regardless of what
>          >? ? ?features
>          >? ? ? >> are used./
>          >? ? ? >>
>          >? ? ? >> Could you please?tell me if I should use the -n
>         option in the
>          >? ? ? >> ExecStart strings?
>          >? ? ? >> The arguments of the options should be the service names?
>          >? ? ? >>
>          >? ? ? >> ??? ExecStart=/usr/sbin/squid -sYC -n squid.service
>          >? ? ? >> ??? ExecStart=/sbin/squid.user -f
>         /etc/squid.user/squid.conf -n
>          >? ? ? >> ??? squid.user.service
>          >? ? ? >>
>          >? ? ? > Yes you should. The different ./configure options has
>         helped you
>          >? ? ?avoid
>          >? ? ? > major issues, but some may still appear.
>          >
>          >? ? ?I agree. Moreover, I do not understand how your two SMP
>         Squids could
>          >? ? ?work correctly without distinct service names because (on
>         OEL) I would
>          >? ? ?expect them to share the same shared memory segments
>         (which they must
>          >? ? ?not do to remain distinct instances).
>          >
>          >? ? ?What is your Squid version? Can you tell how your Squids
>         name their
>          >? ? ?shared memory segment "files"? For example, on some Linux
>         OSes, those
>          >? ? ?segments could be in /var/run/shm/ with names like
>          >? ? ?squid-tr_map_anchors.shm? and squid-tr_spaces.shm.
>          >
>          >
>          >? ? ?Thank you,
>          >
>          >? ? ?Alex.
>          >
>          >? ? ?_______________________________________________
>          >? ? ?squid-users mailing list
>          > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>
>          > https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>>
>          >
> 


From ankor2023 at gmail.com  Tue Mar 11 14:40:46 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 11 Mar 2025 17:40:46 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <85daf4e4-4387-4509-90a1-f229f17f6d34@measurement-factory.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
 <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
 <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>
 <85daf4e4-4387-4509-90a1-f229f17f6d34@measurement-factory.com>
Message-ID: <CADJd0Y3F7E142=Tp3CaRuEfLzL1Z7Ky3okWKy-SmGFYMNbcS0g@mail.gmail.com>

Hello Alex,

Thank you for sharing your thoughts.
The A-example looks easier to implement and more reliable.

Kind regards,
      Ankor.

??, 11 ???. 2025??. ? 17:12, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2025-03-10 23:56, Andrey K wrote:
>
> >  > Alex: FWIW, related future Squid improvements may include:
> >  >  * Detecting such shared memory segments clashes; refusing to start.
> >  >  * Disabling shared memory use when caching is completely disabled.
>
> > But ... segments may remain from the previous
> > Squid crash. Thus, in my opinion, it is impractical to refuse to launch
> > the program.
>
> "Squid should overwrite segments left by a crashed Squid" does not imply
> that "detecting segment clashes among independent Squid instances is
> impractical".
>
> The following rough examples are _not_ implementation blueprints, but
> they illustrate the lack of the above implication:
>
> A. If Squid were to incorporate PID filename[^1] into segment names,
> then segments from different Squid instances will not clash.
>
> B. If Squid were to write its PID filename[^1] into a shared memory
> segment, then Squid would be able to detect that another running
> instance is using the same shared memory segment (while still
> overwriting segments left by an earlier crash).
>
>
> [^1]: Full Squid PID filename are already guaranteed to be unique across
> Squid instances that may overwrite each other segments because Squid
> refuses to start if another Squid instance is using its PID file. The
> only red flag I can think of here is esoteric chrooted instances, but I
> would not be surprised if those instances cannot share segments.
>
>
> > I think it's enough to put a warning in the code when detecting old
> > segments.
>
> I disagree that a level-0 warning during regular/uneventful startups is
> a good idea, especially if there will be one warning for every segment.
> We should try to address the actual problem (i.e. refuse to start a
> segment-clashing concurrent instance) rather than allowing clashes but
> adding a yet another warning about a usually benign event.
>
> Alex.
>
>
> > Something like that:
> > void
> > Ipc::Mem::Segment::create(const off_t aSize)
> > {
> >      assert(aSize > 0);
> >      assert(theFD < 0);
> >
> >      int xerrno = 0;
> >
> >      // Why a brand new segment? A Squid crash may leave a reusable
> > segment, but
> >      // our placement-new code requires an all-0s segment. We could
> > truncate and
> >      // resize the old segment, but OS X does not allow using O_TRUNC
> with
> >      // shm_open() and does not support ftruncate() for old segments.
> >      if (!createFresh(xerrno) && xerrno == EEXIST) {
> > *debugs(54, DBG_CRITICAL, "WARNING: there is an old shared memory
> > segment: '" << theName << "'. Perhaps it was left after the previous
> > crash of the Squid. We will remove it. Or it may be a sign that another
> > instance of the Squid is running.  In this case, you must launch the
> > program with the -n option and specify the unique name of the
> service.");*
> >          unlink();
> >          createFresh(xerrno);
> >      }
> > Kind regards,
> > Ankor.
> >
> >
> > ??, 8 ???. 2025??. ? 08:14, Andrey K <ankor2023 at gmail.com
> > <mailto:ankor2023 at gmail.com>>:
> >
> >     Hello Alex,
> >
> >     Thanks for the analysis.
> >     Squidonlyallowsalphanumericcharactersinthe servicename,
> >     soitrefusesto usethe originalservice namein the -n option (-n
> >     squid.user.service).
> >     I added-n squiduser option to the ExecStart string of the second
> >     instance.
> >     Now it looks good:
> >
> >     # the first instance
> >     lsof -p 3746105 | grep shm
> >     squid   3746105 root  mem    REG               0,23   525572
> >     1213614834 /dev/shm/squid-cf__queues.shm
> >     squid   3746105 root  mem    REG               0,23      136
> >     1213614835 /dev/shm/squid-cf__readers.shm
> >     squid   3746105 root  mem    REG               0,23        8
> >     1213614833 /dev/shm/squid-cf__metadata.shm
> >     squid   3746105 root    7u   REG               0,23        8
> >     1213614833 /dev/shm/squid-cf__metadata.shm
> >     squid   3746105 root    8u   REG               0,23   525572
> >     1213614834 /dev/shm/squid-cf__queues.shm
> >     squid   3746105 root    9u   REG               0,23      136
> >     1213614835 /dev/shm/squid-cf__readers.shm
> >
> >     # the second instance
> >     lsof -p 3685356 | grep shm
> >     squid.use 3685356 root  mem    REG               0,23   2093368
> >     1212704041 /dev/shm/squiduser-tls_session_cache.shm
> >     squid.use 3685356 root  mem    REG               0,23    525572
> >     1212704039 /dev/shm/squiduser-cf__queues.shm
> >     squid.use 3685356 root  mem    REG               0,23       136
> >     1212704040 /dev/shm/squiduser-cf__readers.shm
> >     squid.use 3685356 root  mem    REG               0,23         8
> >     1212704038 /dev/shm/squiduser-cf__metadata.shm
> >     squid.use 3685356 root    6u   REG               0,23         8
> >     1212704038 /dev/shm/squiduser-cf__metadata.shm
> >     squid.use 3685356 root    7u   REG               0,23    525572
> >     1212704039 /dev/shm/squiduser-cf__queues.shm
> >     squid.use 3685356 root    8u   REG               0,23       136
> >     1212704040 /dev/shm/squiduser-cf__readers.shm
> >     squid.use 3685356 root    9u   REG               0,23   2093368
> >     1212704041 /dev/shm/squiduser-tls_session_cache.shm
> >
> >     Kind regards,
> >           Ankor.
> >
> >
> >
> >
> >
> >     ??, 7 ???. 2025??. ? 17:48, Alex Rousskov
> >     <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>:
> >
> >         On 2025-03-07 06:50, Andrey K wrote:
> >
> >          > Squid Cache: Version 6.13
> >          > Service Name: squid
> >
> >          > Squid Cache: Version 6.10
> >          > Service Name: squid
> >
> >          > # the first instance
> >          > 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
> >          > 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
> >          > 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
> >          > 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm
> >         (deleted)
> >          > 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm
> >         (deleted)
> >          > 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm
> >         (deleted)
> >          >
> >          > # the second instance
> >          > 1514 mem  ... 2093368   31497
> >         /dev/shm/squid-tls_session_cache.shm
> >          > 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
> >          > 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
> >          > 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
> >          > 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
> >          > 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
> >          > 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
> >          > 1514   9u ... 2093368   31497
> >         /dev/shm/squid-tls_session_cache.shm
> >
> >         As suspected, these two Squid instances use the same shared
> memory
> >         segments (e.g., /dev/shm/squid-cf*). Such shared use violates
> >         critical
> >         code assumptions and results in undefined behavior.
> >
> >
> >          > Maybe I'm not experiencing any difficulties because I have
> >         caching turned off on
> >          > both instances?
> >
> >         Well, you _are_ experiencing at least one difficulty -- the
> >         assertion
> >         that started this email thread. If you have fully disabled
> >         caching, the
> >         difficulties you experience should not include cache corruption.
> >         However, it looks like at least one of the two instances does
> >         cache TLS
> >         sessions (in /dev/shm/squid-tls_session_cache.shm). If both
> >         instances do
> >         that, then all bets are off!
> >
> >
> >         FWIW, related future Squid improvements may include:
> >
> >         * Detecting such shared memory segments clashes; refusing to
> start.
> >         * Disabling shared memory use when caching is completely
> disabled.
> >
> >         Quality pull requests welcome.
> >
> >
> >         Cheers,
> >
> >         Alex.
> >
> >
> >          > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
> >          >
> >          >     On 2025-03-06 08:59, Amos Jeffries wrote:
> >          >      > On 6/03/25 19:17, Andrey K wrote:
> >          >      >> Hello,
> >          >      >>
> >          >      >> I have a similar configuration: two SMP squids
> >         running on the
> >          >     same OEL
> >          >      >> host.
> >          >      >>
> >          >      >> They were built with different configurations: with
> >         different
> >          >      >> installation path prefixes and different names of
> >         binary files:
> >          >     squid
> >          >      >> and squid.user and they listen to different ports.
> >          >      >> They are launched from two different
> >         services:squid.service and
> >          >      >> squid.user.service with the service Type=forking:
> >          >      >>
> >          >      >>     ExecStart=/usr/sbin/squid -sYC
> >          >      >>     ExecStart=/sbin/squid.user -f
> >         /etc/squid.user/squid.conf
> >          >      >>
> >          >      >> I have not experienced any troubles with this
> >         configuration yet.
> >          >      >>
> >          >      >> /> Please be aware that "squid -n ..." is a
> >         REQUIREMENT for running/
> >          >      >> /multiple Squid instances on the same machine
> >         regardless of what
> >          >     features
> >          >      >> are used./
> >          >      >>
> >          >      >> Could you please tell me if I should use the -n
> >         option in the
> >          >      >> ExecStart strings?
> >          >      >> The arguments of the options should be the service
> names?
> >          >      >>
> >          >      >>     ExecStart=/usr/sbin/squid -sYC -n squid.service
> >          >      >>     ExecStart=/sbin/squid.user -f
> >         /etc/squid.user/squid.conf -n
> >          >      >>     squid.user.service
> >          >      >>
> >          >      > Yes you should. The different ./configure options has
> >         helped you
> >          >     avoid
> >          >      > major issues, but some may still appear.
> >          >
> >          >     I agree. Moreover, I do not understand how your two SMP
> >         Squids could
> >          >     work correctly without distinct service names because (on
> >         OEL) I would
> >          >     expect them to share the same shared memory segments
> >         (which they must
> >          >     not do to remain distinct instances).
> >          >
> >          >     What is your Squid version? Can you tell how your Squids
> >         name their
> >          >     shared memory segment "files"? For example, on some Linux
> >         OSes, those
> >          >     segments could be in /var/run/shm/ with names like
> >          >     squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
> >          >
> >          >
> >          >     Thank you,
> >          >
> >          >     Alex.
> >          >
> >          >     _______________________________________________
> >          >     squid-users mailing list
> >          > squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>
> >          >     <mailto:squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>>
> >          > https://lists.squid-cache.org/listinfo/squid-users
> >         <https://lists.squid-cache.org/listinfo/squid-users>
> >          >     <https://lists.squid-cache.org/listinfo/squid-users
> >         <https://lists.squid-cache.org/listinfo/squid-users>>
> >          >
> >
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250311/8ea2a267/attachment-0001.htm>

From jonathanlee571 at gmail.com  Wed Mar 12 14:54:28 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Wed, 12 Mar 2025 14:54:28 +0000
Subject: [squid-users] DoH blocking by way of rep_mime_type directive
Message-ID: <DS0PR19MB7270C85A6B659BEE4AB2D233A7D02@DS0PR19MB7270.namprd19.prod.outlook.com>

Hello fellow Squid users,

Has anyone attempted to block DoH with mime?

If not, this is how I have done this.

The only issue is MS Teams, requires doh, so I am confused as to how to add an override for specific by need sites.

Here is how I did this.

Please if anyone knows how to add a bypass for this let me know.

acl deny_rep_mime_doh rep_mime_type application/dns-message
acl deny_rep_mime_doh rep_mime_type text/dns
acl deny_rep_mime_doh rep_mime_type application/dns+json
http_reply_access deny deny_rep_mime_doh

acl doh_rfc8484 urlpath_regex -i ^/dns-query
acl doh_rfc8484 urlpath_regex -i dns=
acl doh_rfc8484 urlpath_regex -i ^/resolve
acl doh_group any-of deny_rep_mime_doh doh_rfc8484
http_access deny doh_group

acl terminate_group any-of deny_rep_mime_doh doh_rfc8484


acl active_use annotate_client active=true

ssl_bump peek step1
ssl_bump terminate terminate_group
miss_access deny no_miss active_use
ssl_bump splice splice_main active_use
ssl_bump bump bump_main active_use
acl activated note active_use true
ssl_bump terminate !activated

Ref:
https://www.iana.org/assignments/media-types/application/dns-message
https://www.iana.org/assignments/media-types/application/dns+json
https://wiki.squid-cache.org/ConfigExamples/BlockingMimeTypes

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250312/c3f9b687/attachment.htm>

From ankor2023 at gmail.com  Thu Mar 13 11:49:11 2025
From: ankor2023 at gmail.com (Andrey K)
Date: Thu, 13 Mar 2025 14:49:11 +0300
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y3F7E142=Tp3CaRuEfLzL1Z7Ky3okWKy-SmGFYMNbcS0g@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
 <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
 <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>
 <85daf4e4-4387-4509-90a1-f229f17f6d34@measurement-factory.com>
 <CADJd0Y3F7E142=Tp3CaRuEfLzL1Z7Ky3okWKy-SmGFYMNbcS0g@mail.gmail.com>
Message-ID: <CADJd0Y0ruLFdMJ49u-MtF3mviwhjNaXMpPXQJTgb_NQwaUQcZQ@mail.gmail.com>

Hello,

> Quality pull requests welcome.

I implemented the A-example functionality and made PR:
https://github.com/squid-cache/squid/pull/2023

But the modified Squid project is not being built on github, although there
are no problems during the local builds.
Alex, Amos and Francesco, could you see what the problem is?
Kind regards,
Ankor.



??, 11 ???. 2025??. ? 17:40, Andrey K <ankor2023 at gmail.com>:

> Hello Alex,
>
> Thank you for sharing your thoughts.
> The A-example looks easier to implement and more reliable.
>
> Kind regards,
>       Ankor.
>
> ??, 11 ???. 2025??. ? 17:12, Alex Rousskov <
> rousskov at measurement-factory.com>:
>
>> On 2025-03-10 23:56, Andrey K wrote:
>>
>> >  > Alex: FWIW, related future Squid improvements may include:
>> >  >  * Detecting such shared memory segments clashes; refusing to start.
>> >  >  * Disabling shared memory use when caching is completely disabled.
>>
>> > But ... segments may remain from the previous
>> > Squid crash. Thus, in my opinion, it is impractical to refuse to launch
>> > the program.
>>
>> "Squid should overwrite segments left by a crashed Squid" does not imply
>> that "detecting segment clashes among independent Squid instances is
>> impractical".
>>
>> The following rough examples are _not_ implementation blueprints, but
>> they illustrate the lack of the above implication:
>>
>> A. If Squid were to incorporate PID filename[^1] into segment names,
>> then segments from different Squid instances will not clash.
>>
>> B. If Squid were to write its PID filename[^1] into a shared memory
>> segment, then Squid would be able to detect that another running
>> instance is using the same shared memory segment (while still
>> overwriting segments left by an earlier crash).
>>
>>
>> [^1]: Full Squid PID filename are already guaranteed to be unique across
>> Squid instances that may overwrite each other segments because Squid
>> refuses to start if another Squid instance is using its PID file. The
>> only red flag I can think of here is esoteric chrooted instances, but I
>> would not be surprised if those instances cannot share segments.
>>
>>
>> > I think it's enough to put a warning in the code when detecting old
>> > segments.
>>
>> I disagree that a level-0 warning during regular/uneventful startups is
>> a good idea, especially if there will be one warning for every segment.
>> We should try to address the actual problem (i.e. refuse to start a
>> segment-clashing concurrent instance) rather than allowing clashes but
>> adding a yet another warning about a usually benign event.
>>
>> Alex.
>>
>>
>> > Something like that:
>> > void
>> > Ipc::Mem::Segment::create(const off_t aSize)
>> > {
>> >      assert(aSize > 0);
>> >      assert(theFD < 0);
>> >
>> >      int xerrno = 0;
>> >
>> >      // Why a brand new segment? A Squid crash may leave a reusable
>> > segment, but
>> >      // our placement-new code requires an all-0s segment. We could
>> > truncate and
>> >      // resize the old segment, but OS X does not allow using O_TRUNC
>> with
>> >      // shm_open() and does not support ftruncate() for old segments.
>> >      if (!createFresh(xerrno) && xerrno == EEXIST) {
>> > *debugs(54, DBG_CRITICAL, "WARNING: there is an old shared memory
>> > segment: '" << theName << "'. Perhaps it was left after the previous
>> > crash of the Squid. We will remove it. Or it may be a sign that another
>> > instance of the Squid is running.  In this case, you must launch the
>> > program with the -n option and specify the unique name of the
>> service.");*
>> >          unlink();
>> >          createFresh(xerrno);
>> >      }
>> > Kind regards,
>> > Ankor.
>> >
>> >
>> > ??, 8 ???. 2025??. ? 08:14, Andrey K <ankor2023 at gmail.com
>> > <mailto:ankor2023 at gmail.com>>:
>> >
>> >     Hello Alex,
>> >
>> >     Thanks for the analysis.
>> >     Squidonlyallowsalphanumericcharactersinthe servicename,
>> >     soitrefusesto usethe originalservice namein the -n option (-n
>> >     squid.user.service).
>> >     I added-n squiduser option to the ExecStart string of the second
>> >     instance.
>> >     Now it looks good:
>> >
>> >     # the first instance
>> >     lsof -p 3746105 | grep shm
>> >     squid   3746105 root  mem    REG               0,23   525572
>> >     1213614834 /dev/shm/squid-cf__queues.shm
>> >     squid   3746105 root  mem    REG               0,23      136
>> >     1213614835 /dev/shm/squid-cf__readers.shm
>> >     squid   3746105 root  mem    REG               0,23        8
>> >     1213614833 /dev/shm/squid-cf__metadata.shm
>> >     squid   3746105 root    7u   REG               0,23        8
>> >     1213614833 /dev/shm/squid-cf__metadata.shm
>> >     squid   3746105 root    8u   REG               0,23   525572
>> >     1213614834 /dev/shm/squid-cf__queues.shm
>> >     squid   3746105 root    9u   REG               0,23      136
>> >     1213614835 /dev/shm/squid-cf__readers.shm
>> >
>> >     # the second instance
>> >     lsof -p 3685356 | grep shm
>> >     squid.use 3685356 root  mem    REG               0,23   2093368
>> >     1212704041 /dev/shm/squiduser-tls_session_cache.shm
>> >     squid.use 3685356 root  mem    REG               0,23    525572
>> >     1212704039 /dev/shm/squiduser-cf__queues.shm
>> >     squid.use 3685356 root  mem    REG               0,23       136
>> >     1212704040 /dev/shm/squiduser-cf__readers.shm
>> >     squid.use 3685356 root  mem    REG               0,23         8
>> >     1212704038 /dev/shm/squiduser-cf__metadata.shm
>> >     squid.use 3685356 root    6u   REG               0,23         8
>> >     1212704038 /dev/shm/squiduser-cf__metadata.shm
>> >     squid.use 3685356 root    7u   REG               0,23    525572
>> >     1212704039 /dev/shm/squiduser-cf__queues.shm
>> >     squid.use 3685356 root    8u   REG               0,23       136
>> >     1212704040 /dev/shm/squiduser-cf__readers.shm
>> >     squid.use 3685356 root    9u   REG               0,23   2093368
>> >     1212704041 /dev/shm/squiduser-tls_session_cache.shm
>> >
>> >     Kind regards,
>> >           Ankor.
>> >
>> >
>> >
>> >
>> >
>> >     ??, 7 ???. 2025??. ? 17:48, Alex Rousskov
>> >     <rousskov at measurement-factory.com
>> >     <mailto:rousskov at measurement-factory.com>>:
>> >
>> >         On 2025-03-07 06:50, Andrey K wrote:
>> >
>> >          > Squid Cache: Version 6.13
>> >          > Service Name: squid
>> >
>> >          > Squid Cache: Version 6.10
>> >          > Service Name: squid
>> >
>> >          > # the first instance
>> >          > 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
>> >          > 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
>> >          > 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
>> >          > 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm
>> >         (deleted)
>> >          > 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm
>> >         (deleted)
>> >          > 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm
>> >         (deleted)
>> >          >
>> >          > # the second instance
>> >          > 1514 mem  ... 2093368   31497
>> >         /dev/shm/squid-tls_session_cache.shm
>> >          > 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
>> >          > 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
>> >          > 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
>> >          > 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
>> >          > 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
>> >          > 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
>> >          > 1514   9u ... 2093368   31497
>> >         /dev/shm/squid-tls_session_cache.shm
>> >
>> >         As suspected, these two Squid instances use the same shared
>> memory
>> >         segments (e.g., /dev/shm/squid-cf*). Such shared use violates
>> >         critical
>> >         code assumptions and results in undefined behavior.
>> >
>> >
>> >          > Maybe I'm not experiencing any difficulties because I have
>> >         caching turned off on
>> >          > both instances?
>> >
>> >         Well, you _are_ experiencing at least one difficulty -- the
>> >         assertion
>> >         that started this email thread. If you have fully disabled
>> >         caching, the
>> >         difficulties you experience should not include cache corruption.
>> >         However, it looks like at least one of the two instances does
>> >         cache TLS
>> >         sessions (in /dev/shm/squid-tls_session_cache.shm). If both
>> >         instances do
>> >         that, then all bets are off!
>> >
>> >
>> >         FWIW, related future Squid improvements may include:
>> >
>> >         * Detecting such shared memory segments clashes; refusing to
>> start.
>> >         * Disabling shared memory use when caching is completely
>> disabled.
>> >
>> >         Quality pull requests welcome.
>> >
>> >
>> >         Cheers,
>> >
>> >         Alex.
>> >
>> >
>> >          > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
>> >          >
>> >          >     On 2025-03-06 08:59, Amos Jeffries wrote:
>> >          >      > On 6/03/25 19:17, Andrey K wrote:
>> >          >      >> Hello,
>> >          >      >>
>> >          >      >> I have a similar configuration: two SMP squids
>> >         running on the
>> >          >     same OEL
>> >          >      >> host.
>> >          >      >>
>> >          >      >> They were built with different configurations: with
>> >         different
>> >          >      >> installation path prefixes and different names of
>> >         binary files:
>> >          >     squid
>> >          >      >> and squid.user and they listen to different ports.
>> >          >      >> They are launched from two different
>> >         services:squid.service and
>> >          >      >> squid.user.service with the service Type=forking:
>> >          >      >>
>> >          >      >>     ExecStart=/usr/sbin/squid -sYC
>> >          >      >>     ExecStart=/sbin/squid.user -f
>> >         /etc/squid.user/squid.conf
>> >          >      >>
>> >          >      >> I have not experienced any troubles with this
>> >         configuration yet.
>> >          >      >>
>> >          >      >> /> Please be aware that "squid -n ..." is a
>> >         REQUIREMENT for running/
>> >          >      >> /multiple Squid instances on the same machine
>> >         regardless of what
>> >          >     features
>> >          >      >> are used./
>> >          >      >>
>> >          >      >> Could you please tell me if I should use the -n
>> >         option in the
>> >          >      >> ExecStart strings?
>> >          >      >> The arguments of the options should be the service
>> names?
>> >          >      >>
>> >          >      >>     ExecStart=/usr/sbin/squid -sYC -n squid.service
>> >          >      >>     ExecStart=/sbin/squid.user -f
>> >         /etc/squid.user/squid.conf -n
>> >          >      >>     squid.user.service
>> >          >      >>
>> >          >      > Yes you should. The different ./configure options has
>> >         helped you
>> >          >     avoid
>> >          >      > major issues, but some may still appear.
>> >          >
>> >          >     I agree. Moreover, I do not understand how your two SMP
>> >         Squids could
>> >          >     work correctly without distinct service names because (on
>> >         OEL) I would
>> >          >     expect them to share the same shared memory segments
>> >         (which they must
>> >          >     not do to remain distinct instances).
>> >          >
>> >          >     What is your Squid version? Can you tell how your Squids
>> >         name their
>> >          >     shared memory segment "files"? For example, on some Linux
>> >         OSes, those
>> >          >     segments could be in /var/run/shm/ with names like
>> >          >     squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
>> >          >
>> >          >
>> >          >     Thank you,
>> >          >
>> >          >     Alex.
>> >          >
>> >          >     _______________________________________________
>> >          >     squid-users mailing list
>> >          > squid-users at lists.squid-cache.org
>> >         <mailto:squid-users at lists.squid-cache.org>
>> >          >     <mailto:squid-users at lists.squid-cache.org
>> >         <mailto:squid-users at lists.squid-cache.org>>
>> >          > https://lists.squid-cache.org/listinfo/squid-users
>> >         <https://lists.squid-cache.org/listinfo/squid-users>
>> >          >     <https://lists.squid-cache.org/listinfo/squid-users
>> >         <https://lists.squid-cache.org/listinfo/squid-users>>
>> >          >
>> >
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250313/73b460b0/attachment-0001.htm>

From rousskov at measurement-factory.com  Thu Mar 13 17:55:32 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 13 Mar 2025 13:55:32 -0400
Subject: [squid-users] assertion failed: Queue.cc:388: "EX"
In-Reply-To: <CADJd0Y0ruLFdMJ49u-MtF3mviwhjNaXMpPXQJTgb_NQwaUQcZQ@mail.gmail.com>
References: <CAMJdYBxh2PLBB4dR71A5f6aJ6+Wedp+2r31yhKpaQCJOCbr7gQ@mail.gmail.com>
 <3983bea2-58c5-459f-b304-6f0e07ed11a1@measurement-factory.com>
 <CAMJdYByMftyTmsQNY0x1PdhSv-4-sqWpvsqqAd4e2DpFCO_Cgg@mail.gmail.com>
 <58859d04-0ab9-44db-9a4a-828c022ed612@treenet.co.nz>
 <CADJd0Y1-FdQzSDswZ7tYn4gydpUa7NeaFhjs4zLR6MHjnEaXsw@mail.gmail.com>
 <52160db9-431b-4168-9449-51cbb1a59235@treenet.co.nz>
 <371203f3-da75-4d72-891b-3287adcb2145@measurement-factory.com>
 <CADJd0Y1R=FVY5K0ATFti-zGjDrF74cXwCnDD5+SXsxPVkYXiXw@mail.gmail.com>
 <27c226fc-460b-4f5f-8d36-a451a1adfff3@measurement-factory.com>
 <CADJd0Y3ZWPWgGt6JGzFDFbm_k0x3DC6uu228e3MqJ_pSJ4icvA@mail.gmail.com>
 <CADJd0Y1BVONnWazCbrEtsF+NhT0ML6cUtZdDQOiGSXGWKogQsw@mail.gmail.com>
 <85daf4e4-4387-4509-90a1-f229f17f6d34@measurement-factory.com>
 <CADJd0Y3F7E142=Tp3CaRuEfLzL1Z7Ky3okWKy-SmGFYMNbcS0g@mail.gmail.com>
 <CADJd0Y0ruLFdMJ49u-MtF3mviwhjNaXMpPXQJTgb_NQwaUQcZQ@mail.gmail.com>
Message-ID: <703a848d-101e-477e-91f7-99b0d9e369cf@measurement-factory.com>

On 2025-03-13 07:49, Andrey K wrote:

> I implemented?the A-example functionality and made PR:
> https://github.com/squid-cache/squid/pull/2023 

Thank you.


> ButthemodifiedSquid projectis notbeingbuilt ongithub,althoughthere are 
> noproblemsduringthe localbuilds.
> Alex, Amos and Francesco, could you see what the problem is?

Just to close this mailing list thread: PR #2023 problems are being 
handled on GitHub.

Alex.


> ??, 11 ???. 2025??. ? 17:40, Andrey K:
> 
>     Hello Alex,
> 
>     Thank you for sharing your thoughts.
>     The A-example looks easier to implement and more reliable.
> 
>     Kind?regards,
>      ? ? ? Ankor.
> 
>     ??, 11 ???. 2025??. ? 17:12, Alex Rousskov
>     <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>:
> 
>         On 2025-03-10 23:56, Andrey K wrote:
> 
>          >? >?Alex: FWIW, related future Squid improvements may include:
>          >? >? * Detecting such shared memory segments clashes; refusing
>         to start.
>          >? >? * Disabling shared memory use when caching is completely
>         disabled.
> 
>          > But ... segments may remain from the previous
>          > Squid crash. Thus, in my opinion, it is impractical to refuse
>         to launch
>          > the program.
> 
>         "Squid should overwrite segments left by a crashed Squid" does
>         not imply
>         that "detecting segment clashes among independent Squid
>         instances is
>         impractical".
> 
>         The following rough examples are _not_ implementation
>         blueprints, but
>         they illustrate the lack of the above implication:
> 
>         A. If Squid were to incorporate PID filename[^1] into segment
>         names,
>         then segments from different Squid instances will not clash.
> 
>         B. If Squid were to write its PID filename[^1] into a shared memory
>         segment, then Squid would be able to detect that another running
>         instance is using the same shared memory segment (while still
>         overwriting segments left by an earlier crash).
> 
> 
>         [^1]: Full Squid PID filename are already guaranteed to be
>         unique across
>         Squid instances that may overwrite each other segments because
>         Squid
>         refuses to start if another Squid instance is using its PID
>         file. The
>         only red flag I can think of here is esoteric chrooted
>         instances, but I
>         would not be surprised if those instances cannot share segments.
> 
> 
>          > I think it's enough to put a warning in the code when
>         detecting old
>          > segments.
> 
>         I disagree that a level-0 warning during regular/uneventful
>         startups is
>         a good idea, especially if there will be one warning for every
>         segment.
>         We should try to address the actual problem (i.e. refuse to start a
>         segment-clashing concurrent instance) rather than allowing
>         clashes but
>         adding a yet another warning about a usually benign event.
> 
>         Alex.
> 
> 
>          > Something like that:
>          > void
>          > Ipc::Mem::Segment::create(const off_t aSize)
>          > {
>          >? ? ? assert(aSize > 0);
>          >? ? ? assert(theFD < 0);
>          >
>          >? ? ? int xerrno = 0;
>          >
>          >? ? ? // Why a brand new segment? A Squid crash may leave a
>         reusable
>          > segment, but
>          >? ? ? // our placement-new code requires an all-0s segment. We
>         could
>          > truncate and
>          >? ? ? // resize the old segment, but OS X does not allow using
>         O_TRUNC with
>          >? ? ? // shm_open() and does not support ftruncate() for old
>         segments.
>          >? ? ? if (!createFresh(xerrno) && xerrno == EEXIST) {
>          > *debugs(54, DBG_CRITICAL, "WARNING: there is an old shared
>         memory
>          > segment: '" << theName << "'. Perhaps it was left after the
>         previous
>          > crash of the Squid. We will remove it. Or it may be a sign
>         that another
>          > instance of the Squid is running.? In this case, you must
>         launch the
>          > program with the -n option and specify the unique name of the
>         service.");*
>          >? ? ? ? ? unlink();
>          >? ? ? ? ? createFresh(xerrno);
>          >? ? ? }
>          > Kind regards,
>          > Ankor.
>          >
>          >
>          > ??, 8 ???. 2025??. ? 08:14, Andrey K <ankor2023 at gmail.com
>         <mailto:ankor2023 at gmail.com>
>          > <mailto:ankor2023 at gmail.com <mailto:ankor2023 at gmail.com>>>:
>          >
>          >? ? ?Hello Alex,
>          >
>          >? ? ?Thanks for the analysis.
>          >? ? ?Squidonlyallowsalphanumericcharactersinthe servicename,
>          >? ? ?soitrefusesto usethe originalservice namein the -n option (-n
>          >? ? ?squid.user.service).
>          >? ? ?I added-n squiduser?option to the ExecStart string of the
>         second
>          >? ? ?instance.
>          >? ? ?Now it looks good:
>          >
>          >? ? ?# the first instance
>          >? ? ?lsof -p 3746105 | grep shm
>          >? ? ?squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? 525572
>          >? ? ?1213614834 /dev/shm/squid-cf__queues.shm
>          >? ? ?squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ?136
>          >? ? ?1213614835 /dev/shm/squid-cf__readers.shm
>          >? ? ?squid ? 3746105 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23 ? ? ? ?8
>          >? ? ?1213614833 /dev/shm/squid-cf__metadata.shm
>          >? ? ?squid ? 3746105 root ? ?7u ? REG ? ? ? ? ? ? ? 0,23 ? ? ? ?8
>          >? ? ?1213614833 /dev/shm/squid-cf__metadata.shm
>          >? ? ?squid ? 3746105 root ? ?8u ? REG ? ? ? ? ? ? ? 0,23 ? 525572
>          >? ? ?1213614834 /dev/shm/squid-cf__queues.shm
>          >? ? ?squid ? 3746105 root ? ?9u ? REG ? ? ? ? ? ? ? 0,23 ? ? ?136
>          >? ? ?1213614835 /dev/shm/squid-cf__readers.shm
>          >
>          >? ? ?# the second instance
>          >? ? ?lsof -p 3685356 | grep shm
>          >? ? ?squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23  
>         2093368
>          >? ? ?1212704041 /dev/shm/squiduser-tls_session_cache.shm
>          >? ? ?squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23  
>          ?525572
>          >? ? ?1212704039 /dev/shm/squiduser-cf__queues.shm
>          >? ? ?squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23    
>          ? 136
>          >? ? ?1212704040 /dev/shm/squiduser-cf__readers.shm
>          >? ? ?squid.use 3685356 root ?mem ? ?REG ? ? ? ? ? ? ? 0,23    
>          ? ? 8
>          >? ? ?1212704038 /dev/shm/squiduser-cf__metadata.shm
>          >? ? ?squid.use 3685356 root ? ?6u ? REG ? ? ? ? ? ? ? 0,23    
>          ? ? 8
>          >? ? ?1212704038 /dev/shm/squiduser-cf__metadata.shm
>          >? ? ?squid.use 3685356 root ? ?7u ? REG ? ? ? ? ? ? ? 0,23  
>          ?525572
>          >? ? ?1212704039 /dev/shm/squiduser-cf__queues.shm
>          >? ? ?squid.use 3685356 root ? ?8u ? REG ? ? ? ? ? ? ? 0,23    
>          ? 136
>          >? ? ?1212704040 /dev/shm/squiduser-cf__readers.shm
>          >? ? ?squid.use 3685356 root ? ?9u ? REG ? ? ? ? ? ? ? 0,23  
>         2093368
>          >? ? ?1212704041 /dev/shm/squiduser-tls_session_cache.shm
>          >
>          >? ? ?Kind regards,
>          >? ? ? ? ? ?Ankor.
>          >
>          >
>          >
>          >
>          >
>          >? ? ???, 7 ???. 2025??. ? 17:48, Alex Rousskov
>          >? ? ?<rousskov at measurement-factory.com
>         <mailto:rousskov at measurement-factory.com>
>          >? ? ?<mailto:rousskov at measurement-factory.com
>         <mailto:rousskov at measurement-factory.com>>>:
>          >
>          >? ? ? ? ?On 2025-03-07 06:50, Andrey K wrote:
>          >
>          >? ? ? ? ? > Squid Cache: Version 6.13
>          >? ? ? ? ? > Service Name: squid
>          >
>          >? ? ? ? ? > Squid Cache: Version 6.10
>          >? ? ? ? ? > Service Name: squid
>          >
>          >? ? ? ? ? > # the first instance
>          >? ? ? ? ? > 1318 DEL? ...? ? ? ? ? 30205
>         /dev/shm/squid-cf__queues.shm
>          >? ? ? ? ? > 1318 DEL? ...? ? ? ? ? 30206
>         /dev/shm/squid-cf__readers.shm
>          >? ? ? ? ? > 1318 DEL? ...? ? ? ? ? 30204
>         /dev/shm/squid-cf__metadata.shm
>          >? ? ? ? ? > 1318? ?8u ...? ? ? 8? ?30204
>         /dev/shm/squid-cf__metadata.shm
>          >? ? ? ? ?(deleted)
>          >? ? ? ? ? > 1318? ?9u ... 525572? ?30205
>         /dev/shm/squid-cf__queues.shm
>          >? ? ? ? ?(deleted)
>          >? ? ? ? ? > 1318? 10u ...? ? 136? ?30206
>         /dev/shm/squid-cf__readers.shm
>          >? ? ? ? ?(deleted)
>          >? ? ? ? ? >
>          >? ? ? ? ? > # the second instance
>          >? ? ? ? ? > 1514 mem? ... 2093368? ?31497
>          >? ? ? ? ?/dev/shm/squid-tls_session_cache.shm
>          >? ? ? ? ? > 1514 mem? ...? 525572? ?31495
>         /dev/shm/squid-cf__queues.shm
>          >? ? ? ? ? > 1514 mem? ...? ? ?136? ?31496
>         /dev/shm/squid-cf__readers.shm
>          >? ? ? ? ? > 1514 mem? ...? ? ? ?8? ?31494
>         /dev/shm/squid-cf__metadata.shm
>          >? ? ? ? ? > 1514? ?6u ...? ? ? ?8? ?31494
>         /dev/shm/squid-cf__metadata.shm
>          >? ? ? ? ? > 1514? ?7u ...? 525572? ?31495
>         /dev/shm/squid-cf__queues.shm
>          >? ? ? ? ? > 1514? ?8u ...? ? ?136? ?31496
>         /dev/shm/squid-cf__readers.shm
>          >? ? ? ? ? > 1514? ?9u ... 2093368? ?31497
>          >? ? ? ? ?/dev/shm/squid-tls_session_cache.shm
>          >
>          >? ? ? ? ?As suspected, these two Squid instances use the same
>         shared memory
>          >? ? ? ? ?segments (e.g., /dev/shm/squid-cf*). Such shared use
>         violates
>          >? ? ? ? ?critical
>          >? ? ? ? ?code assumptions and results in undefined behavior.
>          >
>          >
>          >? ? ? ? ? > Maybe I'm not experiencing any difficulties
>         because I have
>          >? ? ? ? ?caching turned off on
>          >? ? ? ? ? > both instances?
>          >
>          >? ? ? ? ?Well, you _are_ experiencing at least one difficulty
>         -- the
>          >? ? ? ? ?assertion
>          >? ? ? ? ?that started this email thread. If you have fully
>         disabled
>          >? ? ? ? ?caching, the
>          >? ? ? ? ?difficulties you experience should not include cache
>         corruption.
>          >? ? ? ? ?However, it looks like at least one of the two
>         instances does
>          >? ? ? ? ?cache TLS
>          >? ? ? ? ?sessions (in /dev/shm/squid-tls_session_cache.shm).
>         If both
>          >? ? ? ? ?instances do
>          >? ? ? ? ?that, then all bets are off!
>          >
>          >
>          >? ? ? ? ?FWIW, related future Squid improvements may include:
>          >
>          >? ? ? ? ?* Detecting such shared memory segments clashes;
>         refusing to start.
>          >? ? ? ? ?* Disabling shared memory use when caching is
>         completely disabled.
>          >
>          >? ? ? ? ?Quality pull requests welcome.
>          >
>          >
>          >? ? ? ? ?Cheers,
>          >
>          >? ? ? ? ?Alex.
>          >
>          >
>          >? ? ? ? ? > ??, 6 ???. 2025??. ? 17:11, Alex Rousskov:
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?On 2025-03-06 08:59, Amos Jeffries wrote:
>          >? ? ? ? ? >? ? ? > On 6/03/25 19:17, Andrey K wrote:
>          >? ? ? ? ? >? ? ? >> Hello,
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> I have a similar?configuration: two SMP squids
>          >? ? ? ? ?running on the
>          >? ? ? ? ? >? ? ?same OEL
>          >? ? ? ? ? >? ? ? >> host.
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> They were built with different
>         configurations: with
>          >? ? ? ? ?different
>          >? ? ? ? ? >? ? ? >> installation path prefixes and
>         different?names of
>          >? ? ? ? ?binary files:
>          >? ? ? ? ? >? ? ?squid
>          >? ? ? ? ? >? ? ? >> and squid.user and they listen to
>         different ports.
>          >? ? ? ? ? >? ? ? >> They are launched?from two different
>          >? ? ? ? ?services:squid.service and
>          >? ? ? ? ? >? ? ? >> squid.user.service with the service
>         Type=forking:
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> ??? ExecStart=/usr/sbin/squid -sYC
>          >? ? ? ? ? >? ? ? >> ??? ExecStart=/sbin/squid.user -f
>          >? ? ? ? ?/etc/squid.user/squid.conf
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> I have not experienced any troubles with this
>          >? ? ? ? ?configuration yet.
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> /> Please be aware that "squid -n ..." is a
>          >? ? ? ? ?REQUIREMENT for running/
>          >? ? ? ? ? >? ? ? >> /multiple Squid instances on the same machine
>          >? ? ? ? ?regardless of what
>          >? ? ? ? ? >? ? ?features
>          >? ? ? ? ? >? ? ? >> are used./
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> Could you please?tell me if I should use
>         the -n
>          >? ? ? ? ?option in the
>          >? ? ? ? ? >? ? ? >> ExecStart strings?
>          >? ? ? ? ? >? ? ? >> The arguments of the options should be the
>         service names?
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? >> ??? ExecStart=/usr/sbin/squid -sYC -n
>         squid.service
>          >? ? ? ? ? >? ? ? >> ??? ExecStart=/sbin/squid.user -f
>          >? ? ? ? ?/etc/squid.user/squid.conf -n
>          >? ? ? ? ? >? ? ? >> ??? squid.user.service
>          >? ? ? ? ? >? ? ? >>
>          >? ? ? ? ? >? ? ? > Yes you should. The different ./configure
>         options has
>          >? ? ? ? ?helped you
>          >? ? ? ? ? >? ? ?avoid
>          >? ? ? ? ? >? ? ? > major issues, but some may still appear.
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?I agree. Moreover, I do not understand how
>         your two SMP
>          >? ? ? ? ?Squids could
>          >? ? ? ? ? >? ? ?work correctly without distinct service names
>         because (on
>          >? ? ? ? ?OEL) I would
>          >? ? ? ? ? >? ? ?expect them to share the same shared memory
>         segments
>          >? ? ? ? ?(which they must
>          >? ? ? ? ? >? ? ?not do to remain distinct instances).
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?What is your Squid version? Can you tell how
>         your Squids
>          >? ? ? ? ?name their
>          >? ? ? ? ? >? ? ?shared memory segment "files"? For example, on
>         some Linux
>          >? ? ? ? ?OSes, those
>          >? ? ? ? ? >? ? ?segments could be in /var/run/shm/ with names like
>          >? ? ? ? ? >? ? ?squid-tr_map_anchors.shm? and squid-tr_spaces.shm.
>          >? ? ? ? ? >
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?Thank you,
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?Alex.
>          >? ? ? ? ? >
>          >? ? ? ? ? >? ? ?_______________________________________________
>          >? ? ? ? ? >? ? ?squid-users mailing list
>          >? ? ? ? ? > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>
>          >? ? ? ? ? >? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>>
>          >? ? ? ? ? > https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>>
>          >? ? ? ? ? >   
>          ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>>>
>          >? ? ? ? ? >
>          >
> 
>         _______________________________________________
>         squid-users mailing list
>         squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>         https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
> 


From ngtech1ltd at gmail.com  Sun Mar 16 08:34:22 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Sun, 16 Mar 2025 10:34:22 +0200
Subject: [squid-users] Kids control and time limit function
Message-ID: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>

I was wondering if there is a ready to use solution with web-ui for kid
time limit.
I am using mikrotik kid-control which is very nice and I was wondering if
anyone have implemented a similar function for squid with an external-acl
helper.
The src options are by:
* username
* src ip address
* src mac address

There should be a schedule in a DB per user ID.
The external ACL helper should cache for about 30 seconds and the table
should be by an hour and day of the week.
This way it would be pretty simple to build a web ui to manage the schedule.

I would like to get some input on things that kid control might be good
doing.

Thanks,
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/f4a47f77/attachment.htm>

From ngtech1ltd at gmail.com  Sun Mar 16 08:38:35 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Sun, 16 Mar 2025 10:38:35 +0200
Subject: [squid-users] windows updates
In-Reply-To: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
References: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
Message-ID: <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>

Hey,

Did you manage to find a solution for your use case?
Let me know if you need assistance with this issue.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com


On Tue, Mar 4, 2025 at 1:57?AM Doug Tucker <doug.tucker at navigaglobal.com>
wrote:

> I have read through everything I can find on this subject but still cannot
> seem to get around the issue of windows updates not working through the
> squid transparent proxy.  No matter what I try I continue to see this in
> the cache log and windows update will not connect.
>
> 2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25:
> error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify
> failed (1/-1/0)
>
> I tried adding the info from the following doc to no avail.
>
> https://wiki.squid-cache.org/SquidFaq/WindowsUpdate
>
>
> The relevant parts of my squid.conf:
>
> #Handling HTTPS requests
> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
> acl SSL_port port 443
> http_access allow SSL_port
> acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump peek step1 all
> ssl_bump peek step2 allowed_https_sites
> ssl_bump splice step3 allowed_https_sites
> ssl_bump terminate step2 all
>
> #windows update
> acl DiscoverSNIHost at_step SslBump1
> acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
> ssl_bump splice NoSSLIntercept
> ssl_bump peek DiscoverSNIHost
> ssl_bump bump all
>
> I ran tcpdump and added every url i could find to the allowed-sites.txt
> and added the 2 sites recommended tot he url.nobump.  If anyone has gotten
> this to work any help would be appreciated.
>
>
>
>
>
>
> *Doug Tucker*
> Sr. Director of Networking and Linux Operations
>
> *o:* 817.975.5832
> *e: *doug.tucker at navigaglobal.com
>
>
> Newscycle Solutions is now Naviga. Learn more.
>
>
> CONFIDENTIALITY NOTICE: The contents of this email message and any
> attachments are intended solely for the addressee(s) and may contain
> confidential and/or privileged information and may be legally protected
> from disclosure. If you are not the intended recipient of this message or
> their agent, or if this message has been addressed to you in error, please
> immediately alert the sender by reply email and then delete this message
> and any attachments. If you are not the intended recipient, you are hereby
> notified that any use, dissemination, copying, or storage of this message
> or its attachments is strictly prohibite
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/f2c42417/attachment.htm>

From doug.tucker at navigaglobal.com  Sun Mar 16 14:34:20 2025
From: doug.tucker at navigaglobal.com (Doug Tucker)
Date: Sun, 16 Mar 2025 14:34:20 +0000
Subject: [squid-users] windows updates
In-Reply-To: <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>
References: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
 <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>
Message-ID: <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>

No, no one responded.

Doug Tucker
Sr. Director of Networking and Linux Operations
doug.tucker at navigaglobal.com
________________________________
From: NgTech LTD <ngtech1ltd at gmail.com>
Sent: Sunday, March 16, 2025 2:38:35 AM
To: Doug Tucker <doug.tucker at navigaglobal.com>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] windows updates

You don't often get email from ngtech1ltd at gmail.com. Learn why this is important<https://aka.ms/LearnAboutSenderIdentification>

Naviga WARNING: External email. Please verify sender before opening attachments or clicking on links.

Hey,

Did you manage to find a solution for your use case?
Let me know if you need assistance with this issue.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>


On Tue, Mar 4, 2025 at 1:57?AM Doug Tucker <doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>> wrote:
I have read through everything I can find on this subject but still cannot seem to get around the issue of windows updates not working through the squid transparent proxy.  No matter what I try I continue to see this in the cache log and windows update will not connect.

2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)

I tried adding the info from the following doc to no avail.

https://wiki.squid-cache.org/SquidFaq/WindowsUpdate


The relevant parts of my squid.conf:

#Handling HTTPS requests
https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate step2 all

#windows update
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
ssl_bump splice NoSSLIntercept
ssl_bump peek DiscoverSNIHost
ssl_bump bump all

I ran tcpdump and added every url i could find to the allowed-sites.txt and added the 2 sites recommended tot he url.nobump.  If anyone has gotten this to work any help would be appreciated.







Doug Tucker
Sr. Director of Networking and Linux Operations

o: 817.975.5832
e: doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>


Newscycle Solutions is now Naviga. Learn more.


CONFIDENTIALITY NOTICE: The contents of this email message and any attachments are intended solely for the addressee(s) and may contain confidential and/or privileged information and may be legally protected from disclosure. If you are not the intended recipient of this message or their agent, or if this message has been addressed to you in error, please immediately alert the sender by reply email and then delete this message and any attachments. If you are not the intended recipient, you are hereby notified that any use, dissemination, copying, or storage of this message or its attachments is strictly prohibite

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/0ae0622c/attachment-0001.htm>

From jonathanlee571 at gmail.com  Sun Mar 16 15:41:17 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sun, 16 Mar 2025 08:41:17 -0700
Subject: [squid-users] Kids control and time limit function
In-Reply-To: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>
References: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>
Message-ID: <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/7f24b4d3/attachment.htm>

From ngtech1ltd at gmail.com  Sun Mar 16 19:56:23 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Sun, 16 Mar 2025 21:56:23 +0200
Subject: [squid-users] windows updates
In-Reply-To: <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>
References: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
 <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>
 <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>
Message-ID: <CABA8h=RpzC4b1Qyz+kWa3zuZ=UVyPH_=8xMsMfBxzFTSfgiM-w@mail.gmail.com>

I will try to look at it later on.
>From what I remember windows updates are using both http and https.
The communication channel was encrypted but the transfer channel was plain
http.



----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

?????? ??? ??, 16 ???? 2025, 16:34, ??? Doug Tucker ?<
doug.tucker at navigaglobal.com>:

> No, no one responded.
>
> Doug Tucker
> Sr. Director of Networking and Linux Operations
> doug.tucker at navigaglobal.com
> ------------------------------
> *From:* NgTech LTD <ngtech1ltd at gmail.com>
> *Sent:* Sunday, March 16, 2025 2:38:35 AM
> *To:* Doug Tucker <doug.tucker at navigaglobal.com>
> *Cc:* squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org
> >
> *Subject:* Re: [squid-users] windows updates
>
> You don't often get email from ngtech1ltd at gmail.com. Learn why this is
> important <https://aka.ms/LearnAboutSenderIdentification>
>
> Naviga WARNING: External email. Please verify sender before opening
> attachments or clicking on links.
>
> Hey,
>
> Did you manage to find a solution for your use case?
> Let me know if you need assistance with this issue.
>
> Eliezer
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
>
>
> On Tue, Mar 4, 2025 at 1:57?AM Doug Tucker <doug.tucker at navigaglobal.com>
> wrote:
>
> I have read through everything I can find on this subject but still cannot
> seem to get around the issue of windows updates not working through the
> squid transparent proxy.  No matter what I try I continue to see this in
> the cache log and windows update will not connect.
>
> 2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25:
> error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify
> failed (1/-1/0)
>
> I tried adding the info from the following doc to no avail.
>
> https://wiki.squid-cache.org/SquidFaq/WindowsUpdate
>
>
> The relevant parts of my squid.conf:
>
> #Handling HTTPS requests
> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
> acl SSL_port port 443
> http_access allow SSL_port
> acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump peek step1 all
> ssl_bump peek step2 allowed_https_sites
> ssl_bump splice step3 allowed_https_sites
> ssl_bump terminate step2 all
>
> #windows update
> acl DiscoverSNIHost at_step SslBump1
> acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
> ssl_bump splice NoSSLIntercept
> ssl_bump peek DiscoverSNIHost
> ssl_bump bump all
>
> I ran tcpdump and added every url i could find to the allowed-sites.txt
> and added the 2 sites recommended tot he url.nobump.  If anyone has gotten
> this to work any help would be appreciated.
>
>
>
>
>
>
> *Doug Tucker*
> Sr. Director of Networking and Linux Operations
>
> *o:* 817.975.5832
> *e: *doug.tucker at navigaglobal.com
>
>
> Newscycle Solutions is now Naviga. Learn more.
>
>
> CONFIDENTIALITY NOTICE: The contents of this email message and any
> attachments are intended solely for the addressee(s) and may contain
> confidential and/or privileged information and may be legally protected
> from disclosure. If you are not the intended recipient of this message or
> their agent, or if this message has been addressed to you in error, please
> immediately alert the sender by reply email and then delete this message
> and any attachments. If you are not the intended recipient, you are hereby
> notified that any use, dissemination, copying, or storage of this message
> or its attachments is strictly prohibite
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/577d7dd0/attachment-0001.htm>

From ngtech1ltd at gmail.com  Sun Mar 16 20:32:01 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Sun, 16 Mar 2025 22:32:01 +0200
Subject: [squid-users] Kids control and time limit function
In-Reply-To: <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>
References: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>
 <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>
Message-ID: <CABA8h=QBKtCCeicQMcgEfk5C=+QYD3pb9f5DWzSWM4P+ZQVkow@mail.gmail.com>

There is an issue with squid config file.
There is a limit to how many times i can trigger a reload.
I would like to configure it by the minute with a db or some external
config file.

For now I am trying to use a mysql db and it's fine with both mysql and
sqlite.
I have a web ui and x grok3 helps me to implement what I was thinking about.

So the filtering option would be either a user name or a mac address or a
src ip or some tag that might be based on authentication via a radius
server on a ppp connection.

I am unsure if ISP's will use squid and collect user related meta data such
as authentication.
If a radius ppp login would register the username and the ip and on a login
it would unregister the username from the ip, it would pretty nice and it
will allow to use such a webui to manage access in the ISP level.



----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

?????? ??? ??, 16 ???? 2025, 17:48, ??? Jonathan Lee ?<
jonathanlee571 at gmail.com>:

> This would block everything during a time frame
>
> acl block_hours time 00:30-05:00
> ssl_bump terminate all block_hours
> http_access deny all block_hours
>
> Squid?s time directive is what you need.
>
> Sent from my iPhone
>
> On Mar 16, 2025, at 01:52, NgTech LTD <ngtech1ltd at gmail.com> wrote:
>
> ?
> I was wondering if there is a ready to use solution with web-ui for kid
> time limit.
> I am using mikrotik kid-control which is very nice and I was wondering if
> anyone have implemented a similar function for squid with an external-acl
> helper.
> The src options are by:
> * username
> * src ip address
> * src mac address
>
> There should be a schedule in a DB per user ID.
> The external ACL helper should cache for about 30 seconds and the table
> should be by an hour and day of the week.
> This way it would be pretty simple to build a web ui to manage the
> schedule.
>
> I would like to get some input on things that kid control might be good
> doing.
>
> Thanks,
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/05eda95e/attachment.htm>

From ngtech1ltd at gmail.com  Mon Mar 17 00:43:25 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Mon, 17 Mar 2025 02:43:25 +0200
Subject: [squid-users] windows updates
In-Reply-To: <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>
References: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
 <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>
 <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>
Message-ID: <CABA8h=R7+i7m23LG7sK+HbOd8q-4e6L0N_0FcfuSkHCrwbemiw@mail.gmail.com>

I have not tried to use SSL bump but with a regular proxy which blocks
everything else then the next list of dstdomain:
.delivery.mp.microsoft.com (http)
.dsp.mp.microsoft.com (http)
.download.windowsupdate.com (http)
static.edge.microsoftapp.net (HTTPS-connect)

The windows updates works just fine.
And as I wrote before, there are two channels: Secure for communication and
plain HTTP for data transfer.

If you need more help let me know.

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com


On Sun, Mar 16, 2025 at 4:34?PM Doug Tucker <doug.tucker at navigaglobal.com>
wrote:

> No, no one responded.
>
> Doug Tucker
> Sr. Director of Networking and Linux Operations
> doug.tucker at navigaglobal.com
> ------------------------------
> *From:* NgTech LTD <ngtech1ltd at gmail.com>
> *Sent:* Sunday, March 16, 2025 2:38:35 AM
> *To:* Doug Tucker <doug.tucker at navigaglobal.com>
> *Cc:* squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org
> >
> *Subject:* Re: [squid-users] windows updates
>
> You don't often get email from ngtech1ltd at gmail.com. Learn why this is
> important <https://aka.ms/LearnAboutSenderIdentification>
>
> Naviga WARNING: External email. Please verify sender before opening
> attachments or clicking on links.
>
> Hey,
>
> Did you manage to find a solution for your use case?
> Let me know if you need assistance with this issue.
>
> Eliezer
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
>
>
> On Tue, Mar 4, 2025 at 1:57?AM Doug Tucker <doug.tucker at navigaglobal.com>
> wrote:
>
> I have read through everything I can find on this subject but still cannot
> seem to get around the issue of windows updates not working through the
> squid transparent proxy.  No matter what I try I continue to see this in
> the cache log and windows update will not connect.
>
> 2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25:
> error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify
> failed (1/-1/0)
>
> I tried adding the info from the following doc to no avail.
>
> https://wiki.squid-cache.org/SquidFaq/WindowsUpdate
>
>
> The relevant parts of my squid.conf:
>
> #Handling HTTPS requests
> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
> acl SSL_port port 443
> http_access allow SSL_port
> acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump peek step1 all
> ssl_bump peek step2 allowed_https_sites
> ssl_bump splice step3 allowed_https_sites
> ssl_bump terminate step2 all
>
> #windows update
> acl DiscoverSNIHost at_step SslBump1
> acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
> ssl_bump splice NoSSLIntercept
> ssl_bump peek DiscoverSNIHost
> ssl_bump bump all
>
> I ran tcpdump and added every url i could find to the allowed-sites.txt
> and added the 2 sites recommended tot he url.nobump.  If anyone has gotten
> this to work any help would be appreciated.
>
>
>
>
>
>
> *Doug Tucker*
> Sr. Director of Networking and Linux Operations
>
> *o:* 817.975.5832
> *e: *doug.tucker at navigaglobal.com
>
>
> Newscycle Solutions is now Naviga. Learn more.
>
>
> CONFIDENTIALITY NOTICE: The contents of this email message and any
> attachments are intended solely for the addressee(s) and may contain
> confidential and/or privileged information and may be legally protected
> from disclosure. If you are not the intended recipient of this message or
> their agent, or if this message has been addressed to you in error, please
> immediately alert the sender by reply email and then delete this message
> and any attachments. If you are not the intended recipient, you are hereby
> notified that any use, dissemination, copying, or storage of this message
> or its attachments is strictly prohibite
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250317/040a772d/attachment-0001.htm>

From jonathanlee571 at gmail.com  Mon Mar 17 01:26:53 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sun, 16 Mar 2025 18:26:53 -0700
Subject: [squid-users] Kids control and time limit function
In-Reply-To: <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>
References: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>
 <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>
Message-ID: <54ADAF44-E517-446D-BF95-B34BCAC8DAFA@gmail.com>



	acl aclname time [day-abbrevs] [h1:m1-h2:m2]
	  # [fast]
	  #  day-abbrevs:
	  #	S - Sunday
	  #	M - Monday
	  #	T - Tuesday
	  #	W - Wednesday
	  #	H - Thursday
	  #	F - Friday
	  #	A - Saturday
	  #  h1:m1 must be less than h2:m2


You can add any ACL with time based needs?

Is this what you're looking for?
> On Mar 16, 2025, at 08:41, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
> 
> This would block everything during a time frame 
> 
> acl block_hours time 00:30-05:00
> ssl_bump terminate all block_hours
> http_access deny all block_hours
> 
> Squid?s time directive is what you need. 
> 
> Sent from my iPhone
> 
>> On Mar 16, 2025, at 01:52, NgTech LTD <ngtech1ltd at gmail.com> wrote:
>> 
>> ?
>> I was wondering if there is a ready to use solution with web-ui for kid time limit.
>> I am using mikrotik kid-control which is very nice and I was wondering if anyone have implemented a similar function for squid with an external-acl helper.
>> The src options are by:
>> * username
>> * src ip address
>> * src mac address
>> 
>> There should be a schedule in a DB per user ID.
>> The external ACL helper should cache for about 30 seconds and the table should be by an hour and day of the week.
>> This way it would be pretty simple to build a web ui to manage the schedule.
>> 
>> I would like to get some input on things that kid control might be good doing.
>> 
>> Thanks,
>> ----
>> Eliezer Croitoru
>> Tech Support
>> Mobile: +972-5-28704261
>> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250316/c51ad67c/attachment.htm>

From ngtech1ltd at gmail.com  Mon Mar 17 11:38:48 2025
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Mon, 17 Mar 2025 13:38:48 +0200
Subject: [squid-users] Kids control and time limit function
In-Reply-To: <54ADAF44-E517-446D-BF95-B34BCAC8DAFA@gmail.com>
References: <CABA8h=RFtfU=j8+Q+XtJ=9MT+tOK+a4wNAzEE-9xafmhDHTrCw@mail.gmail.com>
 <6338F5F0-0635-4E81-80CD-D85A972F5A19@gmail.com>
 <54ADAF44-E517-446D-BF95-B34BCAC8DAFA@gmail.com>
Message-ID: <CABA8h=Tgz2nGqnuMviC5sOQrd-tdVxdRFoWiLHXaNFz9koSseQ@mail.gmail.com>

I know this ACL.
However managing the ACLs statically is not the same as dynamically.
Managing squid.conf or any squid.conf formatted file is kinds of an issue
when using a web ui.
It's much easier for me to handle a sqlite/mysql table for that.
If I set the times to static ie by the hour ie 0-1 and 1-2 and 2-3 coupled
with the day, it's pretty easy to handle.
And if the web ui is simple enough you can manage the times on the fly with
a margin of error by a minute.
It's kids not a business so it's enough for my use case.
I just need to allow them to surf or block them as needed and also in a
planned matter.
There is another factor which I have considered and it's a timer based
external_acl helper.
A helper that will check for the current state and then allow or deny based
on the timer and in time the scheduler will
send a command to the timer.

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com


On Mon, Mar 17, 2025 at 3:27?AM Jonathan Lee <jonathanlee571 at gmail.com>
wrote:

>
> 	acl aclname time [day-abbrevs] [h1:m1-h2:m2]
> 	  # [fast]
> 	  #  day-abbrevs:
> 	  #	S - Sunday
> 	  #	M - Monday
> 	  #	T - Tuesday
> 	  #	W - Wednesday
> 	  #	H - Thursday
> 	  #	F - Friday
> 	  #	A - Saturday
> 	  #  h1:m1 must be less than h2:m2
>
>
>
> You can add any ACL with time based needs?
>
> Is this what you're looking for?
>
> On Mar 16, 2025, at 08:41, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>
> This would block everything during a time frame
>
> acl block_hours time 00:30-05:00
> ssl_bump terminate all block_hours
> http_access deny all block_hours
>
> Squid?s time directive is what you need.
>
> Sent from my iPhone
>
> On Mar 16, 2025, at 01:52, NgTech LTD <ngtech1ltd at gmail.com> wrote:
>
> ?
> I was wondering if there is a ready to use solution with web-ui for kid
> time limit.
> I am using mikrotik kid-control which is very nice and I was wondering if
> anyone have implemented a similar function for squid with an external-acl
> helper.
> The src options are by:
> * username
> * src ip address
> * src mac address
>
> There should be a schedule in a DB per user ID.
> The external ACL helper should cache for about 30 seconds and the table
> should be by an hour and day of the week.
> This way it would be pretty simple to build a web ui to manage the
> schedule.
>
> I would like to get some input on things that kid control might be good
> doing.
>
> Thanks,
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250317/38081074/attachment.htm>

From david at articatech.com  Tue Mar 18 10:25:38 2025
From: david at articatech.com (David Touzeau)
Date: Tue, 18 Mar 2025 11:25:38 +0100
Subject: [squid-users] squid 6.3: client internal ip address PTR DNS query
Message-ID: <a05b87ee-4999-499f-8f92-e54f21a0c9a6@articatech.com>


We note that Squid performs a client DNS PTR query each time client 
sends query.

We have taken care to ensure that

  * that the log model does not use machine names
  * No acls concerning workstation hostnames are added.


We use kerberos authentication with Squid: is 
negotiate_kerberos_auth/process plugin is able to perform PTR requests?

Is there another option that denies squid to perform such requests?

Regards
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250318/2833717f/attachment.htm>

From uhlar at fantomas.sk  Tue Mar 18 10:52:18 2025
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 18 Mar 2025 11:52:18 +0100
Subject: [squid-users] squid 6.13 debian package
In-Reply-To: <6cd95685-a19e-414c-a59d-44be59eaadb0@treenet.co.nz>
References: <Z7dY9xAwSPBwaT26@fantomas.sk>
 <04427622-9d28-4b8b-a25c-118448852b60@treenet.co.nz>
 <Z7mXKyaC011jiztw@fantomas.sk>
 <6cd95685-a19e-414c-a59d-44be59eaadb0@treenet.co.nz>
Message-ID: <Z9lQYn3DP8qsx1FM@fantomas.sk>

>On 22/02/25 22:21, Matus UHLAR - fantomas wrote:
>>>On 21/02/25 05:31, Matus UHLAR - fantomas wrote:
>>>>I am trying to manually backport squid-6.13 to Debian 12.
>>>>
>>>>looks like newest squid-openssl Pre-Depends: on "squid"
>>>>however "squid" is in conflict with "squid-openssl"
>>>>
>>>>Is this a bug in control package or did something change since 6.10
>>>>(which I backported successfully)
>>>>??

>>On 22.02.25 21:25, Amos Jeffries wrote:
>>>That is correct. The Debian 'squid-openssl' package now extends 
>>>the default 'squid' package with OpenSSL support binaries instead 
>>>of replacing everything.
>>>
>>>The backport needs to supply both 'squid' and 'squid-openssl' 
>>>built from the 6.13 sources.

>>Pre-Depends requires dependent package "squid" (without openssl  
>>support) being fully configured before squid-openssl gets installed.
>>
>>Doesn't that mean that squid will be restarted twice, and first 
>>instance will run squid without openssl support and thus without 
>>required functionality?

On 23.02.25 00:39, Amos Jeffries wrote:
>Maybe, I do not recall what upgrade tests showed for apt output.
>
>AFAIK it should only be restarted once. The 'Conflicts' on older 
>squid-openssl packages forces apt/dpkg to treat them as a pair on 
>transition.
>After transition 'squid' is an alias to whichever is preferred.

Just FYI:

I tried manually upgrading squid to 6.13 on three machines.

The Pre-Depends: caused some troubles, I needed to call dpkg install 
multiple times.  

Luckily (or unluckily?) squid did not get restarted during during manual 
installs, so I only restarted manually after new versions were in place.

I would manually prefer using package like squid-base for common 
architecture-dependent files (squid-common is for architecture-independent 
files) but that's up to maintainers.

I will try upgrading to debian testing to check how it works.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
WinError #99999: Out of error messages.

From rousskov at measurement-factory.com  Tue Mar 18 14:07:56 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 18 Mar 2025 10:07:56 -0400
Subject: [squid-users] squid 6.3: client internal ip address PTR DNS
 query
In-Reply-To: <a05b87ee-4999-499f-8f92-e54f21a0c9a6@articatech.com>
References: <a05b87ee-4999-499f-8f92-e54f21a0c9a6@articatech.com>
Message-ID: <f37bf2d2-502b-4253-a1a2-93202e2b1482@measurement-factory.com>

On 2025-03-18 06:25, David Touzeau wrote:
> 
> We note that Squid performs a client DNS PTR query each time client 
> sends query.
> 
> We have taken care to ensure that
> 
>   * that the log model does not use machine names
>   * No acls concerning workstation hostnames are added.

FWIW, the phrase "workstation hostnames" is a red flag for me, 
especially when the other bullet uses "machine names" terminology. In my 
experience, it is easy to overlook a logformat %code or ACL that 
requires Squid to do a reverse DNS lookup.

N.B. In modern Squids (including your v6.3), default ICAP logformat 
triggers reverse DNS lookups if icap_log is enabled.


> We use kerberos authentication with Squid: is 
> negotiate_kerberos_auth/process plugin is able to perform PTR requests?

I am not a Kerberos expert, but I believe that plugin can trigger DNS 
requests at startup (at least). I do not know whether it can trigger DNS 
requests at runtime. You should be able to check that theory by 
disabling authentication for a test client/transaction.


> Is there another option that denies squid to perform such requests?

I do not think so. You have to figure out what triggers those queries 
and adjust the corresponding configuration accordingly. I can offer a 
free private review of your cache.log file collected while reproducing 
the problem using as few transactions as possible and enabling full 
debugging (e.g., setting debug_options to ALL,9). More hints are 
available at 
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

If you would like to proceed with the above analysis, please email me a 
link to the corresponding compressed cache.log.


HTH,

Alex.


From david at articatech.com  Tue Mar 18 18:41:12 2025
From: david at articatech.com (David Touzeau)
Date: Tue, 18 Mar 2025 19:41:12 +0100
Subject: [squid-users] squid 6.3: client internal ip address PTR DNS
 query
In-Reply-To: <f37bf2d2-502b-4253-a1a2-93202e2b1482@measurement-factory.com>
References: <a05b87ee-4999-499f-8f92-e54f21a0c9a6@articatech.com>
 <f37bf2d2-502b-4253-a1a2-93202e2b1482@measurement-factory.com>
Message-ID: <1a0da000-9739-41eb-97b1-b26592663776@articatech.com>

Hi Alex

Thanks

The information provided is very useful.
Although ICAP is not used, the log configuration is active.
Let's validate the first leads you've given us

regards

Le 18/03/2025 ? 15:07, Alex Rousskov a ?crit?:
> On 2025-03-18 06:25, David Touzeau wrote:
>>
>> We note that Squid performs a client DNS PTR query each time client 
>> sends query.
>>
>> We have taken care to ensure that
>>
>> ? * that the log model does not use machine names
>> ? * No acls concerning workstation hostnames are added.
>
> FWIW, the phrase "workstation hostnames" is a red flag for me, 
> especially when the other bullet uses "machine names" terminology. In 
> my experience, it is easy to overlook a logformat %code or ACL that 
> requires Squid to do a reverse DNS lookup.
>
> N.B. In modern Squids (including your v6.3), default ICAP logformat 
> triggers reverse DNS lookups if icap_log is enabled.
>
>
>> We use kerberos authentication with Squid: is 
>> negotiate_kerberos_auth/process plugin is able to perform PTR requests?
>
> I am not a Kerberos expert, but I believe that plugin can trigger DNS 
> requests at startup (at least). I do not know whether it can trigger 
> DNS requests at runtime. You should be able to check that theory by 
> disabling authentication for a test client/transaction.
>
>
>> Is there another option that denies squid to perform such requests?
>
> I do not think so. You have to figure out what triggers those queries 
> and adjust the corresponding configuration accordingly. I can offer a 
> free private review of your cache.log file collected while reproducing 
> the problem using as few transactions as possible and enabling full 
> debugging (e.g., setting debug_options to ALL,9). More hints are 
> available at 
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>
> If you would like to proceed with the above analysis, please email me 
> a link to the corresponding compressed cache.log.
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250318/d30d145b/attachment.htm>

From doug.tucker at navigaglobal.com  Wed Mar 19 19:47:56 2025
From: doug.tucker at navigaglobal.com (Doug Tucker)
Date: Wed, 19 Mar 2025 19:47:56 +0000
Subject: [squid-users] windows updates
In-Reply-To: <CABA8h=R7+i7m23LG7sK+HbOd8q-4e6L0N_0FcfuSkHCrwbemiw@mail.gmail.com>
References: <LV8PR13MB6557CCD08E037732B6ACAEF881C92@LV8PR13MB6557.namprd13.prod.outlook.com>
 <CABA8h=SSx+2oSeVnfaga2G=MzRjVy9J+GKN27Zcop7i2LbVsow@mail.gmail.com>
 <LV8PR13MB655735E8E46A2008474DC1A081DC2@LV8PR13MB6557.namprd13.prod.outlook.com>
 <CABA8h=R7+i7m23LG7sK+HbOd8q-4e6L0N_0FcfuSkHCrwbemiw@mail.gmail.com>
Message-ID: <LV8PR13MB6557BBD8BB39DAB3C12A001F81D92@LV8PR13MB6557.namprd13.prod.outlook.com>

I took out the ssl bump but I added the 1 that was missing from your list below with no positive results.  Windows update just spins and eventually times out.  This is what my config looks like if you have any advice.  Again, the proxy is working for normal web traffic, just not with windows update.

visible_hostname squid
workers 6
cache_mem 1024 MB
maximum_object_size_in_memory 1024 KB
memory_cache_shared on
range_offset_limit 200 MB
maximum_object_size 200 MB
cache_dir aufs /var/scached 4096 16 256
access_log /var/log/squid/access.log squid
cache_mgr manager
cachemgr_passwd none all
http_access allow manager localhost
http_access deny manager

#Handling HTTP requests
http_port 3129 intercept
acl blocked url_regex gmail
http_access deny blocked
acl allowed_http_sites dstdomain "/etc/squid/allowed-sites.txt"
http_access allow allowed_http_sites

#Handling HTTPS requests
https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate step2 all





Doug Tucker
Sr. Director of Networking and Linux Operations

o: 817.975.5832
e: doug.tucker at navigaglobal.com


Newscycle Solutions is now Naviga. Learn more.


CONFIDENTIALITY NOTICE: The contents of this email message and any attachments are intended solely for the addressee(s) and may contain confidential and/or privileged information and may be legally protected from disclosure. If you are not the intended recipient of this message or their agent, or if this message has been addressed to you in error, please immediately alert the sender by reply email and then delete this message and any attachments. If you are not the intended recipient, you are hereby notified that any use, dissemination, copying, or storage of this message or its attachments is strictly prohibite

________________________________
From: NgTech LTD <ngtech1ltd at gmail.com>
Sent: Sunday, March 16, 2025 6:43 PM
To: Doug Tucker <doug.tucker at navigaglobal.com>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] windows updates

You don't often get email from ngtech1ltd at gmail.com. Learn why this is important<https://aka.ms/LearnAboutSenderIdentification>
I have not tried to use SSL bump but with a regular proxy which blocks everything else then the next list of dstdomain:
.delivery.mp.microsoft.com<http://delivery.mp.microsoft.com/> (http)
.dsp.mp.microsoft.com<http://dsp.mp.microsoft.com/> (http)
.download.windowsupdate.com<http://download.windowsupdate.com/> (http)
static.edge.microsoftapp.net<http://static.edge.microsoftapp.net/> (HTTPS-connect)

The windows updates works just fine.
And as I wrote before, there are two channels: Secure for communication and plain HTTP for data transfer.

If you need more help let me know.

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>


On Sun, Mar 16, 2025 at 4:34?PM Doug Tucker <doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>> wrote:
No, no one responded.

Doug Tucker
Sr. Director of Networking and Linux Operations
doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>
________________________________
From: NgTech LTD <ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>>
Sent: Sunday, March 16, 2025 2:38:35 AM
To: Doug Tucker <doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>>
Cc: squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org> <squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>>
Subject: Re: [squid-users] windows updates

You don't often get email from ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>. Learn why this is important<https://aka.ms/LearnAboutSenderIdentification>

Naviga WARNING: External email. Please verify sender before opening attachments or clicking on links.

Hey,

Did you manage to find a solution for your use case?
Let me know if you need assistance with this issue.

Eliezer
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>


On Tue, Mar 4, 2025 at 1:57?AM Doug Tucker <doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>> wrote:
I have read through everything I can find on this subject but still cannot seem to get around the issue of windows updates not working through the squid transparent proxy.  No matter what I try I continue to see this in the cache log and windows update will not connect.

2025/03/03 23:26:55 kid5| Error negotiating SSL on FD 25: error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify failed (1/-1/0)

I tried adding the info from the following doc to no avail.

https://wiki.squid-cache.org/SquidFaq/WindowsUpdate


The relevant parts of my squid.conf:

#Handling HTTPS requests
https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name "/etc/squid/allowed-sites.txt"
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate step2 all

#windows update
acl DiscoverSNIHost at_step SslBump1
acl NoSSLIntercept ssl::server_name_regex -i "/etc/squid/url.nobump"
ssl_bump splice NoSSLIntercept
ssl_bump peek DiscoverSNIHost
ssl_bump bump all

I ran tcpdump and added every url i could find to the allowed-sites.txt and added the 2 sites recommended tot he url.nobump.  If anyone has gotten this to work any help would be appreciated.







Doug Tucker
Sr. Director of Networking and Linux Operations

o: 817.975.5832
e: doug.tucker at navigaglobal.com<mailto:doug.tucker at navigaglobal.com>


Newscycle Solutions is now Naviga. Learn more.


CONFIDENTIALITY NOTICE: The contents of this email message and any attachments are intended solely for the addressee(s) and may contain confidential and/or privileged information and may be legally protected from disclosure. If you are not the intended recipient of this message or their agent, or if this message has been addressed to you in error, please immediately alert the sender by reply email and then delete this message and any attachments. If you are not the intended recipient, you are hereby notified that any use, dissemination, copying, or storage of this message or its attachments is strictly prohibite

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250319/df9a150e/attachment-0001.htm>

From Robert.Zenz at bonsaimind.org  Tue Mar 25 10:37:47 2025
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Tue, 25 Mar 2025 11:37:47 +0100
Subject: [squid-users] sslcrtvalidator_program input not separated by "\1"?
Message-ID: <20250325113747.49b5a01d@Dagon>

I'm currently implementing an extended certificate verification script
for usage with "sslcrtvalidator_program", but I've encountered a hiccup
during that.

The documentation at
https://wiki.squid-cache.org/Features/SslServerCertValidator#helper-communication-protocol
is suggesting that the script will receive "lines" which are separated
by a 0x01 byte.

 > Input line received from Squid:
 > 
 >     request size [kv-pairs]
 > 
 >  > :warning: line refers to a logical input. body may contain \n
 >  > characters so each line in this format is delimited by a 0x01 byte
 >  > instead of the standard \n byte.

However, as far as I can tell that's not the case, the
input "lines" are not separated by 0x01. The example script at
https://github.com/squid-cache/squid/blob/master/src/security/cert_validators/fake/security_fake_certverify.pl.in
seems to be aware of that, as it reads the input line based on the body
length provided.

My script is written in AWK, basically it can be summed up as:

    BEGIN {
        RS = "\1"
    }
    
    {
        print("<" $1 ">")>"/dev/stderr"
        printf("BH message=\"TEST\"\1")
    }

And it never starts processing any input from Squid because 0x01 doesn't
seem to be sent at all. I did have a quick look at the helper.cc, and it
doesn't seem to use the "eom" during sending the message at all.

Am I misunderstanding the documentation here? Is my script/approach
broken somehow and do I need to adjust that to read lines based on
provided length?

From squid3 at treenet.co.nz  Tue Mar 25 11:31:08 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 26 Mar 2025 00:31:08 +1300
Subject: [squid-users] sslcrtvalidator_program input not separated by
 "\1"?
In-Reply-To: <20250325113747.49b5a01d@Dagon>
References: <20250325113747.49b5a01d@Dagon>
Message-ID: <3e11be8a-1678-4e79-a7d2-48e8f4d2d2a9@treenet.co.nz>

I see that note in the documentation predates the protocol change to 
include size parameters.

In modern Squid it only applies to the **response** from certificate 
generator/validator helpers back to Squid.


Your helper should do what the example 'fake' helper does;
  * read one '\n' terminated line of input.
  * parse the ( result SP size SP ) out of that first line
  * loop until more '\n' terminated lines have arrived providing a total 
of 'size' bytes worth of kv-pairs (aka "body").
  * ignore any garbage received on final \n terminated line (should only 
be a CRLF).
  * send reply followed by the '\1' character.


Amos


On 25/03/25 23:37, Robert 'Bobby' Zenz wrote:
> I'm currently implementing an extended certificate verification script
> for usage with "sslcrtvalidator_program", but I've encountered a hiccup
> during that.
> 
> The documentation at
> https://wiki.squid-cache.org/Features/SslServerCertValidator#helper-communication-protocol
> is suggesting that the script will receive "lines" which are separated
> by a 0x01 byte.
> 
>   > Input line received from Squid:
>   >
>   >     request size [kv-pairs]
>   >
>   >  > :warning: line refers to a logical input. body may contain \n
>   >  > characters so each line in this format is delimited by a 0x01 byte
>   >  > instead of the standard \n byte.
> 
> However, as far as I can tell that's not the case, the
> input "lines" are not separated by 0x01. The example script at
> https://github.com/squid-cache/squid/blob/master/src/security/cert_validators/fake/security_fake_certverify.pl.in
> seems to be aware of that, as it reads the input line based on the body
> length provided.
> 
> My script is written in AWK, basically it can be summed up as:
> 
>      BEGIN {
>          RS = "\1"
>      }
>      
>      {
>          print("<" $1 ">")>"/dev/stderr"
>          printf("BH message=\"TEST\"\1")
>      }
> 
> And it never starts processing any input from Squid because 0x01 doesn't
> seem to be sent at all. I did have a quick look at the helper.cc, and it
> doesn't seem to use the "eom" during sending the message at all.
> 
> Am I misunderstanding the documentation here? Is my script/approach
> broken somehow and do I need to adjust that to read lines based on
> provided length?
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From Robert.Zenz at bonsaimind.org  Tue Mar 25 12:38:39 2025
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Tue, 25 Mar 2025 13:38:39 +0100
Subject: [squid-users] sslcrtvalidator_program input not separated by
 "\1"?
In-Reply-To: <3e11be8a-1678-4e79-a7d2-48e8f4d2d2a9@treenet.co.nz>
References: <20250325113747.49b5a01d@Dagon>
 <3e11be8a-1678-4e79-a7d2-48e8f4d2d2a9@treenet.co.nz>
Message-ID: <20250325133839.6cb22ae9@Dagon>

> I see that note in the documentation predates the protocol change to 
> include size parameters.
> 
> In modern Squid it only applies to the **response** from certificate 
> generator/validator helpers back to Squid.

I sorta assumed such a thing, but wasn't sure.

> Your helper should do what the example 'fake' helper does;
>   * read one '\n' terminated line of input.
>   * parse the ( result SP size SP ) out of that first line
>   * loop until more '\n' terminated lines have arrived providing a
> total of 'size' bytes worth of kv-pairs (aka "body").
>   * ignore any garbage received on final \n terminated line (should
> only be a CRLF).
>   * send reply followed by the '\1' character.

Thanks for the detailed explanation. I've changed my script accordingly
and now the interaction behaves as expected.

Thank you for the clarifications!

From lister at rac.unix-admins.com  Tue Mar 25 14:31:25 2025
From: lister at rac.unix-admins.com (Goetz T. Fischer)
Date: Tue, 25 Mar 2025 15:31:25 +0100
Subject: [squid-users] cache doesn't cache
Message-ID: <20250325153125270277.f10d40f1@rac.unix-admins.com>

hi all,

i ran into a slightly odd problem. i'm using the following settings:

cache_dir aufs /mnt/cache/squid 900 16 256
cache_mem 600 MB
maximum_object_size_in_memory 2 MB
maximum_object_size 10 MB

that works fine except for one thing: the cache sizes don't change at all. the folder's size as 
well as the ram used by the squid process are like set in stone. no matter what i do they don't 
change at all. even after days and weeks their size remains the same. the cache folder is stuck at 
63mb and the squid process comsumes 59mb in total. no changes to these values at all.

what am i doing wrong?

thanks for any hints in advance!

--
R-A-C
G?tz T. Fischer CertIT&Comp
+49(0)7225/98 98 79
g.fischer at r-a-c.de
r-a-c.de

From squid.org at bloms.de  Tue Mar 25 14:41:09 2025
From: squid.org at bloms.de (Dieter Bloms)
Date: Tue, 25 Mar 2025 15:41:09 +0100
Subject: [squid-users] cache doesn't cache
In-Reply-To: <20250325153125270277.f10d40f1@rac.unix-admins.com>
References: <20250325153125270277.f10d40f1@rac.unix-admins.com>
Message-ID: <boojziyxufdtmd5hob2a76gigad3n6ekpg62jdg7ilv3gzomxu@jl5xvsblcl33>

Hello Goetz

On Tue, Mar 25, Goetz T. Fischer wrote:

> that works fine except for one thing: the cache sizes don't change at all. the folder's size as 
> well as the ram used by the squid process are like set in stone. no matter what i do they don't 
> change at all. even after days and weeks their size remains the same. the cache folder is stuck at 
> 63mb and the squid process comsumes 59mb in total. no changes to these values at all.
> 
> what am i doing wrong?

Nowadays, data traffic is encrypted and files are not transmitted in plain text.  
Have you activated the ssl_bump so that the proxy can also see the data?


-- 
Regards

  Dieter

--
I do not get viruses because I do not use MS software.
If you use Outlook then please do not put my email address in your
address-book so that WHEN you get a virus it won't use my address in the
>From field.

From lister at rac.unix-admins.com  Tue Mar 25 19:54:04 2025
From: lister at rac.unix-admins.com (Goetz T. Fischer)
Date: Tue, 25 Mar 2025 20:54:04 +0100
Subject: [squid-users] cache doesn't cache
In-Reply-To: <boojziyxufdtmd5hob2a76gigad3n6ekpg62jdg7ilv3gzomxu@jl5xvsblcl33>
References: <20250325153125270277.f10d40f1@rac.unix-admins.com>
 <boojziyxufdtmd5hob2a76gigad3n6ekpg62jdg7ilv3gzomxu@jl5xvsblcl33>
Message-ID: <20250325205404646805.09ddf325@rac.unix-admins.com>

On Tue, 25 Mar 2025 15:41:09 +0100, Dieter Bloms wrote:
> Nowadays, data traffic is encrypted and files are not transmitted in plain text.
> Have you activated the ssl_bump so that the proxy can also see the data?

fair point. i'll check ssl_bump. thanks!

From jonathanlee571 at gmail.com  Wed Mar 26 05:25:51 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 25 Mar 2025 22:25:51 -0700
Subject: [squid-users] cache doesn't cache
In-Reply-To: <20250325205404646805.09ddf325@rac.unix-admins.com>
References: <20250325205404646805.09ddf325@rac.unix-admins.com>
Message-ID: <24ED2F04-A86E-4E56-BDC1-36C05E30AB11@gmail.com>

You will need to issue certificates on the devices to make it work right. It?s an adventure to configure. 
Sent from my iPhone

> On Mar 25, 2025, at 20:02, Goetz T. Fischer <lister at rac.unix-admins.com> wrote:
> 
> ?On Tue, 25 Mar 2025 15:41:09 +0100, Dieter Bloms wrote:
>> Nowadays, data traffic is encrypted and files are not transmitted in plain text.
>> Have you activated the ssl_bump so that the proxy can also see the data?
> 
> fair point. i'll check ssl_bump. thanks!
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

From lister at rac.unix-admins.com  Wed Mar 26 05:31:51 2025
From: lister at rac.unix-admins.com (Goetz T. Fischer)
Date: Wed, 26 Mar 2025 06:31:51 +0100
Subject: [squid-users] cache doesn't cache
In-Reply-To: <24ED2F04-A86E-4E56-BDC1-36C05E30AB11@gmail.com>
References: <20250325205404646805.09ddf325@rac.unix-admins.com>
 <24ED2F04-A86E-4E56-BDC1-36C05E30AB11@gmail.com>
Message-ID: <20250326063151307227.7ced3bd5@rac.unix-admins.com>

On Tue, 25 Mar 2025 22:25:51 -0700, Jonathan Lee wrote:
> You will need to issue certificates on the devices to make it work right. It?s an adventure to 
> configure.

oh it's working already. thanks again for the replies!

