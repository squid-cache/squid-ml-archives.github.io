<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C3983bea2-58c5-459f-b304-6f0e07ed11a1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027481.html">
   <LINK REL="Next"  HREF="027489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C3983bea2-58c5-459f-b304-6f0e07ed11a1%40measurement-factory.com%3E"
       TITLE="[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar  3 14:44:06 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027481.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="027489.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27483">[ date ]</a>
              <a href="thread.html#27483">[ thread ]</a>
              <a href="subject.html#27483">[ subject ]</a>
              <a href="author.html#27483">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-03-02 15:47, Lubos Uhliarik wrote:


&gt;<i> 2024/10/16 17:52:44 kid10| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>
Squid v6 has a few changes that affect SMP startup and shutdown 
sequences. Since you have ruled out upgrading to a supported version, I 
would start by turning on shared_memory_locking in hope that the problem 
lies in a problematic OS configuration.

BTW, that bogus exception text &quot;EX&quot; is a bug. It was fixed in Squid v6. 
Squid v5.10 has a backport of that fix (commit 31f20fda).

Alex.


&gt;<i> We have recently experienced Squid crashes when running Squid in SMP
</I>&gt;<i> mode with 16 workers (workers 16). While reviewing the Squid cache
</I>&gt;<i> logs, I noticed that assertion failures sometimes occurred (usually
</I>&gt;<i> during the shutdown process):
</I>&gt;<i> 
</I>&gt;<i> 2024/10/16 17:52:44 kid10| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:44 kid10| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2024/10/16 17:52:44 kid7| Squid plugin modules loaded: 0
</I>&gt;<i> 2024/10/16 17:52:44 kid7| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:44 kid7| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2024/10/16 17:52:44 kid4| Finished loading MIME types and icons.
</I>&gt;<i> 2024/10/16 17:52:44 kid4| HTCP Disabled.
</I>&gt;<i> 2024/10/16 17:52:44 kid4| Squid plugin modules loaded: 0
</I>&gt;<i> 2024/10/16 17:52:44 kid4| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:44 kid4| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2024/10/16 17:52:44 kid3| Finished loading MIME types and icons.
</I>&gt;<i> 2024/10/16 17:52:44 kid2| Finished loading MIME types and icons.
</I>&gt;<i> 2024/10/16 17:52:44 kid5| Finished loading MIME types and icons.
</I>&gt;<i> 2024/10/16 17:52:45 kid3| HTCP Disabled.
</I>&gt;<i> 2024/10/16 17:52:45 kid2| HTCP Disabled.
</I>&gt;<i> 2024/10/16 17:52:45 kid5| HTCP Disabled.
</I>&gt;<i> 2024/10/16 17:52:45 kid5| Squid plugin modules loaded: 0
</I>&gt;<i> 2024/10/16 17:52:45 kid5| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:45 kid2| Squid plugin modules loaded: 0
</I>&gt;<i> 2024/10/16 17:52:45 kid2| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:45 kid3| Squid plugin modules loaded: 0
</I>&gt;<i> 2024/10/16 17:52:45 kid3| Adaptation support is off.
</I>&gt;<i> 2024/10/16 17:52:45 kid5| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2024/10/16 17:52:45 kid2| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2024/10/16 17:52:45 kid3| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 
</I>&gt;<i> I observed that each &quot;kid&quot; (worker) crashed once, and then Squid
</I>&gt;<i> successfully stopped and restarted.
</I>&gt;<i> 
</I>&gt;<i> Recently, however, the Squid crashes started occurring during the
</I>&gt;<i> start process. The crashes now happen multiple times per worker,
</I>&gt;<i> causing Squid to enter a crash loop. This continues until the hard
</I>&gt;<i> drive fills up with core dumps:
</I>&gt;<i> 
</I>&gt;<i> 2025/02/18 10:17:17 kid4| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Current Directory is /
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Starting Squid Cache version 5.5 for
</I>&gt;<i> x86_64-redhat-linux-gnu...
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Service Name: squid
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Process ID 18779
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Process Roles: worker
</I>&gt;<i> 2025/02/18 10:17:17 kid10| With 65536 file descriptors available
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Initializing IP Cache...
</I>&gt;<i> 2025/02/18 10:17:17 kid10| DNS Socket created at [::], FD 13
</I>&gt;<i> 2025/02/18 10:17:17 kid10| DNS Socket created at 0.0.0.0, FD 14
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Adding nameserver 127.0.0.1 from squid.conf
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Logfile: opening log /var/log/squid/access.log
</I>&gt;<i> 2025/02/18 10:17:17 kid10| WARNING: log name now starts with a module
</I>&gt;<i> name. Use 'stdio:/var/log/squid/access.log'
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Local cache digest enabled; rebuild/rewrite
</I>&gt;<i> every 3600/3600 sec
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Store logging disabled
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Swap maxSize 0 + 262144 KB, estimated 20164 objects
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Target number of buckets: 1008
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Using 8192 Store buckets
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Max Mem  size: 262144 KB [shared]
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Max Swap size: 0 KB
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Using Least Load store dir selection
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Current Directory is /
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Finished loading MIME types and icons.
</I>&gt;<i> 2025/02/18 10:17:17 kid10| HTCP Disabled.
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Squid plugin modules loaded: 0
</I>&gt;<i> 2025/02/18 10:17:17 kid10| Adaptation support is off.
</I>&gt;<i> 2025/02/18 10:17:17 kid10| assertion failed: Queue.cc:388: &quot;EX&quot;
</I>&gt;<i> 2025/02/18 10:17:17 kid7| Current Directory is /
</I>&gt;<i> 
</I>&gt;<i> I investigated the core dump, and the code where Squid is crashing is
</I>&gt;<i> as follows:
</I>&gt;<i> 
</I>&gt;<i> #0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
</I>&gt;<i> Missing separate debuginfos, use: dnf debuginfo-install
</I>&gt;<i> glibc-2.34-125.el9_5.1.x86_64 keyutils-libs-1.6.3-1.el9.x86_64
</I>&gt;<i> krb5-libs-1.21.1-4.el9_5.x86_64 libcap-2.48-9.el9_2.x86_64
</I>&gt;<i> libcom_err-1.46.5-5.el9.x86_64 libecap-1.0.1-10.el9.x86_64
</I>&gt;<i> libgcc-11.5.0-2.el9.x86_64 libgcrypt-1.10.0-11.el9.x86_64
</I>&gt;<i> libgpg-error-1.42-5.el9.x86_64 libselinux-3.6-1.el9.x86_64
</I>&gt;<i> libstdc++-11.5.0-2.el9.x86_64 libtool-ltdl-2.4.6-46.el9.x86_64
</I>&gt;<i> libzstd-1.5.1-2.el9.x86_64 lz4-libs-1.9.3-5.el9.x86_64
</I>&gt;<i> openssl-libs-3.2.2-6.el9_5.x86_64 pcre2-10.40-6.el9.x86_64
</I>&gt;<i> sssd-client-2.9.5-4.el9_5.4.x86_64 systemd-libs-252-46.el9_5.2.x86_64
</I>&gt;<i> xz-libs-5.2.5-8.el9_0.x86_64 zlib-1.2.11-40.el9.x86_64
</I>&gt;<i> (gdb) bt
</I>&gt;<i> #0  0x00007f77b288ba6c in __pthread_kill_implementation () from /lib64/libc.so.6
</I>&gt;<i> #1  0x00007f77b283e686 in raise () from /lib64/libc.so.6
</I>&gt;<i> #2  0x00007f77b2828833 in abort () from /lib64/libc.so.6
</I>&gt;<i> #3  0x0000559bbb412a9d in xassert (msg=&lt;optimized out&gt;,
</I>&gt;<i> file=&lt;optimized out&gt;, line=&lt;optimized out&gt;) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/debug.cc:624
</I>&gt;<i> #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
</I>&gt;<i> this=0x559bbccbf6e0) at ipc/Queue.cc:388
</I>&gt;<i> #5  Ipc::MultiQueue::localReader (this=0x559bbccbf6e0) at ipc/Queue.cc:408
</I>&gt;<i> #6  0x0000559bbb74c192 in Ipc::BaseMultiQueue::localReader
</I>&gt;<i> (this=&lt;optimized out&gt;) at ipc/Queue.cc:195
</I>&gt;<i> #7  Ipc::BaseMultiQueue::clearAllReaderSignals (this=&lt;optimized out&gt;)
</I>&gt;<i> at ipc/Queue.cc:155
</I>&gt;<i> #8  0x0000559bbb486724 in CollapsedForwarding::HandleNewDataAtStart ()
</I>&gt;<i> at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/CollapsedForwarding.cc:151
</I>&gt;<i> #9  0x0000559bbb6aa50b in AsyncCallQueue::fireNext
</I>&gt;<i> (this=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">this at entry</A>=0x559bbccd18a0) at base/../../src/base/RefCount.h:73
</I>&gt;<i> #10 0x0000559bbb6aa89a in AsyncCallQueue::fire (this=0x559bbccd18a0)
</I>&gt;<i> at base/AsyncCallQueue.cc:43
</I>&gt;<i> #11 0x0000559bbb490da1 in EventLoop::dispatchCalls
</I>&gt;<i> (this=0x7fff2d084b90) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:144
</I>&gt;<i> #12 EventLoop::runOnce (this=0x7fff2d084b90) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:109
</I>&gt;<i> #13 0x0000559bbb5929a8 in EventLoop::run (this=0x7fff2d084b90) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/EventLoop.cc:83
</I>&gt;<i> #14 SquidMain (argc=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">argc at entry</A>=5, argv=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">argv at entry</A>=0x7fff2d084ea8) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1716
</I>&gt;<i> #15 0x0000559bbb436086 in SquidMainSafe (argv=0x7fff2d084ea8, argc=5)
</I>&gt;<i> at /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1403
</I>&gt;<i> #16 main (argc=5, argv=0x7fff2d084ea8) at
</I>&gt;<i> /usr/src/debug/squid-5.5-14.el9_5.3.x86_64/src/main.cc:1391
</I>&gt;<i> (gdb) f 4
</I>&gt;<i> #4  0x0000559bbb7549f7 in Ipc::MultiQueue::reader (processId=3,
</I>&gt;<i> this=0x559bbccbf6e0) at ipc/Queue.cc:388
</I>&gt;<i> 388        assert(validProcessId(processId));
</I>&gt;<i> (gdb) list
</I>&gt;<i> 383    }
</I>&gt;<i> 384
</I>&gt;<i> 385    const Ipc::QueueReader &amp;
</I>&gt;<i> 386    Ipc::MultiQueue::reader(const int processId) const
</I>&gt;<i> 387    {
</I>&gt;<i> 388        assert(validProcessId(processId));
</I>&gt;<i> 389        const int index = processId - metadata-&gt;theProcessIdOffset;
</I>&gt;<i> 390        return readers-&gt;theReaders[index];
</I>&gt;<i> 391    }
</I>&gt;<i> 392
</I>&gt;<i> (gdb) p processId
</I>&gt;<i> $1 = 3
</I>&gt;<i> (gdb) p metadata
</I>&gt;<i> $15 = {&lt;RefCount&lt;Ipc::Mem::Object&lt;Ipc::MultiQueue::Metadata&gt; &gt;&gt; = {p_
</I>&gt;<i> = 0x559bbccd9f30}, &lt;No data fields&gt;} (gdb) p *metadata.p_
</I>&gt;<i> $16 = {&lt;Lock&gt; = {_vptr.Lock = 0x559bbb96ea30 &lt;vtable for
</I>&gt;<i> Ipc::Mem::Object&lt;Ipc::MultiQueue::Metadata&gt;+64&gt;, count_ = 1},
</I>&gt;<i>    _vptr.Object = 0x559bbb96ea08 &lt;vtable for
</I>&gt;<i> Ipc::Mem::Object&lt;Ipc::MultiQueue::Metadata&gt;+24&gt;, theSegment = {theFD =
</I>&gt;<i> 9, theName = {static npos = 18446744073709551615, size_ = 40, len_ =
</I>&gt;<i> 23,
</I>&gt;<i>        static SizeMax_ = 196607, buf_ = 0x559bbccbc460
</I>&gt;<i> &quot;/squid-cf__metadata.shm&quot;}, theMem = 0x7f77b3720000, theSize = 8,
</I>&gt;<i> theReserved = 0, doUnlink = false}, theObject = 0x7f77b3720000}
</I>&gt;<i> (gdb) p metadata.p_-&gt;theObject
</I>&gt;<i> $17 = (Ipc::MultiQueue::Metadata *) 0x7f77b3720000
</I>&gt;<i> (gdb) p *metadata.p_-&gt;theObject
</I>&gt;<i> $18 = {theProcessCount = 0, theProcessIdOffset = 0}
</I>&gt;<i> (gdb) p metadata.p_-&gt;theObject-&gt;theProcessIdOffset
</I>&gt;<i> $19 = 0
</I>&gt;<i> 
</I>&gt;<i>  From this investigation, it appears that the theProcessCount and
</I>&gt;<i> theProcessIdOffset variables are set to 0. However, I don't think this
</I>&gt;<i> is actually the case, as these variables should be shared in SHM, and
</I>&gt;<i> the content of those files was not included in the core dump.
</I>&gt;<i> 
</I>&gt;<i> Have any of you experienced similar crashes? I was trying to search
</I>&gt;<i> for a similar issue but without success.
</I>&gt;<i> 
</I>&gt;<i> The backtrace above is from Squid version 5.5. While I understand it
</I>&gt;<i> is an older version, I believe the IPC code hasn&#8217;t changed much since
</I>&gt;<i> then. Unfortunately, we don't have a reproducer or the possibility of
</I>&gt;<i> upgrading Squid to a newer version on the running system for testing.
</I>&gt;<i> 
</I>&gt;<i> It's also worth noting that after restarting Squid, which was stuck in
</I>&gt;<i> the crash loop, Squid started normally. I suspect it could be caused
</I>&gt;<i> by uninitialized SHM or something similar. What do you think?
</I>&gt;<i> 
</I>&gt;<i> Would it help if I set some debug options and share the output with
</I>&gt;<i> you? I was considering something like:
</I>&gt;<i> 
</I>&gt;<i> debug_options ALL,1 1,9 54,9
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance for your response.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Lubos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027481.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="027489.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27483">[ date ]</a>
              <a href="thread.html#27483">[ thread ]</a>
              <a href="subject.html#27483">[ subject ]</a>
              <a href="author.html#27483">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
