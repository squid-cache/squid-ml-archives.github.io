<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C27c226fc-460b-4f5f-8d36-a451a1adfff3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027495.html">
   <LINK REL="Next"  HREF="027497.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C27c226fc-460b-4f5f-8d36-a451a1adfff3%40measurement-factory.com%3E"
       TITLE="[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Mar  7 14:48:34 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027495.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="027497.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27496">[ date ]</a>
              <a href="thread.html#27496">[ thread ]</a>
              <a href="subject.html#27496">[ subject ]</a>
              <a href="author.html#27496">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-03-07 06:50, Andrey K wrote:

&gt;<i> Squid Cache: Version 6.13
</I>&gt;<i> Service Name: squid
</I>
&gt;<i> Squid Cache: Version 6.10
</I>&gt;<i> Service Name: squid
</I>
&gt;<i> # the first instance
</I>&gt;<i> 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
</I>&gt;<i> 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
</I>&gt;<i> 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
</I>&gt;<i> 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm (deleted)
</I>&gt;<i> 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm (deleted)
</I>&gt;<i> 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm (deleted)
</I>&gt;<i> 
</I>&gt;<i> # the second instance
</I>&gt;<i> 1514 mem  ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
</I>&gt;<i> 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
</I>&gt;<i> 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
</I>&gt;<i> 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
</I>&gt;<i> 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
</I>&gt;<i> 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
</I>&gt;<i> 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
</I>&gt;<i> 1514   9u ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
</I>
As suspected, these two Squid instances use the same shared memory 
segments (e.g., /dev/shm/squid-cf*). Such shared use violates critical 
code assumptions and results in undefined behavior.


&gt;<i> Maybe I'm not experiencing any difficulties because I have caching turned off on 
</I>&gt;<i> both instances?
</I>
Well, you _are_ experiencing at least one difficulty -- the assertion 
that started this email thread. If you have fully disabled caching, the 
difficulties you experience should not include cache corruption. 
However, it looks like at least one of the two instances does cache TLS 
sessions (in /dev/shm/squid-tls_session_cache.shm). If both instances do 
that, then all bets are off!


FWIW, related future Squid improvements may include:

* Detecting such shared memory segments clashes; refusing to start.
* Disabling shared memory use when caching is completely disabled.

Quality pull requests welcome.


Cheers,

Alex.


&gt;<i> &#1095;&#1090;, 6 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:11, Alex Rousskov:
</I>&gt;<i> 
</I>&gt;<i>     On 2025-03-06 08:59, Amos Jeffries wrote:
</I>&gt;<i>      &gt; On 6/03/25 19:17, Andrey K wrote:
</I>&gt;<i>      &gt;&gt; Hello,
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; I have a similar&#160;configuration: two SMP squids running on the
</I>&gt;<i>     same OEL
</I>&gt;<i>      &gt;&gt; host.
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; They were built with different configurations: with different
</I>&gt;<i>      &gt;&gt; installation path prefixes and different&#160;names of binary files:
</I>&gt;<i>     squid
</I>&gt;<i>      &gt;&gt; and squid.user and they listen to different ports.
</I>&gt;<i>      &gt;&gt; They are launched&#160;from two different services:squid.service and
</I>&gt;<i>      &gt;&gt; squid.user.service with the service Type=forking:
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; &#160;&#160;&#160; ExecStart=/usr/sbin/squid -sYC
</I>&gt;<i>      &gt;&gt; &#160;&#160;&#160; ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; I have not experienced any troubles with this configuration yet.
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; /&gt; Please be aware that &quot;squid -n ...&quot; is a REQUIREMENT for running/
</I>&gt;<i>      &gt;&gt; /multiple Squid instances on the same machine regardless of what
</I>&gt;<i>     features
</I>&gt;<i>      &gt;&gt; are used./
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; Could you please&#160;tell me if I should use the -n option in the
</I>&gt;<i>      &gt;&gt; ExecStart strings?
</I>&gt;<i>      &gt;&gt; The arguments of the options should be the service names?
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt;&gt; &#160;&#160;&#160; ExecStart=/usr/sbin/squid -sYC -n squid.service
</I>&gt;<i>      &gt;&gt; &#160;&#160;&#160; ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
</I>&gt;<i>      &gt;&gt; &#160;&#160;&#160; squid.user.service
</I>&gt;<i>      &gt;&gt;
</I>&gt;<i>      &gt; Yes you should. The different ./configure options has helped you
</I>&gt;<i>     avoid
</I>&gt;<i>      &gt; major issues, but some may still appear.
</I>&gt;<i> 
</I>&gt;<i>     I agree. Moreover, I do not understand how your two SMP Squids could
</I>&gt;<i>     work correctly without distinct service names because (on OEL) I would
</I>&gt;<i>     expect them to share the same shared memory segments (which they must
</I>&gt;<i>     not do to remain distinct instances).
</I>&gt;<i> 
</I>&gt;<i>     What is your Squid version? Can you tell how your Squids name their
</I>&gt;<i>     shared memory segment &quot;files&quot;? For example, on some Linux OSes, those
</I>&gt;<i>     segments could be in /var/run/shm/ with names like
</I>&gt;<i>     squid-tr_map_anchors.shm&#160; and squid-tr_spaces.shm.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Thank you,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027495.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="027497.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27496">[ date ]</a>
              <a href="thread.html#27496">[ thread ]</a>
              <a href="subject.html#27496">[ subject ]</a>
              <a href="author.html#27496">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
