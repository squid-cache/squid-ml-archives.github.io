<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3CCADJd0Y1BVONnWazCbrEtsF%2BNhT0ML6cUtZdDQOiGSXGWKogQsw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027497.html">
   <LINK REL="Next"  HREF="027499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3CCADJd0Y1BVONnWazCbrEtsF%2BNhT0ML6cUtZdDQOiGSXGWKogQsw%40mail.gmail.com%3E"
       TITLE="[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;">ankor2023 at gmail.com
       </A><BR>
    <I>Tue Mar 11 03:56:20 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027497.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="027499.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27498">[ date ]</a>
              <a href="thread.html#27498">[ thread ]</a>
              <a href="subject.html#27498">[ subject ]</a>
              <a href="author.html#27498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i>  FWIW, related future Squid improvements may include:
</I>
&gt;<i>  * Detecting such shared memory segments clashes; refusing to start.
</I>&gt;<i>  * Disabling shared memory use when caching is completely disabled.
</I>
&gt;<i>  Quality pull requests welcome.
</I>
I looked at the source code and found the detection of the presence of old
shared memory segments (&quot;src/ipc/mem/Segment.cc&quot;):
void
Ipc::Mem::Segment::create(const off_t aSize)
{
    assert(aSize &gt; 0);
    assert(theFD &lt; 0);

    int xerrno = 0;

    // Why a brand new segment? A Squid crash may leave a reusable segment,
but
    // our placement-new code requires an all-0s segment. We could truncate
and
    // resize the old segment, but OS X does not allow using O_TRUNC with
    // shm_open() and does not support ftruncate() for old segments.
    if (!createFresh(xerrno) &amp;&amp; xerrno == EEXIST) {
        unlink();
        createFresh(xerrno);
    }

But, as the comment says, the segments may remain from the previous Squid
crash. Thus, in my opinion, it is impractical to refuse to launch the
program. I think it's enough to put a warning in the code when detecting
old segments.
Something like that:
void
Ipc::Mem::Segment::create(const off_t aSize)
{
    assert(aSize &gt; 0);
    assert(theFD &lt; 0);

    int xerrno = 0;

    // Why a brand new segment? A Squid crash may leave a reusable segment,
but
    // our placement-new code requires an all-0s segment. We could truncate
and
    // resize the old segment, but OS X does not allow using O_TRUNC with
    // shm_open() and does not support ftruncate() for old segments.
    if (!createFresh(xerrno) &amp;&amp; xerrno == EEXIST) {
        *debugs(54, DBG_CRITICAL, &quot;WARNING: there is an old shared memory
segment: '&quot; &lt;&lt; theName &lt;&lt; &quot;'. Perhaps it was left after the previous crash
of the Squid. We will remove it. Or it may be a sign that another instance
of the Squid is running.  In this case, you must launch the program with
the -n option and specify the unique name of the service.&quot;);*
        unlink();
        createFresh(xerrno);
    }
Kind regards,
Ankor.


&#1089;&#1073;, 8 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 08:14, Andrey K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A>&gt;:

&gt;<i> Hello Alex,
</I>&gt;<i>
</I>&gt;<i> Thanks for the analysis.
</I>&gt;<i> Squid only allows alphanumeric characters in the service name, so it
</I>&gt;<i> refuses to use the original service name in the -n option (-n
</I>&gt;<i> squid.user.service).
</I>&gt;<i> I added -n squiduser option to the ExecStart string of the second
</I>&gt;<i> instance.
</I>&gt;<i> Now it looks good:
</I>&gt;<i>
</I>&gt;<i> # the first instance
</I>&gt;<i> lsof -p 3746105 | grep shm
</I>&gt;<i> squid   3746105 root  mem    REG               0,23   525572 1213614834
</I>&gt;<i> /dev/shm/squid-cf__queues.shm
</I>&gt;<i> squid   3746105 root  mem    REG               0,23      136 1213614835
</I>&gt;<i> /dev/shm/squid-cf__readers.shm
</I>&gt;<i> squid   3746105 root  mem    REG               0,23        8 1213614833
</I>&gt;<i> /dev/shm/squid-cf__metadata.shm
</I>&gt;<i> squid   3746105 root    7u   REG               0,23        8 1213614833
</I>&gt;<i> /dev/shm/squid-cf__metadata.shm
</I>&gt;<i> squid   3746105 root    8u   REG               0,23   525572 1213614834
</I>&gt;<i> /dev/shm/squid-cf__queues.shm
</I>&gt;<i> squid   3746105 root    9u   REG               0,23      136 1213614835
</I>&gt;<i> /dev/shm/squid-cf__readers.shm
</I>&gt;<i>
</I>&gt;<i> # the second instance
</I>&gt;<i> lsof -p 3685356 | grep shm
</I>&gt;<i> squid.use 3685356 root  mem    REG               0,23   2093368 1212704041
</I>&gt;<i> /dev/shm/squiduser-tls_session_cache.shm
</I>&gt;<i> squid.use 3685356 root  mem    REG               0,23    525572 1212704039
</I>&gt;<i> /dev/shm/squiduser-cf__queues.shm
</I>&gt;<i> squid.use 3685356 root  mem    REG               0,23       136 1212704040
</I>&gt;<i> /dev/shm/squiduser-cf__readers.shm
</I>&gt;<i> squid.use 3685356 root  mem    REG               0,23         8 1212704038
</I>&gt;<i> /dev/shm/squiduser-cf__metadata.shm
</I>&gt;<i> squid.use 3685356 root    6u   REG               0,23         8 1212704038
</I>&gt;<i> /dev/shm/squiduser-cf__metadata.shm
</I>&gt;<i> squid.use 3685356 root    7u   REG               0,23    525572 1212704039
</I>&gt;<i> /dev/shm/squiduser-cf__queues.shm
</I>&gt;<i> squid.use 3685356 root    8u   REG               0,23       136 1212704040
</I>&gt;<i> /dev/shm/squiduser-cf__readers.shm
</I>&gt;<i> squid.use 3685356 root    9u   REG               0,23   2093368 1212704041
</I>&gt;<i> /dev/shm/squiduser-tls_session_cache.shm
</I>&gt;<i>
</I>&gt;<i> Kind regards,
</I>&gt;<i>      Ankor.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#1087;&#1090;, 7 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:48, Alex Rousskov &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> On 2025-03-07 06:50, Andrey K wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Squid Cache: Version 6.13
</I>&gt;&gt;<i> &gt; Service Name: squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Squid Cache: Version 6.10
</I>&gt;&gt;<i> &gt; Service Name: squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; # the first instance
</I>&gt;&gt;<i> &gt; 1318 DEL  ...          30205 /dev/shm/squid-cf__queues.shm
</I>&gt;&gt;<i> &gt; 1318 DEL  ...          30206 /dev/shm/squid-cf__readers.shm
</I>&gt;&gt;<i> &gt; 1318 DEL  ...          30204 /dev/shm/squid-cf__metadata.shm
</I>&gt;&gt;<i> &gt; 1318   8u ...      8   30204 /dev/shm/squid-cf__metadata.shm (deleted)
</I>&gt;&gt;<i> &gt; 1318   9u ... 525572   30205 /dev/shm/squid-cf__queues.shm (deleted)
</I>&gt;&gt;<i> &gt; 1318  10u ...    136   30206 /dev/shm/squid-cf__readers.shm (deleted)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; # the second instance
</I>&gt;&gt;<i> &gt; 1514 mem  ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
</I>&gt;&gt;<i> &gt; 1514 mem  ...  525572   31495 /dev/shm/squid-cf__queues.shm
</I>&gt;&gt;<i> &gt; 1514 mem  ...     136   31496 /dev/shm/squid-cf__readers.shm
</I>&gt;&gt;<i> &gt; 1514 mem  ...       8   31494 /dev/shm/squid-cf__metadata.shm
</I>&gt;&gt;<i> &gt; 1514   6u ...       8   31494 /dev/shm/squid-cf__metadata.shm
</I>&gt;&gt;<i> &gt; 1514   7u ...  525572   31495 /dev/shm/squid-cf__queues.shm
</I>&gt;&gt;<i> &gt; 1514   8u ...     136   31496 /dev/shm/squid-cf__readers.shm
</I>&gt;&gt;<i> &gt; 1514   9u ... 2093368   31497 /dev/shm/squid-tls_session_cache.shm
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As suspected, these two Squid instances use the same shared memory
</I>&gt;&gt;<i> segments (e.g., /dev/shm/squid-cf*). Such shared use violates critical
</I>&gt;&gt;<i> code assumptions and results in undefined behavior.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Maybe I'm not experiencing any difficulties because I have caching
</I>&gt;&gt;<i> turned off on
</I>&gt;&gt;<i> &gt; both instances?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, you _are_ experiencing at least one difficulty -- the assertion
</I>&gt;&gt;<i> that started this email thread. If you have fully disabled caching, the
</I>&gt;&gt;<i> difficulties you experience should not include cache corruption.
</I>&gt;&gt;<i> However, it looks like at least one of the two instances does cache TLS
</I>&gt;&gt;<i> sessions (in /dev/shm/squid-tls_session_cache.shm). If both instances do
</I>&gt;&gt;<i> that, then all bets are off!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FWIW, related future Squid improvements may include:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Detecting such shared memory segments clashes; refusing to start.
</I>&gt;&gt;<i> * Disabling shared memory use when caching is completely disabled.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Quality pull requests welcome.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; &#1095;&#1090;, 6 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:11, Alex Rousskov:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     On 2025-03-06 08:59, Amos Jeffries wrote:
</I>&gt;&gt;<i> &gt;      &gt; On 6/03/25 19:17, Andrey K wrote:
</I>&gt;&gt;<i> &gt;      &gt;&gt; Hello,
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt; I have a similar configuration: two SMP squids running on the
</I>&gt;&gt;<i> &gt;     same OEL
</I>&gt;&gt;<i> &gt;      &gt;&gt; host.
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt; They were built with different configurations: with different
</I>&gt;&gt;<i> &gt;      &gt;&gt; installation path prefixes and different names of binary files:
</I>&gt;&gt;<i> &gt;     squid
</I>&gt;&gt;<i> &gt;      &gt;&gt; and squid.user and they listen to different ports.
</I>&gt;&gt;<i> &gt;      &gt;&gt; They are launched from two different services:squid.service and
</I>&gt;&gt;<i> &gt;      &gt;&gt; squid.user.service with the service Type=forking:
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt;     ExecStart=/usr/sbin/squid -sYC
</I>&gt;&gt;<i> &gt;      &gt;&gt;     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt; I have not experienced any troubles with this configuration yet.
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt; /&gt; Please be aware that &quot;squid -n ...&quot; is a REQUIREMENT for
</I>&gt;&gt;<i> running/
</I>&gt;&gt;<i> &gt;      &gt;&gt; /multiple Squid instances on the same machine regardless of what
</I>&gt;&gt;<i> &gt;     features
</I>&gt;&gt;<i> &gt;      &gt;&gt; are used./
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt; Could you please tell me if I should use the -n option in the
</I>&gt;&gt;<i> &gt;      &gt;&gt; ExecStart strings?
</I>&gt;&gt;<i> &gt;      &gt;&gt; The arguments of the options should be the service names?
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt;&gt;     ExecStart=/usr/sbin/squid -sYC -n squid.service
</I>&gt;&gt;<i> &gt;      &gt;&gt;     ExecStart=/sbin/squid.user -f /etc/squid.user/squid.conf -n
</I>&gt;&gt;<i> &gt;      &gt;&gt;     squid.user.service
</I>&gt;&gt;<i> &gt;      &gt;&gt;
</I>&gt;&gt;<i> &gt;      &gt; Yes you should. The different ./configure options has helped you
</I>&gt;&gt;<i> &gt;     avoid
</I>&gt;&gt;<i> &gt;      &gt; major issues, but some may still appear.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     I agree. Moreover, I do not understand how your two SMP Squids could
</I>&gt;&gt;<i> &gt;     work correctly without distinct service names because (on OEL) I
</I>&gt;&gt;<i> would
</I>&gt;&gt;<i> &gt;     expect them to share the same shared memory segments (which they
</I>&gt;&gt;<i> must
</I>&gt;&gt;<i> &gt;     not do to remain distinct instances).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     What is your Squid version? Can you tell how your Squids name their
</I>&gt;&gt;<i> &gt;     shared memory segment &quot;files&quot;? For example, on some Linux OSes,
</I>&gt;&gt;<i> those
</I>&gt;&gt;<i> &gt;     segments could be in /var/run/shm/ with names like
</I>&gt;&gt;<i> &gt;     squid-tr_map_anchors.shm  and squid-tr_spaces.shm.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     Thank you,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     Alex.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;     _______________________________________________
</I>&gt;&gt;<i> &gt;     squid-users mailing list
</I>&gt;&gt;<i> &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> &gt;     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250311/ef6812c0/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250311/ef6812c0/attachment-0001.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027497.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="027499.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27498">[ date ]</a>
              <a href="thread.html#27498">[ thread ]</a>
              <a href="subject.html#27498">[ subject ]</a>
              <a href="author.html#27498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
