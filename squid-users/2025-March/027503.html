<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C703a848d-101e-477e-91f7-99b0d9e369cf%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027502.html">
   <LINK REL="Next"  HREF="027482.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20assertion%20failed%3A%20Queue.cc%3A388%3A%20%22EX%22&In-Reply-To=%3C703a848d-101e-477e-91f7-99b0d9e369cf%40measurement-factory.com%3E"
       TITLE="[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Mar 13 17:55:32 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027502.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="027482.html">[squid-users] web page not updated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27503">[ date ]</a>
              <a href="thread.html#27503">[ thread ]</a>
              <a href="subject.html#27503">[ subject ]</a>
              <a href="author.html#27503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-03-13 07:49, Andrey K wrote:

&gt;<i> I implemented&#160;the A-example functionality and made PR:
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/2023">https://github.com/squid-cache/squid/pull/2023</A> 
</I>
Thank you.


&gt;<i> ButthemodifiedSquid projectis notbeingbuilt ongithub,althoughthere are 
</I>&gt;<i> noproblemsduringthe localbuilds.
</I>&gt;<i> Alex, Amos and Francesco, could you see what the problem is?
</I>
Just to close this mailing list thread: PR #2023 problems are being 
handled on GitHub.

Alex.


&gt;<i> &#1074;&#1090;, 11 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:40, Andrey K:
</I>&gt;<i> 
</I>&gt;<i>     Hello Alex,
</I>&gt;<i> 
</I>&gt;<i>     Thank you for sharing your thoughts.
</I>&gt;<i>     The A-example looks easier to implement and more reliable.
</I>&gt;<i> 
</I>&gt;<i>     Kind&#160;regards,
</I>&gt;<i>      &#160; &#160; &#160; Ankor.
</I>&gt;<i> 
</I>&gt;<i>     &#1074;&#1090;, 11 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:12, Alex Rousskov
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;:
</I>&gt;<i> 
</I>&gt;<i>         On 2025-03-10 23:56, Andrey K wrote:
</I>&gt;<i> 
</I>&gt;<i>          &gt;&#160; &gt;&#160;Alex: FWIW, related future Squid improvements may include:
</I>&gt;<i>          &gt;&#160; &gt;&#160; * Detecting such shared memory segments clashes; refusing
</I>&gt;<i>         to start.
</I>&gt;<i>          &gt;&#160; &gt;&#160; * Disabling shared memory use when caching is completely
</I>&gt;<i>         disabled.
</I>&gt;<i> 
</I>&gt;<i>          &gt; But ... segments may remain from the previous
</I>&gt;<i>          &gt; Squid crash. Thus, in my opinion, it is impractical to refuse
</I>&gt;<i>         to launch
</I>&gt;<i>          &gt; the program.
</I>&gt;<i> 
</I>&gt;<i>         &quot;Squid should overwrite segments left by a crashed Squid&quot; does
</I>&gt;<i>         not imply
</I>&gt;<i>         that &quot;detecting segment clashes among independent Squid
</I>&gt;<i>         instances is
</I>&gt;<i>         impractical&quot;.
</I>&gt;<i> 
</I>&gt;<i>         The following rough examples are _not_ implementation
</I>&gt;<i>         blueprints, but
</I>&gt;<i>         they illustrate the lack of the above implication:
</I>&gt;<i> 
</I>&gt;<i>         A. If Squid were to incorporate PID filename[^1] into segment
</I>&gt;<i>         names,
</I>&gt;<i>         then segments from different Squid instances will not clash.
</I>&gt;<i> 
</I>&gt;<i>         B. If Squid were to write its PID filename[^1] into a shared memory
</I>&gt;<i>         segment, then Squid would be able to detect that another running
</I>&gt;<i>         instance is using the same shared memory segment (while still
</I>&gt;<i>         overwriting segments left by an earlier crash).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         [^1]: Full Squid PID filename are already guaranteed to be
</I>&gt;<i>         unique across
</I>&gt;<i>         Squid instances that may overwrite each other segments because
</I>&gt;<i>         Squid
</I>&gt;<i>         refuses to start if another Squid instance is using its PID
</I>&gt;<i>         file. The
</I>&gt;<i>         only red flag I can think of here is esoteric chrooted
</I>&gt;<i>         instances, but I
</I>&gt;<i>         would not be surprised if those instances cannot share segments.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>          &gt; I think it's enough to put a warning in the code when
</I>&gt;<i>         detecting old
</I>&gt;<i>          &gt; segments.
</I>&gt;<i> 
</I>&gt;<i>         I disagree that a level-0 warning during regular/uneventful
</I>&gt;<i>         startups is
</I>&gt;<i>         a good idea, especially if there will be one warning for every
</I>&gt;<i>         segment.
</I>&gt;<i>         We should try to address the actual problem (i.e. refuse to start a
</I>&gt;<i>         segment-clashing concurrent instance) rather than allowing
</I>&gt;<i>         clashes but
</I>&gt;<i>         adding a yet another warning about a usually benign event.
</I>&gt;<i> 
</I>&gt;<i>         Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>          &gt; Something like that:
</I>&gt;<i>          &gt; void
</I>&gt;<i>          &gt; Ipc::Mem::Segment::create(const off_t aSize)
</I>&gt;<i>          &gt; {
</I>&gt;<i>          &gt;&#160; &#160; &#160; assert(aSize &gt; 0);
</I>&gt;<i>          &gt;&#160; &#160; &#160; assert(theFD &lt; 0);
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; int xerrno = 0;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; // Why a brand new segment? A Squid crash may leave a
</I>&gt;<i>         reusable
</I>&gt;<i>          &gt; segment, but
</I>&gt;<i>          &gt;&#160; &#160; &#160; // our placement-new code requires an all-0s segment. We
</I>&gt;<i>         could
</I>&gt;<i>          &gt; truncate and
</I>&gt;<i>          &gt;&#160; &#160; &#160; // resize the old segment, but OS X does not allow using
</I>&gt;<i>         O_TRUNC with
</I>&gt;<i>          &gt;&#160; &#160; &#160; // shm_open() and does not support ftruncate() for old
</I>&gt;<i>         segments.
</I>&gt;<i>          &gt;&#160; &#160; &#160; if (!createFresh(xerrno) &amp;&amp; xerrno == EEXIST) {
</I>&gt;<i>          &gt; *debugs(54, DBG_CRITICAL, &quot;WARNING: there is an old shared
</I>&gt;<i>         memory
</I>&gt;<i>          &gt; segment: '&quot; &lt;&lt; theName &lt;&lt; &quot;'. Perhaps it was left after the
</I>&gt;<i>         previous
</I>&gt;<i>          &gt; crash of the Squid. We will remove it. Or it may be a sign
</I>&gt;<i>         that another
</I>&gt;<i>          &gt; instance of the Squid is running.&#160; In this case, you must
</I>&gt;<i>         launch the
</I>&gt;<i>          &gt; program with the -n option and specify the unique name of the
</I>&gt;<i>         service.&quot;);*
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; unlink();
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; createFresh(xerrno);
</I>&gt;<i>          &gt;&#160; &#160; &#160; }
</I>&gt;<i>          &gt; Kind regards,
</I>&gt;<i>          &gt; Ankor.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt; &#1089;&#1073;, 8 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 08:14, Andrey K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A>&gt;
</I>&gt;<i>          &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A>&gt;&gt;&gt;:
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;Hello Alex,
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;Thanks for the analysis.
</I>&gt;<i>          &gt;&#160; &#160; &#160;Squidonlyallowsalphanumericcharactersinthe servicename,
</I>&gt;<i>          &gt;&#160; &#160; &#160;soitrefusesto usethe originalservice namein the -n option (-n
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.user.service).
</I>&gt;<i>          &gt;&#160; &#160; &#160;I added-n squiduser&#160;option to the ExecStart string of the
</I>&gt;<i>         second
</I>&gt;<i>          &gt;&#160; &#160; &#160;instance.
</I>&gt;<i>          &gt;&#160; &#160; &#160;Now it looks good:
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;# the first instance
</I>&gt;<i>          &gt;&#160; &#160; &#160;lsof -p 3746105 | grep shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; 525572
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614834 /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; &#160; &#160;136
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614835 /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; &#160; &#160; &#160;8
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614833 /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160; &#160;7u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; &#160; &#160; &#160;8
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614833 /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160; &#160;8u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; 525572
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614834 /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid &#160; 3746105 root &#160; &#160;9u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23 &#160; &#160; &#160;136
</I>&gt;<i>          &gt;&#160; &#160; &#160;1213614835 /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;# the second instance
</I>&gt;<i>          &gt;&#160; &#160; &#160;lsof -p 3685356 | grep shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23  
</I>&gt;<i>         2093368
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704041 /dev/shm/squiduser-tls_session_cache.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23  
</I>&gt;<i>          &#160;525572
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704039 /dev/shm/squiduser-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23    
</I>&gt;<i>          &#160; 136
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704040 /dev/shm/squiduser-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160;mem &#160; &#160;REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23    
</I>&gt;<i>          &#160; &#160; 8
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704038 /dev/shm/squiduser-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160; &#160;6u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23    
</I>&gt;<i>          &#160; &#160; 8
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704038 /dev/shm/squiduser-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160; &#160;7u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23  
</I>&gt;<i>          &#160;525572
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704039 /dev/shm/squiduser-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160; &#160;8u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23    
</I>&gt;<i>          &#160; 136
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704040 /dev/shm/squiduser-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160;squid.use 3685356 root &#160; &#160;9u &#160; REG &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0,23  
</I>&gt;<i>         2093368
</I>&gt;<i>          &gt;&#160; &#160; &#160;1212704041 /dev/shm/squiduser-tls_session_cache.shm
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;Kind regards,
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &#160;Ankor.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;&#1087;&#1090;, 7 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:48, Alex Rousskov
</I>&gt;<i>          &gt;&#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt;:
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;On 2025-03-07 06:50, Andrey K wrote:
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; Squid Cache: Version 6.13
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; Service Name: squid
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; Squid Cache: Version 6.10
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; Service Name: squid
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; # the first instance
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318 DEL&#160; ...&#160; &#160; &#160; &#160; &#160; 30205
</I>&gt;<i>         /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318 DEL&#160; ...&#160; &#160; &#160; &#160; &#160; 30206
</I>&gt;<i>         /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318 DEL&#160; ...&#160; &#160; &#160; &#160; &#160; 30204
</I>&gt;<i>         /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318&#160; &#160;8u ...&#160; &#160; &#160; 8&#160; &#160;30204
</I>&gt;<i>         /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;(deleted)
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318&#160; &#160;9u ... 525572&#160; &#160;30205
</I>&gt;<i>         /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;(deleted)
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1318&#160; 10u ...&#160; &#160; 136&#160; &#160;30206
</I>&gt;<i>         /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;(deleted)
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; # the second instance
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514 mem&#160; ... 2093368&#160; &#160;31497
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;/dev/shm/squid-tls_session_cache.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514 mem&#160; ...&#160; 525572&#160; &#160;31495
</I>&gt;<i>         /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514 mem&#160; ...&#160; &#160; &#160;136&#160; &#160;31496
</I>&gt;<i>         /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514 mem&#160; ...&#160; &#160; &#160; &#160;8&#160; &#160;31494
</I>&gt;<i>         /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514&#160; &#160;6u ...&#160; &#160; &#160; &#160;8&#160; &#160;31494
</I>&gt;<i>         /dev/shm/squid-cf__metadata.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514&#160; &#160;7u ...&#160; 525572&#160; &#160;31495
</I>&gt;<i>         /dev/shm/squid-cf__queues.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514&#160; &#160;8u ...&#160; &#160; &#160;136&#160; &#160;31496
</I>&gt;<i>         /dev/shm/squid-cf__readers.shm
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; 1514&#160; &#160;9u ... 2093368&#160; &#160;31497
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;/dev/shm/squid-tls_session_cache.shm
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;As suspected, these two Squid instances use the same
</I>&gt;<i>         shared memory
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;segments (e.g., /dev/shm/squid-cf*). Such shared use
</I>&gt;<i>         violates
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;critical
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;code assumptions and results in undefined behavior.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; Maybe I'm not experiencing any difficulties
</I>&gt;<i>         because I have
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;caching turned off on
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; both instances?
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;Well, you _are_ experiencing at least one difficulty
</I>&gt;<i>         -- the
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;assertion
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;that started this email thread. If you have fully
</I>&gt;<i>         disabled
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;caching, the
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;difficulties you experience should not include cache
</I>&gt;<i>         corruption.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;However, it looks like at least one of the two
</I>&gt;<i>         instances does
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;cache TLS
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;sessions (in /dev/shm/squid-tls_session_cache.shm).
</I>&gt;<i>         If both
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;instances do
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;that, then all bets are off!
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;FWIW, related future Squid improvements may include:
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;* Detecting such shared memory segments clashes;
</I>&gt;<i>         refusing to start.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;* Disabling shared memory use when caching is
</I>&gt;<i>         completely disabled.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;Quality pull requests welcome.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;Cheers,
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;Alex.
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; &#1095;&#1090;, 6 &#1084;&#1072;&#1088;. 2025&#8239;&#1075;. &#1074; 17:11, Alex Rousskov:
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;On 2025-03-06 08:59, Amos Jeffries wrote:
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; On 6/03/25 19:17, Andrey K wrote:
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; Hello,
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; I have a similar&#160;configuration: two SMP squids
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;running on the
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;same OEL
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; host.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; They were built with different
</I>&gt;<i>         configurations: with
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;different
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; installation path prefixes and
</I>&gt;<i>         different&#160;names of
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;binary files:
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;squid
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; and squid.user and they listen to
</I>&gt;<i>         different ports.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; They are launched&#160;from two different
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;services:squid.service and
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; squid.user.service with the service
</I>&gt;<i>         Type=forking:
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; &#160;&#160;&#160; ExecStart=/usr/sbin/squid -sYC
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; &#160;&#160;&#160; ExecStart=/sbin/squid.user -f
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;/etc/squid.user/squid.conf
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; I have not experienced any troubles with this
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;configuration yet.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; /&gt; Please be aware that &quot;squid -n ...&quot; is a
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;REQUIREMENT for running/
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; /multiple Squid instances on the same machine
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;regardless of what
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;features
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; are used./
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; Could you please&#160;tell me if I should use
</I>&gt;<i>         the -n
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;option in the
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; ExecStart strings?
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; The arguments of the options should be the
</I>&gt;<i>         service names?
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; &#160;&#160;&#160; ExecStart=/usr/sbin/squid -sYC -n
</I>&gt;<i>         squid.service
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; &#160;&#160;&#160; ExecStart=/sbin/squid.user -f
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;/etc/squid.user/squid.conf -n
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt; &#160;&#160;&#160; squid.user.service
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; Yes you should. The different ./configure
</I>&gt;<i>         options has
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;helped you
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;avoid
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; major issues, but some may still appear.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;I agree. Moreover, I do not understand how
</I>&gt;<i>         your two SMP
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;Squids could
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;work correctly without distinct service names
</I>&gt;<i>         because (on
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;OEL) I would
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;expect them to share the same shared memory
</I>&gt;<i>         segments
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;(which they must
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;not do to remain distinct instances).
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;What is your Squid version? Can you tell how
</I>&gt;<i>         your Squids
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;name their
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;shared memory segment &quot;files&quot;? For example, on
</I>&gt;<i>         some Linux
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;OSes, those
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;segments could be in /var/run/shm/ with names like
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;squid-tr_map_anchors.shm&#160; and squid-tr_spaces.shm.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;Thank you,
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;_______________________________________________
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;squid-users mailing list
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;   
</I>&gt;<i>          &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;&gt;
</I>&gt;<i>          &gt;&#160; &#160; &#160; &#160; &#160; &gt;
</I>&gt;<i>          &gt;
</I>&gt;<i> 
</I>&gt;<i>         _______________________________________________
</I>&gt;<i>         squid-users mailing list
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>         &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027502.html">[squid-users] assertion failed: Queue.cc:388: &quot;EX&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="027482.html">[squid-users] web page not updated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27503">[ date ]</a>
              <a href="thread.html#27503">[ thread ]</a>
              <a href="subject.html#27503">[ subject ]</a>
              <a href="author.html#27503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
