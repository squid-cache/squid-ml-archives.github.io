<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Interaction SSL_bump, Domain Allowlist and Host Header Forgery Check
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Interaction%20SSL_bump%2C%0A%20Domain%20Allowlist%20and%20Host%20Header%20Forgery%20Check&In-Reply-To=%3CCAJyMU%2BLp5mYgCwME1gjPJRcQuKJ_ZHodWek6XfTQ5B%3Dy80rpBw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="027557.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Interaction SSL_bump, Domain Allowlist and Host Header Forgery Check</H1>
    <B>Adrian</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Interaction%20SSL_bump%2C%0A%20Domain%20Allowlist%20and%20Host%20Header%20Forgery%20Check&In-Reply-To=%3CCAJyMU%2BLp5mYgCwME1gjPJRcQuKJ_ZHodWek6XfTQ5B%3Dy80rpBw%40mail.gmail.com%3E"
       TITLE="[squid-users] Interaction SSL_bump, Domain Allowlist and Host Header Forgery Check">adrian.stnbch at gmail.com
       </A><BR>
    <I>Wed May  7 23:17:17 UTC 2025</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="027557.html">[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27556">[ date ]</a>
              <a href="thread.html#27556">[ thread ]</a>
              <a href="subject.html#27556">[ subject ]</a>
              <a href="author.html#27556">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Squid community,

I would greatly appreciate a hint on how to configure Squid to achieve the
following:

Context
========
Transparent HTTP/S proxy (ideally no TLS re-encryption)
Domain allowlist acl
Squid v6.13

Goal
========
Have Squid &quot;inspect&quot; HTTPS requests (as much as possible/needed with the
actions provided by ssl_bump) and perform the host header forgery check in
addition to checking if the host extracted from SNI matches the domain
allowlist acl.
The configuration should basically prevent this: ]$ curl --insecure
--resolve &lt;domain on allowlist&gt;:443:&lt;arbitrary IP not associated with
domain&gt; <A HREF="https://&lt;domain">https://&lt;domain</A> on allowlist&gt;

It seems like all the necessary tools are provided, and I see hints
pointing to this possibility, e.g.
<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A> (the INFO box)
but I'm having trouble using them to accomplish the desired effect.
The host_verify_strict option seems to solve this for unencrypted HTTP and
I got the domain allowlist to work for HTTP + HTTPS - it's just easily
circumvented by the curl above in the case of HTTPS.

A rough idea about the order/placement of the acls involved (relative to
the ssl_bump steps where applicable) would help a lot.

Cheers,
Adrian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250508/226833a8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250508/226833a8/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="027557.html">[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27556">[ date ]</a>
              <a href="thread.html#27556">[ thread ]</a>
              <a href="subject.html#27556">[ subject ]</a>
              <a href="author.html#27556">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
