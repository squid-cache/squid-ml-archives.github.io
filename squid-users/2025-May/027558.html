<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL_Bump%3A%20Unexpected%20decryption%20of%0A%20non-whitelisted%20domains&In-Reply-To=%3C1d873494-d6d4-4a15-9829-27f34298c247%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027557.html">
   <LINK REL="Next"  HREF="027559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL_Bump%3A%20Unexpected%20decryption%20of%0A%20non-whitelisted%20domains&In-Reply-To=%3C1d873494-d6d4-4a15-9829-27f34298c247%40measurement-factory.com%3E"
       TITLE="[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue May 27 13:49:41 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027557.html">[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains
</A></li>
        <LI>Next message (by thread): <A HREF="027559.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27558">[ date ]</a>
              <a href="thread.html#27558">[ thread ]</a>
              <a href="subject.html#27558">[ subject ]</a>
              <a href="author.html#27558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-05-27 08:47, &#20013;&#23665;&#31232;&#26007; wrote:
&gt;<i> Dear Squid-Users,
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m configuring SSL_Bump to decrypt only a specific list of domains and 
</I>&gt;<i> to splice (pass through encrypted) all others, but I&#8217;m seeing 
</I>&gt;<i> non-whitelisted domains still being decrypted.
</I>&gt;<i> 
</I>&gt;<i> ### Observed behavior (access log excerpt):
</I>&gt;<i> 26.56.128.144 - - [27/May/2025:18:35:17 +0900] &quot;CONNECT mariadb.org:443 
</I>&gt;<i> HTTP/1.1&quot; 200 0 TCP_DENIED:HIER_NONE
</I>&gt;<i> 26.56.128.144 - - [27/May/2025:18:35:17 +0900] &quot;GET 
</I>&gt;<i> <A HREF="https://mariadb.org/donate/">https://mariadb.org/donate/</A> &lt;<A HREF="https://mariadb.org/donate/">https://mariadb.org/donate/</A>&gt;&#160;HTTP/1.1&quot; 403 
</I>&gt;<i> 4076 NONE_NONE:HIER_NONE
</I>&gt;<i> 
</I>&gt;<i> lthough CONNECT is supposed to be denied at step1,
</I>
When Squid is configured to deny a CONNECT request at step1, it bumps 
the client-to-Squid connection after receiving such a banned CONNECT 
request, waits for the client GET (or equivalent) request on the bumped 
connection, and then responds with an Access Denied error to the client. 
This behavior was implemented because most browsers refuse to show 
CONNECT errors to users; they only show GET errors.

If you do not like this behavior, you may, for example, configure your 
Squid to allow CONNECTs to servers that should be spliced.


HTH,

Alex.


&gt;<i> Squid first responds 
</I>&gt;<i> with &#8220;200 OK&#8221; (and presents a self-signed certificate), then the client 
</I>&gt;<i> issues a GET which finally returns 403.
</I>&gt;<i> 
</I>&gt;<i> ### My ssl_bump configuration:
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl bump_domains ssl::server_name &quot;/home/user001/ssl_bump/ssl_bump_domain&quot;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice step2 !bump_domains
</I>&gt;<i> ssl_bump bump step2 bump_domains
</I>&gt;<i> ssl_bump splice step3 all
</I>&gt;<i> 
</I>&gt;<i> Could you please advise why non-whitelisted domains are still being 
</I>&gt;<i> bumped and how to properly prevent this behavior?
</I>&gt;<i> 
</I>&gt;<i> Thank you for your assistance.
</I>&gt;<i> 
</I>&gt;<i> Best regards,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027557.html">[squid-users] SSL_Bump: Unexpected decryption of non-whitelisted domains
</A></li>
	<LI>Next message (by thread): <A HREF="027559.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27558">[ date ]</a>
              <a href="thread.html#27558">[ thread ]</a>
              <a href="subject.html#27558">[ subject ]</a>
              <a href="author.html#27558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
