<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to do transparent rewrite with https requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3Cb9bf085d-86fa-4abc-b5e8-e85663996bbf%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027560.html">
   <LINK REL="Next"  HREF="027562.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to do transparent rewrite with https requests?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3Cb9bf085d-86fa-4abc-b5e8-e85663996bbf%40treenet.co.nz%3E"
       TITLE="[squid-users] How to do transparent rewrite with https requests?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue May 27 20:12:51 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027560.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
        <LI>Next message (by thread): <A HREF="027562.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27561">[ date ]</a>
              <a href="thread.html#27561">[ thread ]</a>
              <a href="subject.html#27561">[ subject ]</a>
              <a href="author.html#27561">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/05/25 04:19, Alex Rousskov wrote:
&gt;<i> On 2025-05-27 10:37, Yves MARTIN wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> My team expects to transparently rewrite requests through squid, 
</I>&gt;&gt;<i> replacing original URL/hostname by another target URL/host.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Main objective is to redirect original HTTPS requests triggered by 
</I>&gt;&gt;<i> &#8220;docker pull alpine&#8221; to a local mirrored registry without obvious 
</I>&gt;&gt;<i> information in user client that the obtained image comes from mirror: 
</I>&gt;&gt;<i> original image location is preserved, no specific proxy or mirror 
</I>&gt;&gt;<i> configuration in docker client/daemon to set.
</I>
Okay. If I am correctly understanding that your primary goal is to have 
the &quot;original ... location is preserved&quot;. Then please discard the terms 
&quot;transparent&quot; and &quot;redirect&quot; from your thoughts on this matter. They 
both introduce requirements that break what you are wanting.


To operate a mirror that can be used in place of an origin server. That 
mirror needs to be configured to both receive and understand the URLs 
produced by that origin server.

After which Squid simply uses the mirror as cache_peer to handle the 
traffic for the domain(s) that origin server provides. Like so:

   # define what can go to the mirror
   acl foo dstdomain foo.example.com
   # how to contact the mirror
   cache_peer mirror.server 80 0 originserver
   cache_peer_access allow foo
   cache_peer_access deny all

If the mirror only knows its local mirror domain instead of the origin 
servers public domain. Then use the cache_peer option 
&quot;forceddomain=mirror-foo.example.com&quot;.


( Whether you URL-rewrite the path and query details before sending it 
to the mirror cache_peer is up to you. Just be aware that it is quite 
dangerous to do on a domain where you do not fully understand the 
meaning of those URL parts. YHBW. I advise not doing so.)


For the HTTPS, the complications are that:

1) you add another cache_peer with port 443. Same ACL setup.

2) Squid must receive the TLS traffic via:

  a) &quot;https_port 443 accel ...&quot;
     with local network routing client requests for the foo.example.com 
domain/IPs to this Squid listening port.


   OR/AND,

  b) SSL-Bump intercept of client CONNECT requests. Like so:

   # using 'foo' dstdomain ACL(s) from cache_peer_access rule(s)
   http_access allow CONNECT foo

   # same domains listed in 'foo' ACL(s)
   # but checking TLS ServerName instead of URL domain.
   acl fooS ssl::server_name ...

   # or peek, YMMV. I just think stare is better for this use-case.
   ssl_bump stare atStep1

   # decrypt so we can decide whether URLs go to mirror or origin
   ssl_bump bump atStep2 fooS

   # pass anything else to origin untouched
   ssl_bump splice atStep2 !fooS


HTH
Amos

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027560.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
	<LI>Next message (by thread): <A HREF="027562.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27561">[ date ]</a>
              <a href="thread.html#27561">[ thread ]</a>
              <a href="subject.html#27561">[ subject ]</a>
              <a href="author.html#27561">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
