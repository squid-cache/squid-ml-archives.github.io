<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to do transparent rewrite with https requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C68995794-3057-464C-A6F4-6A6F4CAD67F9%40icloud.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027561.html">
   <LINK REL="Next"  HREF="027563.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to do transparent rewrite with https requests?</H1>
    <B>&#20013;&#23665;&#31232;&#26007;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C68995794-3057-464C-A6F4-6A6F4CAD67F9%40icloud.com%3E"
       TITLE="[squid-users] How to do transparent rewrite with https requests?">nakayamakito at icloud.com
       </A><BR>
    <I>Wed May 28 00:07:07 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027561.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
        <LI>Next message (by thread): <A HREF="027563.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27562">[ date ]</a>
              <a href="thread.html#27562">[ thread ]</a>
              <a href="subject.html#27562">[ subject ]</a>
              <a href="author.html#27562">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for your response.

Based on your reply, we have reviewed the configuration and observed the following behavior.

&#9632; Relevant Configuration Snippet

acl bump_targets ssl::server_name &quot;/home/user001/ssl_bump/ssl_bump_domain&quot;
ssl_bump stare step1
ssl_bump bump step2 bump_targets
ssl_bump splice step2 !bump_targets
The /home/user001/ssl_bump/ssl_bump_domain file includes only:

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at host</A> squid]# cat /home/user001/ssl_bump/ssl_bump_domain
github.com
&#9632; Observed Logs

26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;CONNECT mariadb.org:443 HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/8.5.0&quot; TCP_DENIED:HIER_NONE
26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;GET <A HREF="https://mariadb.org/donate/">https://mariadb.org/donate/</A> HTTP/1.1&quot; 403 4076 &quot;-&quot; &quot;curl/8.5.0&quot; NONE_NONE:HIER_NONE
As mariadb.org is not listed in the ssl_bump_domain file, we expected it to be spliced. However, the log indicates that Squid is able to see the full HTTPS URL, implying the connection was actually bumped.

&#9632; Main Clarification Point

The key point we would like to confirm is:

In a configuration where ssl_bump is enabled, does Squid still allow the initial CONNECT request (returning 200) even for non-whitelisted domains, then wait for the client to send a follow-up HTTPS request (e.g., GET), which is then bumped and blocked (e.g., 403) by Squid?

Or alternatively:

Is Squid intentionally connecting to the origin server after CONNECT in order to generate an error page (403 etc.) that can be properly displayed to the client browser?

We would greatly appreciate clarification on the expected behavior and underlying mechanism in such cases.



&gt;<i> 2025/05/28 1:19&#12289;Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&#12398;&#12513;&#12540;&#12523;:
</I>&gt;<i> 
</I>&gt;<i> On 2025-05-27 10:37, Yves MARTIN wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> My team expects to transparently rewrite requests through squid, replacing original URL/hostname by another target URL/host.
</I>&gt;&gt;<i> Main objective is to redirect original HTTPS requests triggered by &#8220;docker pull alpine&#8221; to a local mirrored registry without obvious information in user client that the obtained image comes from mirror: original image location is preserved, no specific proxy or mirror configuration in docker client/daemon to set.
</I>&gt;&gt;<i> To do so, we have used squid-urlrewrite and it works well for HTTP request, even if rewrite targets HTTPS URL.
</I>&gt;&gt;<i> But when original request is HTTPS, connection still goes to original URL/hostname IP address <A HREF="https://github.com/rchunping/squid-urlrewrite/issues/3">https://github.com/rchunping/squid-urlrewrite/issues/3</A> According to debug logs, the original request hostname is resolved to IP early and kept in internal context after squid-urlrewrite is invoked.
</I>&gt;<i> 
</I>&gt;<i> In most cases, when bumping connections from a TLS client to Squid and from Squid to TLS server, Squid &quot;pins&quot; (i.e. remembers) the Squid-to-server connection and then (re)uses that pinned connection for all requests received on the client-to-Squid connection.
</I>&gt;<i> 
</I>&gt;<i> I have not checked, but speculate that rewriting request target does not trigger opening a new Squid-to-server TLS connection and re-pinning.
</I>&gt;<i> 
</I>&gt;<i> IIRC, a Squid that is configured to bump during SslBump step1 does not pin. Such a configuration is rarely usable on a modern internet, but YMMV.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250528/8c40de60/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250528/8c40de60/attachment.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027561.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
	<LI>Next message (by thread): <A HREF="027563.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27562">[ date ]</a>
              <a href="thread.html#27562">[ thread ]</a>
              <a href="subject.html#27562">[ subject ]</a>
              <a href="author.html#27562">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
