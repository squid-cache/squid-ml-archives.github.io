<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to do transparent rewrite with https requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C9d21bec3-486c-4cc6-8da9-318b09453c0b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027562.html">
   <LINK REL="Next"  HREF="027564.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to do transparent rewrite with https requests?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C9d21bec3-486c-4cc6-8da9-318b09453c0b%40measurement-factory.com%3E"
       TITLE="[squid-users] How to do transparent rewrite with https requests?">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 28 13:23:05 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027562.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
        <LI>Next message (by thread): <A HREF="027564.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27563">[ date ]</a>
              <a href="thread.html#27563">[ thread ]</a>
              <a href="subject.html#27563">[ subject ]</a>
              <a href="author.html#27563">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-05-27 20:07, &#20013;&#23665;&#31232;&#26007; wrote:
&gt;<i> 
</I>&gt;<i> acl bump_targets ssl::server_name &quot;/home/user001/ssl_bump/ssl_bump_domain&quot;
</I>&gt;<i> ssl_bump stare step1
</I>&gt;<i> ssl_bump bump step2 bump_targets
</I>&gt;<i> ssl_bump splice step2 !bump_targets
</I>&gt;<i> 
</I>&gt;<i> The /home/user001/ssl_bump/ssl_bump_domain file includes only:
</I>&gt;<i> 
</I>&gt;<i> github.com
</I>

&gt;<i> 26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;CONNECT mariadb.org:443 HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/8.5.0&quot; TCP_DENIED:HIER_NONE
</I>&gt;<i> 26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;GET <A HREF="https://mariadb.org/donate/">https://mariadb.org/donate/</A> HTTP/1.1&quot; 403 4076 &quot;-&quot; &quot;curl/8.5.0&quot; NONE_NONE:HIER_NONE
</I>

&gt;<i> As |mariadb.org|&#160;is *not listed in the |ssl_bump_domain|&#160;file*, we 
</I>&gt;<i> expected it to be spliced. However, the log indicates that Squid is able 
</I>&gt;<i> to see the full HTTPS URL, implying the connection was actually bumped.
</I>

When http_access rule denies a CONNECT request during SslBump step1, 
Squid bumps the client-to-Squid connection after receiving such a banned 
CONNECT request, waits for the client GET (or equivalent) request on the 
bumped connection, and then responds with an Access Denied error to the 
client. This behavior was implemented because most browsers refuse to 
show CONNECT errors to users; they only show GET errors.

If you do not like this behavior, you may, for example, configure your 
Squid to allow certain CONNECTs [during SslBump step1].

See http_access directive for the primary way to allow or deny requests.

See the following web page for interactions between http_access checks 
and ssl_bump activities:
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>



&gt;<i> The key point we would like to confirm is:
</I>&gt;<i> 
</I>&gt;<i>     *In a configuration where |ssl_bump|&#160;is enabled, does Squid still
</I>&gt;<i>     allow the initial CONNECT request (returning 200) even for
</I>&gt;<i>     non-whitelisted domains, then wait for the client to send a
</I>&gt;<i>     follow-up HTTPS request (e.g., GET), which is then bumped and
</I>&gt;<i>     blocked (e.g., 403) by Squid?*
</I>
The above summary is somewhat close to what is actually happening, but I 
recommend using the summary in my first paragraph above instead. Please 
keep in mind that it is the entire TLS connection that is being bumped 
(or spliced) rather than selected individual requests inside that 
connection. HTTP CONNECT request/response exchange (if any) happens 
before TLS.


&gt;<i> Or alternatively:
</I>&gt;<i> 
</I>&gt;<i>     *Is Squid intentionally connecting to the origin server after
</I>&gt;<i>     CONNECT in order to generate an error page (403 etc.) that can be
</I>&gt;<i>     properly displayed to the client browser?*
</I>
Squid does not connect to the origin server in order to generate an 
error page. Roughly speaking[^1], Squid generates an error page based on 
the information already available at the time of error page generation. 
Depending on the ssl_bump step that encountered an error, that error 
page generation may come before or after Squid connects to the origin 
server. See the web page above for details.

[1]: Some error response details are collected later, from the 
subsequent GET request (if any). However, the primary error generation 
activity happens at error discovery time, before that GET. In a sense, 
Squid has a response before it has a request, which creates various 
problems/complications!..


HTH,

Alex.


&gt;&gt;<i> 2025/05/28 1:19&#12289;Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&#12398;&#12513;&#12540;&#12523;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2025-05-27 10:37, Yves MARTIN wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My team expects to transparently rewrite requests through squid, 
</I>&gt;&gt;&gt;<i> replacing original URL/hostname by another target URL/host.
</I>&gt;&gt;&gt;<i> Main objective is to redirect original HTTPS requests triggered by 
</I>&gt;&gt;&gt;<i> &#8220;docker pull alpine&#8221; to a local mirrored registry without obvious 
</I>&gt;&gt;&gt;<i> information in user client that the obtained image comes from mirror: 
</I>&gt;&gt;&gt;<i> original image location is preserved, no specific proxy or mirror 
</I>&gt;&gt;&gt;<i> configuration in docker client/daemon to set.
</I>&gt;&gt;&gt;<i> To do so, we have used squid-urlrewrite and it works well for HTTP 
</I>&gt;&gt;&gt;<i> request, even if rewrite targets HTTPS URL.
</I>&gt;&gt;&gt;<i> But when original request is HTTPS, connection still goes to original 
</I>&gt;&gt;&gt;<i> URL/hostname IP address 
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/rchunping/squid-urlrewrite/issues/3">https://github.com/rchunping/squid-urlrewrite/issues/3</A> According to 
</I>&gt;&gt;&gt;<i> debug logs, the original request hostname is resolved to IP early and 
</I>&gt;&gt;&gt;<i> kept in internal context after squid-urlrewrite is invoked.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In most cases, when bumping connections from a TLS client to Squid and 
</I>&gt;&gt;<i> from Squid to TLS server, Squid &quot;pins&quot; (i.e. remembers) the 
</I>&gt;&gt;<i> Squid-to-server connection and then (re)uses that pinned connection 
</I>&gt;&gt;<i> for all requests received on the client-to-Squid connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have not checked, but speculate that rewriting request target does 
</I>&gt;&gt;<i> not trigger opening a new Squid-to-server TLS connection and re-pinning.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IIRC, a Squid that is configured to bump during SslBump step1 does not 
</I>&gt;&gt;<i> pin. Such a configuration is rarely usable on a modern internet, but YMMV.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027562.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
	<LI>Next message (by thread): <A HREF="027564.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27563">[ date ]</a>
              <a href="thread.html#27563">[ thread ]</a>
              <a href="subject.html#27563">[ subject ]</a>
              <a href="author.html#27563">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
