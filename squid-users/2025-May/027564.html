<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to do transparent rewrite with https requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C7968BECE-7789-41B6-97D8-F463F9DC3227%40icloud.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027563.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to do transparent rewrite with https requests?</H1>
    <B>&#20013;&#23665;&#31232;&#26007;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20do%20transparent%20rewrite%20with%20https%20requests%3F&In-Reply-To=%3C7968BECE-7789-41B6-97D8-F463F9DC3227%40icloud.com%3E"
       TITLE="[squid-users] How to do transparent rewrite with https requests?">nakayamakito at icloud.com
       </A><BR>
    <I>Thu May 29 00:38:20 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027563.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27564">[ date ]</a>
              <a href="thread.html#27564">[ thread ]</a>
              <a href="subject.html#27564">[ subject ]</a>
              <a href="author.html#27564">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Thank you for your response.

So it is by design that when SSL_Bump is enabled, Squid does not return a &#8220;403&#8221; error for the CONNECT request, but instead returns &#8220;403&#8221; after the subsequent GET request.

Also, thank you for suggesting a possible workaround.



You can consider this inquiry closed.

Thanks again!



iPhone&#12363;&#12425;&#36865;&#20449;

&gt;<i> 2025/05/28 22:37&#12289;Cloutier, Matt &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Matt.Cloutier at hexcel.com</A>&gt;&#12398;&#12513;&#12540;&#12523;:
</I>&gt;<i> 
</I>&gt;<i> &#65279;Hello,
</I>&gt;<i> 
</I>&gt;<i> The person working on this project is no longer employed at this company.  Thank you for the help on this, but we are going to go in another direction.
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> Matt Cloutier
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This message contains information from Hexcel which may be proprietary or privileged. If you are not the intended recipient, be aware that any disclosure, copying, distribution or use of the contents of this information is prohibited. If you have received this transmission in error, please notify me immediately by telephone or email.
</I>&gt;<i> 
</I>&gt;<i> Protecting your personal data matters to us. For more information about how we may use your personal data, read our Privacy Policy.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Wednesday, May 28, 2025 9:23 AM
</I>&gt;<i> To: &#20013;&#23665;&#31232;&#26007; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nakayamakito at icloud.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] How to do transparent rewrite with https requests?
</I>&gt;<i> 
</I>&gt;<i> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> On 2025-05-27 20:07, &#20013;&#23665;&#31232;&#26007; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl bump_targets ssl::server_name &quot;/home/user001/ssl_bump/ssl_bump_domain&quot;
</I>&gt;&gt;<i> ssl_bump stare step1
</I>&gt;&gt;<i> ssl_bump bump step2 bump_targets
</I>&gt;&gt;<i> ssl_bump splice step2 !bump_targets
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The /home/user001/ssl_bump/ssl_bump_domain file includes only:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> github.com
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;CONNECT
</I>&gt;&gt;<i> mariadb.org:443 HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/8.5.0&quot; TCP_DENIED:HIER_NONE
</I>&gt;&gt;<i> 26.56.128.144 - - [28/May/2025:10:25:18 +0900] &quot;GET
</I>&gt;&gt;<i> <A HREF="https://mari/">https://mari/</A>
</I>&gt;&gt;<i> adb.org%2Fdonate%2F&amp;data=05%7C02%7Cjosh.piana%40hexcel.com%7C204fa12a9
</I>&gt;&gt;<i> f9e4474188208dd9dec17a2%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6
</I>&gt;&gt;<i> 38840359549441010%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYi
</I>&gt;&gt;<i> OiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7
</I>&gt;&gt;<i> C%7C%7C&amp;sdata=Q82TrO03Ee4Z5rmCBSMDYLRgD4LyRL%2BLbu5y5yHqFcs%3D&amp;reserve
</I>&gt;&gt;<i> d=0 HTTP/1.1&quot; 403 4076 &quot;-&quot; &quot;curl/8.5.0&quot; NONE_NONE:HIER_NONE
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> As |mariadb.org| is *not listed in the |ssl_bump_domain| file*, we
</I>&gt;&gt;<i> expected it to be spliced. However, the log indicates that Squid is
</I>&gt;&gt;<i> able to see the full HTTPS URL, implying the connection was actually bumped.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When http_access rule denies a CONNECT request during SslBump step1, Squid bumps the client-to-Squid connection after receiving such a banned CONNECT request, waits for the client GET (or equivalent) request on the bumped connection, and then responds with an Access Denied error to the client. This behavior was implemented because most browsers refuse to show CONNECT errors to users; they only show GET errors.
</I>&gt;<i> 
</I>&gt;<i> If you do not like this behavior, you may, for example, configure your Squid to allow certain CONNECTs [during SslBump step1].
</I>&gt;<i> 
</I>&gt;<i> See http_access directive for the primary way to allow or deny requests.
</I>&gt;<i> 
</I>&gt;<i> See the following web page for interactions between http_access checks and ssl_bump activities:
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> The key point we would like to confirm is:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>    *In a configuration where |ssl_bump| is enabled, does Squid still
</I>&gt;&gt;<i>    allow the initial CONNECT request (returning 200) even for
</I>&gt;&gt;<i>    non-whitelisted domains, then wait for the client to send a
</I>&gt;&gt;<i>    follow-up HTTPS request (e.g., GET), which is then bumped and
</I>&gt;&gt;<i>    blocked (e.g., 403) by Squid?*
</I>&gt;<i> 
</I>&gt;<i> The above summary is somewhat close to what is actually happening, but I recommend using the summary in my first paragraph above instead. Please keep in mind that it is the entire TLS connection that is being bumped (or spliced) rather than selected individual requests inside that connection. HTTP CONNECT request/response exchange (if any) happens before TLS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Or alternatively:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>    *Is Squid intentionally connecting to the origin server after
</I>&gt;&gt;<i>    CONNECT in order to generate an error page (403 etc.) that can be
</I>&gt;&gt;<i>    properly displayed to the client browser?*
</I>&gt;<i> 
</I>&gt;<i> Squid does not connect to the origin server in order to generate an error page. Roughly speaking[^1], Squid generates an error page based on the information already available at the time of error page generation.
</I>&gt;<i> Depending on the ssl_bump step that encountered an error, that error page generation may come before or after Squid connects to the origin server. See the web page above for details.
</I>&gt;<i> 
</I>&gt;<i> [1]: Some error response details are collected later, from the subsequent GET request (if any). However, the primary error generation activity happens at error discovery time, before that GET. In a sense, Squid has a response before it has a request, which creates various problems/complications!..
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> 2025/05/28 1:19&#12289;Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&#12398;&#12513;&#12540;&#12523;:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 2025-05-27 10:37, Yves MARTIN wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> My team expects to transparently rewrite requests through squid,
</I>&gt;&gt;&gt;&gt;<i> replacing original URL/hostname by another target URL/host.
</I>&gt;&gt;&gt;&gt;<i> Main objective is to redirect original HTTPS requests triggered by
</I>&gt;&gt;&gt;&gt;<i> &#8220;docker pull alpine&#8221; to a local mirrored registry without obvious
</I>&gt;&gt;&gt;&gt;<i> information in user client that the obtained image comes from mirror:
</I>&gt;&gt;&gt;&gt;<i> original image location is preserved, no specific proxy or mirror
</I>&gt;&gt;&gt;&gt;<i> configuration in docker client/daemon to set.
</I>&gt;&gt;&gt;&gt;<i> To do so, we have used squid-urlrewrite and it works well for HTTP
</I>&gt;&gt;&gt;&gt;<i> request, even if rewrite targets HTTPS URL.
</I>&gt;&gt;&gt;&gt;<i> But when original request is HTTPS, connection still goes to
</I>&gt;&gt;&gt;&gt;<i> original URL/hostname IP address
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://gi/">https://gi/</A>
</I>&gt;&gt;&gt;&gt;<i> thub.com%2Frchunping%2Fsquid-urlrewrite%2Fissues%2F3&amp;data=05%7C02%7C
</I>&gt;&gt;&gt;&gt;<i> josh.piana%40hexcel.com%7C204fa12a9f9e4474188208dd9dec17a2%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C638840359549469713%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&amp;sdata=1qoWRntXqGMAJU6ea0rpsCpSDKYkZYekXF%2FXIEI2i60%3D&amp;reserved=0 According to debug logs, the original request hostname is resolved to IP early and kept in internal context after squid-urlrewrite is invoked.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> In most cases, when bumping connections from a TLS client to Squid
</I>&gt;&gt;&gt;<i> and from Squid to TLS server, Squid &quot;pins&quot; (i.e. remembers) the
</I>&gt;&gt;&gt;<i> Squid-to-server connection and then (re)uses that pinned connection
</I>&gt;&gt;&gt;<i> for all requests received on the client-to-Squid connection.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I have not checked, but speculate that rewriting request target does
</I>&gt;&gt;&gt;<i> not trigger opening a new Squid-to-server TLS connection and re-pinning.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> IIRC, a Squid that is configured to bump during SslBump step1 does
</I>&gt;&gt;&gt;<i> not pin. Such a configuration is rarely usable on a modern internet, but YMMV.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lis/">https://lis/</A>
</I>&gt;&gt;&gt;<i> ts.squid-cache.org%2Flistinfo%2Fsquid-users&amp;data=05%7C02%7Cjosh.piana
</I>&gt;&gt;&gt;<i> %40hexcel.com%7C204fa12a9f9e4474188208dd9dec17a2%7C4248050df19546d5ac
</I>&gt;&gt;&gt;<i> 9c0c7c52b04cae%7C0%7C0%7C638840359549482027%7CUnknown%7CTWFpbGZsb3d8e
</I>&gt;&gt;&gt;<i> yJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTW
</I>&gt;&gt;&gt;<i> FpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&amp;sdata=GMDv3HOK599Jjw94Lu8mvE%2Bnj
</I>&gt;&gt;&gt;<i> 5s9hsjclXv8HKrD6%2Bw%3D&amp;reserved=0
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250529/9527cd94/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250529/9527cd94/attachment-0001.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027563.html">[squid-users] How to do transparent rewrite with https requests?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27564">[ date ]</a>
              <a href="thread.html#27564">[ thread ]</a>
              <a href="subject.html#27564">[ subject ]</a>
              <a href="author.html#27564">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
