<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=ISO-8859-1&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Hello&nbsp;All.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;goal&nbsp;is&nbsp;to&nbsp;do&nbsp;ssl&nbsp;bumping&nbsp;in&nbsp;transparent&nbsp;proxy&nbsp;mode&nbsp;with&nbsp;domain<br>
&nbsp;&nbsp;&nbsp;&nbsp;exclude&nbsp;possibility.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Let&nbsp;me&nbsp;tell&nbsp;you&nbsp;about&nbsp;squid's&nbsp;strange&nbsp;behaviour&nbsp;when&nbsp;I'm&nbsp;trying&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;it.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;browsers&nbsp;it&nbsp;says&nbsp;something&nbsp;like&nbsp;this:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;font-family:&nbsp;'Segoe&nbsp;UI',Tahoma,sans-serif;&nbsp;font-size:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15px;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;24px;&nbsp;text-align:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal;&nbsp;word-spacing:&nbsp;0px;&nbsp;display:&nbsp;inline&nbsp;!&nbsp;important;&nbsp;float:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;none;&nbsp;background-color:&nbsp;rgb(247,&nbsp;247,&nbsp;247);&quot;&gt;&lt;i&gt;This&nbsp;server&nbsp;could<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;not&nbsp;prove&nbsp;that&nbsp;it&nbsp;is&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;http://www.ukr.net&quot;&gt;www.ukr.net&lt;/a&gt;;&nbsp;its&nbsp;security&nbsp;certificate&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from212.42.76.253.&nbsp;This&nbsp;may&nbsp;be&nbsp;caused&nbsp;by&nbsp;a&nbsp;misconfiguration&nbsp;or<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;an&nbsp;attacker&nbsp;intercepting&nbsp;your&nbsp;connection.&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;NET::ERR_CERT_COMMON_NAME_INVALID&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;Subject:&nbsp;212.42.76.253&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;/span&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Looks&nbsp;like&nbsp;squid&nbsp;takes&nbsp;the&nbsp;CN&nbsp;from&nbsp;the&nbsp;certificate&nbsp;as&nbsp;IP&nbsp;address&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;destination&nbsp;domain.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;But,&nbsp;everything&nbsp;works&nbsp;smoothly&nbsp;when&nbsp;I&nbsp;use&nbsp;proxy&nbsp;in&nbsp;non&nbsp;transparent<br>
&nbsp;&nbsp;&nbsp;&nbsp;mode&nbsp;and&nbsp;put&nbsp;it&nbsp;to&nbsp;the&nbsp;browser&nbsp;directly&nbsp;.&nbsp;I&nbsp;can&nbsp;successfully&nbsp;bypass<br>
&nbsp;&nbsp;&nbsp;&nbsp;bad&nbsp;sites&nbsp;and&nbsp;do&nbsp;ssl&nbsp;bumping&nbsp;on&nbsp;others.&nbsp;There&nbsp;are&nbsp;no&nbsp;certificate<br>
&nbsp;&nbsp;&nbsp;&nbsp;errors&nbsp;except&nbsp;of&nbsp;some&nbsp;of&nbsp;them,&nbsp;you&nbsp;know)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;OS&nbsp;is&nbsp;&lt;i&gt;Centos&nbsp;6.5&nbsp;&lt;/i&gt;&lt;i&gt;2.6.32-358.6.2.el6.x86_64&lt;/i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;squid's&nbsp;version:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;i&gt;/opt/squid/sbin/squid&nbsp;-v&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.0.2&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;Service&nbsp;Name:&nbsp;squid&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;configure&nbsp;options:&nbsp;&nbsp;'--with-openssl'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-linux-netfilter'&nbsp;'--disable-ipv6'&nbsp;'--enable-icap-client'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-ssl-crtd'&nbsp;'--prefix=/opt/squid'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-external-acl-helpers=none'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-auth-negotiate=none'&nbsp;'--enable-follow-x-forwarded-for'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--disable-auth-ntlm'&nbsp;'--disable-arch-native'&nbsp;'--enable-wccpv2'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-snmp'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/usr/share/pkgconfig'<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--enable-ltdl-convenience&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;iptables&nbsp;which&nbsp;is&nbsp;doing&nbsp;redirecting&nbsp;to&nbsp;internal&nbsp;squid&nbsp;ports:&nbsp;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;Table:&nbsp;nat&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;Chain&nbsp;PREROUTING&nbsp;(policy&nbsp;ACCEPT)&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;num&nbsp;&nbsp;target&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prot&nbsp;opt&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destination&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;1&nbsp;&nbsp;&nbsp;&nbsp;ACCEPT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;&nbsp;--&nbsp;&nbsp;0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;192.168.0.121&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;dpt:443&nbsp;/*&nbsp;accept&nbsp;connection&nbsp;*/&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;2&nbsp;&nbsp;&nbsp;&nbsp;REDIRECT&nbsp;&nbsp;&nbsp;tcp&nbsp;&nbsp;--&nbsp;&nbsp;192.168.0.0/24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;dpt:443&nbsp;/*&nbsp;redirect&nbsp;*/&nbsp;redir&nbsp;ports&nbsp;3132&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;3&nbsp;&nbsp;&nbsp;&nbsp;ACCEPT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;&nbsp;--&nbsp;&nbsp;0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;192.168.0.121&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;dpt:80&nbsp;/*&nbsp;accept&nbsp;connection&nbsp;*/&lt;/i&gt;&lt;i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/i&gt;&lt;i&gt;4&nbsp;&nbsp;&nbsp;&nbsp;REDIRECT&nbsp;&nbsp;&nbsp;tcp&nbsp;&nbsp;--&nbsp;&nbsp;192.168.0.0/24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcp&nbsp;dpt:80&nbsp;/*&nbsp;redirect&nbsp;*/&nbsp;redir&nbsp;ports&nbsp;3131&lt;/i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;my&nbsp;squid&nbsp;configuration&nbsp;file:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;___________________________&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;visible_hostname&nbsp;local.local&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;always_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dns_nameservers&nbsp;8.8.8.8&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;stare&nbsp;step2&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;sslBumpDeniedDstDomain&nbsp;dstdomain&nbsp;ukr.net&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;http://www.ukr.net&quot;&gt;www.ukr.net&lt;/a&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;splice&nbsp;sslBumpDeniedDstDomain&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;generate-host-certificates=on<br>
&nbsp;&nbsp;&nbsp;&nbsp;dynamic_cert_mem_cache_size=4MB<br>
&nbsp;&nbsp;&nbsp;&nbsp;cert=/opt/squid/var/ssl_cert/cert.pem&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;3131&nbsp;transparent&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;https_port&nbsp;3132&nbsp;transparent&nbsp;ssl-bump&nbsp;generate-host-certificates=on<br>
&nbsp;&nbsp;&nbsp;&nbsp;dynamic_cert_mem_cache_size=4MB<br>
&nbsp;&nbsp;&nbsp;&nbsp;cert=/opt/squid/var/ssl_cert/cert.pem&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_program&nbsp;/opt/squid/libexec/ssl_crtd&nbsp;-s&nbsp;/opt/squid/var/ssl_db<br>
&nbsp;&nbsp;&nbsp;&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_children&nbsp;15&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;logformat&nbsp;logaccess&nbsp;&nbsp;[%{%d/%b/%Y&nbsp;&nbsp;%H:%M:%S}tl]&nbsp;%&gt;a&nbsp;%Ss/%03&gt;Hs<br>
&nbsp;&nbsp;&nbsp;&nbsp;%&lt;st&nbsp;%rm&nbsp;%ru&nbsp;%un&nbsp;%Sh/%&lt;A&nbsp;%mt&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;daemon:/opt/squid/var/logs/access.log&nbsp;logaccess&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;______________________________________________________&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Also,&nbsp;I've&nbsp;run&nbsp;squid&nbsp;like&nbsp;this&nbsp;&lt;b&gt;&lt;i&gt;/opt/squid/sbin/squid&nbsp;-N&nbsp;-X&nbsp;-d<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&lt;/i&gt;&lt;/b&gt;&nbsp;&nbsp;and&nbsp;got&nbsp;interesting&nbsp;strings&nbsp;like:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;i&gt;2014/11/26&nbsp;04:28:08.622|&nbsp;client_side.cc(3849)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpsSslBumpAccessCheckDone:&nbsp;sslBump&nbsp;needed&nbsp;for&lt;/i&gt;&lt;i&gt;&lt;b&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=212.42.76.246:443&lt;/b&gt;&lt;/i&gt;&lt;i&gt;&nbsp;&lt;/i&gt;&lt;i&gt;&lt;b&gt;remote=192.168.0.122:63719&lt;/b&gt;&lt;/i&gt;&lt;i&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD&nbsp;40&nbsp;flags=33&nbsp;method&nbsp;5&lt;/i&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Here,&nbsp;the&nbsp;local&nbsp;and&nbsp;remote&nbsp;IP&nbsp;addresses&nbsp;are&nbsp;switched&nbsp;(I&nbsp;checked&nbsp;such<br>
&nbsp;&nbsp;&nbsp;&nbsp;lines&nbsp;when&nbsp;went&nbsp;through&nbsp;the&nbsp;squid&nbsp;directly).&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Please,&nbsp;tell&nbsp;me&nbsp;what&nbsp;can&nbsp;be&nbsp;wrong&nbsp;in&nbsp;configuration&nbsp;or&nbsp;squid.&nbsp;&nbsp;I&nbsp;can<br>
&nbsp;&nbsp;&nbsp;&nbsp;provide&nbsp;you&nbsp;with&nbsp;any&nbsp;logs&nbsp;which&nbsp;you&nbsp;may&nbsp;need.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;BTW,&nbsp;cache.log&nbsp;is&nbsp;clean.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;________________&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Best&nbsp;regards&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
