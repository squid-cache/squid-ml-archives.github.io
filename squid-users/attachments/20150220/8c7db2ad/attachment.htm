<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;On&nbsp;20/02/15&nbsp;13:29,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:54E728A6.4010606@treenet.co.nz&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;On&nbsp;20/02/2015&nbsp;10:55&nbsp;p.m.,&nbsp;Corentin&nbsp;Delcourt&nbsp;wrote:<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;I&nbsp;run&nbsp;two&nbsp;squid&nbsp;servers,&nbsp;siblings&nbsp;with&nbsp;each&nbsp;other,&nbsp;let's&nbsp;call&nbsp;them&nbsp;A&nbsp;and<br>
B.&nbsp;When&nbsp;clients&nbsp;send&nbsp;requests&nbsp;to&nbsp;A,&nbsp;and&nbsp;A&nbsp;thinks&nbsp;B&nbsp;has&nbsp;the&nbsp;resource<br>
cached,&nbsp;but&nbsp;in&nbsp;reality&nbsp;B&nbsp;doesn't,<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
Use&nbsp;HTCP&nbsp;protocol&nbsp;between&nbsp;the&nbsp;peers,&nbsp;far&nbsp;less&nbsp;false&nbsp;positives&nbsp;than&nbsp;ICP<br>
or&nbsp;digest.<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Will&nbsp;do,&nbsp;thanks&nbsp;for&nbsp;the&nbsp;tip.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:54E728A6.4010606@treenet.co.nz&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;the&nbsp;client&nbsp;will&nbsp;get&nbsp;a&nbsp;504&nbsp;error&nbsp;with<br>
the&nbsp;message:&nbsp;“Valid&nbsp;document&nbsp;was&nbsp;not&nbsp;found&nbsp;in&nbsp;the&nbsp;cache&nbsp;and<br>
‘only-if-cached’&nbsp;directive&nbsp;was&nbsp;specified.”&nbsp;Vice&nbsp;versa&nbsp;if&nbsp;clients&nbsp;send<br>
requests&nbsp;to&nbsp;B.<br>
<br>
I&nbsp;believe&nbsp;that&nbsp;A&nbsp;should&nbsp;catch&nbsp;this&nbsp;error&nbsp;and&nbsp;fetch&nbsp;the&nbsp;resource<br>
directly,&nbsp;but&nbsp;instead&nbsp;it&nbsp;forwards&nbsp;it&nbsp;to&nbsp;the&nbsp;client,&nbsp;and&nbsp;I&nbsp;cannot&nbsp;figure<br>
out&nbsp;why.&nbsp;I&nbsp;am&nbsp;not&nbsp;using&nbsp;allow-miss.<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
It&nbsp;should&nbsp;be&nbsp;but&nbsp;there&nbsp;are&nbsp;conditions&nbsp;to&nbsp;that:<br>
<br>
*&nbsp;another&nbsp;source&nbsp;of&nbsp;the&nbsp;URL&nbsp;is&nbsp;actually&nbsp;accessible&nbsp;(think&nbsp;IPv6-only<br>
websites,&nbsp;routing&nbsp;outages,&nbsp;DNS&nbsp;lookup&nbsp;failures,&nbsp;Path-MTU&nbsp;failures,<br>
traffic&nbsp;blackholes,&nbsp;etc)<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;I&nbsp;re-send&nbsp;a&nbsp;failing&nbsp;request&nbsp;with&nbsp;Cache-Control:&nbsp;no-cache,&nbsp;or&nbsp;if&nbsp;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;remove&nbsp;the&nbsp;cache_peer&nbsp;directive,&nbsp;I&nbsp;don't&nbsp;get&nbsp;any&nbsp;errors&nbsp;at&nbsp;all&nbsp;so&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;doesn't&nbsp;seem&nbsp;like&nbsp;this&nbsp;is&nbsp;the&nbsp;problem&nbsp;here.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:54E728A6.4010606@treenet.co.nz&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;*&nbsp;there&nbsp;is&nbsp;time&nbsp;remaining&nbsp;within&nbsp;the&nbsp;forward_timeout&nbsp;for&nbsp;the&nbsp;alterative<br>
route&nbsp;to&nbsp;be&nbsp;contacted.&nbsp;If&nbsp;the&nbsp;timeout&nbsp;occurs&nbsp;the&nbsp;last&nbsp;error&nbsp;state<br>
encountered&nbsp;will&nbsp;be&nbsp;reported,&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;earlier&nbsp;error&nbsp;the&nbsp;timeout<br>
itself&nbsp;is&nbsp;mentioned.&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;believe&nbsp;the&nbsp;default&nbsp;timeout&nbsp;is&nbsp;4&nbsp;minutes?&nbsp;I&nbsp;set&nbsp;it&nbsp;explicitely&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;minutes,&nbsp;and&nbsp;forward-max-tries&nbsp;to&nbsp;25&nbsp;for&nbsp;good&nbsp;measure,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;requests&nbsp;are&nbsp;still&nbsp;failing&nbsp;within&nbsp;hundreds&nbsp;of&nbsp;milliseconds&nbsp;so&nbsp;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;don't&nbsp;think&nbsp;this&nbsp;is&nbsp;related.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:54E728A6.4010606@treenet.co.nz&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;*&nbsp;the&nbsp;504&nbsp;is&nbsp;not&nbsp;being&nbsp;cached.&nbsp;That&nbsp;error&nbsp;response&nbsp;is&nbsp;one&nbsp;which&nbsp;is<br>
allowed&nbsp;to&nbsp;be&nbsp;cached&nbsp;by&nbsp;proxies&nbsp;if&nbsp;it&nbsp;gets&nbsp;delivered&nbsp;with&nbsp;cacheability<br>
headers.&nbsp;NP:&nbsp;It&nbsp;could&nbsp;be&nbsp;cached&nbsp;and&nbsp;delivered&nbsp;by&nbsp;either&nbsp;proxy,&nbsp;so&nbsp;even<br>
coming&nbsp;from&nbsp;the&nbsp;other&nbsp;one&nbsp;*it*&nbsp;may&nbsp;still&nbsp;have&nbsp;been&nbsp;cached&nbsp;and&nbsp;what<br>
caused&nbsp;the&nbsp;&quot;HIT&quot;&nbsp;to&nbsp;be&nbsp;identified.<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;don't&nbsp;think&nbsp;the&nbsp;error&nbsp;is&nbsp;being&nbsp;served&nbsp;from&nbsp;cache.&nbsp;If&nbsp;I&nbsp;look&nbsp;at&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;access&nbsp;logs&nbsp;for&nbsp;both&nbsp;machines&nbsp;I&nbsp;see:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;1424437827.131&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6 127.0.0.1 &nbsp;&nbsp;TCP_MISS/504&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4913&nbsp;&nbsp;&nbsp;&nbsp;GET&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://example.net/&quot;&gt;http://example.net/&lt;/a&gt;&nbsp;-&nbsp;SIBLING_HIT/10.0.1.2&nbsp;&nbsp;text/html<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;on&nbsp;A&nbsp;and&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;1424437827.882&nbsp;&nbsp;&nbsp;0&nbsp;10.0.1.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_MISS/504&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4801&nbsp;&nbsp;&nbsp;&nbsp;GET&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://example.net/&quot;&gt;http://example.net/&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text/html&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;…&nbsp;on&nbsp;B,&nbsp;10.0.1.1&nbsp;being&nbsp;A&nbsp;and&nbsp;10.0.1.2&nbsp;being&nbsp;B.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:54E728A6.4010606@treenet.co.nz&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;What&nbsp;confuses&nbsp;me&nbsp;even&nbsp;more&nbsp;is&nbsp;that&nbsp;this&nbsp;didn't&nbsp;happen&nbsp;a&nbsp;month&nbsp;ago,&nbsp;with<br>
the&nbsp;same&nbsp;setup.<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
...&nbsp;what&nbsp;version&nbsp;of&nbsp;Squid?<br>
...&nbsp;and&nbsp;is&nbsp;it&nbsp;the&nbsp;same&nbsp;setup&nbsp;AND&nbsp;version(s)&nbsp;of&nbsp;Squid&nbsp;from&nbsp;a&nbsp;month&nbsp;ago?<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I'm&nbsp;running&nbsp;Squid&nbsp;3.5.2&nbsp;on&nbsp;both&nbsp;servers.&nbsp;I&nbsp;was&nbsp;running&nbsp;3.5.1&nbsp;on&nbsp;both<br>
&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;week&nbsp;ago&nbsp;and&nbsp;observing&nbsp;the&nbsp;same&nbsp;problem.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;can't&nbsp;say&nbsp;for&nbsp;sure&nbsp;which&nbsp;version&nbsp;I&nbsp;was&nbsp;running&nbsp;before&nbsp;this&nbsp;started<br>
&nbsp;&nbsp;&nbsp;&nbsp;happening,&nbsp;but&nbsp;I&nbsp;believe&nbsp;it&nbsp;was&nbsp;3.4.8&nbsp;on&nbsp;one&nbsp;machine&nbsp;and&nbsp;3.4.10&nbsp;on<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;other.&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
