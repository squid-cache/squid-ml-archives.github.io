<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;so,&nbsp;there&#39;s&nbsp;my&nbsp;proxy&nbsp;problem&nbsp;I&nbsp;couldn&#39;t&nbsp;crack,&nbsp;even&nbsp;after&nbsp;spending&nbsp;2+&nbsp;days tweaking-googling-debugging.&nbsp;:(&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem:&nbsp;my&nbsp;_new_&nbsp;Squid&nbsp;installation&nbsp;(Ubuntu&nbsp;14&nbsp;LTS&nbsp;with&nbsp;Squid&nbsp;3.3.8)&nbsp;won&#39;t&nbsp;cache&nbsp;most&nbsp;pages&nbsp;the&nbsp;old&nbsp;Squid&nbsp;does&nbsp;(old&nbsp;Fedora&nbsp;with&nbsp;Squid&nbsp;3.1.15).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Infos:&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:12.8000001907349px;font-family:arial,helvetica,sans-serif&quot;&gt;-&nbsp;Simple&nbsp;reverse&nbsp;proxy,&nbsp;port&nbsp;80&nbsp;only,&nbsp;one&nbsp;uplink&nbsp;straight&nbsp;to&nbsp;the&nbsp;app&nbsp;servers.&nbsp;(The&nbsp;old&nbsp;one&nbsp;points&nbsp;to&nbsp;a&nbsp;load&nbsp;balancer.&nbsp;For&nbsp;testing&nbsp;purposes&nbsp;and&nbsp;seeing&nbsp;the&nbsp;mail&nbsp;on&nbsp;&quot;Thu,&nbsp;4&nbsp;Apr&nbsp;2013&nbsp;16:54:10&nbsp;-0700&quot;,&nbsp;I&#39;m&nbsp;pointing&nbsp;the&nbsp;new&nbsp;one&nbsp;to&nbsp;a&nbsp;specific&nbsp;app&nbsp;server.)&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:12.8000001907349px;font-family:arial,helvetica,sans-serif&quot;&gt;-&nbsp;Pretty&nbsp;standard&nbsp;configuration,&nbsp;standard&nbsp;refresh_patterns.&nbsp;(I&#39;d&nbsp;be&nbsp;surprised&nbsp;if&nbsp;it&nbsp;was&nbsp;a&nbsp;config&nbsp;problem&nbsp;since&nbsp;ICOs&nbsp;are&nbsp;cached&nbsp;well.)&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:12.8000001907349px;font-family:arial,helvetica,sans-serif&quot;&gt;-&nbsp;I&nbsp;have&nbsp;disk&nbsp;caching&nbsp;on&nbsp;the&nbsp;new&nbsp;one,&nbsp;the&nbsp;disk&nbsp;cache&nbsp;has&nbsp;been&nbsp;initialised&nbsp;with&nbsp;-z.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:12.8000001907349px;font-family:arial,helvetica,sans-serif&quot;&gt;-&nbsp;The&nbsp;old&nbsp;one&nbsp;has&nbsp;a&nbsp;very&nbsp;relaxed&nbsp;iptables,&nbsp;the&nbsp;new&nbsp;one&nbsp;has&nbsp;ufw,&nbsp;later&nbsp;set&nbsp;to&nbsp;allow&nbsp;port&nbsp;80&nbsp;and&nbsp;22&nbsp;only&nbsp;for&nbsp;incoming&nbsp;connections.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:12.8000001907349px;font-family:arial,helvetica,sans-serif&quot;&gt;-&nbsp;Clocks&nbsp;are&nbsp;in&nbsp;sync&nbsp;using&nbsp;ntpd&nbsp;-&nbsp;the&nbsp;old&nbsp;one&nbsp;has&nbsp;+20min&nbsp;delay&nbsp;(ie.&nbsp;shows&nbsp;a&nbsp;later&nbsp;time&nbsp;than&nbsp;now).&nbsp;Since&nbsp;it&#39;s&nbsp;the&nbsp;live&nbsp;one,&nbsp;it&#39;s&nbsp;working&nbsp;and&nbsp;it&nbsp;handles&nbsp;a&nbsp;lot&nbsp;of&nbsp;load&nbsp;well,&nbsp;I&nbsp;haven&#39;t&nbsp;dared&nbsp;to&nbsp;correct&nbsp;it.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&gt;-&nbsp;The&nbsp;new&nbsp;Squid&nbsp;gives&nbsp;HITs&nbsp;for&nbsp;favicon.ico&nbsp;and&nbsp;RSS&nbsp;feeds&nbsp;only&nbsp;-&nbsp;these&nbsp;have&nbsp;different&nbsp;headers&nbsp;and&nbsp;mimetypes&nbsp;compared&nbsp;to&nbsp;HTML&nbsp;files&nbsp;(and&nbsp;that&#39;s by&nbsp;design).&lt;/div&gt;&lt;div&gt;-&nbsp;This&nbsp;new&nbsp;server&nbsp;seems&nbsp;to&nbsp;save&nbsp;accessed&nbsp;HTML&nbsp;files&nbsp;in&nbsp;the&nbsp;disk&nbsp;cache&nbsp;but&nbsp;still&nbsp;gives&nbsp;X-Cache-Lookup:MISS&nbsp;for&nbsp;all&nbsp;of&nbsp;them&nbsp;later.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;I&nbsp;debugged&nbsp;using&nbsp;debug_options&nbsp;and&nbsp;logging:&nbsp;h&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;eaders&nbsp;look&nbsp;okay&nbsp;(Cache-Control,&nbsp;Pragma,&nbsp;Vary&nbsp;-&nbsp;pasted&nbsp;below),&nbsp;stale/fresh&nbsp;calculation&nbsp;looks&nbsp;okay&nbsp;(pages&nbsp;are&nbsp;deemed&nbsp;fresh).&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;The&nbsp;best&nbsp;I&nbsp;got&nbsp;so&nbsp;far&nbsp;is&nbsp;this:&nbsp;&quot;client_side_reply.cc(1618)&nbsp;identifyFoundObject:&nbsp;clientProcessRequest2:&nbsp;StoreEntry&nbsp;is&nbsp;NULL&nbsp;-&nbsp; MISS&quot;,&nbsp;even&nbsp;for&nbsp;pages&nbsp;I&nbsp;see&nbsp;in&nbsp;the&nbsp;disk&nbsp;cache.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;use&nbsp;overriding&nbsp;in&nbsp;refresh_patterns,&nbsp;because&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;the&nbsp;problem&nbsp;yet,&nbsp;I&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;problem&nbsp;would&nbsp;this&nbsp;hack&nbsp;hide&nbsp;(and&nbsp;for&nbsp;how&nbsp;long).&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;move&nbsp;away&nbsp;from&nbsp;the&nbsp;current&nbsp;platform&nbsp;and&nbsp;version&nbsp;if&nbsp;possible&nbsp;because&nbsp;this&nbsp;has&nbsp;LTS&nbsp;support&nbsp;and&nbsp;we&#39;ll&nbsp;have&nbsp;many&nbsp;proxy&nbsp;servers&nbsp;if&nbsp;we&nbsp;finally&nbsp;figure&nbsp;out&nbsp;the&nbsp;right&nbsp;config.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;Strange&nbsp;thing,&nbsp;the&nbsp;old&nbsp;proxy&nbsp;seems&nbsp;to&nbsp;return&nbsp;stuff&nbsp;with&nbsp;HTTP/1.0&nbsp;and&nbsp;the&nbsp;new&nbsp;one&nbsp;with &lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;HTTP/1.1&nbsp;in&nbsp;the&nbsp;same&nbsp;browser.&nbsp;No&nbsp;idea&nbsp;why.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;What&nbsp;I&#39;ve&nbsp;tried:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;Compared&nbsp;my&nbsp;squid.conf&nbsp;files&nbsp;-&nbsp;nothing&nbsp;special.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;Googling&nbsp;and&nbsp;mailing&nbsp;list&nbsp;archives&nbsp;-&nbsp;only&nbsp;found&nbsp;common&nbsp;MISS&nbsp;problems&nbsp;that&nbsp;don&#39;t&nbsp;apply&nbsp;to&nbsp;my&nbsp;case.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;Have&nbsp;even&nbsp;experimented&nbsp;removing&nbsp;max-age&nbsp;from&nbsp;the&nbsp;headers&nbsp;sent&nbsp;by&nbsp;the&nbsp;server&nbsp;and&nbsp;only&nbsp;featuring&nbsp;public,&nbsp;also&nbsp;set &lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Last-Modified&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt; 10&nbsp;minutes&nbsp;in&nbsp;the&nbsp;past&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt; -&nbsp;no&nbsp;change.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;-&nbsp;I&#39;ve&nbsp;only&nbsp;moved&nbsp;one&nbsp;low-traffic&nbsp;live&nbsp;site&nbsp;to&nbsp;the&nbsp;new&nbsp;proxy&nbsp;so&nbsp;I&nbsp;can&nbsp;test&nbsp;the&nbsp;old&nbsp;one&nbsp;and&nbsp;the&nbsp;new&nbsp;with&nbsp;the&nbsp;same&nbsp;app&nbsp;server&nbsp;engine.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;I&nbsp;know&nbsp;of &lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Vary:Accept-Encoding&nbsp;issues&nbsp;with&nbsp;testing,&nbsp;so&nbsp;I&nbsp;test&nbsp;in&nbsp;the&nbsp;same&nbsp;browser,&nbsp;clearing&nbsp;the&nbsp;cache&nbsp;before&nbsp;the&nbsp;second&nbsp;page&nbsp;access.&nbsp;With&nbsp;this,&nbsp;I&nbsp;see&nbsp;HITs&nbsp;on&nbsp;the&nbsp;old&nbsp;server&nbsp;and&nbsp;MISS&nbsp;for&nbsp;the&nbsp;new.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;-&nbsp;Heavy&nbsp;logging&nbsp;and&nbsp;debugging,&nbsp;checking&nbsp;out&nbsp;HTTP&nbsp;headers&nbsp;too&nbsp;-&nbsp;seems&nbsp;okay.&nbsp;The&nbsp;same&nbsp;HTTP&nbsp;headers&nbsp;yield&nbsp;in&nbsp;HITs&nbsp;on&nbsp;the&nbsp;old&nbsp;server&nbsp;and&nbsp;MISS&nbsp;on&nbsp;the&nbsp;new&nbsp;one.&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;I&#39;ve&nbsp;collected&nbsp;some&nbsp;resources:&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;-&nbsp;Old&nbsp;server&nbsp;squid.&lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;conf&nbsp;- &lt;/span&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;a&nbsp;href=&quot;http://pastebin.com/h0C7t96n&quot;&nbsp;target=&quot;_blank&quot;&gt;http://pastebin.com/h0C7t96n&lt;/a&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;New&nbsp;server&nbsp;squid.conf&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;http://pastebin.com/KaHDVWYt&quot;&nbsp;target=&quot;_blank&quot;&gt;http://pastebin.com/KaHDVWYt&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;-&nbsp;Examples&nbsp;that&nbsp;gets&nbsp;cached&nbsp;on&nbsp;both&nbsp;servers&nbsp;- &lt;a&nbsp;href=&quot;http://pastebin.com/Be4RqVLq&quot;&nbsp;target=&quot;_blank&quot;&gt;http://pastebin.com/Be4RqVLq&lt;/a&gt; , &lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;a&nbsp;href=&quot;http://pastebin.com/yVDeuyQp&quot;&gt;http://pastebin.com/yVDeuyQp&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;- &lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;Example&nbsp;that&nbsp;gets&nbsp;cached&nbsp;on&nbsp;the&nbsp;old&nbsp;server&nbsp;but&nbsp;is&nbsp;a&nbsp;MISS&nbsp;on&nbsp;the&nbsp;new&nbsp;one&nbsp;- &lt;/span&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;a&nbsp;href=&quot;http://pastebin.com/VvTU6ieR&quot;&nbsp;target=&quot;_blank&quot;&gt;http://pastebin.com/VvTU6ieR&lt;/a&gt;&nbsp;vs &lt;a&nbsp;href=&quot;http://pastebin.com/ysKJwbmh&quot;&gt;http://pastebin.com/ysKJwbmh&lt;/a&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;-&nbsp;Old&nbsp;server&nbsp;firewall&lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt; &lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;settings&nbsp;- &lt;/span&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;a&nbsp;href=&quot;http://pastebin.com/v688dDMU&quot;&gt;http://pastebin.com/v688dDMU&lt;/a&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;-&nbsp;New&nbsp;server&nbsp;firewall&nbsp;settings&nbsp;- &lt;a&nbsp;href=&quot;http://pastebin.com/HyzGdjb4&quot;&gt;http://pastebin.com/HyzGdjb4&lt;/a&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;Any&nbsp;tips,&nbsp;hints?&nbsp;This&nbsp;is&nbsp;driving&nbsp;me&nbsp;crazy!&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;Greg&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:arial,helvetica,sans-serif;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
