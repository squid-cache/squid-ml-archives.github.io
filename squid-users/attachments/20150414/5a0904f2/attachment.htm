<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;worked&nbsp;a&nbsp;fix:&lt;br&gt;&lt;br&gt;diff&nbsp;--git&nbsp;a/squid-3.5.1/src/client_side.cc&nbsp;b/squid-3.5.1/src/client_side.cc&lt;br&gt;index&nbsp;d72e8c4..025316d&nbsp;100644&lt;br&gt;---&nbsp;a/squid-3.5.1/src/client_side.cc&lt;br&gt;+++&nbsp;b/squid-3.5.1/src/client_side.cc&lt;br&gt;@@&nbsp;-3045,7&nbsp;+3045,8&nbsp;@@&nbsp;ConnStateData::parseProxy1p0()&lt;br&gt;        &nbsp;debugs(33,&nbsp;5,&nbsp;&quot;PROXY/1.0&nbsp;protocol&nbsp;on&nbsp;connection&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;clientConnection);&lt;br&gt;        &nbsp;clientConnection-&gt;local&nbsp;=&nbsp;originalDest;&lt;br&gt;        &nbsp;clientConnection-&gt;remote&nbsp;=&nbsp;originalClient;&lt;br&gt;-       &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;+       &nbsp;if&nbsp;(clientConnection-&gt;flags&nbsp;&amp;&nbsp;COMM_TRANSPARENT)&lt;br&gt;+           &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;        &nbsp;debugs(33,&nbsp;5,&nbsp;&quot;PROXY/1.0&nbsp;upgrade:&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;clientConnection);&lt;br&gt;&lt;br&gt;        &nbsp;//&nbsp;repeat&nbsp;fetch&nbsp;ensuring&nbsp;the&nbsp;new&nbsp;client&nbsp;FQDN&nbsp;can&nbsp;be&nbsp;logged&lt;br&gt;@@&nbsp;-3135,14&nbsp;+3136,16&nbsp;@@&nbsp;ConnStateData::parseProxy2p0()&lt;br&gt;        &nbsp;clientConnection-&gt;local.port(ntohs(ipu.ipv4_addr.dst_port));&lt;br&gt;        &nbsp;clientConnection-&gt;remote&nbsp;=&nbsp;ipu.ipv4_addr.src_addr;&lt;br&gt;        &nbsp;clientConnection-&gt;remote.port(ntohs(ipu.ipv4_addr.src_port));&lt;br&gt;-       &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;+       &nbsp;if&nbsp;(clientConnection-&gt;flags&nbsp;&amp;&nbsp;COMM_TRANSPARENT)&lt;br&gt;+           &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;        &nbsp;break;&lt;br&gt;    &nbsp;case&nbsp;0x2:&nbsp;//&nbsp;IPv6        &nbsp;clientConnection-&gt;local&nbsp;=&nbsp;ipu.ipv6_addr.dst_addr;&lt;br&gt;        &nbsp;clientConnection-&gt;local.port(ntohs(ipu.ipv6_addr.dst_port));&lt;br&gt;        &nbsp;clientConnection-&gt;remote&nbsp;=&nbsp;ipu.ipv6_addr.src_addr;&lt;br&gt;        &nbsp;clientConnection-&gt;remote.port(ntohs(ipu.ipv6_addr.src_port));&lt;br&gt;-       &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;+       &nbsp;if&nbsp;(clientConnection-&gt;flags&nbsp;&amp;&nbsp;COMM_TRANSPARENT)&lt;br&gt;+           &nbsp;clientConnection-&gt;flags&nbsp;^=&nbsp;COMM_TRANSPARENT;&nbsp;//&nbsp;prevent&nbsp;TPROXY&nbsp;spoofing&nbsp;of&nbsp;this&nbsp;new&nbsp;IP.&lt;br&gt;        &nbsp;break;&lt;br&gt;    &nbsp;default:&nbsp;//&nbsp;do&nbsp;nothing&lt;br&gt;        &nbsp;break;&lt;br&gt;                &nbsp;&lt;br&gt;&lt;/div&gt;I&nbsp;assume&nbsp;the&nbsp;intention&nbsp;of&nbsp;code&nbsp;is&nbsp;to&nbsp;turn&nbsp;off&nbsp;COMM_TRANSPARENT&nbsp;if&nbsp;PROXY&nbsp;protocol&nbsp;is&nbsp;used.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Is&nbsp;this&nbsp;proper&nbsp;change?&nbsp;At&nbsp;least,&nbsp;it&nbsp;works&nbsp;for&nbsp;me&nbsp;now,&lt;br&gt;&lt;br&gt;&lt;/div&gt;Alex&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Apr&nbsp;14,&nbsp;2015&nbsp;at&nbsp;3:14&nbsp;PM,&nbsp;Yuhua&nbsp;Wu&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:ywu@bitglass.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ywu@bitglass.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;found&nbsp;out&nbsp;what&nbsp;is&nbsp;wrong,&nbsp;but&nbsp;I&nbsp;am&nbsp;not&nbsp;familar&nbsp;to&nbsp;squid&nbsp;code,&nbsp;so&nbsp;I&nbsp;post&nbsp;here&nbsp;to&nbsp;see&nbsp;if&nbsp;someone&nbsp;can&nbsp;show&nbsp;me&nbsp;the&nbsp;next&nbsp;step:&lt;br&gt;&lt;br&gt;&lt;/div&gt;The&nbsp;problem&nbsp;is&nbsp;at&nbsp;this&nbsp;part&nbsp;of&nbsp;code:&lt;br&gt;void&lt;br&gt;ClientHttpRequest::sslBumpStart()&lt;br&gt;{&lt;br&gt;   &nbsp;debugs(85,&nbsp;5,&nbsp;HERE&nbsp;&lt;&lt;&nbsp;&quot;Confirming&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;Ssl::bumpMode(sslBumpNeed_)&nbsp;&lt;&lt;&lt;br&gt;          &nbsp;&quot;-bumped&nbsp;CONNECT&nbsp;tunnel&nbsp;on&nbsp;FD&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;getConn()-&gt;clientConnection);&lt;br&gt;   &nbsp;getConn()-&gt;sslBumpMode&nbsp;=&nbsp;sslBumpNeed_;&lt;br&gt;&lt;br&gt;   &nbsp;AsyncCall::Pointer&nbsp;bumpCall&nbsp;=&nbsp;commCbCall(85,&nbsp;5,&nbsp;&quot;ClientSocketContext::sslBumpEstablish&quot;,&lt;br&gt;                                 &nbsp;CommIoCbPtrFun(&amp;SslBumpEstablish,&nbsp;this));&lt;br&gt;&lt;br&gt;   &nbsp;if&nbsp;(request-&gt;flags.interceptTproxy&nbsp;||&nbsp;request-&gt;flags.intercepted)&nbsp;{&lt;br&gt;       &nbsp;CommIoCbParams&nbsp;&amp;params&nbsp;=&nbsp;GetCommParams&lt;CommIoCbParams&gt;(bumpCall);&lt;br&gt;       &nbsp;params.flag&nbsp;=&nbsp;Comm::OK;&lt;br&gt;       &nbsp;params.conn&nbsp;=&nbsp;getConn()-&gt;clientConnection;&lt;br&gt;       &nbsp;ScheduleCallHere(bumpCall);&lt;br&gt;       &nbsp;return;&lt;br&gt;   &nbsp;}&lt;br&gt;&lt;br&gt;   &nbsp;//&nbsp;send&nbsp;an&nbsp;HTTP&nbsp;200&nbsp;response&nbsp;to&nbsp;kick&nbsp;client&nbsp;SSL&nbsp;negotiation&lt;br&gt;   &nbsp;//&nbsp;TODO:&nbsp;Unify&nbsp;with&nbsp;tunnel.cc&nbsp;and&nbsp;add&nbsp;a&nbsp;Server(?)&nbsp;header&lt;br&gt;   &nbsp;static&nbsp;const&nbsp;char&nbsp;*const&nbsp;conn_established&nbsp;=&nbsp;&quot;HTTP/1.1&nbsp;200&nbsp;Connection&nbsp;established\r\n\r\n&quot;;&lt;br&gt;   &nbsp;Comm::Write(getConn()-&gt;clientConnection,&nbsp;conn_established,&nbsp;strlen(conn_established),&nbsp;bumpCall,&nbsp;NULL);&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;/div&gt;if&nbsp;require-proxy-header&nbsp;is&nbsp;not&nbsp;used,&nbsp;then&nbsp;request-&gt;flags.interceptTproxy&nbsp;is&nbsp;0,&nbsp;and&nbsp;when&nbsp;requir-proxy-header&nbsp;is&nbsp;used,&nbsp;the&lt;br&gt;&lt;/div&gt;request-&gt;flags.interceptTproxy&nbsp;is&nbsp;1!&lt;br&gt;&lt;br&gt;&lt;/div&gt;since&nbsp;request-&gt;flags.interceptTproxy&nbsp;is&nbsp;1,&nbsp;the&nbsp;200&nbsp;status&nbsp;code&nbsp;for&nbsp;CONNECT&nbsp;call&nbsp;is&nbsp;not&nbsp;sent.&nbsp;(The&nbsp;last&nbsp;part&nbsp;of&nbsp;code&nbsp;sending&nbsp;200&nbsp;status&nbsp;code&nbsp;is&nbsp;skipped.)&lt;br&gt;&lt;br&gt;&lt;/div&gt;Any&nbsp;kind&nbsp;help?&lt;br&gt;&lt;br&gt;&lt;/div&gt;Alex&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Apr&nbsp;14,&nbsp;2015&nbsp;at&nbsp;10:05&nbsp;AM,&nbsp;Yuhua&nbsp;Wu&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:ywu@bitglass.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ywu@bitglass.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;I&nbsp;think,&nbsp;in&nbsp;the&nbsp;sslbump&nbsp;mode,&nbsp;if&nbsp;PROXY&nbsp;protocol&nbsp;is&nbsp;enabled,&nbsp;client&nbsp;cannot&nbsp;set&nbsp;up&nbsp;the&nbsp;SSL&nbsp;tunnel&nbsp;with&nbsp;squid&nbsp;after&nbsp;CONNECT&nbsp;call&nbsp;succeeds.&nbsp;I&nbsp;remember&nbsp;that&nbsp;HAProxy&nbsp;will&nbsp;send&nbsp;PROXY&nbsp;protocol&nbsp;line&nbsp;during&nbsp;ssl&nbsp;negotiation.&nbsp;If&nbsp;squid&nbsp;does&nbsp;not&nbsp;parse&nbsp;the&nbsp;PROXY&nbsp;protocol&nbsp;header&nbsp;during&nbsp;SSL&nbsp;negotiation,&nbsp;this&nbsp;will&nbsp;cause&nbsp;the&nbsp;problem.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Alex&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&gt;On&nbsp;Mon,&nbsp;Apr&nbsp;13,&nbsp;2015&nbsp;at&nbsp;7:56&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;/span&gt;&lt;div&gt;&lt;div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;14/04/2015&nbsp;4:47&nbsp;a.m.,&nbsp;Yuhua&nbsp;Wu&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;For&nbsp;example,&nbsp;is&nbsp;this&nbsp;configuration&nbsp;supported?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3129&nbsp;require-proxy-header&nbsp;ssl-bump&nbsp;……&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;By&nbsp;the&nbsp;way,&nbsp;we&nbsp;added&nbsp;acl&nbsp;rules:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;frontend&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.0/8&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;proxy_protocol_access&nbsp;allow&nbsp;frontend&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Alex&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;Yes&nbsp;that&nbsp;should&nbsp;work.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Versions/v3/3.5/RELEASENOTES.html#ss2.7&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.squid-cache.org/Versions/v3/3.5/RELEASENOTES.html#ss2.7&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;above&nbsp;config&nbsp;example&nbsp;decrypts&nbsp;the&nbsp;traffic&nbsp;through&nbsp;the&nbsp;following&nbsp;layers:&lt;br&gt;<br>
 &nbsp;HTTPS&nbsp;over&nbsp;HTTP/1.x&nbsp;over&nbsp;PROXY/TCP&nbsp;...&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;you&nbsp;can&nbsp;see&nbsp;the&nbsp;PROXY&nbsp;and&nbsp;HTTPS&nbsp;layers&nbsp;are&nbsp;separate&nbsp;protocols&nbsp;that&lt;br&gt;<br>
dont&nbsp;interact.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
