<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Hello&nbsp;all,&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;I&#39;m&nbsp;trying&nbsp;my&nbsp;hands&nbsp;with&nbsp;openvswitch&nbsp;and&nbsp;squid.&nbsp;This&nbsp;is&nbsp;what&nbsp;I&nbsp;want&nbsp;to&nbsp;achieve.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;The&nbsp;client&nbsp;tries&nbsp;to&nbsp;connect&nbsp;to&nbsp;the&nbsp;server.&nbsp;This&nbsp;packet&nbsp;is&nbsp;handled&nbsp;through&nbsp;an&nbsp;openvswitch&nbsp;and&nbsp;it&#39;s&nbsp;sent&nbsp;to&nbsp;a&nbsp;machine&nbsp;running&nbsp;squid&nbsp;for&nbsp;proxying.&nbsp;The&nbsp;machine&nbsp;running&nbsp;squid&nbsp;sees&nbsp;the&nbsp;packet&nbsp;with&nbsp;client&nbsp;to&nbsp;server&nbsp;but&nbsp;iptables&nbsp;rules&nbsp;help&nbsp;in&nbsp;delivering&nbsp;this&nbsp;packet&nbsp;up&nbsp;the&nbsp;stack.&nbsp;On&nbsp;a&nbsp;cache&nbsp;hit,&nbsp;squid&nbsp;responds&nbsp;back&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;also&nbsp;installs&nbsp;iptables&nbsp;rules&nbsp;on&nbsp;the&nbsp;fly&nbsp;and&nbsp;hence&nbsp;the&nbsp;source&nbsp;IP&nbsp;is&nbsp;that&nbsp;of&nbsp;the&nbsp;server.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;This&nbsp;is&nbsp;achieved&nbsp;through&nbsp;the&nbsp;following&nbsp;configuration&nbsp;in&nbsp;squid.conf.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;http_port&nbsp;3128&nbsp;intercept&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;With&nbsp;this&nbsp;configuration&nbsp;however,&nbsp;on&nbsp;a&nbsp;cache&nbsp;miss&nbsp;case,&nbsp;squid&nbsp;uses&nbsp;it&#39;s&nbsp;IP&nbsp;address&nbsp;as&nbsp;the&nbsp;source&nbsp;IP&nbsp;to&nbsp;connect&nbsp;to&nbsp;the&nbsp;server.&nbsp;What&nbsp;I&nbsp;expect&nbsp;is&nbsp;squid&nbsp;to&nbsp;use&nbsp;the&nbsp;client&#39;s&nbsp;IP&nbsp;address&nbsp;to&nbsp;establish&nbsp;this&nbsp;new&nbsp;connection&nbsp;to&nbsp;the&nbsp;server.&nbsp;From&nbsp;the&nbsp;squid.conf,&nbsp;I&nbsp;believe&nbsp;I&nbsp;need&nbsp;to&nbsp;use&nbsp;the&nbsp;tproxy&nbsp;mode&nbsp;with&nbsp;the&nbsp;http_port&nbsp;directive,&nbsp;but&nbsp;I&#39;m&nbsp;stumped&nbsp;about&nbsp;what&nbsp;iptables&nbsp;rules&nbsp;to&nbsp;configure.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;follow&nbsp;the&nbsp;steps&nbsp;here&nbsp;(&lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/Features/Tproxy4#Feature:_TPROXY_version_4.1.2B-_Support&lt;/a&gt;)&nbsp;but&nbsp;no&nbsp;luck&nbsp;yet.&nbsp;And&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;why&nbsp;I&#39;d&nbsp;need&nbsp;to&nbsp;use&nbsp;WCCP&nbsp;for&nbsp;something&nbsp;like&nbsp;this.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;I&nbsp;expect&nbsp;squid&nbsp;to&nbsp;use&nbsp;the&nbsp;client&#39;s&nbsp;IP&nbsp;address&nbsp;and&nbsp;the&nbsp;reverse&nbsp;traffic&nbsp;from&nbsp;the&nbsp;server&nbsp;will&nbsp;make&nbsp;it&#39;s&nbsp;way&nbsp;to&nbsp;squid&#39;s&nbsp;box&nbsp;through&nbsp;openvswitch.&nbsp;All&nbsp;squid&nbsp;has&nbsp;to&nbsp;do&nbsp;is&nbsp;install&nbsp;an&nbsp;iptable&nbsp;rule&nbsp;on&nbsp;the&nbsp;fly&nbsp;for&nbsp;the&nbsp;outgoing&nbsp;connection&nbsp;to&nbsp;use&nbsp;the&nbsp;client&#39;s&nbsp;IP&nbsp;address&nbsp;and&nbsp;also&nbsp;have&nbsp;a&nbsp;corresponding&nbsp;reverse&nbsp;rule&nbsp;to&nbsp;translate&nbsp;from&nbsp;the&nbsp;client&#39;s&nbsp;IP&nbsp;address&nbsp;to&nbsp;squid&#39;s&nbsp;IP&nbsp;address.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;The&nbsp;kernel&nbsp;that&nbsp;I&#39;m&nbsp;using&nbsp;is&nbsp;3.16&nbsp;and&nbsp;it&nbsp;has&nbsp;the&nbsp;nf_conntrack&nbsp;and&nbsp;xt_TPROXY&nbsp;modules&nbsp;insmoded.&nbsp;Can&nbsp;someone&nbsp;help&nbsp;me&nbsp;with&nbsp;this?&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Thanks,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Srinath&lt;/div&gt;&lt;/div&gt;<br>

</tt>
