<tt>
<br>
&lt;div&gt;This&nbsp;was&nbsp;pretty&nbsp;interesting&nbsp;and&nbsp;informative&nbsp;‚Äîdespite&nbsp;the&nbsp;egregious&nbsp;typos&nbsp;üòÅ&nbsp;‚Äî&nbsp;thanks&nbsp;Amos!&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;mailbox_signature&quot;&gt;<br>
&lt;br&gt;¬†&lt;/div&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;p&gt;On&nbsp;Sat,&nbsp;Apr&nbsp;25,&nbsp;2015&nbsp;at&nbsp;12:25&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;/p&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&lt;p&gt;On&nbsp;25/04/2015&nbsp;12:50&nbsp;a.m.,&nbsp;James&nbsp;Lay&nbsp;wrote:&lt;br&gt;&gt;&nbsp;Hey&nbsp;all.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Topic&nbsp;says&nbsp;it....I'm&nbsp;running&nbsp;squid-3.5.3-20150420-r13802&nbsp;and&nbsp;wanted&nbsp;to&lt;br&gt;&gt;&nbsp;see&nbsp;if&nbsp;there's&nbsp;anything&nbsp;glaring&nbsp;that&nbsp;I'm&nbsp;missing/have&nbsp;misconfigured.&nbsp;&nbsp;My&lt;br&gt;&gt;&nbsp;setup&nbsp;is&nbsp;squid&nbsp;is&nbsp;running&nbsp;on&nbsp;a&nbsp;router,&nbsp;one&nbsp;nic&nbsp;external,&nbsp;one&nbsp;nic&lt;br&gt;&gt;&nbsp;internal.&nbsp;&nbsp;This&nbsp;is&nbsp;running&nbsp;as&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;with&nbsp;iptables&nbsp;doing&nbsp;a&lt;br&gt;&gt;&nbsp;redirect&nbsp;to&nbsp;ports&nbsp;3128&nbsp;and&nbsp;3129.&nbsp;&nbsp;Config&nbsp;below:&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;#############################################################&lt;br&gt;&gt;&nbsp;acl&nbsp;localnet&nbsp;src&nbsp;192.168.1.0/24&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;&gt;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http&lt;br&gt;&gt;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;https&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;&gt;&nbsp;acl&nbsp;broken_sites&nbsp;dst&nbsp;96.16.0.0/15&lt;br&gt;&gt;&nbsp;&lt;others&nbsp;redacted&gt;&lt;br&gt;&gt;&nbsp;acl&nbsp;broken_sites&nbsp;dst&nbsp;54.160.0.0/12&lt;br&gt;&gt;&nbsp;acl&nbsp;allowed_sites&nbsp;url_regex&nbsp;&quot;/opt/etc/squid/url.txt&quot;&lt;br&gt;&gt;&nbsp;acl&nbsp;all_others&nbsp;dst&nbsp;all&lt;br&gt;&lt;br&gt;Using&nbsp;&quot;dst&nbsp;all&quot;&nbsp;is&nbsp;very&nbsp;inefficient.&nbsp;It&nbsp;requires&nbsp;Squid&nbsp;to&nbsp;perform&nbsp;DNS&lt;br&gt;lookups&nbsp;just&nbsp;to&nbsp;answer&nbsp;&quot;yes&quot;.&nbsp;Unless&nbsp;there&nbsp;is&nbsp;some&nbsp;unusual&nbsp;reason&lt;br&gt;requiring&nbsp;that&nbsp;you&nbsp;might&nbsp;as&nbsp;well&nbsp;use&nbsp;the&nbsp;provided&nbsp;&quot;all&quot;&nbsp;ACL&nbsp;for&nbsp;faster&lt;br&gt;operation.&lt;br&gt;&lt;br&gt;&lt;br&gt;&gt;&nbsp;acl&nbsp;SSL&nbsp;method&nbsp;CONNECT&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;a&nbsp;bit&nbsp;dangerous.&nbsp;CONNECT&nbsp;does&nbsp;not&nbsp;necessarily&nbsp;mean&nbsp;SSL&nbsp;-&nbsp;even&lt;br&gt;with&nbsp;the&nbsp;port&nbsp;443&nbsp;restriction.&nbsp;&nbsp;CONNECT&nbsp;could&nbsp;as&nbsp;easily&nbsp;contain&nbsp;a&nbsp;tunnel&lt;br&gt;to&nbsp;email&nbsp;server&nbsp;and&nbsp;be&nbsp;pumping&nbsp;spam,&nbsp;or&nbsp;literally&nbsp;any&nbsp;other&nbsp;type&nbsp;of&lt;br&gt;traffic&nbsp;to&nbsp;any&nbsp;other&nbsp;server.&nbsp;Spam&nbsp;emails,&nbsp;FTP,&nbsp;BitTorrent,&nbsp;and&nbsp;Skype&nbsp;are&lt;br&gt;pretty&nbsp;popular&nbsp;protocols&nbsp;seen&nbsp;with&nbsp;CONNECT.&lt;br&gt;&lt;br&gt;So&nbsp;you&nbsp;can&nbsp;easily&nbsp;mistake&nbsp;security&nbsp;rules&nbsp;about&nbsp;SSL&nbsp;and&nbsp;create&nbsp;allow&lt;br&gt;policies&nbsp;that&nbsp;make&nbsp;you&nbsp;vulnerable&nbsp;to&nbsp;some&nbsp;nasty&nbsp;attacks.&lt;br&gt;&lt;br&gt;Its&nbsp;also&nbsp;a&nbsp;redundant&nbsp;ACL&nbsp;definition&nbsp;with&nbsp;the&nbsp;default&nbsp;CONNECT&nbsp;ACL&nbsp;earlier.&lt;br&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;manager&nbsp;localhost&lt;br&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;manager&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;allowed_sites&lt;br&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;broken_sites&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;all_others&nbsp;&lt;br&gt;&lt;br&gt;The&nbsp;above&nbsp;being&nbsp;equivalent&nbsp;to&nbsp;&quot;deny&nbsp;all&quot;&nbsp;makes&nbsp;the&nbsp;below&nbsp;rules&nbsp;not&nbsp;do&lt;br&gt;anything.&nbsp;I&nbsp;dont&nbsp;know&nbsp;yoru&nbsp;policy,&nbsp;maybe&nbsp;you&nbsp;did.&lt;br&gt;&lt;br&gt;Consider&nbsp;whether&nbsp;that&nbsp;is&nbsp;what&nbsp;you&nbsp;expected/wanted&nbsp;to&nbsp;happen.&lt;br&gt;&lt;br&gt;&lt;br&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;&gt;&nbsp;icp_access&nbsp;deny&nbsp;all&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;sslproxy_cert_error&nbsp;allow&nbsp;broken_sites&lt;br&gt;&gt;&nbsp;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;sslproxy_options&nbsp;ALL&lt;br&gt;&gt;&nbsp;acl&nbsp;p3129&nbsp;myportname&nbsp;3129&lt;br&gt;&lt;br&gt;This&nbsp;name&nbsp;&quot;3129&quot;&nbsp;does&nbsp;not&nbsp;match&nbsp;any&nbsp;listening&nbsp;port&nbsp;name.&nbsp;See&nbsp;below...&lt;br&gt;&lt;br&gt;&lt;br&gt;&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;&gt;&nbsp;#ssl_bump&nbsp;splice&nbsp;broken_sites&lt;br&gt;&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;p3129&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;http_port&nbsp;192.168.1.253:3128&nbsp;intercept&nbsp;&lt;br&gt;&lt;br&gt;...&nbsp;in&nbsp;the&nbsp;absence&nbsp;of&nbsp;a&nbsp;name=&nbsp;parameter&nbsp;the&nbsp;default&nbsp;name&nbsp;for&nbsp;tis&nbsp;port&nbsp;is&lt;br&gt;&quot;192.168.1.253:3128&quot;.&lt;br&gt;&lt;br&gt;&gt;&nbsp;https_port&nbsp;192.168.1.253:3129&nbsp;intercept&nbsp;ssl-bump&lt;br&gt;&gt;&nbsp;cert=/opt/sslsplit/sslsplit.crt&nbsp;key=/opt/sslsplit/sslsplitca.key&lt;br&gt;&gt;&nbsp;cafile=/opt/sslsplit/sslsplitca.pem&nbsp;generate-host-certificates=on&lt;br&gt;&gt;&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;sslflags=NO_SESSION_REUSE&lt;br&gt;&lt;br&gt;...&nbsp;in&nbsp;the&nbsp;absence&nbsp;of&nbsp;a&nbsp;name=&nbsp;parameter&nbsp;the&nbsp;default&nbsp;name&nbsp;for&nbsp;tis&nbsp;port&nbsp;is&lt;br&gt;&quot;192.168.1.253:3129&quot;.&lt;br&gt;&lt;br&gt;Do&nbsp;you&nbsp;see&nbsp;the&nbsp;pattern?&lt;br&gt;&nbsp;set&nbsp;the&nbsp;name=&nbsp;parameter&nbsp;eplicitly&nbsp;or&nbsp;it&nbsp;becomes&nbsp;teh&nbsp;*string*&nbsp;value&nbsp;of&lt;br&gt;the&nbsp;host:port&nbsp;field.&lt;br&gt;&lt;br&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;always_direct&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;Has&nbsp;no&nbsp;use&nbsp;in&nbsp;your&nbsp;config.&lt;br&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;logformat&nbsp;common&nbsp;%&gt;a&nbsp;%[ui&nbsp;%[un&nbsp;[%tl]&nbsp;&quot;%rm&nbsp;%ru&nbsp;HTTP/%rv&quot;&nbsp;%&gt;Hs&nbsp;%&lt;st&nbsp;%Ss:%&lt;br&gt;&gt;&nbsp;Sh&nbsp;%ssl::&gt;cert_subject&lt;br&gt;&lt;br&gt;Bad:&nbsp;do&nbsp;not&nbsp;re-define&nbsp;built&nbsp;in&nbsp;format&nbsp;definitions&nbsp;please.&lt;br&gt;&lt;br&gt;Either&nbsp;use&nbsp;the&nbsp;provided&nbsp;format,&nbsp;or&nbsp;use&nbsp;a&nbsp;different&nbsp;name&nbsp;if&nbsp;you&nbsp;need&nbsp;the&lt;br&gt;custom&nbsp;one.&lt;br&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;access_log&nbsp;syslog:daemon.info&nbsp;common&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;refresh_pattern&nbsp;^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10080&lt;br&gt;&gt;&nbsp;refresh_pattern&nbsp;^gopher:&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&lt;br&gt;&gt;&nbsp;refresh_pattern&nbsp;-i&nbsp;(cgi-bin|\?)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&lt;br&gt;&gt;&nbsp;refresh_pattern&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4320&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;icp_port&nbsp;3130&lt;br&gt;&lt;br&gt;You&nbsp;are&nbsp;initializing&nbsp;ICP&nbsp;port,&nbsp;but&nbsp;also&nbsp;configured&nbsp;&quot;icp_access&nbsp;deny&nbsp;all&quot;.&lt;br&gt;&lt;br&gt;To&nbsp;disble&nbsp;ICP&nbsp;leave&nbsp;remove&nbsp;the&nbsp;icp_*&nbsp;directives&nbsp;from&nbsp;your&nbsp;config.&lt;br&gt;&lt;br&gt;To&nbsp;enable&nbsp;ICP,&nbsp;configure&nbsp;the&nbsp;icp_access&nbsp;to&nbsp;allow&nbsp;some&nbsp;sources&nbsp;to&nbsp;make&lt;br&gt;queries.&lt;br&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;coredump_dir&nbsp;/opt/var&lt;br&gt;&gt;&nbsp;#############################################################&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;My&nbsp;goal&nbsp;has&nbsp;been&nbsp;to&nbsp;at&nbsp;least&nbsp;get&nbsp;the&nbsp;domain&nbsp;logged&nbsp;on&nbsp;any&nbsp;https&nbsp;access,&lt;br&gt;&gt;&nbsp;but&nbsp;alas&nbsp;some&nbsp;sites&nbsp;show:&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Apr&nbsp;24&nbsp;06:39:32&nbsp;gateway&nbsp;(squid-1):&nbsp;192.168.1.101&nbsp;-&nbsp;-&lt;br&gt;&gt;&nbsp;[24/Apr/2015:06:39:32&nbsp;-0600]&nbsp;&quot;CONNECT&nbsp;216.58.216.162:443&nbsp;HTTP/1.1&quot;&nbsp;200&lt;br&gt;&gt;&nbsp;401&nbsp;TCP_TUNNEL:ORIGINAL_DST&nbsp;-&lt;br&gt;&gt;&nbsp;&lt;br&gt;&lt;br&gt;With&nbsp;interception&nbsp;+&nbsp;your&nbsp;custom&nbsp;rule&nbsp;using&nbsp;%ru&nbsp;you&nbsp;should&nbsp;always&nbsp;see&lt;br&gt;raw-IP:port.&nbsp;If&nbsp;you&nbsp;see&nbsp;a&nbsp;TLS&nbsp;SNI&nbsp;domain&nbsp;in&nbsp;there&nbsp;*that*&nbsp;is&nbsp;a&nbsp;bug.&nbsp;&quot;%ru&quot;&lt;br&gt;is&nbsp;explicitly&nbsp;asking&nbsp;for&nbsp;the&nbsp;client-presented&nbsp;CONNECT&nbsp;*URL*,&nbsp;not&nbsp;the&lt;br&gt;server&nbsp;details.&lt;br&gt;&lt;br&gt;&lt;br&gt;That&nbsp;&quot;TCP_TUNNEL&quot;&nbsp;will&nbsp;always&nbsp;happen&nbsp;whenever&nbsp;the&nbsp;protocol&nbsp;found&nbsp;on&nbsp;port&lt;br&gt;443&nbsp;is&nbsp;not&nbsp;HTTPS.&lt;br&gt;&lt;br&gt;Amos&lt;br&gt;_______________________________________________&lt;br&gt;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;squid-users@lists.squid-cache.org&lt;br&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;br&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;
</tt>
