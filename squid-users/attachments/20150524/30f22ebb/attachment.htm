<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;TRANSITIONAL//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&nbsp;&nbsp;&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;CHARSET=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;META&nbsp;NAME=&quot;GENERATOR&quot;&nbsp;CONTENT=&quot;GtkHTML/4.6.6&quot;&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&nbsp;TEXT=&quot;#000000&quot;&nbsp;BGCOLOR=&quot;#ffffff&quot;&gt;<br>
On&nbsp;Mon,&nbsp;2015-05-25&nbsp;at&nbsp;08:48&nbsp;+1200,&nbsp;Jason&nbsp;Haar&nbsp;wrote:<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;25/05/15&nbsp;04:25,&nbsp;James&nbsp;Lay&nbsp;wrote:&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;first&nbsp;question&nbsp;is&nbsp;about&nbsp;properly&nbsp;creating&nbsp;the&nbsp;certs.&nbsp;&nbsp;Looking&nbsp;at:&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;A&nbsp;HREF=&quot;http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&quot;&gt;http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&lt;/A&gt;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;mentions&nbsp;using&nbsp;crtd,&nbsp;but&nbsp;as&nbsp;I&nbsp;understand&nbsp;it,&nbsp;crtd&nbsp;isn't&nbsp;supported&nbsp;when&nbsp;using&nbsp;transparent&nbsp;proxies.&nbsp;&nbsp;So,&nbsp;with&nbsp;no&nbsp;crtd,&nbsp;as&nbsp;I&nbsp;understand&nbsp;it&nbsp;this&nbsp;is&nbsp;what&nbsp;I'll&nbsp;need:&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/BLOCKQUOTE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;don't&nbsp;know&nbsp;where&nbsp;you&nbsp;got&nbsp;that&nbsp;from,&nbsp;but&nbsp;that's&nbsp;not&nbsp;true.&nbsp;I&nbsp;think&nbsp;you&nbsp;are&nbsp;confusing&nbsp;the&nbsp;issue&nbsp;that&nbsp;when&nbsp;squid&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;transparent&nbsp;HTTPS&nbsp;proxy,&nbsp;it&nbsp;lacks&nbsp;the&nbsp;&quot;easy&quot;&nbsp;hostname&nbsp;details&nbsp;that&nbsp;a&nbsp;formal&nbsp;(ie&nbsp;non-transparent)&nbsp;proxy&nbsp;has.&nbsp;ie&nbsp;when&nbsp;a&nbsp;browser&nbsp;asks&nbsp;for&nbsp;a&nbsp;secure&nbsp;website&nbsp;via&nbsp;a&nbsp;formal&nbsp;proxy,&nbsp;it&nbsp;sends&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CONNECT&nbsp;github.com:443&nbsp;HTTP/1.1&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;So&nbsp;squid&nbsp;knows&nbsp;*in&nbsp;advance*&nbsp;the&nbsp;server&nbsp;is&nbsp;called&nbsp;&quot;github.com&quot;.&nbsp;So&nbsp;it&nbsp;connects&nbsp;to&nbsp;github.com,&nbsp;downloads&nbsp;the&nbsp;public&nbsp;key&nbsp;and&nbsp;then&nbsp;uses&nbsp;crtd&nbsp;to&nbsp;create&nbsp;a&nbsp;clone&nbsp;of&nbsp;it&nbsp;-&nbsp;identical&nbsp;except&nbsp;that&nbsp;it's&nbsp;signed&nbsp;by&nbsp;your&nbsp;self-created&nbsp;Squid&nbsp;CA&nbsp;instead&nbsp;of&nbsp;Verisign/whatever&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Compare&nbsp;that&nbsp;with&nbsp;transparent&nbsp;proxy&nbsp;mode,&nbsp;where&nbsp;all&nbsp;that&nbsp;squid&nbsp;knows&nbsp;is&nbsp;that&nbsp;a&nbsp;browser&nbsp;has&nbsp;had&nbsp;it's&nbsp;outbound&nbsp;tcp&nbsp;port&nbsp;443&nbsp;traffic&nbsp;to&nbsp;192.30.252.128&nbsp;redirected&nbsp;onto&nbsp;it,&nbsp;so&nbsp;it&nbsp;doesn't&nbsp;know&nbsp;that&nbsp;is&nbsp;github.com.&nbsp;If&nbsp;you&nbsp;are&nbsp;using&nbsp;squid-3.4&nbsp;or&nbsp;less,&nbsp;that's&nbsp;all&nbsp;there&nbsp;is&nbsp;to&nbsp;it&nbsp;-&nbsp;there's&nbsp;no&nbsp;way&nbsp;to&nbsp;figure&nbsp;out&nbsp;the&nbsp;cert&nbsp;name&nbsp;in&nbsp;a&nbsp;guaranteed&nbsp;fashion&nbsp;(there&nbsp;are&nbsp;hacks,&nbsp;but&nbsp;my&nbsp;own&nbsp;experience&nbsp;is&nbsp;that&nbsp;they&nbsp;can&nbsp;only&nbsp;work&nbsp;up&nbsp;to&nbsp;95%&nbsp;of&nbsp;the&nbsp;time&nbsp;-&nbsp;and&nbsp;break&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;largest&nbsp;sites).&nbsp;With&nbsp;squid-3.5&nbsp;there&nbsp;is&nbsp;&quot;peek&quot;&nbsp;-&nbsp;which&nbsp;means&nbsp;squid&nbsp;can&nbsp;let&nbsp;the&nbsp;initial&nbsp;few&nbsp;packets&nbsp;through&nbsp;(ie&nbsp;act&nbsp;like&nbsp;&quot;splice&quot;)&nbsp;-&nbsp;which&nbsp;is&nbsp;enough&nbsp;to&nbsp;see&nbsp;the&nbsp;client&nbsp;send&nbsp;the&nbsp;SNI&nbsp;request&nbsp;to&nbsp;the&nbsp;https&nbsp;server&nbsp;and&nbsp;get&nbsp;the&nbsp;reply.&nbsp;So&nbsp;&quot;peek&quot;&nbsp;allows&nbsp;squid&nbsp;to&nbsp;learn&nbsp;about&nbsp;the&nbsp;true&nbsp;server&nbsp;name&nbsp;of&nbsp;the&nbsp;https&nbsp;server.&nbsp;At&nbsp;that&nbsp;point&nbsp;*I&nbsp;think*&nbsp;squid&nbsp;creates&nbsp;a&nbsp;forged&nbsp;cert,&nbsp;then&nbsp;creates&nbsp;a&nbsp;new&nbsp;connection&nbsp;to&nbsp;the&nbsp;server,&nbsp;then&nbsp;links&nbsp;together&nbsp;the&nbsp;existing&nbsp;client&nbsp;tcp&nbsp;channel&nbsp;with&nbsp;the&nbsp;new&nbsp;proxy-&gt;server&nbsp;tcp&nbsp;channel&nbsp;and&nbsp;carries&nbsp;on&nbsp;intercepting&nbsp;(I&nbsp;think&nbsp;that's&nbsp;the&nbsp;outcome&nbsp;-&nbsp;there&nbsp;would&nbsp;have&nbsp;to&nbsp;be&nbsp;some&nbsp;extra&nbsp;smoke-n-mirrors&nbsp;in&nbsp;there&nbsp;to&nbsp;make&nbsp;that&nbsp;happen)&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;pseudo-code,&nbsp;it&nbsp;looks&nbsp;like&nbsp;this&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;http_port&nbsp;and&nbsp;&quot;CONNECT&nbsp;(.*)&nbsp;HTTP&quot;&nbsp;then&nbsp;sni_name=$1&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;https_port&nbsp;and&nbsp;&quot;peek&quot;&nbsp;then&nbsp;sni_name=find_sni($ipaddress)&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;https_port&nbsp;then&nbsp;sni_name=$ipaddress&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;all&nbsp;is&nbsp;said&nbsp;and&nbsp;done,&nbsp;transparent&nbsp;HTTPS&nbsp;intercept&nbsp;is&nbsp;the&nbsp;very&nbsp;last&nbsp;thing&nbsp;you&nbsp;should&nbsp;be&nbsp;working&nbsp;on.&nbsp;You&nbsp;need&nbsp;to&nbsp;gets&nbsp;squid&nbsp;working&nbsp;100%&nbsp;as&nbsp;a&nbsp;formal&nbsp;proxy&nbsp;-&nbsp;and&nbsp;only&nbsp;then&nbsp;start&nbsp;looking&nbsp;at&nbsp;making&nbsp;that&nbsp;work&nbsp;in&nbsp;transparent&nbsp;mode.&nbsp;And&nbsp;you&nbsp;*definitely*&nbsp;want&nbsp;ssl_crtd.&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;PRE&gt;<br>
--&nbsp;<br>
Cheers<br>
<br>
Jason&nbsp;Haar<br>
Corporate&nbsp;Information&nbsp;Security&nbsp;Manager,&nbsp;Trimble&nbsp;Navigation&nbsp;Ltd.<br>
Phone:&nbsp;+1&nbsp;408&nbsp;481&nbsp;8171<br>
PGP&nbsp;Fingerprint:&nbsp;7A2E&nbsp;0407&nbsp;C9A6&nbsp;CAF6&nbsp;2B9F&nbsp;8422&nbsp;C063&nbsp;5EBB&nbsp;FE1D&nbsp;66D1<br>
_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
&lt;A&nbsp;HREF=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/A&gt;<br>
&lt;A&nbsp;HREF=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/A&gt;<br>
&lt;/PRE&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BR&gt;<br>
Thanks&nbsp;for&nbsp;the&nbsp;great&nbsp;response&nbsp;Jason...I&nbsp;appreciate&nbsp;it.&nbsp;&nbsp;I&nbsp;think&nbsp;maybe&nbsp;I&nbsp;misread&nbsp;this:&lt;BR&gt;<br>
&lt;BR&gt;<br>
&lt;A&nbsp;HREF=&quot;http://wiki.squid-cache.org/Features/DynamicSslCert&quot;&gt;http://wiki.squid-cache.org/Features/DynamicSslCert&lt;/A&gt;&lt;BR&gt;<br>
&lt;BR&gt;<br>
&quot;While&nbsp;&lt;A&nbsp;HREF=&quot;http://wiki.squid-cache.org/Features/SslBump&quot;&gt;SslBump&lt;/A&gt;&nbsp;itself&nbsp;works&nbsp;fine&nbsp;in&nbsp;transparent&nbsp;redirection&nbsp;environments&nbsp;(e.g.&nbsp;those&nbsp;using&nbsp;WCCP&nbsp;or&nbsp;iptables),&nbsp;dynamic&nbsp;certificate&nbsp;generation&nbsp;does&nbsp;not:&nbsp;To&nbsp;generate&nbsp;the&nbsp;certificate&nbsp;dynamically,&nbsp;Squid&nbsp;must&nbsp;know&nbsp;the&nbsp;server&nbsp;domain&nbsp;name.&nbsp;That&nbsp;information&nbsp;is&nbsp;not&nbsp;available&nbsp;at&nbsp;the&nbsp;time&nbsp;the&nbsp;HTTPS&nbsp;client&nbsp;TCP&nbsp;connection&nbsp;is&nbsp;intercepted&nbsp;and&nbsp;bumped.&nbsp;Currently,&nbsp;you&nbsp;cannot&nbsp;use&nbsp;dynamic&nbsp;certificate&nbsp;generation&nbsp;for&nbsp;transparent&nbsp;connections&nbsp;until&nbsp;&lt;A&nbsp;HREF=&quot;http://wiki.squid-cache.org/Features/BumpSslServerFirst&quot;&gt;bump-server-first&lt;/A&gt;&nbsp;is&nbsp;supported.&quot;&lt;BR&gt;<br>
&lt;BR&gt;<br>
Is&nbsp;this&nbsp;no&nbsp;longer&nbsp;accurate&nbsp;with&nbsp;now&nbsp;that&nbsp;peek/splice&nbsp;has&nbsp;been&nbsp;implemented?&lt;BR&gt;<br>
&lt;BR&gt;<br>
Thank&nbsp;you.&lt;BR&gt;<br>
&lt;BR&gt;<br>
James<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;<br>

</tt>
