<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;On&nbsp;25/05/15&nbsp;04:25,&nbsp;James&nbsp;Lay&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid:1432484742.3702.17.camel@JamesiMac&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;name=&quot;GENERATOR&quot;&nbsp;content=&quot;GtkHTML/4.6.6&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;first&nbsp;question&nbsp;is&nbsp;about&nbsp;properly&nbsp;creating&nbsp;the&nbsp;certs. &nbsp;Looking<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;moz-do-not-send=&quot;true&quot;<br>
href=&quot;http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&quot;&gt;http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&lt;/a&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;mentions&nbsp;using&nbsp;crtd,&nbsp;but&nbsp;as&nbsp;I&nbsp;understand&nbsp;it,&nbsp;crtd&nbsp;isn't<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;supported&nbsp;when&nbsp;using&nbsp;transparent&nbsp;proxies. &nbsp;So,&nbsp;with&nbsp;no&nbsp;crtd,&nbsp;as&nbsp;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;understand&nbsp;it&nbsp;this&nbsp;is&nbsp;what&nbsp;I'll&nbsp;need:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;don't&nbsp;know&nbsp;where&nbsp;you&nbsp;got&nbsp;that&nbsp;from,&nbsp;but&nbsp;that's&nbsp;not&nbsp;true.&nbsp;I&nbsp;think<br>
&nbsp;&nbsp;&nbsp;&nbsp;you&nbsp;are&nbsp;confusing&nbsp;the&nbsp;issue&nbsp;that&nbsp;when&nbsp;squid&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;transparent<br>
&nbsp;&nbsp;&nbsp;&nbsp;HTTPS&nbsp;proxy,&nbsp;it&nbsp;lacks&nbsp;the&nbsp;&quot;easy&quot;&nbsp;hostname&nbsp;details&nbsp;that&nbsp;a&nbsp;formal&nbsp;(ie<br>
&nbsp;&nbsp;&nbsp;&nbsp;non-transparent)&nbsp;proxy&nbsp;has.&nbsp;ie&nbsp;when&nbsp;a&nbsp;browser&nbsp;asks&nbsp;for&nbsp;a&nbsp;secure<br>
&nbsp;&nbsp;&nbsp;&nbsp;website&nbsp;via&nbsp;a&nbsp;formal&nbsp;proxy,&nbsp;it&nbsp;sends&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CONNECT&nbsp;github.com:443&nbsp;HTTP/1.1&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;So&nbsp;squid&nbsp;knows&nbsp;*in&nbsp;advance*&nbsp;the&nbsp;server&nbsp;is&nbsp;called&nbsp;&quot;github.com&quot;.&nbsp;So&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;connects&nbsp;to&nbsp;github.com,&nbsp;downloads&nbsp;the&nbsp;public&nbsp;key&nbsp;and&nbsp;then&nbsp;uses&nbsp;crtd<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;create&nbsp;a&nbsp;clone&nbsp;of&nbsp;it&nbsp;-&nbsp;identical&nbsp;except&nbsp;that&nbsp;it's&nbsp;signed&nbsp;by&nbsp;your<br>
&nbsp;&nbsp;&nbsp;&nbsp;self-created&nbsp;Squid&nbsp;CA&nbsp;instead&nbsp;of&nbsp;Verisign/whatever&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Compare&nbsp;that&nbsp;with&nbsp;transparent&nbsp;proxy&nbsp;mode,&nbsp;where&nbsp;all&nbsp;that&nbsp;squid&nbsp;knows<br>
&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;that&nbsp;a&nbsp;browser&nbsp;has&nbsp;had&nbsp;it's&nbsp;outbound&nbsp;tcp&nbsp;port&nbsp;443&nbsp;traffic&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;192.30.252.128&nbsp;redirected&nbsp;onto&nbsp;it,&nbsp;so&nbsp;it&nbsp;doesn't&nbsp;know&nbsp;that&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;github.com.&nbsp;If&nbsp;you&nbsp;are&nbsp;using&nbsp;squid-3.4&nbsp;or&nbsp;less,&nbsp;that's&nbsp;all&nbsp;there&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;it&nbsp;-&nbsp;there's&nbsp;no&nbsp;way&nbsp;to&nbsp;figure&nbsp;out&nbsp;the&nbsp;cert&nbsp;name&nbsp;in&nbsp;a&nbsp;guaranteed<br>
&nbsp;&nbsp;&nbsp;&nbsp;fashion&nbsp;(there&nbsp;are&nbsp;hacks,&nbsp;but&nbsp;my&nbsp;own&nbsp;experience&nbsp;is&nbsp;that&nbsp;they&nbsp;can<br>
&nbsp;&nbsp;&nbsp;&nbsp;only&nbsp;work&nbsp;up&nbsp;to&nbsp;95%&nbsp;of&nbsp;the&nbsp;time&nbsp;-&nbsp;and&nbsp;break&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;largest<br>
&nbsp;&nbsp;&nbsp;&nbsp;sites).&nbsp;With&nbsp;squid-3.5&nbsp;there&nbsp;is&nbsp;&quot;peek&quot;&nbsp;-&nbsp;which&nbsp;means&nbsp;squid&nbsp;can&nbsp;let<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;initial&nbsp;few&nbsp;packets&nbsp;through&nbsp;(ie&nbsp;act&nbsp;like&nbsp;&quot;splice&quot;)&nbsp;-&nbsp;which&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;enough&nbsp;to&nbsp;see&nbsp;the&nbsp;client&nbsp;send&nbsp;the&nbsp;SNI&nbsp;request&nbsp;to&nbsp;the&nbsp;https&nbsp;server<br>
&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;get&nbsp;the&nbsp;reply.&nbsp;So&nbsp;&quot;peek&quot;&nbsp;allows&nbsp;squid&nbsp;to&nbsp;learn&nbsp;about&nbsp;the&nbsp;true<br>
&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;name&nbsp;of&nbsp;the&nbsp;https&nbsp;server.&nbsp;At&nbsp;that&nbsp;point&nbsp;*I&nbsp;think*&nbsp;squid<br>
&nbsp;&nbsp;&nbsp;&nbsp;creates&nbsp;a&nbsp;forged&nbsp;cert,&nbsp;then&nbsp;creates&nbsp;a&nbsp;new&nbsp;connection&nbsp;to&nbsp;the&nbsp;server,<br>
&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;links&nbsp;together&nbsp;the&nbsp;existing&nbsp;client&nbsp;tcp&nbsp;channel&nbsp;with&nbsp;the&nbsp;new<br>
&nbsp;&nbsp;&nbsp;&nbsp;proxy-&gt;server&nbsp;tcp&nbsp;channel&nbsp;and&nbsp;carries&nbsp;on&nbsp;intercepting&nbsp;(I&nbsp;think<br>
&nbsp;&nbsp;&nbsp;&nbsp;that's&nbsp;the&nbsp;outcome&nbsp;-&nbsp;there&nbsp;would&nbsp;have&nbsp;to&nbsp;be&nbsp;some&nbsp;extra<br>
&nbsp;&nbsp;&nbsp;&nbsp;smoke-n-mirrors&nbsp;in&nbsp;there&nbsp;to&nbsp;make&nbsp;that&nbsp;happen)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;pseudo-code,&nbsp;it&nbsp;looks&nbsp;like&nbsp;this&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;http_port&nbsp;and&nbsp;&quot;CONNECT&nbsp;(.*)&nbsp;HTTP&quot;&nbsp;then&nbsp;sni_name=$1&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;https_port&nbsp;and&nbsp;&quot;peek&quot;&nbsp;then&nbsp;sni_name=find_sni($ipaddress)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;https_port&nbsp;then&nbsp;sni_name=$ipaddress&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;all&nbsp;is&nbsp;said&nbsp;and&nbsp;done,&nbsp;transparent&nbsp;HTTPS&nbsp;intercept&nbsp;is&nbsp;the&nbsp;very<br>
&nbsp;&nbsp;&nbsp;&nbsp;last&nbsp;thing&nbsp;you&nbsp;should&nbsp;be&nbsp;working&nbsp;on.&nbsp;You&nbsp;need&nbsp;to&nbsp;gets&nbsp;squid&nbsp;working<br>
&nbsp;&nbsp;&nbsp;&nbsp;100%&nbsp;as&nbsp;a&nbsp;formal&nbsp;proxy&nbsp;-&nbsp;and&nbsp;only&nbsp;then&nbsp;start&nbsp;looking&nbsp;at&nbsp;making&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;work&nbsp;in&nbsp;transparent&nbsp;mode.&nbsp;And&nbsp;you&nbsp;*definitely*&nbsp;want&nbsp;ssl_crtd.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;class=&quot;moz-signature&quot;&nbsp;cols=&quot;72&quot;&gt;--&nbsp;<br>
Cheers<br>
<br>
Jason&nbsp;Haar<br>
Corporate&nbsp;Information&nbsp;Security&nbsp;Manager,&nbsp;Trimble&nbsp;Navigation&nbsp;Ltd.<br>
Phone:&nbsp;+1&nbsp;408&nbsp;481&nbsp;8171<br>
PGP&nbsp;Fingerprint:&nbsp;7A2E&nbsp;0407&nbsp;C9A6&nbsp;CAF6&nbsp;2B9F&nbsp;8422&nbsp;C063&nbsp;5EBB&nbsp;FE1D&nbsp;66D1<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
