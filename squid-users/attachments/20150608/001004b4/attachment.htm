<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;On&nbsp;06/08/2015&nbsp;04:23&nbsp;PM,&nbsp;Rafael&nbsp;Akchurin<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:DB5PR04MB1128EB4550FB52189F4C523C8FBF0@DB5PR04MB1128.eurprd04.prod.outlook.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Hello&nbsp;all,<br>
<br>
What&nbsp;is&nbsp;the&nbsp;recommended&nbsp;approach&nbsp;to&nbsp;perform&nbsp;load&nbsp;balancing&nbsp;and&nbsp;high&nbsp;availability&nbsp;between&nbsp;N&nbsp;squid&nbsp;servers?&nbsp;<br>
I&nbsp;have&nbsp;the&nbsp;following&nbsp;list&nbsp;of&nbsp;requirements&nbsp;to&nbsp;fullfil:<br>
<br>
1)&nbsp;Manage&nbsp;N&nbsp;squid&nbsp;servers&nbsp;that&nbsp;share&nbsp;cache&nbsp;(as&nbsp;far&nbsp;as&nbsp;i&nbsp;understand&nbsp;is&nbsp;done&nbsp;using&nbsp;cache_peer).&nbsp;Desirable.<br>
2)&nbsp;Availability:&nbsp;if&nbsp;any&nbsp;of&nbsp;the&nbsp;N&nbsp;servers&nbsp;fails&nbsp;the&nbsp;clients&nbsp;are&nbsp;redirected&nbsp;to&nbsp;the&nbsp;rest&nbsp;N-1.&nbsp;Prefferable.<br>
3)&nbsp;Scalability:&nbsp;The&nbsp;load&nbsp;is&nbsp;distributed&nbsp;(round-roubin&nbsp;or&nbsp;some&nbsp;other&nbsp;algorithm)&nbsp;between&nbsp;N&nbsp;servers,&nbsp;if&nbsp;a&nbsp;new&nbsp;server&nbsp;is&nbsp;added&nbsp;(N&nbsp;+&nbsp;1)&nbsp;new&nbsp;clients&nbsp;will&nbsp;be&nbsp;able&nbsp;to&nbsp;use&nbsp;it&nbsp;reducing&nbsp;the&nbsp;load&nbsp;on&nbsp;the&nbsp;rest&nbsp;N.&nbsp;Prefferable.<br>
4)&nbsp;I&nbsp;need&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;identify&nbsp;client&nbsp;IP&nbsp;addresses&nbsp;on&nbsp;the&nbsp;squid&nbsp;side&nbsp;and/or&nbsp;perform&nbsp;Squid&nbsp;authentication.&nbsp;The&nbsp;client&nbsp;IP&nbsp;and&nbsp;User&nbsp;Name&nbsp;are&nbsp;later&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;to&nbsp;scan&nbsp;the&nbsp;HTTP(S)&nbsp;request/response&nbsp;contents&nbsp;using&nbsp;icap_send_client_ip&nbsp;and&nbsp;icap_send_client_username.&nbsp;Very&nbsp;important&nbsp;requirement.<br>
5)&nbsp;I&nbsp;need&nbsp;to&nbsp;support&nbsp;both&nbsp;HTTP&nbsp;and&nbsp;HTTPS&nbsp;connections&nbsp;with&nbsp;support&nbsp;of&nbsp;selective&nbsp;SSL&nbsp;Bump.&nbsp;I.e.&nbsp;for&nbsp;some&nbsp;web&nbsp;sites&nbsp;I&nbsp;do&nbsp;not&nbsp;want&nbsp;to&nbsp;look&nbsp;inside&nbsp;SSL&nbsp;so&nbsp;that&nbsp;original&nbsp;site's&nbsp;certificates are&nbsp;used&nbsp;for&nbsp;encryption.&nbsp;Very&nbsp;important&nbsp;requirement&nbsp;too.<br>
<br>
I&nbsp;know&nbsp;that&nbsp;strictly&nbsp;for&nbsp;HTTP&nbsp;I&nbsp;could&nbsp;use&nbsp;HAProxy&nbsp;with&nbsp;Forward-For&nbsp;or&nbsp;something&nbsp;similar,&nbsp;but&nbsp;the&nbsp;5th&nbsp;requirement&nbsp;is&nbsp;very&nbsp;important&nbsp;and&nbsp;I&nbsp;could&nbsp;not&nbsp;find&nbsp;a&nbsp;way&nbsp;to&nbsp;handle&nbsp;SSL&nbsp;with&nbsp;HAProxy&nbsp;properly.<br>
<br>
The&nbsp;only&nbsp;idea&nbsp;that&nbsp;comes&nbsp;to&nbsp;my&nbsp;mind&nbsp;is to&nbsp;use&nbsp;some&nbsp;form&nbsp;of&nbsp;round-robin&nbsp;load&nbsp;balancing&nbsp;on&nbsp;the&nbsp;level&nbsp;of&nbsp;DNS,&nbsp;but&nbsp;it&nbsp;has&nbsp;its&nbsp;own&nbsp;drawbacks&nbsp;(should&nbsp;be&nbsp;able&nbsp;to&nbsp;check&nbsp;availability&nbsp;of&nbsp;my&nbsp;N&nbsp;servers&nbsp;+&nbsp;not&nbsp;real&nbsp;balancing,&nbsp;more&nbsp;like&nbsp;distribution).<br>
Any&nbsp;help/thoughts&nbsp;are&nbsp;appreciated.<br>
<br>
Thank&nbsp;you!<br>
<br>
Best&nbsp;regards,<br>
Rafael&nbsp;Akchurin<br>
Diladele&nbsp;B.V.<br>
<br>
_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;-&nbsp;you&nbsp;are&nbsp;likely&nbsp;going&nbsp;to&nbsp;want&nbsp;to&nbsp;create&nbsp;a&nbsp;config&nbsp;for&nbsp;peers:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;peers&nbsp;src&nbsp;192.168.1.1/32&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;peers&nbsp;src&nbsp;192.168.1.2/32&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;peers&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cache_peer&nbsp;192.168.1.1&nbsp;sibling&nbsp;3128&nbsp;4827&nbsp;htcp=no-clr&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cache_peer&nbsp;192.168.1.2&nbsp;sibling&nbsp;3128&nbsp;4827&nbsp;htcp=no-clr&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;remember&nbsp;to&nbsp;make&nbsp;sure&nbsp;all&nbsp;peers&nbsp;are&nbsp;properly&nbsp;represented&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;-&nbsp;use&nbsp;a&nbsp;load&nbsp;balancing&nbsp;device&nbsp;or&nbsp;software,&nbsp;and&nbsp;this&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;part-and-parcel&nbsp;to&nbsp;that&nbsp;functionality&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;-&nbsp;load&nbsp;balancers&nbsp;give&nbsp;you&nbsp;several&nbsp;options. &nbsp;i&nbsp;use&nbsp;&quot;least<br>
&nbsp;&nbsp;&nbsp;&nbsp;connections&quot;&nbsp;which&nbsp;is&nbsp;a&nbsp;bit&nbsp;more&nbsp;intelligent&nbsp;that&nbsp;straight<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;-&nbsp;depending&nbsp;on&nbsp;how&nbsp;you&nbsp;setup&nbsp;your&nbsp;load&nbsp;balancer,&nbsp;you&nbsp;might&nbsp;be&nbsp;able<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;get&nbsp;the&nbsp;client&nbsp;IP&nbsp;without&nbsp;playing&nbsp;games. &nbsp;if&nbsp;you&nbsp;cant&nbsp;see&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;IP&nbsp;as&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;connection,&nbsp;you&nbsp;will&nbsp;have&nbsp;to&nbsp;work<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;&quot;X-Forwarded-For&quot;&nbsp;header,&nbsp;like&nbsp;so:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;follow_x_forwarded_for&nbsp;allow&nbsp;svc_chk&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;follow_x_forwarded_for&nbsp;deny&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;b&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/b&gt;acl_uses_indirect_client&nbsp;on&lt;b&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/b&gt;...&lt;b&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/b&gt;log_uses_indirect_client&nbsp;on&lt;b&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/b&gt;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Also,&nbsp;your&nbsp;auth&nbsp;methods&nbsp;may&nbsp;have&nbsp;nuances&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;accounted<br>
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(Kerberos&nbsp;and&nbsp;load&nbsp;balancing&nbsp;requires&nbsp;some&nbsp;extra&nbsp;steps).&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp; 5&nbsp;-&nbsp;HAProxy&nbsp;will&nbsp;work&nbsp;for&nbsp;HTTP&nbsp;and&nbsp;HTTPS. &nbsp;remember,&nbsp;your&nbsp;clients<br>
&nbsp;&nbsp;&nbsp;&nbsp;arent&nbsp;talking&nbsp;to&nbsp;HAProxy&nbsp;for&nbsp;HTTP&nbsp;proxying. &nbsp;the&nbsp;port&nbsp;you&nbsp;load<br>
&nbsp;&nbsp;&nbsp;&nbsp;balance&nbsp;on&nbsp;with&nbsp;HAProxy&nbsp;is&nbsp;not&nbsp;the&nbsp;HTTP&nbsp;proxy&nbsp;process. &nbsp;All&nbsp;HAProxy<br>
&nbsp;&nbsp;&nbsp;&nbsp;has&nbsp;to&nbsp;do&nbsp;is&nbsp;hand&nbsp;the&nbsp;connection&nbsp;off&nbsp;to&nbsp;Squid&nbsp;which&nbsp;will&nbsp;handle&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;or&nbsp;HTTPS-with-SSL-Bump,&nbsp;independent&nbsp;of&nbsp;anything<br>
&nbsp;&nbsp;&nbsp;&nbsp;HAProxy&nbsp;sees&nbsp;or&nbsp;cares&nbsp;about.&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
