<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello&nbsp;all.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;tried&nbsp;reading&nbsp;all&nbsp;the&nbsp;FAQ&#39;s&nbsp;and&nbsp;scoured&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;internet&nbsp;for&nbsp;any&nbsp;configuration&nbsp;examples&nbsp;I&nbsp;can&nbsp;find&nbsp;and&nbsp;I&nbsp;have&nbsp;not&nbsp;seen&nbsp;a&nbsp;working&nbsp;solution&nbsp;for&nbsp;this.&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;been&nbsp;using&nbsp;squid&nbsp;for&nbsp;a&nbsp;couple&nbsp;of&nbsp;years&nbsp;now&nbsp;to&nbsp;bump&nbsp;SSL&nbsp;traffic&nbsp;with&nbsp;no&nbsp;issues.&lt;/div&gt;&lt;div&gt;However&nbsp;I&nbsp;have&nbsp;a&nbsp;new&nbsp;environment&nbsp;where&nbsp;an&nbsp;upstream&nbsp;proxy&nbsp;is&nbsp;already&nbsp;in&nbsp;place&nbsp;and&nbsp;MUST&nbsp;be&nbsp;used.&lt;/div&gt;&lt;div&gt;So&nbsp;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;get&nbsp;squid&nbsp;working&nbsp;with&nbsp;SSL&nbsp;bump&nbsp;where&nbsp;I&nbsp;have&nbsp;to&nbsp;use&nbsp;a&nbsp;cache_peer.&lt;/div&gt;&lt;div&gt;So&nbsp;here&#39;s&nbsp;the&nbsp;environment.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Normal&nbsp;network&nbsp;setup:&lt;/div&gt;&lt;div&gt;Client&nbsp;--&gt;&nbsp;Forefront&nbsp;Threat&nbsp;Manager&nbsp;Gateway/Proxy&nbsp;(TMG)&nbsp;--&gt;&nbsp;Internet&lt;/div&gt;&lt;div&gt;Client&nbsp;is&nbsp;setup&nbsp;to&nbsp;use&nbsp;TMG:8080&nbsp;to&nbsp;get&nbsp;to&nbsp;internet&nbsp;for&nbsp;all&nbsp;protocols.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s&nbsp;my&nbsp;new&nbsp;network&nbsp;chain&nbsp;with&nbsp;squid&nbsp;inserted:&lt;/div&gt;&lt;div&gt;Moving&nbsp;forward,&nbsp;I&nbsp;will&nbsp;abbreviate&nbsp;the&nbsp;Forefront&nbsp;proxy&nbsp;as&nbsp;&quot;TMG&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Client&nbsp;--&gt;&nbsp;Squid&nbsp;3.5.5&nbsp;--&gt;&nbsp;TMG&nbsp;--&gt;&nbsp;Internet&lt;/div&gt;&lt;div&gt;And&nbsp;then&nbsp;I&nbsp;set&nbsp;the&nbsp;client&nbsp;to&nbsp;use&nbsp;squid:3128&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;the&nbsp;CONNECT&nbsp;tunnel.&lt;/div&gt;&lt;div&gt;Scenario:&lt;/div&gt;&lt;div&gt;Under&nbsp;normal&nbsp;circumstances,&nbsp;the&nbsp;following&nbsp;takes&nbsp;place&nbsp;for&nbsp;a&nbsp;standard&nbsp;request:&lt;/div&gt;&lt;div&gt;GET&nbsp;&lt;a&nbsp;href=&quot;http://www.arin.net&quot;&gt;http://www.arin.net&lt;/a&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;results&nbsp;in&nbsp;a&nbsp;301&nbsp;redirect&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://www.arin.net&quot;&gt;https://www.arin.net&lt;/a&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;client&nbsp;then&nbsp;immediately&nbsp;sends&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://www.arin.net:443&quot;&gt;www.arin.net:443&lt;/a&gt;&nbsp;to&nbsp;TMG:8080&lt;/div&gt;&lt;div&gt;And&nbsp;the&nbsp;connection&nbsp;is&nbsp;made.&nbsp;Perfectly&nbsp;normal.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Currently,&nbsp;I&nbsp;have&nbsp;configured&nbsp;the&nbsp;client&nbsp;to&nbsp;use&nbsp;squid:3128&nbsp;for&nbsp;all&nbsp;protocols&lt;/div&gt;&lt;div&gt;How&nbsp;do&nbsp;I&nbsp;bump&nbsp;the&nbsp;CONNECT&nbsp;tunnel?&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;been&nbsp;trying&nbsp;to&nbsp;manipulate&nbsp;the&nbsp;configuration&nbsp;file&nbsp;for&nbsp;days&nbsp;with&nbsp;no&nbsp;success.&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;settled&nbsp;on&nbsp;the&nbsp;configuration&nbsp;below&nbsp;for&nbsp;now&nbsp;because&nbsp;it&nbsp;allows&nbsp;unimpeded&nbsp;network&nbsp;traffic.&lt;/div&gt;&lt;div&gt;It&nbsp;does&nbsp;not&nbsp;bump&nbsp;any&nbsp;SSL.&lt;/div&gt;&lt;div&gt;Client&nbsp;is&nbsp;still&nbsp;set&nbsp;to&nbsp;use&nbsp;port&nbsp;3128&nbsp;for&nbsp;all&nbsp;protocols,&nbsp;Setting&nbsp;it&nbsp;to&nbsp;use&nbsp;3129&nbsp;for&nbsp;https&nbsp;was&nbsp;a&nbsp;failure.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;tried:&lt;/div&gt;&lt;div&gt;https_port&nbsp;3128&nbsp;&amp;&nbsp;3129&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;&amp;&nbsp;3129&lt;/div&gt;&lt;div&gt;various&nbsp;ssl_bump&nbsp;directives&nbsp;to&nbsp;include&nbsp;peek,&nbsp;stare,&nbsp;bump.&lt;/div&gt;&lt;div&gt;Nothing&nbsp;works.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s&nbsp;my&nbsp;usual&nbsp;failure&nbsp;in&nbsp;/var/log/access.log:&lt;/div&gt;&lt;div&gt;1435482419.334&nbsp; &nbsp; 194&nbsp;192.168.25.2&nbsp;TCP_MISS/301&nbsp;616&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://www.arin.net/&quot;&gt;http://www.arin.net/&lt;/a&gt;&nbsp;-&nbsp;FIRSTUP_PARENT/&lt;a&nbsp;href=&quot;http://10.210.4.103&quot;&gt;10.210.4.103&lt;/a&gt;&nbsp;text/html&lt;/div&gt;&lt;div&gt;1435482419.337&nbsp; &nbsp; &nbsp; 0&nbsp;192.168.25.2&nbsp;TAG_NONE/409&nbsp;4324&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://www.arin.net:443&quot;&gt;www.arin.net:443&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;reviewing&nbsp;many&nbsp;packet&nbsp;captures...&nbsp;I&nbsp;think&nbsp;the&nbsp;problem&nbsp;is&nbsp;this:&lt;/div&gt;&lt;div&gt;In&nbsp;order&nbsp;for&nbsp;squid&nbsp;to&nbsp;establish&nbsp;a&nbsp;connection&nbsp;via&nbsp;SSL&nbsp;to&nbsp;arin,&nbsp;squid&nbsp;would&nbsp;have&nbsp;to&nbsp;send&nbsp;a&nbsp;CONNECT&nbsp;request&nbsp;through&nbsp;the&nbsp;cache_peer.&lt;/div&gt;&lt;div&gt;Squid&nbsp;&quot;never&quot;&nbsp;sends&nbsp;a&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://www.arin.net:443&quot;&gt;www.arin.net:443&lt;/a&gt;&nbsp;to&nbsp;the&nbsp;cache_peer&nbsp;in&nbsp;any&nbsp;configuration&nbsp;I&nbsp;have&nbsp;tried,&nbsp;unless,&nbsp;I&nbsp;leave&nbsp;the&nbsp;configuration&nbsp;the&nbsp;way&nbsp;it&nbsp;is&nbsp;below.&lt;/div&gt;&lt;div&gt;Of&nbsp;course,&nbsp;since&nbsp;the&nbsp;client&nbsp;is&nbsp;only&nbsp;talking&nbsp;to&nbsp;squid&nbsp;on&nbsp;port&nbsp;3128,&nbsp;no&nbsp;SSL&nbsp;bumping&nbsp;takes&nbsp;place.&lt;/div&gt;&lt;div&gt;The&nbsp;minute&nbsp;I&nbsp;try&nbsp;to&nbsp;bump&nbsp;port&nbsp;3128&nbsp;all&nbsp;SSL&nbsp;stops&nbsp;working.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Again...&nbsp;I&nbsp;can&nbsp;get&nbsp;this&nbsp;to&nbsp;work&nbsp;in&nbsp;2&nbsp;minutes&nbsp;with&nbsp;no&nbsp;problems&nbsp;if&nbsp;I&nbsp;didn&#39;t&nbsp;have&nbsp;to&nbsp;also&nbsp;speak&nbsp;to&nbsp;a&nbsp;cache_peer.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Contents&nbsp;of&nbsp;/etc/squid/squid.conf&nbsp;:&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.25.0/24&quot;&gt;192.168.25.0/24&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;ftp&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;gopher&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;wais&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp; #&nbsp;unregistered&nbsp;ports&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http-mgmt&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;gss-http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;filemaker&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;multiling&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_effective_user&nbsp;proxy&lt;/div&gt;&lt;div&gt;forwarded_for&nbsp;delete&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;manager&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;never_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;cache_peer&nbsp;192.168.1.5&nbsp;parent&nbsp;8080&nbsp;0&nbsp;no-query&nbsp;default&nbsp;login=redacted&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;host_verify_strict&nbsp;off&lt;/div&gt;&lt;div&gt;sslproxy_cert_sign&nbsp;signTrusted&lt;/div&gt;&lt;div&gt;sslproxy_cert_error&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;3129&nbsp;intercept&nbsp;ssl-bump&nbsp;capath=/etc/ssl/certs&nbsp;cert=/etc/ssl/certs/midca.pem&nbsp;key=/etc/ssl/private/midca.key&nbsp;generate-host-certificates=on&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;server-first&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;sslcrtd_children&nbsp;40&nbsp;startup=7&nbsp;idle=5 &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_dir&nbsp;ufs&nbsp;/var/cache/squid&nbsp;100&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/cache/squid&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^ftp:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1440&nbsp; &nbsp; 20%&nbsp; &nbsp; &nbsp;10080&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^gopher:&nbsp; &nbsp; &nbsp; &nbsp; 1440&nbsp; &nbsp; 0%&nbsp; &nbsp; &nbsp; 1440&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp; &nbsp; &nbsp;0%&nbsp; &nbsp; &nbsp; 0&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;20%&nbsp; &nbsp; &nbsp;4320&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;would&nbsp;send&nbsp;pcaps&nbsp;of&nbsp;the&nbsp;failures&nbsp;but&nbsp;then&nbsp;I&nbsp;would&nbsp;have&nbsp;to&nbsp;sanitize&nbsp;them.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;/div&gt;&lt;div&gt;-JP&lt;/div&gt;&lt;/div&gt;<br>

</tt>
