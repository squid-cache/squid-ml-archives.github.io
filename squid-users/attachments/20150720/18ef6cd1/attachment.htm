<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Calibri<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;Overlooked&nbsp;before.&lt;br&gt;&lt;br&gt;This&nbsp;should&nbsp;be&nbsp;right&nbsp;now:&lt;br&gt;&lt;br&gt;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;+++&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;@@&nbsp;-191,8&nbsp;+194,10&nbsp;@@&nbsp;Ssl::PeerConnector::initializeSsl()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;:&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;:&nbsp;NULL);&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;:&nbsp;NULL;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!sniServer&nbsp;||&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(request-&gt;flags.redirected&nbsp;&amp;&amp;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::Config.onoff.redir_rewrites_host))&nbsp;{&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sniServer&nbsp;=&nbsp;!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;:&nbsp;NULL;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sniServer)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(83,&nbsp;5,&nbsp;&quot;SNIserve&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;sniServer);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl::setClientSNI(ssl,&nbsp;sniServer);&lt;br&gt;&lt;br&gt;&lt;br&gt;Alex&lt;br&gt;&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&lt;div&gt;&lt;hr&nbsp;id=&quot;stopSpelling&quot;&gt;From&#58;&nbsp;alex_wu2012@hotmail.com&lt;br&gt;To&#58;&nbsp;rousskov@measurement-factory.com;&nbsp;squid-users@lists.squid-cache.org&lt;br&gt;Date&#58;&nbsp;Mon,&nbsp;20&nbsp;Jul&nbsp;2015&nbsp;12&#58;34&#58;05&nbsp;-0700&lt;br&gt;Subject&#58;&nbsp;Re&#58;&nbsp;[squid-users]&nbsp;SSL&nbsp;connction&nbsp;failed&nbsp;due&nbsp;to&nbsp;SNI&nbsp;after&nbsp;content&nbsp;redirection&lt;br&gt;&lt;br&gt;<br>
<br>
&lt;style&gt;&lt;!--<br>
.ExternalClass&nbsp;.ecxhmmessage&nbsp;P&nbsp;{<br>
padding:0px;<br>
}<br>
<br>
.ExternalClass&nbsp;body.ecxhmmessage&nbsp;{<br>
font-size:12pt;<br>
font-family:Calibri;<br>
}<br>
<br>
--&gt;&lt;/style&gt;<br>
&lt;div&nbsp;dir=ltr&gt;That's&nbsp;right,&lt;br&gt;&lt;br&gt;It&nbsp;should&nbsp;be&nbsp;as&nbsp;follows&#58;&lt;br&gt;&lt;br&gt;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;+++&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;@@&nbsp;-191,8&nbsp;+194,10&nbsp;@@&nbsp;Ssl&#58;&#58;PeerConnector&#58;&#58;initializeSsl()&lt;br&gt;&lt;br&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;-&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;&#58;&lt;br&gt;-&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;(!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;&#58;&nbsp;NULL);&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName-&gt;c_str();&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;if&nbsp;(request-&gt;flags.redirected&nbsp;&amp;&amp;&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;&#58;&#58;Config.onoff.redir_rewrites_host&nbsp;&amp;&amp;&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;!request-&gt;GetHostIsNumeric()&nbsp;)&nbsp;&#123;&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;sniServer&nbsp;=&nbsp;request-&gt;GetHost();&lt;br&gt;+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;&#125;&lt;br&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;if&nbsp;(sniServer)&nbsp;&#123;&lt;br&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;debugs(83,&nbsp;5,&nbsp;&quot;SNIserve&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;sniServer);&lt;br&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&nbsp;Ssl&#58;&#58;setClientSNI(ssl,&nbsp;sniServer);&lt;br&gt;&lt;br&gt;Let&nbsp;me&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;get&nbsp;squid-dev.&lt;br&gt;&lt;br&gt;Alex&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&gt;&nbsp;Date&#58;&nbsp;Mon,&nbsp;20&nbsp;Jul&nbsp;2015&nbsp;13&#58;10&#58;26&nbsp;-0600&lt;br&gt;&gt;&nbsp;From&#58;&nbsp;rousskov@measurement-factory.com&lt;br&gt;&gt;&nbsp;To&#58;&nbsp;alex_wu2012@hotmail.com;&nbsp;squid-users@lists.squid-cache.org&lt;br&gt;&gt;&nbsp;Subject&#58;&nbsp;Re&#58;&nbsp;[squid-users]&nbsp;SSL&nbsp;connction&nbsp;failed&nbsp;due&nbsp;to&nbsp;SNI&nbsp;after&nbsp;content&nbsp;redirection&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;On&nbsp;07/20/2015&nbsp;11&#58;28&nbsp;AM,&nbsp;Alex&nbsp;Wu&nbsp;wrote&#58;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;With&nbsp;3.5.6&nbsp;code,&nbsp;we&nbsp;found&nbsp;one&nbsp;thing&nbsp;is&nbsp;broken.&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;We&nbsp;used&nbsp;pyredir&nbsp;to&nbsp;rewrite&nbsp;request&nbsp;to&nbsp;a&nbsp;surrogated&nbsp;server&nbsp;enabled&nbsp;SSL&lt;br&gt;&gt;&nbsp;&gt;&nbsp;connection.&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;Also,&nbsp;we&nbsp;enable&nbsp;this&nbsp;in&nbsp;squid.conf&#58;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;url_rewrite_host_header&nbsp;on&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;We&nbsp;expect&nbsp;a&nbsp;request&nbsp;to&nbsp;www.foo.com&nbsp;is&nbsp;changed&nbsp;to&nbsp;www.foo-internal.com.&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;squid&nbsp;sends&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;host&nbsp;header&nbsp;rewritten&nbsp;by&nbsp;pyredir&nbsp;as&lt;br&gt;&gt;&nbsp;&gt;&nbsp;www.foo-internal.com&nbsp;&nbsp;,&nbsp;but&nbsp;it&nbsp;fails&nbsp;connecting&nbsp;to&nbsp;the&nbsp;server&nbsp;withSSL&lt;br&gt;&gt;&nbsp;&gt;&nbsp;enabled&nbsp;due&nbsp;to&nbsp;SNI&nbsp;hostname&nbsp;selection&nbsp;(it&nbsp;is&nbsp;under&nbsp;SSLBUMP).&nbsp;We&nbsp;did&nbsp;this&lt;br&gt;&gt;&nbsp;&gt;&nbsp;change&nbsp;to&nbsp;get&nbsp;it&nbsp;work&#58;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;&gt;&nbsp;&gt;&nbsp;+++&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;&gt;&nbsp;&gt;&nbsp;@@&nbsp;-191,8&nbsp;+194,10&nbsp;@@&nbsp;Ssl&#58;&#58;PeerConnector&#58;&#58;initializeSsl()&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;&gt;&nbsp;&gt;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;&#58;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!request-&gt;GetHostIsNumeric()&nbsp;?&lt;br&gt;&gt;&nbsp;&gt;&nbsp;request-&gt;GetHost()&nbsp;&#58;&nbsp;NULL);&lt;br&gt;&gt;&nbsp;&gt;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName-&gt;c_str();&lt;br&gt;&gt;&nbsp;&gt;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;request-&gt;flags.redirected&nbsp;&amp;&amp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&#58;&#58;Config.onoff.redir_rewrites_host)&nbsp;&#123;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sniServer&nbsp;=&nbsp;!request-&gt;GetHostIsNumeric()&nbsp;?&lt;br&gt;&gt;&nbsp;&gt;&nbsp;request-&gt;GetHost()&nbsp;&#58;&nbsp;NULL;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sniServer)&nbsp;&#123;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(83,&nbsp;5,&nbsp;&quot;SNIserve&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;sniServer);&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl&#58;&#58;setClientSNI(ssl,&nbsp;sniServer);&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&gt;&nbsp;Is&nbsp;this&nbsp;correct?&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Not&nbsp;quite&#58;&nbsp;Your&nbsp;code&nbsp;is&nbsp;unconditionally&nbsp;dereferencing&nbsp;hostName&nbsp;which&lt;br&gt;&gt;&nbsp;might&nbsp;be&nbsp;NULL.&nbsp;You&nbsp;also&nbsp;seem&nbsp;to&nbsp;disable&nbsp;the&nbsp;request-&gt;GetHost()&nbsp;path&nbsp;for&lt;br&gt;&gt;&nbsp;cases&nbsp;where&nbsp;flags.redirected&nbsp;&amp;&amp;&nbsp;redir_rewrites_host&nbsp;is&nbsp;false.&nbsp;However,&nbsp;I&lt;br&gt;&gt;&nbsp;am&nbsp;not&nbsp;an&nbsp;expert&nbsp;on&nbsp;rewrite&nbsp;request&nbsp;APIs...&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;You&nbsp;may&nbsp;want&nbsp;to&nbsp;move&nbsp;this&nbsp;to&nbsp;squid-dev&nbsp;or&nbsp;Bugzilla.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;HTH,&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Alex.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
squid-users@lists.squid-cache.org<br>
http&#58;//lists.squid-cache.org/listinfo/squid-users&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
