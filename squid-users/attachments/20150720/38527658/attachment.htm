<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Calibri<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;That's&nbsp;right,&lt;br&gt;&lt;br&gt;It&nbsp;should&nbsp;be&nbsp;as&nbsp;follows:&lt;br&gt;&lt;br&gt;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;+++&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;@@&nbsp;-191,8&nbsp;+194,10&nbsp;@@&nbsp;Ssl::PeerConnector::initializeSsl()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;:&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;:&nbsp;NULL);&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName-&gt;c_str();&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(request-&gt;flags.redirected&nbsp;&amp;&amp;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::Config.onoff.redir_rewrites_host&nbsp;&amp;&amp;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!request-&gt;GetHostIsNumeric()&nbsp;)&nbsp;{&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sniServer&nbsp;=&nbsp;request-&gt;GetHost();&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sniServer)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(83,&nbsp;5,&nbsp;&quot;SNIserve&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;sniServer);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl::setClientSNI(ssl,&nbsp;sniServer);&lt;br&gt;&lt;br&gt;Let&nbsp;me&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;get&nbsp;squid-dev.&lt;br&gt;&lt;br&gt;Alex&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&lt;div&gt;&gt;&nbsp;Date&#58;&nbsp;Mon,&nbsp;20&nbsp;Jul&nbsp;2015&nbsp;13&#58;10&#58;26&nbsp;-0600&lt;br&gt;&gt;&nbsp;From&#58;&nbsp;rousskov&#64;measurement-factory.com&lt;br&gt;&gt;&nbsp;To&#58;&nbsp;alex_wu2012&#64;hotmail.com&#59;&nbsp;squid-users&#64;lists.squid-cache.org&lt;br&gt;&gt;&nbsp;Subject&#58;&nbsp;Re&#58;&nbsp;&#91;squid-users&#93;&nbsp;SSL&nbsp;connction&nbsp;failed&nbsp;due&nbsp;to&nbsp;SNI&nbsp;after&nbsp;content&nbsp;redirection&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;On&nbsp;07/20/2015&nbsp;11&#58;28&nbsp;AM,&nbsp;Alex&nbsp;Wu&nbsp;wrote&#58;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;With&nbsp;3.5.6&nbsp;code,&nbsp;we&nbsp;found&nbsp;one&nbsp;thing&nbsp;is&nbsp;broken.&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;We&nbsp;used&nbsp;pyredir&nbsp;to&nbsp;rewrite&nbsp;request&nbsp;to&nbsp;a&nbsp;surrogated&nbsp;server&nbsp;enabled&nbsp;SSL&lt;br&gt;&gt;&nbsp;&#62;&nbsp;connection.&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;Also,&nbsp;we&nbsp;enable&nbsp;this&nbsp;in&nbsp;squid.conf&#58;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;url_rewrite_host_header&nbsp;on&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;We&nbsp;expect&nbsp;a&nbsp;request&nbsp;to&nbsp;www.foo.com&nbsp;is&nbsp;changed&nbsp;to&nbsp;www.foo-internal.com.&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;squid&nbsp;sends&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;host&nbsp;header&nbsp;rewritten&nbsp;by&nbsp;pyredir&nbsp;as&lt;br&gt;&gt;&nbsp;&#62;&nbsp;www.foo-internal.com&nbsp;&nbsp;,&nbsp;but&nbsp;it&nbsp;fails&nbsp;connecting&nbsp;to&nbsp;the&nbsp;server&nbsp;withSSL&lt;br&gt;&gt;&nbsp;&#62;&nbsp;enabled&nbsp;due&nbsp;to&nbsp;SNI&nbsp;hostname&nbsp;selection&nbsp;&#40;it&nbsp;is&nbsp;under&nbsp;SSLBUMP&#41;.&nbsp;We&nbsp;did&nbsp;this&lt;br&gt;&gt;&nbsp;&#62;&nbsp;change&nbsp;to&nbsp;get&nbsp;it&nbsp;work&#58;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#43;&#43;&#43;&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#64;&#64;&nbsp;-191,8&nbsp;&#43;194,10&nbsp;&#64;&#64;&nbsp;Ssl&#58;&#58;PeerConnector&#58;&#58;initializeSsl&#40;&#41;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;&gt;&nbsp;&#62;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;&#42;sniServer&nbsp;&#61;&nbsp;hostName&nbsp;&#63;&nbsp;hostName-&#62;c_str&#40;&#41;&nbsp;&#58;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#40;&#33;request-&#62;GetHostIsNumeric&#40;&#41;&nbsp;&#63;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;request-&#62;GetHost&#40;&#41;&nbsp;&#58;&nbsp;NULL&#41;&#59;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#43;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;&#42;sniServer&nbsp;&#61;&nbsp;hostName-&#62;c_str&#40;&#41;&#59;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#43;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&#40;&nbsp;request-&#62;flags.redirected&nbsp;&#38;&#38;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#58;&#58;Config.onoff.redir_rewrites_host&#41;&nbsp;&#123;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#43;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sniServer&nbsp;&#61;&nbsp;&#33;request-&#62;GetHostIsNumeric&#40;&#41;&nbsp;&#63;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;request-&#62;GetHost&#40;&#41;&nbsp;&#58;&nbsp;NULL&#59;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&#43;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#125;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;&#40;sniServer&#41;&nbsp;&#123;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs&#40;83,&nbsp;5,&nbsp;&#34;SNIserve&nbsp;&#34;&nbsp;&#60;&#60;&nbsp;sniServer&#41;&#59;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl&#58;&#58;setClientSNI&#40;ssl,&nbsp;sniServer&#41;&#59;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;&lt;br&gt;&gt;&nbsp;&#62;&nbsp;Is&nbsp;this&nbsp;correct&#63;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Not&nbsp;quite&#58;&nbsp;Your&nbsp;code&nbsp;is&nbsp;unconditionally&nbsp;dereferencing&nbsp;hostName&nbsp;which&lt;br&gt;&gt;&nbsp;might&nbsp;be&nbsp;NULL.&nbsp;You&nbsp;also&nbsp;seem&nbsp;to&nbsp;disable&nbsp;the&nbsp;request-&#62;GetHost&#40;&#41;&nbsp;path&nbsp;for&lt;br&gt;&gt;&nbsp;cases&nbsp;where&nbsp;flags.redirected&nbsp;&#38;&#38;&nbsp;redir_rewrites_host&nbsp;is&nbsp;false.&nbsp;However,&nbsp;I&lt;br&gt;&gt;&nbsp;am&nbsp;not&nbsp;an&nbsp;expert&nbsp;on&nbsp;rewrite&nbsp;request&nbsp;APIs...&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;You&nbsp;may&nbsp;want&nbsp;to&nbsp;move&nbsp;this&nbsp;to&nbsp;squid-dev&nbsp;or&nbsp;Bugzilla.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;HTH,&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Alex.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
