<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Calibri<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;With&nbsp;3.5.6&nbsp;code,&nbsp;we&nbsp;found&nbsp;one&nbsp;thing&nbsp;is&nbsp;broken.&lt;br&gt;&lt;br&gt;We&nbsp;used&nbsp;pyredir&nbsp;to&nbsp;rewrite&nbsp;request&nbsp;to&nbsp;a&nbsp;surrogated&nbsp;server&nbsp;enabled&nbsp;SSL&nbsp;connection.&nbsp;&lt;br&gt;&lt;br&gt;Also,&nbsp;we&nbsp;enable&nbsp;this&nbsp;in&nbsp;squid.conf:&lt;br&gt;&lt;br&gt;url_rewrite_host_header&nbsp;on&lt;br&gt;&lt;br&gt;We&nbsp;expect&nbsp;a&nbsp;request&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;www.foo.com&quot;&nbsp;target=&quot;_blank&quot;&gt;www.foo.com&lt;/a&gt;&nbsp;is&nbsp;changed&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;www.foo-internal.com.&quot;&nbsp;target=&quot;_blank&quot;&gt;www.foo-internal.com.&lt;/a&gt;&nbsp;&lt;br&gt;&lt;br&gt;squid&nbsp;sends&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;host&nbsp;header&nbsp;rewritten&nbsp;by&nbsp;pyredir&nbsp;as&nbsp;&lt;a&nbsp;href=&quot;www.foo-internal.com&quot;&nbsp;target=&quot;_blank&quot;&gt;www.foo-internal.com&lt;/a&gt;&nbsp;&nbsp;,&nbsp;but&nbsp;it&nbsp;fails&nbsp;connecting&nbsp;to&nbsp;the&nbsp;server&nbsp;withSSL&nbsp;enabled&nbsp;due&nbsp;to&nbsp;SNI&nbsp;hostname&nbsp;selection&nbsp;(it&nbsp;is&nbsp;under&nbsp;SSLBUMP).&nbsp;We&nbsp;did&nbsp;this&nbsp;change&nbsp;to&nbsp;get&nbsp;it&nbsp;work:&lt;br&gt;&lt;br&gt;---&nbsp;a/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;+++&nbsp;b/squid-3.5.6/src/ssl/PeerConnector.cc&lt;br&gt;@@&nbsp;-191,8&nbsp;+194,10&nbsp;@@&nbsp;Ssl::PeerConnector::initializeSsl()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;SNI&nbsp;TLS&nbsp;extension&nbsp;only&nbsp;when&nbsp;we&nbsp;connect&nbsp;directly&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;and&nbsp;we&nbsp;know&nbsp;the&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName&nbsp;?&nbsp;hostName-&gt;c_str()&nbsp;:&lt;br&gt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;:&nbsp;NULL);&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*sniServer&nbsp;=&nbsp;hostName-&gt;c_str();&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;request-&gt;flags.redirected&nbsp;&amp;&amp;&nbsp;::Config.onoff.redir_rewrites_host)&nbsp;{&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sniServer&nbsp;=&nbsp;!request-&gt;GetHostIsNumeric()&nbsp;?&nbsp;request-&gt;GetHost()&nbsp;:&nbsp;NULL;&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sniServer)&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(83,&nbsp;5,&nbsp;&quot;SNIserve&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;sniServer);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ssl::setClientSNI(ssl,&nbsp;sniServer);&lt;br&gt;&lt;br&gt;&lt;br&gt;Is&nbsp;this&nbsp;correct?&lt;br&gt;&lt;br&gt;Alex&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
