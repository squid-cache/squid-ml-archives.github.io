<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana;font-size:&nbsp;12.0px;&quot;&gt;&lt;div&gt;I&nbsp;checked&nbsp;the&nbsp;bug&nbsp;you&nbsp;have&nbsp;mentioned&nbsp;and&nbsp;I&nbsp;think&nbsp;I&nbsp;am&nbsp;confronted&nbsp;with&nbsp;the&nbsp;same&nbsp;issue.&nbsp;I&nbsp;was&nbsp;able&nbsp;to&nbsp;build&nbsp;and&nbsp;test&nbsp;Squid&nbsp;3.5.6&nbsp;on&nbsp;Ubuntu&nbsp;14.04.2&nbsp;x84_64.&nbsp;I&nbsp;observed&nbsp;the&nbsp;same&nbsp;behavior.&nbsp;I&nbsp;have&nbsp;tested&nbsp;an&nbsp;8&nbsp;GB&nbsp;archive&nbsp;file&nbsp;and&nbsp;I&nbsp;get&nbsp;100&nbsp;%&nbsp;CPU&nbsp;usage&nbsp;and&nbsp;a&nbsp;download&nbsp;rate&nbsp;of&nbsp;nearly&nbsp;500&nbsp;KB/sec&nbsp;when&nbsp;the&nbsp;object&nbsp;gets&nbsp;cached.&nbsp;I&nbsp;have&nbsp;attached&nbsp;strace&nbsp;to&nbsp;the&nbsp;running&nbsp;process,&nbsp;but&nbsp;I&nbsp;killed&nbsp;it&nbsp;after&nbsp;30&nbsp;minutes.&nbsp;The&nbsp;whole&nbsp;takes&nbsp;hours,&nbsp;although&nbsp;we&nbsp;have&nbsp;a&nbsp;1-GBit&nbsp;ethernet:&lt;br/&gt;<br>
&lt;br/&gt;<br>
Process&nbsp;4091&nbsp;attached&lt;br/&gt;<br>
Process&nbsp;4091&nbsp;detached&lt;br/&gt;<br>
%&nbsp;time&nbsp;seconds&nbsp;usecs/call&nbsp;calls&nbsp;errors&nbsp;syscall&lt;br/&gt;<br>
------&nbsp;-----------&nbsp;-----------&nbsp;---------&nbsp;---------&nbsp;----------------&lt;br/&gt;<br>
78.83&nbsp;2.622879&nbsp;1&nbsp;1823951&nbsp;write&lt;br/&gt;<br>
12.29&nbsp;0.408748&nbsp;2&nbsp;228029&nbsp;2&nbsp;read&lt;br/&gt;<br>
6.18&nbsp;0.205663&nbsp;0&nbsp;912431&nbsp;1&nbsp;epoll_wait&lt;br/&gt;<br>
2.58&nbsp;0.085921&nbsp;0&nbsp;456020&nbsp;epoll_ctl&lt;br/&gt;<br>
0.09&nbsp;0.002919&nbsp;0&nbsp;6168&nbsp;brk&lt;br/&gt;<br>
0.02&nbsp;0.000623&nbsp;2&nbsp;356&nbsp;openat&lt;br/&gt;<br>
0.01&nbsp;0.000286&nbsp;0&nbsp;712&nbsp;getdents&lt;br/&gt;<br>
0.00&nbsp;0.000071&nbsp;1&nbsp;91&nbsp;getrusage&lt;br/&gt;<br>
0.00&nbsp;0.000038&nbsp;0&nbsp;362&nbsp;close&lt;br/&gt;<br>
0.00&nbsp;0.000003&nbsp;2&nbsp;2&nbsp;sendto&lt;br/&gt;<br>
0.00&nbsp;0.000001&nbsp;0&nbsp;3&nbsp;1&nbsp;recvfrom&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;2&nbsp;open&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;3&nbsp;stat&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;1&nbsp;1&nbsp;rt_sigreturn&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;1&nbsp;kill&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;4&nbsp;fcntl&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;2&nbsp;2&nbsp;unlink&lt;br/&gt;<br>
0.00&nbsp;0.000000&nbsp;0&nbsp;1&nbsp;getppid&lt;br/&gt;<br>
------&nbsp;-----------&nbsp;-----------&nbsp;---------&nbsp;---------&nbsp;----------------&lt;br/&gt;<br>
100.00&nbsp;3.327152&nbsp;3428139&nbsp;7&nbsp;total&lt;br/&gt;<br>
&lt;br/&gt;<br>
Can&nbsp;I&nbsp;do&nbsp;anything&nbsp;that&nbsp;helps&nbsp;to&nbsp;get&nbsp;ride&nbsp;of&nbsp;this&nbsp;problem?&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
&lt;br/&gt;<br>
Gesendet:&nbsp;Dienstag,&nbsp;21.&nbsp;Juli&nbsp;2015&nbsp;um&nbsp;17:37&nbsp;Uhr&lt;br/&gt;<br>
Von:&nbsp;&quot;Amos&nbsp;Jeffries&quot;&nbsp;&lt;squid3@treenet.co.nz&gt;&lt;br/&gt;<br>
An:&nbsp;&quot;Jens&nbsp;Offenbach&quot;&nbsp;&lt;wolle5050@gmx.de&gt;,&nbsp;&quot;squid-users@lists.squid-cache.org&quot;&nbsp;&lt;squid-users@lists.squid-cache.org&gt;&lt;br/&gt;<br>
Betreff:&nbsp;Re:&nbsp;Aw:&nbsp;Re:&nbsp;[squid-users]&nbsp;Squid3:&nbsp;100&nbsp;%&nbsp;CPU&nbsp;load&nbsp;during&nbsp;object&nbsp;caching&lt;br/&gt;<br>
On&nbsp;22/07/2015&nbsp;12:31&nbsp;a.m.,&nbsp;Jens&nbsp;Offenbach&nbsp;wrote:&lt;br/&gt;<br>
&gt;&nbsp;Thank&nbsp;you&nbsp;very&nbsp;much&nbsp;for&nbsp;your&nbsp;detailed&nbsp;explainations.&nbsp;We&nbsp;want&nbsp;to&nbsp;use&nbsp;Squid&nbsp;in&lt;br/&gt;<br>
&gt;&nbsp;order&nbsp;to&nbsp;accelerate&nbsp;our&nbsp;automated&nbsp;software&nbsp;setup&nbsp;processes&nbsp;via&nbsp;Puppet.&nbsp;Actually&lt;br/&gt;<br>
&gt;&nbsp;Squid&nbsp;will&nbsp;host&nbsp;only&nbsp;a&nbsp;very&nbsp;short&nbsp;amount&nbsp;of&nbsp;large&nbsp;objects&nbsp;(10-20).&nbsp;Its&nbsp;purpose&lt;br/&gt;<br>
&gt;&nbsp;is&nbsp;not&nbsp;to&nbsp;cache&nbsp;web&nbsp;traffic&nbsp;or&nbsp;little&nbsp;objects.&lt;br/&gt;<br>
&lt;br/&gt;<br>
Ah,&nbsp;Squid&nbsp;does&nbsp;not&nbsp;&quot;host&quot;,&nbsp;it&nbsp;caches.&nbsp;The&nbsp;difference&nbsp;may&nbsp;seem&nbsp;trivial&nbsp;at&lt;br/&gt;<br>
first&nbsp;glance&nbsp;but&nbsp;it&nbsp;is&nbsp;the&nbsp;critical&nbsp;factor&nbsp;between&nbsp;whether&nbsp;a&nbsp;proxy&nbsp;or&nbsp;a&lt;br/&gt;<br>
local&nbsp;web&nbsp;server&nbsp;is&nbsp;the&nbsp;best&nbsp;tool&nbsp;for&nbsp;the&nbsp;job.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;From&nbsp;my&nbsp;own&nbsp;experiences&nbsp;with&nbsp;Puppet,&nbsp;yes&nbsp;Squid&nbsp;is&nbsp;the&nbsp;right&nbsp;tool.&nbsp;But&lt;br/&gt;<br>
only&nbsp;because&nbsp;the&nbsp;Puppet&nbsp;server&nbsp;was&nbsp;using&nbsp;relatively&nbsp;slow&nbsp;python&nbsp;code&nbsp;to&lt;br/&gt;<br>
generate&nbsp;objects&nbsp;and&nbsp;not&nbsp;doing&nbsp;server-side&nbsp;caching&nbsp;on&nbsp;its&nbsp;own.&nbsp;If&nbsp;that&lt;br/&gt;<br>
situation&nbsp;has&nbsp;changed&nbsp;in&nbsp;recent&nbsp;years&nbsp;then&nbsp;Squids&nbsp;usefulness&nbsp;will&nbsp;also&lt;br/&gt;<br>
have&nbsp;changed.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;&nbsp;The&nbsp;hit-ratio&nbsp;for&nbsp;all&nbsp;the&nbsp;hosted&lt;br/&gt;<br>
&gt;&nbsp;objects&nbsp;will&nbsp;be&nbsp;very&nbsp;high,&nbsp;because&nbsp;most&nbsp;of&nbsp;our&nbsp;VMs&nbsp;require&nbsp;the&nbsp;same&nbsp;software&nbsp;stack.&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;will&nbsp;update&nbsp;mit&nbsp;config&nbsp;regarding&nbsp;to&nbsp;your&nbsp;comments!&nbsp;Thanks&nbsp;a&nbsp;lot!&lt;br/&gt;<br>
&gt;&nbsp;But&nbsp;actually&nbsp;I&nbsp;have&nbsp;still&nbsp;no&nbsp;idea,&nbsp;why&nbsp;the&nbsp;download&nbsp;rates&nbsp;are&nbsp;so&nbsp;unsatisfying.&lt;br/&gt;<br>
&gt;&nbsp;We&nbsp;are&nbsp;sill&nbsp;in&nbsp;the&nbsp;test&nbsp;phase.&nbsp;We&nbsp;have&nbsp;only&nbsp;one&nbsp;client&nbsp;that&nbsp;requests&nbsp;a&nbsp;large&lt;br/&gt;<br>
&gt;&nbsp;object&nbsp;from&nbsp;Squid&nbsp;and&nbsp;the&nbsp;transfer&nbsp;rates&nbsp;are&nbsp;lower&nbsp;than&nbsp;1&nbsp;MB/sec&nbsp;during&nbsp;cache&lt;br/&gt;<br>
&gt;&nbsp;build-up&nbsp;without&nbsp;any&nbsp;form&nbsp;of&nbsp;concurrency.&nbsp;Have&nbsp;vou&nbsp;got&nbsp;an&nbsp;idea&nbsp;what&nbsp;could&nbsp;be&nbsp;the&lt;br/&gt;<br>
&gt;&nbsp;source&nbsp;of&nbsp;the&nbsp;problem&nbsp;here?&nbsp;Why&nbsp;causes&nbsp;the&nbsp;Squid&nbsp;process&nbsp;100&nbsp;%&nbsp;CPU&nbsp;usage.&lt;br/&gt;<br>
&lt;br/&gt;<br>
I&nbsp;did&nbsp;not&nbsp;see&nbsp;any&nbsp;config&nbsp;causing&nbsp;the&nbsp;known&nbsp;100%&nbsp;CPU&nbsp;bugs&nbsp;to&nbsp;be&lt;br/&gt;<br>
encountered&nbsp;in&nbsp;your&nbsp;case&nbsp;(eg.&nbsp;HTTPS&nbsp;going&nbsp;through&nbsp;delay&nbsp;pools&nbsp;guarantees&lt;br/&gt;<br>
100%&nbsp;CPU).&nbsp;Which&nbsp;leads&nbsp;me&nbsp;to&nbsp;think&nbsp;its&nbsp;probably&nbsp;related&nbsp;to&nbsp;memory&lt;br/&gt;<br>
shuffling.&nbsp;(&lt;&lt;a&nbsp;href=&quot;https://3c.gmx.net/mail/client/dereferrer?redirectUrl=http%3A%2F%2Fbugs.squid-cache.org%2Fshow_bug.cgi%3Fid%3D3189&quot;&nbsp;target=&quot;_blank&quot;&gt;http://bugs.squid-cache.org/show_bug.cgi?id=3189&lt;/a&gt;&gt;&nbsp;appears&lt;br/&gt;<br>
to&nbsp;be&nbsp;the&nbsp;same&nbsp;and&nbsp;still&nbsp;unidentified)&lt;br/&gt;<br>
&lt;br/&gt;<br>
As&nbsp;for&nbsp;speed,&nbsp;if&nbsp;the&nbsp;CPU&nbsp;is&nbsp;maxed&nbsp;out&nbsp;by&nbsp;one&nbsp;particular&nbsp;action&nbsp;Squid&lt;br/&gt;<br>
wont&nbsp;have&nbsp;time&nbsp;for&nbsp;much&nbsp;other&nbsp;work.&nbsp;So&nbsp;things&nbsp;go&nbsp;slow.&lt;br/&gt;<br>
&lt;br/&gt;<br>
On&nbsp;the&nbsp;other&nbsp;hand&nbsp;Squid&nbsp;is&nbsp;also&nbsp;optimized&nbsp;for&nbsp;relatively&nbsp;high&nbsp;traffic&lt;br/&gt;<br>
usage.&nbsp;For&nbsp;very&nbsp;small&nbsp;client&nbsp;counts&nbsp;(such&nbsp;as&nbsp;under-10)&nbsp;it&nbsp;is&nbsp;effectively&lt;br/&gt;<br>
running&nbsp;in&nbsp;idle&nbsp;mode&nbsp;99%&nbsp;of&nbsp;the&nbsp;time.&nbsp;The&nbsp;I/O&nbsp;event&nbsp;loop&nbsp;starts&nbsp;pausing&lt;br/&gt;<br>
for&nbsp;10ms&nbsp;blocks&nbsp;waiting&nbsp;to&nbsp;see&nbsp;if&nbsp;some&nbsp;more&nbsp;useful&nbsp;amount&nbsp;of&nbsp;work&nbsp;can&nbsp;be&lt;br/&gt;<br>
done&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;wait.&nbsp;That&nbsp;can&nbsp;lead&nbsp;to&nbsp;apparent&nbsp;network&nbsp;slowdown&lt;br/&gt;<br>
as&nbsp;TCP&nbsp;gets&nbsp;up&nbsp;to&nbsp;10ms&nbsp;delay&nbsp;per&nbsp;packet.&nbsp;But&nbsp;that&nbsp;should&nbsp;not&nbsp;be&nbsp;visible&lt;br/&gt;<br>
in&nbsp;CPU&nbsp;numbers.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
That&nbsp;said,&nbsp;1&nbsp;client&nbsp;can&nbsp;still&nbsp;max&nbsp;out&nbsp;Squid&nbsp;CPU&nbsp;and/or&nbsp;NIC&nbsp;throughput&lt;br/&gt;<br>
capacity&nbsp;on&nbsp;a&nbsp;single&nbsp;request&nbsp;if&nbsp;its&nbsp;pushing/pulling&nbsp;packets&nbsp;fast&nbsp;enough.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
If&nbsp;you&nbsp;can&nbsp;attach&nbsp;the&nbsp;strace&nbsp;tool&nbsp;to&nbsp;Squid&nbsp;when&nbsp;its&nbsp;consuming&nbsp;the&nbsp;CPU&lt;br/&gt;<br>
there&nbsp;might&nbsp;be&nbsp;some&nbsp;better&nbsp;hints&nbsp;about&nbsp;where&nbsp;to&nbsp;look.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
Cheers&lt;br/&gt;<br>
Amos&lt;br/&gt;<br>
&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>
<br>

</tt>
