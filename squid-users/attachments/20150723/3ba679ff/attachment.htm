<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;After&nbsp;bumping&nbsp;Squid&nbsp;from&nbsp;3.4.x&nbsp;to&nbsp;3.5.x&nbsp;in&nbsp;our&nbsp;implementation&nbsp;of&nbsp;Squid&nbsp;in&nbsp;the&nbsp;Smoothwall&nbsp;Express&nbsp;v3.1&nbsp;firewall&nbsp;distro&nbsp;we&nbsp;have&nbsp;begun&nbsp;to&nbsp;have&nbsp;complaints&nbsp;from&nbsp;our&nbsp;users&nbsp;about&nbsp;&quot;erratic&nbsp;behavior&quot;&nbsp;of&nbsp;Squid&nbsp;shutting&nbsp;down&nbsp;during&nbsp;reboots&nbsp;or&nbsp;network&nbsp;drops&nbsp;causing&nbsp;reboots.&lt;br&gt;&lt;br&gt;It&nbsp;appears&nbsp;that&nbsp;squid&nbsp;(v3.5.[5-6])&nbsp;does&nbsp;not&nbsp;respond&nbsp;well&nbsp;to&nbsp;SIGTERM&nbsp;<br>
during&nbsp;system&nbsp;shutdown;&nbsp;the&nbsp;cache&nbsp;index&nbsp;almost&nbsp;invariably&nbsp;needs&nbsp;to&nbsp;be&nbsp;<br>
rebuilt&nbsp;on&nbsp;next&nbsp;boot.&nbsp;It&nbsp;is&nbsp;suggested&nbsp;that&nbsp;we&nbsp;use&nbsp;squid&nbsp;to&nbsp;shut&nbsp;squid&nbsp;<br>
down.&nbsp;While&nbsp;using&nbsp;squid&nbsp;to&nbsp;stop&nbsp;the&nbsp;squid&nbsp;daemon&nbsp;is&nbsp;very&nbsp;doable,&nbsp;this&nbsp;<br>
requirement&nbsp;runs&nbsp;contrary&nbsp;to&nbsp;the&nbsp;longstanding,&nbsp;traditional&nbsp;UNIX&nbsp;method&nbsp;<br>
of&nbsp;&quot;SIGTERM,&nbsp;pause,&nbsp;SIGKILL&quot;.&lt;br&gt;&lt;br&gt;During&nbsp;normal&nbsp;system&nbsp;operation,&nbsp;<br>
squid&nbsp;*ought*&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;take&nbsp;as&nbsp;much&nbsp;time&nbsp;as&nbsp;it&nbsp;wants&nbsp;to&nbsp;shut&nbsp;down.&nbsp;<br>
But&nbsp;it&nbsp;still&nbsp;shouldn&#39;t&nbsp;take&nbsp;more&nbsp;than&nbsp;10-20&nbsp;seconds;&nbsp;&#39;shutdown&#39;&nbsp;is&nbsp;a&nbsp;<br>
command,&nbsp;not&nbsp;a&nbsp;request&nbsp;to&nbsp;be&nbsp;honored&nbsp;at&nbsp;squid&#39;s&nbsp;leisure.&nbsp;After&nbsp;all,&nbsp;the&nbsp;<br>
CPU&nbsp;could&nbsp;be&nbsp;on&nbsp;fire....&lt;br&gt;&lt;br&gt;This&nbsp;raises&nbsp;a&nbsp;few&nbsp;questions&nbsp;that&nbsp;are&nbsp;<br>
intended&nbsp;to&nbsp;foster&nbsp;fresh&nbsp;discussion,&nbsp;not&nbsp;to&nbsp;re-hash&nbsp;old&nbsp;arguments.&nbsp;They&nbsp;<br>
are&nbsp;really&nbsp;more&nbsp;rhetorical&nbsp;in&nbsp;nature;&nbsp;the&nbsp;goal&nbsp;is&nbsp;to&nbsp;find&nbsp;the&nbsp;root&nbsp;cause<br>
&nbsp;of&nbsp;the&nbsp;problem.&lt;br&gt;&lt;ul&gt;&lt;li&gt;Why&nbsp;do&nbsp;these&nbsp;latest&nbsp;versions&nbsp;of&nbsp;Squid&nbsp;3&nbsp;behave&nbsp;oddly&nbsp;in&nbsp;this&nbsp;respect?&lt;/li&gt;&lt;li&gt;What&nbsp;is&nbsp;it&nbsp;about&nbsp;shutting&nbsp;squid&nbsp;down&nbsp;that&nbsp;corrupts&nbsp;the&nbsp;cache&nbsp;index?&lt;/li&gt;&lt;li&gt;Does&nbsp;it&nbsp;take&nbsp;more&nbsp;than&nbsp;a&nbsp;few&nbsp;seconds&nbsp;to&nbsp;write&nbsp;the&nbsp;index&nbsp;to&nbsp;disk?&lt;/li&gt;&lt;li&gt;Does&nbsp;squid&nbsp;use&nbsp;the&nbsp;very&nbsp;slow&nbsp;&#39;writethrough&#39;&nbsp;method&nbsp;instead&nbsp;of&nbsp;trusting&nbsp;the&nbsp;Linux&nbsp;disk&nbsp;cache&nbsp;to&nbsp;properly&nbsp;save&nbsp;the&nbsp;cache?&lt;/li&gt;&lt;li&gt;Should&nbsp;squid&nbsp;write&nbsp;the&nbsp;cache&nbsp;index&nbsp;to&nbsp;disk&nbsp;more&nbsp;often?&lt;/li&gt;&lt;li&gt;Should&nbsp;squid&nbsp;track&nbsp;its&nbsp;own&nbsp;&#39;dirty&nbsp;pages&#39;&nbsp;in&nbsp;its&nbsp;in-core&nbsp;index&nbsp;to&nbsp;reduce&nbsp;the&nbsp;time&nbsp;it&nbsp;takes&nbsp;to&nbsp;write&nbsp;the&nbsp;index?&lt;/li&gt;&lt;li&gt;Should&nbsp;squid&nbsp;implement&nbsp;a&nbsp;journal&nbsp;(akin&nbsp;to&nbsp;EXT/ReiserFS&nbsp;and&nbsp;others)&nbsp;so&nbsp;the&nbsp;on-disk&nbsp;index&nbsp;structure&nbsp;is&nbsp;always&nbsp;OK?&lt;/li&gt;&lt;li&gt;Is&nbsp;the&nbsp;problem&nbsp;related&nbsp;to&nbsp;clients&nbsp;actively&nbsp;receiving&nbsp;web&nbsp;pages&nbsp;from&nbsp;squid?&lt;/li&gt;&lt;li&gt;Could<br>
&nbsp;squid&#39;s&nbsp;signal&nbsp;handling&nbsp;be&nbsp;adjusted&nbsp;to&nbsp;treat&nbsp;those&nbsp;clients&nbsp;more&nbsp;<br>
harshly?&nbsp;That&nbsp;is,&nbsp;terminate&nbsp;the&nbsp;transfers&nbsp;early&nbsp;because&nbsp;squid&nbsp;shutting&nbsp;<br>
down&nbsp;is&nbsp;much&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;network&nbsp;interface&nbsp;going&nbsp;down.&lt;/li&gt;&lt;li&gt;Is&nbsp;<br>
the&nbsp;only&nbsp;viable&nbsp;solution&nbsp;to&nbsp;use&nbsp;squid&nbsp;to&nbsp;stop&nbsp;the&nbsp;daemon?&nbsp;Does&nbsp;&#39;squid&nbsp;-k<br>
&nbsp;shutdown&#39;&nbsp;exit&nbsp;only&nbsp;after&nbsp;the&nbsp;daemon&nbsp;is&nbsp;dead?&nbsp;The&nbsp;squid&nbsp;man&nbsp;page&nbsp;<br>
indicates&nbsp;that&nbsp;it&nbsp;sends&nbsp;the&nbsp;shutdown&nbsp;&#39;signal&#39;&nbsp;but&nbsp;does&nbsp;not&nbsp;await&nbsp;a&nbsp;<br>
reply;&nbsp;thus&nbsp;a&nbsp;potentially&nbsp;lengthy&nbsp;pause&nbsp;in&nbsp;system&nbsp;shutdown&nbsp;may&nbsp;be&nbsp;<br>
required&nbsp;anyway.&lt;/li&gt;&lt;li&gt;Is&nbsp;pausing&nbsp;the&nbsp;system&nbsp;shutdown&nbsp;for&nbsp;10-15&nbsp;seconds&nbsp;the&nbsp;only&nbsp;really&nbsp;viable&nbsp;shutdown&nbsp;solution?&lt;/li&gt;&lt;li&gt;Or&nbsp;is&nbsp;it&nbsp;best&nbsp;to&nbsp;delete&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;cache&nbsp;index&nbsp;on&nbsp;every&nbsp;system&nbsp;startup?&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Any&nbsp;thoughts&nbsp;on&nbsp;any&nbsp;of&nbsp;the&nbsp;above&nbsp;statements&nbsp;or&nbsp;issues?&lt;/p&gt;&lt;p&gt;As&nbsp;always,&nbsp;I&nbsp;appreciate&nbsp;any&nbsp;help&nbsp;and&nbsp;suggestions.&lt;/p&gt;&lt;p&gt;Regards&lt;/p&gt;&lt;p&gt;Stan&lt;br&gt;&lt;/p&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
