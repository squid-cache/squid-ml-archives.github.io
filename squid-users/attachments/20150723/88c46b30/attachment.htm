<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana;font-size:&nbsp;12.0px;&quot;&gt;&lt;div&gt;<br>
&lt;div&gt;I&nbsp;have&nbsp;attached&nbsp;strace&nbsp;to&nbsp;Squid&nbsp;and&nbsp;waited&nbsp;until&nbsp;the&nbsp;download&nbsp;rate&nbsp;has&nbsp;decreased&nbsp;to&nbsp;500&nbsp;KB/sec.&lt;br/&gt;<br>
&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;I&nbsp;used&nbsp;&quot;cache_dir&nbsp;aufs&nbsp;/var/cache/squid3&nbsp;88894&nbsp;16&nbsp;256&nbsp;max-size=10737418240&quot;.&lt;/div&gt;<br>
<br>
&lt;div&gt;<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;Here&nbsp;is&nbsp;the&nbsp;download&nbsp;link:&lt;/div&gt;<br>
<br>
&lt;div&gt;http://w1.wikisend.com/node-fs/download/6a004a416f65b4cdf7f8eff4ff961199/squid.strace&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;I&nbsp;hope&nbsp;it&nbsp;can&nbsp;help&nbsp;you.&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&nbsp;name=&quot;quote&quot;&nbsp;style=&quot;margin:10px&nbsp;5px&nbsp;5px&nbsp;10px;&nbsp;padding:&nbsp;10px&nbsp;0&nbsp;10px&nbsp;10px;&nbsp;border-left:2px&nbsp;solid&nbsp;#C3D9E5;&nbsp;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;margin:0&nbsp;0&nbsp;10px&nbsp;0;&quot;&gt;&lt;b&gt;Gesendet:&lt;/b&gt;&nbsp;Donnerstag,&nbsp;23.&nbsp;Juli&nbsp;2015&nbsp;um&nbsp;13:29&nbsp;Uhr&lt;br/&gt;<br>
&lt;b&gt;Von:&lt;/b&gt;&nbsp;&quot;Marcus&nbsp;Kool&quot;&nbsp;&lt;marcus.kool@urlfilterdb.com&gt;&lt;br/&gt;<br>
&lt;b&gt;An:&lt;/b&gt;&nbsp;&quot;Jens&nbsp;Offenbach&quot;&nbsp;&lt;wolle5050@gmx.de&gt;,&nbsp;&quot;Eliezer&nbsp;Croitoru&quot;&nbsp;&lt;eliezer@ngtech.co.il&gt;,&nbsp;&quot;Amos&nbsp;Jeffries&quot;&nbsp;&lt;squid3@treenet.co.nz&gt;,&nbsp;squid-users@lists.squid-cache.org&lt;br/&gt;<br>
&lt;b&gt;Betreff:&lt;/b&gt;&nbsp;Re:&nbsp;[squid-users]&nbsp;Squid3:&nbsp;100&nbsp;%&nbsp;CPU&nbsp;load&nbsp;during&nbsp;object&nbsp;caching&lt;/div&gt;<br>
<br>
&lt;div&nbsp;name=&quot;quoted-content&quot;&gt;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;it&nbsp;is&nbsp;relevant,&nbsp;maybe&nbsp;it&nbsp;is:&lt;br/&gt;<br>
&lt;br/&gt;<br>
I&nbsp;am&nbsp;developing&nbsp;an&nbsp;ICAP&nbsp;daemon&nbsp;and&nbsp;after&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;sends&nbsp;a&nbsp;&quot;100&nbsp;continue&quot;&lt;br/&gt;<br>
Squid&nbsp;sends&nbsp;the&nbsp;object&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;in&nbsp;small&nbsp;chunks&nbsp;of&nbsp;varying&nbsp;sizes:&lt;br/&gt;<br>
4095,&nbsp;5813,&nbsp;1448,&nbsp;4344,&nbsp;1448,&nbsp;1448,&nbsp;2896,&nbsp;etc.&lt;br/&gt;<br>
Note&nbsp;that&nbsp;the&nbsp;interval&nbsp;of&nbsp;receiving&nbsp;the&nbsp;chunks&nbsp;is&nbsp;1/1000th&nbsp;of&nbsp;a&nbsp;second.&lt;br/&gt;<br>
It&nbsp;seems&nbsp;that&nbsp;Squid&nbsp;forwards&nbsp;the&nbsp;object&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;every&nbsp;time&nbsp;it&nbsp;receives&lt;br/&gt;<br>
one&nbsp;or&nbsp;a&nbsp;few&nbsp;TCP&nbsp;packets.&lt;br/&gt;<br>
&lt;br/&gt;<br>
I&nbsp;have&nbsp;a&nbsp;suspicion&nbsp;that&nbsp;in&nbsp;the&nbsp;scenario&nbsp;of&nbsp;100%&nbsp;CPU,&nbsp;large&nbsp;#write&nbsp;calls&nbsp;and&nbsp;low&nbsp;throughput&nbsp;a&nbsp;similar&nbsp;thing&nbsp;is&nbsp;happening:&lt;br/&gt;<br>
Squid&nbsp;physically&nbsp;stores&nbsp;a&nbsp;small&nbsp;part&nbsp;of&nbsp;the&nbsp;object&nbsp;many&nbsp;times,&nbsp;i.e.&nbsp;every&nbsp;time&nbsp;one&nbsp;or&nbsp;a&nbsp;few&nbsp;TCP&nbsp;packets&nbsp;arrive.&lt;br/&gt;<br>
&lt;br/&gt;<br>
Amos,&nbsp;is&nbsp;there&nbsp;a&nbsp;debug&nbsp;setting&nbsp;that&nbsp;can&nbsp;confirm/reject&nbsp;this&nbsp;suspicion?&lt;br/&gt;<br>
&lt;br/&gt;<br>
Marcus&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
On&nbsp;07/23/2015&nbsp;04:25&nbsp;AM,&nbsp;Jens&nbsp;Offenbach&nbsp;wrote:&lt;br/&gt;<br>
&gt;&nbsp;A&nbsp;test&nbsp;with&nbsp;ROCK&nbsp;&quot;cache_dir&nbsp;rock&nbsp;/var/cache/squid3&nbsp;51200&quot;&nbsp;gives&nbsp;very&nbsp;confusing&nbsp;results.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;cleared&nbsp;the&nbsp;cache:&lt;br/&gt;<br>
&gt;&nbsp;rm&nbsp;-rf&nbsp;/var/cache/squid3/*&lt;br/&gt;<br>
&gt;&nbsp;squid&nbsp;-z&lt;br/&gt;<br>
&gt;&nbsp;squid&lt;br/&gt;<br>
&gt;&nbsp;http_proxy=&lt;a&nbsp;href=&quot;http://139.2.57.120:3128/&quot;&nbsp;target=&quot;_blank&quot;&gt;http://139.2.57.120:3128/&lt;/a&gt;&nbsp;wget&nbsp;http://test-server/freesurfer-Linux-centos6_x86_64-stable-pub-v5.3.0.tar&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;The&nbsp;download&nbsp;starts&nbsp;with&nbsp;10&nbsp;MB/sec&nbsp;and&nbsp;stays&nbsp;constant&nbsp;for&nbsp;1&nbsp;minutes,&nbsp;then&nbsp;it&nbsp;drops&nbsp;gradually&nbsp;to&nbsp;1&nbsp;MB/sec&nbsp;and&nbsp;stays&nbsp;there&nbsp;for&nbsp;some&nbsp;time.&nbsp;After&nbsp;5&nbsp;minutes&nbsp;the&nbsp;download&nbsp;rate&nbsp;returns&nbsp;back&nbsp;to&nbsp;10&nbsp;MB/sec&nbsp;very&nbsp;quickly&nbsp;and&nbsp;drops&nbsp;again&nbsp;step-by-step&nbsp;to&nbsp;1&nbsp;MB/sec.&nbsp;After&nbsp;5-6&nbsp;minutes&nbsp;the&nbsp;download&nbsp;rates&nbsp;rises&nbsp;again&nbsp;to&nbsp;10&nbsp;MB/sec&nbsp;and&nbsp;drops&nbsp;again&nbsp;gradually&nbsp;to&nbsp;1&nbsp;MB/sec.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;During&nbsp;caching&nbsp;progress,&nbsp;we&nbsp;have&nbsp;100&nbsp;%&nbsp;CPU&nbsp;usage&nbsp;and&nbsp;a&nbsp;disk&nbsp;IO&nbsp;that&nbsp;is&nbsp;corresponds&nbsp;with&nbsp;the&nbsp;download&nbsp;rate.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;For&nbsp;further&nbsp;investigations&nbsp;I&nbsp;give&nbsp;you&nbsp;my&nbsp;build&nbsp;properties:&lt;br/&gt;<br>
&gt;&nbsp;squid&nbsp;-v&lt;br/&gt;<br>
&gt;&nbsp;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.6&lt;br/&gt;<br>
&gt;&nbsp;Service&nbsp;Name:&nbsp;squid&lt;br/&gt;<br>
&gt;&nbsp;configure&nbsp;options:&nbsp;&#39;--build=x86_64-linux-gnu&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--includedir=/include&#39;&nbsp;&#39;--mandir=/share/man&#39;&nbsp;&#39;--infodir=/share/info&#39;&nbsp;&#39;--sysconfdir=/etc&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--libexecdir=/lib/squid3&#39;&nbsp;&#39;--srcdir=.&#39;&nbsp;&#39;--disable-maintainer-mode&#39;&nbsp;&#39;--disable-dependency-tracking&#39;&nbsp;&#39;--disable-silent-rules&#39;&nbsp;&#39;--datadir=/usr/share/squid3&#39;&nbsp;&#39;--sysconfdir=/etc/squid3&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--enable-inline&#39;&nbsp;&#39;--enable-async-io=8&#39;&nbsp;&#39;--enable-storeio=ufs,aufs,diskd,rock&#39;&nbsp;&#39;--enable-removal-policies=lru,heap&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-underscores&#39;&nbsp;&#39;--enable-icap-client&#39;&nbsp;&#39;--enable-follow-x-forwarded-for&#39;&nbsp;&#39;--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB&#39;&nbsp;&#39;--enable-auth-digest=file,LDAP&#39;&nbsp;&#39;--enable-auth-negotiate=kerberos,wrapper&#39;&nbsp;&#39;--enable-auth-ntlm=fake,smb_lm&#39;&nbsp;&#39;--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group&#39;&nbsp;&#39;--enable-url-rewrite-helpers=fake&#39;&nbsp;&#39;--enable-eui&#39;&nbsp;&#39;--enable-e&lt;br/&gt;<br>
s&lt;br/&gt;<br>
i&#39;&nbsp;&#39;--enable-icmp&#39;&nbsp;&#39;--enable-zph-qos&#39;&nbsp;&#39;--enable-ecap&#39;&nbsp;&#39;--disable-translation&#39;&nbsp;&#39;--with-swapdir=/var/cache/squid3&#39;&nbsp;&#39;--with-logdir=/var/log/squid3&#39;&nbsp;&#39;--with-pidfile=/var/run/squid3.pid&#39;&nbsp;&#39;--with-filedescriptors=65536&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-default-user=proxy&#39;&nbsp;&#39;--enable-linux-netfilter&#39;&nbsp;&#39;build_alias=x86_64-linux-gnu&#39;&nbsp;&#39;CFLAGS=-g&nbsp;-O2&nbsp;-fPIE&nbsp;-fstack-protector&nbsp;--param=ssp-buffer-size=4&nbsp;-Wformat&nbsp;-Werror=format-security&nbsp;-Wall&#39;&nbsp;&#39;LDFLAGS=-Wl,-Bsymbolic-functions&nbsp;-fPIE&nbsp;-pie&nbsp;-Wl,-z,relro&nbsp;-Wl,-z,now&#39;&nbsp;&#39;CPPFLAGS=-D_FORTIFY_SOURCE=2&#39;&nbsp;&#39;CXXFLAGS=-g&nbsp;-O2&nbsp;-fPIE&nbsp;-fstack-protector&nbsp;--param=ssp-buffer-size=4&nbsp;-Wformat&nbsp;-Werror=format-security&#39;&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;Gesendet:&nbsp;Mittwoch,&nbsp;22.&nbsp;Juli&nbsp;2015&nbsp;um&nbsp;21:47&nbsp;Uhr&lt;br/&gt;<br>
&gt;&nbsp;Von:&nbsp;&quot;Eliezer&nbsp;Croitoru&quot;&nbsp;&lt;eliezer@ngtech.co.il&gt;&lt;br/&gt;<br>
&gt;&nbsp;An:&nbsp;squid-users@lists.squid-cache.org&lt;br/&gt;<br>
&gt;&nbsp;Betreff:&nbsp;Re:&nbsp;[squid-users]&nbsp;Squid3:&nbsp;100&nbsp;%&nbsp;CPU&nbsp;load&nbsp;during&nbsp;object&nbsp;caching&lt;br/&gt;<br>
&gt;&nbsp;On&nbsp;22/07/2015&nbsp;21:59,&nbsp;Eliezer&nbsp;Croitoru&nbsp;wrote:&lt;br/&gt;<br>
&gt;&gt;&nbsp;Hey&nbsp;Jens,&lt;br/&gt;<br>
&gt;&gt;&lt;br/&gt;<br>
&gt;&gt;&nbsp;I&nbsp;have&nbsp;tested&nbsp;the&nbsp;issue&nbsp;with&nbsp;LARGE&nbsp;ROCK&nbsp;and&nbsp;not&nbsp;AUFS&nbsp;or&nbsp;UFS.&lt;br/&gt;<br>
&gt;&gt;&nbsp;Using&nbsp;squid&nbsp;or&nbsp;not&nbsp;my&nbsp;connection&nbsp;to&nbsp;the&nbsp;server&nbsp;is&nbsp;about&nbsp;2.5&nbsp;MBps&nbsp;(20Mbps).&lt;br/&gt;<br>
&gt;&gt;&nbsp;Squid&nbsp;is&nbsp;sitting&nbsp;on&nbsp;an&nbsp;intel&nbsp;atom&nbsp;with&nbsp;SSD&nbsp;drive&nbsp;and&nbsp;on&nbsp;a&nbsp;HIT&nbsp;case&nbsp;the&lt;br/&gt;<br>
&gt;&gt;&nbsp;download&nbsp;speed&nbsp;is&nbsp;more&nbsp;then&nbsp;doubled&nbsp;to&nbsp;4.5&nbsp;MBps(36Mbps).&lt;br/&gt;<br>
&gt;&gt;&nbsp;I&nbsp;have&nbsp;not&nbsp;tried&nbsp;it&nbsp;with&nbsp;AUFS&nbsp;yet.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;And&nbsp;I&nbsp;must&nbsp;admit&nbsp;that&nbsp;AUFS&nbsp;beats&nbsp;rock&nbsp;cache&nbsp;with&nbsp;speed.&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;tried&nbsp;rock&nbsp;with&nbsp;basic&nbsp;&quot;cache_dir&nbsp;rock&nbsp;/var/spool/squid&nbsp;8000&quot;&nbsp;vs&lt;br/&gt;<br>
&gt;&nbsp;&quot;cache_dir&nbsp;aufs&nbsp;/var/spool/squid&nbsp;8000&nbsp;16&nbsp;256&quot;&nbsp;and&nbsp;the&nbsp;aufs&nbsp;cache&nbsp;HIT&lt;br/&gt;<br>
&gt;&nbsp;results&nbsp;more&nbsp;then&nbsp;doubles&nbsp;3&nbsp;the&nbsp;speed&nbsp;rock&nbsp;gave&nbsp;with&nbsp;default&nbsp;settings.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;So&nbsp;about&nbsp;15MBps&nbsp;which&nbsp;is&nbsp;120Mbps.&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;do&nbsp;not&nbsp;seem&nbsp;to&nbsp;feel&nbsp;what&nbsp;Jens&nbsp;feels&nbsp;but&nbsp;the&nbsp;100%&nbsp;CPU&nbsp;might&nbsp;be&nbsp;because&lt;br/&gt;<br>
&gt;&nbsp;of&nbsp;spinning&nbsp;disk&nbsp;hangs&nbsp;while&nbsp;reading&nbsp;the&nbsp;file&nbsp;from&nbsp;disk.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;Amos,&nbsp;I&nbsp;remember&nbsp;that&nbsp;there&nbsp;were&nbsp;some&nbsp;suggestions&nbsp;how&nbsp;to&nbsp;tune&nbsp;large&nbsp;rock.&lt;br/&gt;<br>
&gt;&nbsp;Any&nbsp;hints?&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;can&nbsp;test&nbsp;it&nbsp;and&nbsp;make&nbsp;it&nbsp;a&nbsp;suggestion&nbsp;for&nbsp;big&nbsp;files.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;Eliezer&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br/&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br/&gt;<br>
&gt;&nbsp;squid-users@lists.squid-cache.org&lt;br/&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br/&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br/&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br/&gt;<br>
&gt;&nbsp;squid-users@lists.squid-cache.org&lt;br/&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br/&gt;<br>
&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>
<br>

</tt>
