<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;Thanks,&nbsp;Amos.&nbsp;That&nbsp;was&nbsp;very&nbsp;helpful.&nbsp;Smoothwall&nbsp;Express&nbsp;does&nbsp;not&nbsp;and&nbsp;never&nbsp;has&nbsp;used&nbsp;systemd,&nbsp;precisely&nbsp;because&nbsp;of&nbsp;the&nbsp;reasons&nbsp;you&nbsp;mention.&nbsp;It&nbsp;does&nbsp;use&nbsp;udev&nbsp;and&nbsp;we&nbsp;are&nbsp;considering&nbsp;bumping&nbsp;to&nbsp;eudev,&nbsp;but&nbsp;that&nbsp;is&nbsp;a&nbsp;fairly&nbsp;large&nbsp;change,&nbsp;but&nbsp;likely&nbsp;worth&nbsp;it.&lt;br&gt;&lt;br&gt;&lt;/div&gt;We&nbsp;have&nbsp;some&nbsp;things&nbsp;to&nbsp;think&nbsp;about&nbsp;now&nbsp;with&nbsp;possibly&nbsp;redesigning&nbsp;the&nbsp;system&nbsp;shutdown.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Stan&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Jul&nbsp;24,&nbsp;2015&nbsp;at&nbsp;8:10&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Response&nbsp;inline.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
On&nbsp;24/07/2015&nbsp;8:21&nbsp;a.m.,&nbsp;Stanford&nbsp;Prescott&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;After&nbsp;bumping&nbsp;Squid&nbsp;from&nbsp;3.4.x&nbsp;to&nbsp;3.5.x&nbsp;in&nbsp;our&nbsp;implementation&nbsp;of&nbsp;Squid&nbsp;in&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;Smoothwall&nbsp;Express&nbsp;v3.1&nbsp;firewall&nbsp;distro&nbsp;we&nbsp;have&nbsp;begun&nbsp;to&nbsp;have&lt;br&gt;<br>
&gt;&nbsp;complaints&nbsp;from&nbsp;our&nbsp;users&nbsp;about&nbsp;&quot;erratic&nbsp;behavior&quot;&nbsp;of&nbsp;Squid&nbsp;shutting&nbsp;down&lt;br&gt;<br>
&gt;&nbsp;during&nbsp;reboots&nbsp;or&nbsp;network&nbsp;drops&nbsp;causing&nbsp;reboots.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;appears&nbsp;that&nbsp;squid&nbsp;(v3.5.[5-6])&nbsp;does&nbsp;not&nbsp;respond&nbsp;well&nbsp;to&nbsp;SIGTERM&nbsp;during&lt;br&gt;<br>
&gt;&nbsp;system&nbsp;shutdown;&nbsp;the&nbsp;cache&nbsp;index&nbsp;almost&nbsp;invariably&nbsp;needs&nbsp;to&nbsp;be&nbsp;rebuilt&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;next&nbsp;boot.&nbsp;It&nbsp;is&nbsp;suggested&nbsp;that&nbsp;we&nbsp;use&nbsp;squid&nbsp;to&nbsp;shut&nbsp;squid&nbsp;down.&nbsp;While&lt;br&gt;<br>
&gt;&nbsp;using&nbsp;squid&nbsp;to&nbsp;stop&nbsp;the&nbsp;squid&nbsp;daemon&nbsp;is&nbsp;very&nbsp;doable,&nbsp;this&nbsp;requirement&nbsp;runs&lt;br&gt;<br>
&gt;&nbsp;contrary&nbsp;to&nbsp;the&nbsp;longstanding,&nbsp;traditional&nbsp;UNIX&nbsp;method&nbsp;of&nbsp;&quot;SIGTERM,&nbsp;pause,&lt;br&gt;<br>
&gt;&nbsp;SIGKILL&quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Squid&nbsp;is&nbsp;designed&nbsp;to&nbsp;operate&nbsp;in&nbsp;UNIX&nbsp;style.&nbsp;It&nbsp;contains&nbsp;its&nbsp;own&nbsp;daemon&lt;br&gt;<br>
manager,&nbsp;and&nbsp;a&nbsp;worker&nbsp;process.&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;SIGTERM&nbsp;is&nbsp;received&nbsp;by&nbsp;the&nbsp;manager&nbsp;process,&nbsp;it&nbsp;relays&nbsp;that&nbsp;to&nbsp;the&lt;br&gt;<br>
worker&nbsp;which&nbsp;begins&nbsp;shutdown&nbsp;immediately&nbsp;but&nbsp;with&nbsp;shutdown_lifetime&lt;br&gt;<br>
grace&nbsp;period&nbsp;for&nbsp;active&nbsp;clients&nbsp;to&nbsp;finish.&nbsp;A&nbsp;second&nbsp;SIGTERM&nbsp;will&nbsp;act&lt;br&gt;<br>
like&nbsp;shutdown_lifetime&nbsp;having&nbsp;expired,&nbsp;everything&nbsp;gets&nbsp;closed&nbsp;immediately.&lt;br&gt;<br>
&lt;br&gt;<br>
SIGKILL&nbsp;causes&nbsp;the&nbsp;OS&nbsp;init&nbsp;system&nbsp;to&nbsp;erase&nbsp;the&nbsp;Squid&nbsp;processes&nbsp;from&lt;br&gt;<br>
system&nbsp;memory,&nbsp;aborts&nbsp;all&nbsp;the&nbsp;open&nbsp;sockets&nbsp;and&nbsp;disk&nbsp;I/O,&nbsp;etc.&nbsp;The&lt;br&gt;<br>
nuclear&nbsp;option&nbsp;as&nbsp;some&nbsp;often&nbsp;called&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;causes&nbsp;issues&nbsp;with&nbsp;systemd,&nbsp;openrc,&nbsp;or&nbsp;upstart&nbsp;where&nbsp;the&nbsp;init&lt;br&gt;<br>
system&nbsp;insists&nbsp;on&nbsp;being&nbsp;a&nbsp;daemon&nbsp;manager&nbsp;itself.&nbsp;IIRC&nbsp;there&nbsp;was&nbsp;an&lt;br&gt;<br>
excellent&nbsp;tutorial&nbsp;somewhere&nbsp;(by&nbsp;DJB?)&nbsp;that&nbsp;explained&nbsp;in&nbsp;great&nbsp;detail&lt;br&gt;<br>
why&nbsp;having&nbsp;a&nbsp;daemon&nbsp;manager&nbsp;to&nbsp;operate&nbsp;other&nbsp;daemon&nbsp;managers&nbsp;was&nbsp;a&lt;br&gt;<br>
terrible&nbsp;idea.&nbsp;Squid&nbsp;hits&nbsp;pretty&nbsp;much&nbsp;all&nbsp;the&nbsp;relevant&nbsp;nasty&nbsp;side&lt;br&gt;<br>
effects&nbsp;as&nbsp;each&nbsp;piece&nbsp;of&nbsp;the&nbsp;system&nbsp;makes&nbsp;bad&nbsp;assumptions&nbsp;or&nbsp;gets&lt;br&gt;<br>
confused&nbsp;about&nbsp;other&nbsp;bits&nbsp;activities.&lt;br&gt;<br>
&lt;br&gt;<br>
Meanwhile&nbsp;if&nbsp;just&nbsp;left&nbsp;alone&nbsp;the&nbsp;worker&nbsp;is&nbsp;still&nbsp;trying&nbsp;to&nbsp;gracefully&lt;br&gt;<br>
close&nbsp;client&nbsp;transactions&nbsp;for&nbsp;shutdown_lifetime&nbsp;(30sec&nbsp;default).&nbsp;Then&lt;br&gt;<br>
abort&nbsp;those&nbsp;and&nbsp;save&nbsp;the&nbsp;final&nbsp;cache&nbsp;index&nbsp;to&nbsp;a&nbsp;new&nbsp;swap.state&nbsp;file&nbsp;on&nbsp;disk.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;During&nbsp;normal&nbsp;system&nbsp;operation,&nbsp;squid&nbsp;*ought*&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;take&nbsp;as&nbsp;much&lt;br&gt;<br>
&gt;&nbsp;time&nbsp;as&nbsp;it&nbsp;wants&nbsp;to&nbsp;shut&nbsp;down.&nbsp;But&nbsp;it&nbsp;still&nbsp;shouldn&#39;t&nbsp;take&nbsp;more&nbsp;than&nbsp;10-20&lt;br&gt;<br>
&gt;&nbsp;seconds;&nbsp;&#39;shutdown&#39;&nbsp;is&nbsp;a&nbsp;command,&nbsp;not&nbsp;a&nbsp;request&nbsp;to&nbsp;be&nbsp;honored&nbsp;at&nbsp;squid&#39;s&lt;br&gt;<br>
&gt;&nbsp;leisure.&nbsp;After&nbsp;all,&nbsp;the&nbsp;CPU&nbsp;could&nbsp;be&nbsp;on&nbsp;fire....&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;This&nbsp;raises&nbsp;a&nbsp;few&nbsp;questions&nbsp;that&nbsp;are&nbsp;intended&nbsp;to&nbsp;foster&nbsp;fresh&nbsp;discussion,&lt;br&gt;<br>
&gt;&nbsp;not&nbsp;to&nbsp;re-hash&nbsp;old&nbsp;arguments.&nbsp;They&nbsp;are&nbsp;really&nbsp;more&nbsp;rhetorical&nbsp;in&nbsp;nature;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;goal&nbsp;is&nbsp;to&nbsp;find&nbsp;the&nbsp;root&nbsp;cause&nbsp;of&nbsp;the&nbsp;problem.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;/span&gt;&gt; &nbsp; &nbsp;-&nbsp;Why&nbsp;do&nbsp;these&nbsp;latest&nbsp;versions&nbsp;of&nbsp;Squid&nbsp;3&nbsp;behave&nbsp;oddly&nbsp;in&nbsp;this&nbsp;respect?&lt;br&gt;<br>
&lt;br&gt;<br>
systemd&nbsp;is&nbsp;becoming&nbsp;popular.&nbsp;See&nbsp;above.&nbsp;Impatience&nbsp;and&nbsp;incorrect&nbsp;init&lt;br&gt;<br>
scripts&nbsp;using&nbsp;SIGKIL&nbsp;instead&nbsp;of&nbsp;SIGTERM&nbsp;does&nbsp;seem&nbsp;to&nbsp;be&nbsp;the&nbsp;main&nbsp;pathway&lt;br&gt;<br>
to&nbsp;having&nbsp;issues.&lt;br&gt;<br>
&lt;br&gt;<br>
Squid-3&nbsp;has&nbsp;become&nbsp;a&nbsp;SMP&nbsp;multi-process&nbsp;thing.&nbsp;Which&nbsp;increases&nbsp;the&nbsp;number&lt;br&gt;<br>
of&nbsp;workers,&nbsp;and&nbsp;things&nbsp;they&nbsp;are&nbsp;still&nbsp;doing&nbsp;during&nbsp;shtutdown.&lt;br&gt;<br>
&lt;br&gt;<br>
Squid-3.1&nbsp;&amp;&nbsp;3.2&nbsp;added&nbsp;various&nbsp;checksums&nbsp;to&nbsp;swap.state&nbsp;format&nbsp;protecting&lt;br&gt;<br>
against&nbsp;file&nbsp;corruption&nbsp;propigating&nbsp;into&nbsp;the&nbsp;memory&nbsp;index&nbsp;of&nbsp;next&lt;br&gt;<br>
started&nbsp;Squid&nbsp;process.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;What&nbsp;is&nbsp;it&nbsp;about&nbsp;shutting&nbsp;squid&nbsp;down&nbsp;that&nbsp;corrupts&nbsp;the&nbsp;cache&nbsp;index?&lt;br&gt;<br>
&lt;br&gt;<br>
&quot;corruption&quot;&nbsp;in&nbsp;the&nbsp;cache&nbsp;index&nbsp;means&nbsp;the&nbsp;swap.state&nbsp;file&nbsp;for&nbsp;each&nbsp;cache&lt;br&gt;<br>
has&nbsp;not&nbsp;been&nbsp;completely&nbsp;written.&nbsp;On&nbsp;next&nbsp;load&nbsp;the&nbsp;file&nbsp;checksum&nbsp;does&nbsp;not&lt;br&gt;<br>
match&nbsp;the&nbsp;contents&nbsp;checksum.&nbsp;So&nbsp;reverts&nbsp;to&nbsp;a&nbsp;relatively&nbsp;slow&nbsp;scan&nbsp;of&nbsp;the&lt;br&gt;<br>
disk&nbsp;to&nbsp;see&nbsp;what&nbsp;is&nbsp;there.&lt;br&gt;<br>
&lt;br&gt;<br>
SIGKILL&nbsp;being&nbsp;used&nbsp;during&nbsp;the&nbsp;time&nbsp;that&nbsp;index&nbsp;is&nbsp;being&nbsp;written&nbsp;to&nbsp;disk&lt;br&gt;<br>
FD&nbsp;will&nbsp;cause&nbsp;it&nbsp;nearly&nbsp;100%&nbsp;of&nbsp;the&nbsp;time.&nbsp;Being&nbsp;used&nbsp;before&nbsp;old&lt;br&gt;<br>
swap.state&nbsp;is&nbsp;replaced&nbsp;will&nbsp;lead&nbsp;to&nbsp;a&nbsp;lot&nbsp;of&nbsp;SWAPFAIL&nbsp;as&nbsp;objects&nbsp;on&nbsp;disk&lt;br&gt;<br>
today&nbsp;dont&nbsp;match&nbsp;what&nbsp;was&nbsp;on&nbsp;disk&nbsp;when&nbsp;Squid&nbsp;restarted&nbsp;a&nbsp;week&nbsp;ago.&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;corruption&nbsp;happens&nbsp;also&nbsp;varies&nbsp;between&nbsp;disk&nbsp;controllers.&nbsp;Some&lt;br&gt;<br>
controllers&nbsp;complete&nbsp;already&nbsp;scheduled&nbsp;writes.&nbsp;Some&nbsp;drop&nbsp;them.&nbsp;SIGKILL&lt;br&gt;<br>
may&nbsp;be&nbsp;relevant&nbsp;in&nbsp;that&nbsp;decision&nbsp;too.&nbsp;The&nbsp;ones&nbsp;that&nbsp;complete&nbsp;all&lt;br&gt;<br>
scheduled&nbsp;writes&nbsp;and&nbsp;close&nbsp;the&nbsp;file&nbsp;hit&nbsp;corruption&nbsp;less&nbsp;often,&nbsp;or&nbsp;less&lt;br&gt;<br>
badly.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Does&nbsp;it&nbsp;take&nbsp;more&nbsp;than&nbsp;a&nbsp;few&nbsp;seconds&nbsp;to&nbsp;write&nbsp;the&nbsp;index&nbsp;to&nbsp;disk?&lt;br&gt;<br>
&lt;br&gt;<br>
No.&nbsp;But&nbsp;it&nbsp;can&nbsp;take&nbsp;days&nbsp;for&nbsp;active&nbsp;clients&nbsp;to&nbsp;finish&nbsp;off&nbsp;long-polling&lt;br&gt;<br>
HTTP&nbsp;requests&nbsp;or&nbsp;CONNECT&nbsp;tunnels.&nbsp;shutdown_lifetime&nbsp;is&nbsp;what&nbsp;they&nbsp;are&lt;br&gt;<br>
allowed.&nbsp;IME,&nbsp;Squid&nbsp;workers&nbsp;usually&nbsp;completely&nbsp;exit&nbsp;within&nbsp;5&nbsp;seconds&nbsp;of&lt;br&gt;<br>
that&nbsp;grace&nbsp;period&nbsp;being&nbsp;over.&nbsp;It&nbsp;takes&nbsp;under&nbsp;a&nbsp;ms&nbsp;to&nbsp;close&nbsp;a&nbsp;socket,&nbsp;but&lt;br&gt;<br>
many&nbsp;tens&nbsp;of&nbsp;thousands&nbsp;of&nbsp;sockets&nbsp;may&nbsp;be&nbsp;open&nbsp;on&nbsp;a&nbsp;busy&nbsp;proxy.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Does&nbsp;squid&nbsp;use&nbsp;the&nbsp;very&nbsp;slow&nbsp;&#39;writethrough&#39;&nbsp;method&nbsp;instead&nbsp;of&nbsp;trusting&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt; &nbsp; &nbsp;the&nbsp;Linux&nbsp;disk&nbsp;cache&nbsp;to&nbsp;properly&nbsp;save&nbsp;the&nbsp;cache?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Squid&nbsp;is&nbsp;generating&nbsp;new&nbsp;content&nbsp;and&nbsp;writing&nbsp;it&nbsp;to&nbsp;a&nbsp;file&nbsp;with&nbsp;write(2)&lt;br&gt;<br>
API.&nbsp;That&nbsp;content&nbsp;is&nbsp;anything&nbsp;up&nbsp;to&nbsp;68MB&nbsp;in&nbsp;size&nbsp;*per&nbsp;cache_dir*.&nbsp;How&lt;br&gt;<br>
fast&nbsp;can&nbsp;your&nbsp;disk&nbsp;save&nbsp;that&nbsp;much&nbsp;data&nbsp;when&nbsp;its&nbsp;passed&nbsp;in&nbsp;~100&nbsp;byte&nbsp;IO&lt;br&gt;<br>
chunks?&lt;br&gt;<br>
 Whatever&nbsp;OS&nbsp;filesystem&nbsp;does&nbsp;to&nbsp;optimize&nbsp;I/O&nbsp;happens&nbsp;on&nbsp;top&nbsp;of&nbsp;that&lt;br&gt;<br>
process-level&nbsp;activity.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;mentioned&nbsp;above&nbsp;SIGKILL&nbsp;also&nbsp;does&nbsp;not&nbsp;shutdown&nbsp;the&nbsp;process&nbsp;(that&lt;br&gt;<br>
would&nbsp;be&nbsp;SIGTERM).&nbsp;Just&nbsp;drops&nbsp;it&nbsp;all&nbsp;on&nbsp;the&nbsp;floor.&nbsp;Using&nbsp;SIGKILL&nbsp;on&nbsp;a&lt;br&gt;<br>
process&nbsp;currently&nbsp;writing&nbsp;to&nbsp;disk&nbsp;has&nbsp;varying&nbsp;results&nbsp;from&nbsp;the&nbsp;disk&lt;br&gt;<br>
driver&nbsp;layers&nbsp;-&nbsp;usually&nbsp;not&nbsp;good.&lt;br&gt;<br>
&lt;br&gt;<br>
SIGTERM&nbsp;will&nbsp;almost&nbsp;guarantee&nbsp;the&nbsp;files&nbsp;complete&nbsp;writing&nbsp;and&nbsp;things&nbsp;get&lt;br&gt;<br>
gracefully&nbsp;resolved.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;haven&#39;t&nbsp;guessed&nbsp;already&nbsp;IMO&nbsp;you&nbsp;should&nbsp;at&nbsp;worst&nbsp;use&nbsp;SIGTERM&nbsp;twice&lt;br&gt;<br>
on&nbsp;Squid&nbsp;instead&nbsp;of&nbsp;SIGKILL&nbsp;even&nbsp;once.&nbsp;If&nbsp;Squid&nbsp;is&nbsp;actually&nbsp;operational&lt;br&gt;<br>
a&nbsp;second&nbsp;SIGTERM&nbsp;will&nbsp;have&nbsp;the&nbsp;same&nbsp;effect&nbsp;as&nbsp;shutdown_lifetime&nbsp;having&lt;br&gt;<br>
finished&nbsp;early.&lt;br&gt;<br>
&lt;br&gt;<br>
Sadly&nbsp;systemd&nbsp;and&nbsp;init&nbsp;scripts&nbsp;can&nbsp;be&nbsp;rather&nbsp;friendly&nbsp;with&nbsp;SIGKILL.&lt;br&gt;<br>
Which&nbsp;can&nbsp;be&nbsp;problematic.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Should&nbsp;squid&nbsp;write&nbsp;the&nbsp;cache&nbsp;index&nbsp;to&nbsp;disk&nbsp;more&nbsp;often?&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;cache&nbsp;index&nbsp;is&nbsp;extremely&nbsp;volatile.&nbsp;Every&nbsp;single&nbsp;request&nbsp;through&nbsp;it&lt;br&gt;<br>
adds&nbsp;or&nbsp;removes&nbsp;an&nbsp;entry.&nbsp;Which&nbsp;is&nbsp;a&nbsp;lot&nbsp;of&nbsp;disk&nbsp;overhead&nbsp;on&nbsp;a&nbsp;very&nbsp;busy&lt;br&gt;<br>
proxy.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;compromise&nbsp;is&nbsp;to&nbsp;write&nbsp;it&nbsp;only&nbsp;once&nbsp;on&nbsp;shutdown/restart&nbsp;when&nbsp;all&lt;br&gt;<br>
updates&nbsp;have&nbsp;been&nbsp;finished.&nbsp;Or&nbsp;on&nbsp;&quot;-k&nbsp;rotate&quot;&nbsp;(SIGHUP)&nbsp;when&nbsp;explicitly&lt;br&gt;<br>
asked&nbsp;to&nbsp;auto-save&nbsp;all&nbsp;state&nbsp;for&nbsp;log&nbsp;file&nbsp;rotations.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Should&nbsp;squid&nbsp;track&nbsp;its&nbsp;own&nbsp;&#39;dirty&nbsp;pages&#39;&nbsp;in&nbsp;its&nbsp;in-core&nbsp;index&nbsp;to&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt; &nbsp; &nbsp;reduce&nbsp;the&nbsp;time&nbsp;it&nbsp;takes&nbsp;to&nbsp;write&nbsp;the&nbsp;index?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;There&nbsp;is&nbsp;not&nbsp;much&nbsp;to&nbsp;track.&nbsp;The&nbsp;&quot;pages&quot;&nbsp;as&nbsp;it&nbsp;were&nbsp;are&nbsp;little&nbsp;marker&lt;br&gt;<br>
records&nbsp;a&nbsp;few&nbsp;hundred&nbsp;bytes&nbsp;stating&nbsp;what&nbsp;HTTP&nbsp;message&nbsp;is&nbsp;contained&nbsp;in&lt;br&gt;<br>
any&nbsp;given&nbsp;on-disk&nbsp;file.&nbsp;The&nbsp;memory&nbsp;copy&nbsp;gets&nbsp;erased&nbsp;as&nbsp;soon&nbsp;as&nbsp;the&nbsp;disk&lt;br&gt;<br>
controller&nbsp;has&nbsp;been&nbsp;asked&nbsp;to&nbsp;delete&nbsp;the&nbsp;file.&nbsp;The&nbsp;running&nbsp;worker&nbsp;does&lt;br&gt;<br>
not&nbsp;track&nbsp;whether&nbsp;the&nbsp;delete&nbsp;worked&nbsp;or&nbsp;not,&nbsp;just&nbsp;that&nbsp;all&nbsp;index&nbsp;entries&lt;br&gt;<br>
are&nbsp;supposedly&nbsp;valid&nbsp;HTTP&nbsp;objects.&nbsp;Whatever&nbsp;files&nbsp;get&nbsp;left&nbsp;undeleted&nbsp;on&lt;br&gt;<br>
disk&nbsp;can&nbsp;be&nbsp;overwritten&nbsp;with&nbsp;new&nbsp;content.&nbsp;[enter&nbsp;a&nbsp;few&nbsp;race&nbsp;condition&nbsp;bugs].&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;shutdown&nbsp;the&nbsp;(up&nbsp;to&nbsp;2^27&nbsp;x&nbsp;512&nbsp;bytes)&nbsp;set&nbsp;of&nbsp;then-valid&nbsp;records&nbsp;are&lt;br&gt;<br>
dumped&nbsp;to&nbsp;disk&nbsp;in&nbsp;a&nbsp;new&nbsp;swap.state.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Should&nbsp;squid&nbsp;implement&nbsp;a&nbsp;journal&nbsp;(akin&nbsp;to&nbsp;EXT/ReiserFS&nbsp;and&nbsp;others)&nbsp;so&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt; &nbsp; &nbsp;the&nbsp;on-disk&nbsp;index&nbsp;structure&nbsp;is&nbsp;always&nbsp;OK?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Been&nbsp;tried.&nbsp;store_log&nbsp;is&nbsp;the&nbsp;journal.&nbsp;You&nbsp;can&nbsp;turn&nbsp;it&nbsp;on&nbsp;if&nbsp;you&nbsp;have&nbsp;any&lt;br&gt;<br>
need&nbsp;for&nbsp;external&nbsp;software&nbsp;to&nbsp;track&nbsp;what&nbsp;Squid&nbsp;cache&nbsp;contains&nbsp;in&nbsp;near&lt;br&gt;<br>
real-time.&lt;br&gt;<br>
&lt;br&gt;<br>
Overall&nbsp;it&nbsp;slows&nbsp;Squid&nbsp;down&nbsp;and&nbsp;it&nbsp;is&nbsp;not&nbsp;useful&nbsp;to&nbsp;remember&nbsp;objects&lt;br&gt;<br>
that&nbsp;were&nbsp;saved&nbsp;X&nbsp;days&nbsp;ago&nbsp;and&nbsp;deleted&nbsp;a&nbsp;few&nbsp;seconds&nbsp;later.&lt;br&gt;<br>
&lt;br&gt;<br>
Wont&nbsp;protect&nbsp;against&nbsp;swap.state&nbsp;corruption&nbsp;anyway,&nbsp;since&nbsp;the&nbsp;journal/log&lt;br&gt;<br>
file&nbsp;would&nbsp;get&nbsp;truncated/corrupted&nbsp;in&nbsp;the&nbsp;same&nbsp;ways&nbsp;as&nbsp;swap.state.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Is&nbsp;the&nbsp;problem&nbsp;related&nbsp;to&nbsp;clients&nbsp;actively&nbsp;receiving&nbsp;web&nbsp;pages&nbsp;from&lt;br&gt;<br>
&gt; &nbsp; &nbsp;squid?&lt;br&gt;<br>
&lt;br&gt;<br>
Indirectly.&nbsp;They&nbsp;delay&nbsp;added&nbsp;by&nbsp;waiting&nbsp;for&nbsp;them&nbsp;increases&nbsp;the&lt;br&gt;<br>
impatience&nbsp;of&nbsp;external&nbsp;daemon&nbsp;managers&nbsp;and&nbsp;admins&nbsp;chance&nbsp;of&nbsp;using&lt;br&gt;<br>
SIGKILL&nbsp;on&nbsp;the&nbsp;worker.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Could&nbsp;squid&#39;s&nbsp;signal&nbsp;handling&nbsp;be&nbsp;adjusted&nbsp;to&nbsp;treat&nbsp;those&nbsp;clients&nbsp;more&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt; &nbsp; &nbsp;harshly?&nbsp;That&nbsp;is,&nbsp;terminate&nbsp;the&nbsp;transfers&nbsp;early&nbsp;because&nbsp;squid&nbsp;shutting&nbsp;down&lt;br&gt;<br>
&gt; &nbsp; &nbsp;is&nbsp;much&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;network&nbsp;interface&nbsp;going&nbsp;down.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;It&nbsp;could.&nbsp;I&nbsp;have&nbsp;actually&nbsp;just&nbsp;applied&nbsp;a&nbsp;patch&nbsp;to&nbsp;Squid-4&nbsp;that&nbsp;makes&lt;br&gt;<br>
Squid&nbsp;abort&nbsp;idle&nbsp;client&nbsp;connections&nbsp;on&nbsp;teh&nbsp;first&nbsp;SIGTERM&nbsp;and&nbsp;more&lt;br&gt;<br>
cleanly&nbsp;close&nbsp;*all*&nbsp;client&nbsp;FDs&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;shutdown_lifetime&nbsp;(or&lt;br&gt;<br>
second&nbsp;SIGTERM)&nbsp;before&nbsp;it&nbsp;uses&nbsp;abort()&nbsp;on&nbsp;whats&nbsp;left.&nbsp;That&nbsp;will&nbsp;probably&lt;br&gt;<br>
be&nbsp;in&nbsp;3.5.7&nbsp;as&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
Hopefully&nbsp;that&nbsp;will&nbsp;result&nbsp;in&nbsp;less&nbsp;SWAPFAIL&nbsp;corruption&nbsp;issues&nbsp;in&nbsp;future&lt;br&gt;<br>
for&nbsp;some&nbsp;people.&nbsp;It&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;help&nbsp;with&nbsp;swap.fail&nbsp;corruption&nbsp;since&lt;br&gt;<br>
thet&nbsp;is&nbsp;a&nbsp;step&nbsp;later.&lt;br&gt;<br>
&lt;br&gt;<br>
Long&nbsp;term&nbsp;plan&nbsp;is&nbsp;to&nbsp;handle&nbsp;shutdown&nbsp;in&nbsp;such&nbsp;a&nbsp;way&nbsp;that&nbsp;non-busy&nbsp;Squid&lt;br&gt;<br>
may&nbsp;even&nbsp;exit&nbsp;before&nbsp;shutdown_lifetime&nbsp;is&nbsp;over.&nbsp;Which&nbsp;should&nbsp;definitely&lt;br&gt;<br>
include&nbsp;proper&nbsp;swap.state&nbsp;closure.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Is&nbsp;the&nbsp;only&nbsp;viable&nbsp;solution&nbsp;to&nbsp;use&nbsp;squid&nbsp;to&nbsp;stop&nbsp;the&nbsp;daemon?&nbsp;Does&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt; &nbsp; &nbsp;&#39;squid&nbsp;-k&nbsp;shutdown&#39;&nbsp;exit&nbsp;only&nbsp;after&nbsp;the&nbsp;daemon&nbsp;is&nbsp;dead?&nbsp;The&nbsp;squid&nbsp;man&nbsp;page&lt;br&gt;<br>
&gt; &nbsp; &nbsp;indicates&nbsp;that&nbsp;it&nbsp;sends&nbsp;the&nbsp;shutdown&nbsp;&#39;signal&#39;&nbsp;but&nbsp;does&nbsp;not&nbsp;await&nbsp;a&nbsp;reply;&lt;br&gt;<br>
&gt; &nbsp; &nbsp;thus&nbsp;a&nbsp;potentially&nbsp;lengthy&nbsp;pause&nbsp;in&nbsp;system&nbsp;shutdown&nbsp;may&nbsp;be&nbsp;required&nbsp;anyway.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;The&nbsp;man&nbsp;page&nbsp;is&nbsp;correct.&nbsp;&quot;squid&nbsp;-k&nbsp;shutdown&quot;&nbsp;sends&nbsp;a&nbsp;SIGTERM&nbsp;signal&nbsp;to&lt;br&gt;<br>
the&nbsp;process&nbsp;listed&nbsp;in&nbsp;squids&nbsp;PID&nbsp;file.&lt;br&gt;<br>
 NP:&nbsp;any&nbsp;other&nbsp;UNIX&nbsp;style&nbsp;process&nbsp;could&nbsp;happily&nbsp;do&nbsp;the&nbsp;same&nbsp;to&nbsp;control&lt;br&gt;<br>
Squid.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;-k&nbsp;process&nbsp;itself&nbsp;exits&nbsp;immediately&nbsp;when&nbsp;that&nbsp;signal&nbsp;is&nbsp;sent.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;running&nbsp;squid&nbsp;daemon&nbsp;manager&nbsp;(or&nbsp;coordinator)&nbsp;process&nbsp;handles&nbsp;that&lt;br&gt;<br>
signal&nbsp;as&nbsp;mentioned&nbsp;above.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Is&nbsp;pausing&nbsp;the&nbsp;system&nbsp;shutdown&nbsp;for&nbsp;10-15&nbsp;seconds&nbsp;the&nbsp;only&nbsp;really&lt;br&gt;<br>
&gt; &nbsp; &nbsp;viable&nbsp;shutdown&nbsp;solution?&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;current&nbsp;Squid&nbsp;releases&nbsp;yes.&nbsp;The&nbsp;alternative&nbsp;is&nbsp;to&nbsp;risk&nbsp;the&nbsp;corruption&lt;br&gt;<br>
problems.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp;-&nbsp;Or&nbsp;is&nbsp;it&nbsp;best&nbsp;to&nbsp;delete&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;cache&nbsp;index&nbsp;on&nbsp;every&nbsp;system&lt;br&gt;<br>
&gt; &nbsp; &nbsp;startup?&lt;br&gt;<br>
&lt;br&gt;<br>
No.&nbsp;Just&nbsp;configure&nbsp;shutdown_lifetime&nbsp;to&nbsp;a&nbsp;few&nbsp;seconds,&nbsp;and&nbsp;require&nbsp;the&lt;br&gt;<br>
init&nbsp;scripts&nbsp;system&nbsp;to&nbsp;wait&nbsp;that&nbsp;long&nbsp;plus&nbsp;2-3&nbsp;more&nbsp;sec&nbsp;for&nbsp;the&nbsp;whole&lt;br&gt;<br>
bunch&nbsp;of&nbsp;Squid&nbsp;processes&nbsp;to&nbsp;complete&nbsp;normally.&nbsp;Use&nbsp;SIGTERM&nbsp;if&nbsp;really&lt;br&gt;<br>
necessary&nbsp;to&nbsp;speed&nbsp;things&nbsp;up.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;a&nbsp;occasional&nbsp;exceptions,&nbsp;you&nbsp;may&nbsp;be&nbsp;one,&nbsp;but&nbsp;for&nbsp;most&lt;br&gt;<br>
installations&nbsp;it&nbsp;seems&nbsp;to&nbsp;still&nbsp;work&nbsp;fine&nbsp;that&nbsp;way.&lt;br&gt;<br>
&lt;br&gt;<br>
HTH&lt;br&gt;<br>
Amos&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
