##########################
##                      ##
## Standard Definations ##
##                      ##
##########################
# Hostname
visible_hostname <obscurred>

# Squid Listen Ports
http_port 127.0.0.1:3128
http_port 127.0.0.1:3129 ssl-bump cert=/etc/squid/certs/<obscurred>.root.cert.pem key=/etc/squid/certs/<obscurred>.root.key.pem generate-host-certificates=on version=1 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
http_port 127.0.0.1:3130 intercept
https_port 127.0.0.1:3131 cert=/etc/squid/certs/<obscurred>.root.cert.pem key=/etc/squid/certs/<obscurred>.root.key.pem ssl-bump intercept generate-host-certificates=on version=1 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE

http_port 172.18.1.2:3128
http_port 172.18.1.2:3129 ssl-bump cert=/etc/squid/certs/<obscurred>.root.cert.pem key=/etc/squid/certs/<obscurred>.root.key.pem generate-host-certificates=on version=1 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
http_port 172.18.1.2:3130 intercept
https_port 172.18.1.2:3131 cert=/etc/squid/certs/<obscurred>.root.cert.pem key=/etc/squid/certs/<obscurred>.root.key.pem ssl-bump intercept generate-host-certificates=on version=1 options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE

# Local IP
dns_v4_first on
tcp_outgoing_address <obscurred> all

# Access Log
logformat csv %ts.%03tu@@%>a@@%err_code@@%03>Hs@@%Ss@@%[un@@%#>ru@@%rm@@%mt
access_log stdio:/var/log/squid/access.log logformat=csv

# Prevent access log from trimming long urls
strip_query_terms off

# DNS Nameservers
dns_nameservers 172.18.1.2

# SSL prevent bumping some sites
# Microsoft Windows Update
acl broken_ssl_regex dstdom_regex -i (^|\.)(update|windowsupdate|metaservices|c|crl|sls|one|ntservicepack|urs)\.microsoft\.com$ (^|\.)wustat\.windows\.com (^|\.)download\.windowsupdate\.com$ (^|\.)akamai\.net$ (^|\.)msftncsi\.com$
# Allegiant Airlines
acl broken_ssl_regex dstdom_regex -i (^|\.)allegiantair\.com$
# Bob Barker
acl broken_ssl_regex dstdom_regex -i (^|\.)bobbarker\.com$
# Dropbox App
acl broken_ssl_regex dstdom_regex -i (^|\.)(dropbox|dropboxusercontent)\.com$
# iTunes
acl broken_ssl_regex dstdom_regex -i (^|\.)itunes\.apple\.com$ (^|\.)metrics\.mzstatic\.com$ (^|\.)xp\.apple\.com$
# Minecraft
acl broken_ssl_regex dstdom_regex -i (^|\.)amazonaws\.com$ (^|\.)minecraft\.net$ (^|\.)mojang\.com$
# Origin
acl broken_ssl_regex dstdom_regex -i (^|\.)origin\.com$ (^|\.)ea\.com$
# Playstation
acl broken_ssl_regex dstdom_regex -i (^|\.)us\.playstation\.com$
# Scottrade
acl broken_ssl_regex dstdom_regex -i (^|\.)trading\.scottrade\.com$
# Skype
acl broken_ssl_regex dstdom_regex -i (^|\.)smetrics\.skype\.com$
# StartSSL
acl broken_ssl_regex dstdom_regex -i (^|\.)startssl\.com$
# Verisign
acl broken_ssl_regex dstdom_regex -i (^|\.)verisign\.com$
# Spotify
acl broken_ssl_regex dstdom_regex -i (^|\.)ap\.spotify\.com$
# Stripe
acl broken_ssl_regex dstdom_regex -i (^|\.)stripe\.com$ (^|\.)stripecdn\.com

##########################
##                      ##
## Access Control Lists ##
##                      ##
##########################

# Local Networks
# <obscurred>
acl <obscurred> src 172.18.2.0/24
# <obscurred>
acl <obscurred> src 172.18.3.0/24
# <obscurred>
acl <obscurred> src 172.18.4.0/24
# <obscurred>
acl <obscurred> src 172.18.5.0/24
# <obscurred>
acl <obscurred> src 172.18.6.0/24
# (Virtual Machines)
acl virtual_net src 172.18.100.0/24
# (Public-Wifi)
acl public_net src 192.168.50.0/24

###############
## Whitelist ##
###############

# Whitelist Local Domains
acl whitelist_dom dstdom_regex -i <obscurred> (^|\.)public-wifi\.local$
# Whitelist Microsoft
acl whitelist_dom dstdom_regex -i (^|.+)((windowsupdate|windows|download)|\.)(microsoft|windows|windowsupdate)\.com$
# Whitelist Adobe Flash Updater
acl whitelist_dom dstdom_regex -i (^|\.)macromedia\.com$

###############
## Blacklist ##
###############

# Very bad software
acl blacklist_url url_regex -i "/etc/squid/blacklists/bad-software"
# Clearly Pornographic
acl blacklist_url url_regex -i "/etc/squid/blacklists/porno-urls"
# Stat Gathering
acl blacklist_dom dstdom_regex -i (^|\.)chartbeat\.net$ (^|\.)turn\.com$ (^|\.)relead\.me$ (^|\.)scorecardresearch\.com$ (^|\.)statcounter\.com$ (^|\.)bluekai\.com$
# Very bad sites
acl blacklist_dom dstdom_regex -i (^|\.)opensoftwaredownload\.com$ (^|\.)aliexpress\.com$ (^|\.)redtube\.com$ (^|\.)efukt\.com$ (^|\.)4chan\.org$
# Overtly Pornographic
acl blacklist_dom dstdom_regex -i "/etc/squid/blacklists/porno-domains" 
# Ads
acl blacklist_dom dstdom_regex -i "/etc/squid/blacklists/yoyo-blacklist"

####################
## Proxy Detecton ##
####################
via off
forwarded_for transparent

request_header_access From deny all
request_header_access Server deny all
request_header_access WWW-Authenticate deny all
request_header_access Link deny all
request_header_access Cache-Control deny all
request_header_access Proxy-Connection deny all
request_header_access X-Cache deny all
request_header_access X-Cache-Lookup deny all
request_header_access Via deny all
request_header_access Forwarded-For deny all
request_header_access X-Forwarded-For deny all
request_header_access Pragma deny all
request_header_access Keep-Alive deny all

###################
##  Rate Limits  ##
###################

# Number of delay pools to be used
delay_pools 3

# Define the class of each delay pool
delay_class 1 2
delay_class 2 2
delay_class 3 2

# Determine which delay pool a request falls into
delay_access 1 allow <obscurred>
delay_access 1 deny all
delay_access 2 allow <obscurred>
delay_access 2 deny all
delay_access 3 allow <obscurred>
delay_access 3 deny all

# Defines the parameters for the delay pool
# (10 megabit total / 2.5 megabit/ip)
delay_parameters 1 1280000/1280000 -1/-1 320000/1280000
# (5 megabit total / 1.5 megabit/ip)
delay_parameters 2 640000/640000 -1/-1 192000/640000
# (10 megabit total / 2.5 megabit/ip)
delay_parameters 3 1280000/1280000 -1/-1 320000/1280000

################
## SSL Config ##
################

acl sslstep1 at_step SslBump1

# Broken Websites
ssl_bump peek broken_ssl_regex sslstep1
ssl_bump splice broken_ssl_regex

# Public WiFi
ssl_bump peek public_net sslstep1
ssl_bump splice public_net

# SSL Bumped Traffic
ssl_bump stare all sslstep1
ssl_bump bump all

#######################
## Access Parameters ##
#######################

# Allow Cache Manager (from localhost)
http_access allow manager localhost
http_access deny manager

# Allow localhost
http_access allow localhost

# Allow Whitelist
#http_access allow whitelist_url
http_access allow whitelist_dom

# Deny blacklisted domains
http_access deny blacklist_url
http_access deny blacklist_dom

# Allow Private Network
http_access allow <obscurred>
http_access allow <obscurred>
http_access allow <obscurred>
http_access allow <obscurred>
http_access allow <obscurred>
http_access allow public_net

# Deny all others
http_access deny all

##########################
##   Cache Parameters	##
##########################

# Define Log file
cache_log /var/log/squid/cache.log

# Cache in RAM
cache_mem 2048 MB
maximum_object_size_in_memory 5 MB

# Cache in DISK
cache_dir diskd /etc/squid/cache 819200 32 128 Q1=32 Q2=512

# Size of disk objects
minimum_object_size 0 KB
maximum_object_size 5120 MB
range_offset_limit 5120 MB

# Continue downloading aborted requests
quick_abort_min -1

# DISK cache replacement policy
cache_replacement_policy heap LFUDA

# Force cache of common update files
refresh_pattern -i (^|.+)((windowsupdate|windows|download)|\.)(microsoft|windows|windowsupdate)\.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip) 4320 100% 43200 reload-into-ims
refresh_pattern -i (^|.+)\.google\.com/.*/.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip) 4320 100% 43200 reload-into-ims