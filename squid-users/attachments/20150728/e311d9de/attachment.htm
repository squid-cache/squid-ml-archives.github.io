<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;squid-3.5.5-1.el6.x86_64&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;CentOS&nbsp;6.6&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt; This&nbsp;looks&nbsp;like&nbsp;a&nbsp;bug&nbsp;in&nbsp;Squid&nbsp;v3&nbsp;or&nbsp;a&nbsp;difference&nbsp;from&nbsp;2.7. &nbsp;Our&nbsp;monitor&nbsp;couldn&#39;t&nbsp;be&nbsp;simpler. &nbsp;It&nbsp;requests&nbsp;the&nbsp;SAME&nbsp;URL&nbsp;twice&nbsp;(identical&nbsp;in&nbsp;every&nbsp;way,&nbsp;same&nbsp;hostname&nbsp;too),&nbsp;and&nbsp;expects&nbsp;the&nbsp;2nd&nbsp;response&nbsp;to&nbsp;contain&nbsp;the&nbsp;X-Squid&nbsp;hit&nbsp;header. &nbsp;If&nbsp;it&nbsp;does&nbsp;not,&nbsp;then&nbsp;Squid&nbsp;has&nbsp;some&nbsp;sort&nbsp;of&nbsp;race&nbsp;condition&nbsp;going&nbsp;on&nbsp;its&nbsp;code.&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt; I&nbsp;just&nbsp;reproduced&nbsp;this&nbsp;by&nbsp;hand,&nbsp;using&nbsp;an&nbsp;HTTP&nbsp;sniffer&nbsp;tool. &nbsp;I&nbsp;requested&nbsp;the&nbsp;same&nbsp;URL&nbsp;twice,&nbsp;with&nbsp;about&nbsp;a&nbsp;0.25&nbsp;second&nbsp;delay&nbsp;between&nbsp;fetches,&nbsp;and&nbsp;the&nbsp;2nd&nbsp;attempt&nbsp;was&nbsp;ALSO&nbsp;A&nbsp;MISS. &nbsp;Then&nbsp;I&nbsp;waited&nbsp;1&nbsp;second&nbsp;and&nbsp;tried&nbsp;a&nbsp;3rd&nbsp;time,&nbsp;and&nbsp;it&nbsp;was&nbsp;FINALLY&nbsp;a&nbsp;hit.&nbsp; &lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Squid&nbsp;v3&nbsp;seems&nbsp;to&nbsp;have&nbsp;changed&nbsp;the&nbsp;way&nbsp;it&nbsp;stores&nbsp;objects. &nbsp;Maybe&nbsp;it&nbsp;is&nbsp;doing&nbsp;some&nbsp;sort&nbsp;of&nbsp;&quot;asynchronous&quot;&nbsp;background&nbsp;store&nbsp;now,&nbsp;so&nbsp;if&nbsp;you&nbsp;send&nbsp;in&nbsp;sequential&nbsp;requests&nbsp;without&nbsp;a&nbsp;delay&nbsp;between,&nbsp;it&nbsp;may&nbsp;not&nbsp;actually&nbsp;have&nbsp;finished&nbsp;storing&nbsp;it&nbsp;yet,&nbsp;so&nbsp;it&nbsp;doesn&#39;t&nbsp;report&nbsp;a&nbsp;&quot;hit&quot;. &nbsp;Meaning,&nbsp;the&nbsp;first&nbsp;&quot;miss&quot;&nbsp;response&nbsp;may&nbsp;have&nbsp;fired&nbsp;off&nbsp;a&nbsp;thread&nbsp;to&nbsp;store&nbsp;the&nbsp;object,&nbsp;and&nbsp;not&nbsp;doing&nbsp;it&nbsp;in&nbsp;the&nbsp;main&nbsp;thread&nbsp;anymore&nbsp;like&nbsp;in&nbsp;v2,&nbsp;if&nbsp;you&nbsp;get&nbsp;my&nbsp;meaning.&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;For&nbsp;the&nbsp;Squid&nbsp;dev&nbsp;team,&nbsp;here&nbsp;are&nbsp;the&nbsp;headers&nbsp;we&nbsp;are&nbsp;sending&nbsp;back&nbsp;from&nbsp;the&nbsp;origin&nbsp;App&nbsp;VIP:&lt;br&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Accept-Ranges:&nbsp;none&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Access-Control-Allow-Origin:&nbsp;*&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;b&gt;Cache-Control:&nbsp;max-age=300&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Connection:&nbsp;close&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Content-Length:&nbsp;403&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Content-Type:&nbsp;image/jpeg&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Date:&nbsp;Tue,&nbsp;28&nbsp;Jul&nbsp;2015&nbsp;17:25:36&nbsp;GMT&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Expires:&nbsp;Tue,&nbsp;28&nbsp;Jul&nbsp;2015&nbsp;17:30:36&nbsp;GMT&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Last-Modified:&nbsp;Mon,&nbsp;11&nbsp;Jun&nbsp;2012&nbsp;04:25:18&nbsp;GMT&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p3&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Server:&nbsp;Apache/2.2.26&nbsp;(Unix)&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p2&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;This&nbsp;should&nbsp;very&nbsp;much&nbsp;be&nbsp;cached&nbsp;right&nbsp;away&nbsp;and&nbsp;it&#39;s&nbsp;a&nbsp;simple&nbsp;tiny&nbsp;image.&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;One&nbsp;thing&nbsp;we&nbsp;also&nbsp;notice&nbsp;is&nbsp;this&nbsp;only&nbsp;occurs&nbsp;doing&nbsp;load,&nbsp;meaning&nbsp;when&nbsp;we&nbsp;have&nbsp;production&nbsp;load&nbsp;traffic&nbsp;this&nbsp;fails,&nbsp;but&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;other&nbsp;connections&nbsp;to&nbsp;the&nbsp;box,&nbsp;no&nbsp;other&nbsp;queries,&nbsp;this&nbsp;does&nbsp;not&nbsp;fail.&nbsp;Is&nbsp;it&nbsp;possible&nbsp;that&nbsp;squid&nbsp;is&nbsp;ejecting&nbsp;this&nbsp;that&nbsp;fast&nbsp;or&nbsp;is&nbsp;there&nbsp;another&nbsp;possibility&nbsp;here?&nbsp;Not&nbsp;sure&nbsp;what&nbsp;other&nbsp;data&nbsp;I&nbsp;can&nbsp;provide&nbsp;but&nbsp;will&nbsp;if&nbsp;asked.&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Thanks&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;Tory&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;span&nbsp;class=&quot;s1&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;/p&gt;&lt;p&nbsp;class=&quot;p1&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
