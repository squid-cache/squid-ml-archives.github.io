<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi&nbsp;Amos,&nbsp;&lt;br&gt;&lt;br&gt; cache_mem&nbsp;0&lt;br&gt;<br>
 cache&nbsp;deny&nbsp;all&nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;already&nbsp;there.&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regarding&nbsp;number&nbsp;of&nbsp;nic&nbsp;ports&nbsp;we&nbsp;have&nbsp;4&nbsp;10G&nbsp;eth&nbsp;cards&nbsp;2&nbsp;in&nbsp;each&nbsp;bonding&nbsp;interface.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Well,&nbsp;entire&nbsp;config&nbsp;would&nbsp;be&nbsp;way&nbsp;too&nbsp;long&nbsp;but&nbsp;here&nbsp;is&nbsp;the&nbsp;static&nbsp;part:&lt;br&gt;via&nbsp;off&lt;br&gt;cpu_affinity_map&nbsp;process_numbers=1&nbsp;cores=2&lt;br&gt;forwarded_for&nbsp;delete&lt;br&gt;visible_hostname&nbsp;squid1&lt;br&gt;pid_filename&nbsp;/var/run/squid1.pid&lt;br&gt;icp_port&nbsp;0&lt;br&gt;htcp_port&nbsp;0&lt;br&gt;icp_access&nbsp;deny&nbsp;all&lt;br&gt;htcp_access&nbsp;deny&nbsp;all&lt;br&gt;snmp_port&nbsp;0&lt;br&gt;snmp_access&nbsp;deny&nbsp;all&lt;br&gt;dns_nameservers&nbsp;x.x.x.x&lt;br&gt;cache_mem&nbsp;0&lt;br&gt;cache&nbsp;deny&nbsp;all&lt;br&gt;pipeline_prefetch&nbsp;on&lt;br&gt;memory_pools&nbsp;off&lt;br&gt;maximum_object_size&nbsp;16&nbsp;KB&lt;br&gt;maximum_object_size_in_memory&nbsp;16&nbsp;KB&lt;br&gt;ipcache_size&nbsp;0&lt;br&gt;cache_store_log&nbsp;none&lt;br&gt;half_closed_clients&nbsp;off&lt;br&gt;include&nbsp;/etc/squid/rules&lt;br&gt;access_log&nbsp;/var/log/squid/squid1-access.log&lt;br&gt;cache_log&nbsp;/var/log/squid/squid1-cache.log&lt;br&gt;coredump_dir&nbsp;/var/spool/squid/squid1&lt;br&gt;refresh_pattern&nbsp;^ftp:          &nbsp;1440   &nbsp;20%    &nbsp;10080&lt;br&gt;refresh_pattern&nbsp;^gopher:       &nbsp;1440   &nbsp;0%     &nbsp;1440&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0    &nbsp;0%     &nbsp;0&lt;br&gt;refresh_pattern&nbsp;.              &nbsp;0      &nbsp;20%    &nbsp;4320&lt;br&gt;&lt;br&gt;acl&nbsp;port0&nbsp;myport&nbsp;30000&lt;br&gt;http_access&nbsp;allow&nbsp;testhost&lt;br&gt;tcp_outgoing_address&nbsp;x.x.x.x&nbsp;port0&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;include&nbsp;is&nbsp;there&nbsp;for&nbsp;basic&nbsp;ACL&nbsp;-&nbsp;safe&nbsp;ports&nbsp;and&nbsp;so&nbsp;on&nbsp;-&nbsp;to&nbsp;minimize&nbsp;config&nbsp;file&nbsp;footprint&nbsp;since&nbsp;it&#39;s&nbsp;static&nbsp;and&nbsp;same&nbsp;for&nbsp;every&nbsp;worker.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;so&nbsp;on&nbsp;44&nbsp;more&nbsp;times&nbsp;in&nbsp;this&nbsp;config&nbsp;file&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Do&nbsp;you&nbsp;know&nbsp;of&nbsp;any&nbsp;good&nbsp;article&nbsp;hot&nbsp;to&nbsp;tune&nbsp;kernel&nbsp;locking&nbsp;or&nbsp;have&nbsp;any&nbsp;idea&nbsp;why&nbsp;is&nbsp;it&nbsp;happening?&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;cannot&nbsp;find&nbsp;any&nbsp;good&nbsp;info&nbsp;on&nbsp;it&nbsp;and&nbsp;all&nbsp;I&#39;ve&nbsp;found&nbsp;are&nbsp;bits&nbsp;and&nbsp;peaces&nbsp;of&nbsp;kernel&nbsp;source&nbsp;code.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Tnx.&lt;br&gt;&lt;/div&gt;&lt;div&gt;J.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2015-07-31&nbsp;0:42&nbsp;GMT+02:00&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;31/07/2015&nbsp;8:05&nbsp;a.m.,&nbsp;Josip&nbsp;Makarevic&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;problem&nbsp;with&nbsp;squid&nbsp;setup&nbsp;(squid&nbsp;version&nbsp;3.5.6,&nbsp;built&nbsp;from&nbsp;source,&lt;br&gt;<br>
&gt;&nbsp;centos&nbsp;6.6)&lt;br&gt;<br>
&gt;&nbsp;I&#39;ve&nbsp;tried&nbsp;2&nbsp;options:&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;SMP&lt;br&gt;<br>
&gt;&nbsp;2.&nbsp;NON-SMP&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&#39;ve&nbsp;decided&nbsp;to&nbsp;stick&nbsp;with&nbsp;custom&nbsp;build&nbsp;non-smp&nbsp;version&nbsp;and&nbsp;the&nbsp;thing&nbsp;is:&lt;br&gt;<br>
&gt;&nbsp;-&nbsp;i&nbsp;don&#39;t&nbsp;need&nbsp;cache&nbsp;-&nbsp;any&nbsp;kind&nbsp;of&nbsp;it&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt; cache_mem&nbsp;0&lt;br&gt;<br>
 cache&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
That&nbsp;is&nbsp;it.&nbsp;All&nbsp;other&nbsp;caches&nbsp;used&nbsp;by&nbsp;Squid&nbsp;*are*&nbsp;mandatory&nbsp;for&nbsp;good&lt;br&gt;<br>
performance.&nbsp;And&nbsp;are&nbsp;only&nbsp;used&nbsp;anyway&nbsp;when&nbsp;the&nbsp;component&nbsp;that&nbsp;needs&nbsp;them&lt;br&gt;<br>
is&nbsp;actively&nbsp;used.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;-&nbsp;I&nbsp;have&nbsp;DNS&nbsp;cache&nbsp;just&nbsp;for&nbsp;that&lt;br&gt;<br>
&gt;&nbsp;-&nbsp;squid&nbsp;has&nbsp;to&nbsp;listen&nbsp;on&nbsp;1024&nbsp;ports&nbsp;on&nbsp;23&nbsp;instances.&lt;br&gt;<br>
&gt;&nbsp;each&nbsp;instance&nbsp;listens&nbsp;on&nbsp;set&nbsp;of&nbsp;ports&nbsp;and&nbsp;each&nbsp;port&nbsp;has&nbsp;different&nbsp;outgoing&lt;br&gt;<br>
&gt;&nbsp;ip&nbsp;address.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;And&nbsp;how&nbsp;many&nbsp;NIC&nbsp;do&nbsp;you&nbsp;have&nbsp;that&nbsp;spread&nbsp;over?&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;thing&nbsp;is&nbsp;this:&lt;br&gt;<br>
&gt;&nbsp;It&#39;s&nbsp;alll&nbsp;good&nbsp;until&nbsp;we&nbsp;hit&nbsp;it&nbsp;with&nbsp;more&nbsp;than&nbsp;150mbits&nbsp;then...&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;(output&nbsp;from&nbsp;perf&nbsp;top)&lt;br&gt;<br>
&gt; &nbsp;84.57% &nbsp;[kernel] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[k]&nbsp;osq_lock&lt;br&gt;<br>
&gt; &nbsp; 4.62% &nbsp;[kernel] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[k]&nbsp;mutex_spin_on_owner&lt;br&gt;<br>
&gt; &nbsp; 1.41% &nbsp;[kernel] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[k]&nbsp;memcpy&lt;br&gt;<br>
&gt; &nbsp; 0.79% &nbsp;[kernel] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[k]&nbsp;inet_dump_ifaddr&lt;br&gt;<br>
&gt; &nbsp; 0.62% &nbsp;[kernel] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[k]&nbsp;memset&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp;21:53:39&nbsp;up&nbsp;7&nbsp;days,&nbsp;10:38, &nbsp;1&nbsp;user, &nbsp;load&nbsp;average:&nbsp;24.01,&nbsp;23.84,&nbsp;23.33&lt;br&gt;<br>
&gt;&nbsp;(yes,&nbsp;we&nbsp;have&nbsp;24&nbsp;cores)&lt;br&gt;<br>
&gt;&nbsp;Same&nbsp;behavior&nbsp;is&nbsp;with&nbsp;SMP&nbsp;and&nbsp;NON-SMP&nbsp;setup&nbsp;(SMP&nbsp;setup&nbsp;is&nbsp;all&nbsp;in&nbsp;one&nbsp;file&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;workers&nbsp;23&nbsp;option&nbsp;but&nbsp;then&nbsp;I&nbsp;have&nbsp;to&nbsp;use&nbsp;rock&nbsp;cache)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;so,&nbsp;my&nbsp;question&nbsp;is....what...how&nbsp;to&nbsp;optimize&nbsp;this.....whatever....I&#39;m&nbsp;stuck&lt;br&gt;<br>
&gt;&nbsp;for&nbsp;days,&nbsp;I&#39;ve&nbsp;tried&nbsp;many&nbsp;sysctl&nbsp;options&nbsp;but&nbsp;none&nbsp;of&nbsp;them&nbsp;works.&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;help,&nbsp;info,&nbsp;something&nbsp;else?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;None&nbsp;of&nbsp;those&nbsp;are&nbsp;Squid&nbsp;functionality.&nbsp;If&nbsp;you&nbsp;want&nbsp;help&nbsp;optimizing&nbsp;your&lt;br&gt;<br>
config&nbsp;and&nbsp;are&nbsp;willing&nbsp;to&nbsp;post&nbsp;it&nbsp;to&nbsp;the&nbsp;list&nbsp;I&nbsp;am&nbsp;happy&nbsp;to&nbsp;do&nbsp;a&nbsp;quick&lt;br&gt;<br>
audit&nbsp;and&nbsp;point&nbsp;out&nbsp;any&nbsp;problem&nbsp;areas&nbsp;for&nbsp;you.&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;tuning&nbsp;the&nbsp;internal&nbsp;locking&nbsp;code&nbsp;of&nbsp;the&nbsp;kernel&nbsp;is&nbsp;way&nbsp;off&nbsp;topic.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
