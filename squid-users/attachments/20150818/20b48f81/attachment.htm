<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi,&nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;We&nbsp;have&nbsp;a&nbsp;squid&nbsp;reverse&nbsp;configuration,&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;change &nbsp;backend&nbsp;webserver &nbsp;with&nbsp;a&nbsp;new&nbsp;webserver&nbsp;with&nbsp;new&nbsp;IP&nbsp;and&nbsp;port&nbsp;(80&nbsp;--&gt;&nbsp;8000)&nbsp;.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Old&nbsp;squid&nbsp;configuration&nbsp;used&nbsp;url_rewrite_program.&nbsp;I&nbsp;&#39;not&nbsp;familar&nbsp;with&nbsp;this&nbsp;configuration.&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;port&nbsp;changing&nbsp;on&nbsp;new&nbsp;web&nbsp;server&nbsp;(&nbsp;80&nbsp;--&gt;&nbsp;8000)&nbsp;,&nbsp;i&nbsp;find&nbsp;that&nbsp;i&nbsp;had&nbsp;to&nbsp;add&nbsp;new&nbsp;production&nbsp;web&nbsp;on&nbsp;url_rerite_program.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;I&nbsp;tried&nbsp;to&nbsp;change&nbsp;program&nbsp;,&nbsp;but&nbsp;i&nbsp;met&nbsp;a&nbsp;issue.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;on&nbsp;part&nbsp;1&nbsp;--&gt;&nbsp;current&nbsp;rewrite&nbsp;program&nbsp;configuration &nbsp;running&nbsp;today&nbsp;and&nbsp;correctly &nbsp;for&nbsp;testurl&nbsp;--&gt;&nbsp;running&nbsp;fine&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;on&nbsp;part&nbsp;2&nbsp;--&gt;&nbsp;configuration&nbsp;with&nbsp;change &nbsp;for&nbsp;testurl&nbsp;and&nbsp;productionurl&nbsp;-&gt;&nbsp;OK&nbsp;for&nbsp;productionurl&nbsp;and&nbsp;KO&nbsp;for&nbsp;testurl&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;An&nbsp;idea&nbsp;if&nbsp;something&nbsp;is&nbsp;wrong&nbsp;on&nbsp;change&nbsp;?&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Part&nbsp;1) &nbsp;old&nbsp;configuration&nbsp;:&nbsp;&lt;br&gt;&lt;br&gt;#!/usr/bin/perl&lt;br&gt;&lt;br&gt;$INTERNALIP=&quot;15.40.40.40&quot;;&lt;br&gt;$PRODUCTIONURL=&quot;&lt;a&nbsp;href=&quot;http://add.ptr.lu&quot;&gt;add.ptr.lu&lt;/a&gt;&quot;;&nbsp;&lt;br&gt;$TESTURL=&quot;&lt;a&nbsp;href=&quot;http://test.add.ptr.lu&quot;&gt;test.add.ptr.lu&lt;/a&gt;&quot;;&nbsp;&lt;br&gt;$TESTPORT=&quot;8001&quot;;&lt;br&gt;&lt;br&gt;#&nbsp;turn&nbsp;off&nbsp;write&nbsp;buffering&nbsp;&lt;br&gt;$|&nbsp;=&nbsp;1;&lt;br&gt;while&nbsp;(&lt;&gt;)&nbsp;{&nbsp;&lt;br&gt;&lt;br&gt; &nbsp;#&nbsp;get&nbsp;the&nbsp;URL&nbsp;from&nbsp;the&nbsp;request&nbsp;&lt;br&gt; &nbsp;chomp($url&nbsp;=&nbsp;$_);&lt;br&gt;&lt;br&gt; &nbsp;if&nbsp;($url&nbsp;=~&nbsp;m/($INTERNALIP|$TESTURL):$TESTPORT/)&lt;br&gt; &nbsp;{&lt;br&gt;   &nbsp;#&nbsp;fix&nbsp;up&nbsp;the&nbsp;cname&nbsp;and&nbsp;port&lt;br&gt;   &nbsp;$url&nbsp;=~&nbsp;s^:$TESTPORT^^;&nbsp;&lt;br&gt;   &nbsp;$url&nbsp;=~&nbsp;s^$INTERNALIP^$TESTURL^;&nbsp;&lt;br&gt;&lt;br&gt;   &nbsp;#&nbsp;fix&nbsp;the&nbsp;protocol&nbsp;&lt;br&gt;   &nbsp;$url&nbsp;=~&nbsp;s^https://^http://^;&nbsp;&lt;br&gt; &nbsp;}&lt;br&gt; &nbsp;else&lt;br&gt; &nbsp;{&lt;br&gt;   &nbsp;#&nbsp;fix&nbsp;up&nbsp;the&nbsp;name&nbsp;&lt;br&gt;   &nbsp;$url&nbsp;=~&nbsp;s^$INTERNALIP^$PRODUCTIONURL^;&nbsp;&lt;br&gt;&lt;br&gt;   &nbsp;#&nbsp;fix&nbsp;the&nbsp;protocol&nbsp;&lt;br&gt;   &nbsp;$url&nbsp;=~&nbsp;s^http://^https://^;&nbsp;&lt;br&gt; &nbsp;}&lt;br&gt;&lt;br&gt; &nbsp;#&nbsp;return&nbsp;the&nbsp;fixed&nbsp;URL&nbsp;to&nbsp;squid&nbsp;&lt;br&gt; &nbsp;print&nbsp;&quot;$url\n&quot;;&nbsp;&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;Part&nbsp;2)&nbsp;configuration&nbsp;with&nbsp;changes&nbsp;&lt;br&gt;&lt;br&gt;#!/usr/bin/perl<br>
&lt;br&gt; &lt;br&gt;$INTERNALIP=&quot;15.40.40.40&quot;;<br>
&lt;br&gt;$PRODUCTIONURL=&quot;&lt;a&nbsp;href=&quot;http://add.ptr.lu&quot;&gt;add.ptr.lu&lt;/a&gt;&quot;; <br>
&lt;br&gt;$TESTURL=&quot;&lt;a&nbsp;href=&quot;http://test.add.ptr.lu&quot;&gt;test.add.ptr.lu&lt;/a&gt;&quot;; <br>
&lt;br&gt;$TESTPORT=&quot;8001&quot;;<br>
&lt;br&gt;$PRODPORT=&quot;8000&quot;;<br>
&lt;br&gt; &lt;br&gt;#&nbsp;turn&nbsp;off&nbsp;write&nbsp;buffering <br>
&lt;br&gt;$|&nbsp;=&nbsp;1;<br>
&lt;br&gt;while&nbsp;(&lt;&gt;)&nbsp;{ <br>
&lt;br&gt; &lt;br&gt; &nbsp;#&nbsp;get&nbsp;the&nbsp;URL&nbsp;from&nbsp;the&nbsp;request <br>
&lt;br&gt; &nbsp;chomp($url&nbsp;=&nbsp;$_);<br>
&lt;br&gt; &lt;br&gt; &nbsp;if&nbsp;($url&nbsp;=~&nbsp;m/($INTERNALIP|$TESTURL):$TESTPORT/)<br>
&lt;br&gt; &nbsp;{<br>
&lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;up&nbsp;the&nbsp;cname&nbsp;and&nbsp;port<br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^:$TESTPORT^^; <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^$INTERNALIP^$TESTURL^; <br>
&lt;br&gt; &lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;the&nbsp;protocol <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^https://^http://^; <br>
&lt;br&gt; &nbsp;}<br>
&lt;br&gt; &lt;br&gt;elsif&nbsp;($url&nbsp;=~&nbsp;m/($INTERNALIP|$PRODUCTIONURL):$PRODPORT/)<br>
&lt;br&gt; &nbsp;{<br>
&lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;up&nbsp;the&nbsp;cname&nbsp;and&nbsp;port<br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^:$PRODPORT^^; <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^$INTERNALIP^$PRODURL^; <br>
&lt;br&gt; &lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;the&nbsp;protocol <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^https://^http://^; <br>
&lt;br&gt; &nbsp;}<br>
&lt;br&gt; &lt;br&gt; &nbsp;else<br>
&lt;br&gt; &nbsp;{<br>
&lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;up&nbsp;the&nbsp;name <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^$INTERNALIP^$PRODUCTIONURL^; <br>
&lt;br&gt; &lt;br&gt; &nbsp; &nbsp;#&nbsp;fix&nbsp;the&nbsp;protocol <br>
&lt;br&gt; &nbsp; &nbsp;$url&nbsp;=~&nbsp;s^http://^https://^; <br>
&lt;br&gt; &nbsp;}<br>
&lt;br&gt; &lt;br&gt; &nbsp;#&nbsp;return&nbsp;the&nbsp;fixed&nbsp;URL&nbsp;to&nbsp;squid <br>
&lt;br&gt; &nbsp;print&nbsp;&quot;$url\n&quot;; <br>
&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
