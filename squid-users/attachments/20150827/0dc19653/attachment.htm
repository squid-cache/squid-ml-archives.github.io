<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;All,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;configure&nbsp;a&nbsp;squid&nbsp;filtering&nbsp;instance&nbsp;which&nbsp;serves&nbsp;both&nbsp;proxy&nbsp;and&nbsp;intercepted&nbsp;(transparent)&nbsp;connections.&nbsp;Filtering&nbsp;is&nbsp;accomplished&nbsp;by&nbsp;a&nbsp;Request&nbsp;eCAP&nbsp;adapter&nbsp;which&nbsp;have&nbsp;something&nbsp;like &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;if(IsDenied()&nbsp;&amp;&amp;&nbsp;RequestMethod==&quot;CONNECT&quot;)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//&nbsp;Gives&nbsp;TAG_NONE/403&nbsp;in&nbsp;the&nbsp;access&nbsp;log&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; hostx-&gt;blockVirgin();&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp; return;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;also&nbsp;have&nbsp;a&nbsp;requirement&nbsp;to&nbsp;bump&nbsp;a&nbsp;particular&nbsp;domain&nbsp;and&nbsp;peek&nbsp;other&nbsp;https&nbsp;connections&nbsp;for&nbsp;intercepted&nbsp;mode.&nbsp;So&nbsp;there&nbsp;are&nbsp;3&nbsp;possible&nbsp;outcomes/filtering&nbsp;decision&nbsp;for&nbsp;any&nbsp;https&nbsp;connections&nbsp;hitting&nbsp;this&nbsp;server.&nbsp;They&nbsp;are &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;Bump&nbsp;and&nbsp;allow&nbsp;the&nbsp;access&lt;/div&gt;&lt;div&gt;2)&nbsp;Non&nbsp;bumped&nbsp;and&nbsp;allowed&nbsp;access&lt;/div&gt;&lt;div&gt;3)&nbsp;Non&nbsp;bumped&nbsp;and&nbsp;denied&nbsp;access,&nbsp;by&nbsp;the&nbsp;code&nbsp;given&nbsp;above&nbsp;in&nbsp;eCAP&nbsp;adapter&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;squid&nbsp;(tried&nbsp;with&nbsp;v3.5.6&nbsp;and&nbsp;v3.5.7-20150823-r13895,&nbsp;same&nbsp;outcome)&nbsp;config&nbsp;looks&nbsp;like&nbsp;below&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;&lt;div&gt;#&nbsp; TAG:&nbsp;ssl_bump&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;server-first&nbsp;&lt;ip&nbsp;of&nbsp;the&nbsp;domain&nbsp;to&nbsp;be&nbsp;bumped&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;.&lt;/div&gt;&lt;div&gt;&lt;div&gt;http_port&nbsp;&lt;proxy&nbsp;ip&gt;:&lt;port&gt;&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;cert=&lt;path&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;https_port &lt;intercept/transparent&nbsp;ip&gt;:&lt;port&gt; intercept&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;cert=&lt;path&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Things&nbsp;are&nbsp;fine&nbsp;with&nbsp;the&nbsp;intercepted&nbsp;connections&nbsp;(for&nbsp;all&nbsp;the&nbsp;3&nbsp;scenarios).&nbsp;But&nbsp;with&nbsp;the&nbsp;proxy&nbsp;connections&nbsp;I&nbsp;am&nbsp;encountering&nbsp;some&nbsp;peculiar&nbsp;behavior&nbsp;with&nbsp;scenario&nbsp;3&nbsp;(ie&nbsp;when&nbsp;a&nbsp;non&nbsp;bumped&nbsp;https&nbsp;CONNECT&nbsp;is&nbsp;denied&nbsp;by&nbsp;eCAP).&nbsp;Instead&nbsp;of&nbsp;terminating&nbsp;the&nbsp;connection,&nbsp;it&nbsp;is&nbsp;logged&nbsp;as&nbsp;TAG_NONE/200&nbsp;in&nbsp;the&nbsp;access&nbsp;log&nbsp;and&nbsp;getting&nbsp;bumped&nbsp;(a&nbsp;dynamic&nbsp;certificate&nbsp;is&nbsp;generated)&nbsp;and&nbsp;then&nbsp;getting&nbsp;terminated.&nbsp;The&nbsp;behavior&nbsp;disappears&nbsp;and&nbsp;works&nbsp;if&nbsp;I&nbsp;comment&nbsp;the&nbsp;&quot;peek&nbsp;all&quot;&nbsp;line.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;bug&nbsp;or&nbsp;an&nbsp;expected&nbsp;behavior.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Of&nbsp;course&nbsp;the&nbsp;proxy&nbsp;bumped&nbsp;connection&nbsp;works&nbsp;fine&nbsp;if&nbsp;I&nbsp;selectively&nbsp;peek&nbsp;for&nbsp;intercepted&nbsp;connections&nbsp;(ssl_bump&nbsp;peek&nbsp;&lt;if&nbsp;only&nbsp;in&nbsp;intercepted&nbsp;mode&gt;),&nbsp;but&nbsp;in&nbsp;this&nbsp;case&nbsp;I&nbsp;am&nbsp;getting&nbsp;duplicate&nbsp;entries&nbsp;in&nbsp;the&nbsp;access&nbsp;log&nbsp;file&nbsp;(ie&nbsp;2&nbsp;CONNECT&nbsp;log&nbsp;messages&nbsp;for&nbsp;each&nbsp;https&nbsp;CONNECT)&nbsp;for&nbsp;intercepted&nbsp;mode&nbsp;https&nbsp;connections.The&nbsp;same&nbsp;goes&nbsp;for&nbsp;other&nbsp;ACL&nbsp;combinations&nbsp;like&nbsp;the&nbsp;below&nbsp;resulting&nbsp;in&nbsp;duplicated&nbsp;log&nbsp;messages&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;ssl_bump&nbsp;server-first&nbsp;&lt;ip&nbsp;of&nbsp;the&nbsp;domain&nbsp;to&nbsp;be&nbsp;bumped&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;&lt;only&nbsp;if&nbsp;the&nbsp;request&nbsp;hit&nbsp;the&nbsp;proxy&nbsp;ip:port&nbsp;and&nbsp;not&nbsp;the&nbsp;intercept/transparent&nbsp;ip&nbsp;:port&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards,&lt;/div&gt;&lt;div&gt;John&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
