<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&nbsp;style=&quot;margin-left:40px&quot;&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;&gt;&nbsp;acl&nbsp;s1_tls_connect&nbsp;at_step&nbsp;SslBump1&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&gt;&nbsp;acl&nbsp;s2_tls_client_hello&nbsp;at_step&nbsp;SslBump2&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&gt;&nbsp;acl&nbsp;s3_tls_server_hello&nbsp;at_step&nbsp;SslBump3&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&gt;&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&gt;&nbsp;acl&nbsp;tls_server_name_is_ip&nbsp;ssl::server_name_regex&nbsp;\&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&gt;&nbsp;^[0-9]+.[0-9]+.[0-9]+.[0-9]+n&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&lt;/span&gt;&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;<br>
&lt;/span&gt;You&nbsp;have&nbsp;a&nbsp;letter&nbsp;&#39;n&#39;&nbsp;on&nbsp;the&nbsp;end&nbsp;there&nbsp;is&nbsp;that&nbsp;intentional?&lt;br&gt;&lt;br&gt;&lt;/div&gt;It&nbsp;would&nbsp;seem&nbsp;so.&nbsp;I&nbsp;copied&nbsp;that&nbsp;from&nbsp;someone&nbsp;else&#39;s&nbsp;&quot;peek-splice&quot;&nbsp;directives&nbsp;that&nbsp;they&nbsp;said&nbsp;worked&nbsp;well&nbsp;for&nbsp;them.&nbsp;The&nbsp;actual&nbsp;regex&nbsp;in&nbsp;the&nbsp;perl&nbsp;script&nbsp;that&nbsp;writes&nbsp;squid.conf&nbsp;is&nbsp;&lt;i&gt;&quot;print&nbsp;FILE&nbsp;&quot;acl&nbsp;tls_server_name_is_ip&nbsp;ssl::server_name_regex&nbsp;^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$\n\n&quot;;&lt;/i&gt;.&quot;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;style=&quot;margin-left:40px&quot;&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;&gt;&nbsp;acl&nbsp;google&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;s1_tls_connect&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;nobumpSites&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://wellsfargo.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;wellsfargo.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;s2_tls_client_hello&nbsp;nobumpSites&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;s2_tls_client_hello&nbsp;google&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;stare&nbsp;s2_tls_client_hello&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;s3_tls_server_hello&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://forcesafesearch.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;forcesafesearch.google.com&lt;/a&gt;&nbsp;parent&nbsp;443&nbsp;0&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;ssl&nbsp;name=GS&nbsp;originserver&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;no-query&nbsp;no-netdb-exchange&nbsp;no-digest&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;search&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;GS&nbsp;allow&nbsp;search&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;GS&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;think&nbsp;the&nbsp;fake-CONNECT&nbsp;Squid&nbsp;creates&nbsp;still&nbsp;has&nbsp;only&nbsp;raw-IP:port&lt;br&gt;<br>
details.&nbsp;And&nbsp;with&nbsp;splicing&nbsp;you&nbsp;dont&nbsp;have&nbsp;the&nbsp;decrypt&nbsp;to&nbsp;setup&nbsp;dstdomain&lt;br&gt;<br>
URL&nbsp;details.&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;dstdomain&nbsp;you&nbsp;need&nbsp;to&nbsp;match&nbsp;what&nbsp;shows&nbsp;up&nbsp;in&nbsp;access.log&nbsp;as&nbsp;the&nbsp;URI&lt;br&gt;<br>
of&nbsp;these&nbsp;requests.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-left:40px&quot;&gt;Does&nbsp;the&nbsp;&quot;google&quot;&nbsp;ACL&nbsp;work&nbsp;in&nbsp;cache_peer_access&nbsp;to&nbsp;use&nbsp;the&nbsp;SNI?&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;The&nbsp;&quot;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&quot;&nbsp;was&nbsp;taken&nbsp;directly&nbsp;from&nbsp;an&nbsp;example&nbsp;that&nbsp;was&nbsp;provided.&nbsp;When&nbsp;I&nbsp;try&nbsp;to&nbsp;access&nbsp;&lt;i&gt;&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&lt;/i&gt;&nbsp;the&nbsp;error&nbsp;message&nbsp;says&nbsp;a&nbsp;&quot;secure&nbsp;connection&nbsp;could&nbsp;not&nbsp;be&nbsp;established&nbsp;to&nbsp;&lt;i&gt;&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;http://google.com&lt;/a&gt;&quot;.&nbsp;&lt;/i&gt;It&nbsp;seems&nbsp;the&nbsp;&quot;redirect&nbsp;to&nbsp;https&quot;&nbsp;isn&#39;t&nbsp;working&nbsp;using&nbsp;the&nbsp;acl&nbsp;&lt;span&nbsp;class=&quot;im&quot;&gt;&lt;i&gt;&quot;acl&nbsp;google&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&lt;/i&gt;&quot;&nbsp;in&nbsp;&quot;cache_peer_access&quot;.&nbsp;&lt;/span&gt;If&nbsp;I&nbsp;enter&nbsp;instead&nbsp;&lt;i&gt;&lt;a&nbsp;href=&quot;https://google.com&quot;&gt;https://google.com&lt;/a&gt;&nbsp;&lt;/i&gt;then&nbsp;I&nbsp;don&#39;t&nbsp;get&nbsp;that&nbsp;error&nbsp;but&nbsp;inappropriate&nbsp;Google&nbsp;images&nbsp;are&nbsp;still&nbsp;not&nbsp;blocked.&nbsp;When&nbsp;I&nbsp;look&nbsp;at&nbsp;the&nbsp;access.log,&nbsp;all&nbsp;I&nbsp;see&nbsp;are&nbsp;IP&nbsp;addresses&nbsp;for&nbsp;the&nbsp;domains&nbsp;for&nbsp;CONECTs&nbsp;like&nbsp;this&lt;br&gt;&lt;br&gt;&lt;i&gt;1441396051.210    &nbsp;62&nbsp;10.3.3.100&nbsp;TCP_MISS/503&nbsp;3639&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://www.google.com/&quot;&gt;http://www.google.com/&lt;/a&gt;&nbsp;-&nbsp;FIRSTUP_PARENT/&lt;a&nbsp;href=&quot;http://216.239.38.120&quot;&gt;216.239.38.120&lt;/a&gt;&nbsp;text/html&lt;br&gt;1441396051.330    &nbsp;61&nbsp;10.3.3.100&nbsp;TCP_MISS/503&nbsp;3640&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://www.google.com/favicon.ico&quot;&gt;http://www.google.com/favicon.ico&lt;/a&gt;&nbsp;-&nbsp;FIRSTUP_PARENT/&lt;a&nbsp;href=&quot;http://216.239.38.120&quot;&gt;216.239.38.120&lt;/a&gt;&nbsp;text/html&lt;br&gt;1441396051.390    &nbsp;58&nbsp;10.3.3.100&nbsp;TCP_MISS/503&nbsp;3672&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://www.google.com/favicon.ico&quot;&gt;http://www.google.com/favicon.ico&lt;/a&gt;&nbsp;-&nbsp;FIRSTUP_PARENT/&lt;a&nbsp;href=&quot;http://216.239.38.120&quot;&gt;216.239.38.120&lt;/a&gt;&nbsp;text/html&lt;br&gt;1441396097.795    &nbsp;81&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.191:443&quot;&gt;74.125.227.191:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.191&quot;&gt;74.125.227.191&lt;/a&gt;&nbsp;-&lt;br&gt;1441396097.830    &nbsp;87&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.172:443&quot;&gt;74.125.227.172:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.172&quot;&gt;74.125.227.172&lt;/a&gt;&nbsp;-&lt;br&gt;1441396098.115    &nbsp;93&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.175:443&quot;&gt;74.125.227.175:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.175&quot;&gt;74.125.227.175&lt;/a&gt;&nbsp;-&lt;br&gt;1441396098.877    &nbsp;79&nbsp;10.3.3.100&nbsp;TCP_MISS/200&nbsp;840&nbsp;POST&nbsp;&lt;a&nbsp;href=&quot;http://clients1.google.com/ocsp&quot;&gt;http://clients1.google.com/ocsp&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.168&quot;&gt;74.125.227.168&lt;/a&gt;&nbsp;application/ocsp-response&lt;br&gt;1441396098.878   &nbsp;622&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.160:443&quot;&gt;74.125.227.160:443&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;1441396098.878   &nbsp;621&nbsp;10.3.3.100&nbsp;TCP_TUNNEL/200&nbsp;5123&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.160:443&quot;&gt;74.125.227.160:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.160&quot;&gt;74.125.227.160&lt;/a&gt;&nbsp;-&lt;br&gt;1441396099.078    &nbsp;92&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.217:443&quot;&gt;74.125.227.217:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.217&quot;&gt;74.125.227.217&lt;/a&gt;&nbsp;-&lt;br&gt;1441396099.189   &nbsp;106&nbsp;10.3.3.100&nbsp;TCP_MISS/200&nbsp;809&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;https://googleads.g.doubleclick.net/pagead/drt/si?ogt=1&amp;pli=1&amp;auth=DQAAAMQAAAA4q0535ee2zf0UOZwVQ6_S4mSWjf5Kb4fXl9x3McqtJiWrkQIQToYoQiKlpOleH4gYm8RDSWUaDvvHLQqnRZUq0hgjBst5H7svmtOGMUQJWwIv_orC8WVMfxr91CPgT5DFQ-5IULxyQsXmTMj9gOrFQ6S3PA86VzwCr1buDy8gaOeX_wF-hzw52PmkI5fEDNXwc5rhvhFkZ0epUswSyOMIWKqbgKDwcM3MpxD8WsDKiPdKyTD7qlNjZfxKqKO2EBJD2pbu24zhvuCHX7baeaPt&quot;&gt;https://googleads.g.doubleclick.net/pagead/drt/si?ogt=1&amp;pli=1&amp;auth=DQAAAMQAAAA4q0535ee2zf0UOZwVQ6_S4mSWjf5Kb4fXl9x3McqtJiWrkQIQToYoQiKlpOleH4gYm8RDSWUaDvvHLQqnRZUq0hgjBst5H7svmtOGMUQJWwIv_orC8WVMfxr91CPgT5DFQ-5IULxyQsXmTMj9gOrFQ6S3PA86VzwCr1buDy8gaOeX_wF-hzw52PmkI5fEDNXwc5rhvhFkZ0epUswSyOMIWKqbgKDwcM3MpxD8WsDKiPdKyTD7qlNjZfxKqKO2EBJD2pbu24zhvuCHX7baeaPt&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.217&quot;&gt;74.125.227.217&lt;/a&gt;&nbsp;image/gif&lt;br&gt;1441396112.635    &nbsp;99&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.175:443&quot;&gt;74.125.227.175:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.175&quot;&gt;74.125.227.175&lt;/a&gt;&nbsp;-&lt;br&gt;1441396114.575    &nbsp;85&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.191:443&quot;&gt;74.125.227.191:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.191&quot;&gt;74.125.227.191&lt;/a&gt;&nbsp;-&lt;br&gt;1441396123.684    &nbsp;92&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.191:443&quot;&gt;74.125.227.191:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.191&quot;&gt;74.125.227.191&lt;/a&gt;&nbsp;-&lt;br&gt;1441396124.205    &nbsp;87&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.175:443&quot;&gt;74.125.227.175:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.175&quot;&gt;74.125.227.175&lt;/a&gt;&nbsp;-&lt;br&gt;1441396127.192    &nbsp;84&nbsp;10.3.3.100&nbsp;TAG_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://74.125.227.205:443&quot;&gt;74.125.227.205:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://74.125.227.205&quot;&gt;74.125.227.205&lt;/a&gt;&nbsp;-&lt;br&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;I&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;tell&nbsp;if&nbsp;the&nbsp;SNI&nbsp;is&nbsp;being&nbsp;used&nbsp;in&nbsp;cache_peer_access&nbsp;other&nbsp;than&nbsp;as&nbsp;I&nbsp;mentioned&nbsp;above&nbsp;only&nbsp;IP&nbsp;addresses&nbsp;appear&nbsp;in&nbsp;access.log&nbsp;for&nbsp;the&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&nbsp;domain.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;style=&quot;margin-left:40px&quot;&gt;The&nbsp;flag&nbsp;DONT_VERIFY_PEER&nbsp;tells&nbsp;Squid&nbsp;not&nbsp;to&nbsp;even&nbsp;bother&nbsp;checking&nbsp;any&lt;br&gt;<br>
security&nbsp;on&nbsp;the&nbsp;outgoing&nbsp;server&nbsp;connection&nbsp;when&nbsp;going&nbsp;DIRECT&nbsp;(not&nbsp;to&nbsp;the&lt;br&gt;<br>
cache_peer).&nbsp;Making&nbsp;the&nbsp;sslproxy_cert_error&nbsp;rules&nbsp;useless.&lt;br&gt;&lt;br&gt;&lt;/div&gt;You&#39;ve&nbsp;mentioned&nbsp;this&nbsp;before.&nbsp;The&nbsp;problem&nbsp;is&nbsp;with&nbsp;my&nbsp;squid.conf&nbsp;if&nbsp;it&nbsp;doesn&#39;t&nbsp;have&nbsp;DONT_VERIFY_PEER&nbsp;ssl-bump&nbsp;does&nbsp;not&nbsp;work&nbsp;at&nbsp;all.&nbsp;Is&nbsp;there&nbsp;a&nbsp;better&nbsp;way&nbsp;to&nbsp;setup&nbsp;ssl-bump&nbsp;than&nbsp;what&nbsp;I&nbsp;have&nbsp;that&nbsp;doesn&#39;t&nbsp;use&nbsp;DONT_VERIFY_PEER?&lt;br&gt;&lt;br&gt;&lt;/div&gt;Here&nbsp;is&nbsp;my&nbsp;complete&nbsp;squid.conf.&nbsp;Hope&nbsp;it&nbsp;is&nbsp;helpful.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;style=&quot;margin-left:40px&quot;&gt;&lt;i&gt;visible_hostname&nbsp;smoothwallu3&lt;br&gt;&lt;br&gt;#&nbsp;Uncomment&nbsp;the&nbsp;following&nbsp;to&nbsp;send&nbsp;debug&nbsp;info&nbsp;to&nbsp;/var/log/squid/cache.log&lt;br&gt;#debug_options&nbsp;ALL,1&nbsp;33,2&nbsp;28,9&lt;br&gt;&lt;br&gt;#&nbsp;ACCESS&nbsp;CONTROLS&lt;br&gt;#&nbsp;----------------------------------------------------------------&lt;br&gt;acl&nbsp;localhostgreen&nbsp;src&nbsp;10.3.3.1&lt;br&gt;acl&nbsp;localnetgreen&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.3.3.0/24&quot;&gt;10.3.3.0/24&lt;/a&gt;&lt;br&gt;&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;445&nbsp;443&nbsp;441&nbsp;563&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80 &nbsp;   &nbsp; &nbsp;   &nbsp;#&nbsp;http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;81 &nbsp;   &nbsp; &nbsp;   &nbsp;#&nbsp;smoothwall&nbsp;http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21 &nbsp;   &nbsp; &nbsp;   &nbsp;#&nbsp;ftp&nbsp;&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;445&nbsp;443&nbsp;441&nbsp;563   &nbsp;#&nbsp;https,&nbsp;snews&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70    &nbsp;   &nbsp;   &nbsp;#&nbsp;gopher&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210   &nbsp;   &nbsp;  &nbsp;   &nbsp;#&nbsp;wais &nbsp;&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535   &nbsp;   &nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280      &nbsp;   &nbsp;   &nbsp;#&nbsp;http-mgmt&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488      &nbsp;   &nbsp;   &nbsp;#&nbsp;gss-http&nbsp;&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591      &nbsp;   &nbsp;   &nbsp;#&nbsp;filemaker&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777      &nbsp;   &nbsp;   &nbsp;#&nbsp;multiling&nbsp;http&lt;br&gt;&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;&lt;br&gt;#&nbsp;TAG:&nbsp;http_access&lt;br&gt;#&nbsp;----------------------------------------------------------------&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;localnetgreen&lt;br&gt;http_access&nbsp;allow&nbsp;CONNECT&nbsp;localnetgreen&lt;br&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;localhostgreen&lt;br&gt;http_access&nbsp;allow&nbsp;CONNECT&nbsp;localhostgreen&lt;br&gt;&lt;br&gt;#&nbsp;http_port&nbsp;and&nbsp;https_port&lt;br&gt;#----------------------------------------------------------------------------&lt;br&gt;&lt;br&gt;#&nbsp;For&nbsp;forward-proxy&nbsp;port.&nbsp;Squid&nbsp;uses&nbsp;this&nbsp;port&nbsp;to&nbsp;serve&nbsp;error&nbsp;pages,&nbsp;ftp&nbsp;icons&nbsp;and&nbsp;communication&nbsp;with&nbsp;other&nbsp;proxies.&lt;br&gt;#----------------------------------------------------------------------------&lt;br&gt;http_port&nbsp;3127&lt;br&gt;&lt;br&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://10.3.3.1:800&quot;&gt;10.3.3.1:800&lt;/a&gt;&nbsp;intercept&lt;br&gt;https_port&nbsp;&lt;a&nbsp;href=&quot;http://10.3.3.1:808&quot;&gt;10.3.3.1:808&lt;/a&gt;&nbsp;intercept&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;cert=/var/smoothwall/mods/proxy/ssl_cert/squidCA.pem&lt;br&gt;&lt;br&gt;&lt;br&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://127.0.0.1:800&quot;&gt;127.0.0.1:800&lt;/a&gt;&nbsp;intercept&lt;br&gt;&lt;br&gt;sslproxy_session_cache_size&nbsp;4&nbsp;MB&lt;br&gt;&lt;br&gt;ssl_bump&nbsp;none&nbsp;localhostgreen&lt;br&gt;&lt;br&gt;acl&nbsp;s1_tls_connect     &nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;s2_tls_client_hello&nbsp;at_step&nbsp;SslBump2&lt;br&gt;acl&nbsp;s3_tls_server_hello&nbsp;at_step&nbsp;SslBump3&lt;br&gt;&lt;br&gt;acl&nbsp;tls_server_name_is_ip&nbsp;ssl::server_name_regex&nbsp;^[0-9]+.[0-9]+.[0-9]+.[0-9]+n&lt;br&gt;acl&nbsp;google&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;ssl_bump&nbsp;peek &nbsp;s1_tls_connect     &nbsp;all&lt;br&gt;ssl_bump&nbsp;splice&nbsp;s2_tls_client_hello&nbsp;google&lt;br&gt;ssl_bump&nbsp;stare &nbsp;s2_tls_client_hello&nbsp;all&lt;br&gt;ssl_bump&nbsp;bump &nbsp;s3_tls_server_hello&nbsp;all&lt;br&gt;&lt;br&gt;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://forcesafesearch.google.com&quot;&gt;forcesafesearch.google.com&lt;/a&gt;&nbsp;parent&nbsp;443&nbsp;0&nbsp;ssl&nbsp;name=GS&nbsp;originserver&nbsp;no-query&nbsp;no-netdb-exchange&nbsp;no-digest&lt;br&gt;acl&nbsp;search&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://google.com/imghp&quot;&gt;google.com/imghp&lt;/a&gt;&lt;br&gt;cache_peer_access&nbsp;GS&nbsp;allow&nbsp;search&lt;br&gt;cache_peer_access&nbsp;GS&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;sslproxy_cert_error&nbsp;allow&nbsp;tls_server_name_is_ip&lt;br&gt;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;br&gt;sslcrtd_program&nbsp;/var/smoothwall/mods/proxy/libexec/ssl_crtd&nbsp;-s&nbsp;/var/smoothwall/mods/proxy/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;sslcrtd_children&nbsp;5&lt;br&gt;&lt;br&gt;http_access&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;cache_replacement_policy&nbsp;heap&nbsp;GDSF&lt;br&gt;memory_replacement_policy&nbsp;heap&nbsp;GDSF&lt;br&gt;&lt;br&gt;#&nbsp;CACHE&nbsp;OPTIONS&lt;br&gt;#&nbsp;----------------------------------------------------------------------------&lt;br&gt;cache_effective_user&nbsp;squid&lt;br&gt;cache_effective_group&nbsp;squid&lt;br&gt;&lt;br&gt;cache_swap_high&nbsp;100&lt;br&gt;cache_swap_low&nbsp;80&lt;br&gt;&lt;br&gt;cache_access_log&nbsp;stdio:/var/log/squid/access.log&lt;br&gt;cache_log&nbsp;/var/log/squid/cache.log&lt;br&gt;cache_mem&nbsp;64&nbsp;MB&lt;br&gt;&lt;br&gt;cache_dir&nbsp;diskd&nbsp;/var/spool/squid/cache&nbsp;1024&nbsp;16&nbsp;256&lt;br&gt;&lt;br&gt;maximum_object_size&nbsp;33&nbsp;MB&lt;br&gt;&lt;br&gt;minimum_object_size&nbsp;0&nbsp;KB&lt;br&gt;&lt;br&gt;&lt;br&gt;request_body_max_size&nbsp;0&nbsp;KB&lt;br&gt;&lt;br&gt;#&nbsp;OTHER&nbsp;OPTIONS&lt;br&gt;#&nbsp;----------------------------------------------------------------------------&lt;br&gt;#via&nbsp;off&lt;br&gt;forwarded_for&nbsp;off&lt;br&gt;&lt;br&gt;pid_filename&nbsp;/var/run/squid.pid&lt;br&gt;&lt;br&gt;shutdown_lifetime&nbsp;10&nbsp;seconds&lt;br&gt;#icp_port&nbsp;3130&lt;br&gt;&lt;br&gt;half_closed_clients&nbsp;off&lt;br&gt;&lt;br&gt;umask&nbsp;022&lt;br&gt;&lt;br&gt;logfile_rotate&nbsp;0&lt;br&gt;&lt;br&gt;strip_query_terms&nbsp;off&lt;br&gt;&lt;br&gt;&lt;/i&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Sep&nbsp;4,&nbsp;2015&nbsp;at&nbsp;2:09&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;5/09/2015&nbsp;5:48&nbsp;a.m.,&nbsp;Stanford&nbsp;Prescott&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;tried&nbsp;to&nbsp;enable&nbsp;safe&nbsp;searching&nbsp;with&nbsp;Squid&nbsp;3.5.7&nbsp;using&nbsp;ssl-bump&lt;br&gt;<br>
&gt;&nbsp;splice&nbsp;but&nbsp;when&nbsp;I&nbsp;enable&nbsp;it,&nbsp;browsing&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://google.com&lt;/a&gt;&nbsp;generates&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;error&nbsp;page&nbsp;saying&nbsp;there&nbsp;is&nbsp;no&nbsp;valid&nbsp;certificate.&nbsp;Browsing&nbsp;to&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;other&nbsp;https&nbsp;sites&nbsp;loads&nbsp;the&nbsp;pages&nbsp;correctly&nbsp;and&nbsp;all&nbsp;other&nbsp;SSL-bump&nbsp;sites&lt;br&gt;<br>
&gt;&nbsp;get&nbsp;bumped&nbsp;and&nbsp;displayed&nbsp;correctly.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Has&nbsp;anyone&nbsp;had&nbsp;any&nbsp;luck&nbsp;getting&nbsp;this&nbsp;to&nbsp;work?&nbsp;Here&nbsp;is&nbsp;the&nbsp;relevant&lt;br&gt;<br>
&gt;&nbsp;squid.conf&nbsp;entries&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Please&nbsp;use&nbsp;3.5.8.&nbsp;The&nbsp;ssl_bump&nbsp;behaviour&nbsp;got&nbsp;some&nbsp;more&nbsp;important&nbsp;fixes&lt;br&gt;<br>
recently.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;s1_tls_connect&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;s2_tls_client_hello&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;s3_tls_server_hello&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;tls_server_name_is_ip&nbsp;ssl::server_name_regex&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;^[0-9]+.[0-9]+.[0-9]+.[0-9]+n&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;have&nbsp;a&nbsp;letter&nbsp;&#39;n&#39;&nbsp;on&nbsp;the&nbsp;end&nbsp;there&nbsp;is&nbsp;that&nbsp;intentional?&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;google&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;s1_tls_connect&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;nobumpSites&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://wellsfargo.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;wellsfargo.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;s2_tls_client_hello&nbsp;nobumpSites&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;s2_tls_client_hello&nbsp;google&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;stare&nbsp;s2_tls_client_hello&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;s3_tls_server_hello&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://forcesafesearch.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;forcesafesearch.google.com&lt;/a&gt;&nbsp;parent&nbsp;443&nbsp;0&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;ssl&nbsp;name=GS&nbsp;originserver&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;no-query&nbsp;no-netdb-exchange&nbsp;no-digest&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;search&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;GS&nbsp;allow&nbsp;search&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;GS&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;think&nbsp;the&nbsp;fake-CONNECT&nbsp;Squid&nbsp;creates&nbsp;still&nbsp;has&nbsp;only&nbsp;raw-IP:port&lt;br&gt;<br>
details.&nbsp;And&nbsp;with&nbsp;splicing&nbsp;you&nbsp;dont&nbsp;have&nbsp;the&nbsp;decrypt&nbsp;to&nbsp;setup&nbsp;dstdomain&lt;br&gt;<br>
URL&nbsp;details.&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;dstdomain&nbsp;you&nbsp;need&nbsp;to&nbsp;match&nbsp;what&nbsp;shows&nbsp;up&nbsp;in&nbsp;access.log&nbsp;as&nbsp;the&nbsp;URI&lt;br&gt;<br>
of&nbsp;these&nbsp;requests.&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;the&nbsp;&quot;google&quot;&nbsp;ACL&nbsp;work&nbsp;in&nbsp;cache_peer_access&nbsp;to&nbsp;use&nbsp;the&nbsp;SNI?&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslproxy_cert_error&nbsp;allow&nbsp;tls_server_name_is_ip&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;The&nbsp;flag&nbsp;DONT_VERIFY_PEER&nbsp;tells&nbsp;Squid&nbsp;not&nbsp;to&nbsp;even&nbsp;bother&nbsp;checking&nbsp;any&lt;br&gt;<br>
security&nbsp;on&nbsp;the&nbsp;outgoing&nbsp;server&nbsp;connection&nbsp;when&nbsp;going&nbsp;DIRECT&nbsp;(not&nbsp;to&nbsp;the&lt;br&gt;<br>
cache_peer).&nbsp;Making&nbsp;the&nbsp;sslproxy_cert_error&nbsp;rules&nbsp;useless.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
