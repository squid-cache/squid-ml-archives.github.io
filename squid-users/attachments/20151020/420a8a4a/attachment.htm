<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana;font-size:&nbsp;12.0px;&quot;&gt;&lt;div&gt;<br>
&lt;div&gt;Hi&nbsp;All,&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;I&#39;ve&nbsp;been&nbsp;following&nbsp;the&nbsp;guide&nbsp;at&nbsp;this&nbsp;location&nbsp;for&nbsp;Active&nbsp;Directory&nbsp;integration&lt;br/&gt;<br>
http://wiki.bitbinary.com/index.php/Active_Directory_Integrated_Squid_Proxy&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
First,&nbsp;some&nbsp;versions&nbsp;for&nbsp;sanity..&lt;br/&gt;<br>
Ubuntu&nbsp;:&nbsp;14.04.3&nbsp;LTS&lt;br/&gt;<br>
Squid&nbsp;&nbsp;:&nbsp;3.3.8&nbsp;(from&nbsp;ubuntu&nbsp;repositories)&lt;br/&gt;<br>
Samba&nbsp;&nbsp;:&nbsp;4.1.6-Ubuntu&lt;br/&gt;<br>
DC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Windows&nbsp;Server&nbsp;2012&nbsp;R2&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
I&nbsp;am&nbsp;currently&nbsp;testing&nbsp;the&nbsp;authentication,&nbsp;negotiate&nbsp;kerberos&nbsp;and&nbsp;basic&nbsp;ldap&nbsp;are&nbsp;both&nbsp;working&nbsp;correctly.&nbsp;However&nbsp;ntlm&nbsp;is&nbsp;not&nbsp;and&nbsp;I&nbsp;don&#39;t&nbsp;seem&nbsp;to&nbsp;making&nbsp;any&nbsp;progress&nbsp;on&nbsp;debugging&nbsp;further.&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
Here&nbsp;is&nbsp;the&nbsp;relevant&nbsp;part&nbsp;of&nbsp;squid.conf&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
###&nbsp;negotiate&nbsp;kerberos&nbsp;and&nbsp;ntlm&nbsp;authentication&lt;br/&gt;<br>
auth_param&nbsp;negotiate&nbsp;program&nbsp;/usr/lib/squid3/negotiate_wrapper_auth&nbsp;-d&nbsp;--ntlm&nbsp;/usr/bin/ntlm_auth&nbsp;--diagnostics&nbsp;--helper-protocol=squid-2.5-ntlmssp&nbsp;--domain=DOMAIN&nbsp;--kerberos&nbsp;/usr/lib/squid3/negotiate_kerberos_auth&nbsp;-d&nbsp;-s&nbsp;GSS_C_NO_NAME&lt;br/&gt;<br>
auth_param&nbsp;negotiate&nbsp;children&nbsp;10&lt;br/&gt;<br>
auth_param&nbsp;negotiate&nbsp;keep_alive&nbsp;off&lt;br/&gt;<br>
###&nbsp;pure&nbsp;ntlm&nbsp;authentication&lt;br/&gt;<br>
auth_param&nbsp;ntlm&nbsp;program&nbsp;/usr/bin/ntlm_auth&nbsp;--diagnostics&nbsp;--helper-protocol=squid-2.5-ntlmssp&nbsp;--domain=DOMAIN&lt;br/&gt;<br>
auth_param&nbsp;ntlm&nbsp;children&nbsp;10&lt;br/&gt;<br>
auth_param&nbsp;ntlm&nbsp;keep_alive&nbsp;off&lt;br/&gt;<br>
###&nbsp;provide&nbsp;basic&nbsp;authentication&nbsp;via&nbsp;ldap&nbsp;for&nbsp;clients&nbsp;not&nbsp;authenticated&nbsp;via&nbsp;kerberos/ntlm&lt;br/&gt;<br>
auth_param&nbsp;basic&nbsp;program&nbsp;/usr/lib/squid3/basic_ldap_auth&nbsp;-R&nbsp;-b&nbsp;&quot;DC=domain,DC=local&quot;&nbsp;-D&nbsp;proxyuser@domain.local&nbsp;-W&nbsp;/etc/squid3/ldappass.txt&nbsp;-f&nbsp;sAMAccountName=%s&nbsp;-h&nbsp;dc1.domain.local&lt;br/&gt;<br>
auth_param&nbsp;basic&nbsp;children&nbsp;10&lt;br/&gt;<br>
auth_param&nbsp;basic&nbsp;realm&nbsp;Internet&nbsp;Proxy&lt;br/&gt;<br>
auth_param&nbsp;basic&nbsp;credentialsttl&nbsp;30&nbsp;minutes&lt;br/&gt;<br>
###&nbsp;ldap&nbsp;authorisation&lt;br/&gt;<br>
external_acl_type&nbsp;memberof&nbsp;%LOGIN&nbsp;/usr/lib/squid3/ext_ldap_group_acl&nbsp;-R&nbsp;-K&nbsp;-S&nbsp;-b&nbsp;&quot;DC=domain,DC=local&quot;&nbsp;-D&nbsp;proxyuser@domain.local&nbsp;-W&nbsp;/etc/squid3/ldappass.txt&nbsp;-f&nbsp;&quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,OU=Proxy,DC=domain,DC=local))&quot;&nbsp;-h&nbsp;dc1.domain.local&lt;br/&gt;<br>
&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;With&nbsp;kerberos&nbsp;and&nbsp;ldap&nbsp;working&nbsp;correctly,&nbsp;this&nbsp;seems&nbsp;to&nbsp;cover&nbsp;all&nbsp;my&nbsp;users,&nbsp;except&nbsp;for&nbsp;non-domain&nbsp;joined&nbsp;internet&nbsp;explorer,&nbsp;which&nbsp;unfortunately&nbsp;I&nbsp;still&nbsp;need&nbsp;to&nbsp;cater&nbsp;for.&lt;br/&gt;<br>
For&nbsp;testing&nbsp;I&nbsp;have&nbsp;allowed&nbsp;the&nbsp;proxy&nbsp;user&nbsp;to&nbsp;login.&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
The&nbsp;following&nbsp;commands&nbsp;work&nbsp;successfully&nbsp;as&nbsp;proxy&nbsp;user&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
wbinfo&nbsp;-p&lt;br/&gt;<br>
wbinfo&nbsp;-u&lt;br/&gt;<br>
wbinfo&nbsp;-g&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
wbinfo&nbsp;-t&nbsp;does&nbsp;not&nbsp;run&nbsp;successfully&nbsp;as&nbsp;proxy&nbsp;user,&nbsp;but&nbsp;does&nbsp;run&nbsp;as&nbsp;root.&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
testing&nbsp;ntlm_auth&nbsp;at&nbsp;the&nbsp;command&nbsp;line&nbsp;works&nbsp;correctly.&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
ntlm_auth&nbsp;--helper-protocol=squid-2.5-basic&lt;br/&gt;<br>
DOMAIN&#92;user&nbsp;password&lt;br/&gt;<br>
OK&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;When&nbsp;a&nbsp;non-domain&nbsp;joined&nbsp;user&nbsp;with&nbsp;internet&nbsp;explorer&nbsp;attempt&nbsp;to&nbsp;use&nbsp;the&nbsp;proxy,&nbsp;they&nbsp;are&nbsp;continually&nbsp;prompted&nbsp;for&nbsp;credentials.&nbsp;In&nbsp;/var/log/cache.log,&nbsp;I&nbsp;see:&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Got&nbsp;&#39;YR&nbsp;TlRMTVNTUAABAAAAl4II4gAAAAAAAAAAAAAAAAAAAAAGA4AlAAAADw==&#39;&nbsp;from&nbsp;squid&nbsp;(length:&nbsp;59).&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Decode&nbsp;&#39;TlRMTVNTUAABAAAAl4II4gAAAAAAAAAAAAAAAAAAAAAGA4AlAAAADw==&#39;&nbsp;(decoded&nbsp;length:&nbsp;40).&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;received&nbsp;type&nbsp;1&nbsp;NTLM&nbsp;token&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Return&nbsp;&#39;TT&nbsp;TlRMTVNTUAACAAAAEAAQADgAAAAVgoninreK53QrtdEAAAAAAAAAADgAOABIAAAABgEAAAAAAA9JAE4AUwBFAEMAVQBSAEUAAgAQAEkATgBTAEUAQwBVAFIARQABAAoAUABSAE8AWABZAAQAAAADAAoAcAByAG8AeAB5AAAAAAA=&lt;br/&gt;<br>
&#39;&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Got&nbsp;&#39;KK&nbsp;TlRMTVNTUAADAAAAGAAYAHQAAADYANgAjAAAABAAEABYAAAACAAIAGgAAAAEAAQAcAAAABAAEABkAQAAFYKI4gYDgCUAAAAP4J12bZve1C56VHP1YUJ5N2kAbgBzAGUAYwB1AHIAZQBiAHIAYQBkAEkATwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAI1+mUr3xj8iMVIytXIZcbAQEAAAAAAADgQryt3wrRAStLKXVkL/kDAAAAAAIAEABJAE4AUwBFAEMAVQBSAEUAAQAKAFAAUgBPAFgAWQAEAAAAAwAKAHAAcgBvAHgAeQAIADAAMAAAAAAAAAABAAAAABAAALfe6ZoORXwOZjR0QdSusCHwlNUGYo79byijLZDZARCDCgAQAAAAAAAAAAAAAAAAAAAAAAAJACQASABUAFQAUAAvADEANwAyAC4AMgA4AC4AMgA5AC4AMQA0ADcAAAAAAAAAAACEC4x7NJBCdMLgU3gJ6QTq&#39;&nbsp;from&nbsp;squid&nbsp;(length:&nbsp;499).&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Decode&nbsp;&#39;TlRMTVNTUAADAAAAGAAYAHQAAADYANgAjAAAABAAEABYAAAACAAIAGgAAAAEAAQAcAAAABAAEABkAQAAFYKI4gYDgCUAAAAP4J12bZve1C56VHP1YUJ5N2kAbgBzAGUAYwB1AHIAZQBiAHIAYQBkAEkATwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAI1+mUr3xj8iMVIytXIZcbAQEAAAAAAADgQryt3wrRAStLKXVkL/kDAAAAAAIAEABJAE4AUwBFAEMAVQBSAEUAAQAKAFAAUgBPAFgAWQAEAAAAAwAKAHAAcgBvAHgAeQAIADAAMAAAAAAAAAABAAAAABAAALfe6ZoORXwOZjR0QdSusCHwlNUGYo79byijLZDZARCDCgAQAAAAAAAAAAAAAAAAAAAAAAAJACQASABUAFQAUAAvADEANwAyAC4AMgA4AC4AMgA5AC4AMQA0ADcAAAAAAAAAAACEC4x7NJBCdMLgU3gJ6QTq&#39;&nbsp;(decoded&nbsp;length:&nbsp;372).&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;received&nbsp;type&nbsp;3&nbsp;NTLM&nbsp;token&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;negotiate_wrapper:&nbsp;Return&nbsp;&#39;BH&nbsp;NT_STATUS_UNSUCCESSFUL&nbsp;NT_STATUS_UNSUCCESSFUL&lt;br/&gt;<br>
&#39;&lt;br/&gt;<br>
2015/10/20&nbsp;12:33:19&#124;&nbsp;ERROR:&nbsp;Negotiate&nbsp;Authentication&nbsp;validating&nbsp;user.&nbsp;Error&nbsp;returned&nbsp;&#39;BH&nbsp;NT_STATUS_UNSUCCESSFUL&nbsp;NT_STATUS_UNSUCCESSFUL&#39;&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
Can&nbsp;anyone&nbsp;give&nbsp;me&nbsp;any&nbsp;pointers&nbsp;on&nbsp;what&nbsp;I&nbsp;am&nbsp;doing&nbsp;incorrectly?&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
Thank&nbsp;you.&lt;br/&gt;<br>
&nbsp;&lt;br/&gt;<br>
Ilias&lt;br/&gt;<br>
&nbsp;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>
<br>

</tt>
