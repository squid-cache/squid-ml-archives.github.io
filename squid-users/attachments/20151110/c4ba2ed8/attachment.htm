<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;font-family:&nbsp;Monospace;&quot;&gt;<br>
&lt;div&gt;Hi,&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;needed&nbsp;to&nbsp;setup&nbsp;Squid&nbsp;as&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;with&nbsp;SSL&nbsp;bumping&nbsp;for&nbsp;only&nbsp;one&nbsp;single&nbsp;https&nbsp;website.&lt;/div&gt;<br>
&lt;div&gt;The&nbsp;goal&nbsp;was&nbsp;to&nbsp;bump&nbsp;https&nbsp;connections&nbsp;to&nbsp;this&nbsp;website&nbsp;with&nbsp;its&nbsp;offical&nbsp;signed&nbsp;SSL&nbsp;certificate.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;As&nbsp;an&nbsp;illustration:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Website/hostname:&nbsp;https://abc.mydomain.com&lt;/div&gt;<br>
&lt;div&gt;DNS:&nbsp;abc.mydomain.com&nbsp;A&nbsp;1.2.3.4&lt;/div&gt;<br>
&lt;div&gt;Official&nbsp;wildcard&nbsp;certificate:&nbsp;CN&nbsp;=&nbsp;*.mydomain.com&nbsp;(server.crt,&nbsp;server.key)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;used&nbsp;Squid&nbsp;3.4.10&nbsp;from&nbsp;CentOS&nbsp;repository&nbsp;and&nbsp;configured&nbsp;iptables&nbsp;DNAT&nbsp;rules&nbsp;for&nbsp;intercepting.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Squid&nbsp;config:&lt;/div&gt;<br>
&lt;div&gt;https_port&nbsp;&lt;squid-ip&gt;:3443&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=&lt;server.crt&gt;&nbsp;key=&lt;server.key&gt;&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;MYSITE&nbsp;dst&nbsp;1.2.3.4&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;server-first&nbsp;MYSITE&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;none&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Everything&nbsp;worked&nbsp;perfectly.&nbsp;All&nbsp;traffic&nbsp;to&nbsp;https://abc.mydomain.com&nbsp;was&nbsp;bumped&nbsp;for&nbsp;caching&nbsp;purposes,&lt;/div&gt;<br>
&lt;div&gt;all&nbsp;traffic&nbsp;to&nbsp;other&nbsp;https&nbsp;websites&nbsp;was&nbsp;simply&nbsp;tunneled.&nbsp;Squid&nbsp;did&nbsp;not&nbsp;need&nbsp;to&nbsp;generate&nbsp;faked&nbsp;server&nbsp;certificates&lt;/div&gt;<br>
&lt;div&gt;and&nbsp;clients&nbsp;were&nbsp;left&nbsp;untouched&nbsp;(no&nbsp;proxy&nbsp;settings,&nbsp;no&nbsp;self-signed&nbsp;CA).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Now&nbsp;some&nbsp;parts&nbsp;of&nbsp;the&nbsp;website&nbsp;are&nbsp;delivered&nbsp;by&nbsp;Amazon&nbsp;CloudFront.&nbsp;CloudFront&nbsp;has&nbsp;the&nbsp;SSL&nbsp;certificate&nbsp;installed&lt;/div&gt;<br>
&lt;div&gt;(same&nbsp;official&nbsp;signed&nbsp;certificate&nbsp;as&nbsp;mentiod&nbsp;above).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Additional&nbsp;website/hostname:&nbsp;https://xyz.mydomain.com&lt;/div&gt;<br>
&lt;div&gt;DNS:&nbsp;xyz.mydomain.com&nbsp;CNAME&nbsp;&lt;distribution&gt;.cloudfront.net&lt;/div&gt;<br>
&lt;div&gt;Official&nbsp;wildcard&nbsp;certificate:&nbsp;CN&nbsp;=&nbsp;*.mydomain.com&nbsp;(server.crt,&nbsp;server.key)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;cannot&nbsp;simply&nbsp;extend&nbsp;my&nbsp;ACL&nbsp;with&nbsp;all&nbsp;destination&nbsp;IPs&nbsp;used&nbsp;by&nbsp;CloudFront,&nbsp;because&nbsp;these&nbsp;are&nbsp;shared&nbsp;IPs&nbsp;and&lt;/div&gt;<br>
&lt;div&gt;CloudFront&nbsp;needs&nbsp;to&nbsp;know&nbsp;which&nbsp;domain/hostname&nbsp;is&nbsp;asked&nbsp;to&nbsp;provide&nbsp;the&nbsp;correct&nbsp;certificate.&nbsp;Usually&nbsp;a&nbsp;client&lt;/div&gt;<br>
&lt;div&gt;uses&nbsp;the&nbsp;SNI&nbsp;extension&nbsp;of&nbsp;TLS&nbsp;to&nbsp;transmit&nbsp;the&nbsp;required&nbsp;domain/hostname.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;have&nbsp;heard&nbsp;of&nbsp;the&nbsp;new&nbsp;&quot;SSL&nbsp;Peek&nbsp;and&nbsp;Splice&quot;&nbsp;feature&nbsp;in&nbsp;Squid&nbsp;3.5&nbsp;but&nbsp;don't&nbsp;get&nbsp;it&nbsp;working&nbsp;(Squid&nbsp;3.5.9).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;My&nbsp;assumption&nbsp;is&nbsp;that&nbsp;I&nbsp;have&nbsp;to&nbsp;use&nbsp;in&nbsp;Squid's&nbsp;config:&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;https_port&nbsp;&lt;squid-ip&gt;:3443&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=&lt;server.crt&gt;&nbsp;key=&lt;server.key&gt;&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;MYSITE&nbsp;ssl:server_name&nbsp;.mydomain.com&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;bump&nbsp;MYSITE&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;splice&nbsp;all&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;This&nbsp;results&nbsp;in&nbsp;tunneling&nbsp;all&nbsp;https&nbsp;traffic,&nbsp;nothing&nbsp;will&nbsp;be&nbsp;bumped&nbsp;and&nbsp;cached.&nbsp;I'm&nbsp;a&nbsp;little&nbsp;bit&nbsp;confused&nbsp;about&nbsp;the&lt;/div&gt;<br>
&lt;div&gt;documentation:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Under&nbsp;the&nbsp;headline&nbsp;&quot;Processing&nbsp;steps&quot;:&lt;/div&gt;<br>
&lt;div&gt;&lt;b&gt;Step&nbsp;2:&lt;/b&gt;&lt;/div&gt;<br>
&lt;p&nbsp;class=&quot;line867&quot;&gt;&lt;span&nbsp;class=&quot;anchor&quot;&nbsp;id=&quot;line-51&quot;&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;ol&nbsp;type=&quot;i&quot;&gt;<br>
&lt;li&gt;Get&nbsp;TLS&nbsp;clientHello&nbsp;info,&nbsp;including&nbsp;&lt;b&gt;SNI&lt;/b&gt;&nbsp;where&nbsp;available.&nbsp;&lt;/li&gt;&lt;/ol&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Under&nbsp;the&nbsp;headline&nbsp;&quot;Actions&quot;:&lt;/div&gt;<br>
&lt;div&gt;peek/stare&nbsp;Receive&nbsp;client&nbsp;&lt;b&gt;SNI&nbsp;(step1)&lt;/b&gt;,&nbsp;...&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;achieve&nbsp;my&nbsp;goal&nbsp;with&nbsp;Squid&nbsp;in&nbsp;transparent&nbsp;mode?&lt;/div&gt;<br>
&lt;div&gt;In&nbsp;other&nbsp;words:&nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;bump&nbsp;https&nbsp;connections&nbsp;to&nbsp;destinations&nbsp;with&nbsp;shared&nbsp;IPs?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Best,&lt;/div&gt;<br>
&lt;div&gt;Stefan&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
