<tt>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;think&nbsp;it&nbsp;is&nbsp;better&nbsp;to&nbsp;translate&nbsp;this&nbsp;code&nbsp;to&nbsp;c.&nbsp;Contact&nbsp;me,&nbsp;having&nbsp;c&nbsp;will&nbsp;give&nbsp;you&nbsp;speed&nbsp;and&nbsp;memory&nbsp;savings.&lt;/p&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Le&nbsp;13&nbsp;nov.&nbsp;2015&nbsp;8:22&nbsp;PM,&nbsp;&quot;Jens&nbsp;Kallup&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jkallup@web.de&quot;&gt;jkallup@web.de&lt;/a&gt;&gt;&nbsp;a&nbsp;écrit :&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;have&nbsp;problems&nbsp;to&nbsp;block&nbsp;web&nbsp;sites &nbsp;listet&nbsp;in&nbsp;mysql&nbsp;database.&lt;br&gt;<br>
When&nbsp;i&nbsp;start&nbsp;the&nbsp;script&nbsp;below,&nbsp;it&nbsp;works,&nbsp;but&nbsp;squid3.4&nbsp;give&nbsp;me&nbsp;log&nbsp;output;&lt;br&gt;<br>
&lt;br&gt;<br>
2015/11/14&nbsp;01:27:40&nbsp;kid1|&nbsp;helperHandleRead:&nbsp;unexpected&nbsp;read&nbsp;from&nbsp;blockscript&nbsp;#Hlpr0,&nbsp;3&nbsp;bytes&nbsp;&#39;OK&lt;br&gt;<br>
&lt;br&gt;<br>
how&nbsp;can&nbsp;i&nbsp;fix&nbsp;that&nbsp;problem&nbsp;?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&nbsp;in&nbsp;advice&lt;br&gt;<br>
Jens&lt;br&gt;<br>
&lt;br&gt;<br>
#!/usr/bin/php&lt;br&gt;<br>
&lt;?php&lt;br&gt;<br>
$db&nbsp;=&nbsp;new&nbsp;mysqli(&quot;&lt;server&gt;&quot;,&nbsp;&quot;&lt;user&gt;&quot;,&nbsp;&quot;&lt;password&gt;&quot;,&nbsp;&quot;&lt;database&gt;&quot;);&lt;br&gt;<br>
if&nbsp;($db-&gt;connect_error&nbsp;&gt;&nbsp;0)&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp;die(fwrite(STDOUT,&quot;ERR\n&quot;));&lt;br&gt;<br>
}&lt;br&gt;<br>
while&nbsp;(!feof(STDIN))&lt;br&gt;<br>
{&lt;br&gt;<br>
 &nbsp; &nbsp;$i&nbsp;=&nbsp;trim(fgets(STDIN));&lt;br&gt;<br>
 &nbsp; &nbsp;$s&nbsp;=&nbsp;explode(&quot;&nbsp;&quot;,&nbsp;$i);&lt;br&gt;<br>
 &nbsp; &nbsp;$dst&nbsp;=&nbsp;$s[0];&lt;br&gt;<br>
 &nbsp; &nbsp;$row&nbsp;=&nbsp;array();&lt;br&gt;<br>
 &nbsp; &nbsp;$query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;squid&nbsp;WHERE&nbsp;name&nbsp;=&nbsp;&#39;$dst&#39;&quot;;&lt;br&gt;<br>
 &nbsp; &nbsp;if&nbsp;($res&nbsp;=&nbsp;$db-&gt;query($query))&nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;$row&nbsp;=&nbsp;$res-&gt;fetch_row();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;$rec&nbsp;=&nbsp;$res-&gt;num_rows;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(($row[2]&nbsp;==&nbsp;1)&nbsp;||&nbsp;($rec&nbsp;&lt;&nbsp;1))&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fwrite(STDOUT,&quot;ERR\n&quot;);&nbsp;else&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fwrite(STDOUT,&quot;OK\n&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;$res-&gt;close();&lt;br&gt;<br>
 &nbsp; &nbsp;}&lt;br&gt;<br>
}&lt;br&gt;<br>
$db-&gt;close();&lt;br&gt;<br>
?&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
this&nbsp;is&nbsp;my&nbsp;squid.config&lt;br&gt;<br>
&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;program&nbsp;/usr/lib/squid3/basic_ncsa_auth&nbsp;/sap/squid/passwd&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;children&nbsp;4&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;utf8&nbsp;on&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;realm&nbsp;Bitte&nbsp;geben&nbsp;Sie&nbsp;Ihren&nbsp;Benutzernamen&nbsp;und&nbsp;Passwort&nbsp;fuer&nbsp;die&nbsp;Internetberechtigung&nbsp;ein!&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;credentialsttl&nbsp;60&nbsp;minutes&lt;br&gt;<br>
auth_param&nbsp;basic&nbsp;casesensitive&nbsp;on&lt;br&gt;<br>
external_acl_type&nbsp;blockscript&nbsp;%DST&nbsp;/usr/bin/php&nbsp;/sap/squid/block.php&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;192.168.178.7&lt;br&gt;<br>
acl&nbsp;ncsa_users&nbsp;proxy_auth&nbsp;REQUIRED&lt;br&gt;<br>
acl&nbsp;mysql_block&nbsp;external&nbsp;blockscript&lt;br&gt;<br>
acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;80 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;21 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;ftp&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;443 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;https&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;70 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;gopher&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;210 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;wais&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535 &nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;280 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;http-mgmt&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;488 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;gss-http&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;591 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;filemaker&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;777 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;multiling&nbsp;http&lt;br&gt;<br>
acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
#&nbsp;Deny&nbsp;requests&nbsp;to&nbsp;certain&nbsp;unsafe&nbsp;ports&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
#&nbsp;Deny&nbsp;CONNECT&nbsp;to&nbsp;other&nbsp;than&nbsp;secure&nbsp;SSL&nbsp;ports&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
#&lt;br&gt;<br>
#&nbsp;INSERT&nbsp;YOUR&nbsp;OWN&nbsp;RULE(S)&nbsp;HERE&nbsp;TO&nbsp;ALLOW&nbsp;ACCESS&nbsp;FROM&nbsp;YOUR&nbsp;CLIENTS&lt;br&gt;<br>
#&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;mysql_block&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&nbsp;ncsa_users&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localnet &nbsp;ncsa_users&lt;br&gt;<br>
#&nbsp;And&nbsp;finally&nbsp;deny&nbsp;all&nbsp;other&nbsp;access&nbsp;to&nbsp;this&nbsp;proxy&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
http_port&nbsp;3128&lt;br&gt;<br>
cache_mgr&nbsp;&lt;a&nbsp;href=&quot;mailto:jkallup@web.de&quot;&nbsp;target=&quot;_blank&quot;&gt;jkallup@web.de&lt;/a&gt;&lt;br&gt;<br>
cache_effective_user&nbsp;squid&lt;br&gt;<br>
#&nbsp;We&nbsp;recommend&nbsp;you&nbsp;to&nbsp;use&nbsp;at&nbsp;least&nbsp;the&nbsp;following&nbsp;line.&lt;br&gt;<br>
hierarchy_stoplist&nbsp;cgi-bin&nbsp;?&lt;br&gt;<br>
cache_dir&nbsp;ufs&nbsp;/sap/var/spool/squid&nbsp;64&nbsp;16&nbsp;128&lt;br&gt;<br>
cache_access_log&nbsp;/sap/squid/log/access.log&lt;br&gt;<br>
cache_log &nbsp; &nbsp; &nbsp; &nbsp;/sap/squid/log/cache.log&lt;br&gt;<br>
cache_store_log &nbsp;/sap/squid/log/store.log&lt;br&gt;<br>
#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir&lt;br&gt;<br>
coredump_dir&nbsp;/sap/var/spool/squid&lt;br&gt;<br>
#&nbsp;Add&nbsp;any&nbsp;of&nbsp;your&nbsp;own&nbsp;refresh_pattern&nbsp;entries&nbsp;above&nbsp;these.&lt;br&gt;<br>
refresh_pattern&nbsp;^ftp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1440 &nbsp; &nbsp;20%&nbsp;10080&lt;br&gt;<br>
refresh_pattern&nbsp;^gopher: &nbsp; &nbsp; &nbsp; &nbsp;1440 &nbsp; &nbsp;0% &nbsp;1440&lt;br&gt;<br>
refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0 &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp;0&lt;br&gt;<br>
refresh_pattern&nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; 20%&nbsp;4320&lt;br&gt;<br>
logformat&nbsp;squid &nbsp;%tl.%03tu&nbsp;%6tr&nbsp;%&gt;a&nbsp;%un&nbsp;%Ss/%03&gt;Hs&nbsp;%&lt;st&nbsp;%rm&nbsp;%ru&nbsp;%Sh/%&lt;A&nbsp;%mt&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
