#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
#http_access deny !Safe_ports

cache_mgr ICZ_IT@inventec.com
append_domain .icz.inventec

#http_port 10.13.3.30:80 vhost vport=8080 defaultsite=*ICZ-SQUID\squidreport*

# Deny CONNECT to other than secure SSL ports
#http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost
# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed

#########################################
#	Enable KERBEROS authentication	#
#########################################

auth_param negotiate program /usr/local/bin/negotiate_wrapper -d --ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=ICZ --kerberos /usr/lib64/squid/negotiate_kerberos_auth -d -s GSS_C_NO_NAME
auth_param negotiate children 160 startup=5 idle=1
auth_param negotiate keep_alive off


#########################################
#	Enable NTLM authentication	#
#########################################

auth_param ntlm program /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=ICZ
auth_param ntlm children 160 startup=5 idle=1
auth_param ntlm keep_alive off


#########################################
# 	ENABLE LDAP AUTH		#
#########################################

#auth_param basic program /usr/lib64/squid/basic_ldap_auth -R -b "dc=icz,dc=inventec" -D squid@icz.inventec -W /etc/squid/ldappass.txt -f sAMAccountName=%s -h icz-dc-1.icz.inventec
#auth_param basic children 10
#auth_param basic realm Please enter user name to access the internet
#auth_param basic credentialsttl 1 hour

external_acl_type ldap_group ttl=3600 negative_ttl=0 children-max=160 children-startup=10  %LOGIN /usr/lib64/squid/ext_wbinfo_group_acl


#external_acl_type ldap_group ttl=320 ipv4 %LOGIN /usr/lib64/squid/ext_ldap_group_acl -d -R -P -b "dc=icz,dc=inventec" -D squid -W "/etc/squid/ldappass.txt" -f "(&(objectClass=person)(sAMAccountname=%u)(memberOf=cn=%g,ou=icz,dc=icz,dc=inventec))" -h icz-dc-1
#acl AuthUsers external nt_group ICZ_Proxy_Anonymous



#########################################
# DEFINE ACL Groups based on AD groups	#
#################################################################################
#   aclname		acltype  	typename	activedirectorygroup	#
#################################################################################
acl AnonymousAccess 	external 	ldap_group 	Icz_Proxy_Anonymous
acl FullAccess	 	external 	ldap_group 	Icz_Proxy_Full
acl StandardAccess 	external 	ldap_group 	ICZ_Proxy_Standard
acl ExceptionAccess 	external 	ldap_group 	ICZ_Proxy_Exception
acl RestrictedAccess 	external	ldap_group 	ICZ_Proxy_Restricted
acl BlockedAccess	external 	ldap_group 	ICZ_Proxy_Blocked

#################################################################################
#   aclname		acltype  	file with web list			#
#################################################################################
acl allowedsites        dstdomain -i 	"/etc/squid/WEB_allowedsites.txt"
acl blockedsites        dstdomain -i	"/etc/squid/WEB_blockedsites.txt"
acl exceptedsites       dstdomain -i	"/etc/squid/WEB_exceptedsites.txt"
acl prioritysites       dstdomain -i	"/etc/squid/WEB_prioritysites.txt"


#acl allowed_time time T 00:00-12:00
#acl blockfiles urlpath_regex -i \.[Ee][Xx][Ee]$
#acl rule2 url_regex -i www.ign.com
#reply_body_max_size 30 MB allowed_time


acl auth proxy_auth REQUIRED


#########################################
# 	Safe Ports			#
#########################################
acl SSL_ports port 443
acl Safe_ports port 80      # http
acl Safe_ports port 21      # ftp
acl Safe_ports port 443     # https
acl Safe_ports port 70      # gopher
acl Safe_ports port 210     # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280     # http-mgmt
acl Safe_ports port 488     # gss-http
acl Safe_ports port 591     # filemaker
acl Safe_ports port 777     # multiling http
acl CONNECT method CONNECT

acl zabbix snmp_community icz-public

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost

#########################################
#	HTTP Access Rules		#
#################################################################################
# allow unrestricted access to prioritysites					#
#################################################################################


# enforce authentication, order of rules is important for authorization levels
http_access deny !auth

http_access allow prioritysites

# prevent access to basic auth prompt for BlockedAccess users
http_access deny BlockedAccess all
http_access allow allowedsites
http_access deny RestrictedAccess all
http_access allow AnonymousAccess auth
http_access allow FullAccess auth
http_access allow ExceptionAccess exceptedsites auth
http_access deny blockedsites
http_access allow StandardAccess auth


http_access deny all


# Squid normally listens to port 3128
http_port 80

# Uncomment and adjust the following to add a disk cache directory.
#cache_dir ufs /var/spool/squid 100 16 256

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

#########################################
# 	SNMP Zabbix Monitoring		#
#########################################
snmp_access allow zabbix
snmp_port 3401

forwarded_for off
cache_mem 512 MB

#access_log /var/log/squid/access.log squid FullAccess !allowedsites !prioritysites !AnonymousAccess

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320