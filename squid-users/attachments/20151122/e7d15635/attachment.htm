<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;<br>
&quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;title&gt;&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;font-family:Arial;font-size:14px&quot;&gt;<br>
&lt;p&gt;I'm&nbsp;running&nbsp;Squid&nbsp;3.5.10&nbsp;on&nbsp;Debian&nbsp;Jessie&nbsp;and&nbsp;after&nbsp;some&nbsp;hours&nbsp;of&nbsp;execution&nbsp;it&nbsp;runs&nbsp;out&nbsp;of&nbsp;file&nbsp;descriptors.&lt;br&gt;<br>
Squid&nbsp;is&nbsp;listening&nbsp;on&nbsp;port&nbsp;3125,&nbsp;3126&nbsp;and&nbsp;3127.&lt;br&gt;<br>
Port&nbsp;3126&nbsp;is&nbsp;used&nbsp;for&nbsp;intercepting,&nbsp;via&nbsp;iptables&nbsp;redirect,&nbsp;https&nbsp;connections&nbsp;mostly&nbsp;from&nbsp;mobile&nbsp;devices&nbsp;like&nbsp;smartphones.&nbsp;On&nbsp;this&nbsp;port&nbsp;is&nbsp;active&nbsp;ssl-bump&nbsp;but&nbsp;I'm&nbsp;not&nbsp;decrypting&nbsp;https&nbsp;traffic,&nbsp;only&nbsp;&quot;peek&quot;&nbsp;to&nbsp;get&nbsp;https&nbsp;server&nbsp;host&nbsp;name.&lt;br&gt;<br>
Port&nbsp;3125&nbsp;is&nbsp;used&nbsp;for&nbsp;intercepting&nbsp;http&nbsp;connections&nbsp;of&nbsp;the&nbsp;same&nbsp;mobile&nbsp;devices&nbsp;whose&nbsp;https&nbsp;traffic&nbsp;is&nbsp;intercepted&nbsp;on&nbsp;port&nbsp;3126.&lt;br&gt;<br>
Port&nbsp;3127&nbsp;is&nbsp;used&nbsp;for&nbsp;clients&nbsp;configured&nbsp;to&nbsp;use&nbsp;a&nbsp;proxy.&lt;br&gt;<br>
Leaked&nbsp;file&nbsp;descriptors&nbsp;are&nbsp;all&nbsp;related&nbsp;to&nbsp;connection&nbsp;on&nbsp;port&nbsp;3126&nbsp;(https&nbsp;intercept&nbsp;ssl-bump).&lt;br&gt;<br>
A&nbsp;sample&nbsp;output&nbsp;of&nbsp;lsof&nbsp;command&nbsp;gives:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;squid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32490&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy&nbsp;&nbsp;&nbsp;12u&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IPv6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4065613&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0t0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP&nbsp;172.16.10.22:3126-&gt;192.168.93.113:55815&nbsp;(CLOSE_WAIT)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;squid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32490&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy&nbsp;&nbsp;&nbsp;14u&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IPv6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4097822&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0t0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP&nbsp;172.16.10.22:3126-&gt;192.168.90.207:52288&nbsp;(ESTABLISHED)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&gt;<br>
&lt;br&gt;<br>
where&nbsp;172.16.10.22&nbsp;is&nbsp;an&nbsp;IP&nbsp;address&nbsp;of&nbsp;my&nbsp;Squid&nbsp;installation&nbsp;and&nbsp;192.168.x.x&nbsp;are&nbsp;mobile&nbsp;devices.&lt;br&gt;<br>
Is&nbsp;seems&nbsp;that&nbsp;this&nbsp;condition&nbsp;is&nbsp;triggered&nbsp;by&nbsp;&quot;local&nbsp;IP&nbsp;does&nbsp;not&nbsp;match&nbsp;any&nbsp;domain&nbsp;IP&quot;&nbsp;error&nbsp;logged&nbsp;by&nbsp;Squid&nbsp;in&nbsp;cache.log,&nbsp;but&nbsp;I'm&nbsp;not&nbsp;sure&nbsp;if&nbsp;all&nbsp;stuck&nbsp;connections&nbsp;are&nbsp;caused&nbsp;by&nbsp;this&nbsp;kind&nbsp;of&nbsp;error.&lt;br&gt;<br>
For&nbsp;the&nbsp;2&nbsp;connections&nbsp;of&nbsp;the&nbsp;sample&nbsp;above&nbsp;the&nbsp;related&nbsp;cache.log&nbsp;errors&nbsp;are:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;2015/11/21&nbsp;12:57:51.229&nbsp;kid1|&nbsp;SECURITY&nbsp;ALERT:&nbsp;Host&nbsp;header&nbsp;forgery&nbsp;detected&nbsp;on&nbsp;local=23.0.163.57:443&nbsp;remote=192.168.93.113:55815&nbsp;FD&nbsp;12&nbsp;flags=33&nbsp;(local&nbsp;IP&nbsp;does&nbsp;not&nbsp;match&nbsp;any&nbsp;domain&nbsp;IP)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;2015/11/21&nbsp;13:59:44.230&nbsp;kid1|&nbsp;SECURITY&nbsp;ALERT:&nbsp;Host&nbsp;header&nbsp;forgery&nbsp;detected&nbsp;on&nbsp;local=198.144.127.162:443&nbsp;remote=192.168.90.207:52288&nbsp;FD&nbsp;14&nbsp;flags=33&nbsp;(local&nbsp;IP&nbsp;does&nbsp;not&nbsp;match&nbsp;any&nbsp;domain&nbsp;IP)&lt;br&gt;<br>
&lt;br&gt;<br>
&quot;lsof&quot;&nbsp;sample&nbsp;output&nbsp;was&nbsp;taken&nbsp;more&nbsp;that&nbsp;10&nbsp;hours&nbsp;after&nbsp;Squid&nbsp;logged&nbsp;these&nbsp;errors&nbsp;and&nbsp;it&nbsp;shows&nbsp;that&nbsp;Squid&nbsp;is&nbsp;still&nbsp;holding&nbsp;connections&nbsp;open,&nbsp;using&nbsp;a&nbsp;lot&nbsp;of&nbsp;file&nbsp;descriptors.&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Andr&eacute;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
---&nbsp;my&nbsp;squid.conf&nbsp;---&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;10.0.0.0/8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;172.16.0.0/12&nbsp;&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;192.168.0.0/16&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;<br>
acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ftp&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;https&lt;br&gt;<br>
acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
acl&nbsp;squid-internal-static&nbsp;url_regex&nbsp;^http://nat-academico:3127/squid-internal-static/&lt;br&gt;<br>
acl&nbsp;e2guardian&nbsp;localport&nbsp;3127&lt;br&gt;<br>
follow_x_forwarded_for&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;squid-internal-static&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;manager&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;to_localhost&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localnet&nbsp;e2guardian&lt;br&gt;<br>
include&nbsp;/etc/squid/transparent-blacklist.conf&lt;br&gt;<br>
include&nbsp;/etc/squid/transparent-whitelist.conf&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;transparent-whitelist-http&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;transparent-blacklist-http&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
http_port&nbsp;3127&lt;br&gt;<br>
http_port&nbsp;3125&nbsp;intercept&lt;br&gt;<br>
https_port&nbsp;3126&nbsp;cert=/etc/ssl/certs/nat-academico.crt&nbsp;key=/etc/ssl/private/services.key&nbsp;intercept&nbsp;ssl-bump&lt;br&gt;<br>
acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;br&gt;<br>
ssl_bump&nbsp;splice&nbsp;transparent-whitelist-https&lt;br&gt;<br>
ssl_bump&nbsp;terminate&nbsp;transparent-blacklist-https&lt;br&gt;<br>
cache_dir&nbsp;ufs&nbsp;/var/spool/squid&nbsp;10000&nbsp;16&nbsp;256&lt;br&gt;<br>
coredump_dir&nbsp;/var/spool/squid&lt;br&gt;<br>
refresh_pattern&nbsp;^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10080&lt;br&gt;<br>
refresh_pattern&nbsp;^gopher:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&lt;br&gt;<br>
refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&lt;br&gt;<br>
refresh_pattern&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4320&lt;br&gt;<br>
dns_v4_first&nbsp;on&lt;br&gt;&lt;/p&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
