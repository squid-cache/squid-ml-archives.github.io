<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;We&nbsp;did&nbsp;not&nbsp;enable&nbsp;squid&nbsp;cache,&nbsp;so&nbsp;I&nbsp;think&nbsp;memory&nbsp;is&nbsp;ok&nbsp;for&nbsp;our&nbsp;case,&nbsp;and&nbsp;we&nbsp;run&nbsp;squid&nbsp;servers&nbsp;(without&nbsp;cache,&nbsp;without&nbsp;cache&nbsp;cluster,&nbsp;just&nbsp;as&nbsp;forward&nbsp;proxy)&nbsp;more&nbsp;than&nbsp;100&nbsp;servers&nbsp;more&nbsp;than&nbsp;1&nbsp;years&nbsp;in&nbsp;AWS&nbsp;serveral&nbsp;regions&nbsp;with&nbsp;EC2&nbsp;c3.xlarge&nbsp;on&nbsp;ubuntu&nbsp;12.04.&nbsp;It&nbsp;was&nbsp;always&nbsp;running&nbsp;well.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Just&nbsp;after&nbsp;upgrade&nbsp;ubuntu&nbsp;14.04,&nbsp;we&nbsp;found&nbsp;the&nbsp;memory&nbsp;usage&nbsp;increased.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Server&nbsp;Spec:&nbsp;AWS&nbsp;EC2&nbsp;c3.xlarge&nbsp;(4&nbsp;Cores,&nbsp;7.5GB&nbsp;Memory,&nbsp;2&nbsp;x&nbsp;40&nbsp;GB&nbsp;SSD)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Before&nbsp;upgrade:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;12.04:&lt;/div&gt;&lt;div&gt;Memory&nbsp;usage&nbsp;is&nbsp;always&nbsp;less&nbsp;than&nbsp;50%&nbsp;(3.5GB),&nbsp;will&nbsp;increase&nbsp;or&nbsp;decrease&nbsp;because&nbsp;traffic&nbsp;changes&lt;/div&gt;&lt;div&gt;CPU&nbsp;is&nbsp;very&nbsp;low,&nbsp;same&nbsp;as&nbsp;Disk&nbsp;IO,&nbsp;B/W&nbsp;(In&nbsp;or&nbsp;Out)&nbsp;is&nbsp;500Mb/s&nbsp;at&nbsp;most,&nbsp;is&nbsp;around&nbsp;200Mb/s&nbsp;most&nbsp;of&nbsp;time.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;14:04&lt;/div&gt;&lt;div&gt;Memory&nbsp;usage&nbsp;is&nbsp;about&nbsp;80-90&nbsp;%&nbsp;(nearly&nbsp;7GB),&nbsp;will&nbsp;increase&nbsp;,&nbsp;but&nbsp;it&nbsp;decrease&nbsp;very&nbsp;slow,&nbsp;and&nbsp;always&nbsp;keeping&nbsp;more&nbsp;than&nbsp;50%&nbsp;(3.5GB),&lt;/div&gt;&lt;div&gt;CPU&nbsp;is&nbsp;very&nbsp;low,&nbsp;same&nbsp;as&nbsp;Disk&nbsp;IO,&nbsp;B/W&nbsp;(In&nbsp;or&nbsp;Out)&nbsp;is&nbsp;500Mb/s&nbsp;at&nbsp;most,&nbsp;is&nbsp;around&nbsp;200Mb/s&nbsp;most&nbsp;of&nbsp;time.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;tested&nbsp;with&nbsp;squid-3.3.8&nbsp;(ubuntu&nbsp;offical&nbsp;packages),&nbsp;and&nbsp;squid-3.5.11&nbsp;on&nbsp;12.04&nbsp;and&nbsp;14.04,&nbsp;I&nbsp;think&nbsp;it&nbsp;is&nbsp;most&nbsp;likely&nbsp;ubuntu&nbsp;related&nbsp;issue&nbsp;?&nbsp;because&nbsp;same&nbsp;version,&nbsp;same&nbsp;configs,&nbsp;but&nbsp;different&nbsp;OS&nbsp;versions.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2015-11-30&nbsp;11:37&nbsp;GMT+08:00&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;30/11/2015&nbsp;3:19&nbsp;p.m.,&nbsp;风声&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;try&nbsp;to&nbsp;use&nbsp;jemalloc,&nbsp;but&nbsp;from&nbsp;monitoring,&nbsp;there&nbsp;is&nbsp;no&nbsp;difference,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;follow&nbsp;this&nbsp;guide:&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://github.com/jemalloc/jemalloc/wiki/Getting-Started&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/jemalloc/jemalloc/wiki/Getting-Started&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;used&nbsp;LD_PRELOAD&nbsp;to&nbsp;let&nbsp;squid&nbsp;use&nbsp;jemalloc.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;is&nbsp;there&nbsp;something&nbsp;wrong&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;I&nbsp;want&nbsp;to&nbsp;re-compile&nbsp;squid&nbsp;with&nbsp;jemalloc,&nbsp;how&nbsp;can&nbsp;i&nbsp;do&nbsp;that&nbsp;?&nbsp;Can&nbsp;I&nbsp;just&lt;br&gt;<br>
&gt;&nbsp;use&nbsp;some&nbsp;FLAGS&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;A&nbsp;number&nbsp;of&nbsp;build&nbsp;variables&nbsp;can&nbsp;be&nbsp;set&nbsp;on&nbsp;the&nbsp;command&nbsp;line&nbsp;to&lt;br&gt;<br>
./configure. &nbsp;See&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;&quot;./configure&nbsp;--help&quot;&nbsp;for&nbsp;the&nbsp;ones&nbsp;your&lt;br&gt;<br>
Squid&nbsp;supports.&lt;br&gt;<br>
&lt;br&gt;<br>
But,&nbsp;hold&nbsp;up&nbsp;a&nbsp;minute&nbsp;there.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;have&nbsp;provided&nbsp;all&nbsp;sorts&nbsp;of&nbsp;snapshots&nbsp;of&nbsp;what&nbsp;the&nbsp;system&nbsp;thinks&lt;br&gt;<br>
memory&nbsp;usage&nbsp;is.&nbsp;But&nbsp;not&nbsp;told&nbsp;us&nbsp;anything&nbsp;about&nbsp;what&nbsp;values&nbsp;you&nbsp;expect&lt;br&gt;<br>
to&nbsp;see&nbsp;there,&nbsp;or&nbsp;what&nbsp;the&nbsp;machine&nbsp;has&nbsp;available.&nbsp;Just&nbsp;a&nbsp;blank&nbsp;statement&lt;br&gt;<br>
that&nbsp;its&nbsp;&quot;high&quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;see&nbsp;that&nbsp;the&nbsp;*entire&nbsp;machine*&nbsp;is&nbsp;using&nbsp;~8GB&nbsp;of&nbsp;RAM.&nbsp;For&nbsp;those&nbsp;of&nbsp;us&lt;br&gt;<br>
managing&nbsp;machines&nbsp;with&nbsp;32-128&nbsp;GB&nbsp;of&nbsp;RAM&nbsp;thats&nbsp;actually&nbsp;pretty&nbsp;low.&nbsp;For&lt;br&gt;<br>
machines&nbsp;with&nbsp;only&nbsp;a&nbsp;few&nbsp;hundred&nbsp;MB&nbsp;of&nbsp;RAM&nbsp;plugged&nbsp;in&nbsp;thats&nbsp;impossible&lt;br&gt;<br>
numbers.&nbsp;So&nbsp;please&nbsp;provide&nbsp;some&nbsp;context&nbsp;about&nbsp;the&nbsp;machiens&nbsp;limits.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Also,&nbsp;be&nbsp;aware&nbsp;that&nbsp;&quot;Virtual&nbsp;Memory&quot;&nbsp;is&nbsp;just&nbsp;that&nbsp;*virtual*.&nbsp;It&nbsp;is&nbsp;not&lt;br&gt;<br>
real&nbsp;in-use&nbsp;memory.&nbsp;Whenever&nbsp;fork()&nbsp;is&nbsp;usesd&nbsp;to&nbsp;spawn&nbsp;a&nbsp;child&nbsp;helper&nbsp;or&lt;br&gt;<br>
pworker&nbsp;process&nbsp;the&nbsp;current&nbsp;memory&nbsp;value&nbsp;of&nbsp;the&nbsp;parent&nbsp;process&nbsp;is&lt;br&gt;<br>
assigned&nbsp;to&nbsp;the&nbsp;child&nbsp;-&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;it&nbsp;needs&nbsp;or&nbsp;uses&nbsp;it.&lt;br&gt;<br>
Effectively&nbsp;doubling&nbsp;the&nbsp;&quot;Virtual&nbsp;Memory&quot;&nbsp;numbers&nbsp;with&nbsp;every&nbsp;helper&lt;br&gt;<br>
started,&nbsp;even&nbsp;when&nbsp;the&nbsp;helper&nbsp;uses&nbsp;only&nbsp;a&nbsp;few&nbsp;KB.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;see&nbsp;from&nbsp;the&nbsp;netstat&nbsp;output&nbsp;that&nbsp;you&nbsp;have&nbsp;~6318&nbsp;sockets&nbsp;currently&nbsp;in&lt;br&gt;<br>
play.&nbsp;Thats&nbsp;up&nbsp;to&nbsp;~1.6&nbsp;GB&nbsp;of&nbsp;RAM&nbsp;just&nbsp;for&nbsp;connection&nbsp;buffering&nbsp;right&nbsp;there.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;whatever&nbsp;the&nbsp;cache&nbsp;requirements&nbsp;are.&nbsp;Reaching&nbsp;several&nbsp;GB&nbsp;of&nbsp;RAM&nbsp;in&lt;br&gt;<br>
actual&nbsp;usage&nbsp;is&nbsp;pretty&nbsp;easy.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;only&nbsp;after&nbsp;that&nbsp;is&nbsp;all&nbsp;added&nbsp;together&nbsp;multiply&nbsp;by&nbsp;however&nbsp;many&lt;br&gt;<br>
dozen&nbsp;or&nbsp;hundred&nbsp;helpers&nbsp;are&nbsp;being&nbsp;run,&nbsp;and&nbsp;thats&nbsp;what&nbsp;the&nbsp;virtual&lt;br&gt;<br>
memory&nbsp;numbers&nbsp;can&nbsp;say&nbsp;Squid&nbsp;is&nbsp;&quot;using&quot;.&nbsp;Though&nbsp;in&nbsp;reality&nbsp;it&nbsp;is&nbsp;not&lt;br&gt;<br>
even&nbsp;close.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
