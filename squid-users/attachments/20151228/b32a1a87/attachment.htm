<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;question&nbsp;has&nbsp;been&nbsp;asked&nbsp;many&nbsp;times&nbsp;before,&nbsp;but&nbsp;unfortunately&nbsp;the&nbsp;ones&nbsp;I&nbsp;checked&nbsp;did&nbsp;not&nbsp;seem&nbsp;to&nbsp;have&nbsp;a&nbsp;solution&nbsp;for&nbsp;me.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;setup&nbsp;squid&nbsp;as&nbsp;transparent&nbsp;proxy,&nbsp;but&nbsp;I&nbsp;keep&nbsp;getting&nbsp;the&nbsp;error&nbsp;Forwarding&nbsp;loop&nbsp;detected.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;the&nbsp;following&nbsp;setup:&lt;/div&gt;&lt;div&gt;Client&nbsp;[172.24.30.11]&nbsp;&lt;-&gt;&nbsp;Router&nbsp;[172.24.30.253&nbsp;&amp;&amp;&nbsp;172.24.10.253&nbsp;]&nbsp;&lt;-&gt;&nbsp;Squid&nbsp;Server&nbsp;[172.24.10.13]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;configuration&nbsp;for&nbsp;squid&nbsp;is&nbsp;as&nbsp;following:&lt;/div&gt;&lt;div&gt;&lt;div&gt;http_port&nbsp;8080&lt;/div&gt;&lt;div&gt;http_port&nbsp;3129&nbsp;intercept&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;iptables&nbsp;rule&nbsp;on&nbsp;my&nbsp;router&nbsp;is&nbsp;as&nbsp;follow:&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-I&nbsp;PREROUTING&nbsp;-s&nbsp;172.24.30.11&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;DNAT&nbsp;--to&nbsp;&lt;a&nbsp;href=&quot;http://172.24.10.13:3129&quot;&gt;172.24.10.13:3129&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;when&nbsp;the&nbsp;client&nbsp;tries&nbsp;to&nbsp;download&nbsp;something&nbsp;I&nbsp;get&nbsp;the&nbsp;following&nbsp;logs:&lt;/div&gt;&lt;div&gt;----&nbsp;access.log&nbsp;----&lt;/div&gt;&lt;div&gt;&lt;div&gt;1451303118.327&nbsp; &nbsp; &nbsp; 0&nbsp;172.24.10.13&nbsp;TCP_MISS/403&nbsp;3751&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://74.125.136.94/&quot;&gt;http://74.125.136.94/&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;/div&gt;&lt;div&gt;1451303118.327&nbsp; &nbsp; &nbsp; 0&nbsp;172.24.30.11&nbsp;TCP_MISS/403&nbsp;3915&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://74.125.136.94/&quot;&gt;http://74.125.136.94/&lt;/a&gt;&nbsp;-&nbsp;HIER_DIRECT/&lt;a&nbsp;href=&quot;http://172.24.10.13&quot;&gt;172.24.10.13&lt;/a&gt;&nbsp;text/html&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;----&nbsp;cache.log&nbsp;----&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Starting&nbsp;Squid&nbsp;Cache&nbsp;version&nbsp;3.3.8&nbsp;for&nbsp;x86_64-redhat-linux-gnu...&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Process&nbsp;ID&nbsp;776&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Process&nbsp;Roles:&nbsp;worker&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;With&nbsp;16384&nbsp;file&nbsp;descriptors&nbsp;available&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Initializing&nbsp;IP&nbsp;Cache...&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;DNS&nbsp;Socket&nbsp;created&nbsp;at&nbsp;[::],&nbsp;FD&nbsp;7&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;DNS&nbsp;Socket&nbsp;created&nbsp;at&nbsp;0.0.0.0,&nbsp;FD&nbsp;8&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Adding&nbsp;domain&nbsp;&lt;a&nbsp;href=&quot;http://int-mgt.bitcube.nl&quot;&gt;int-mgt.bitcube.nl&lt;/a&gt;&nbsp;from&nbsp;/etc/resolv.conf&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Adding&nbsp;domain&nbsp;&lt;a&nbsp;href=&quot;http://int-prd.bitcube.nl&quot;&gt;int-prd.bitcube.nl&lt;/a&gt;&nbsp;from&nbsp;/etc/resolv.conf&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Adding&nbsp;domain&nbsp;&lt;a&nbsp;href=&quot;http://dmz-prd.bitcube.nl&quot;&gt;dmz-prd.bitcube.nl&lt;/a&gt;&nbsp;from&nbsp;/etc/resolv.conf&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Adding&nbsp;nameserver&nbsp;172.24.10.253&nbsp;from&nbsp;/etc/resolv.conf&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Logfile:&nbsp;opening&nbsp;log&nbsp;daemon:/var/log/squid/access.log&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Logfile&nbsp;Daemon:&nbsp;opening&nbsp;log&nbsp;/var/log/squid/access.log&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Local&nbsp;cache&nbsp;digest&nbsp;enabled;&nbsp;rebuild/rewrite&nbsp;every&nbsp;3600/3600&nbsp;sec&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Store&nbsp;logging&nbsp;disabled&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Swap&nbsp;maxSize&nbsp;0&nbsp;+&nbsp;262144&nbsp;KB,&nbsp;estimated&nbsp;20164&nbsp;objects&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Target&nbsp;number&nbsp;of&nbsp;buckets:&nbsp;1008&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Using&nbsp;8192&nbsp;Store&nbsp;buckets&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Max&nbsp;Mem&nbsp; size:&nbsp;262144&nbsp;KB&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Max&nbsp;Swap&nbsp;size:&nbsp;0&nbsp;KB&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Using&nbsp;Least&nbsp;Load&nbsp;store&nbsp;dir&nbsp;selection&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Current&nbsp;Directory&nbsp;is&nbsp;/&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Loaded&nbsp;Icons.&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;HTCP&nbsp;Disabled.&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Squid&nbsp;plugin&nbsp;modules&nbsp;loaded:&nbsp;0&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Adaptation&nbsp;support&nbsp;is&nbsp;off.&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Accepting&nbsp;HTTP&nbsp;Socket&nbsp;connections&nbsp;at&nbsp;local=[::]:8080&nbsp;remote=[::]&nbsp;FD&nbsp;11&nbsp;flags=9&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:14&nbsp;kid1|&nbsp;Accepting&nbsp;NAT&nbsp;intercepted&nbsp;HTTP&nbsp;Socket&nbsp;connections&nbsp;at&nbsp;local=&lt;a&nbsp;href=&quot;http://0.0.0.0:3129&quot;&gt;0.0.0.0:3129&lt;/a&gt;&nbsp;remote=[::]&nbsp;FD&nbsp;12&nbsp;flags=41&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:15&nbsp;kid1|&nbsp;storeLateRelease:&nbsp;released&nbsp;0&nbsp;objects&lt;/div&gt;&lt;div&gt;2015/12/28&nbsp;12:45:18&nbsp;kid1|&nbsp;WARNING:&nbsp;Forwarding&nbsp;loop&nbsp;detected&nbsp;for:&lt;/div&gt;&lt;div&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;/div&gt;&lt;div&gt;User-Agent:&nbsp;curl/7.29.0&lt;/div&gt;&lt;div&gt;Host:&nbsp;74.125.136.94&lt;/div&gt;&lt;div&gt;Accept:&nbsp;*/*&lt;/div&gt;&lt;div&gt;Via:&nbsp;1.1&nbsp;srv-proxy01.xxxxxxxxxxxx&nbsp;(squid/3.3.8)&lt;/div&gt;&lt;div&gt;X-Forwarded-For:&nbsp;172.24.30.11&lt;/div&gt;&lt;div&gt;Cache-Control:&nbsp;max-age=259200&lt;/div&gt;&lt;div&gt;Connection:&nbsp;keep-alive&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;I&nbsp;configure&nbsp;the&nbsp;client&nbsp;to&nbsp;use&nbsp;a&nbsp;proxy&nbsp;(on&nbsp;port&nbsp;8080)&nbsp;it&nbsp;all&nbsp;works&nbsp;fine.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;feeling&nbsp;i&#39;m&nbsp;forgetting&nbsp;something&nbsp;simple&nbsp;:(&lt;/div&gt;&lt;div&gt;Hopefully&nbsp;someone&nbsp;can&nbsp;point&nbsp;me&nbsp;into&nbsp;the&nbsp;right&nbsp;direction?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Richard&lt;/div&gt;&lt;/div&gt;<br>

</tt>
