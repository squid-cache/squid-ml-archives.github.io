<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Sorry&nbsp;for&nbsp;nagging. &nbsp;We&nbsp;want&nbsp;to&nbsp;use&nbsp;both&nbsp;tproxy&nbsp;and&nbsp;accelerator&nbsp;mode.&nbsp;Mainly&nbsp;tproxy&nbsp;for&nbsp;internet&nbsp;traffic&nbsp;and&nbsp;accelerator&nbsp;mode&nbsp;for&nbsp;web&nbsp;server.&nbsp;Also&nbsp;we&nbsp;want&nbsp;to&nbsp;ignore&nbsp;cache&nbsp;control&nbsp;header&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;requests&nbsp;destined&nbsp;for&nbsp;our&nbsp;webserver&nbsp;(&lt;a&nbsp;href=&quot;http://abcexample.com&quot;&gt;abcexample.com&lt;/a&gt;) &nbsp;Does&nbsp;the&nbsp;below&nbsp;configuration&nbsp;work&nbsp;?&nbsp;or&nbsp;Do&nbsp;we&nbsp;need&nbsp;to&nbsp;do&nbsp;add&nbsp;IPtables&nbsp;rules?&lt;br&gt;&lt;br&gt;http_port&nbsp;3128&lt;br&gt;http_port&nbsp;3129&nbsp;tproxy&lt;br&gt;http_port&nbsp;80&nbsp;accel&nbsp;defaultsite=&lt;a&nbsp;href=&quot;http://abcexample.com&quot;&gt;abcexample.com&lt;/a&gt;&nbsp;ignore-cc&lt;br&gt;&lt;span&nbsp;class=&quot;im&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;br&gt;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://abcexample.com/data/&quot;&gt;abcexample.com/data/&lt;/a&gt;&nbsp;parent&nbsp;80&nbsp;0&nbsp;no-query&nbsp;originserver&nbsp;name=myAccel&lt;br&gt;&lt;br&gt;acl&nbsp;our_sites&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://abcexample.com&quot;&gt;abcexample.com&lt;/a&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;our_sites&lt;br&gt;cache_peer_access&nbsp;myAccel&nbsp;allow&nbsp;our_sites&lt;br&gt;cache_peer_access&nbsp;myAccel&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;-&nbsp;Cross&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Feb&nbsp;28,&nbsp;2016&nbsp;at&nbsp;12:05&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;28/02/2016&nbsp;5:31&nbsp;p.m.,&nbsp;Anonymous&nbsp;cross&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&nbsp;Amos,&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;are&nbsp;using&nbsp;forward&nbsp;tproxy&nbsp;.&nbsp;We&nbsp;used&nbsp;to&nbsp;redirect&nbsp;the&nbsp;packets&nbsp;coming &nbsp;from&lt;br&gt;<br>
&gt;&nbsp;client&nbsp;for&nbsp;port&nbsp;80&nbsp;to&nbsp;squid&nbsp;proxy&nbsp;server.&nbsp;Squid&nbsp;spoofs&nbsp;the&nbsp;request&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;with&nbsp;Server&nbsp;transparently.&nbsp;Please&nbsp;find&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;configuration&nbsp;below&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Client&nbsp;---&nbsp;&gt;&nbsp;Squid&nbsp;proxy&nbsp;server&nbsp;---&nbsp;&gt;&nbsp;web&nbsp;Server&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;talk&nbsp;about&nbsp;TPROXY&nbsp;up&nbsp;here.&nbsp;But&nbsp;your&nbsp;config&nbsp;with&nbsp;the&nbsp;refresh&nbsp;pattern&lt;br&gt;<br>
is&nbsp;for&nbsp;the&nbsp;accel&nbsp;port&nbsp;domain.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;are&nbsp;a&nbsp;legitimate&nbsp;reverse-proxy&nbsp;/&nbsp;CDN&nbsp;/&nbsp;accel&nbsp;-&nbsp;then&nbsp;intercepting,&lt;br&gt;<br>
even&nbsp;with&nbsp;TPROXY&nbsp;is&nbsp;just&nbsp;plain&nbsp;daft.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;=====&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3129&nbsp;tproxy&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;80&nbsp;accel&nbsp;defaultsite=&lt;a&nbsp;href=&quot;http://abcexample.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;abcexample.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;refresh_pattern&nbsp;-i&nbsp;&lt;a&nbsp;href=&quot;http://abcexample.com/*&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;abcexample.com/*&lt;/a&gt;&nbsp;600&nbsp;0%&nbsp;600&nbsp;override-expire&lt;br&gt;<br>
&gt;&nbsp;override-lastmod&nbsp;reload-into-ims&nbsp;ignore-reload&lt;br&gt;<br>
&gt;&nbsp;refresh_pattern&nbsp;-i&nbsp;&lt;a&nbsp;href=&quot;http://abcexample2.com/*&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;abcexample2.com/*&lt;/a&gt;&nbsp;600&nbsp;0%&nbsp;600&nbsp;override-expire&lt;br&gt;<br>
&gt;&nbsp;override-lastmod&nbsp;reload-into-ims&nbsp;ignore-reload&lt;br&gt;<br>
&gt;&nbsp;=====&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;can&nbsp;remove&nbsp;the&nbsp;&quot;/*&quot;&nbsp;part&nbsp;of&nbsp;those&nbsp;patterns,&nbsp;its&nbsp;just&nbsp;wasting&nbsp;config&lt;br&gt;<br>
file&nbsp;space&nbsp;and&nbsp;perhapse&nbsp;confusing&nbsp;you&nbsp;into&nbsp;thinking&nbsp;the&nbsp;&#39;/&#39;&nbsp;part&nbsp;is&lt;br&gt;<br>
being&nbsp;looked&nbsp;for&nbsp;by&nbsp;regex&nbsp;(the&nbsp;&#39;*&#39;&nbsp;cancels&nbsp;its&nbsp;existence&nbsp;out).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
reload-into-ims&nbsp;and&nbsp;ignore-reload&nbsp;are&nbsp;mutually&nbsp;exclusive&nbsp;options.&nbsp;Squid&lt;br&gt;<br>
cannot&nbsp;both&nbsp;adjust&nbsp;a&nbsp;reload&nbsp;action&nbsp;and&nbsp;ignore&nbsp;it&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&lt;br&gt;<br>
Remove&nbsp;the&nbsp;ignore-reload.&lt;br&gt;<br>
&lt;br&gt;<br>
Add&nbsp;&quot;ignore-cc&quot;&nbsp;to&nbsp;the&nbsp;accel&nbsp;port&nbsp;line&nbsp;to&nbsp;ignore&nbsp;a&nbsp;Cache-Control&lt;br&gt;<br>
arriving&nbsp;from&nbsp;the&nbsp;clients. &nbsp;No&nbsp;you&nbsp;cannot&nbsp;do&nbsp;the&nbsp;same&nbsp;on&nbsp;the&nbsp;tproxy&nbsp;line&lt;br&gt;<br>
without&nbsp;causing&nbsp;a&nbsp;lot&nbsp;of&nbsp;trouble.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;should&nbsp;seriously&nbsp;consider&nbsp;removing&nbsp;override-lastmod&nbsp;as&nbsp;well.&nbsp;That&nbsp;is&lt;br&gt;<br>
usually&nbsp;only&nbsp;used&nbsp;on&nbsp;dynamic&nbsp;content,&nbsp;which&nbsp;is&nbsp;important&nbsp;to&nbsp;keep&nbsp;up-to-date.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Basically&nbsp;we&nbsp;want&nbsp;to&nbsp;increase&nbsp;the&nbsp;page&nbsp;load&nbsp;times&nbsp;by&nbsp;caching&nbsp;the&nbsp;images.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Then&nbsp;adjust&nbsp;your&nbsp;web&nbsp;server&nbsp;outputs&nbsp;to&nbsp;make&nbsp;that&nbsp;happen.&nbsp;Page&nbsp;times&nbsp;will&lt;br&gt;<br>
get&nbsp;even&nbsp;better&nbsp;if&nbsp;you&nbsp;allow&nbsp;cache&nbsp;in&nbsp;the&nbsp;ISPs&nbsp;closer&nbsp;to&nbsp;the&nbsp;clients&nbsp;to&lt;br&gt;<br>
store&nbsp;your&nbsp;images&nbsp;correctly&nbsp;instead&nbsp;of&nbsp;hacking&nbsp;your&nbsp;proxy&nbsp;config&nbsp;to&nbsp;be&lt;br&gt;<br>
the&nbsp;only&nbsp;one&nbsp;doing&nbsp;so&nbsp;efficiently.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;config&nbsp;above&nbsp;indicates&nbsp;that&nbsp;you&nbsp;are&nbsp;the&nbsp;owner&nbsp;of&nbsp;&lt;a&nbsp;href=&quot;http://abcexample.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;abcexample.com&lt;/a&gt;&nbsp;(or&lt;br&gt;<br>
they&nbsp;are&nbsp;a&nbsp;customer&nbsp;of&nbsp;yours)&nbsp;and&nbsp;thus&nbsp;in&nbsp;a&nbsp;position&nbsp;to&nbsp;get&nbsp;problems&lt;br&gt;<br>
like&nbsp;caching&nbsp;times&nbsp;for&nbsp;images&nbsp;fixed&nbsp;at&nbsp;the&nbsp;web&nbsp;server&nbsp;end.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Sometimes&nbsp;the&nbsp;specific&nbsp;client&nbsp;is&nbsp;triggering&nbsp;HTTP&nbsp;request&nbsp;with&nbsp;cache-control&lt;br&gt;<br>
&gt;&nbsp;as&nbsp;no-cache.&nbsp;We&nbsp;want&nbsp;to&nbsp;mandate&nbsp;the&nbsp;packets&nbsp;coming&nbsp;from&nbsp;specific&nbsp;client&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;be&nbsp;cached&nbsp;in&nbsp;squid&nbsp;to&nbsp;increase&nbsp;the&nbsp;page&nbsp;load&nbsp;times&nbsp;. &nbsp;In&nbsp;order&nbsp;to&nbsp;avoid&lt;br&gt;<br>
&gt;&nbsp;serving&nbsp;the&nbsp;stale&nbsp;content&nbsp;we&nbsp;have&nbsp;configured&nbsp;a&nbsp;refresh&nbsp;pattern.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;have&nbsp;configured&nbsp;the&nbsp;refresh_pattern&nbsp;to&nbsp;force&nbsp;Squid&nbsp;to&nbsp;serve&nbsp;stale&lt;br&gt;<br>
content&nbsp;for&nbsp;up&nbsp;to&nbsp;10&nbsp;hours.&nbsp;It&nbsp;does&nbsp;not&nbsp;prevent&nbsp;the&nbsp;content&nbsp;being&nbsp;stale.&lt;br&gt;<br>
It&nbsp;just&nbsp;gets&nbsp;delivered&nbsp;by&nbsp;the&nbsp;proxy&nbsp;anyway.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;kind&nbsp;of&nbsp;what&nbsp;I&nbsp;meant&nbsp;by&nbsp;there&nbsp;usually&nbsp;being&nbsp;a&nbsp;reason&nbsp;for&nbsp;seeing&lt;br&gt;<br>
no-cache.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;have&nbsp;used&nbsp;refresh_pattern&nbsp;to&nbsp;force&nbsp;things&nbsp;to&nbsp;cache&nbsp;for&nbsp;long&nbsp;times&lt;br&gt;<br>
and&nbsp;the&nbsp;web&nbsp;server&nbsp;indicates&nbsp;they&nbsp;are&nbsp;not&nbsp;supposed&nbsp;to.&nbsp;Then&nbsp;you&nbsp;can&lt;br&gt;<br>
cause&nbsp;pages&nbsp;looking&nbsp;weird,&nbsp;not&nbsp;updating&nbsp;correctly,&nbsp;etc&nbsp;...&lt;br&gt;<br>
&lt;br&gt;<br>
 ...&nbsp;users&nbsp;press&nbsp;the&nbsp;force-refresh&nbsp;button&nbsp;in&nbsp;their&nbsp;browser&nbsp;to&nbsp;&#39;fix&#39;&nbsp;the&lt;br&gt;<br>
page&nbsp;they&nbsp;see.&nbsp;Thus&nbsp;generating&nbsp;a&nbsp;no-cache&nbsp;or&nbsp;max-age=0&nbsp;request&nbsp;(aka&lt;br&gt;<br>
reload)&nbsp;to&nbsp;try&nbsp;and&nbsp;make&nbsp;the&nbsp;page&nbsp;update&nbsp;properly.&lt;br&gt;<br>
&lt;br&gt;<br>
 ...&nbsp;downstream&nbsp;caches&nbsp;think&nbsp;the&nbsp;content&nbsp;is&nbsp;constantly&nbsp;stale&nbsp;and&lt;br&gt;<br>
re-request&nbsp;updates&nbsp;for&nbsp;every&nbsp;user&nbsp;until&nbsp;they&nbsp;get&nbsp;something&nbsp;fresh.&lt;br&gt;<br>
&lt;br&gt;<br>
These&nbsp;can&nbsp;waste&nbsp;more&nbsp;bandwidth&nbsp;and&nbsp;actually&nbsp;increase&nbsp;avg&nbsp;page&nbsp;load&nbsp;times&lt;br&gt;<br>
versus&nbsp;letting&nbsp;the&nbsp;objects&nbsp;get&nbsp;refreshed&nbsp;once&nbsp;every&nbsp;N&nbsp;requests.&lt;br&gt;<br>
&lt;br&gt;<br>
Force-caching&nbsp;is&nbsp;a&nbsp;pretty&nbsp;popular&nbsp;pasttime.&nbsp;ISPs&nbsp;at&nbsp;least&nbsp;have&nbsp;a&nbsp;little&lt;br&gt;<br>
bit&nbsp;of&nbsp;excuse&nbsp;since&nbsp;they&nbsp;have&nbsp;no&nbsp;way&nbsp;to&nbsp;fix&nbsp;what&nbsp;the&nbsp;web&nbsp;server&nbsp;outputs.&lt;br&gt;<br>
As&nbsp;reverse-proxy&nbsp;operator&nbsp;you&nbsp;do.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;Regards,&lt;br&gt;Anonymous&nbsp;cross.&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
