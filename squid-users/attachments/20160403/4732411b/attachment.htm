<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&#39;m&nbsp;attempting&nbsp;to&nbsp;build&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;(policy&nbsp;based&nbsp;routing&nbsp;on&nbsp;firewall&nbsp;to&nbsp;squid&nbsp;proxy)&nbsp;with&nbsp;the&nbsp;following&nbsp;behavior:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;proxies&nbsp;http&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains,&nbsp;provide&nbsp;an&nbsp;message&nbsp;otherwise&nbsp;such&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;&nbsp;or&nbsp;similar&lt;/div&gt;&lt;div&gt;2)&nbsp;proxies&nbsp;https&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains&nbsp;(ideally,&nbsp;splicing&nbsp;those,&nbsp;so&nbsp;as&nbsp;not&nbsp;to&nbsp;break&nbsp;HSTS,&nbsp;if&nbsp;enabled),&nbsp;otherwise&nbsp;provide&nbsp;an&nbsp;error&nbsp;message&nbsp;(bumping&nbsp;and&nbsp;providing&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;attempting&nbsp;this&nbsp;with&nbsp;a&nbsp;3.5.15&nbsp;compiled&nbsp;with&nbsp;icap&nbsp;(not&nbsp;yet&nbsp;used)&nbsp;and&nbsp;ssl-bumping.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Part&nbsp;1&nbsp;seems&nbsp;easy&nbsp;enough&nbsp;(and&nbsp;is&nbsp;well&nbsp;documented)...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain1.tld&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain2.tld&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;http_ok&nbsp;all-of&nbsp;whitelist&nbsp;!SSL_ports&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;http_ok&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Moving&nbsp;onto&nbsp;Part&nbsp;2&nbsp;(the&nbsp;peek&nbsp;and&nbsp;splice&nbsp;setup)&nbsp;appears&nbsp;to&nbsp;be&nbsp;the&nbsp;topic&nbsp;of&nbsp;a&nbsp;few&nbsp;discussions&nbsp;out&nbsp;there...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain1.tld&lt;/div&gt;&lt;div&gt;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain2.tld&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;sni_whitelist&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;appears&nbsp;however&nbsp;that&nbsp;when&nbsp;combining&nbsp;the&nbsp;two,&nbsp;the&nbsp;generated&nbsp;certificate(s),&nbsp;instead&nbsp;of&nbsp;mimic&#39;ing&nbsp;the&nbsp;original&nbsp;server&#39;s&nbsp;certificate&nbsp;comes&nbsp;out&nbsp;with&nbsp;the&nbsp;CN=&lt;IP&gt;&nbsp;where&nbsp;&lt;IP&gt;&nbsp;is&nbsp;the&nbsp;ip&nbsp;used&nbsp;by&nbsp;the&nbsp;&quot;connect&quot;&nbsp;part&nbsp;of&nbsp;the&nbsp;connection.&nbsp;In&nbsp;addition,&nbsp;it&nbsp;appears&nbsp;that&nbsp;only&nbsp;the&nbsp;first&nbsp;entry&nbsp;ever&nbsp;matches&nbsp;(at&nbsp;this&nbsp;point,&nbsp;i&#39;ve&nbsp;tried&nbsp;so&nbsp;many&nbsp;combinations,&nbsp;i&#39;m&nbsp;no&nbsp;longer&nbsp;certain&nbsp;of&nbsp;anything). &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;i&nbsp;remove&nbsp;*all*&nbsp;the&nbsp;http_access&nbsp;lines,&nbsp;then&nbsp;the&nbsp;behavior&nbsp;appears&nbsp;correct&nbsp;(from&nbsp;a&nbsp;&quot;splicing/bumping&quot;&nbsp;standpoint).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Can&nbsp;anyone&nbsp;confirm&nbsp;that&nbsp;this&nbsp;is&nbsp;indeed&nbsp;possible&nbsp;to&nbsp;achieve?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;believe,&nbsp;based&nbsp;on&nbsp;experimentation&nbsp;that&nbsp;any&nbsp;http_access&nbsp;i&nbsp;have,&nbsp;because&nbsp;of&nbsp;the&nbsp;&quot;deny&nbsp;all&quot;&nbsp;cause&nbsp;the&nbsp;bumping&nbsp;to&nbsp;&quot;short&nbsp;circuit&quot;&nbsp;and&nbsp;effectively&nbsp;send&nbsp;an&nbsp;early&nbsp;&quot;access&nbsp;denied&quot;&nbsp;based&nbsp;on&nbsp;the&nbsp;only&nbsp;information&nbsp;it&nbsp;has&nbsp;(the&nbsp;ip&nbsp;address&nbsp;from&nbsp;the&nbsp;&quot;connect&quot;,&nbsp;rather&nbsp;than&nbsp;the&nbsp;SNI&nbsp;that&nbsp;would&nbsp;come&nbsp;later). &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Would&nbsp;a&nbsp;setup&nbsp;where&nbsp;&quot;deny&nbsp;http+!whitelist&quot;&nbsp;so&nbsp;have&nbsp;the&nbsp;allow&nbsp;be&nbsp;the&nbsp;default&nbsp;allow&nbsp;for&nbsp;the&nbsp;bumping&nbsp;to&nbsp;work&nbsp;and&nbsp;get&nbsp;to&nbsp;step2&nbsp;and&nbsp;match&nbsp;the&nbsp;sni*&nbsp;acls&nbsp;somehow?&nbsp;(with&nbsp;a&nbsp;&quot;deny&nbsp;step2&nbsp;!sni_whitelist&quot;).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;3.5.15&nbsp;capable&nbsp;of&nbsp;doing&nbsp;this?&nbsp;If&nbsp;this&nbsp;requires&nbsp;some&nbsp;feature/effort,&nbsp;what&nbsp;would&nbsp;be&nbsp;the&nbsp;procedure&nbsp;to&nbsp;sponsor&nbsp;that&nbsp;work?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Jok&lt;/div&gt;&lt;/div&gt;<br>

</tt>
