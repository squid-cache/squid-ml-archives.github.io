<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Apr&nbsp;3,&nbsp;2016&nbsp;at&nbsp;9:59&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&gt;On&nbsp;4/04/2016&nbsp;4:18&nbsp;p.m.,&nbsp;Jok&nbsp;Thuau&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&#39;m&nbsp;attempting&nbsp;to&nbsp;build&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;(policy&nbsp;based&nbsp;routing&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;firewall&nbsp;to&nbsp;squid&nbsp;proxy)&nbsp;with&nbsp;the&nbsp;following&nbsp;behavior:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;1)&nbsp;proxies&nbsp;http&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains,&nbsp;provide&nbsp;an&nbsp;message&lt;br&gt;<br>
&gt;&nbsp;otherwise&nbsp;such&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;&nbsp;or&nbsp;similar&lt;br&gt;<br>
&gt;&nbsp;2)&nbsp;proxies&nbsp;https&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains&nbsp;(ideally,&nbsp;splicing&lt;br&gt;<br>
&gt;&nbsp;those,&nbsp;so&nbsp;as&nbsp;not&nbsp;to&nbsp;break&nbsp;HSTS,&nbsp;if&nbsp;enabled),&nbsp;otherwise&nbsp;provide&nbsp;an&nbsp;error&lt;br&gt;<br>
&gt;&nbsp;message&nbsp;(bumping&nbsp;and&nbsp;providing&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&#39;m&nbsp;attempting&nbsp;this&nbsp;with&nbsp;a&nbsp;3.5.15&nbsp;compiled&nbsp;with&nbsp;icap&nbsp;(not&nbsp;yet&nbsp;used)&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;ssl-bumping.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Part&nbsp;1&nbsp;seems&nbsp;easy&nbsp;enough&nbsp;(and&nbsp;is&nbsp;well&nbsp;documented)...&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain1.tld&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain2.tld&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;http_ok&nbsp;all-of&nbsp;whitelist&nbsp;!SSL_ports&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;http_ok&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;This&nbsp;is&nbsp;denying&nbsp;the&nbsp;HTTPS&nbsp;traffic&nbsp;CONNECT&nbsp;requests&nbsp;(synthesized&nbsp;by&lt;br&gt;<br>
Squid),&nbsp;since&nbsp;they&nbsp;only&nbsp;have&nbsp;IP&nbsp;address&nbsp;no&nbsp;domain&nbsp;name.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;yes,&nbsp;this&nbsp;is&nbsp;where&nbsp;I&nbsp;started&nbsp;with&nbsp;just&nbsp;http. &lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Moving&nbsp;onto&nbsp;Part&nbsp;2&nbsp;(the&nbsp;peek&nbsp;and&nbsp;splice&nbsp;setup)&nbsp;appears&nbsp;to&nbsp;be&nbsp;the&nbsp;topic&nbsp;of&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;few&nbsp;discussions&nbsp;out&nbsp;there...&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain1.tld&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain2.tld&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;have&nbsp;omitted&nbsp;the&nbsp;definition&nbsp;of&nbsp;step1&nbsp;ACL.&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;the&nbsp;definition&nbsp;of&nbsp;&quot;step1&quot;&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;one&nbsp;on&nbsp;the&nbsp;wiki&nbsp;(See&nbsp;full&nbsp;config&nbsp;below)&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;sni_whitelist&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;appears&nbsp;however&nbsp;that&nbsp;when&nbsp;combining&nbsp;the&nbsp;two,&nbsp;the&nbsp;generated&lt;br&gt;<br>
&gt;&nbsp;certificate(s),&nbsp;instead&nbsp;of&nbsp;mimic&#39;ing&nbsp;the&nbsp;original&nbsp;server&#39;s&nbsp;certificate&lt;br&gt;<br>
&gt;&nbsp;comes&nbsp;out&nbsp;with&nbsp;the&nbsp;CN=&lt;IP&gt;&nbsp;where&nbsp;&lt;IP&gt;&nbsp;is&nbsp;the&nbsp;ip&nbsp;used&nbsp;by&nbsp;the&nbsp;&quot;connect&quot;&nbsp;part&lt;br&gt;<br>
&gt;&nbsp;of&nbsp;the&nbsp;connection.&nbsp;In&nbsp;addition,&nbsp;it&nbsp;appears&nbsp;that&nbsp;only&nbsp;the&nbsp;first&nbsp;entry&nbsp;ever&lt;br&gt;<br>
&gt;&nbsp;matches&nbsp;(at&nbsp;this&nbsp;point,&nbsp;i&#39;ve&nbsp;tried&nbsp;so&nbsp;many&nbsp;combinations,&nbsp;i&#39;m&nbsp;no&nbsp;longer&lt;br&gt;<br>
&gt;&nbsp;certain&nbsp;of&nbsp;anything).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;have&nbsp;omitted&nbsp;the&nbsp;http(s)_port&nbsp;configuration&nbsp;details,&nbsp;and&nbsp;the&nbsp;step1&lt;br&gt;<br>
ACL.&nbsp;So&nbsp;its&nbsp;not&nbsp;possible&nbsp;to&nbsp;say&nbsp;if&nbsp;you&nbsp;have&nbsp;the&nbsp;cert&nbsp;generation&nbsp;settings&lt;br&gt;<br>
wrong,&nbsp;or&nbsp;if&nbsp;the&nbsp;peeking&nbsp;step&nbsp;is&nbsp;matching&nbsp;wrong,&nbsp;or&nbsp;something&nbsp;else.&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&#39;s&nbsp;included&nbsp;in&nbsp;the&nbsp;config&nbsp;below.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;i&nbsp;remove&nbsp;*all*&nbsp;the&nbsp;http_access&nbsp;lines,&nbsp;then&nbsp;the&nbsp;behavior&nbsp;appears&nbsp;correct&lt;br&gt;<br>
&gt;&nbsp;(from&nbsp;a&nbsp;&quot;splicing/bumping&quot;&nbsp;standpoint).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Strange.&nbsp;Squid&nbsp;without&nbsp;any&nbsp;http_access&nbsp;lines&nbsp;should&nbsp;be&nbsp;denying&nbsp;traffic&nbsp;100%.&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;do&nbsp;not&nbsp;see&nbsp;this&nbsp;behavior.&nbsp;Traffic&nbsp;appears&nbsp;to&nbsp;be&nbsp;allowed,&nbsp;and&nbsp;bumped&nbsp;(though&nbsp;with&nbsp;the&nbsp;wrong&nbsp;certificate,&nbsp;depending&nbsp;on&nbsp;the&nbsp;config,&nbsp;as&nbsp;explained&nbsp;before). &lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&gt;<br>
&gt;&nbsp;Can&nbsp;anyone&nbsp;confirm&nbsp;that&nbsp;this&nbsp;is&nbsp;indeed&nbsp;possible&nbsp;to&nbsp;achieve?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;believe,&nbsp;based&nbsp;on&nbsp;experimentation&nbsp;that&nbsp;any&nbsp;http_access&nbsp;i&nbsp;have,&nbsp;because&nbsp;of&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;&quot;deny&nbsp;all&quot;&nbsp;cause&nbsp;the&nbsp;bumping&nbsp;to&nbsp;&quot;short&nbsp;circuit&quot;&nbsp;and&nbsp;effectively&nbsp;send&nbsp;an&lt;br&gt;<br>
&gt;&nbsp;early&nbsp;&quot;access&nbsp;denied&quot;&nbsp;based&nbsp;on&nbsp;the&nbsp;only&nbsp;information&nbsp;it&nbsp;has&nbsp;(the&nbsp;ip&nbsp;address&lt;br&gt;<br>
&gt;&nbsp;from&nbsp;the&nbsp;&quot;connect&quot;,&nbsp;rather&nbsp;than&nbsp;the&nbsp;SNI&nbsp;that&nbsp;would&nbsp;come&nbsp;later).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Would&nbsp;a&nbsp;setup&nbsp;where&nbsp;&quot;deny&nbsp;http+!whitelist&quot;&nbsp;so&nbsp;have&nbsp;the&nbsp;allow&nbsp;be&nbsp;the&nbsp;default&lt;br&gt;<br>
&gt;&nbsp;allow&nbsp;for&nbsp;the&nbsp;bumping&nbsp;to&nbsp;work&nbsp;and&nbsp;get&nbsp;to&nbsp;step2&nbsp;and&nbsp;match&nbsp;the&nbsp;sni*&nbsp;acls&lt;br&gt;<br>
&gt;&nbsp;somehow?&nbsp;(with&nbsp;a&nbsp;&quot;deny&nbsp;step2&nbsp;!sni_whitelist&quot;).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Is&nbsp;3.5.15&nbsp;capable&nbsp;of&nbsp;doing&nbsp;this?&nbsp;If&nbsp;this&nbsp;requires&nbsp;some&nbsp;feature/effort,&nbsp;what&lt;br&gt;<br>
&gt;&nbsp;would&nbsp;be&nbsp;the&nbsp;procedure&nbsp;to&nbsp;sponsor&nbsp;that&nbsp;work?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;It&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;answer&nbsp;any&nbsp;of&nbsp;those&nbsp;questsions&nbsp;properly&nbsp;without&lt;br&gt;<br>
full&nbsp;config&nbsp;details.&nbsp;You&nbsp;have&nbsp;omitted&nbsp;a&nbsp;lot.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;my&nbsp;apologies&nbsp;for&nbsp;trying&nbsp;to&nbsp;show&nbsp;only&nbsp;the&nbsp;relevant&nbsp;parts.&nbsp;Find&nbsp;below&nbsp;the&nbsp;current&nbsp;config. &lt;/div&gt;&lt;div&gt;It&nbsp;appears&nbsp;to&nbsp;be&nbsp;bumping&nbsp;everything&nbsp;rather&nbsp;than&nbsp;splicing&nbsp;any&nbsp;of&nbsp;the&nbsp;config&nbsp;(which&nbsp;may&nbsp;be&nbsp;due&nbsp;to&nbsp;the&nbsp;limitations&nbsp;documented&nbsp;on&nbsp;the&nbsp;wiki)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;http_port&nbsp;3129&nbsp;intercept&lt;br&gt;https_port&nbsp;8443&nbsp;intercept&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=64MB&nbsp;\&lt;br&gt; &nbsp; &nbsp;cert=/etc/squid/ssl/proxy.pem&nbsp;\&lt;br&gt; &nbsp; &nbsp;key=/etc/squid/ssl/proxy.key&nbsp;\&lt;br&gt; &nbsp; &nbsp;cafile=/etc/squid/ssl/proxy.pem&lt;br&gt;always_direct&nbsp;allow&nbsp;all&lt;br&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;acl&nbsp;SniBypass&nbsp;ssl::server_name_regex&nbsp;\.slashdot\.org &lt;br&gt;acl&nbsp;SniBypass&nbsp;ssl::server_name_regex&nbsp;\.fsdn\.com&lt;br&gt;acl&nbsp;http_bypass&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://slashdot.org&quot;&nbsp;target=&quot;_blank&quot;&gt;slashdot.org&lt;/a&gt;&lt;br&gt;acl&nbsp;http_bypass&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://fsdn.com&quot;&nbsp;target=&quot;_blank&quot;&gt;fsdn.com&lt;/a&gt;&lt;br&gt;acl&nbsp;https_bypass&nbsp;all-of&nbsp;CONNECT&nbsp;SniBypass&lt;br&gt;acl&nbsp;http_ok&nbsp;all-of&nbsp;http_bypass&nbsp;Safe_ports&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;splice&nbsp;SniBypass&nbsp;step2&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;sslproxy_cert_sign_hash&nbsp;sha256&lt;br&gt;sslproxy_options&nbsp;NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE&lt;br&gt;always_direct&nbsp;allow&nbsp;all&lt;br&gt;sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;sslcrtd_children&nbsp;8&nbsp;startup=1&nbsp;idle=1&lt;br&gt;http_access&nbsp;allow&nbsp;http_ok&lt;br&gt;http_access&nbsp;allow&nbsp;CONNECT&lt;br&gt;no_cache&nbsp;allow&nbsp;all&lt;br&gt;cache&nbsp;deny&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;div&gt;shutdown_lifetime&nbsp;3&nbsp;seconds &lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
