<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;TRANSITIONAL//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&nbsp;&nbsp;&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;CHARSET=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;META&nbsp;NAME=&quot;GENERATOR&quot;&nbsp;CONTENT=&quot;GtkHTML/4.6.6&quot;&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
On&nbsp;Sun,&nbsp;2016-04-03&nbsp;at&nbsp;21:18&nbsp;-0700,&nbsp;Jok&nbsp;Thuau&nbsp;wrote:<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I'm&nbsp;attempting&nbsp;to&nbsp;build&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;(policy&nbsp;based&nbsp;routing&nbsp;on&nbsp;firewall&nbsp;to&nbsp;squid&nbsp;proxy)&nbsp;with&nbsp;the&nbsp;following&nbsp;behavior:<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;proxies&nbsp;http&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains,&nbsp;provide&nbsp;an&nbsp;message&nbsp;otherwise&nbsp;such&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;&nbsp;or&nbsp;similar<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;proxies&nbsp;https&nbsp;traffic&nbsp;for&nbsp;a&nbsp;given&nbsp;set&nbsp;of&nbsp;domains&nbsp;(ideally,&nbsp;splicing&nbsp;those,&nbsp;so&nbsp;as&nbsp;not&nbsp;to&nbsp;break&nbsp;HSTS,&nbsp;if&nbsp;enabled),&nbsp;otherwise&nbsp;provide&nbsp;an&nbsp;error&nbsp;message&nbsp;(bumping&nbsp;and&nbsp;providing&nbsp;&quot;domain&nbsp;not&nbsp;allowed&quot;)<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I'm&nbsp;attempting&nbsp;this&nbsp;with&nbsp;a&nbsp;3.5.15&nbsp;compiled&nbsp;with&nbsp;icap&nbsp;(not&nbsp;yet&nbsp;used)&nbsp;and&nbsp;ssl-bumping.<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Part&nbsp;1&nbsp;seems&nbsp;easy&nbsp;enough&nbsp;(and&nbsp;is&nbsp;well&nbsp;documented)...<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain1.tld&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;whitelist&nbsp;dstdomain&nbsp;.domain2.tld<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;http_ok&nbsp;all-of&nbsp;whitelist&nbsp;!SSL_ports<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;http_ok<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;all<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Moving&nbsp;onto&nbsp;Part&nbsp;2&nbsp;(the&nbsp;peek&nbsp;and&nbsp;splice&nbsp;setup)&nbsp;appears&nbsp;to&nbsp;be&nbsp;the&nbsp;topic&nbsp;of&nbsp;a&nbsp;few&nbsp;discussions&nbsp;out&nbsp;there...<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain1.tld<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;sni_whitelist&nbsp;ssl::server_name&nbsp;.domain2.tld<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;peek&nbsp;step1<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;splice&nbsp;sni_whitelist<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;bump&nbsp;all<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;appears&nbsp;however&nbsp;that&nbsp;when&nbsp;combining&nbsp;the&nbsp;two,&nbsp;the&nbsp;generated&nbsp;certificate(s),&nbsp;instead&nbsp;of&nbsp;mimic'ing&nbsp;the&nbsp;original&nbsp;server's&nbsp;certificate&nbsp;comes&nbsp;out&nbsp;with&nbsp;the&nbsp;CN=&lt;IP&gt;&nbsp;where&nbsp;&lt;IP&gt;&nbsp;is&nbsp;the&nbsp;ip&nbsp;used&nbsp;by&nbsp;the&nbsp;&quot;connect&quot;&nbsp;part&nbsp;of&nbsp;the&nbsp;connection.&nbsp;In&nbsp;addition,&nbsp;it&nbsp;appears&nbsp;that&nbsp;only&nbsp;the&nbsp;first&nbsp;entry&nbsp;ever&nbsp;matches&nbsp;(at&nbsp;this&nbsp;point,&nbsp;i've&nbsp;tried&nbsp;so&nbsp;many&nbsp;combinations,&nbsp;i'm&nbsp;no&nbsp;longer&nbsp;certain&nbsp;of&nbsp;anything).&nbsp;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;i&nbsp;remove&nbsp;*all*&nbsp;the&nbsp;http_access&nbsp;lines,&nbsp;then&nbsp;the&nbsp;behavior&nbsp;appears&nbsp;correct&nbsp;(from&nbsp;a&nbsp;&quot;splicing/bumping&quot;&nbsp;standpoint).<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;anyone&nbsp;confirm&nbsp;that&nbsp;this&nbsp;is&nbsp;indeed&nbsp;possible&nbsp;to&nbsp;achieve?<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;believe,&nbsp;based&nbsp;on&nbsp;experimentation&nbsp;that&nbsp;any&nbsp;http_access&nbsp;i&nbsp;have,&nbsp;because&nbsp;of&nbsp;the&nbsp;&quot;deny&nbsp;all&quot;&nbsp;cause&nbsp;the&nbsp;bumping&nbsp;to&nbsp;&quot;short&nbsp;circuit&quot;&nbsp;and&nbsp;effectively&nbsp;send&nbsp;an&nbsp;early&nbsp;&quot;access&nbsp;denied&quot;&nbsp;based&nbsp;on&nbsp;the&nbsp;only&nbsp;information&nbsp;it&nbsp;has&nbsp;(the&nbsp;ip&nbsp;address&nbsp;from&nbsp;the&nbsp;&quot;connect&quot;,&nbsp;rather&nbsp;than&nbsp;the&nbsp;SNI&nbsp;that&nbsp;would&nbsp;come&nbsp;later).&nbsp;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Would&nbsp;a&nbsp;setup&nbsp;where&nbsp;&quot;deny&nbsp;http+!whitelist&quot;&nbsp;so&nbsp;have&nbsp;the&nbsp;allow&nbsp;be&nbsp;the&nbsp;default&nbsp;allow&nbsp;for&nbsp;the&nbsp;bumping&nbsp;to&nbsp;work&nbsp;and&nbsp;get&nbsp;to&nbsp;step2&nbsp;and&nbsp;match&nbsp;the&nbsp;sni*&nbsp;acls&nbsp;somehow?&nbsp;(with&nbsp;a&nbsp;&quot;deny&nbsp;step2&nbsp;!sni_whitelist&quot;).<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Is&nbsp;3.5.15&nbsp;capable&nbsp;of&nbsp;doing&nbsp;this?&nbsp;If&nbsp;this&nbsp;requires&nbsp;some&nbsp;feature/effort,&nbsp;what&nbsp;would&nbsp;be&nbsp;the&nbsp;procedure&nbsp;to&nbsp;sponsor&nbsp;that&nbsp;work?<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;BR&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Thanks,<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Jok<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BLOCKQUOTE&nbsp;TYPE=CITE&gt;<br>
&lt;PRE&gt;<br>
_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
&lt;A&nbsp;HREF=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/A&gt;<br>
&lt;A&nbsp;HREF=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/A&gt;<br>
&lt;/PRE&gt;<br>
&lt;/BLOCKQUOTE&gt;<br>
&lt;BR&gt;<br>
This&nbsp;may&nbsp;assist:&lt;BR&gt;<br>
&lt;BR&gt;<br>
&lt;A&nbsp;HREF=&quot;http://article.gmane.org/gmane.comp.web.squid.general/114389&quot;&gt;http://article.gmane.org/gmane.comp.web.squid.general/114389&lt;/A&gt;&lt;BR&gt;<br>
&lt;BR&gt;<br>
James<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;<br>

</tt>
