<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Apr&nbsp;4,&nbsp;2016&nbsp;at&nbsp;6:23&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;If&nbsp;i&nbsp;remove&nbsp;*all*&nbsp;the&nbsp;http_access&nbsp;lines,&nbsp;then&nbsp;the&nbsp;behavior&nbsp;appears&lt;br&gt;<br>
&gt;&gt;&nbsp;correct&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;(from&nbsp;a&nbsp;&quot;splicing/bumping&quot;&nbsp;standpoint).&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Strange.&nbsp;Squid&nbsp;without&nbsp;any&nbsp;http_access&nbsp;lines&nbsp;should&nbsp;be&nbsp;denying&nbsp;traffic&lt;br&gt;<br>
&gt;&gt;&nbsp;100%.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;do&nbsp;not&nbsp;see&nbsp;this&nbsp;behavior.&nbsp;Traffic&nbsp;appears&nbsp;to&nbsp;be&nbsp;allowed,&nbsp;and&nbsp;bumped&lt;br&gt;<br>
&gt;&nbsp;(though&nbsp;with&nbsp;the&nbsp;wrong&nbsp;certificate,&nbsp;depending&nbsp;on&nbsp;the&nbsp;config,&nbsp;as&nbsp;explained&lt;br&gt;<br>
&gt;&nbsp;before).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;my&nbsp;apologies&nbsp;for&nbsp;trying&nbsp;to&nbsp;show&nbsp;only&nbsp;the&nbsp;relevant&nbsp;parts.&nbsp;Find&nbsp;below&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;current&nbsp;config.&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;appears&nbsp;to&nbsp;be&nbsp;bumping&nbsp;everything&nbsp;rather&nbsp;than&nbsp;splicing&nbsp;any&nbsp;of&nbsp;the&nbsp;config&lt;br&gt;<br>
&gt;&nbsp;(which&nbsp;may&nbsp;be&nbsp;due&nbsp;to&nbsp;the&nbsp;limitations&nbsp;documented&nbsp;on&nbsp;the&nbsp;wiki)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3129&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;https_port&nbsp;8443&nbsp;intercept&nbsp;ssl-bump&nbsp;generate-host-certificates=on&lt;br&gt;<br>
&gt;&nbsp;dynamic_cert_mem_cache_size=64MB&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cert=/etc/squid/ssl/proxy.pem&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; key=/etc/squid/ssl/proxy.key&nbsp;\&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cafile=/etc/squid/ssl/proxy.pem&lt;br&gt;<br>
&gt;&nbsp;always_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;always_direct&nbsp;has&nbsp;not&nbsp;been&nbsp;necessary&nbsp;with&nbsp;SSL-Bump&nbsp;sice&nbsp;3.1&nbsp;series.&nbsp;You&lt;br&gt;<br>
should&nbsp;remove&nbsp;it.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;SniBypass&nbsp;ssl::server_name_regex&nbsp;\.slashdot\.org&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;SniBypass&nbsp;ssl::server_name_regex&nbsp;\.fsdn\.com&lt;br&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;moved&nbsp;those&nbsp;&quot;SniBypass&quot;&nbsp;acl&nbsp;into&nbsp;a&nbsp;separate&nbsp;files&nbsp;and&nbsp;replaced&nbsp;this&nbsp;with&nbsp;an&nbsp;include,&nbsp;as&nbsp;that&nbsp;list&nbsp;will&nbsp;end&nbsp;up&nbsp;growing. &lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;<br>
&gt;&nbsp;acl&nbsp;http_bypass&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://slashdot.org&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;slashdot.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;http_bypass&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://fsdn.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;fsdn.com&lt;/a&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;similarly&nbsp;here,&nbsp;replaced&nbsp;by&nbsp;an&nbsp;include...&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;https_bypass&nbsp;all-of&nbsp;CONNECT&nbsp;SniBypass&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;This&nbsp;https_bypass&nbsp;ACL&nbsp;definition&nbsp;is&nbsp;a&nbsp;bit&nbsp;weird.&nbsp;It&nbsp;requires&nbsp;a&nbsp;single&lt;br&gt;<br>
message&nbsp;to&nbsp;match&nbsp;both&nbsp;TLS&nbsp;and&nbsp;HTTP&nbsp;properties&nbsp;simultaneously.&lt;/blockquote&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
As&nbsp;you&nbsp;might&nbsp;imagine&nbsp;it&nbsp;is&nbsp;difficult&nbsp;for&nbsp;a&nbsp;TLS&nbsp;messages&nbsp;to&nbsp;match&nbsp;HTTP&lt;br&gt;<br>
properties,&nbsp;and&nbsp;vice&nbsp;versa.&nbsp;So&nbsp;it&nbsp;wont&nbsp;ever&nbsp;match.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;don&#39;t&nbsp;understand.&nbsp;SniBypass&nbsp;is&nbsp;based&nbsp;on&nbsp;ssl::server_name_regex&nbsp;which&nbsp;shouldn&#39;t&nbsp;apply&nbsp;to&nbsp;http&nbsp;at&nbsp;all... &lt;/div&gt;&lt;div&gt;Would&nbsp;that&nbsp;not&nbsp;be&nbsp;coming&nbsp;from&nbsp;the&nbsp;(client|server)Hello?&lt;/div&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
Note:&nbsp;SNI&nbsp;is&nbsp;*not*&nbsp;equivalent&nbsp;to&nbsp;Host&nbsp;or&nbsp;URL&nbsp;domain&nbsp;name.&nbsp;They&nbsp;can&lt;br&gt;<br>
contain&nbsp;very&nbsp;different&nbsp;values.&nbsp;The&nbsp;only&nbsp;thing&nbsp;they&nbsp;have&nbsp;in&nbsp;common&nbsp;is&lt;br&gt;<br>
that&nbsp;they&nbsp;both&nbsp;are&nbsp;supposed&nbsp;to&nbsp;point&nbsp;at&nbsp;the&nbsp;IP&nbsp;of&nbsp;the&nbsp;server&nbsp;being&lt;br&gt;<br>
contacted.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;http_ok&nbsp;all-of&nbsp;http_bypass&nbsp;Safe_ports&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;SniBypass&nbsp;step2&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;This&nbsp;splice&nbsp;will&nbsp;work&nbsp;if&nbsp;(and&nbsp;only&nbsp;if)&nbsp;the&nbsp;client&nbsp;sends&nbsp;TLS&nbsp;SNI&nbsp;values&lt;br&gt;<br>
to&nbsp;Squid.&nbsp;It&nbsp;will&nbsp;ignore&nbsp;the&nbsp;server&nbsp;cert&nbsp;details.&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;clients&nbsp;which&nbsp;do&nbsp;not&nbsp;send&nbsp;SNI&nbsp;or&nbsp;for&nbsp;all&nbsp;connections&nbsp;where&nbsp;the&nbsp;SNI&lt;br&gt;<br>
does&nbsp;not&nbsp;match&nbsp;your&nbsp;ACL&nbsp;the&nbsp;bump&nbsp;rule&nbsp;below&nbsp;will&nbsp;do&nbsp;client-first&nbsp;bumping&lt;br&gt;<br>
(without&nbsp;the&nbsp;server&nbsp;cert).&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;suggets&nbsp;you&nbsp;try&nbsp;these&nbsp;ssl_bump&nbsp;rules&nbsp;instead:&lt;br&gt;[snip]&lt;/blockquote&gt;&lt;div&gt; OK&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;[snip]&lt;br&gt;<br>
Okay.&nbsp;That&nbsp;sort&nbsp;of&nbsp;matches&nbsp;your&nbsp;policy.&nbsp;Except&nbsp;that&nbsp;you&nbsp;are&nbsp;missing&nbsp;the&lt;br&gt;<br>
security&nbsp;defaults.&nbsp;Those&nbsp;lines&nbsp;are&nbsp;carefully&nbsp;tuned&nbsp;for&nbsp;the&nbsp;specific&lt;br&gt;<br>
behaviour&nbsp;to&nbsp;protect&nbsp;against&nbsp;security&nbsp;attacks:&lt;br&gt;<br>
&lt;br&gt;<br>
 http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
 http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&lt;br&gt;<br>
..&nbsp;and&nbsp;should&nbsp;be&nbsp;above&nbsp;your&nbsp;custom&nbsp;rules.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;added&nbsp;those&nbsp;at&nbsp;the&nbsp;top&nbsp;as&nbsp;requested...&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;<br>
 cache&nbsp;allow&nbsp;all&lt;br&gt;<br>
 cache&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;...&nbsp;pick&nbsp;one.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;done&nbsp;-&nbsp;the&nbsp;deny&nbsp;one&nbsp;is&nbsp;the&nbsp;one&nbsp;left&nbsp;in&nbsp;there&nbsp;now. &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;shutdown_lifetime&nbsp;3&nbsp;seconds&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;for&nbsp;clarification,&nbsp;I&nbsp;also&nbsp;moved&nbsp;the&nbsp;two&nbsp;sets&nbsp;of&nbsp;ACLs&nbsp;into&nbsp;separate&nbsp;files,&nbsp;as&nbsp;those&nbsp;will&nbsp;eventually&nbsp;be&nbsp;maintained&nbsp;externally&nbsp;(SniBypass&nbsp;and&nbsp;http_bypass).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;config&nbsp;file&nbsp;is&nbsp;now:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;#&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;ftp&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;gopher&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;wais&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;unregistered&nbsp;ports&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;http-mgmt&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;#&nbsp;gss-http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;filemaker&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&lt;/span&gt;#&nbsp;multiling&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&lt;/div&gt;&lt;div&gt;http_port&nbsp;3129&nbsp;intercept&lt;/div&gt;&lt;div&gt;https_port&nbsp;8443&nbsp;intercept&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=64MB&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;cert=/etc/squid/ssl/proxy.pem&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;key=/etc/squid/ssl/proxy.key&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;cafile=/etc/squid/ssl/proxy.pem&lt;/div&gt;&lt;div&gt;workers&nbsp;6&lt;/div&gt;&lt;div&gt;always_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;&lt;div&gt;include&nbsp;&quot;/etc/squid/snibypass.acl&quot;&lt;/div&gt;&lt;div&gt;include&nbsp;&quot;/etc/squid/dstbypass.acl&quot;&lt;/div&gt;&lt;div&gt;acl&nbsp;https_ok&nbsp;all-of&nbsp;CONNECT&nbsp;SniBypass&lt;/div&gt;&lt;div&gt;acl&nbsp;http_ok&nbsp;all-of&nbsp;http_bypass&nbsp;Safe_ports&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;SniBypass&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;stare&nbsp;step2&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;all&lt;/div&gt;&lt;div&gt;sslproxy_options&nbsp;NO_SSLv2,NO_SSLv3,SINGLE_ECDH_USE&lt;/div&gt;&lt;div&gt;sslproxy_cert_sign_hash&nbsp;sha256&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;sslcrtd_children&nbsp;8&nbsp;startup=1&nbsp;idle=1&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;http_ok&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;https_ok&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;cache&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;shutdown_lifetime&nbsp;3&nbsp;seconds&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;with&nbsp;that&nbsp;config,&nbsp;the&nbsp;http_access&nbsp;deny&nbsp;all&nbsp;(couple&nbsp;lines&nbsp;before&nbsp;the&nbsp;end)&nbsp;appears&nbsp;to&nbsp;deny&nbsp;the&nbsp;TLS/SSL&nbsp;connection&nbsp;before&nbsp;the&nbsp;ssl_bump&nbsp;steps&nbsp;have&nbsp;a&nbsp;chance&nbsp;to&nbsp;match,&nbsp;so&nbsp;i&nbsp;get&nbsp;certs&nbsp;that&nbsp;are&nbsp;not&nbsp;mimic&#39;ed&nbsp;(they&nbsp;have&nbsp;CN=&lt;ip&gt;).&nbsp;If&nbsp;i&nbsp;remove&nbsp;all&nbsp;3&nbsp;http_access&nbsp;at&nbsp;the&nbsp;end,&nbsp;then&nbsp;the&nbsp;splicing/bumping&nbsp;behavior&nbsp;appears&nbsp;to&nbsp;work&nbsp;as&nbsp;expected,&nbsp;but&nbsp;then&nbsp;i&#39;m&nbsp;not&nbsp;denying&nbsp;anything...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;that&nbsp;seems&nbsp;to&nbsp;confirm&nbsp;my&nbsp;suspicion&nbsp;that&nbsp;the&nbsp;access&nbsp;control&nbsp;(http_access)&nbsp;apply&nbsp;too&nbsp;early&nbsp;for&nbsp;me&nbsp;to&nbsp;match&nbsp;anything&nbsp;related&nbsp;to&nbsp;the&nbsp;ssl::server_name&nbsp;or&nbsp;ssl::server_name_regex.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;keep&nbsp;thinking&nbsp;that&nbsp;what&nbsp;i&#39;m&nbsp;missing&nbsp;is&nbsp;that&nbsp;the&nbsp;http_access&nbsp;applies&nbsp;too&nbsp;early.&nbsp;I&nbsp;played&nbsp;with&nbsp;&quot;terminate&quot;&nbsp;instead&nbsp;of&nbsp;&quot;bump&quot;&nbsp;at&nbsp;the&nbsp;last&nbsp;ssl_bump&nbsp;command,&nbsp;but&nbsp;i&nbsp;really&nbsp;need&nbsp;the&nbsp;error&nbsp;message.&nbsp;I&nbsp;keep&nbsp;wanting&nbsp;to&nbsp;have&nbsp;something&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;SniBypass&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;stare&nbsp;step2&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;deny&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;where&nbsp;the&nbsp;last&nbsp;one&nbsp;would&nbsp;effectively&nbsp;bump&nbsp;the&nbsp;connection,&nbsp;and&nbsp;provide&nbsp;the&nbsp;ERR_ACCESS_DENIED&nbsp;page.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;so&nbsp;much&nbsp;for&nbsp;your&nbsp;help.&lt;/div&gt;&lt;div&gt;Jok&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
