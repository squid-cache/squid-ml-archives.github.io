<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;PGP&nbsp;SIGNED&nbsp;MESSAGE-----&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Hash:&nbsp;SHA256&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp; &lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;18.04.16&nbsp;22:11,&nbsp;Guy&nbsp;Helmer&nbsp;пишет:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;white-space:&nbsp;pre;&quot;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;On&nbsp;Apr&nbsp;17,&nbsp;2016,&nbsp;at&nbsp;5:50&nbsp;AM,&nbsp;Yuri&nbsp;Voinov<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-rfc2396E&quot;&nbsp;href=&quot;mailto:yvoinov@gmail.com&quot;&gt;&lt;yvoinov@gmail.com&gt;&lt;/a&gt;&nbsp;wrote:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;-----BEGIN&nbsp;PGP&nbsp;SIGNED&nbsp;MESSAGE-----&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;Hash:&nbsp;SHA256&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt; &nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;*NIX&nbsp;means&nbsp;UNIX.&nbsp;Solaris&nbsp;is&nbsp;AT&amp;T&nbsp;UNIX.&nbsp;Linux&nbsp;is&nbsp;not<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNIX&nbsp;(C)&nbsp;Linus&nbsp;Torvalds.&nbsp;:)&nbsp;We&nbsp;are&nbsp;not&nbsp;speaking&nbsp;about&nbsp;all&nbsp;possible<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OS'es.&nbsp;I&nbsp;suggests&nbsp;the&nbsp;matter&nbsp;in&nbsp;SSL/TLS,&nbsp;not&nbsp;OS&nbsp;or&nbsp;hands&nbsp;or<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;something&nbsp;similar.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;The&nbsp;problem&nbsp;is&nbsp;in&nbsp;CF,&nbsp;I&nbsp;think.&nbsp;As&nbsp;a&nbsp;maximum&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peek-n-splice.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;Because&nbsp;of&nbsp;I've&nbsp;not&nbsp;changed&nbsp;my&nbsp;squid.conf&nbsp;over&nbsp;last&nbsp;year,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;but&nbsp;approx.&nbsp;in&nbsp;january&nbsp;2016&nbsp;CloudFlare&nbsp;stopped&nbsp;work&nbsp;via&nbsp;proxy,&nbsp;as<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;said&nbsp;my&nbsp;field&nbsp;SA.&nbsp;AFAIK,&nbsp;CF&nbsp;change&nbsp;own&nbsp;security&nbsp;settings.&nbsp;Also,&nbsp;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;suggests,&nbsp;mozilla&nbsp;.org&nbsp;also&nbsp;moved&nbsp;behind&nbsp;CF.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;Ok,&nbsp;let's&nbsp;talk&nbsp;about&nbsp;squid.conf.&nbsp;SSL-related&nbsp;rows&nbsp;are<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;here:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;#&nbsp;SSL&nbsp;bump&nbsp;rules&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;acl&nbsp;DiscoverSNIHost&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;acl&nbsp;NoSSLIntercept&nbsp;ssl::server_name_regex&nbsp;-i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/usr/local/squid/etc/url.nobump&quot;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;acl&nbsp;NoSSLIntercept&nbsp;ssl::server_name_regex&nbsp;-i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/usr/local/squid/etc/url.tor&quot;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;DiscoverSNIHost&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;NoSSLIntercept&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;http_port&nbsp;3126&nbsp;intercept&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;https_port&nbsp;3127&nbsp;intercept&nbsp;ssl-bump<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cert=/usr/local/squid/etc/rootCA.crt<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key=/usr/local/squid/etc/rootCA.key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options=SINGLE_DH_USE,SINGLE_ECDH_USE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tls-dh=prime256v1:/usr/local/squid/etc/dhparam.pem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;generate-host-certificates=on<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dynamic_cert_mem_cache_size=4MB<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cert=/usr/local/squid/etc/rootCA.crt<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key=/usr/local/squid/etc/rootCA.key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options=SINGLE_DH_USE,SINGLE_ECDH_USE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tls-dh=prime256v1:/usr/local/squid/etc/dhparam.pem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;tls_outgoing_options<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cafile=/usr/local/squid/etc/ca-bundle.crt<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options=SINGLE_DH_USE,SINGLE_ECDH_USE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cipher=HIGH:MEDIUM:!aNULL:!eNULL:!RC4:!LOW:!MD5:!EXP:!PSK:!SRP:!DSS&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;sslproxy_foreign_intermediate_certs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/usr/local/squid/etc/intermediate_ca.pem&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;sslcrtd_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/usr/local/squid/libexec/security_file_certgen&nbsp;-s&nbsp;/var/lib/ssl_db<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;I&nbsp;see&nbsp;no&nbsp;anomalies&nbsp;in&nbsp;this&nbsp;lines.&nbsp;Ciphersuite&nbsp;is&nbsp;very<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relaxed.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&nbsp;Also,&nbsp;if&nbsp;we&nbsp;discuss&nbsp;a&nbsp;bug&nbsp;-&nbsp;may&nbsp;be&nbsp;better&nbsp;to&nbsp;turn&nbsp;on<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug&nbsp;to&nbsp;know,&nbsp;why&nbsp;4.x&nbsp;got&nbsp;first&nbsp;NONE_ABORTED/200&nbsp;during&nbsp;CONNECT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;phase&nbsp;and&nbsp;then&nbsp;NONE/503&nbsp;during&nbsp;TLS&nbsp;negotiate?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;Hi,&nbsp;Yuri,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;If&nbsp;I&nbsp;understand&nbsp;correctly,&nbsp;the&nbsp;issue&nbsp;is&nbsp;between&nbsp;squid&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;origin&nbsp;proxy.&nbsp;In&nbsp;case&nbsp;it&nbsp;would&nbsp;help,&nbsp;have&nbsp;you&nbsp;enabled&nbsp;ECDH<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslproxy_options&nbsp;or&nbsp;sslproxy_cipher&nbsp;settings&nbsp;in&nbsp;this&nbsp;snippet&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;would&nbsp;enable&nbsp;Squid&nbsp;to&nbsp;use&nbsp;ECDH&nbsp;when&nbsp;talking&nbsp;to&nbsp;the&nbsp;origin&nbsp;servers?&lt;/span&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;As&nbsp;you&nbsp;can&nbsp;see&nbsp;above&nbsp;-&nbsp;yes,&nbsp;ECDH&nbsp;enabled,&nbsp;and&nbsp;I've&nbsp;checked&nbsp;it&nbsp;via<br>
&nbsp;&nbsp;&nbsp;&nbsp;Qualys&nbsp;SSL&nbsp;Labs&nbsp;-&nbsp;Projects&nbsp;/&nbsp;SSL&nbsp;Client&nbsp;Test<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-rfc2396E&quot;&nbsp;href=&quot;https://www.ssllabs.com/ssltest/viewMyClient.html&quot;&gt;&lt;https://www.ssllabs.com/ssltest/viewMyClient.html&gt;&lt;/a&gt;.&nbsp;Also<br>
&nbsp;&nbsp;&nbsp;&nbsp;another&nbsp;sites&nbsp;utilize&nbsp;ECDH&nbsp;with&nbsp;this&nbsp;setup&nbsp;like&nbsp;sharm.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;white-space:&nbsp;pre;&quot;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;Do&nbsp;you&nbsp;happen&nbsp;to&nbsp;have&nbsp;a&nbsp;packet&nbsp;capture&nbsp;between&nbsp;your&nbsp;squid<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;and&nbsp;a&nbsp;CloudFlare&nbsp;server&nbsp;that&nbsp;could&nbsp;help&nbsp;diagnose&nbsp;the&nbsp;TLS<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protocol’s&nbsp;problem?&lt;/span&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Not&nbsp;now.&nbsp;First&nbsp;this&nbsp;issue&nbsp;occurs&nbsp;onto&nbsp;production&nbsp;environment,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;&nbsp;has&nbsp;own&nbsp;DMZ&nbsp;and&nbsp;heavy&nbsp;enough&nbsp;traffic&nbsp;from&nbsp;a&nbsp;few&nbsp;dozen&nbsp;customers.<br>
&nbsp;&nbsp;&nbsp;&nbsp;Some&nbsp;difficults&nbsp;to&nbsp;isolate&nbsp;one&nbsp;transaction&nbsp;with&nbsp;sniffing.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&nbsp;style=&quot;white-space:&nbsp;pre;&quot;&gt;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;Regards,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;Guy&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&lt;/span&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;PGP&nbsp;SIGNATURE-----<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Version:&nbsp;GnuPG&nbsp;v2<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp; &lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;iQEcBAEBCAAGBQJXFQ1UAAoJENNXIZxhPexGEJYH/jkPrxiY9ztyltmoXJLeYsMy<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;YxuGgtFWyW96Z8HZ1Zf9BzucDGAvUdfTLnvZb/4dh22bs+COQbX2s53RcSqGAJaP<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;CVfRG4AgU+R8AUNA9nLxAbM4NQM4EAbB16ZsF8jeyZzJXPiRjozLtDjo1vMslJtV<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;791L5gn//izooJAlLMNKxoSy37RniEcaRLnuol+xVb4jqfx3nWo4lQzWnS2cXe5k<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;YFIb4X8uTEo6lgH8Ld8FHQYRq6KZz11TZbQ+ft5CKFY5pqNqLP+Cjrq1bgTUgKVK<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;WA0F96GR9IECDe4pWCPXnX2bijTax5nY9NNs/rA1Pawch4j4ZyUY2I/M9ngI6RU=<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;=Y/pM<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;PGP&nbsp;SIGNATURE-----<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
