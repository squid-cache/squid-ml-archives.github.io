<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;create&nbsp;a&nbsp;kind&nbsp;of&nbsp;captive&nbsp;portal&nbsp;when&nbsp;only&nbsp;my&nbsp;domain&nbsp;and&nbsp;google&nbsp;play&nbsp;are&nbsp;whitelisted&nbsp;and&nbsp;other&nbsp;addresses(http/https)&nbsp;are&nbsp;forwarded&nbsp;to&nbsp;my&nbsp;domain. &lt;/div&gt;&lt;div&gt;All&nbsp;http&nbsp;requests&nbsp;are&nbsp;landing&nbsp;fine&nbsp;in&nbsp;the&nbsp;url_rewrite&nbsp;program,&nbsp;while&nbsp;the&nbsp;https&nbsp;requests&nbsp;appear&nbsp;as&nbsp;only&nbsp;the&nbsp;IP&nbsp;address&nbsp;but&nbsp;not&nbsp;the&nbsp;dns&nbsp;name.&nbsp;I&#39;m&nbsp;aware&nbsp;of &lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/Features/SslPeekAndSplice&quot;&gt;http://wiki.squid-cache.org/Features/SslPeekAndSplice&lt;/a&gt;&nbsp;and&nbsp;especially&nbsp;the&nbsp;note&nbsp;that&nbsp;during&nbsp;ssl_bump&nbsp;no&nbsp;dns&nbsp;name&nbsp;is&nbsp;available&nbsp;yet&nbsp;and&nbsp;instead&nbsp;one&nbsp;should&nbsp;be&nbsp;using&nbsp;the&nbsp;acl&nbsp;ssl::server_name&nbsp;directive,&nbsp;but&nbsp;for&nbsp;some&nbsp;reason&nbsp;no&nbsp;https&nbsp;address&nbsp;is&nbsp;being&nbsp;sent&nbsp;to&nbsp;my&nbsp;url_rewrite&nbsp;program.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;same&nbsp;SSL&nbsp;certificate&nbsp;used&nbsp;on&nbsp;my&nbsp;domain&nbsp;is&nbsp;also&nbsp;being&nbsp;used&nbsp;with&nbsp;squid&nbsp;at&nbsp;https_port&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;using&nbsp;squid&nbsp;3.5.20&nbsp;compiled&nbsp;manually&nbsp;with&nbsp;the&nbsp;following&nbsp;directives:&lt;/div&gt;&lt;div&gt;&lt;div&gt;./configure&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--prefix=/usr&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--exec-prefix=/usr&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--includedir=/usr/include&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--datadir=${prefix}/share/squid&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--libdir=/usr/lib64&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--libexecdir=${prefix}/lib/squid&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--localstatedir=/var&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--sysconfdir=/etc/squid&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--sharedstatedir=/var/lib&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--with-logdir=/var/log/squid&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--with-pidfile=/var/run/squid.pid&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--with-default-user=proxy&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-silent-rules&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-dependency-tracking&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--with-openssl&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-ssl&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-icmp&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-delay-pools&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-useragent-log&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-esi&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-ssl-crtd&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-follow-x-forwarded-for&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-storeid-rewrite-helpers&nbsp;\&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;--enable-external-acl-helpers&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s&nbsp;my&nbsp;squid.conf&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;div&gt;pinger_enable&nbsp;off&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;unregistered&nbsp;ports&lt;/div&gt;&lt;div&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;http&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&gt;mydomain.com&lt;/a&gt; &lt;/div&gt;&lt;div&gt;acl&nbsp;https&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&gt;mydomain.com&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;http&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;https&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;url_rewrite_program&nbsp;/bin/bash&nbsp;-c&nbsp;-l&nbsp;/etc/squid/redirect.bash&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!http&lt;/div&gt;&lt;div&gt;url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!https&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;3127&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;intercept&lt;/div&gt;&lt;div&gt;https_port&nbsp;3129&nbsp;intercept&nbsp;cert=mycert.cert&nbsp;key=mykey.key&nbsp;ssl-bump&nbsp;intercept&nbsp;generate-host-certificates=on&nbsp; version=1&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp; cafile=Intermediate.crt&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;always_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;localhost&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;https&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/cache/squid&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;any&nbsp;idea&nbsp;why&nbsp;no&nbsp;https&nbsp;urls&nbsp;are&nbsp;being&nbsp;redirected&nbsp;to&nbsp;the&nbsp;url_rewrite&nbsp;program?&lt;/div&gt;&lt;div&gt;Any&nbsp;alternative&nbsp;solution&nbsp;is&nbsp;also&nbsp;very&nbsp;much&nbsp;welcome&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards&lt;/div&gt;&lt;div&gt;Moataz&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
