<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;just&nbsp;had&nbsp;an&nbsp;idea.&nbsp;Refering&nbsp;to&nbsp;the&nbsp;last&nbsp;email.&lt;/div&gt;&lt;div&gt;The&nbsp;reason&nbsp;why&nbsp;I&#39;m&nbsp;getting&nbsp;those&nbsp;&quot;Header&nbsp;forgery&quot;&nbsp;errors&nbsp;might&nbsp;be&nbsp;because&nbsp;of&nbsp;the&nbsp;defined&nbsp;nat&nbsp;rules.&nbsp;I&#39;m&nbsp;using&nbsp;the&nbsp;following&nbsp;rules:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;--match&nbsp;owner&nbsp;--uid-owner&nbsp;proxy&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;ACCEPT&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;DNAT&nbsp;--to-destination&nbsp;${MY_IP}:3128&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;--match&nbsp;owner&nbsp;--uid-owner&nbsp;proxy&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;ACCEPT&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;DNAT&nbsp;--to-destination&nbsp;${MY_IP}:3129&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;so,&nbsp;the&nbsp;next&nbsp;thing&nbsp;is&nbsp;I&nbsp;changed&nbsp;the&nbsp;--to-destination&nbsp;lines&nbsp;as&nbsp;follows:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;owner&nbsp;!&nbsp;--uid-owner&nbsp;proxy&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-port&nbsp;3129&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;no&nbsp;success.&nbsp;Do&nbsp;these&nbsp;nat&nbsp;rules&nbsp;have&nbsp;anything&nbsp;to&nbsp;do&nbsp;with&nbsp;the&nbsp;header&nbsp;forgery&nbsp;problem?&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Jul&nbsp;7,&nbsp;2016&nbsp;at&nbsp;7:28&nbsp;PM,&nbsp;Moataz&nbsp;Elmasry&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:zaza1851983ml@googlemail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;zaza1851983ml@googlemail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Sorry,&nbsp;I&nbsp;just&nbsp;realized,&nbsp;I&nbsp;sent&nbsp;you&nbsp;a&nbsp;private&nbsp;email&nbsp;instead&nbsp;of&nbsp;to&nbsp;the&nbsp;mailing&nbsp;list.&nbsp;Apologies&nbsp;for&nbsp;that. &lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;Hi&nbsp;Amos,&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;did&nbsp;some&nbsp;progress&nbsp;today&nbsp;so&nbsp;that&nbsp;least&nbsp;I&#39;m&nbsp;not&nbsp;getting&nbsp;any&nbsp;errors&nbsp;in&nbsp;the&nbsp;browser,&nbsp;te&nbsp;url_redirect_program&nbsp;receives&nbsp;the&nbsp;actual&nbsp;url.&nbsp;Redirecting&nbsp;normal&nbsp;http&nbsp;urls&nbsp;work&nbsp;fine,&nbsp;but&nbsp;redirecting&nbsp;https&nbsp;urls&nbsp;results&nbsp;in&nbsp;a&nbsp;similar&nbsp;error&nbsp;in&nbsp;the&nbsp;logs:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;div&gt;2016/07/07&nbsp;17:19:28|&nbsp;SECURITY&nbsp;ALERT:&nbsp;Host&nbsp;header&nbsp;forgery&nbsp;detected&nbsp;on&nbsp;local=&lt;a&nbsp;href=&quot;http://31.13.92.36:443/&quot;&nbsp;target=&quot;_blank&quot;&gt;31.13.92.36:443&lt;/a&gt; remote=x.x.x.x:65228&nbsp;FD&nbsp;18&nbsp;flags=33&nbsp;(local&nbsp;IP&nbsp;does&nbsp;not&nbsp;match&nbsp;any&nbsp;domain&nbsp;IP)&lt;/div&gt;&lt;div&gt;2016/07/07&nbsp;17:19:28|&nbsp;SECURITY&nbsp;ALERT:&nbsp;on&nbsp;URL: &lt;a&nbsp;href=&quot;http://www.facebook.com:443/&quot;&nbsp;target=&quot;_blank&quot;&gt;www.facebook.com:443&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;And&nbsp;the&nbsp;browser&nbsp;tab&nbsp;hags&nbsp;(in&nbsp;page&nbsp;loading)&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Heres&nbsp;the &lt;span&gt;squid&lt;/span&gt;.conf&nbsp;important&nbsp;parts&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&quot;&lt;/div&gt;&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;acl&nbsp;http_sites&nbsp;dstdomain &lt;a&nbsp;href=&quot;http://play.google.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt; &lt;a&nbsp;href=&quot;http://mydomain.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;/div&gt;&lt;/span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;acl&nbsp;https_sites&nbsp;ssl::server_name &lt;a&nbsp;href=&quot;http://play.google.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt; &lt;a&nbsp;href=&quot;http://mydomain.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;acl&nbsp;HTTP&nbsp;proto&nbsp;HTTP&lt;/div&gt;&lt;div&gt;acl&nbsp;HTTPS&nbsp;proto&nbsp;HTTPS&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;http_sites&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;https_sites&lt;/div&gt;&lt;/span&gt;&lt;span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;sslcrtd_program&nbsp;/lib/&lt;span&gt;squid&lt;/span&gt;/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;span&gt;&lt;div&gt;http_port&nbsp;3127&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;intercept&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;https_port&nbsp;3129&nbsp;cert=/etc/&lt;span&gt;squid&lt;/span&gt;/ssl/example.com.cert&nbsp;key=/etc/&lt;span&gt;squid&lt;/span&gt;/ssl/example.com.private&nbsp;ssl-bump&nbsp;intercept&nbsp;generate-host-certificates=on&nbsp; version=1&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp;capath=/etc/ssl/certs/&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslproxy_cert_error&nbsp;allow&nbsp;all &lt;/div&gt;&lt;div&gt;sslproxy_flags&nbsp;DONT_VERIFY_PEER &lt;/div&gt;&lt;/span&gt;&lt;span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;splice&nbsp;step2&nbsp;all&nbsp;!https_sites &lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&nbsp;!https_sites&lt;/div&gt;&lt;/span&gt;&lt;span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;url_rewrite_program&nbsp;/bin/bash&nbsp;-c&nbsp;-l&nbsp;/etc/&lt;span&gt;squid&lt;/span&gt;/redirect.bash&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&gt;url_rewrite_extras&nbsp;&quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;%un&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp&nbsp; ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;/div&gt;&lt;div&gt;logformat &lt;span&gt;squid&lt;/span&gt; &quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;%un&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp&nbsp; ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;/div&gt;&lt;div&gt;url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!http_sites&nbsp;!https_sites&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/cache/&lt;span&gt;squid&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;searched&nbsp;a&nbsp;bit&nbsp;on&nbsp;the&nbsp;&quot;Host&nbsp;header&nbsp;forgery&nbsp;detected&quot;&nbsp;but&nbsp;could&nbsp;not&nbsp;find&nbsp;a&nbsp;similar&nbsp;situation&nbsp;to&nbsp;mines&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Any&nbsp;ideas&nbsp;how&nbsp;to&nbsp;overcome&nbsp;this&nbsp;error?&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Many&nbsp;thanks&nbsp;and&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Moataz&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;Wed,&nbsp;Jul&nbsp;6,&nbsp;2016&nbsp;at&nbsp;9:30&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;/span&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&gt;On&nbsp;2016-07-06&nbsp;10:48,&nbsp;Moataz&nbsp;Elmasry&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi&nbsp;all,&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;m&nbsp;trying&nbsp;to&nbsp;create&nbsp;a&nbsp;kind&nbsp;of&nbsp;captive&nbsp;portal&nbsp;when&nbsp;only&nbsp;my&nbsp;domain&nbsp;and&lt;br&gt;<br>
google&nbsp;play&nbsp;are&nbsp;whitelisted&nbsp;and&nbsp;other&nbsp;addresses(http/https)&nbsp;are&lt;br&gt;<br>
forwarded&nbsp;to&nbsp;my&nbsp;domain.&lt;br&gt;<br>
All&nbsp;http&nbsp;requests&nbsp;are&nbsp;landing&nbsp;fine&nbsp;in&nbsp;the&nbsp;url_rewrite&nbsp;program,&nbsp;while&lt;br&gt;<br>
the&nbsp;https&nbsp;requests&nbsp;appear&nbsp;as&nbsp;only&nbsp;the&nbsp;IP&nbsp;address&nbsp;but&nbsp;not&nbsp;the&nbsp;dns&nbsp;name.&lt;br&gt;<br>
I&#39;m&nbsp;aware&nbsp;of&nbsp;&lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/Features/SslPeekAndSplice&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/Features/SslPeekAndSplice&lt;/a&gt;&nbsp;and&lt;br&gt;<br>
especially&nbsp;the&nbsp;note&nbsp;that&nbsp;during&nbsp;ssl_bump&nbsp;no&nbsp;dns&nbsp;name&nbsp;is&nbsp;available&nbsp;yet&lt;br&gt;<br>
and&nbsp;instead&nbsp;one&nbsp;should&nbsp;be&nbsp;using&nbsp;the&nbsp;acl&nbsp;ssl::server_name&nbsp;directive,&lt;br&gt;<br>
but&nbsp;for&nbsp;some&nbsp;reason&nbsp;no&nbsp;https&nbsp;address&nbsp;is&nbsp;being&nbsp;sent&nbsp;to&nbsp;my&nbsp;url_rewrite&lt;br&gt;<br>
program.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;same&nbsp;SSL&nbsp;certificate&nbsp;used&nbsp;on&nbsp;my&nbsp;domain&nbsp;is&nbsp;also&nbsp;being&nbsp;used&nbsp;with&lt;br&gt;<br>
squid&nbsp;at&nbsp;https_port&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;&lt;span&gt;<br>
Here&#39;s&nbsp;my&nbsp;squid.conf&lt;br&gt;<br>
&lt;br&gt;<br>
&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
pinger_enable&nbsp;off&lt;br&gt;&lt;/span&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp;[1]&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;<br>
&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp;[2]&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;[3]&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&lt;span&gt;&lt;br&gt;<br>
network&lt;br&gt;<br>
&lt;br&gt;<br>
acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https&lt;br&gt;<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;<br>
acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;manager&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
acl&nbsp;http&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;[4]&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&nbsp;[5]&lt;br&gt;<br>
acl&nbsp;https&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;[4]&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&nbsp;[5]&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;...&nbsp;weird.&nbsp;There&nbsp;is&nbsp;nothing&nbsp;in&nbsp;the&nbsp;ACL&nbsp;matching&nbsp;which&nbsp;would&nbsp;indicate&nbsp;it&nbsp;was&nbsp;HTTP&nbsp;vs&nbsp;HTTPS.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;dstdomain&nbsp;can&nbsp;match&nbsp;for&nbsp;CONNECT&nbsp;tunnels&nbsp;transferring&nbsp;non-HTTP&nbsp;traffic&nbsp;when&nbsp;the&nbsp;URI&nbsp;contains&nbsp;the&nbsp;domain&nbsp;specified.&nbsp;It&nbsp;only&nbsp;indicates&nbsp;that&nbsp;HTTP&nbsp;was&nbsp;used&nbsp;by&nbsp;the&nbsp;client&nbsp;...&nbsp;except&nbsp;for&nbsp;intercepted&nbsp;HTTPS&nbsp;traffic,&nbsp;where&nbsp;it&nbsp;merely&nbsp;indicates&nbsp;that&nbsp;Squid&nbsp;itself&nbsp;is&nbsp;wrapping&nbsp;the&nbsp;inbound&nbsp;traffic&nbsp;into&nbsp;HTTP&nbsp;compatible&nbsp;format&nbsp;before&nbsp;interpreting&nbsp;them.&nbsp;Squid&nbsp;sometimes&nbsp;uses&nbsp;the&nbsp;TLS&nbsp;SNI&nbsp;value&nbsp;as&nbsp;the&nbsp;URI&nbsp;dstdomain.&lt;br&gt;<br>
 &nbsp;-&gt;&nbsp;unreliable.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;TLS&nbsp;SNI&nbsp;can&nbsp;contain&nbsp;the&nbsp;listed&nbsp;server&nbsp;name&nbsp;for&nbsp;non-HTTPS&nbsp;protocols.&lt;br&gt;<br>
 &nbsp;-&gt;&nbsp;unreliable.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;http&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;https&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
*&nbsp;&quot;http_access&quot;&nbsp;means&nbsp;Squid&nbsp;is&nbsp;testing&nbsp;whether&nbsp;an&nbsp;HTTP&nbsp;protocol&nbsp;client&nbsp;is&nbsp;allowed&nbsp;to&nbsp;use&nbsp;the&nbsp;proxy.&nbsp;The&nbsp;&quot;http&quot;&nbsp;URL&nbsp;contains&nbsp;HTTP&nbsp;protocol&nbsp;matching.&nbsp;Which&nbsp;is&nbsp;okay,&nbsp;but&nbsp;see&nbsp;above&nbsp;about&nbsp;what&nbsp;the&nbsp;&quot;dstdomain&nbsp;&quot;value&nbsp;could&nbsp;be.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;The&nbsp;&quot;https&quot;&nbsp;ACL&nbsp;contains&nbsp;TLS&nbsp;details&nbsp;matching&nbsp;-&nbsp;so&nbsp;is&nbsp;usually&nbsp;not&nbsp;possible&nbsp;to&nbsp;even&nbsp;test&nbsp;like&nbsp;this.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;localnet&nbsp;and&nbsp;localhost&nbsp;are&nbsp;already&nbsp;allowed&nbsp;to&nbsp;do&nbsp;anything&nbsp;safe&nbsp;by&nbsp;the&nbsp;earlier&nbsp;http_access&nbsp;rules.&nbsp;I&nbsp;doubt&nbsp;these&nbsp;confused&nbsp;matches&nbsp;are&nbsp;even&nbsp;getting&nbsp;used.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
url_rewrite_program&nbsp;/bin/bash&nbsp;-c&nbsp;-l&nbsp;/etc/squid/redirect.bash&lt;br&gt;<br>
&lt;br&gt;<br>
url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!http&lt;br&gt;<br>
url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!https&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
Several&nbsp;problems&nbsp;here:&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;&quot;all&quot;&nbsp;is&nbsp;only&nbsp;a&nbsp;meaningless&nbsp;waste&nbsp;of&nbsp;CPU&nbsp;time&nbsp;and&nbsp;memory&nbsp;in&nbsp;this&nbsp;usage.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;&quot;https&quot;&nbsp;ACL&nbsp;probably&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;match.&nbsp;Rewriting&nbsp;of&nbsp;the&nbsp;*HTTP*&nbsp;URL&nbsp;is&nbsp;a&nbsp;HTTP&nbsp;decision.&nbsp;Not&nbsp;TLS.&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;The&nbsp;use&nbsp;of&nbsp;negation&nbsp;(!)&nbsp;means&nbsp;you&nbsp;have&nbsp;expicitly&nbsp;configured&nbsp;Squid&nbsp;*not*&nbsp;to&nbsp;send&nbsp;any&nbsp;lookups&nbsp;to&nbsp;the&nbsp;helper&nbsp;when&nbsp;the&nbsp;ACL&nbsp;listed&nbsp;domain&nbsp;name(s)&nbsp;are&nbsp;present&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;request.&lt;br&gt;<br>
 So&nbsp;you&nbsp;were&nbsp;asking&nbsp;why&nbsp;no&nbsp;requests&nbsp;with&nbsp;the&nbsp;domain&nbsp;name&nbsp;show&nbsp;up&nbsp;in&nbsp;the&nbsp;helper?&lt;br&gt;<br>
 Squid&nbsp;is&nbsp;obeying&nbsp;your&nbsp;explicit&nbsp;instructions&nbsp;not&nbsp;to&nbsp;send&nbsp;them.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
Not&nbsp;safe.&lt;br&gt;<br>
&lt;br&gt;<br>
localnet&nbsp;and&nbsp;localhost&nbsp;are&nbsp;already&nbsp;allowed&nbsp;to&nbsp;do&nbsp;anything&nbsp;safe&nbsp;by&nbsp;the&nbsp;earlier&nbsp;http_access&nbsp;rules.&nbsp;SO&nbsp;you&nbsp;should&nbsp;not&nbsp;see&nbsp;a&nbsp;change&nbsp;if&nbsp;you&nbsp;set&nbsp;this&nbsp;back&nbsp;to&nbsp;the&nbsp;&quot;deny&nbsp;all&quot;&nbsp;which&nbsp;it&nbsp;should&nbsp;be.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
http_port&nbsp;3127&lt;br&gt;<br>
http_port&nbsp;3128&nbsp;intercept&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
Not&nbsp;safe&nbsp;practice.&nbsp;Port&nbsp;3128&nbsp;is&nbsp;the&nbsp;officialy&nbsp;registered&nbsp;Squid&nbsp;proxy&nbsp;port&nbsp;and&nbsp;quite&nbsp;well&nbsp;known.&nbsp;There&nbsp;are&nbsp;several&nbsp;attacks&nbsp;that&nbsp;can&nbsp;be&nbsp;done&nbsp;if&nbsp;the&nbsp;attacker&nbsp;happens&nbsp;to&nbsp;identify&nbsp;what&nbsp;intercept&nbsp;port&nbsp;is&nbsp;numbered&nbsp;and&nbsp;connect&nbsp;there.&nbsp;Use&nbsp;a&nbsp;randomly&nbsp;selected&nbsp;other&nbsp;port&nbsp;number.&lt;br&gt;<br>
&lt;br&gt;<br>
Same&nbsp;for&nbsp;the&nbsp;below&nbsp;3129.&nbsp;It&nbsp;is&nbsp;used&nbsp;in&nbsp;our&nbsp;documetation&nbsp;as&nbsp;an&nbsp;example&nbsp;only.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
https_port&nbsp;3129&nbsp;intercept&nbsp;cert=mycert.cert&nbsp;key=mykey.key&nbsp;ssl-bump&lt;br&gt;<br>
intercept&nbsp;generate-host-certificates=on &nbsp;version=1&lt;br&gt;<br>
options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE &nbsp;cafile=Intermediate.crt&lt;br&gt;<br>
&lt;br&gt;<br>
always_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
always_direct&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;SSL-Bump.&nbsp;It&nbsp;was&nbsp;a&nbsp;bug&nbsp;workaround&nbsp;needed&nbsp;only&nbsp;for&nbsp;a&nbsp;very&nbsp;few&nbsp;releases&nbsp;many&nbsp;years&nbsp;ago&nbsp;now.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&lt;br&gt;<br>
ssl_bump&nbsp;splice&nbsp;localhost&lt;br&gt;<br>
ssl_bump&nbsp;splice&nbsp;https&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
You&nbsp;are&nbsp;splicing&nbsp;traffic.&nbsp;This&nbsp;means&nbsp;there&nbsp;are&nbsp;no&nbsp;HTTPS&nbsp;messages&nbsp;interpreted&nbsp;by&nbsp;Squid.&nbsp;Thus&nbsp;no&nbsp;possibility&nbsp;of&nbsp;your&nbsp;URL-rewrite&nbsp;helper&nbsp;ever&nbsp;being&nbsp;even&nbsp;considered&nbsp;for&nbsp;use&nbsp;on&nbsp;them.&lt;br&gt;<br>
At&nbsp;best&nbsp;it&nbsp;might&nbsp;be&nbsp;considered&nbsp;for&nbsp;the&nbsp;CONNECT&nbsp;tunnel&nbsp;used&nbsp;by&nbsp;splice,&nbsp;but&nbsp;that&nbsp;means&nbsp;CONNECT&nbsp;URI&nbsp;has&nbsp;its&nbsp;domain&nbsp;set,&nbsp;the&nbsp;dstdomain&nbsp;would&nbsp;match&nbsp;and&nbsp;&quot;!http&quot;&nbsp;comes&nbsp;into&nbsp;affect&nbsp;to&nbsp;prevent&nbsp;it&nbsp;being&nbsp;asked.&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
ssl_bump&nbsp;peek&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
coredump_dir&nbsp;/var/cache/squid&lt;br&gt;<br>
&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;any&nbsp;idea&nbsp;why&nbsp;no&nbsp;https&nbsp;urls&nbsp;are&nbsp;being&nbsp;redirected&nbsp;to&nbsp;the&nbsp;url_rewrite&lt;br&gt;<br>
program?&lt;br&gt;<br>
Any&nbsp;alternative&nbsp;solution&nbsp;is&nbsp;also&nbsp;very&nbsp;much&nbsp;welcome&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
1)&nbsp;If&nbsp;you&nbsp;really&nbsp;meant&nbsp;to&nbsp;detect&nbsp;HTTP&nbsp;vs&nbsp;HTTPS&nbsp;traffic.&nbsp;Use&nbsp;the&nbsp;proper&nbsp;ACL&nbsp;definitions:&lt;br&gt;<br>
 &nbsp;acl&nbsp;HTTP&nbsp;proto&nbsp;HTTP&lt;br&gt;<br>
 &nbsp;acl&nbsp;HTTPS&nbsp;proto&nbsp;HTTPS&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
2)&nbsp;Most&nbsp;rewriters&nbsp;cannot&nbsp;correctly&nbsp;handle&nbsp;the&nbsp;URI&nbsp;type&nbsp;used&nbsp;on&nbsp;CONNECT&nbsp;tunnels,&nbsp;and&nbsp;more&nbsp;importantly&nbsp;are&nbsp;not&nbsp;able&nbsp;to&nbsp;safely&nbsp;decide&nbsp;where&nbsp;to&nbsp;redirect&nbsp;to&nbsp;even&nbsp;if&nbsp;they&nbsp;could&nbsp;produce&nbsp;the&nbsp;right&nbsp;URI&nbsp;output.&lt;br&gt;<br>
&lt;br&gt;<br>
So,&nbsp;normal&nbsp;installations&nbsp;should&nbsp;block&nbsp;requests&nbsp;to&nbsp;your&nbsp;re-writer&nbsp;by&nbsp;using&nbsp;the&nbsp;available&nbsp;&quot;CONNECT&quot;&nbsp;ACL&nbsp;like&nbsp;so:&lt;br&gt;<br>
 url_rewrite_access&nbsp;deny&nbsp;CONNECT&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;if&nbsp;your&nbsp;rewriter&nbsp;is&nbsp;an&nbsp;exception&nbsp;and&nbsp;can&nbsp;actually&nbsp;divert&nbsp;whole&nbsp;tunnels&nbsp;correctly&nbsp;(or&nbsp;knows&nbsp;corectly&nbsp;to&nbsp;return&nbsp;&quot;ERR&quot;&nbsp;and&nbsp;skip&nbsp;re-writing).&nbsp;Then&nbsp;use&nbsp;the&nbsp;method&nbsp;field&nbsp;it&nbsp;receives&nbsp;from&nbsp;Squid&nbsp;to&nbsp;have&nbsp;it&nbsp;decide&nbsp;what&nbsp;to&nbsp;do.&lt;br&gt;<br>
&lt;br&gt;<br>
3)&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;rewrite&nbsp;or&nbsp;redirect&nbsp;https://&nbsp;URLs&nbsp;...&nbsp;in&nbsp;other&nbsp;words&nbsp;modifying&nbsp;the&nbsp;HTTPS&nbsp;messages&nbsp;inside&nbsp;the&nbsp;crypto.&lt;br&gt;<br>
&lt;br&gt;<br>
That&nbsp;requires&nbsp;&quot;ssl_bump&nbsp;bump&quot;&nbsp;action&nbsp;to&nbsp;be&nbsp;configured&nbsp;and&nbsp;the&nbsp;traffic&nbsp;decrypted.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
