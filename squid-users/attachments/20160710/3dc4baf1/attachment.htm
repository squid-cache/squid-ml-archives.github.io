<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Amos,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;I&nbsp;really&nbsp;learnt&nbsp;alot&nbsp;from&nbsp;your&nbsp;previous&nbsp;email.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;going&nbsp;on..&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Jul&nbsp;8,&nbsp;2016&nbsp;at&nbsp;1:18&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&gt;On&nbsp;8/07/2016&nbsp;10:20&nbsp;p.m.,&nbsp;Moataz&nbsp;Elmasry&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;Amos,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Do&nbsp;you&nbsp;know&nbsp;any&nbsp;of&nbsp;those&nbsp;&#39;exceptional&#39;&nbsp;redirectors&nbsp;that&nbsp;can&nbsp;handle&nbsp;https?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;know&nbsp;they&nbsp;exist,&nbsp;some&nbsp;of&nbsp;my&nbsp;clients&nbsp;wrote&nbsp;and&nbsp;use&nbsp;some.&nbsp;But&nbsp;I&nbsp;can&#39;t&lt;br&gt;<br>
point&nbsp;you&nbsp;to&nbsp;any&nbsp;if&nbsp;thats&nbsp;what&nbsp;you&nbsp;are&nbsp;asking.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;can&nbsp;say&nbsp;though&nbsp;there&nbsp;r&nbsp;two&nbsp;things&nbsp;that&nbsp;can&nbsp;reliably&nbsp;be&nbsp;done&nbsp;with&nbsp;a&lt;br&gt;<br>
CONNECT&nbsp;request&nbsp;by&nbsp;a&nbsp;URL-rewriter;&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;return&nbsp;ERR,&nbsp;explicitly&nbsp;telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;re-write&nbsp;those&nbsp;tunnels.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;trades&nbsp;helper&nbsp;complexity&nbsp;for&nbsp;simpler&nbsp;squid.conf&nbsp;ACLs.&nbsp;Both&nbsp;simply&lt;br&gt;<br>
telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;re-write.&lt;br&gt;<br>
&lt;br&gt;<br>
2)&nbsp;re-write&nbsp;the&nbsp;URI&nbsp;from&nbsp;domain:port&nbsp;to&nbsp;be&nbsp;IP:port.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;Funny&nbsp;thing&nbsp;is&nbsp;when&nbsp;I&#39;m&nbsp;getting&nbsp;the&nbsp;URL&nbsp;in&nbsp;the&nbsp;redirect.bash,&nbsp;I&#39;m&nbsp;not&nbsp;getting&nbsp;an&nbsp;IP.&nbsp;I&nbsp;probed&nbsp;and&nbsp;logged&nbsp;in&nbsp;many&nbsp;fields&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;logformat&nbsp;page,&nbsp;and&nbsp;I&nbsp;usually&nbsp;get&nbsp;either&nbsp;the&nbsp;IP&nbsp;or&nbsp;the&nbsp;DNS&nbsp;inside&nbsp;redirect.bash&nbsp;but&nbsp;not&nbsp;both&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
If&nbsp;the&nbsp;IP&nbsp;it&nbsp;gets&nbsp;re-written&nbsp;to&nbsp;is&nbsp;the&nbsp;one&nbsp;the&nbsp;client&nbsp;was&nbsp;going&nbsp;to,&nbsp;this&lt;br&gt;<br>
is&nbsp;in&nbsp;effect&nbsp;telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;do&nbsp;DNS&nbsp;lookup&nbsp;when&nbsp;figuring&nbsp;out&nbsp;where&lt;br&gt;<br>
to&nbsp;send&nbsp;it.&nbsp;That&nbsp;can&nbsp;be&nbsp;useful&nbsp;when&nbsp;you&nbsp;don&#39;t&nbsp;want&nbsp;Squid&nbsp;to&nbsp;use&lt;br&gt;<br>
alternative&nbsp;IPs&nbsp;it&nbsp;might&nbsp;find&nbsp;via&nbsp;DNS.&lt;br&gt;<br>
 (NP:&nbsp;This&nbsp;wont&nbsp;affect&nbsp;the&nbsp;host&nbsp;verify&nbsp;checking&nbsp;as&nbsp;it&nbsp;happens&nbsp;too&nbsp;late.&lt;br&gt;<br>
This&nbsp;is&nbsp;actually&nbsp;just&nbsp;a&nbsp;fancy&nbsp;way&nbsp;to&nbsp;enforce&nbsp;the&nbsp;ORIGINAL_DST&nbsp;pass-thru&lt;br&gt;<br>
behaviour&nbsp;based&nbsp;on&nbsp;more&nbsp;complex&nbsp;things&nbsp;than&nbsp;host-verify&nbsp;detects)&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Ok.&nbsp;So&nbsp;let&#39;s&nbsp;ignore&nbsp;the&nbsp;redirection&nbsp;for&nbsp;now&nbsp;and&nbsp;just&nbsp;try&nbsp;to&nbsp;whitelist&nbsp;some&lt;br&gt;<br>
&gt;&nbsp;https&nbsp;urls&nbsp;and&nbsp;deny&nbsp;anything&nbsp;else.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Now&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;peek&nbsp;and&nbsp;bump&nbsp;the&nbsp;connection,&nbsp;just&nbsp;to&nbsp;obtain&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;servername&nbsp;without&nbsp;causing&nbsp;much&nbsp;harm,&nbsp;but&nbsp;the&nbsp;https&nbsp;sites&nbsp;are&nbsp;now&nbsp;either&lt;br&gt;<br>
&gt;&nbsp;loading&nbsp;infinitely,&nbsp;or&nbsp;loading&nbsp;successfully,&nbsp;where&nbsp;they&nbsp;should&nbsp;have&nbsp;been&lt;br&gt;<br>
&gt;&nbsp;blacklisted,&nbsp;assuming&nbsp;the&nbsp;https&nbsp;unwrapping&nbsp;happened&nbsp;successfully.&nbsp;Could&nbsp;you&lt;br&gt;<br>
&gt;&nbsp;please&nbsp;have&nbsp;a&nbsp;look&nbsp;and&nbsp;tell&nbsp;me&nbsp;what&#39;s&nbsp;wrong&nbsp;with&nbsp;the&nbsp;following&lt;br&gt;<br>
&gt;&nbsp;configuration?&nbsp;BTW&nbsp;after&nbsp;playing&nbsp;with&nbsp;ssl_bump&nbsp;I&nbsp;realized&nbsp;that&nbsp;I&nbsp;didn&#39;t&lt;br&gt;<br>
&gt;&nbsp;really&nbsp;understand&nbsp;the&nbsp;steps(1,2,3)&nbsp;as&nbsp;well&nbsp;as&nbsp;when&nbsp;to&nbsp;peek/bump/stare&lt;br&gt;<br>
&gt;&nbsp;etc...&nbsp;.&nbsp;The&nbsp;squid.conf&nbsp;contains&nbsp;some&nbsp;comments&nbsp;and&nbsp;questions&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;squid.conf&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;http_sites&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;https_sites&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;#match&nbsp;any&nbsp;url&nbsp;where&nbsp;the&nbsp;servername&nbsp;in&nbsp;the&nbsp;SNI&nbsp;is&nbsp;not&nbsp;empty&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;haveServerName&nbsp;ssl::server_name_regex&nbsp;.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;http_sites&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;https_sites&nbsp;#My&nbsp;expectation&nbsp;is&nbsp;that&nbsp;this&nbsp;rule&nbsp;is&nbsp;matched&lt;br&gt;<br>
&gt;&nbsp;when&nbsp;the&nbsp;https&nbsp;connection&nbsp;has&nbsp;been&nbsp;unwrapped&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;On&nbsp;HTTP&nbsp;traffic&nbsp;the&nbsp;&quot;http_sites&quot;&nbsp;ACL&nbsp;will&nbsp;match&nbsp;the&nbsp;URL&nbsp;domain.&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;HTTPS&nbsp;traffic&nbsp;without&nbsp;(or&nbsp;before&nbsp;finding)&nbsp;the&nbsp;SNI&nbsp;neither&nbsp;ACL&nbsp;will&lt;br&gt;<br>
match.&nbsp;Because&nbsp;URL&nbsp;is&nbsp;a&nbsp;raw-IP&nbsp;at&nbsp;that&nbsp;stage.&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;HTTPS&nbsp;traffic&nbsp;with&nbsp;SNI&nbsp;the&nbsp;&quot;http_sites&quot;&nbsp;ACL&nbsp;will&nbsp;match.&nbsp;Because&nbsp;the&lt;br&gt;<br>
SNI&nbsp;got&nbsp;copied&nbsp;to&nbsp;the&nbsp;request&nbsp;URI.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;&quot;https_sites&quot;&nbsp;ACL&nbsp;will&nbsp;only&nbsp;be&nbsp;reached&nbsp;on&nbsp;traffic&nbsp;where&nbsp;the&nbsp;SNI&nbsp;does&lt;br&gt;<br>
*not*&nbsp;contain&nbsp;the&nbsp;values&nbsp;its&nbsp;looking&nbsp;for.&nbsp;This&nbsp;test&nbsp;will&nbsp;always&nbsp;be&nbsp;a&lt;br&gt;<br>
non-match&nbsp;/&nbsp;false.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;Ouch,&nbsp;I&nbsp;now&nbsp;see&nbsp;in&nbsp;the&nbsp;docs&nbsp;that&nbsp;ssl::server_name&nbsp;is&nbsp;suitable&nbsp;for&nbsp;usage&nbsp;within&nbsp;ssl_bump.&nbsp;So&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;use&nbsp;case&nbsp;I&nbsp;suppose.&nbsp; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3127&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;https_port&nbsp;3129&nbsp;cert=/etc/squid/ssl/example.com.cert&lt;br&gt;<br>
&gt;&nbsp;key=/etc/squid/ssl/example.com.private&nbsp;ssl-bump&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;generate-host-certificates=on &nbsp;version=1&lt;br&gt;<br>
&gt;&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp;capath=/etc/ssl/certs/&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslproxy_cert_error&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1 &nbsp;#Is&nbsp;this&nbsp;equivelant&nbsp;to&nbsp;&quot;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&nbsp;???&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Yes.&nbsp;&quot;all&quot;&nbsp;is&nbsp;a&nbsp;test&nbsp;that&nbsp;always&nbsp;produces&nbsp;match&nbsp;/&nbsp;true.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;&quot;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&quot;&nbsp;means:&lt;br&gt;<br>
 If&nbsp;(at_step&nbsp;==&nbsp;SslBump1&nbsp;and&nbsp;true&nbsp;==&nbsp;true)&nbsp;then&nbsp;do&nbsp;peeking.&lt;br&gt;<br>
 else&nbsp;...&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;haveServerName&nbsp;!https_sites&lt;br&gt;<br>
&gt;&nbsp;#What&nbsp;about&nbsp;connections&nbsp;that&nbsp;didn&#39;t&nbsp;provide&nbsp;sni&nbsp;yet?&nbsp;Do&nbsp;they&nbsp;get&nbsp;to&nbsp;have&lt;br&gt;<br>
&gt;&nbsp;own&nbsp;definition&nbsp;for&nbsp;step2?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;For&nbsp;those:&lt;br&gt;<br>
&lt;br&gt;<br>
 &quot;haveServerName&quot;&nbsp;being&nbsp;a&nbsp;regex&nbsp;&quot;.&quot;&nbsp;pattern&nbsp;will&nbsp;match&nbsp;the&nbsp;raw-IP&nbsp;in&nbsp;the&lt;br&gt;<br>
CONNECT&nbsp;request,&nbsp;the&nbsp;SNI&nbsp;value,&nbsp;or&nbsp;any&nbsp;subjectAltName&nbsp;in&nbsp;the&nbsp;server&lt;br&gt;<br>
certificate.&nbsp;One&nbsp;of&nbsp;those&nbsp;three&nbsp;will&nbsp;always&nbsp;exist&nbsp;and&nbsp;have&nbsp;a&nbsp;value&nbsp;that&lt;br&gt;<br>
&#39;.&#39;&nbsp;is&nbsp;matched&nbsp;against.&nbsp;Basically&nbsp;it&nbsp;can&#39;t&nbsp;fail&nbsp;-&nbsp;therefore&nbsp;you&nbsp;can&lt;br&gt;<br>
consider&nbsp;it&nbsp;just&nbsp;a&nbsp;complicated&nbsp;(and&nbsp;slow&nbsp;/&nbsp;CPU&nbsp;draining)&nbsp;way&nbsp;of&nbsp;checking&lt;br&gt;<br>
&quot;all&quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
AND&lt;br&gt;<br>
&lt;br&gt;<br>
 &quot;https_sites&quot;&nbsp;produces&nbsp;false.&nbsp;The&nbsp;&quot;!&quot;&nbsp;turns&nbsp;that&nbsp;false&nbsp;into&nbsp;true.&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;that&nbsp;line&nbsp;matches&nbsp;and&nbsp;&quot;bump&quot;&nbsp;action&nbsp;is&nbsp;done&nbsp;at&nbsp;step&nbsp;2.&lt;br&gt;<br>
&lt;br&gt;<br>
Bump&nbsp;being&nbsp;a&nbsp;final&nbsp;action&nbsp;means&nbsp;there&nbsp;is&nbsp;no&nbsp;step&nbsp;3&nbsp;for&nbsp;those&nbsp;requests.&lt;br&gt;<br>
&lt;br&gt;<br>
NOTE: &nbsp;Side&nbsp;effects&nbsp;of&nbsp;bump&nbsp;at&nbsp;step&nbsp;2&nbsp;(aka&nbsp;client-first&nbsp;bumping)&nbsp;is&nbsp;that&lt;br&gt;<br>
certificate&nbsp;Squid&nbsp;generates&nbsp;will&nbsp;be&nbsp;generated&nbsp;ONLY&nbsp;from&nbsp;squid.conf&lt;br&gt;<br>
settings&nbsp;and&nbsp;clientHello&nbsp;details.&lt;br&gt;<br>
 No&nbsp;server&nbsp;involvement,&nbsp;thus&nbsp;a&nbsp;very&nbsp;high&nbsp;chance&nbsp;that&nbsp;the&nbsp;server&nbsp;TLS&lt;br&gt;<br>
connection&nbsp;requirements&nbsp;and&nbsp;what&nbsp;Squid&nbsp;offers&nbsp;the&nbsp;client&nbsp;to&nbsp;use&nbsp;will&lt;br&gt;<br>
conflict&nbsp;or&nbsp;introduce&nbsp;downgrade&nbsp;attack&nbsp;vulnerabilities&nbsp;into&nbsp;these&lt;br&gt;<br>
connections.&lt;br&gt;<br>
&lt;br&gt;<br>
 Whether&nbsp;that&nbsp;is&nbsp;okay&nbsp;is&nbsp;a&nbsp;grey&nbsp;area&nbsp;with&nbsp;disagreement&nbsp;possibilities&nbsp;on&lt;br&gt;<br>
all&nbsp;sides.&lt;br&gt;<br>
 *&nbsp;On&nbsp;the&nbsp;one&nbsp;hand&nbsp;you&nbsp;are&nbsp;probably&nbsp;configuring&nbsp;good&nbsp;security&nbsp;for&nbsp;the&lt;br&gt;<br>
client&nbsp;connection&nbsp;even&nbsp;when&nbsp;the&nbsp;server&nbsp;connection&nbsp;has&nbsp;worse&nbsp;TLS.&lt;br&gt;<br>
 *&nbsp;On&nbsp;the&nbsp;two&nbsp;hand&nbsp;you&nbsp;are&nbsp;potentially&nbsp;configuring&nbsp;something&nbsp;worse&nbsp;than&lt;br&gt;<br>
some&nbsp;servers.&lt;br&gt;<br>
 *&nbsp;On&nbsp;the&nbsp;third&nbsp;hand&nbsp;you&nbsp;are&nbsp;definitely&nbsp;fooling&nbsp;the&nbsp;client&nbsp;into&nbsp;thinking&lt;br&gt;<br>
it&nbsp;has&nbsp;different&nbsp;security&nbsp;level&nbsp;than&nbsp;the&nbsp;server&nbsp;connection&nbsp;can&nbsp;provide,&lt;br&gt;<br>
or&nbsp;vice-versa&nbsp;for&nbsp;the&nbsp;server&nbsp;knowledge&nbsp;about&nbsp;the&nbsp;client&nbsp;connection.&nbsp;Its&lt;br&gt;<br>
risky,&nbsp;and&nbsp;you&nbsp;can&nbsp;expect&nbsp;problems.&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;#Is&nbsp;this&nbsp;equivelant&nbsp;to&nbsp;&quot;ssl_bump &nbsp;bump&nbsp;step2&nbsp;haveServerName&nbsp;!https_sites&quot;&nbsp;??&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Yes&nbsp;it&nbsp;is.&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&gt;&nbsp;#Can&nbsp;I&nbsp;use&nbsp;step2&nbsp;with&nbsp;some&nbsp;other&nbsp;acl?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Er.&nbsp;You&nbsp;can&nbsp;use&nbsp;any&nbsp;ACL&nbsp;that&nbsp;has&nbsp;available&nbsp;data&nbsp;for&nbsp;the&nbsp;time&nbsp;and&lt;br&gt;<br>
position&nbsp;at&nbsp;which&nbsp;it&nbsp;is&nbsp;tested.&lt;br&gt;<br>
 In&nbsp;other&nbsp;words&nbsp;I&nbsp;would&nbsp;not&nbsp;suggest&nbsp;using&nbsp;ACLs&nbsp;that&nbsp;check&nbsp;HTTP&nbsp;response&lt;br&gt;<br>
headers&nbsp;at&nbsp;the&nbsp;ssl_bump&nbsp;checking&nbsp;time.&lt;br&gt;<br>
&lt;br&gt;<br>
At&nbsp;step&nbsp;2&nbsp;of&nbsp;SSL-Bumping&nbsp;process&nbsp;you&nbsp;have&nbsp;client&nbsp;TCP&nbsp;connection&nbsp;details,&lt;br&gt;<br>
TLS&nbsp;clientHello&nbsp;details&nbsp;and&nbsp;initial&nbsp;extensions&nbsp;like&nbsp;SNI&nbsp;(well&nbsp;the&nbsp;ones&lt;br&gt;<br>
that&nbsp;have&nbsp;been&nbsp;implemented&nbsp;-&nbsp;SNI&nbsp;being&nbsp;the&nbsp;only&nbsp;useful&nbsp;one&nbsp;AFAIK).&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;#Is&nbsp;this&nbsp;now&nbsp;step3&nbsp;for&nbsp;all?what&nbsp;about&nbsp;those&nbsp;urls&nbsp;who&nbsp;didn&#39;t&nbsp;have&nbsp;a&nbsp;match&nbsp;in&lt;br&gt;<br>
&gt;&nbsp;step2.&nbsp;Is&nbsp;this&nbsp;step2&nbsp;for&nbsp;some&nbsp;and&nbsp;step3&nbsp;for&nbsp;others?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Any&nbsp;step2&nbsp;traffic&nbsp;which&nbsp;fails&nbsp;the&nbsp;&quot;!https_sites&quot;&nbsp;test&nbsp;will&nbsp;match&nbsp;this.&lt;br&gt;<br>
Which&nbsp;means&nbsp;there&nbsp;is&nbsp;no&nbsp;step3&nbsp;for&nbsp;those&nbsp;requests.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;have&nbsp;been&nbsp;paying&nbsp;attention&nbsp;you&nbsp;will&nbsp;have&nbsp;noticed&nbsp;that&nbsp;all&nbsp;traffic&lt;br&gt;<br>
passing&nbsp;the&nbsp;&quot;!https_sites&quot;&nbsp;has&nbsp;been&nbsp;bumped,&nbsp;and&nbsp;all&nbsp;traffic&nbsp;failing&nbsp;that&lt;br&gt;<br>
same&nbsp;test&nbsp;has&nbsp;been&nbsp;spliced.&lt;br&gt;<br>
&lt;br&gt;<br>
==&gt;&nbsp;Therefore,&nbsp;zero&nbsp;traffic&nbsp;reaches&nbsp;step&nbsp;3.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;Many&nbsp;thanks&nbsp;for&nbsp;the&nbsp;detailed&nbsp;clarification,&nbsp;this&nbsp;really&nbsp;helps&nbsp;ALOT!!!!&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
My&nbsp;advice&nbsp;on&nbsp;this&nbsp;as&nbsp;a&nbsp;general&nbsp;rule-of-thumb&nbsp;is&nbsp;to&nbsp;splice&nbsp;at&nbsp;step&nbsp;1&nbsp;or&nbsp;2&lt;br&gt;<br>
if&nbsp;you&nbsp;can.&nbsp;That&nbsp;solves&nbsp;a&nbsp;lot&nbsp;of&nbsp;possible&nbsp;problems&nbsp;with&nbsp;the&nbsp;splicing.&lt;br&gt;<br>
And&nbsp;to&nbsp;bump&nbsp;only&nbsp;at&nbsp;step&nbsp;3&nbsp;where&nbsp;the&nbsp;mimic&nbsp;feature&nbsp;can&nbsp;avoid&nbsp;a&nbsp;lot&nbsp;of&lt;br&gt;<br>
other&nbsp;problems&nbsp;with&nbsp;the&nbsp;bumping.&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;will&nbsp;still&nbsp;encounter&nbsp;some&nbsp;problems&nbsp;though&nbsp;(guaranteed).&nbsp;Don&#39;t&nbsp;forget&lt;br&gt;<br>
that&nbsp;TLS&nbsp;is&nbsp;specifically&nbsp;designed&nbsp;to&nbsp;prevent&nbsp;&#39;bumping&#39;&nbsp;from&nbsp;being&nbsp;done&lt;br&gt;<br>
on&nbsp;its&nbsp;connections.&nbsp;The&nbsp;fact&nbsp;that&nbsp;we&nbsp;can&nbsp;offer&nbsp;the&nbsp;feature&nbsp;at&nbsp;all&nbsp;for&lt;br&gt;<br>
generic&nbsp;use&nbsp;is&nbsp;a&nbsp;terrible&nbsp;statement&nbsp;about&nbsp;the&nbsp;Internets&nbsp;bad&nbsp;lack&nbsp;of&lt;br&gt;<br>
security.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers.&lt;br&gt;<br>
&lt;span&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;Amos&lt;br&gt;<br>
&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ok.&nbsp;new&nbsp;try. &nbsp;The&nbsp;following&nbsp;are&nbsp;common&nbsp;configurations:&lt;/div&gt;&lt;div&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;http_sites&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt; &lt;/div&gt;&lt;div&gt;acl&nbsp;https_sites&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt; &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;http_sites&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;3127&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;intercept&lt;/div&gt;&lt;div&gt;https_port&nbsp;3129&nbsp;cert=/etc/squid/ssl/example.com.cert&nbsp;key=/etc/squid/ssl/example.com.private&nbsp;ssl-bump&nbsp;intercept&nbsp;generate-host-certificates=on&nbsp; version=1&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp;capath=/etc/ssl/certs/&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslproxy_cert_error&nbsp;allow&nbsp;all &lt;/div&gt;&lt;div&gt;sslproxy_flags&nbsp;DONT_VERIFY_PEER &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;url_rewrite_program&nbsp;/bin/bash&nbsp;-c&nbsp;-l&nbsp;/etc/squid/redirect.bash&lt;/div&gt;&lt;div&gt;url_rewrite_extras&nbsp;&quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;la=%la:%lp&nbsp;la2=%&lt;a/%&lt;a&nbsp; la3=%&lt;la:%&lt;lp&nbsp;%un&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp&nbsp; ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;ssl3=%ssl::&gt;cert_subject&nbsp;ssl4=%ssl::&gt;cert_issuer&nbsp; rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;/div&gt;&lt;div&gt;logformat&nbsp;squid&nbsp;&quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;la=%la:%lp&nbsp;la2=%&lt;a/%&lt;a&nbsp; la3=%&lt;la:%&lt;lp&nbsp; %un&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp&nbsp; ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;ssl3=%ssl::&gt;cert_subject&nbsp;ssl4=%ssl::&gt;cert_issuer&nbsp; rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;/div&gt;&lt;div&gt;url_rewrite_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Using &lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&quot;ssl_bump&nbsp;splice&nbsp;step1&nbsp;all&nbsp; &lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Nothing&nbsp;is&nbsp;blocked.&nbsp;And&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;any&nbsp;urls,&nbsp;nor&nbsp;sni&nbsp;info&nbsp;neither&nbsp;in&nbsp;access.log&nbsp;nor&nbsp;in&nbsp;my&nbsp;redirect.log.Only&nbsp;IPs. &nbsp;I&#39;m&nbsp;trying&nbsp;many&nbsp;https&nbsp;sites.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Using &lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&quot;ssl_bump&nbsp;splice&nbsp;step2&nbsp;all&nbsp; &lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Same&nbsp;result.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Using&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;ssl_bump&nbsp;splice&nbsp;step2&nbsp; all&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;I&nbsp;can&nbsp;see&nbsp;URLs&nbsp;in&nbsp;the&nbsp;access.log&nbsp;and&nbsp;redirect.log&nbsp;but&nbsp;no&nbsp;IP&#39;s.&nbsp;Further&nbsp;I&#39;m&nbsp;getting&nbsp;the&nbsp;header&nbsp;forgery&nbsp;warning&nbsp;in&nbsp;the&nbsp;logs,&nbsp;and&nbsp;all&nbsp;pages&nbsp;start&nbsp;loading,&nbsp;but&nbsp;never&nbsp;finish.&nbsp;Maybe&nbsp;this&nbsp;is&nbsp;something&nbsp;related&nbsp;to&nbsp;the&nbsp;nat&nbsp;rules&nbsp;in&nbsp;the&nbsp;iptables?&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;For&nbsp;info,&nbsp;I&#39;m&nbsp;using&nbsp;the&nbsp;simplest&nbsp;bash&nbsp;redirector&nbsp;for&nbsp;now.&nbsp;Here&#39;s&nbsp;the&nbsp;code&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;while&nbsp;true;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;do&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;read&nbsp;input;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;echo&nbsp;&quot;input=${input}&quot;&nbsp; &gt;&gt;/var/log/squid/redirects.log&nbsp;2&gt;&amp;1&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;old_url=$(echo&nbsp;${input}&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$1}&#39;)&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;echo&nbsp;&quot;${old_url}&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;[[&nbsp;$?&nbsp;!=&nbsp;0&nbsp;]]&nbsp;&amp;&amp;&nbsp;exit&nbsp;-1&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt; &nbsp; &nbsp;continue&lt;/div&gt;&lt;div&gt;done&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;I&#39;ll&nbsp;try&nbsp;squid4&nbsp;next&nbsp;week,&nbsp;maybe&nbsp;the&nbsp;result&nbsp;will&nbsp;be&nbsp;better&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Many&nbsp;thanks&nbsp;and&nbsp;cheers,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Moataz&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
