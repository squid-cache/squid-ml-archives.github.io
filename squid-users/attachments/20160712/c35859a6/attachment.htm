<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;Hi&nbsp;Amos,&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;kinda&nbsp;solved&nbsp;the&nbsp;problem&nbsp;(Thanks&nbsp;to&nbsp;you!!!)&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;All&nbsp;what&nbsp;was&nbsp;needed&nbsp;is&nbsp;to&nbsp;peek&nbsp;the&nbsp;important&nbsp;domains&nbsp;in&nbsp;step2&nbsp;in&nbsp;order&nbsp;not&nbsp;to&nbsp;cause&nbsp;them&nbsp;harm&nbsp;and&nbsp;bump&nbsp;everything&nbsp;else&nbsp;in&nbsp;step3.&nbsp;In&nbsp;this&nbsp;case&nbsp;I&#39;m&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;dns&nbsp;names&nbsp;in&nbsp;the&nbsp;redirect&nbsp;script&nbsp;and&nbsp;block&nbsp;them&nbsp;accordingly&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Here&nbsp;is&nbsp;the&nbsp;relevant&nbsp;part:&lt;/div&gt;&lt;span&nbsp;class=&quot;im&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;div&gt;acl&nbsp;http_sites&nbsp;dstdomain &lt;a&nbsp;href=&quot;http://play.google.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt; &lt;a&nbsp;href=&quot;http://mydomain.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;https_sites&nbsp;ssl::server_name &lt;a&nbsp;href=&quot;http://play.google.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt; &lt;a&nbsp;href=&quot;http://mydomain.com/&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step2&nbsp;https_sites&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&nbsp;!https_sites&nbsp;#http_sites&nbsp;won&#39;t&nbsp;be&nbsp;bumped&nbsp;anyway.&nbsp;But&nbsp;just&nbsp;to&nbsp;be&nbsp;sure&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;url_rewrite_access&nbsp;allow&nbsp;all&nbsp;!http_sites&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;Of&nbsp;course&nbsp;I&#39;m&nbsp;still&nbsp;not&nbsp;able&nbsp;to&nbsp;rewrite&nbsp;https&nbsp;address&nbsp;as&nbsp;discussed,&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;different&nbsp;story&nbsp;I&nbsp;guess.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;The&nbsp;SslPeekAndSplice&nbsp;wiki&nbsp;page&nbsp;needs&nbsp;serious&nbsp;rework&nbsp;though&nbsp;as&nbsp;many&nbsp;of&nbsp;the&nbsp;stuff&nbsp;discussed&nbsp;here&nbsp;are&nbsp;not&nbsp;explained&nbsp;on&nbsp;the&nbsp;page,&nbsp;which&nbsp;makes&nbsp;life&nbsp;really&nbsp;hard&nbsp;for&nbsp;noobs&nbsp;like&nbsp;me.&nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;contribute&nbsp;back&nbsp;a&nbsp;little&nbsp;bit&nbsp;by&nbsp;reworking&nbsp;that&nbsp;wiki&nbsp;page?&nbsp;I&#39;ll&nbsp;try&nbsp;to&nbsp;write&nbsp;a&nbsp;small&nbsp;post&nbsp;about&nbsp;the SslPeekAndSplice&nbsp;in&nbsp;the&nbsp;next&nbsp;few&nbsp;days.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;Many&nbsp;Thanks&nbsp;again&nbsp;for&nbsp;the&nbsp;great&nbsp;help.&nbsp;Really&nbsp;appreciate&nbsp;it&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;Cheers,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&nbsp;style=&quot;font-size:12.8px&quot;&gt;Moataz&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jul&nbsp;10,&nbsp;2016&nbsp;at&nbsp;10:42&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;10/07/2016&nbsp;8:13&nbsp;p.m.,&nbsp;Moataz&nbsp;Elmasry&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;Amos,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Thanks&nbsp;I&nbsp;really&nbsp;learnt&nbsp;alot&nbsp;from&nbsp;your&nbsp;previous&nbsp;email.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;going&nbsp;on..&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Fri,&nbsp;Jul&nbsp;8,&nbsp;2016&nbsp;at&nbsp;1:18&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;8/07/2016&nbsp;10:20&nbsp;p.m.,&nbsp;Moataz&nbsp;Elmasry&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Hi&nbsp;Amos,&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Do&nbsp;you&nbsp;know&nbsp;any&nbsp;of&nbsp;those&nbsp;&#39;exceptional&#39;&nbsp;redirectors&nbsp;that&nbsp;can&nbsp;handle&nbsp;https?&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&nbsp;know&nbsp;they&nbsp;exist,&nbsp;some&nbsp;of&nbsp;my&nbsp;clients&nbsp;wrote&nbsp;and&nbsp;use&nbsp;some.&nbsp;But&nbsp;I&nbsp;can&#39;t&lt;br&gt;<br>
&gt;&gt;&nbsp;point&nbsp;you&nbsp;to&nbsp;any&nbsp;if&nbsp;thats&nbsp;what&nbsp;you&nbsp;are&nbsp;asking.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&nbsp;can&nbsp;say&nbsp;though&nbsp;there&nbsp;r&nbsp;two&nbsp;things&nbsp;that&nbsp;can&nbsp;reliably&nbsp;be&nbsp;done&nbsp;with&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;CONNECT&nbsp;request&nbsp;by&nbsp;a&nbsp;URL-rewriter;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;1)&nbsp;return&nbsp;ERR,&nbsp;explicitly&nbsp;telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;re-write&nbsp;those&nbsp;tunnels.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;This&nbsp;trades&nbsp;helper&nbsp;complexity&nbsp;for&nbsp;simpler&nbsp;squid.conf&nbsp;ACLs.&nbsp;Both&nbsp;simply&lt;br&gt;<br>
&gt;&gt;&nbsp;telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;re-write.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;2)&nbsp;re-write&nbsp;the&nbsp;URI&nbsp;from&nbsp;domain:port&nbsp;to&nbsp;be&nbsp;IP:port.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;Funny&nbsp;thing&nbsp;is&nbsp;when&nbsp;I&#39;m&nbsp;getting&nbsp;the&nbsp;URL&nbsp;in&nbsp;the&nbsp;redirect.bash,&nbsp;I&#39;m&nbsp;not&lt;br&gt;<br>
&gt;&nbsp;getting&nbsp;an&nbsp;IP.&nbsp;I&nbsp;probed&nbsp;and&nbsp;logged&nbsp;in&nbsp;many&nbsp;fields&nbsp;as&nbsp;described&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;logformat&nbsp;page,&nbsp;and&nbsp;I&nbsp;usually&nbsp;get&nbsp;either&nbsp;the&nbsp;IP&nbsp;or&nbsp;the&nbsp;DNS&nbsp;inside&lt;br&gt;<br>
&gt;&nbsp;redirect.bash&nbsp;but&nbsp;not&nbsp;both&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;If&nbsp;the&nbsp;IP&nbsp;it&nbsp;gets&nbsp;re-written&nbsp;to&nbsp;is&nbsp;the&nbsp;one&nbsp;the&nbsp;client&nbsp;was&nbsp;going&nbsp;to,&nbsp;this&lt;br&gt;<br>
&gt;&gt;&nbsp;is&nbsp;in&nbsp;effect&nbsp;telling&nbsp;Squid&nbsp;not&nbsp;to&nbsp;do&nbsp;DNS&nbsp;lookup&nbsp;when&nbsp;figuring&nbsp;out&nbsp;where&lt;br&gt;<br>
&gt;&gt;&nbsp;to&nbsp;send&nbsp;it.&nbsp;That&nbsp;can&nbsp;be&nbsp;useful&nbsp;when&nbsp;you&nbsp;don&#39;t&nbsp;want&nbsp;Squid&nbsp;to&nbsp;use&lt;br&gt;<br>
&gt;&gt;&nbsp;alternative&nbsp;IPs&nbsp;it&nbsp;might&nbsp;find&nbsp;via&nbsp;DNS.&lt;br&gt;<br>
&gt;&gt; &nbsp;(NP:&nbsp;This&nbsp;wont&nbsp;affect&nbsp;the&nbsp;host&nbsp;verify&nbsp;checking&nbsp;as&nbsp;it&nbsp;happens&nbsp;too&nbsp;late.&lt;br&gt;<br>
&gt;&gt;&nbsp;This&nbsp;is&nbsp;actually&nbsp;just&nbsp;a&nbsp;fancy&nbsp;way&nbsp;to&nbsp;enforce&nbsp;the&nbsp;ORIGINAL_DST&nbsp;pass-thru&lt;br&gt;<br>
&gt;&gt;&nbsp;behaviour&nbsp;based&nbsp;on&nbsp;more&nbsp;complex&nbsp;things&nbsp;than&nbsp;host-verify&nbsp;detects)&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Ok.&nbsp;So&nbsp;let&#39;s&nbsp;ignore&nbsp;the&nbsp;redirection&nbsp;for&nbsp;now&nbsp;and&nbsp;just&nbsp;try&nbsp;to&nbsp;whitelist&lt;br&gt;<br>
&gt;&gt;&nbsp;some&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;https&nbsp;urls&nbsp;and&nbsp;deny&nbsp;anything&nbsp;else.&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Now&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;peek&nbsp;and&nbsp;bump&nbsp;the&nbsp;connection,&nbsp;just&nbsp;to&nbsp;obtain&nbsp;the&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;servername&nbsp;without&nbsp;causing&nbsp;much&nbsp;harm,&nbsp;but&nbsp;the&nbsp;https&nbsp;sites&nbsp;are&nbsp;now&nbsp;either&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;loading&nbsp;infinitely,&nbsp;or&nbsp;loading&nbsp;successfully,&nbsp;where&nbsp;they&nbsp;should&nbsp;have&nbsp;been&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;blacklisted,&nbsp;assuming&nbsp;the&nbsp;https&nbsp;unwrapping&nbsp;happened&nbsp;successfully.&nbsp;Could&lt;br&gt;<br>
&gt;&gt;&nbsp;you&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;please&nbsp;have&nbsp;a&nbsp;look&nbsp;and&nbsp;tell&nbsp;me&nbsp;what&#39;s&nbsp;wrong&nbsp;with&nbsp;the&nbsp;following&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;configuration?&nbsp;BTW&nbsp;after&nbsp;playing&nbsp;with&nbsp;ssl_bump&nbsp;I&nbsp;realized&nbsp;that&nbsp;I&nbsp;didn&#39;t&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;really&nbsp;understand&nbsp;the&nbsp;steps(1,2,3)&nbsp;as&nbsp;well&nbsp;as&nbsp;when&nbsp;to&nbsp;peek/bump/stare&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;etc...&nbsp;.&nbsp;The&nbsp;squid.conf&nbsp;contains&nbsp;some&nbsp;comments&nbsp;and&nbsp;questions&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;squid.conf&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;http_sites&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;https_sites&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;#match&nbsp;any&nbsp;url&nbsp;where&nbsp;the&nbsp;servername&nbsp;in&nbsp;the&nbsp;SNI&nbsp;is&nbsp;not&nbsp;empty&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;haveServerName&nbsp;ssl::server_name_regex&nbsp;.&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;http_sites&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;http_access&nbsp;allow&nbsp;https_sites&nbsp;#My&nbsp;expectation&nbsp;is&nbsp;that&nbsp;this&nbsp;rule&nbsp;is&lt;br&gt;<br>
&gt;&gt;&nbsp;matched&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;when&nbsp;the&nbsp;https&nbsp;connection&nbsp;has&nbsp;been&nbsp;unwrapped&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;HTTP&nbsp;traffic&nbsp;the&nbsp;&quot;http_sites&quot;&nbsp;ACL&nbsp;will&nbsp;match&nbsp;the&nbsp;URL&nbsp;domain.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;HTTPS&nbsp;traffic&nbsp;without&nbsp;(or&nbsp;before&nbsp;finding)&nbsp;the&nbsp;SNI&nbsp;neither&nbsp;ACL&nbsp;will&lt;br&gt;<br>
&gt;&gt;&nbsp;match.&nbsp;Because&nbsp;URL&nbsp;is&nbsp;a&nbsp;raw-IP&nbsp;at&nbsp;that&nbsp;stage.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;HTTPS&nbsp;traffic&nbsp;with&nbsp;SNI&nbsp;the&nbsp;&quot;http_sites&quot;&nbsp;ACL&nbsp;will&nbsp;match.&nbsp;Because&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;SNI&nbsp;got&nbsp;copied&nbsp;to&nbsp;the&nbsp;request&nbsp;URI.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;&quot;https_sites&quot;&nbsp;ACL&nbsp;will&nbsp;only&nbsp;be&nbsp;reached&nbsp;on&nbsp;traffic&nbsp;where&nbsp;the&nbsp;SNI&nbsp;does&lt;br&gt;<br>
&gt;&gt;&nbsp;*not*&nbsp;contain&nbsp;the&nbsp;values&nbsp;its&nbsp;looking&nbsp;for.&nbsp;This&nbsp;test&nbsp;will&nbsp;always&nbsp;be&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;non-match&nbsp;/&nbsp;false.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;Ouch,&nbsp;I&nbsp;now&nbsp;see&nbsp;in&nbsp;the&nbsp;docs&nbsp;that&nbsp;ssl::server_name&nbsp;is&nbsp;suitable&nbsp;for&nbsp;usage&lt;br&gt;<br>
&gt;&nbsp;within&nbsp;ssl_bump.&nbsp;So&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;use&nbsp;case&nbsp;I&nbsp;suppose.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;http_port&nbsp;3127&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;http_port&nbsp;3128&nbsp;intercept&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;https_port&nbsp;3129&nbsp;cert=/etc/squid/ssl/example.com.cert&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;key=/etc/squid/ssl/example.com.private&nbsp;ssl-bump&nbsp;intercept&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;generate-host-certificates=on &nbsp;version=1&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp;capath=/etc/ssl/certs/&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;sslproxy_cert_error&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1 &nbsp;#Is&nbsp;this&nbsp;equivelant&nbsp;to&nbsp;&quot;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&nbsp;???&quot;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Yes.&nbsp;&quot;all&quot;&nbsp;is&nbsp;a&nbsp;test&nbsp;that&nbsp;always&nbsp;produces&nbsp;match&nbsp;/&nbsp;true.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;&quot;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&quot;&nbsp;means:&lt;br&gt;<br>
&gt;&gt; &nbsp;If&nbsp;(at_step&nbsp;==&nbsp;SslBump1&nbsp;and&nbsp;true&nbsp;==&nbsp;true)&nbsp;then&nbsp;do&nbsp;peeking.&lt;br&gt;<br>
&gt;&gt; &nbsp;else&nbsp;...&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;haveServerName&nbsp;!https_sites&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;#What&nbsp;about&nbsp;connections&nbsp;that&nbsp;didn&#39;t&nbsp;provide&nbsp;sni&nbsp;yet?&nbsp;Do&nbsp;they&nbsp;get&nbsp;to&nbsp;have&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;own&nbsp;definition&nbsp;for&nbsp;step2?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;For&nbsp;those:&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt; &nbsp;&quot;haveServerName&quot;&nbsp;being&nbsp;a&nbsp;regex&nbsp;&quot;.&quot;&nbsp;pattern&nbsp;will&nbsp;match&nbsp;the&nbsp;raw-IP&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;CONNECT&nbsp;request,&nbsp;the&nbsp;SNI&nbsp;value,&nbsp;or&nbsp;any&nbsp;subjectAltName&nbsp;in&nbsp;the&nbsp;server&lt;br&gt;<br>
&gt;&gt;&nbsp;certificate.&nbsp;One&nbsp;of&nbsp;those&nbsp;three&nbsp;will&nbsp;always&nbsp;exist&nbsp;and&nbsp;have&nbsp;a&nbsp;value&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;&#39;.&#39;&nbsp;is&nbsp;matched&nbsp;against.&nbsp;Basically&nbsp;it&nbsp;can&#39;t&nbsp;fail&nbsp;-&nbsp;therefore&nbsp;you&nbsp;can&lt;br&gt;<br>
&gt;&gt;&nbsp;consider&nbsp;it&nbsp;just&nbsp;a&nbsp;complicated&nbsp;(and&nbsp;slow&nbsp;/&nbsp;CPU&nbsp;draining)&nbsp;way&nbsp;of&nbsp;checking&lt;br&gt;<br>
&gt;&gt;&nbsp;&quot;all&quot;.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;AND&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt; &nbsp;&quot;https_sites&quot;&nbsp;produces&nbsp;false.&nbsp;The&nbsp;&quot;!&quot;&nbsp;turns&nbsp;that&nbsp;false&nbsp;into&nbsp;true.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;So&nbsp;that&nbsp;line&nbsp;matches&nbsp;and&nbsp;&quot;bump&quot;&nbsp;action&nbsp;is&nbsp;done&nbsp;at&nbsp;step&nbsp;2.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Bump&nbsp;being&nbsp;a&nbsp;final&nbsp;action&nbsp;means&nbsp;there&nbsp;is&nbsp;no&nbsp;step&nbsp;3&nbsp;for&nbsp;those&nbsp;requests.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;NOTE: &nbsp;Side&nbsp;effects&nbsp;of&nbsp;bump&nbsp;at&nbsp;step&nbsp;2&nbsp;(aka&nbsp;client-first&nbsp;bumping)&nbsp;is&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;certificate&nbsp;Squid&nbsp;generates&nbsp;will&nbsp;be&nbsp;generated&nbsp;ONLY&nbsp;from&nbsp;squid.conf&lt;br&gt;<br>
&gt;&gt;&nbsp;settings&nbsp;and&nbsp;clientHello&nbsp;details.&lt;br&gt;<br>
&gt;&gt; &nbsp;No&nbsp;server&nbsp;involvement,&nbsp;thus&nbsp;a&nbsp;very&nbsp;high&nbsp;chance&nbsp;that&nbsp;the&nbsp;server&nbsp;TLS&lt;br&gt;<br>
&gt;&gt;&nbsp;connection&nbsp;requirements&nbsp;and&nbsp;what&nbsp;Squid&nbsp;offers&nbsp;the&nbsp;client&nbsp;to&nbsp;use&nbsp;will&lt;br&gt;<br>
&gt;&gt;&nbsp;conflict&nbsp;or&nbsp;introduce&nbsp;downgrade&nbsp;attack&nbsp;vulnerabilities&nbsp;into&nbsp;these&lt;br&gt;<br>
&gt;&gt;&nbsp;connections.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt; &nbsp;Whether&nbsp;that&nbsp;is&nbsp;okay&nbsp;is&nbsp;a&nbsp;grey&nbsp;area&nbsp;with&nbsp;disagreement&nbsp;possibilities&nbsp;on&lt;br&gt;<br>
&gt;&gt;&nbsp;all&nbsp;sides.&lt;br&gt;<br>
&gt;&gt; &nbsp;*&nbsp;On&nbsp;the&nbsp;one&nbsp;hand&nbsp;you&nbsp;are&nbsp;probably&nbsp;configuring&nbsp;good&nbsp;security&nbsp;for&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;client&nbsp;connection&nbsp;even&nbsp;when&nbsp;the&nbsp;server&nbsp;connection&nbsp;has&nbsp;worse&nbsp;TLS.&lt;br&gt;<br>
&gt;&gt; &nbsp;*&nbsp;On&nbsp;the&nbsp;two&nbsp;hand&nbsp;you&nbsp;are&nbsp;potentially&nbsp;configuring&nbsp;something&nbsp;worse&nbsp;than&lt;br&gt;<br>
&gt;&gt;&nbsp;some&nbsp;servers.&lt;br&gt;<br>
&gt;&gt; &nbsp;*&nbsp;On&nbsp;the&nbsp;third&nbsp;hand&nbsp;you&nbsp;are&nbsp;definitely&nbsp;fooling&nbsp;the&nbsp;client&nbsp;into&nbsp;thinking&lt;br&gt;<br>
&gt;&gt;&nbsp;it&nbsp;has&nbsp;different&nbsp;security&nbsp;level&nbsp;than&nbsp;the&nbsp;server&nbsp;connection&nbsp;can&nbsp;provide,&lt;br&gt;<br>
&gt;&gt;&nbsp;or&nbsp;vice-versa&nbsp;for&nbsp;the&nbsp;server&nbsp;knowledge&nbsp;about&nbsp;the&nbsp;client&nbsp;connection.&nbsp;Its&lt;br&gt;<br>
&gt;&gt;&nbsp;risky,&nbsp;and&nbsp;you&nbsp;can&nbsp;expect&nbsp;problems.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;#Is&nbsp;this&nbsp;equivelant&nbsp;to&nbsp;&quot;ssl_bump &nbsp;bump&nbsp;step2&nbsp;haveServerName&lt;br&gt;<br>
&gt;&gt;&nbsp;!https_sites&quot;&nbsp;??&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Yes&nbsp;it&nbsp;is.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;#Can&nbsp;I&nbsp;use&nbsp;step2&nbsp;with&nbsp;some&nbsp;other&nbsp;acl?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Er.&nbsp;You&nbsp;can&nbsp;use&nbsp;any&nbsp;ACL&nbsp;that&nbsp;has&nbsp;available&nbsp;data&nbsp;for&nbsp;the&nbsp;time&nbsp;and&lt;br&gt;<br>
&gt;&gt;&nbsp;position&nbsp;at&nbsp;which&nbsp;it&nbsp;is&nbsp;tested.&lt;br&gt;<br>
&gt;&gt; &nbsp;In&nbsp;other&nbsp;words&nbsp;I&nbsp;would&nbsp;not&nbsp;suggest&nbsp;using&nbsp;ACLs&nbsp;that&nbsp;check&nbsp;HTTP&nbsp;response&lt;br&gt;<br>
&gt;&gt;&nbsp;headers&nbsp;at&nbsp;the&nbsp;ssl_bump&nbsp;checking&nbsp;time.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;At&nbsp;step&nbsp;2&nbsp;of&nbsp;SSL-Bumping&nbsp;process&nbsp;you&nbsp;have&nbsp;client&nbsp;TCP&nbsp;connection&nbsp;details,&lt;br&gt;<br>
&gt;&gt;&nbsp;TLS&nbsp;clientHello&nbsp;details&nbsp;and&nbsp;initial&nbsp;extensions&nbsp;like&nbsp;SNI&nbsp;(well&nbsp;the&nbsp;ones&lt;br&gt;<br>
&gt;&gt;&nbsp;that&nbsp;have&nbsp;been&nbsp;implemented&nbsp;-&nbsp;SNI&nbsp;being&nbsp;the&nbsp;only&nbsp;useful&nbsp;one&nbsp;AFAIK).&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;#Is&nbsp;this&nbsp;now&nbsp;step3&nbsp;for&nbsp;all?what&nbsp;about&nbsp;those&nbsp;urls&nbsp;who&nbsp;didn&#39;t&nbsp;have&nbsp;a&nbsp;match&lt;br&gt;<br>
&gt;&gt;&nbsp;in&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;step2.&nbsp;Is&nbsp;this&nbsp;step2&nbsp;for&nbsp;some&nbsp;and&nbsp;step3&nbsp;for&nbsp;others?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Any&nbsp;step2&nbsp;traffic&nbsp;which&nbsp;fails&nbsp;the&nbsp;&quot;!https_sites&quot;&nbsp;test&nbsp;will&nbsp;match&nbsp;this.&lt;br&gt;<br>
&gt;&gt;&nbsp;Which&nbsp;means&nbsp;there&nbsp;is&nbsp;no&nbsp;step3&nbsp;for&nbsp;those&nbsp;requests.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;If&nbsp;you&nbsp;have&nbsp;been&nbsp;paying&nbsp;attention&nbsp;you&nbsp;will&nbsp;have&nbsp;noticed&nbsp;that&nbsp;all&nbsp;traffic&lt;br&gt;<br>
&gt;&gt;&nbsp;passing&nbsp;the&nbsp;&quot;!https_sites&quot;&nbsp;has&nbsp;been&nbsp;bumped,&nbsp;and&nbsp;all&nbsp;traffic&nbsp;failing&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;same&nbsp;test&nbsp;has&nbsp;been&nbsp;spliced.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;==&gt;&nbsp;Therefore,&nbsp;zero&nbsp;traffic&nbsp;reaches&nbsp;step&nbsp;3.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Many&nbsp;thanks&nbsp;for&nbsp;the&nbsp;detailed&nbsp;clarification,&nbsp;this&nbsp;really&nbsp;helps&nbsp;ALOT!!!!&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;My&nbsp;advice&nbsp;on&nbsp;this&nbsp;as&nbsp;a&nbsp;general&nbsp;rule-of-thumb&nbsp;is&nbsp;to&nbsp;splice&nbsp;at&nbsp;step&nbsp;1&nbsp;or&nbsp;2&lt;br&gt;<br>
&gt;&gt;&nbsp;if&nbsp;you&nbsp;can.&nbsp;That&nbsp;solves&nbsp;a&nbsp;lot&nbsp;of&nbsp;possible&nbsp;problems&nbsp;with&nbsp;the&nbsp;splicing.&lt;br&gt;<br>
&gt;&gt;&nbsp;And&nbsp;to&nbsp;bump&nbsp;only&nbsp;at&nbsp;step&nbsp;3&nbsp;where&nbsp;the&nbsp;mimic&nbsp;feature&nbsp;can&nbsp;avoid&nbsp;a&nbsp;lot&nbsp;of&lt;br&gt;<br>
&gt;&gt;&nbsp;other&nbsp;problems&nbsp;with&nbsp;the&nbsp;bumping.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;You&nbsp;will&nbsp;still&nbsp;encounter&nbsp;some&nbsp;problems&nbsp;though&nbsp;(guaranteed).&nbsp;Don&#39;t&nbsp;forget&lt;br&gt;<br>
&gt;&gt;&nbsp;that&nbsp;TLS&nbsp;is&nbsp;specifically&nbsp;designed&nbsp;to&nbsp;prevent&nbsp;&#39;bumping&#39;&nbsp;from&nbsp;being&nbsp;done&lt;br&gt;<br>
&gt;&gt;&nbsp;on&nbsp;its&nbsp;connections.&nbsp;The&nbsp;fact&nbsp;that&nbsp;we&nbsp;can&nbsp;offer&nbsp;the&nbsp;feature&nbsp;at&nbsp;all&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;generic&nbsp;use&nbsp;is&nbsp;a&nbsp;terrible&nbsp;statement&nbsp;about&nbsp;the&nbsp;Internets&nbsp;bad&nbsp;lack&nbsp;of&lt;br&gt;<br>
&gt;&gt;&nbsp;security.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Cheers.&lt;br&gt;<br>
&gt;&gt;&nbsp;Amos&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;Ok.&nbsp;new&nbsp;try. &nbsp;The&nbsp;following&nbsp;are&nbsp;common&nbsp;configurations:&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;http_sites&nbsp;dstdomain&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;https_sites&nbsp;ssl::server_name&nbsp;&lt;a&nbsp;href=&quot;http://play.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;play.google.com&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://mydomain.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;mydomain.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;http_sites&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_program&nbsp;/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3127&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;https_port&nbsp;3129&nbsp;cert=/etc/squid/ssl/example.com.cert&lt;br&gt;<br>
&gt;&nbsp;key=/etc/squid/ssl/example.com.private&nbsp;ssl-bump&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;generate-host-certificates=on &nbsp;version=1&lt;br&gt;<br>
&gt;&nbsp;options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&nbsp;capath=/etc/ssl/certs/&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslproxy_cert_error&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;sslproxy_flags&nbsp;DONT_VERIFY_PEER&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;url_rewrite_program&nbsp;/bin/bash&nbsp;-c&nbsp;-l&nbsp;/etc/squid/redirect.bash&lt;br&gt;<br>
&gt;&nbsp;url_rewrite_extras&nbsp;&quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;la=%la:%lp&nbsp;la2=%&lt;a/%&lt;a &nbsp;la3=%&lt;la:%&lt;lp&nbsp;%un&lt;br&gt;<br>
&gt;&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp &nbsp;ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&lt;br&gt;<br>
&gt;&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;ssl3=%ssl::&gt;cert_subject&lt;br&gt;<br>
&gt;&nbsp;ssl4=%ssl::&gt;cert_issuer &nbsp;rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;br&gt;<br>
&gt;&nbsp;logformat&nbsp;squid&nbsp;&quot;%&gt;a/%&gt;A&nbsp;%&lt;A&nbsp;la=%la:%lp&nbsp;la2=%&lt;a/%&lt;a &nbsp;la3=%&lt;la:%&lt;lp &nbsp;%un&lt;br&gt;<br>
&gt;&nbsp;%&gt;rm&nbsp;myip=%la&nbsp;myport=%lp &nbsp;ru=%ru&nbsp;ru2=%&gt;ru&nbsp;ru3=%&lt;ru&nbsp;rd=%&gt;rd&nbsp;rd2=%&lt;rd&nbsp;h=%&gt;h&lt;br&gt;<br>
&gt;&nbsp;ssl1=%ssl::bump_mode&nbsp;ssl2=%ssl::&gt;sni&nbsp;ssl3=%ssl::&gt;cert_subject&lt;br&gt;<br>
&gt;&nbsp;ssl4=%ssl::&gt;cert_issuer &nbsp;rp1=%rp&nbsp;rp2=%&gt;rp&nbsp;rp3=%&lt;rp&nbsp;h1=%&gt;h&nbsp;h2=%&gt;ha&quot;&lt;br&gt;<br>
&gt;&nbsp;url_rewrite_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Using&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&quot;ssl_bump&nbsp;splice&nbsp;step1&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Nothing&nbsp;is&nbsp;blocked.&nbsp;And&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;any&nbsp;urls,&nbsp;nor&nbsp;sni&nbsp;info&nbsp;neither&nbsp;in&lt;br&gt;<br>
&gt;&nbsp;access.log&nbsp;nor&nbsp;in&nbsp;my&nbsp;redirect.log.Only&nbsp;IPs. &nbsp;I&#39;m&nbsp;trying&nbsp;many&nbsp;https&nbsp;sites.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;Because&nbsp;&quot;all&quot;&nbsp;traffic&nbsp;got&nbsp;spliced&nbsp;at&nbsp;step1.&nbsp;Nothing&nbsp;go&nbsp;to&nbsp;the&nbsp;step3&nbsp;bumping.&lt;br&gt;<br>
&lt;br&gt;<br>
Sorry&nbsp;if&nbsp;my&nbsp;general&nbsp;rule-of-thumb&nbsp;description&nbsp;was&nbsp;not&nbsp;clear.&nbsp;I&nbsp;meant&lt;br&gt;<br>
those&nbsp;RoT&nbsp;to&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;preference&nbsp;for&nbsp;what&nbsp;stage&nbsp;to&nbsp;do&nbsp;splice&nbsp;or&nbsp;bump&lt;br&gt;<br>
-&nbsp;for&nbsp;the&nbsp;things&nbsp;you&nbsp;want&nbsp;them&nbsp;respectively&nbsp;to&nbsp;apply&nbsp;to.&lt;br&gt;<br>
 You&nbsp;still&nbsp;need&nbsp;other&nbsp;ACLs&nbsp;defining&nbsp;what&nbsp;traffic&nbsp;the&nbsp;action&nbsp;is&nbsp;to&nbsp;be&lt;br&gt;<br>
applied&nbsp;on.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Using&lt;br&gt;<br>
&gt;&nbsp;&quot;ssl_bump&nbsp;splice&nbsp;step2&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Splice&nbsp;still&nbsp;happens&nbsp;to&nbsp;&quot;all&quot;&nbsp;traffic.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&nbsp;Same&nbsp;result.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Using&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;step2 &nbsp;all&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;step3&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;can&nbsp;see&nbsp;URLs&nbsp;in&nbsp;the&nbsp;access.log&nbsp;and&nbsp;redirect.log&nbsp;but&nbsp;no&nbsp;IP&#39;s.&nbsp;Further&nbsp;I&#39;m&lt;br&gt;<br>
&gt;&nbsp;getting&nbsp;the&nbsp;header&nbsp;forgery&nbsp;warning&nbsp;in&nbsp;the&nbsp;logs,&nbsp;and&nbsp;all&nbsp;pages&nbsp;start&lt;br&gt;<br>
&gt;&nbsp;loading,&nbsp;but&nbsp;never&nbsp;finish.&nbsp;Maybe&nbsp;this&nbsp;is&nbsp;something&nbsp;related&nbsp;to&nbsp;the&nbsp;nat&nbsp;rules&lt;br&gt;<br>
&gt;&nbsp;in&nbsp;the&nbsp;iptables?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;No.&lt;br&gt;<br>
&lt;br&gt;<br>
peek&nbsp;is &nbsp;non-final&nbsp;action,&nbsp;grabbing&nbsp;the&nbsp;SNI&nbsp;and&nbsp;clientHello&nbsp;details.&nbsp;It&lt;br&gt;<br>
only&nbsp;stops&nbsp;the&nbsp;current&nbsp;step&#39;s&nbsp;ACL&nbsp;evaluation.&nbsp;ssl_bump&nbsp;gets&nbsp;re-evaluated&lt;br&gt;<br>
for&nbsp;future&nbsp;step&#39;s.&lt;br&gt;<br>
&lt;br&gt;<br>
splice&nbsp;and&nbsp;bump&nbsp;are&nbsp;both&nbsp;&quot;final&quot;&nbsp;actions.&nbsp;SSL-Bumping&nbsp;process&nbsp;in&nbsp;its&lt;br&gt;<br>
entirety&nbsp;stops&nbsp;and&nbsp;does&nbsp;the&nbsp;action&nbsp;chosen.&nbsp;It&nbsp;does&nbsp;not&nbsp;continue&nbsp;to&nbsp;do&lt;br&gt;<br>
any&nbsp;other&nbsp;ssl_bump&nbsp;things&nbsp;once&nbsp;one&nbsp;of&nbsp;them&nbsp;is&nbsp;reached.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;the&nbsp;above&nbsp;peek&nbsp;happens&nbsp;to&nbsp;all&nbsp;traffic,&nbsp;then&nbsp;splice&nbsp;happens&nbsp;to&nbsp;all&lt;br&gt;<br>
traffic.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;For&nbsp;info,&nbsp;I&#39;m&nbsp;using&nbsp;the&nbsp;simplest&nbsp;bash&nbsp;redirector&nbsp;for&nbsp;now.&nbsp;Here&#39;s&nbsp;the&nbsp;code&lt;br&gt;<br>
&gt;&nbsp;while&nbsp;true;&lt;br&gt;<br>
&gt;&nbsp;do&lt;br&gt;<br>
&gt; &nbsp; &nbsp; read&nbsp;input;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; echo&nbsp;&quot;input=${input}&quot; &nbsp;&gt;&gt;/var/log/squid/redirects.log&nbsp;2&gt;&amp;1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; old_url=$(echo&nbsp;${input}&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$1}&#39;)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; echo&nbsp;&quot;${old_url}&quot;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; [[&nbsp;$?&nbsp;!=&nbsp;0&nbsp;]]&nbsp;&amp;&amp;&nbsp;exit&nbsp;-1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; continue&lt;br&gt;<br>
&gt;&nbsp;done&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&#39;ll&nbsp;try&nbsp;squid4&nbsp;next&nbsp;week,&nbsp;maybe&nbsp;the&nbsp;result&nbsp;will&nbsp;be&nbsp;better&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;It&nbsp;won&#39;t&nbsp;be&nbsp;much&nbsp;better,&nbsp;the&nbsp;problem&nbsp;so&nbsp;far&nbsp;is&nbsp;in&nbsp;the&nbsp;ssl_bump&nbsp;ACL&nbsp;design.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
