<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&gt;Â &lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;Since&nbsp;Squid&nbsp;does&nbsp;not&nbsp;(yet)&nbsp;generate&nbsp;new&nbsp;outgoing&nbsp;CONNECT&nbsp;requests&nbsp;to&lt;/span&gt;&lt;br&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;cache_peer&#39;s&nbsp;it&nbsp;cannot&nbsp;tunnel&nbsp;through&nbsp;a&nbsp;non-TLS&nbsp;peer&nbsp;to&nbsp;a&nbsp;server&nbsp;on&nbsp;the&lt;/span&gt;&lt;br&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;other&nbsp;side.&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;see.&nbsp;This&nbsp;is&nbsp;an&nbsp;undocumented&nbsp;and&nbsp;unexpected&nbsp;restriction&nbsp;of&nbsp;cache_peer.&nbsp;The&nbsp;cache_peer&nbsp;documentation&nbsp;should&nbsp;mention&nbsp;that&nbsp;the&nbsp;`ssl`&nbsp;option&nbsp;is&nbsp;mandatory&nbsp;when&nbsp;the&nbsp;peer&nbsp;is&nbsp;being&nbsp;used&nbsp;after&nbsp;an&nbsp;`ssl_bump`.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;all&nbsp;your&nbsp;help,&nbsp;i&#39;ve&nbsp;learned&nbsp;a&nbsp;lot&nbsp;:)&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;b&gt;Mihai&nbsp;Ene&lt;/b&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;Software&nbsp;Developer&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&nbsp;style=&quot;color:rgb(153,153,153);font-size:12.8000001907349px&quot;&gt;UB&nbsp;|&nbsp;Your&nbsp;universal&nbsp;basket&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;&lt;a&nbsp;href=&quot;http://ub.io&quot;&nbsp;target=&quot;_blank&quot;&gt;http://ub.io&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;&lt;a&nbsp;href=&quot;mailto:me@ub.io&quot;&nbsp;target=&quot;_blank&quot;&gt;me@ub.io&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:small&quot;&gt;@shop_ub&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;color=&quot;#999999&quot;&gt;&lt;a&nbsp;href=&quot;tel:+447473804972&quot;&nbsp;value=&quot;+447881904476&quot;&nbsp;target=&quot;_blank&quot;&gt;+44&nbsp;(0)7473&nbsp;804972&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jul&nbsp;19,&nbsp;2016&nbsp;at&nbsp;7:54&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;19/07/2016&nbsp;3:19&nbsp;a.m.,&nbsp;Mihai&nbsp;Ene&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Your&nbsp;details&nbsp;helped&nbsp;me&nbsp;understand&nbsp;a&nbsp;lot&nbsp;better.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;turns&nbsp;out&nbsp;squid&nbsp;correctly&nbsp;adds&nbsp;the&nbsp;header&nbsp;to&nbsp;the&nbsp;CONNECT&nbsp;request,&nbsp;when&lt;br&gt;<br>
&gt;&nbsp;that&nbsp;request&nbsp;is&nbsp;made&nbsp;to&nbsp;another&nbsp;proxy.&nbsp;It&nbsp;cannot&nbsp;be&nbsp;itself,&nbsp;unfortunately,&lt;br&gt;<br>
&gt;&nbsp;because&nbsp;then&nbsp;it&nbsp;complains&nbsp;about&nbsp;a&nbsp;loop.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Also&nbsp;unfortunately,&nbsp;your&nbsp;suggestion&nbsp;of&nbsp;doing&nbsp;`ssl-bump`&nbsp;on&nbsp;the&nbsp;http&nbsp;port&lt;br&gt;<br>
&gt;&nbsp;doesn&#39;t&nbsp;work&nbsp;because&nbsp;the&nbsp;squid&nbsp;process&nbsp;terminates&nbsp;with&nbsp;a&nbsp;failed&nbsp;assertion&lt;br&gt;<br>
&gt;&nbsp;when&nbsp;using&nbsp;cache_peer,&nbsp;it&nbsp;seems&nbsp;to&nbsp;be&nbsp;this&nbsp;bug&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://bugs.squid-cache.org/show_bug.cgi?id=3963&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://bugs.squid-cache.org/show_bug.cgi?id=3963&lt;/a&gt;&nbsp;,&nbsp;which&nbsp;I&nbsp;get&nbsp;during&nbsp;with&lt;br&gt;<br>
&gt;&nbsp;my&nbsp;squid&nbsp;3.5.20&nbsp;`2016/07/18&nbsp;15:07:50.566|&nbsp;assertion&nbsp;failed:&lt;br&gt;<br>
&gt;&nbsp;PeerConnector.cc:116:&nbsp;&quot;peer-&gt;use_ssl&quot;`.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;That&nbsp;is&nbsp;becasue&nbsp;your&nbsp;config&nbsp;is&nbsp;then&nbsp;requiring&nbsp;Squid&nbsp;to&nbsp;fetch&nbsp;the&nbsp;TLS&lt;br&gt;<br>
certificate&nbsp;details&nbsp;from&nbsp;a&nbsp;non-TLS&nbsp;cache_peer.&lt;br&gt;<br>
&lt;br&gt;<br>
Since&nbsp;Squid&nbsp;does&nbsp;not&nbsp;(yet)&nbsp;generate&nbsp;new&nbsp;outgoing&nbsp;CONNECT&nbsp;requests&nbsp;to&lt;br&gt;<br>
cache_peer&#39;s&nbsp;it&nbsp;cannot&nbsp;tunnel&nbsp;through&nbsp;a&nbsp;non-TLS&nbsp;peer&nbsp;to&nbsp;a&nbsp;server&nbsp;on&nbsp;the&lt;br&gt;<br>
other&nbsp;side.&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;fetch&nbsp;and&nbsp;mimic&nbsp;the&nbsp;server&nbsp;TLS&nbsp;certificate,&nbsp;Squid&nbsp;has&nbsp;to&nbsp;connect&nbsp;to&lt;br&gt;<br>
the/a&nbsp;server&nbsp;using&nbsp;TLS.&nbsp;Preferrably&nbsp;the&nbsp;server&nbsp;listed&nbsp;in&nbsp;DNS&nbsp;for&nbsp;the&lt;br&gt;<br>
domain&nbsp;being&nbsp;requested.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
NP:&nbsp;It&nbsp;is&nbsp;worth&nbsp;noting&nbsp;that&nbsp;this&nbsp;same&nbsp;cache_peer&nbsp;being&nbsp;non-TLS&nbsp;issue&nbsp;is&lt;br&gt;<br>
affecting&nbsp;any&nbsp;of&nbsp;the&nbsp;intercepted&nbsp;port&nbsp;443&nbsp;traffic&nbsp;which&nbsp;is&nbsp;denied&nbsp;from&lt;br&gt;<br>
going&nbsp;direct&nbsp;to&nbsp;a&nbsp;server&nbsp;and&nbsp;only&nbsp;allowed&nbsp;through&nbsp;the&nbsp;cache_peer.&nbsp;You&lt;br&gt;<br>
will&nbsp;continue&nbsp;to&nbsp;see&nbsp;it&nbsp;sometimes&nbsp;regardless&nbsp;of&nbsp;the&nbsp;http_port&nbsp;settings.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Config&nbsp;used:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;8000&nbsp;ssl-bump&nbsp;generate-host-certificates=on&lt;br&gt;<br>
&gt;&nbsp;dynamic_cert_mem_cache_size=16MB&nbsp;cert=/etc/squid/ca.crt&lt;br&gt;<br>
&gt;&nbsp;key=/etc/squid/ca.key&nbsp;dhparams=/etc/squid/dh2048.pem&nbsp;options=NO_SSLv3&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/squid_ssl_db&nbsp;-M&nbsp;32MB&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_children&nbsp;32&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;never_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;192.71.64.174&nbsp;parent&nbsp;6745&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;default&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Considering&nbsp;the&nbsp;fact&nbsp;that&nbsp;I&nbsp;can&#39;t&nbsp;do&nbsp;`ssl-bump`&nbsp;on&nbsp;http&nbsp;port&nbsp;because&nbsp;of&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;`peer-use_ssl`&nbsp;assertion&nbsp;(bug&nbsp;linked&nbsp;above),&nbsp;also&nbsp;considering&nbsp;the&nbsp;fact&nbsp;that&lt;br&gt;<br>
&gt;&nbsp;squid&nbsp;:8000&nbsp;using&nbsp;itself&nbsp;as&nbsp;a&nbsp;proxy&nbsp;:8443&nbsp;complains&nbsp;about&nbsp;a&nbsp;proxy&nbsp;loop,&nbsp;are&lt;br&gt;<br>
&gt;&nbsp;there&nbsp;any&nbsp;other&nbsp;options&nbsp;I&nbsp;might&nbsp;have&nbsp;to&nbsp;use&nbsp;ssl_bump&nbsp;*with*&nbsp;multiple&lt;br&gt;<br>
&gt;&nbsp;cache_peer,&nbsp;and&nbsp;cache_peer&nbsp;selection&nbsp;based&nbsp;on&nbsp;proxy_auth&nbsp;and/or&nbsp;req_header?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;In&nbsp;curent&nbsp;Squid&nbsp;releases&nbsp;the&nbsp;peers&nbsp;need&nbsp;to&nbsp;be&nbsp;receiving&nbsp;TLS&nbsp;connections&lt;br&gt;<br>
in&nbsp;order&nbsp;for&nbsp;decrypted&nbsp;traffic&nbsp;to&nbsp;be&nbsp;delivered&nbsp;there.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Otherwise:&lt;br&gt;<br>
&lt;&lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
