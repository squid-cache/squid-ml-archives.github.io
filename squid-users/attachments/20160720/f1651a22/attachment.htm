<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi.&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;being&nbsp;trying&nbsp;to&nbsp;setup&nbsp;a&nbsp;local&nbsp;squid&nbsp;server&nbsp;on&nbsp;my&nbsp;home&nbsp;LAN&nbsp;to&nbsp;cache&nbsp;HTTP&nbsp;(not&nbsp;HTTPS)&nbsp;pages.&nbsp;I&nbsp;want&nbsp;to&nbsp;avoid&nbsp;any&nbsp;client&nbsp;configuration,&nbsp;so&nbsp;I&#39;m&nbsp;aiming&nbsp;for&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;-&nbsp;with&nbsp;squid&nbsp;in&nbsp;intercept&nbsp;mode.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;my&nbsp;network&nbsp;setup,&nbsp;the&nbsp;squid&nbsp;server&nbsp;is&nbsp;inside&nbsp;the&nbsp;LAN&nbsp;together&nbsp;with&nbsp;its&nbsp;clients,&nbsp;and&nbsp;not&nbsp;siting&nbsp;between&nbsp;the&nbsp;clients&nbsp;and&nbsp;the&nbsp;router/modem&nbsp;like&nbsp;all&nbsp;guides&nbsp;assume.&nbsp;Furthermore,&nbsp;requests&nbsp;originating&nbsp;from&nbsp;the&nbsp;same&nbsp;machine&nbsp;where&nbsp;squid&nbsp;is&nbsp;running&nbsp;should&nbsp;be&nbsp;cached&nbsp;as&nbsp;well.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;setup&nbsp;squid&nbsp;inside&nbsp;a&nbsp;docker&nbsp;container,&nbsp;on&nbsp;a&nbsp;fedora&nbsp;24&nbsp;image.&nbsp;The&nbsp;squid&nbsp;version&nbsp;is 3.5.19.&nbsp;On&nbsp;squid.conf&nbsp;I&#39;ve&nbsp;added&nbsp;a&nbsp;new&nbsp;http_port&nbsp;line,&nbsp;for&nbsp;port&nbsp;8080&nbsp;with&nbsp;the&nbsp;intercept&nbsp;flag:&lt;/div&gt;&lt;div&gt;http_port&nbsp;8080&nbsp;intercept&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;router&nbsp;is&nbsp;a&nbsp;Mikrotik&nbsp;router&nbsp;board,&nbsp;so&nbsp;it&#39;s&nbsp;trivial&nbsp;to&nbsp;setup&nbsp;a DNAT rule&nbsp;to&nbsp;redirect&nbsp;all&nbsp;TCP&nbsp;requests&nbsp;to&nbsp;the&nbsp;squid server.&nbsp;To&nbsp;avoid&nbsp;forward&nbsp;loops,&nbsp;I&#39;ve&nbsp;marked&nbsp;all&nbsp;packets&nbsp;originating&nbsp;from&nbsp;squid&nbsp;with&nbsp;DSCP&nbsp;4&nbsp;using&nbsp;iptables&nbsp;rules,&nbsp;and&nbsp;excluded&nbsp;those&nbsp;from&nbsp;the&nbsp;DNAT&nbsp;rule&nbsp;on&nbsp;the&nbsp;router.&nbsp;I&#39;ve&nbsp;tested&nbsp;this&nbsp;by&nbsp;running&nbsp;wget&nbsp;requests&nbsp;from&nbsp;inside&nbsp;the&nbsp;docker&nbsp;container,&nbsp;and&nbsp;those&nbsp;went&nbsp;by&nbsp;without&nbsp;any&nbsp;redirection.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;comes&nbsp;the&nbsp;problem:&lt;/div&gt;&lt;div&gt;When&nbsp;any&nbsp;of&nbsp;the&nbsp;redirected&nbsp;requests&nbsp;reach&nbsp;squid,&nbsp;squid&nbsp;will&nbsp;reply&nbsp;instantly&nbsp;with&nbsp;TCP_MISS/403.&nbsp;Since&nbsp;all&nbsp;traffic&nbsp;from&nbsp;the&nbsp;squid&nbsp;machine&nbsp;is&nbsp;marked&nbsp;with&nbsp;a&nbsp;specific&nbsp;DSCP,&nbsp;it&#39;s&nbsp;also&nbsp;easy&nbsp;to&nbsp;see&nbsp;squid&nbsp;made&nbsp;no&nbsp;requests&nbsp;to&nbsp;the&nbsp;outside&nbsp;world&nbsp;before&nbsp;giving&nbsp;that&nbsp;reply.&nbsp;Running&nbsp;tcpdump&nbsp;on&nbsp;the&nbsp;host&nbsp;machine&nbsp;shows&nbsp;no&nbsp;other&nbsp;packets&nbsp;are&nbsp;being&nbsp;sent&nbsp;other&nbsp;than&nbsp;the&nbsp;403&nbsp;reply.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&#39;s&nbsp;happening?&nbsp;why&nbsp;doesn&#39;t&nbsp;squid&nbsp;tries&nbsp;to&nbsp;fetch&nbsp;the&nbsp;request&nbsp;pages&nbsp;at&nbsp;all?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;From&nbsp;my&nbsp;understanding,&nbsp;my&nbsp;setup&nbsp;is&nbsp;roughly&nbsp;equivalent&nbsp;to &lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat&lt;/a&gt;,&nbsp;only&nbsp;the&nbsp;DNAT&nbsp;is&nbsp;happening&nbsp;outside&nbsp;the&nbsp;squid&nbsp;box;&nbsp;There&nbsp;is&nbsp;no&nbsp;reason&nbsp;this&nbsp;should&nbsp;interfere&nbsp;with&nbsp;anything.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute&lt;/a&gt;&nbsp;seens&nbsp;to&nbsp;recommend&nbsp;routing&nbsp;without&nbsp;DNAT;&nbsp;This&nbsp;seems&nbsp;weird,&nbsp;as&nbsp;the&nbsp;only&nbsp;way&nbsp;I&nbsp;can&nbsp;see&nbsp;this&nbsp;working&nbsp;is&nbsp;if&nbsp;the&nbsp;squid&nbsp;machine&nbsp;accepted&nbsp;packets&nbsp;to&nbsp;any&nbsp;address&nbsp;as&nbsp;their&nbsp;own.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;TL;DR:&lt;/div&gt;&lt;div&gt;When&nbsp;running&nbsp;squid&nbsp;in&nbsp;intercept&nbsp;mode,&nbsp;inside&nbsp;a&nbsp;docker&nbsp;container,&nbsp;routing&nbsp;traffic&nbsp;to&nbsp;it&nbsp;through&nbsp;dst-nat&nbsp;rules&nbsp;on&nbsp;a&nbsp;external&nbsp;router,&nbsp;squid&nbsp;will&nbsp;reply&nbsp;with&nbsp;&#39;403&nbsp;forbidden&#39;&nbsp;to&nbsp;all&nbsp;requests.&nbsp;Access.log&nbsp;lists&nbsp;TCP_MISS/403,&nbsp;but&nbsp;tcpdump&nbsp;indicates&nbsp;that&nbsp;squid&nbsp;is&nbsp;never&nbsp;trying&nbsp;to&nbsp;query&nbsp;the&nbsp;requested&nbsp;page&nbsp;at&nbsp;all.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
