<tt>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;At&nbsp;what&nbsp;point&nbsp;does&nbsp;buffer&nbsp;bloat&nbsp;set&nbsp;in? &nbsp;I&nbsp;have&nbsp;a&nbsp;linux&nbsp;router&nbsp;with&nbsp;the&nbsp;below&nbsp;sysctl&nbsp;tweaks&nbsp;load&nbsp;balancing&nbsp;with&nbsp;haproxy&nbsp;to&nbsp;2&nbsp;squid&nbsp;instances. &nbsp;I&nbsp;have&nbsp;4&nbsp;x&nbsp;1Gb&nbsp;interfaces&nbsp;bonded&nbsp;and&nbsp;have&nbsp;bumped&nbsp;the&nbsp;ring&nbsp;buffers&nbsp;on&nbsp;RX&nbsp;and&nbsp;TX&nbsp;to&nbsp;1024&nbsp;on&nbsp;all&nbsp;interfaces.&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;The&nbsp;squid&nbsp;servers&nbsp;run&nbsp;with&nbsp;almost&nbsp;the&nbsp;same&nbsp;hardware&nbsp;and&nbsp;tweaks,&nbsp;except&nbsp;the&nbsp;ring&nbsp;buffers&nbsp;have&nbsp;only&nbsp;been&nbsp;bumped&nbsp;to&nbsp;512.&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;DSL&nbsp;Reports&nbsp;has&nbsp;a&nbsp;speed&nbsp;test&nbsp;page&nbsp;that&nbsp;supposedly&nbsp;finds&nbsp;and&nbsp;quantifies&nbsp;buffer&nbsp;bloat&nbsp;and&nbsp;my&nbsp;setup&nbsp;does&nbsp;not&nbsp;introduce&nbsp;it,&nbsp;per&nbsp;their&nbsp;tests.&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;am&nbsp;only&nbsp;running&nbsp;a&nbsp;home&nbsp;internet&nbsp;connection&nbsp;(50&nbsp;down&nbsp;x&nbsp;15&nbsp;up)&nbsp;but&nbsp;have&nbsp;a&nbsp;wonderful&nbsp;browsing&nbsp;experience. &nbsp;I&nbsp;imagine&nbsp;scale&nbsp;of&nbsp;bandwidth&nbsp;might&nbsp;be&nbsp;a&nbsp;factor,&nbsp;but&nbsp;have&nbsp;no&nbsp;idea&nbsp;where&nbsp;buffer&nbsp;bloat&nbsp;begins&nbsp;to&nbsp;set&nbsp;in.&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Favor&nbsp;low&nbsp;latency&nbsp;over&nbsp;high&nbsp;bandwidth&lt;br&gt;<br>
net.ipv4.tcp_low_latency&nbsp;=&nbsp;1&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Use&nbsp;the&nbsp;full&nbsp;range&nbsp;of&nbsp;ports.&lt;br&gt;<br>
net.ipv4.ip_local_port_range&nbsp;=&nbsp;1025&nbsp;65535&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;files&nbsp;per&nbsp;process;&nbsp;default&nbsp;1048576&lt;br&gt;<br>
#fs.nr_open&nbsp;=&nbsp;10000000&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Increase&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;limit;&nbsp;default&nbsp;402289&lt;br&gt;<br>
fs.file-max&nbsp;=&nbsp;100000&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;requests&nbsp;queued&nbsp;to&nbsp;a&nbsp;listen&nbsp;socket;&nbsp;default&nbsp;128&lt;br&gt;<br>
net.core.somaxconn&nbsp;=&nbsp;1024&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;packets&nbsp;backlogged&nbsp;in&nbsp;the&nbsp;kernel;&nbsp;default&nbsp;1000&lt;br&gt;<br>
#net.core.netdev_max_backlog&nbsp;=&nbsp;2000&lt;br&gt;<br>
net.core.netdev_max_backlog&nbsp;=&nbsp;4096&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;syn&nbsp;requests&nbsp;allowed;&nbsp;default&nbsp;128&lt;br&gt;<br>
#net.ipv4.tcp_max_syn_backlog&nbsp;=&nbsp;2048&lt;br&gt;<br>
net.ipv4.tcp_max_syn_backlog&nbsp;=&nbsp;16284&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Discourage&nbsp;Linux&nbsp;from&nbsp;swapping&nbsp;idle&nbsp;processes&nbsp;to&nbsp;disk&nbsp;(default&nbsp;=&nbsp;60)&lt;br&gt;<br>
#vm.swappiness&nbsp;=&nbsp;10&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Increase&nbsp;Linux&nbsp;autotuning&nbsp;TCP&nbsp;buffer&nbsp;limits&lt;br&gt;<br>
#&nbsp;Set&nbsp;max&nbsp;to&nbsp;16MB&nbsp;for&nbsp;1GE&nbsp;and&nbsp;32M&nbsp;(33554432)&nbsp;or&nbsp;54M&nbsp;(56623104)&nbsp;for&nbsp;10GE&lt;br&gt;<br>
#&nbsp;Don&#39;t&nbsp;set&nbsp;tcp_mem&nbsp;itself!&nbsp;Let&nbsp;the&nbsp;kernel&nbsp;scale&nbsp;it&nbsp;based&nbsp;on&nbsp;RAM.&lt;br&gt;<br>
net.core.rmem_max&nbsp;=&nbsp;16777216&lt;br&gt;<br>
net.core.wmem_max&nbsp;=&nbsp;16777216&lt;br&gt;<br>
net.core.rmem_default&nbsp;=&nbsp;16777216&lt;br&gt;<br>
net.core.wmem_default&nbsp;=&nbsp;16777216&lt;br&gt;<br>
net.core.optmem_max&nbsp;=&nbsp;40960&lt;br&gt;<br>
net.ipv4.tcp_rmem&nbsp;=&nbsp;4096&nbsp;87380&nbsp;16777216&lt;br&gt;<br>
net.ipv4.tcp_wmem&nbsp;=&nbsp;4096&nbsp;65536&nbsp;16777216&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Increase&nbsp;Linux&nbsp;autotuning&nbsp;UDP&nbsp;buffer&nbsp;limits&lt;br&gt;<br>
net.ipv4.udp_mem&nbsp;=&nbsp;4096&nbsp;87380&nbsp;16777216&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Make&nbsp;room&nbsp;for&nbsp;more&nbsp;TIME_WAIT&nbsp;sockets&nbsp;due&nbsp;to&nbsp;more&nbsp;clients,&lt;br&gt;<br>
#&nbsp;and&nbsp;allow&nbsp;them&nbsp;to&nbsp;be&nbsp;reused&nbsp;if&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;sockets&lt;br&gt;<br>
#&nbsp;Also&nbsp;increase&nbsp;the&nbsp;max&nbsp;packet&nbsp;backlog&lt;br&gt;<br>
net.core.netdev_max_backlog&nbsp;=&nbsp;50000&lt;br&gt;<br>
net.ipv4.tcp_max_syn_backlog&nbsp;=&nbsp;30000&lt;br&gt;<br>
net.ipv4.tcp_max_tw_buckets&nbsp;=&nbsp;2000000&lt;br&gt;<br>
net.ipv4.tcp_tw_reuse&nbsp;=&nbsp;1&lt;br&gt;<br>
net.ipv4.tcp_fin_timeout&nbsp;=&nbsp;10&lt;/p&gt;<br>
&lt;p&nbsp;dir=&quot;ltr&quot;&gt;#&nbsp;Disable&nbsp;TCP&nbsp;slow&nbsp;start&nbsp;on&nbsp;idle&nbsp;connections&lt;br&gt;<br>
net.ipv4.tcp_slow_start_after_idle&nbsp;=&nbsp;0&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Aug&nbsp;4,&nbsp;2016&nbsp;2:17&nbsp;AM,&nbsp;&quot;Amos&nbsp;Jeffries&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;type=&quot;attribution&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;On&nbsp;4/08/2016&nbsp;2:32&nbsp;a.m.,&nbsp;Heiler&nbsp;Bemerguy&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;think&nbsp;it&nbsp;doesn&#39;t&nbsp;really&nbsp;matter&nbsp;how&nbsp;much&nbsp;squid&nbsp;sets&nbsp;its&nbsp;default&nbsp;buffer.&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;linux&nbsp;kernel&nbsp;will&nbsp;upscale&nbsp;to&nbsp;the&nbsp;maximum&nbsp;set&nbsp;by&nbsp;the&nbsp;third&nbsp;option.&lt;br&gt;<br>
&gt;&nbsp;(and&nbsp;the&nbsp;TCP&nbsp;Window&nbsp;Size&nbsp;will&nbsp;follow&nbsp;that)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;net.ipv4.tcp_wmem&nbsp;=&nbsp;1024&nbsp;32768&nbsp;8388608&lt;br&gt;<br>
&gt;&nbsp;net.ipv4.tcp_rmem&nbsp;=&nbsp;1024&nbsp;32768&nbsp;8388608&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Having&nbsp;large&nbsp;system&nbsp;buffers&nbsp;like&nbsp;that&nbsp;just&nbsp;leads&nbsp;to&nbsp;buffer&nbsp;bloat&lt;br&gt;<br>
problems.&nbsp;Squid&nbsp;is&nbsp;still&nbsp;the&nbsp;bottleneck&nbsp;if&nbsp;it&nbsp;is&nbsp;sending&nbsp;only&nbsp;4KB&nbsp;each&lt;br&gt;<br>
I/O&nbsp;cycle&nbsp;to&nbsp;the&nbsp;client&nbsp;-&nbsp;no&nbsp;matter&nbsp;how&nbsp;much&nbsp;is&nbsp;already&nbsp;received&nbsp;by&lt;br&gt;<br>
Squid,&nbsp;or&nbsp;stuck&nbsp;in&nbsp;kernel&nbsp;queues&nbsp;waiting&nbsp;to&nbsp;arrive&nbsp;to&nbsp;Squid.&nbsp;The&nbsp;more&lt;br&gt;<br>
heavily&nbsp;loaded&nbsp;the&nbsp;proxy&nbsp;is&nbsp;the&nbsp;longer&nbsp;each&nbsp;I/O&nbsp;cycle&nbsp;gets&nbsp;as&nbsp;all&lt;br&gt;<br>
clients&nbsp;get&nbsp;one&nbsp;slice&nbsp;of&nbsp;the&nbsp;cycle&nbsp;to&nbsp;do&nbsp;whatever&nbsp;processing&nbsp;they&nbsp;need&nbsp;done.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;buffers&nbsp;limited&nbsp;by&nbsp;HTTP_REQBUF_SZ&nbsp;are&nbsp;not&nbsp;dynamic&nbsp;so&nbsp;its&nbsp;not&nbsp;just&nbsp;a&lt;br&gt;<br>
minimum.&nbsp;Nathan&nbsp;found&nbsp;a&nbsp;300%&nbsp;speed&nbsp;increase&nbsp;from&nbsp;a&nbsp;3x&nbsp;buffer&nbsp;size&lt;br&gt;<br>
increase.&nbsp;Which&nbsp;is&nbsp;barely&nbsp;noticable&nbsp;(but&nbsp;still&nbsp;present)&nbsp;on&nbsp;small&lt;br&gt;<br>
responses,&nbsp;but&nbsp;very&nbsp;noticable&nbsp;with&nbsp;large&nbsp;transactions.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
