<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana;font-size:&nbsp;12.0px;&quot;&gt;&lt;div&gt;Hello&nbsp;Amos,&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;auth_param&nbsp;ntlm&nbsp;keep_alive&nbsp;off&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;unfortunately&nbsp;does&nbsp;not&nbsp;solve&nbsp;the&nbsp;problem.&lt;/div&gt;<br>
<br>
&lt;div&gt;I&nbsp;did&nbsp;more&nbsp;investigation&nbsp;about&nbsp;the&nbsp;problem&nbsp;and&nbsp;i&nbsp;found&nbsp;informations.&lt;/div&gt;<br>
<br>
&lt;div&gt;Every&nbsp;time&nbsp;a&nbsp;user&nbsp;get&nbsp;the&nbsp;browser&nbsp;popup&nbsp;requesting&nbsp;credentials,&nbsp;i&nbsp;found&nbsp;on&nbsp;squid&nbsp;log&nbsp;this&nbsp;event:&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;<br>
&lt;div&gt;Login&nbsp;for&nbsp;user&nbsp;[DOMAIN]&#92;[user]@[PC_XXXX]&nbsp;failed&nbsp;due&nbsp;to&nbsp;[Access&nbsp;denied]&lt;br/&gt;<br>
NTLMSSP&nbsp;BH:&nbsp;NT_STATUS_ACCESS_DENIED&lt;br/&gt;<br>
2016/09/02&nbsp;16:56:13&nbsp;kid1&#124;&nbsp;ERROR:&nbsp;NTLM&nbsp;Authentication&nbsp;validating&nbsp;user.&nbsp;Result:&nbsp;{result=BH,&nbsp;notes={message:&nbsp;NT_STATUS_ACCESS_DENIED;&nbsp;}}&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;It&#39;s&nbsp;not&nbsp;easy&nbsp;to&nbsp;do&nbsp;more&nbsp;debug&nbsp;because&nbsp;i&nbsp;have&nbsp;9000&nbsp;concurrent&nbsp;connections,&nbsp;but&nbsp;if&nbsp;you&nbsp;think&nbsp;that&nbsp;can&nbsp;help&nbsp;me,&nbsp;i&nbsp;try&nbsp;to&nbsp;set&nbsp;debug_option&nbsp;to&nbsp;something&nbsp;like&nbsp;29,5&lt;/div&gt;<br>
<br>
&lt;div&gt;Sometimes&nbsp;users&nbsp;left&nbsp;the&nbsp;office&nbsp;letting&nbsp;the&nbsp;browser&nbsp;open.&lt;/div&gt;<br>
<br>
&lt;div&gt;After&nbsp;1&nbsp;hour&nbsp;(more&nbsp;or&nbsp;less),&nbsp;they&nbsp;return&nbsp;to&nbsp;the&nbsp;pc&nbsp;and&nbsp;popup&nbsp;show&nbsp;as&nbsp;soos&nbsp;as&nbsp;mouse&nbsp;point&nbsp;to&nbsp;a&nbsp;new&nbsp;link&nbsp;on&nbsp;the&nbsp;open&nbsp;browser.&lt;/div&gt;<br>
<br>
&lt;div&gt;It&#39;s&nbsp;probably&nbsp;because&nbsp;something&nbsp;cached&nbsp;expire,&nbsp;but&nbsp;i&nbsp;cannot&nbsp;demostrate&nbsp;it&nbsp;so&nbsp;easily&nbsp;beceuse,&nbsp;as&nbsp;you&nbsp;said,&nbsp;ntlm&nbsp;never&nbsp;cache.&lt;/div&gt;<br>
<br>
&lt;div&gt;On&nbsp;my&nbsp;samba/winbind&nbsp;logs&nbsp;i&nbsp;see&nbsp;many&lt;/div&gt;<br>
<br>
&lt;div&gt;rpccli_netlogon_sam_network_logon:&nbsp;credentials&nbsp;chain&nbsp;check&nbsp;failed&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;So&nbsp;it&#39;s&nbsp;very&nbsp;strange&nbsp;to&nbsp;understand&nbsp;if&nbsp;some&nbsp;problem&nbsp;occur&nbsp;beetween&nbsp;squid&nbsp;and&nbsp;browser&nbsp;or&nbsp;samba&nbsp;and&nbsp;Active&nbsp;Directory.&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;What&nbsp;do&nbsp;you&nbsp;think&nbsp;about?&lt;/div&gt;<br>
&lt;/div&gt;<br>
<br>
&lt;div&gt;Thanks.&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;Giulius.&lt;br/&gt;<br>
&lt;br/&gt;<br>
On&nbsp;1/09/2016&nbsp;12:37&nbsp;a.m.,&nbsp;akn&nbsp;ab&nbsp;wrote:&lt;br/&gt;<br>
&gt;&nbsp;Dear&nbsp;all,&lt;br/&gt;<br>
&gt;&nbsp;i&#39;m&nbsp;facing&nbsp;a&nbsp;strange&nbsp;problem&nbsp;using&nbsp;squid&nbsp;3.5.20&nbsp;with&nbsp;ntlm&nbsp;transparent&lt;br/&gt;<br>
&gt;&nbsp;authentication.&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;cannot&nbsp;use&nbsp;kerberos&nbsp;auth&nbsp;because&nbsp;i&nbsp;need&nbsp;to&nbsp;pass&nbsp;DOMAIN&#92;user&nbsp;to&nbsp;my&nbsp;parent&nbsp;proxy&lt;br/&gt;<br>
&gt;&nbsp;with&nbsp;x-authenticated-user&nbsp;header,&nbsp;and&nbsp;the&nbsp;form&nbsp;USERNAME@DOMAIN&nbsp;is&nbsp;not&nbsp;supported.&lt;br/&gt;<br>
&gt;&nbsp;Users&nbsp;can&nbsp;surf&nbsp;the&nbsp;web&nbsp;without&nbsp;problems&nbsp;but,&nbsp;sometimes,&nbsp;they&nbsp;receive&nbsp;request&lt;br/&gt;<br>
&gt;&nbsp;credential&nbsp;popup&nbsp;from&nbsp;browser&nbsp;(explorer,&nbsp;edge,&nbsp;mozilla&nbsp;and&nbsp;chrome&nbsp;it&nbsp;does&nbsp;not&lt;br/&gt;<br>
&gt;&nbsp;matter).&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;ntlm&nbsp;program&nbsp;/usr/local/samba/bin/ntlm_auth&lt;br/&gt;<br>
&gt;&nbsp;--helper-protocol=squid-2.5-ntlmssp&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;ntlm&nbsp;children&nbsp;300&nbsp;startup=200&nbsp;idle=10&nbsp;concurrency=0&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;ntlm&nbsp;keep_alive&nbsp;on&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;program&nbsp;/usr/local/samba/bin/ntlm_auth&lt;br/&gt;<br>
&gt;&nbsp;--helper-protocol=squid-2.5-basic&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;children&nbsp;25&nbsp;startup=15&nbsp;idle=5&nbsp;concurrency=0&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;realm&nbsp;PROXY&nbsp;AUTHORIZATION&nbsp;REQUIRED&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;credentialsttl&nbsp;30&nbsp;minutes&lt;br/&gt;<br>
&gt;&nbsp;authenticate_cache_garbage_interval&nbsp;1&nbsp;hours&lt;br/&gt;<br>
&gt;&nbsp;authenticate_ttl&nbsp;30&nbsp;minutes&lt;br/&gt;<br>
&gt;&nbsp;authenticate_ip_ttl&nbsp;30&nbsp;minutes&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;migrated&nbsp;from&nbsp;squid&nbsp;2.6.x&nbsp;and,&nbsp;with&nbsp;similar&nbsp;configuration,&nbsp;the&nbsp;required&lt;br/&gt;<br>
&gt;&nbsp;credentials&nbsp;was&nbsp;displayed&nbsp;only&nbsp;when&nbsp;the&nbsp;password&nbsp;was&nbsp;expired.&lt;br/&gt;<br>
&gt;&nbsp;In&nbsp;this&nbsp;situation,&nbsp;users&nbsp;must&nbsp;click&nbsp;on&nbsp;abort&nbsp;button&nbsp;many&nbsp;times&nbsp;to&nbsp;restore&nbsp;a&lt;br/&gt;<br>
&gt;&nbsp;good&nbsp;situation,&nbsp;but&nbsp;i&nbsp;cannot&nbsp;understand&nbsp;why&nbsp;the&nbsp;request&nbsp;popup&nbsp;suddenly.&lt;br/&gt;<br>
&gt;&nbsp;Is&nbsp;this&nbsp;a&nbsp;credentials&nbsp;cache&nbsp;timeout&nbsp;problm&nbsp;(authenticate_ttl&nbsp;30&nbsp;minutes)?&lt;br/&gt;<br>
&lt;br/&gt;<br>
Maybe.&nbsp;If&nbsp;so&nbsp;its&nbsp;not&nbsp;an&nbsp;NTLM&nbsp;problem&nbsp;since&nbsp;NTLM&nbsp;credentials&nbsp;are&nbsp;&quot;cached&quot;&lt;br/&gt;<br>
by&nbsp;being&nbsp;tied&nbsp;to&nbsp;the&nbsp;TCP&nbsp;connection&nbsp;state,&nbsp;not&nbsp;stored&nbsp;in&nbsp;a&nbsp;regular&nbsp;cache&lt;br/&gt;<br>
like&nbsp;Basic&nbsp;auth&nbsp;credentials.&lt;br/&gt;<br>
&lt;br/&gt;<br>
I&nbsp;suggest&nbsp;trying:&lt;br/&gt;<br>
auth_param&nbsp;ntlm&nbsp;keep_alive&nbsp;off&lt;br/&gt;<br>
&lt;br/&gt;<br>
Squid-3&nbsp;is&nbsp;now&nbsp;HTTP/1.1&nbsp;which&nbsp;behaves&nbsp;a&nbsp;bit&nbsp;differently&nbsp;with&nbsp;persistent&lt;br/&gt;<br>
connectiosn&nbsp;than&nbsp;HTTP/1.0&nbsp;did.&nbsp;Which&nbsp;affects&nbsp;the&nbsp;pile&nbsp;of&nbsp;nasty&nbsp;hacks&lt;br/&gt;<br>
needed&nbsp;to&nbsp;make&nbsp;NTLM&nbsp;work&nbsp;over&nbsp;HTTP.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;&nbsp;Is&nbsp;this&nbsp;a&nbsp;problem&nbsp;in&nbsp;the&nbsp;browser?&lt;br/&gt;<br>
&lt;br/&gt;<br>
Yes,&nbsp;at&nbsp;least&nbsp;partially.&nbsp;The&nbsp;popup&nbsp;only&nbsp;occurs&nbsp;when&nbsp;the&nbsp;browser&nbsp;thinks&lt;br/&gt;<br>
none&nbsp;of&nbsp;its&nbsp;credentials&nbsp;are&nbsp;valid&nbsp;to&nbsp;send&nbsp;to&nbsp;the&nbsp;proxy.&nbsp;Why&nbsp;it&nbsp;thinks&lt;br/&gt;<br>
that&nbsp;might&nbsp;be&nbsp;a&nbsp;browser&nbsp;bug&nbsp;or&nbsp;a&nbsp;Squid&nbsp;bug.&nbsp;Or&nbsp;just&nbsp;the&nbsp;way&nbsp;NTLM&nbsp;behaves&lt;br/&gt;<br>
in&nbsp;some&nbsp;HTTP&nbsp;message&nbsp;circumstances.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;&nbsp;Is&nbsp;this&nbsp;a&nbsp;comunication&nbsp;problem&nbsp;with&nbsp;squind&nbsp;and&nbsp;Active&nbsp;Directory?&lt;br/&gt;<br>
&lt;br/&gt;<br>
Unlikely.&nbsp;It&#39;s&nbsp;more&nbsp;probably&nbsp;between&nbsp;Squid&nbsp;and&nbsp;browser.&nbsp;Squid&nbsp;only&lt;br/&gt;<br>
interacts&nbsp;with&nbsp;AD&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;new&nbsp;TCP&nbsp;connection,&nbsp;or&nbsp;when&nbsp;NTLM&nbsp;is&lt;br/&gt;<br>
started&nbsp;on&nbsp;an&nbsp;existing&nbsp;connection.&lt;br/&gt;<br>
&lt;br/&gt;<br>
It&nbsp;could&nbsp;be&nbsp;browser&nbsp;sending&nbsp;unacceptible&nbsp;credentials&nbsp;(eg.&nbsp;the&nbsp;users&lt;br/&gt;<br>
machine&#39;s&nbsp;account&nbsp;instead&nbsp;of&nbsp;the&nbsp;users&nbsp;own&nbsp;account)&nbsp;then&nbsp;deciding&nbsp;NTLM&lt;br/&gt;<br>
is&nbsp;unusable.&lt;br/&gt;<br>
&lt;br/&gt;<br>
It&nbsp;could&nbsp;be&nbsp;the&nbsp;browser&nbsp;failing&nbsp;to&nbsp;send&nbsp;the&nbsp;right&nbsp;NTLM&nbsp;token&nbsp;for&nbsp;Squid&lt;br/&gt;<br>
to&nbsp;check&nbsp;against&nbsp;the&nbsp;existing&nbsp;known&nbsp;credentials&nbsp;tied&nbsp;to&nbsp;the&nbsp;connection.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;undestrand&nbsp;why,&nbsp;so&nbsp;i&nbsp;need&nbsp;advices&nbsp;to&nbsp;start&nbsp;debug&nbsp;and&nbsp;find&nbsp;a&lt;br/&gt;<br>
&gt;&nbsp;solution.&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;&lt;a&nbsp;href=&quot;https://deref-mail.com/mail/client/c6_H0i188Ps/dereferrer/?redirectUrl=http%3A%2F%2Fwiki.squid-cache.org%2FKnowledgeBase%2FDebugSections&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/KnowledgeBase/DebugSections&lt;/a&gt;&gt;&lt;br/&gt;<br>
&lt;br/&gt;<br>
Section&nbsp;29&nbsp;is&nbsp;the&nbsp;various&nbsp;authenticators.&nbsp;You&nbsp;will&nbsp;also&nbsp;need&nbsp;the&nbsp;ACL&lt;br/&gt;<br>
processing&nbsp;section&nbsp;and&nbsp;results.&lt;br/&gt;<br>
&lt;br/&gt;<br>
Amos&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>
<br>

</tt>
