<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana;font-size:&nbsp;12.0px;&quot;&gt;&lt;div&gt;<br>
&lt;div&gt;Dear&nbsp;Amos,&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;i&nbsp;found&nbsp;the&nbsp;problem.&lt;/div&gt;<br>
<br>
&lt;div&gt;It&nbsp;was&nbsp;a&nbsp;samba&nbsp;issue&nbsp;caused&nbsp;by&nbsp;badlock&nbsp;patch&nbsp;implementation.&lt;/div&gt;<br>
<br>
&lt;div&gt;Thanks&nbsp;for&nbsp;your&nbsp;assistance&nbsp;and&nbsp;sorry&nbsp;for&nbsp;my&nbsp;wrong&nbsp;mailing-list&nbsp;post,&nbsp;i&nbsp;should&nbsp;have&nbsp;check&nbsp;better&nbsp;the&nbsp;samba&nbsp;logs.&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
<br>
&lt;div&gt;Giulius.&lt;/div&gt;<br>
<br>
&lt;div&gt;&nbsp;<br>
&lt;div&nbsp;name=&quot;quote&quot;&nbsp;style=&quot;margin:10px&nbsp;5px&nbsp;5px&nbsp;10px;&nbsp;padding:&nbsp;10px&nbsp;0&nbsp;10px&nbsp;10px;&nbsp;border-left:2px&nbsp;solid&nbsp;#C3D9E5;&nbsp;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;<br>
&lt;div&nbsp;style=&quot;margin:0&nbsp;0&nbsp;10px&nbsp;0;&quot;&gt;&lt;b&gt;Sent:&lt;/b&gt;&nbsp;Saturday,&nbsp;September&nbsp;03,&nbsp;2016&nbsp;at&nbsp;4:43&nbsp;AM&lt;br/&gt;<br>
&lt;b&gt;From:&lt;/b&gt;&nbsp;&quot;Amos&nbsp;Jeffries&quot;&nbsp;&lt;squid3@treenet.co.nz&gt;&lt;br/&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;&quot;akn&nbsp;ab&quot;&nbsp;&lt;drcimino@mail.com&gt;,&nbsp;squid-users@lists.squid-cache.org&lt;br/&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[squid-users]&nbsp;Debugging&nbsp;NTLM&nbsp;problem&lt;/div&gt;<br>
<br>
&lt;div&nbsp;name=&quot;quoted-content&quot;&gt;On&nbsp;3/09/2016&nbsp;3:06&nbsp;a.m.,&nbsp;akn&nbsp;ab&nbsp;wrote:&lt;br/&gt;<br>
&gt;&nbsp;Hello&nbsp;Amos,&lt;br/&gt;<br>
&gt;&nbsp;auth_param&nbsp;ntlm&nbsp;keep_alive&nbsp;off&lt;br/&gt;<br>
&gt;&nbsp;unfortunately&nbsp;does&nbsp;not&nbsp;solve&nbsp;the&nbsp;problem.&lt;br/&gt;<br>
&gt;&nbsp;I&nbsp;did&nbsp;more&nbsp;investigation&nbsp;about&nbsp;the&nbsp;problem&nbsp;and&nbsp;i&nbsp;found&nbsp;informations.&lt;br/&gt;<br>
&gt;&nbsp;Every&nbsp;time&nbsp;a&nbsp;user&nbsp;get&nbsp;the&nbsp;browser&nbsp;popup&nbsp;requesting&nbsp;credentials,&nbsp;i&nbsp;found&nbsp;on&nbsp;squid&lt;br/&gt;<br>
&gt;&nbsp;log&nbsp;this&nbsp;event:&lt;br/&gt;<br>
&gt;&nbsp;Login&nbsp;for&nbsp;user&nbsp;[DOMAIN]&#92;[user]@[PC_XXXX]&nbsp;failed&nbsp;due&nbsp;to&nbsp;[Access&nbsp;denied]&lt;br/&gt;<br>
&gt;&nbsp;NTLMSSP&nbsp;BH:&nbsp;NT_STATUS_ACCESS_DENIED&lt;br/&gt;<br>
&gt;&nbsp;2016/09/02&nbsp;16:56:13&nbsp;kid1&#124;&nbsp;ERROR:&nbsp;NTLM&nbsp;Authentication&nbsp;validating&nbsp;user.&nbsp;Result:&lt;br/&gt;<br>
&gt;&nbsp;{result=BH,&nbsp;notes={message:&nbsp;NT_STATUS_ACCESS_DENIED;&nbsp;}}&lt;br/&gt;<br>
&lt;br/&gt;<br>
That&nbsp;is&nbsp;ntlm_auth&nbsp;(on&nbsp;behalf&nbsp;of&nbsp;AD)&nbsp;telling&nbsp;Squid&nbsp;the&nbsp;user&nbsp;credentials&lt;br/&gt;<br>
are&nbsp;not&nbsp;correct.&nbsp;There&nbsp;is&nbsp;no&nbsp;NTLM&nbsp;protocol&nbsp;problem.&lt;br/&gt;<br>
&lt;br/&gt;<br>
Consider&nbsp;this&nbsp;NT_STATUS_ACCESS_DENIED&nbsp;as&nbsp;if&nbsp;a&nbsp;user&nbsp;entered&nbsp;the&nbsp;wrong&lt;br/&gt;<br>
password.&nbsp;Why&nbsp;do&nbsp;you&nbsp;want&nbsp;to&nbsp;allow&nbsp;them&nbsp;access&nbsp;in&nbsp;that&nbsp;case?&lt;br/&gt;<br>
&lt;br/&gt;<br>
&lt;br/&gt;<br>
&gt;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to&nbsp;do&nbsp;more&nbsp;debug&nbsp;because&nbsp;i&nbsp;have&nbsp;9000&nbsp;concurrent&nbsp;connections,&nbsp;but&lt;br/&gt;<br>
&gt;&nbsp;if&nbsp;you&nbsp;think&nbsp;that&nbsp;can&nbsp;help&nbsp;me,&nbsp;i&nbsp;try&nbsp;to&nbsp;set&nbsp;debug_option&nbsp;to&nbsp;something&nbsp;like&nbsp;29,5&lt;br/&gt;<br>
&gt;&nbsp;Sometimes&nbsp;users&nbsp;left&nbsp;the&nbsp;office&nbsp;letting&nbsp;the&nbsp;browser&nbsp;open.&lt;br/&gt;<br>
&gt;&nbsp;After&nbsp;1&nbsp;hour&nbsp;(more&nbsp;or&nbsp;less),&nbsp;they&nbsp;return&nbsp;to&nbsp;the&nbsp;pc&nbsp;and&nbsp;popup&nbsp;show&nbsp;as&nbsp;soos&nbsp;as&lt;br/&gt;<br>
&gt;&nbsp;mouse&nbsp;point&nbsp;to&nbsp;a&nbsp;new&nbsp;link&nbsp;on&nbsp;the&nbsp;open&nbsp;browser.&lt;br/&gt;<br>
&gt;&nbsp;It&#39;s&nbsp;probably&nbsp;because&nbsp;something&nbsp;cached&nbsp;expire,&nbsp;but&nbsp;i&nbsp;cannot&nbsp;demostrate&nbsp;it&nbsp;so&lt;br/&gt;<br>
&gt;&nbsp;easily&nbsp;beceuse,&nbsp;as&nbsp;you&nbsp;said,&nbsp;ntlm&nbsp;never&nbsp;cache.&lt;br/&gt;<br>
&gt;&nbsp;On&nbsp;my&nbsp;samba/winbind&nbsp;logs&nbsp;i&nbsp;see&nbsp;many&lt;br/&gt;<br>
&gt;&nbsp;rpccli_netlogon_sam_network_logon:&nbsp;credentials&nbsp;chain&nbsp;check&nbsp;failed&lt;br/&gt;<br>
&gt;&nbsp;So&nbsp;it&#39;s&nbsp;very&nbsp;strange&nbsp;to&nbsp;understand&nbsp;if&nbsp;some&nbsp;problem&nbsp;occur&nbsp;beetween&nbsp;squid&nbsp;and&lt;br/&gt;<br>
&gt;&nbsp;browser&nbsp;or&nbsp;samba&nbsp;and&nbsp;Active&nbsp;Directory.&lt;br/&gt;<br>
&gt;&nbsp;What&nbsp;do&nbsp;you&nbsp;think&nbsp;about?&lt;br/&gt;<br>
&gt;&nbsp;Thanks.&lt;br/&gt;<br>
&gt;&nbsp;Giulius.&lt;br/&gt;<br>
&gt;&lt;br/&gt;<br>
&gt;&nbsp;On&nbsp;1/09/2016&nbsp;12:37&nbsp;a.m.,&nbsp;akn&nbsp;ab&nbsp;wrote:&lt;br/&gt;<br>
&gt;&nbsp;&gt;&nbsp;Dear&nbsp;all,&lt;br/&gt;<br>
&gt;&nbsp;&gt;&nbsp;i&#39;m&nbsp;facing&nbsp;a&nbsp;strange&nbsp;problem&nbsp;using&nbsp;squid&nbsp;3.5.20&nbsp;with&nbsp;ntlm&nbsp;transparent&lt;br/&gt;<br>
&gt;&nbsp;&gt;&nbsp;authentication.&lt;br/&gt;<br>
&gt;&nbsp;&gt;&nbsp;I&nbsp;cannot&nbsp;use&nbsp;kerberos&nbsp;auth&nbsp;because&nbsp;i&nbsp;need&nbsp;to&nbsp;pass&nbsp;DOMAIN&#92;user&nbsp;to&nbsp;my&nbsp;parent&nbsp;proxy&lt;br/&gt;<br>
&gt;&nbsp;&gt;&nbsp;with&nbsp;x-authenticated-user&nbsp;header,&nbsp;and&nbsp;the&nbsp;form&nbsp;USERNAME@DOMAIN&nbsp;is&nbsp;not&nbsp;supported.&lt;br/&gt;<br>
&lt;br/&gt;<br>
I&nbsp;suggest&nbsp;you&nbsp;use&nbsp;an&nbsp;external_acl_type&nbsp;helper&nbsp;that&nbsp;takes&nbsp;the&nbsp;%LOGIN&lt;br/&gt;<br>
format&nbsp;parameter&nbsp;and&nbsp;sends&nbsp;&#39;OK&nbsp;upstream_user_=&quot;...&quot;&nbsp;&#39;&nbsp;back&nbsp;to&nbsp;Squid.&nbsp;Use&lt;br/&gt;<br>
the&nbsp;%note{upstream_user_}&nbsp;in&nbsp;your&nbsp;request_header_add&nbsp;directive&nbsp;to&nbsp;send&lt;br/&gt;<br>
the&nbsp;right&nbsp;header&nbsp;value&nbsp;upstream.&lt;br/&gt;<br>
&lt;br/&gt;<br>
That&nbsp;will&nbsp;allow&nbsp;you&nbsp;to&nbsp;at&nbsp;least&nbsp;keep&nbsp;your&nbsp;part&nbsp;of&nbsp;the&nbsp;proxy&nbsp;chain&nbsp;using&lt;br/&gt;<br>
secure&nbsp;Negotiate&nbsp;authentication&nbsp;even&nbsp;though&nbsp;the&nbsp;parent&nbsp;proxy&nbsp;allows&lt;br/&gt;<br>
anyone&nbsp;to&nbsp;inject&nbsp;traffic&nbsp;spoofing&nbsp;your&nbsp;user&nbsp;accounts.&lt;br/&gt;<br>
&lt;br/&gt;<br>
Amos&lt;br/&gt;<br>
&nbsp;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<br>
<br>

</tt>
