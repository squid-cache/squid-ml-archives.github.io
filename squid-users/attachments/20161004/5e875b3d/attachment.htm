<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Finally&nbsp;I&#39;ve&nbsp;managed&nbsp;to&nbsp;go&nbsp;on&nbsp;&lt;a&nbsp;href=&quot;http://ftp.intel.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ftp.intel.com&lt;/a&gt;&nbsp;using&nbsp;FileZilla&nbsp;through&nbsp;my&nbsp;squid&nbsp;gateway&nbsp;in&nbsp;standart&nbsp;(proxy)&nbsp;mode.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Squid&nbsp;conf:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;ftp_port &nbsp;x.x.x.x &nbsp;2122&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Then&nbsp;I&nbsp;try&nbsp;to&nbsp;block&nbsp;FTP-Command&nbsp;and&nbsp;nothing&nbsp;happen.&nbsp;Some&nbsp;from&nbsp;my&nbsp;config:&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;rh&nbsp;req_header&nbsp;-i&nbsp;^FTP-Command&lt;/div&gt;http_access&nbsp;deny&nbsp;rh&lt;br&gt;&lt;/div&gt;http_access&nbsp;permit&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;br&gt;And&nbsp;also&nbsp;add&nbsp;following:&nbsp;&lt;br&gt;&lt;br&gt;request_header_access &nbsp;&quot;FTP-Command:&nbsp;LIST&quot;&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;Connect&nbsp;and&nbsp;browsing&nbsp;of&nbsp;remote&nbsp;&lt;a&nbsp;href=&quot;http://ftp.intel.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ftp.intel.com&lt;/a&gt;&nbsp;is &nbsp;OK&nbsp;-&nbsp;nothing&nbsp;blocked.&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;In&nbsp;squid&nbsp;log&nbsp;i&nbsp;see&nbsp;(fragment):&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2016/10/04&nbsp;15:23:04.177&nbsp;kid1|&nbsp;9,2|&nbsp;FtpServer.cc(495)&nbsp;writeReply:&nbsp;FTP&nbsp;Client&nbsp;REPLY:&lt;br&gt;---------&lt;br&gt;227&nbsp;Entering&nbsp;Passive&nbsp;Mode&nbsp;(192,168,33,254,230,30).&lt;br&gt;&lt;br&gt;----------&lt;br&gt;2016/10/04&nbsp;15:23:04.177&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(949)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable&lt;br&gt;2016/10/04&nbsp;15:23:04.177&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(949)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;33,2|&nbsp;FtpServer.cc(699)&nbsp;parseOneRequest:&nbsp;&gt;&gt;ftp&nbsp;LIST&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;9,2|&nbsp;FtpServer.cc(1320)&nbsp;handleRequest:&nbsp;FTP&nbsp;Client&nbsp;local=&lt;a&nbsp;href=&quot;http://192.168.33.254:2122&quot;&gt;192.168.33.254:2122&lt;/a&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://192.168.33.10:60838&quot;&gt;192.168.33.10:60838&lt;/a&gt;&nbsp;FD&nbsp;9&nbsp;flags=1&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;9,2|&nbsp;FtpServer.cc(1322)&nbsp;handleRequest:&nbsp;FTP&nbsp;Client&nbsp;REQUEST:&lt;br&gt;---------&lt;br&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;br&gt;FTP-Command:&nbsp;LIST&lt;br&gt;FTP-Arguments:&nbsp;&lt;br&gt;&lt;br&gt;----------&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(744)&nbsp;clientAccessCheckDone:&nbsp;The&nbsp;request&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&nbsp;is&nbsp;ALLOWED;&nbsp;last&nbsp;ACL&nbsp;checked:&nbsp;net33&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(720)&nbsp;clientAccessCheck2:&nbsp;No&nbsp;adapted_http_access&nbsp;configuration.&nbsp;default:&nbsp;ALLOW&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(744)&nbsp;clientAccessCheckDone:&nbsp;The&nbsp;request&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&nbsp;is&nbsp;ALLOWED;&nbsp;last&nbsp;ACL&nbsp;checked:&nbsp;net33&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;17,2|&nbsp;FwdState.cc(133)&nbsp;FwdState:&nbsp;Forwarding&nbsp;client&nbsp;request&nbsp;local=&lt;a&nbsp;href=&quot;http://192.168.33.254:2122&quot;&gt;192.168.33.254:2122&lt;/a&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://192.168.33.10:60838&quot;&gt;192.168.33.10:60838&lt;/a&gt;&nbsp;FD&nbsp;9&nbsp;flags=1,&nbsp;url=&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(258)&nbsp;peerSelectDnsPaths:&nbsp;Find&nbsp;IP&nbsp;destination&nbsp;for:&nbsp;&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&#39;&nbsp;via&nbsp;&lt;a&nbsp;href=&quot;http://ftp.intel.com&quot;&gt;ftp.intel.com&lt;/a&gt;&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(258)&nbsp;peerSelectDnsPaths:&nbsp;Find&nbsp;IP&nbsp;destination&nbsp;for:&nbsp;&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&#39;&nbsp;via&nbsp;&lt;a&nbsp;href=&quot;http://ftp.intel.com&quot;&gt;ftp.intel.com&lt;/a&gt;&lt;br&gt;2016/10/04&nbsp;15:23:04.178&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(280)&nbsp;peerSelectDnsPaths:&nbsp;Found&nbsp;sources&nbsp;for&nbsp;&#39;&lt;a&nbsp;href=&quot;ftp://ftp.intel.com/&quot;&gt;ftp://ftp.intel.com/&lt;/a&gt;&#39;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;I&nbsp;need&nbsp;to&nbsp;block&nbsp;FTP-Command:&nbsp;LIST&nbsp;(for&nbsp;example)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2016-10-03&nbsp;20:34&nbsp;GMT+03:00&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.&lt;wbr&gt;com&lt;/a&gt;&gt;&lt;/span&gt;:&lt;br&gt;&lt;blockquote&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&nbsp;class=&quot;gmail_quote&quot;&gt;Please&nbsp;ask&nbsp;these&nbsp;questions&nbsp;on&nbsp;squid-users...&lt;br&gt;<br>
&lt;span&gt;&lt;br&gt;<br>
On&nbsp;10/03/2016&nbsp;05:51&nbsp;AM,&nbsp;oleg&nbsp;gv&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Thanks,&nbsp;but&nbsp;problems&nbsp;still&nbsp;exist&nbsp;-&nbsp;FTP&nbsp;doesn&#39;t&nbsp;work&nbsp;through&nbsp;proxy.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;I&#39;ve&nbsp;set&nbsp;in&nbsp;proxy&lt;br&gt;<br>
&lt;/span&gt;&gt; &nbsp; &nbsp; ftp_port&nbsp;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.168.0.1:2121&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.1:2121&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.168.0.1:2121&quot;&nbsp;target=&quot;_blank&quot;&gt;http://192.168.0.1:2121&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;span&gt;&gt;&nbsp;2.&nbsp;set&nbsp;in&nbsp;client&nbsp;browser&nbsp;to&nbsp;use&nbsp;proxy&nbsp;for&nbsp;FTP&nbsp;on&nbsp;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.168.0.1:2121&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.1:2121&lt;/a&gt;&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;&lt;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.168.0.1:2121&quot;&nbsp;target=&quot;_blank&quot;&gt;http://192.168.0.1:2121&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;span&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;Trying&nbsp;to&nbsp;go&nbsp;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;ftp://ftp.intel.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ftp://ftp.intel.com&lt;/a&gt; &nbsp;and&nbsp;In&nbsp;log&nbsp;of&nbsp;squid&nbsp;i&nbsp;see:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;FTP&nbsp;Client&nbsp;REPLY:&lt;br&gt;<br>
&gt;&nbsp;---------&lt;br&gt;<br>
&gt;&nbsp;530&nbsp;Must&nbsp;login&nbsp;first&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;####&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Another&nbsp;variant:&nbsp;setup&nbsp;inerception&nbsp;ftp_proxy&nbsp;(with&nbsp;nat&nbsp;redirect)&nbsp;-&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;it&nbsp;also&nbsp;doesn&#39;nt&nbsp;work:&nbsp;last&nbsp;commands&nbsp;in&nbsp;log:&lt;br&gt;<br>
&gt;&nbsp;2016/10/03&nbsp;14:43:09.929&nbsp;kid1|&nbsp;9,2|&nbsp;FtpRelay.cc(733)&lt;br&gt;<br>
&gt;&nbsp;dataChannelConnected:&nbsp;connected&nbsp;FTP&nbsp;server&nbsp;data&nbsp;channel:&lt;br&gt;<br>
&gt;&nbsp;local=8x.xxx.xxx.xxx:41231&nbsp;remote=&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.198.164.82:36034&quot;&nbsp;target=&quot;_blank&quot;&gt;192.198.164.82:36034&lt;/a&gt;&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;&lt;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://192.198.164.82:36034&quot;&nbsp;target=&quot;_blank&quot;&gt;http://192.198.164.82:36034&lt;/a&gt;&gt;&nbsp;FD&nbsp;19&nbsp;flags=1&lt;br&gt;<br>
&lt;span&gt;&gt;&nbsp;2016/10/03&nbsp;14:43:09.929&nbsp;kid1|&nbsp;9,2|&nbsp;FtpClient.cc(791)&nbsp;writeCommand:&nbsp;ftp&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;LIST&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;2016/10/03&nbsp;14:43:10.125&nbsp;kid1|&nbsp;9,2|&nbsp;FtpClient.cc(1108)&nbsp;parseControlReply:&lt;br&gt;<br>
&gt;&nbsp;ftp&gt;&gt;&nbsp;125&nbsp;Data&nbsp;connection&nbsp;already&nbsp;open;&nbsp;Transfer&nbsp;starting.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;And&nbsp;ftp.intel&nbsp;com&nbsp;is&nbsp;hang,&nbsp;trying&nbsp;to&nbsp;open..&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;2016-10-01&nbsp;2:12&nbsp;GMT+03:00&nbsp;Alex&nbsp;Rousskov&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.&lt;wbr&gt;com&lt;/a&gt;&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;&lt;mailto:&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-f&lt;wbr&gt;actory.com&lt;/a&gt;&gt;&gt;:&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail-m_6503794103847508117gmail-m_6042727669406171417HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;gmail-m_6503794103847508117gmail-m_6042727669406171417h5&quot;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;09/30/2016&nbsp;10:42&nbsp;AM,&nbsp;oleg&nbsp;gv&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;Hello,&nbsp;I&#39;ve&nbsp;found&nbsp;that&nbsp;NativeFtpRelay&nbsp;appeared&nbsp;in&nbsp;squid&nbsp;3.5&nbsp;.&nbsp;Is&nbsp;it&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;possible&nbsp;to&nbsp;apply&nbsp;http-access&nbsp;acl&nbsp;for&nbsp;FTP&nbsp;proto&nbsp;concerning&nbsp;filtering&nbsp;of&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;FTP&nbsp;methods(commands)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Yes,&nbsp;it&nbsp;should&nbsp;be&nbsp;possible.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;by&nbsp;analogy&nbsp;of&nbsp;HTTP&nbsp;methods&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Not&nbsp;quite.&nbsp;IIRC,&nbsp;when&nbsp;the&nbsp;HTTP&nbsp;message&nbsp;representing&nbsp;the&nbsp;FTP&nbsp;transaction&lt;br&gt;<br>
&gt; &nbsp; &nbsp; is&nbsp;relayed&nbsp;through&nbsp;Squid,&nbsp;the&nbsp;FTP&nbsp;command&nbsp;name&nbsp;is&nbsp;_not_&nbsp;stored&nbsp;as&nbsp;an&lt;br&gt;<br>
&gt; &nbsp; &nbsp; HTTP&nbsp;method.&nbsp;The&nbsp;FTP&nbsp;command&nbsp;name&nbsp;is&nbsp;stored&nbsp;as&nbsp;HTTP&nbsp;&quot;FTP-Command&quot;&nbsp;header&lt;br&gt;<br>
&gt; &nbsp; &nbsp; value.&nbsp;See&nbsp;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://wiki.squid-cache.org/Features/FtpRelay&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/Fe&lt;wbr&gt;atures/FtpRelay&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;&lt;a&nbsp;rel=&quot;noreferrer&quot;&nbsp;href=&quot;http://wiki.squid-cache.org/Features/FtpRelay&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/&lt;wbr&gt;Features/FtpRelay&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; You&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;block&nbsp;FTP&nbsp;commands&nbsp;using&nbsp;a&nbsp;req_header&nbsp;ACL.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;what&nbsp;other&nbsp;possibilities&nbsp;in&nbsp;squid&nbsp;exist&nbsp;to&nbsp;do&nbsp;this&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; An&nbsp;ICAP&nbsp;or&nbsp;eCAP&nbsp;service&nbsp;can&nbsp;also&nbsp;filter&nbsp;relayed&nbsp;FTP&nbsp;messages.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Alex.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
