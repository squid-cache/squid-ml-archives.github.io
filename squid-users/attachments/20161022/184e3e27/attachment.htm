<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&gt;Excellent...glad&nbsp;it&nbsp;worked.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;James&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;Sat,&nbsp;2016-10-22&nbsp;at&nbsp;10:35&nbsp;-0300,&nbsp;Leandro&nbsp;Barragan&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;pre&gt;Thanks&nbsp;a&nbsp;lot&nbsp;James,&nbsp;compiling&nbsp;Squid&nbsp;3.5.22&nbsp;using&nbsp;that&nbsp;specific&nbsp;commit<br>
of&nbsp;LibreSSL&nbsp;worked&nbsp;as&nbsp;a&nbsp;charm!&nbsp;I&nbsp;no&nbsp;longer&nbsp;have&nbsp;that&nbsp;&quot;unknown&nbsp;cipher<br>
returned&quot;&nbsp;errors.&nbsp;I&nbsp;do&nbsp;have&nbsp;some&nbsp;errors&nbsp;with&nbsp;a&nbsp;tiny&nbsp;amount&nbsp;of&nbsp;sites,<br>
but&nbsp;I&nbsp;suppose&nbsp;its&nbsp;because&nbsp;of&nbsp;server-side&nbsp;misconfigurations&nbsp;that<br>
LibreSSL&nbsp;simply&nbsp;don't&nbsp;like.<br>
<br>
<br>
On&nbsp;21&nbsp;October&nbsp;2016&nbsp;at&nbsp;13:01,&nbsp;James&nbsp;Lay&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jlay@slave-tothe-box.net&quot;&gt;jlay@slave-tothe-box.net&lt;/a&gt;&gt;&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
On&nbsp;2016-10-21&nbsp;09:58,&nbsp;Leandro&nbsp;Barragan&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
James,&nbsp;thanks&nbsp;for&nbsp;your&nbsp;advice!&nbsp;I've&nbsp;read&nbsp;your&nbsp;email&nbsp;on&nbsp;this&nbsp;list&nbsp;about<br>
LibreSSL.&nbsp;I&nbsp;tried&nbsp;to&nbsp;compile&nbsp;Squid&nbsp;with&nbsp;LibreSSL&nbsp;in&nbsp;the&nbsp;first&nbsp;place<br>
because&nbsp;of&nbsp;what&nbsp;you&nbsp;wrote&nbsp;about&nbsp;ChaCha20.&nbsp;But&nbsp;unfortunately,&nbsp;I<br>
couldn't,&nbsp;compilation&nbsp;stopped&nbsp;because&nbsp;of&nbsp;some&nbsp;obscure&nbsp;error.<br>
<br>
Do&nbsp;you&nbsp;remember&nbsp;what&nbsp;version&nbsp;of&nbsp;squid&nbsp;and&nbsp;libressl&nbsp;you&nbsp;used?&nbsp;BTW&nbsp;I<br>
tried&nbsp;with&nbsp;OpenSSL&nbsp;1.0.2g&nbsp;applying&nbsp;the&nbsp;CloudFare&nbsp;ChaCha20&nbsp;patch,&nbsp;but<br>
it&nbsp;doesn't&nbsp;work&nbsp;either,&nbsp;same&nbsp;error&nbsp;(unknown&nbsp;cipher)<br>
<br>
Thanks!<br>
<br>
On&nbsp;21&nbsp;October&nbsp;2016&nbsp;at&nbsp;10:55,&nbsp;James&nbsp;Lay&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jlay@slave-tothe-box.net&quot;&gt;jlay@slave-tothe-box.net&lt;/a&gt;&gt;&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
On&nbsp;2016-10-20&nbsp;20:15,&nbsp;Leandro&nbsp;Barragan&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
<br>
Thanks&nbsp;for&nbsp;your&nbsp;time&nbsp;Alex!&nbsp;I&nbsp;modified&nbsp;my&nbsp;original&nbsp;config&nbsp;based&nbsp;on&nbsp;Amos<br>
recommendations,&nbsp;so&nbsp;I&nbsp;think&nbsp;now&nbsp;I&nbsp;have&nbsp;a&nbsp;more&nbsp;consistent&nbsp;peek&nbsp;&amp;&nbsp;splice<br>
config:<br>
<br>
&nbsp;acl&nbsp;TF&nbsp;ssl::server_name_regex&nbsp;-i&nbsp;facebook&nbsp;fbcdn&nbsp;twitter&nbsp;reddit<br>
&nbsp;ssl_bump&nbsp;peek&nbsp;all<br>
&nbsp;ssl_bump&nbsp;terminate&nbsp;TF<br>
&nbsp;ssl_bump&nbsp;splice&nbsp;all<br>
<br>
As&nbsp;you&nbsp;mentioned,&nbsp;terminate&nbsp;closes&nbsp;the&nbsp;connection,&nbsp;it&nbsp;doesn't&nbsp;serve&nbsp;an<br>
error&nbsp;page&nbsp;(when&nbsp;it&nbsp;works,&nbsp;i.e.&nbsp;with&nbsp;reddit&nbsp;and&nbsp;twitter).<br>
<br>
I've&nbsp;compiled&nbsp;Squid&nbsp;3.5.22&nbsp;using&nbsp;OpenSSL&nbsp;1.0.2j&nbsp;and&nbsp;I'm&nbsp;having&nbsp;the<br>
same&nbsp;exact&nbsp;issue,&nbsp;even&nbsp;with&nbsp;this&nbsp;new&nbsp;config.&nbsp;Based&nbsp;on&nbsp;what&nbsp;you<br>
explained,&nbsp;I&nbsp;think&nbsp;it's&nbsp;a&nbsp;OpenSSL&nbsp;problem&nbsp;and&nbsp;Squid&nbsp;can't&nbsp;do&nbsp;anything<br>
about&nbsp;it.&nbsp;I&nbsp;have&nbsp;two&nbsp;reasons&nbsp;to&nbsp;believe&nbsp;that:<br>
<br>
1)&nbsp;The&nbsp;&quot;unknown&nbsp;cipher&nbsp;returned&quot;&nbsp;error&nbsp;get's&nbsp;triggered&nbsp;on&nbsp;terminated<br>
and&nbsp;non&nbsp;terminated&nbsp;(e.g.&nbsp;microsoft.com)&nbsp;sites,&nbsp;which&nbsp;makes&nbsp;me&nbsp;think&nbsp;it<br>
has&nbsp;nothing&nbsp;to&nbsp;do&nbsp;with&nbsp;Squid&nbsp;ACLs.<br>
2)&nbsp;All&nbsp;problematic&nbsp;sites&nbsp;use&nbsp;a&nbsp;new&nbsp;cipher&nbsp;called&nbsp;&quot;ChaCha20&quot;&nbsp;(E.g.<br>
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256....according&nbsp;to&nbsp;Qualys<br>
online&nbsp;analyzer&nbsp;and&nbsp;TestSSLServer&nbsp;tool)<br>
<br>
A&nbsp;lot&nbsp;of&nbsp;sites&nbsp;are&nbsp;using&nbsp;this&nbsp;new&nbsp;cipher.&nbsp;I'm&nbsp;back&nbsp;at&nbsp;the&nbsp;beginning,&nbsp;I<br>
will&nbsp;continue&nbsp;trying&nbsp;to&nbsp;compile&nbsp;Squid&nbsp;with&nbsp;patched&nbsp;versions&nbsp;of&nbsp;OpenSSL<br>
or&nbsp;LibreSSL.<br>
<br>
Thanks!<br>
<br>
On&nbsp;20&nbsp;October&nbsp;2016&nbsp;at&nbsp;01:01,&nbsp;Alex&nbsp;Rousskov<br>
&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
<br>
On&nbsp;10/19/2016&nbsp;12:44&nbsp;AM,&nbsp;Leandro&nbsp;Barragan&nbsp;wrote:<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
error:140920F8:SSL&nbsp;routines:SSL3_GET_SERVER_HELLO:unknown&nbsp;cipher<br>
returned&nbsp;(1/-1/0)<br>
&lt;/blockquote&gt;<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
I&nbsp;fail&nbsp;to&nbsp;see&nbsp;why&nbsp;is&nbsp;this&nbsp;happening.&nbsp;I&nbsp;only&nbsp;need&nbsp;to&nbsp;peek&nbsp;on&nbsp;the<br>
connection&nbsp;and&nbsp;make&nbsp;a&nbsp;decision&nbsp;based&nbsp;on&nbsp;SNI,<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
Please&nbsp;note&nbsp;that&nbsp;&quot;peek&nbsp;and&nbsp;make&nbsp;a&nbsp;decision&nbsp;based&nbsp;on&nbsp;SNI&quot;&nbsp;is&nbsp;not&nbsp;what<br>
your&nbsp;configuration&nbsp;tells&nbsp;Squid&nbsp;to&nbsp;do.&nbsp;Your&nbsp;configuration&nbsp;tells&nbsp;Squid&nbsp;to<br>
peek&nbsp;during&nbsp;step2,&nbsp;which&nbsp;means&nbsp;making&nbsp;a&nbsp;decision&nbsp;based&nbsp;on&nbsp;server<br>
certificates&nbsp;(and&nbsp;SNI).<br>
<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
I'm&nbsp;not&nbsp;Bumping,&nbsp;so&nbsp;I<br>
don't&nbsp;understand&nbsp;why&nbsp;ciphers&nbsp;matter&nbsp;in&nbsp;my&nbsp;situation.<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
The&nbsp;ciphers&nbsp;matter&nbsp;because&nbsp;Squid&nbsp;v3&nbsp;uses&nbsp;OpenSSL&nbsp;parsers&nbsp;during&nbsp;step1,<br>
step2,&nbsp;and&nbsp;step3.&nbsp;FWIW,&nbsp;Squid&nbsp;v4&nbsp;uses&nbsp;OpenSSL&nbsp;parsers&nbsp;during&nbsp;step2&nbsp;(a<br>
little)&nbsp;and&nbsp;step3.&nbsp;It&nbsp;is&nbsp;possible&nbsp;to&nbsp;completely&nbsp;remove&nbsp;OpenSSL&nbsp;from<br>
step2&nbsp;but&nbsp;there&nbsp;is&nbsp;currently&nbsp;no&nbsp;project&nbsp;to&nbsp;do&nbsp;that&nbsp;AFAIK.<br>
<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
ssl_bump&nbsp;peek&nbsp;all&nbsp;step1<br>
ssl_bump&nbsp;peek&nbsp;all&nbsp;step2<br>
ssl_bump&nbsp;terminate&nbsp;face&nbsp;step3<br>
ssl_bump&nbsp;terminate&nbsp;twitter&nbsp;step3<br>
ssl_bump&nbsp;splice&nbsp;all&nbsp;step3<br>
&lt;/blockquote&gt;<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
BTW,&nbsp;&quot;step1&quot;,&nbsp;&quot;step2&quot;,&nbsp;and&nbsp;&quot;step3&quot;&nbsp;ACLs&nbsp;do&nbsp;nothing&nbsp;useful&nbsp;in&nbsp;the&nbsp;above<br>
config.&nbsp;You&nbsp;can&nbsp;safely&nbsp;remove&nbsp;them&nbsp;to&nbsp;arrive&nbsp;at&nbsp;the&nbsp;equivalent&nbsp;ssl_bump<br>
configuration.<br>
<br>
<br>
On&nbsp;10/19/2016&nbsp;07:42&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
<br>
Terminate&nbsp;means&nbsp;impersonating&nbsp;the&nbsp;server&nbsp;and&nbsp;responding&nbsp;to&nbsp;the&nbsp;client<br>
with&nbsp;an&nbsp;HTTPS&nbsp;error&nbsp;page.<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
Terminate&nbsp;means&nbsp;&quot;close&nbsp;client&nbsp;and&nbsp;server&nbsp;connections&nbsp;immediately&quot;.&nbsp;The<br>
problem&nbsp;is&nbsp;not&nbsp;with&nbsp;the&nbsp;terminate&nbsp;action&nbsp;but&nbsp;with&nbsp;peeking&nbsp;(which&nbsp;relies<br>
on&nbsp;OpenSSL,&nbsp;especially&nbsp;during&nbsp;step2,&nbsp;especially&nbsp;in&nbsp;Squid&nbsp;v3).<br>
<br>
<br>
HTH,<br>
<br>
Alex.<br>
&lt;/blockquote&gt;<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
FWIW&nbsp;I've&nbsp;had&nbsp;great&nbsp;success&nbsp;with&nbsp;the&nbsp;git&nbsp;version&nbsp;of&nbsp;libressl&nbsp;and&nbsp;using<br>
the<br>
below:<br>
<br>
./configure&nbsp;--prefix=/opt/libressl<br>
<br>
and&nbsp;for&nbsp;squid:<br>
<br>
./configure&nbsp;--prefix=/opt&nbsp;--with-openssl=/opt/libressl&nbsp;--enable-ssl<br>
--enable-ssl-crtd<br>
<br>
James<br>
&lt;/blockquote&gt;<br>
&lt;/blockquote&gt;<br>
<br>
<br>
I'm&nbsp;currently&nbsp;using&nbsp;squid-3.5.22&nbsp;and&nbsp;using&nbsp;the&nbsp;below&nbsp;git&nbsp;for&nbsp;libressl:<br>
<br>
commit&nbsp;b7ba692f72f232602efb3e720ab0510406bae69c<br>
Author:&nbsp;Brent&nbsp;Cook&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:bcook@openbsd.org&quot;&gt;bcook@openbsd.org&lt;/a&gt;&gt;<br>
Date:&nbsp;&nbsp;&nbsp;Wed&nbsp;Sep&nbsp;14&nbsp;23:40:10&nbsp;2016&nbsp;-0500<br>
<br>
What's&nbsp;the&nbsp;error&nbsp;you're&nbsp;getting&nbsp;when&nbsp;you&nbsp;try&nbsp;and&nbsp;compile?<br>
<br>
<br>
James<br>
_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;<br>
&lt;/blockquote&gt;&lt;/pre&gt;&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
