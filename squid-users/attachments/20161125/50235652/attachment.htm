<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&nbsp;&quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;&gt;<br>
&lt;html&gt;&lt;body&nbsp;id=&quot;punymce&quot;&gt;Hello&lt;br&gt;I'm&nbsp;looking&nbsp;solutions&nbsp;of&nbsp;my&nbsp;problem&nbsp;but&nbsp;I&nbsp;can't&nbsp;find.&lt;br&gt;I&nbsp;have&nbsp;Squid&nbsp;+&nbsp;dansguardian&nbsp;installation&nbsp;as&nbsp;transparent&nbsp;proxy&nbsp;and&nbsp;in&nbsp;this&nbsp;configuration&nbsp;must&nbsp;be&nbsp;something&nbsp;wrong.&nbsp;This&nbsp;is&nbsp;a&nbsp;Debian&nbsp;7&nbsp;and&nbsp;working&nbsp;in&nbsp;local&nbsp;network&nbsp;as&nbsp;router&nbsp;(local&nbsp;address&nbsp;10.0.0.4,&nbsp;10.99.0.1).&lt;br&gt;&lt;br&gt;In&nbsp;dansguardian&nbsp;log&nbsp;file&nbsp;I&nbsp;have&nbsp;good&nbsp;IP&nbsp;client&nbsp;address,&nbsp;but&nbsp;in&nbsp;squid&nbsp;log&nbsp;file&nbsp;this&nbsp;address&nbsp;is&nbsp;equal&nbsp;to&nbsp;the&nbsp;router&nbsp;address&nbsp;(10.0.0.4).&lt;br&gt;&lt;br&gt;#&nbsp;tailf&nbsp;/var/log/dansguardian/access.log&lt;br&gt;2016.11.25&nbsp;13:52:16&nbsp;-&nbsp;10.99.0.98&nbsp;&lt;a&nbsp;href=&quot;http://businessclick.b...&quot;&nbsp;mce_href=&quot;http://businessclick.b...&quot;&gt;http://businessclick.b...&lt;/a&gt;&lt;br&gt;&lt;br&gt;10.99.0.98&nbsp;is&nbsp;real&nbsp;client&nbsp;address&lt;br&gt;&lt;br&gt;~#&nbsp;tailf&nbsp;/var/log/squid/access.log&lt;br&gt;25/Nov/2016:13:34:08&nbsp;+0100&nbsp;1480077248.293&nbsp;170&nbsp;10.0.0.4&nbsp;10.0.0.4&nbsp;TCP_MISS/200&nbsp;1004&nbsp;POST&nbsp;&lt;a&nbsp;href=&quot;http://ocsp.digic...&quot;&nbsp;mce_href=&quot;http://ocsp.digic...&quot;&gt;http://ocsp.digic...&lt;/a&gt;&lt;br&gt;&lt;br&gt;10.0.0.4&nbsp;is&nbsp;not&nbsp;a&nbsp;real&nbsp;client&nbsp;address,&nbsp;it's&nbsp;look&nbsp;like&nbsp;dansguardian&nbsp;IP.Â &nbsp;Second&nbsp;address&nbsp;is&nbsp;a&nbsp;'%&gt;a'&nbsp;parameter,&nbsp;I&nbsp;try&nbsp;also&nbsp;with&nbsp;'%&gt;A'&lt;br&gt;&lt;br&gt;I&nbsp;try&nbsp;change&nbsp;squid&nbsp;and&nbsp;dansguardian&nbsp;listen&nbsp;address&nbsp;to&nbsp;0.0.0.0&nbsp;but&nbsp;this&nbsp;not&nbsp;help.&nbsp;I&nbsp;don't&nbsp;know&nbsp;what&nbsp;is&nbsp;the&nbsp;reason&nbsp;of&nbsp;that.&nbsp;I&nbsp;have&nbsp;same&nbsp;older&nbsp;installation&nbsp;in&nbsp;Debian&nbsp;6&nbsp;and&nbsp;there&nbsp;it&nbsp;works&nbsp;fine.&lt;br&gt;&lt;br&gt;My&nbsp;clients&nbsp;is:&lt;br&gt;&nbsp;10.0.0.0/24&lt;br&gt;&nbsp;10.99.0.0/24&lt;br&gt;&lt;br&gt;&lt;br&gt;#&nbsp;squid&nbsp;-v&lt;br&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;2.7.STABLE9&lt;br&gt;configure&nbsp;options:&nbsp;&nbsp;'--prefix=/usr'&nbsp;'--exec_prefix=/usr'&nbsp;'--bindir=/usr/sbin'&nbsp;'--sbindir=/usr/sbin'&nbsp;'--libexecdir=/usr/lib/squid'&nbsp;'--sysconfdir=/etc/squid'&nbsp;'--localstatedir=/var/spool/squid'&nbsp;'--datadir=/usr/share/squid'&nbsp;'--with-pthreads'&nbsp;'--enable-async-io'&nbsp;'--enable-storeio=ufs,aufs,coss,diskd,null'&nbsp;'--enable-linux-netfilter'&nbsp;'--enable-arp-acl'&nbsp;'--enable-epoll'&nbsp;'--enable-removal-policies=lru,heap'&nbsp;'--enable-snmp'&nbsp;'--enable-delay-pools'&nbsp;'--enable-htcp'&nbsp;'--enable-cache-digests'&nbsp;'--enable-referer-log'&nbsp;'--enable-useragent-log'&nbsp;'--enable-auth=basic,digest,ntlm,negotiate'&nbsp;'--enable-negotiate-auth-helpers=squid_kerb_auth'&nbsp;'--enable-carp'&nbsp;'--enable-follow-x-forwarded-for'&nbsp;'--with-large-files'&nbsp;'--with-maxfd=65536'&nbsp;'--build'&nbsp;'x86_64-linux-gnu'&nbsp;'build_alias=x86_64-linux-gnu'&lt;br&gt;&lt;br&gt;&lt;br&gt;#&nbsp;dansguardian&nbsp;-v&lt;br&gt;DansGuardian&nbsp;2.10.1.1&lt;br&gt;Built&nbsp;with:&nbsp;&nbsp;'--prefix=/usr'&nbsp;'--enable-clamav=yes'&nbsp;'--enable-clamd=yes'&nbsp;'--with-proxyuser=dansguardian'&nbsp;'--with-proxygroup=dansguardian'&nbsp;'--sysconfdir=/etc'&nbsp;'--localstatedir=/var'&nbsp;'--enable-icap=yes'&nbsp;'--enable-commandline=yes'&nbsp;'--enable-email=yes'&nbsp;'--enable-ntlm=yes'&nbsp;'--enable-trickledm=yes'&nbsp;'--mandir=${prefix}/share/man'&nbsp;'--infodir=${prefix}/share/info'&nbsp;'CXXFLAGS=-g&nbsp;-O2&nbsp;-fstack-protector&nbsp;--param=ssp-buffer-size=4&nbsp;-Wformat&nbsp;-Werror=format-security'&nbsp;'LDFLAGS=-Wl,-z,relro'&nbsp;'CPPFLAGS=-D_FORTIFY_SOURCE=2'&nbsp;'CFLAGS=-g&nbsp;-O2&nbsp;-fstack-protector&nbsp;--param=ssp-buffer-size=4&nbsp;-Wformat&nbsp;-Werror=format-security'&lt;br&gt;&lt;br&gt;&lt;br&gt;~#&nbsp;netstat&nbsp;-ntlp&lt;br&gt;Active&nbsp;Internet&nbsp;connections&nbsp;(only&nbsp;servers)&lt;br&gt;Proto&nbsp;Recv-Q&nbsp;Send-Q&nbsp;Local&nbsp;Address&nbsp;Foreign&nbsp;Address&nbsp;State&nbsp;PID/Program&nbsp;name&lt;br&gt;...&lt;br&gt;tcp&nbsp;0&nbsp;0&nbsp;10.99.0.1:8080&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;8478/dansguardian&lt;br&gt;tcp&nbsp;0&nbsp;0&nbsp;10.0.0.4:8080&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;8478/dansguardian&lt;br&gt;...&lt;br&gt;tcp&nbsp;0&nbsp;0&nbsp;10.99.0.1:3128&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;9952/(squid)&lt;br&gt;tcp&nbsp;0&nbsp;0&nbsp;10.0.0.4:3128&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;9952/(squid)&lt;br&gt;...&lt;br&gt;&lt;br&gt;&lt;br&gt;#&nbsp;grep&nbsp;-v&nbsp;'^$\|^\s*\#'&nbsp;/etc/squid/squid.conf&lt;br&gt;acl&nbsp;all&nbsp;src&nbsp;0.0.0.0/0.0.0.0&lt;br&gt;acl&nbsp;manager&nbsp;proto&nbsp;cache_object&lt;br&gt;acl&nbsp;localhost&nbsp;src&nbsp;127.0.0.1/32&lt;br&gt;acl&nbsp;to_localhost&nbsp;dst&nbsp;127.0.0.0/8&lt;br&gt;acl&nbsp;LAN&nbsp;src&nbsp;10.0.0.0/24&lt;br&gt;acl&nbsp;LAN2&nbsp;src&nbsp;10.99.0.0/24&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http&lt;br&gt;acl&nbsp;purge&nbsp;method&nbsp;PURGE&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;http_access&nbsp;allow&nbsp;LAN&lt;br&gt;http_access&nbsp;allow&nbsp;LAN2&lt;br&gt;http_access&nbsp;allow&nbsp;manager&nbsp;localhost&lt;br&gt;http_access&nbsp;deny&nbsp;manager&lt;br&gt;http_access&nbsp;allow&nbsp;purge&nbsp;localhost&lt;br&gt;http_access&nbsp;deny&nbsp;purge&lt;br&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;http_access&nbsp;deny&nbsp;all&lt;br&gt;icp_access&nbsp;deny&nbsp;all&lt;br&gt;follow_x_forwarded_for&nbsp;allow&nbsp;localhost&lt;br&gt;http_port&nbsp;10.0.0.4:3128&nbsp;transparent&lt;br&gt;http_port&nbsp;10.99.0.1:3128&nbsp;transparent&lt;br&gt;tcp_outgoing_address&nbsp;79.188.96.14&lt;br&gt;hierarchy_stoplist&nbsp;cgi-bin&nbsp;?&lt;br&gt;cache_mem&nbsp;64&nbsp;MB&lt;br&gt;cache_dir&nbsp;ufs&nbsp;/tmp/squid&nbsp;100&nbsp;16&nbsp;256&lt;br&gt;logformat&nbsp;squid&nbsp;%tl&nbsp;%ts.%03tu&nbsp;%6tr&nbsp;%la&nbsp;%&gt;a&nbsp;%Ss/%03Hs&nbsp;%&lt;st&nbsp;%rm&nbsp;%ru&nbsp;%un&nbsp;%Sh/%&lt;A&nbsp;%mt&nbsp;&quot;%{User-Agent}&gt;h&quot;&lt;br&gt;access_log&nbsp;/var/log/squid/access.log&nbsp;squid&lt;br&gt;refresh_pattern&nbsp;^ftp:&nbsp;1440&nbsp;20%&nbsp;10080&lt;br&gt;refresh_pattern&nbsp;^gopher:&nbsp;1440&nbsp;0%&nbsp;1440&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;0%&nbsp;0&lt;br&gt;refresh_pattern&nbsp;(Release|Packages(.gz)*)$&nbsp;0&nbsp;20%&nbsp;2880&lt;br&gt;refresh_pattern&nbsp;.&nbsp;0&nbsp;20%&nbsp;4320&lt;br&gt;acl&nbsp;shoutcast&nbsp;rep_header&nbsp;X-HTTP09-First-Line&nbsp;^ICY.[0-9]&lt;br&gt;upgrade_http0.9&nbsp;deny&nbsp;shoutcast&lt;br&gt;acl&nbsp;apache&nbsp;rep_header&nbsp;Server&nbsp;^Apache&lt;br&gt;broken_vary_encoding&nbsp;allow&nbsp;apache&lt;br&gt;extension_methods&nbsp;REPORT&nbsp;MERGE&nbsp;MKACTIVITY&nbsp;CHECKOUT&lt;br&gt;hosts_file&nbsp;/etc/hosts&lt;br&gt;coredump_dir&nbsp;/tmp/squid&lt;br&gt;&lt;br&gt;&lt;br&gt;#&nbsp;grep&nbsp;-v&nbsp;'^$\|^\s*\#'&nbsp;/etc/dansguardian/dansguardian.conf&lt;br&gt;reportinglevel&nbsp;=&nbsp;3&lt;br&gt;languagedir&nbsp;=&nbsp;'/etc/dansguardian/languages'&lt;br&gt;language&nbsp;=&nbsp;'polish'&lt;br&gt;loglevel&nbsp;=&nbsp;2&lt;br&gt;logexceptionhits&nbsp;=&nbsp;2&lt;br&gt;logfileformat&nbsp;=&nbsp;1&lt;br&gt;filterip&nbsp;=&nbsp;10.0.0.4&lt;br&gt;filterip&nbsp;=&nbsp;10.99.0.1&lt;br&gt;filterport&nbsp;=&nbsp;8080&lt;br&gt;proxyip&nbsp;=&nbsp;10.0.0.4&lt;br&gt;proxyip&nbsp;=&nbsp;10.99.0.1&lt;br&gt;proxyport&nbsp;=&nbsp;3128&lt;br&gt;accessdeniedaddress&nbsp;=&nbsp;'&lt;a&nbsp;href=&quot;http://YOURSERVER.YOURDOMAIN/cgi-bin/dansguardian.pl'&quot;&nbsp;mce_href=&quot;http://YOURSERVER.YOURDOMAIN/cgi-bin/dansguardian.pl'&quot;&gt;http://YOURSERVER.YOURDOMAIN/cgi-bin/dansguardian.pl'&lt;/a&gt;&lt;br&gt;nonstandarddelimiter&nbsp;=&nbsp;on&lt;br&gt;usecustombannedimage&nbsp;=&nbsp;on&lt;br&gt;custombannedimagefile&nbsp;=&nbsp;'/usr/share/dansguardian/transparent1x1.gif'&lt;br&gt;filtergroups&nbsp;=&nbsp;1&lt;br&gt;filtergroupslist&nbsp;=&nbsp;'/etc/dansguardian/lists/filtergroupslist'&lt;br&gt;bannediplist&nbsp;=&nbsp;'/etc/dansguardian/lists/bannediplist'&lt;br&gt;exceptioniplist&nbsp;=&nbsp;'/etc/dansguardian/lists/exceptioniplist'&lt;br&gt;showweightedfound&nbsp;=&nbsp;on&lt;br&gt;weightedphrasemode&nbsp;=&nbsp;2&lt;br&gt;urlcachenumber&nbsp;=&nbsp;1000&lt;br&gt;urlcacheage&nbsp;=&nbsp;900&lt;br&gt;scancleancache&nbsp;=&nbsp;on&lt;br&gt;phrasefiltermode&nbsp;=&nbsp;2&lt;br&gt;preservecase&nbsp;=&nbsp;0&lt;br&gt;hexdecodecontent&nbsp;=&nbsp;off&lt;br&gt;forcequicksearch&nbsp;=&nbsp;off&lt;br&gt;reverseaddresslookups&nbsp;=&nbsp;off&lt;br&gt;reverseclientiplookups&nbsp;=&nbsp;off&lt;br&gt;logclienthostnames&nbsp;=&nbsp;off&lt;br&gt;createlistcachefiles&nbsp;=&nbsp;on&lt;br&gt;maxuploadsize&nbsp;=&nbsp;-1&lt;br&gt;maxcontentfiltersize&nbsp;=&nbsp;256&lt;br&gt;maxcontentramcachescansize&nbsp;=&nbsp;2000&lt;br&gt;maxcontentfilecachescansize&nbsp;=&nbsp;20000&lt;br&gt;filecachedir&nbsp;=&nbsp;'/tmp'&lt;br&gt;deletedownloadedtempfiles&nbsp;=&nbsp;on&lt;br&gt;initialtrickledelay&nbsp;=&nbsp;20&lt;br&gt;trickledelay&nbsp;=&nbsp;10&lt;br&gt;downloadmanager&nbsp;=&nbsp;'/etc/dansguardian/downloadmanagers/fancy.conf'&lt;br&gt;downloadmanager&nbsp;=&nbsp;'/etc/dansguardian/downloadmanagers/default.conf'&lt;br&gt;contentscannertimeout&nbsp;=&nbsp;60&lt;br&gt;contentscanexceptions&nbsp;=&nbsp;off&lt;br&gt;recheckreplacedurls&nbsp;=&nbsp;off&lt;br&gt;forwardedfor&nbsp;=&nbsp;off&lt;br&gt;usexforwardedfor&nbsp;=&nbsp;off&lt;br&gt;logconnectionhandlingerrors&nbsp;=&nbsp;on&lt;br&gt;logchildprocesshandling&nbsp;=&nbsp;off&lt;br&gt;maxchildren&nbsp;=&nbsp;120&lt;br&gt;minchildren&nbsp;=&nbsp;8&lt;br&gt;minsparechildren&nbsp;=&nbsp;4&lt;br&gt;preforkchildren&nbsp;=&nbsp;6&lt;br&gt;maxsparechildren&nbsp;=&nbsp;32&lt;br&gt;maxagechildren&nbsp;=&nbsp;500&lt;br&gt;maxips&nbsp;=&nbsp;0&lt;br&gt;ipcfilename&nbsp;=&nbsp;'/tmp/.dguardianipc'&lt;br&gt;urlipcfilename&nbsp;=&nbsp;'/tmp/.dguardianurlipc'&lt;br&gt;ipipcfilename&nbsp;=&nbsp;'/tmp/.dguardianipipc'&lt;br&gt;nodaemon&nbsp;=&nbsp;off&lt;br&gt;nologger&nbsp;=&nbsp;off&lt;br&gt;logadblocks&nbsp;=&nbsp;off&lt;br&gt;loguseragent&nbsp;=&nbsp;off&lt;br&gt;softrestart&nbsp;=&nbsp;off&lt;br&gt;mailer&nbsp;=&nbsp;'/usr/sbin/sendmail&nbsp;-t'&lt;br&gt;&lt;br&gt;&lt;br&gt;#&nbsp;iptables&nbsp;-L&nbsp;-nv&nbsp;-t&nbsp;nat&lt;br&gt;Chain&nbsp;PREROUTING&nbsp;(policy&nbsp;ACCEPT&nbsp;51435&nbsp;packets,&nbsp;3996K&nbsp;bytes)&lt;br&gt;Â pkts&nbsp;bytes&nbsp;targetÂ Â Â Â &nbsp;prot&nbsp;opt&nbsp;inÂ Â Â Â &nbsp;outÂ Â Â Â &nbsp;sourceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â &nbsp;destination&lt;br&gt;11951Â <br>
&nbsp;590K&nbsp;REDIRECTÂ Â &nbsp;tcpÂ &nbsp;--Â &nbsp;*Â Â Â Â Â &nbsp;*Â Â Â Â Â Â &nbsp;10.0.0.0/24Â Â Â Â Â Â Â Â Â &nbsp;<br>
0.0.0.0/0Â Â Â Â Â Â Â Â Â Â Â &nbsp;tcp&nbsp;dpt:80flags:&nbsp;0x17/0x02&nbsp;state&nbsp;NEW&nbsp;redir&nbsp;ports&nbsp;<br>
8080&lt;br&gt;Â 8453Â &nbsp;425K&nbsp;REDIRECTÂ Â &nbsp;tcpÂ &nbsp;--Â &nbsp;*Â Â Â Â Â &nbsp;*Â Â Â Â Â Â &nbsp;<br>
10.99.0.0/24Â Â Â Â Â Â Â Â &nbsp;0.0.0.0/0Â Â Â Â Â Â Â Â Â Â Â &nbsp;tcp&nbsp;dpt:80flags:&nbsp;0x17/0x02&nbsp;<br>
state&nbsp;NEW&nbsp;redir&nbsp;ports&nbsp;8080&lt;br&gt;&lt;br&gt;Chain&nbsp;INPUT&nbsp;(policy&nbsp;ACCEPT&nbsp;57817&nbsp;packets,&nbsp;3748K&nbsp;bytes)&lt;br&gt;Â pkts&nbsp;bytes&nbsp;targetÂ Â Â Â &nbsp;prot&nbsp;opt&nbsp;inÂ Â Â Â &nbsp;outÂ Â Â Â &nbsp;sourceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â &nbsp;destination&lt;br&gt;&lt;br&gt;Chain&nbsp;OUTPUT&nbsp;(policy&nbsp;ACCEPT&nbsp;54832&nbsp;packets,&nbsp;3473K&nbsp;bytes)&lt;br&gt;Â pkts&nbsp;bytes&nbsp;targetÂ Â Â Â &nbsp;prot&nbsp;opt&nbsp;inÂ Â Â Â &nbsp;outÂ Â Â Â &nbsp;sourceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â &nbsp;destination&lt;br&gt;&lt;br&gt;Chain&nbsp;POSTROUTING&nbsp;(policy&nbsp;ACCEPT&nbsp;21292&nbsp;packets,&nbsp;1338K&nbsp;bytes)&lt;br&gt;Â pkts&nbsp;bytes&nbsp;targetÂ Â Â Â &nbsp;prot&nbsp;opt&nbsp;inÂ Â Â Â &nbsp;outÂ Â Â Â &nbsp;sourceÂ Â Â Â Â Â Â Â Â Â Â Â Â Â &nbsp;destination&lt;br&gt;Â &nbsp;11MÂ &nbsp;990M&nbsp;MASQUERADEÂ &nbsp;allÂ &nbsp;--Â &nbsp;*Â Â Â Â Â &nbsp;eth0Â Â Â &nbsp;0.0.0.0/0Â Â Â Â Â Â Â Â Â Â Â &nbsp;0.0.0.0/0&lt;br&gt;&lt;br&gt;&lt;br&gt;Thanks&nbsp;for&nbsp;any&nbsp;help&lt;br&gt;&lt;br&gt;--&nbsp;&lt;br&gt;Grzegorz&nbsp;KuczyÅski&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;<br>

</tt>
