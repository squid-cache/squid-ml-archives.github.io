<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;all,&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail-post-text&quot;&gt;<br>
<br>
&lt;p&gt;For&nbsp;couple&nbsp;of&nbsp;days&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;how&nbsp;to&nbsp;get&nbsp;a&nbsp;transparent&nbsp;<br>
HTTPs&nbsp;proxy&nbsp;to&nbsp;work&nbsp;with&nbsp;Squid.&nbsp;What&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;achieve&nbsp;is&nbsp;a&nbsp;proxy&nbsp;<br>
that&nbsp;accepts&nbsp;internet&nbsp;traffic&nbsp;from&nbsp;ports&nbsp;80&nbsp;&amp;&nbsp;443,&nbsp;routes&nbsp;them&nbsp;<br>
through&nbsp;Squid&nbsp;to&nbsp;Privoxy&nbsp;and&nbsp;finally&nbsp;through&nbsp;Tor&nbsp;and&nbsp;returns&nbsp;back&nbsp;the&nbsp;<br>
data.&nbsp;So&nbsp;essentially&nbsp;I&nbsp;want&nbsp;to&nbsp;&quot;automatically&quot;&nbsp;revert&nbsp;some&nbsp;traffic&nbsp;<br>
through&nbsp;Tor&nbsp;without&nbsp;the&nbsp;user&nbsp;needing&nbsp;to&nbsp;add&nbsp;a&nbsp;proxy&nbsp;to&nbsp;their&nbsp;connection.&lt;/p&gt;<br>
<br>
&lt;p&gt;I&nbsp;know&nbsp;how&nbsp;to&nbsp;setup&nbsp;the&nbsp;Privoxy&nbsp;and&nbsp;Tor&nbsp;part,&nbsp;but&nbsp;I&#39;m&nbsp;struggling&nbsp;with&nbsp;the&nbsp;Squid&nbsp;&amp;&nbsp;IP&nbsp;tables&nbsp;configuration.&lt;/p&gt;<br>
<br>
&lt;h2&gt;Here&nbsp;is&nbsp;my&nbsp;setup&lt;/h2&gt;<br>
<br>
&lt;p&gt;Download&nbsp;latest&nbsp;version&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;curl&nbsp;-O&nbsp;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.22.tar.gz&quot;&gt;http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.22.tar.gz&lt;/a&gt;&nbsp;&amp;&amp;&nbsp;tar&nbsp;zxvf&nbsp;squid-3.5.22.tar.gz&nbsp;&amp;&amp;&nbsp;cd&nbsp;squid-3.5.22<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Install&nbsp;all&nbsp;needed&nbsp;packages&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;apt&nbsp;install&nbsp;devscripts&nbsp;build-essential&nbsp;openssl&nbsp;libssl-dev&nbsp;fakeroot&nbsp;libcppunit-dev&nbsp;libsasl2-dev&nbsp;cdbs&nbsp;ccze&nbsp;libfile-readbackwards-perl&nbsp;libcap2&nbsp;libcap-dev&nbsp;libcap2-dev&nbsp;libnetfilter-conntrack-dev&nbsp;htop&nbsp;ccze&nbsp;sysv-rc-conf&nbsp;-y<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Configure&nbsp;the&nbsp;build&nbsp;and&nbsp;make&nbsp;and&nbsp;install&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;./configure&nbsp;\<br>
CHOST=&quot;x86_64-pc-linux-gnu&quot;&nbsp;\<br>
CFLAGS=&quot;-march=core2&nbsp;-O2&nbsp;-pipe&quot;&nbsp;\<br>
CXXFLAGS=&quot;${CFLAGS}&quot;&nbsp;\<br>
--build=x86_64-linux-gnu&nbsp;\<br>
--prefix=/usr&nbsp;\<br>
--exec-prefix=/usr&nbsp;\<br>
--bindir=/usr/bin&nbsp;\<br>
--sbindir=/usr/sbin&nbsp;\<br>
--libdir=/usr/lib&nbsp;\<br>
--sharedstatedir=/usr/com&nbsp;\<br>
--includedir=/usr/include&nbsp;\<br>
--localstatedir=/var&nbsp;\<br>
--libexecdir=/usr/lib/squid&nbsp;\<br>
--srcdir=.&nbsp;\<br>
--datadir=/usr/share/squid&nbsp;\<br>
--sysconfdir=/etc/squid&nbsp;\<br>
--infodir=/usr/share/info&nbsp;\<br>
--mandir=/usr/share/man&nbsp;\<br>
--x-includes=/usr/include&nbsp;\<br>
--x-libraries=/usr/lib&nbsp;\<br>
--with-default-user=proxy&nbsp;\<br>
--with-logdir=/var/log/squid&nbsp;\<br>
--with-pidfile=/var/run/squid.pid&nbsp;\<br>
--enable-err-languages=English&nbsp;\<br>
--enable-default-err-language=English&nbsp;\<br>
--enable-storeio=ufs,aufs,diskd&nbsp;\<br>
--enable-linux-netfilter&nbsp;\<br>
--enable-removal-policies=lru,heap&nbsp;\<br>
--enable-gnuregex&nbsp;\<br>
--enable-follow-x-forwarded-for&nbsp;\<br>
--enable-x-accelerator-vary&nbsp;\<br>
--enable-zph-qos&nbsp;\<br>
--enable-delay-pools&nbsp;\<br>
--enable-snmp&nbsp;\<br>
--enable-underscores&nbsp;\<br>
--with-openssl&nbsp;\<br>
--enable-ssl-crtd&nbsp;\<br>
--enable-http-violations&nbsp;\<br>
--enable-async-io=24&nbsp;\<br>
--enable-storeid-rewrite-helpers&nbsp;\<br>
--with-large-files&nbsp;\<br>
--with-libcap&nbsp;\<br>
--with-netfilter-conntrack&nbsp;\<br>
--with-included-ltdl&nbsp;\<br>
--with-maxfd=65536&nbsp;\<br>
--with-filedescriptors=65536&nbsp;\<br>
--with-pthreads&nbsp;\<br>
--without-gnutls&nbsp;\<br>
--without-mit-krb5&nbsp;\<br>
--without-heimdal-krb5&nbsp;\<br>
--without-gnugss&nbsp;\<br>
--disable-icap-client&nbsp;\<br>
--disable-wccp&nbsp;\<br>
--disable-wccpv2&nbsp;\<br>
--disable-dependency-tracking&nbsp;\<br>
--disable-auth&nbsp;--disable-epoll&nbsp;\<br>
--disable-ident-lookups&nbsp;\<br>
--disable-icmp<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Allow&nbsp;ip4&nbsp;forwarding&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;echo&nbsp;-e&nbsp;&quot;net.ipv4.ip_forward&nbsp;=&nbsp;1\nnet.ipv4.conf.default.rp_filter&nbsp;=&nbsp;0\nnet.ipv4.conf.all.rp_filter&nbsp;=&nbsp;0\nnet.ipv4.conf.eth0.rp_filter&nbsp;=&nbsp;0\n&quot;&nbsp;&gt;&gt;&nbsp;/etc/sysctl.conf<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Generate&nbsp;certificates&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;mkdir&nbsp;/etc/squid/ssl_certs&nbsp;&amp;&amp;&nbsp;cd&nbsp;/etc/squid/ssl_certs<br>
openssl&nbsp;genrsa&nbsp;-out&nbsp;squid.key&nbsp;2048<br>
openssl&nbsp;req&nbsp;-new&nbsp;-key&nbsp;squid.key&nbsp;-out&nbsp;squid.csr&nbsp;-nodes<br>
openssl&nbsp;x509&nbsp;-req&nbsp;-days&nbsp;3652&nbsp;-in&nbsp;squid.csr&nbsp;-signkey&nbsp;squid.key&nbsp;-out&nbsp;squid.crt<br>
cat&nbsp;squid.crt&nbsp;squid.key&nbsp;&gt;&nbsp;squid.pem<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Generate&nbsp;certificate&nbsp;cache&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;mkdir&nbsp;/var/lib/squid&nbsp;&amp;&amp;&nbsp;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/var/lib/squid/<br>
/usr/lib/squid/ssl_crtd&nbsp;-c&nbsp;-s&nbsp;/var/lib/squid/ssl_db<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Change&nbsp;ownership&nbsp;and&nbsp;rights&nbsp;to&nbsp;folders&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;mkdir&nbsp;-p&nbsp;/var/spool/squid<br>
<br>
chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/etc/squid/squid.conf&nbsp;|&nbsp;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/usr/lib/squid&nbsp;|&nbsp;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/var/lib/squid/ssl_db/&nbsp;|&nbsp;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/var/spool/squid&nbsp;|&nbsp;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/var/log/squid&nbsp;&nbsp;|&nbsp;chmod&nbsp;777&nbsp;/var/spool/squid&nbsp;|&nbsp;chmod&nbsp;777&nbsp;/var/log/squid&nbsp;&nbsp;|&nbsp;chmod&nbsp;755&nbsp;/var/lib/squid/ssl_db/certs&nbsp;|&nbsp;chown&nbsp;proxy:proxy&nbsp;/var/log/squid/<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Change&nbsp;configuration&nbsp;(bellow)&nbsp;and&nbsp;initialize&nbsp;the&nbsp;cache&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;squid&nbsp;-f&nbsp;/etc/squid/squid.conf&nbsp;-z<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;Redirect&nbsp;ports&nbsp;80&nbsp;and&nbsp;443&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3128<br>
iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3129<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;My&nbsp;actual&nbsp;squid&nbsp;configuration&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;acl&nbsp;localnet&nbsp;src&nbsp;all<br>
<br>
acl&nbsp;SSL_ports&nbsp;port&nbsp;443<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ftp<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;https<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gopher<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;wais<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;&nbsp;#&nbsp;unregistered&nbsp;ports<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http-mgmt<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gss-http<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;filemaker<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;multiling&nbsp;http<br>
acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT<br>
<br>
never_direct&nbsp;allow&nbsp;all<br>
always_direct&nbsp;allow&nbsp;all<br>
<br>
#&nbsp;Only&nbsp;allow&nbsp;cachemgr&nbsp;access&nbsp;from&nbsp;localhost<br>
http_access&nbsp;allow&nbsp;localhost&nbsp;manager<br>
http_access&nbsp;deny&nbsp;manager<br>
<br>
http_access&nbsp;allow&nbsp;localnet<br>
http_access&nbsp;allow&nbsp;localhost<br>
<br>
debug_options&nbsp;ALL,2<br>
<br>
visible_hostname&nbsp;squid<br>
<br>
#&nbsp;stop&nbsp;squid&nbsp;taking&nbsp;forever&nbsp;to&nbsp;restart.<br>
shutdown_lifetime&nbsp;3<br>
#&nbsp;for&nbsp;clients&nbsp;with&nbsp;a&nbsp;configured&nbsp;proxy.<br>
http_port&nbsp;3127<br>
#&nbsp;for&nbsp;clients&nbsp;who&nbsp;are&nbsp;sent&nbsp;here&nbsp;via&nbsp;iptables&nbsp;...&nbsp;REDIRECT.<br>
http_port&nbsp;3128&nbsp;tproxy<br>
#&nbsp;for&nbsp;https&nbsp;clients&nbsp;who&nbsp;are&nbsp;sent&nbsp;here&nbsp;via&nbsp;iptables&nbsp;...&nbsp;REDIRECT<br>
https_port&nbsp;3129&nbsp;tproxy&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;cert=/etc/squid/ssl_certs/squid.pem<br>
<br>
sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&nbsp;sslcrtd_children&nbsp;8&nbsp;startup=1&nbsp;idle=1<br>
<br>
#&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1<br>
#&nbsp;ssl_bump&nbsp;peek&nbsp;step1<br>
#&nbsp;ssl_bump&nbsp;bump&nbsp;all<br>
<br>
ssl_bump&nbsp;server-first&nbsp;all<br>
sslproxy_cert_error&nbsp;allow&nbsp;all<br>
sslproxy_flags&nbsp;DONT_VERIFY_PEER<br>
<br>
via&nbsp;off<br>
forwarded_for&nbsp;off<br>
<br>
request_header_access&nbsp;From&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Server&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;WWW-Authenticate&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Link&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Cache-Control&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Proxy-Connection&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;X-Cache&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;X-Cache-Lookup&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Via&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;X-Forwarded-For&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Pragma&nbsp;deny&nbsp;all<br>
request_header_access&nbsp;Keep-Alive&nbsp;deny&nbsp;all<br>
<br>
cache_dir&nbsp;ufs&nbsp;/var/spool/squid&nbsp;1024&nbsp;16&nbsp;256<br>
coredump_dir&nbsp;/var/cache/squid<br>
<br>
refresh_pattern&nbsp;^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10080<br>
refresh_pattern&nbsp;^gopher:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440<br>
refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<br>
refresh_pattern&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4320<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;hr&gt;<br>
<br>
&lt;p&gt;You&nbsp;can&nbsp;notice&nbsp;how&nbsp;benevolent&nbsp;I&#39;m&nbsp;with&nbsp;the&nbsp;settings&nbsp;for&nbsp;Squid.&nbsp;It&#39;s&nbsp;only&nbsp;for&nbsp;testing.&lt;/p&gt;<br>
<br>
&lt;p&gt;So&nbsp;where&nbsp;I&nbsp;got&nbsp;now&nbsp;is&nbsp;that&nbsp;nor&nbsp;intercept&nbsp;nor&nbsp;tproxy&nbsp;works.&nbsp;If&nbsp;I&nbsp;use&nbsp;<br>
accel&nbsp;for&nbsp;the&nbsp;non-HTTPS&nbsp;traffic&nbsp;it&nbsp;works,&nbsp;but&nbsp;nothing&nbsp;else.&nbsp;If&nbsp;I&nbsp;use&nbsp;it&nbsp;<br>
as&nbsp;it&nbsp;is,&nbsp;the&nbsp;result&nbsp;is&nbsp;that&nbsp;it&nbsp;will&nbsp;end&nbsp;up&nbsp;hanging&nbsp;for&nbsp;the&nbsp;client&#39;s&nbsp;<br>
timeout&nbsp;period&nbsp;and&nbsp;then&nbsp;timeout.&lt;/p&gt;<br>
<br>
&lt;p&gt;Here&nbsp;is&nbsp;an&nbsp;example.&nbsp;I&nbsp;changed&nbsp;in&nbsp;&lt;code&gt;/etc/hosts&lt;/code&gt;&nbsp;the&nbsp;IP&nbsp;for&nbsp;&lt;a&nbsp;href=&quot;http://httpbin.org&quot;&gt;httpbin.org&lt;/a&gt;&nbsp;and&nbsp;redirected&nbsp;it&nbsp;through&nbsp;the&nbsp;squid&nbsp;box.&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;‚ùØ&nbsp;curl&nbsp;-vk&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org/ip&quot;&gt;https://httpbin.org/ip&lt;/a&gt;<br>
*&nbsp;&nbsp;&nbsp;Trying&nbsp;*******...<br>
*&nbsp;Connected&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://httpbin.org&quot;&gt;httpbin.org&lt;/a&gt;&nbsp;(*******)&nbsp;port&nbsp;443&nbsp;(#0)<br>
*&nbsp;TLS&nbsp;1.2&nbsp;connection&nbsp;using&nbsp;TLS_RSA_WITH_AES_256_GCM_SHA384<br>
*&nbsp;Server&nbsp;certificate:&nbsp;******<br>
*&nbsp;Server&nbsp;certificate:&nbsp;Universe<br>
&gt;&nbsp;GET&nbsp;/ip&nbsp;HTTP/1.1<br>
&gt;&nbsp;Host:&nbsp;&lt;a&nbsp;href=&quot;http://httpbin.org&quot;&gt;httpbin.org&lt;/a&gt;<br>
&gt;&nbsp;User-Agent:&nbsp;curl/7.49.1<br>
&gt;&nbsp;Accept:&nbsp;*/*<br>
&gt;<br>
&lt;&nbsp;HTTP/1.1&nbsp;503&nbsp;Service&nbsp;Unavailable<br>
&lt;&nbsp;Server:&nbsp;squid/3.5.22<br>
&lt;&nbsp;Mime-Version:&nbsp;1.0<br>
&lt;&nbsp;Date:&nbsp;Mon,&nbsp;05&nbsp;Dec&nbsp;2016&nbsp;05:43:50&nbsp;GMT<br>
&lt;&nbsp;Content-Type:&nbsp;text/html;charset=utf-8<br>
&lt;&nbsp;Content-Length:&nbsp;3498<br>
&lt;&nbsp;X-Squid-Error:&nbsp;ERR_CONNECT_FAIL&nbsp;110<br>
&lt;&nbsp;Vary:&nbsp;Accept-Language<br>
&lt;&nbsp;Content-Language:&nbsp;en<br>
&lt;&nbsp;X-Cache:&nbsp;MISS&nbsp;from&nbsp;pipik<br>
&lt;&nbsp;Connection:&nbsp;close<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;On&nbsp;the&nbsp;squid&nbsp;side&lt;/p&gt;<br>
<br>
&lt;pre&gt;&lt;code&gt;2016/12/05&nbsp;05:42:50.362&nbsp;kid1|&nbsp;5,2|&nbsp;TcpAcceptor.cc(220)&nbsp;doAccept:&nbsp;New&nbsp;connection&nbsp;on&nbsp;FD&nbsp;28<br>
2016/12/05&nbsp;05:42:50.362&nbsp;kid1|&nbsp;5,2|&nbsp;TcpAcceptor.cc(295)&nbsp;acceptNext:&nbsp;connection&nbsp;on&nbsp;local=[::]:3129&nbsp;remote=[::]&nbsp;FD&nbsp;28&nbsp;flags=25<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;33,2|&nbsp;client_side.cc(3911)&nbsp;httpsSslBumpAccessCheckDone:&nbsp;sslBump&nbsp;needed&nbsp;for&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;FD&nbsp;11&nbsp;flags=17&nbsp;method&nbsp;3<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2347)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;FD&nbsp;11&nbsp;flags=17<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2348)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;REQUEST:<br>
---------<br>
CONNECT&nbsp;*******:3129&nbsp;HTTP/1.1<br>
Host:&nbsp;*******:3129<br>
<br>
<br>
----------<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(744)&nbsp;clientAccessCheckDone:&nbsp;The&nbsp;request&nbsp;CONNECT&nbsp;*******:3129&nbsp;is&nbsp;ALLOWED;&nbsp;last&nbsp;ACL&nbsp;checked:&nbsp;localnet<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(720)&nbsp;clientAccessCheck2:&nbsp;No&nbsp;adapted_http_access&nbsp;configuration.&nbsp;default:&nbsp;ALLOW<br>
2016/12/05&nbsp;05:42:50.363&nbsp;kid1|&nbsp;85,2|&nbsp;client_side_request.cc(744)&nbsp;clientAccessCheckDone:&nbsp;The&nbsp;request&nbsp;CONNECT&nbsp;*******:3129&nbsp;is&nbsp;ALLOWED;&nbsp;last&nbsp;ACL&nbsp;checked:&nbsp;localnet<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.378&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(4284)&nbsp;clientPeekAndSpliceSSL:&nbsp;SSL_accept&nbsp;failed.<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;17,2|&nbsp;FwdState.cc(133)&nbsp;FwdState:&nbsp;Forwarding&nbsp;client&nbsp;request&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;FD&nbsp;11&nbsp;flags=17,&nbsp;url=*******:3129<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(280)&nbsp;peerSelectDnsPaths:&nbsp;Found&nbsp;sources&nbsp;for&nbsp;&#39;*******:3129&#39;<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(281)&nbsp;peerSelectDnsPaths:&nbsp;&nbsp;&nbsp;always_direct&nbsp;=&nbsp;ALLOWED<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(282)&nbsp;peerSelectDnsPaths:&nbsp;&nbsp;&nbsp;&nbsp;never_direct&nbsp;=&nbsp;DUNNO<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(288)&nbsp;peerSelectDnsPaths:&nbsp;&nbsp;&nbsp;&nbsp;ORIGINAL_DST&nbsp;=&nbsp;local=#############&nbsp;remote=*******:3129&nbsp;flags=25<br>
2016/12/05&nbsp;05:42:50.379&nbsp;kid1|&nbsp;44,2|&nbsp;peer_select.cc(295)&nbsp;peerSelectDnsPaths:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timedout&nbsp;=&nbsp;0<br>
2016/12/05&nbsp;05:43:50.645&nbsp;kid1|&nbsp;4,2|&nbsp;errorpage.cc(1261)&nbsp;BuildContent:&nbsp;No&nbsp;existing&nbsp;error&nbsp;page&nbsp;language&nbsp;negotiated&nbsp;for&nbsp;ERR_CONNECT_FAIL.&nbsp;Using&nbsp;default&nbsp;error&nbsp;file.<br>
2016/12/05&nbsp;05:43:50.645&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(980)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable<br>
2016/12/05&nbsp;05:43:50.645&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(980)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable<br>
2016/12/05&nbsp;05:43:50.845&nbsp;kid1|&nbsp;83,2|&nbsp;client_side.cc(3811)&nbsp;clientNegotiateSSL:&nbsp;clientNegotiateSSL:&nbsp;New&nbsp;session&nbsp;0x29dda60&nbsp;on&nbsp;FD&nbsp;11&nbsp;(#############:59117)<br>
2016/12/05&nbsp;05:43:50.943&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2347)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;FD&nbsp;11&nbsp;flags=17<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2348)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;REQUEST:<br>
---------<br>
GET&nbsp;/ip&nbsp;HTTP/1.1<br>
Host:&nbsp;&lt;a&nbsp;href=&quot;http://httpbin.org&quot;&gt;httpbin.org&lt;/a&gt;<br>
User-Agent:&nbsp;curl/7.49.1<br>
Accept:&nbsp;*/*<br>
<br>
<br>
----------<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;33,2|&nbsp;QosConfig.cc(145)&nbsp;doTosLocalMiss:&nbsp;QOS:&nbsp;Preserving&nbsp;TOS&nbsp;on&nbsp;miss,&nbsp;TOS=0<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;33,2|&nbsp;client_side_reply.cc(1534)&nbsp;buildReplyHeader:&nbsp;clientBuildReplyHeader:&nbsp;Connection&nbsp;Keep-Alive&nbsp;not&nbsp;requested&nbsp;by&nbsp;admin&nbsp;or&nbsp;client<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;88,2|&nbsp;client_side_reply.cc(2051)&nbsp;processReplyAccessResult:&nbsp;The&nbsp;reply&nbsp;for&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org/ip&quot;&gt;https://httpbin.org/ip&lt;/a&gt;&nbsp;is&nbsp;ALLOWED,&nbsp;because&nbsp;it&nbsp;matched&nbsp;(access_log&nbsp;daemon:/var/log/squid/access.log&nbsp;line)<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(1393)&nbsp;sendStartOfMessage:&nbsp;HTTP&nbsp;Client&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;FD&nbsp;11&nbsp;flags=17<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(1394)&nbsp;sendStartOfMessage:&nbsp;HTTP&nbsp;Client&nbsp;REPLY:<br>
---------<br>
HTTP/1.1&nbsp;503&nbsp;Service&nbsp;Unavailable<br>
Server:&nbsp;squid/3.5.22<br>
Mime-Version:&nbsp;1.0<br>
Date:&nbsp;Mon,&nbsp;05&nbsp;Dec&nbsp;2016&nbsp;05:43:50&nbsp;GMT<br>
Content-Type:&nbsp;text/html;charset=utf-8<br>
Content-Length:&nbsp;3498<br>
X-Squid-Error:&nbsp;ERR_CONNECT_FAIL&nbsp;110<br>
Vary:&nbsp;Accept-Language<br>
Content-Language:&nbsp;en<br>
X-Cache:&nbsp;MISS&nbsp;from&nbsp;squid<br>
Connection:&nbsp;close<br>
<br>
<br>
----------<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;33,2|&nbsp;client_side.cc(817)&nbsp;swanSong:&nbsp;local=*******:3129&nbsp;remote=#############&nbsp;flags=17<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(980)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable<br>
2016/12/05&nbsp;05:43:50.944&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(980)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable<br>
&lt;/code&gt;&lt;/pre&gt;<br>
<br>
&lt;p&gt;I&nbsp;tried&nbsp;so&nbsp;many&nbsp;different&nbsp;configurations&nbsp;that&nbsp;I&#39;m&nbsp;already&nbsp;lost&nbsp;in&nbsp;<br>
what&nbsp;does&nbsp;work&nbsp;and&nbsp;what&nbsp;doesn&#39;t.&nbsp;I&#39;m&nbsp;probably&nbsp;not&nbsp;understanding&nbsp;the&nbsp;<br>
connection&nbsp;between&nbsp;iptables&nbsp;and&nbsp;squid&nbsp;properly,&nbsp;but&nbsp;no&nbsp;matter&nbsp;what&nbsp;I&nbsp;<br>
read&nbsp;I&nbsp;always&nbsp;end&nbsp;up&nbsp;here.&lt;/p&gt;<br>
<br>
&lt;p&gt;I&nbsp;appreciate&nbsp;any&nbsp;suggestions.&lt;/p&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
