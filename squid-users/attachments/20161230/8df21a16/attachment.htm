<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&#39;m&nbsp;a&nbsp;bit&nbsp;confused&nbsp;now.&nbsp;Examples&nbsp;from&nbsp;default&nbsp;config:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp; &nbsp; &nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp; #&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;ftp&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;gopher&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;wais&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http-mgmt&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;gss-http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;filemaker&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;multiling&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp; #&nbsp;unregistered&nbsp;ports&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;these&nbsp;ACL&nbsp;work&nbsp;as&nbsp;OR,&nbsp;right?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Why&nbsp;is &lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;req_header&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt; different?&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Dec&nbsp;29,&nbsp;2016&nbsp;at&nbsp;9:44&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;2016-12-29&nbsp;21:01,&nbsp;Ivan&nbsp;Larionov&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&nbsp;see&nbsp;behavior&nbsp;change&nbsp;after&nbsp;update&nbsp;from&nbsp;squid&nbsp;2.7&nbsp;to&nbsp;3.5:&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;have&nbsp;following&nbsp;ACLs&nbsp;which&nbsp;I&nbsp;later&nbsp;use&nbsp;for&nbsp;cache_peer_access:&lt;br&gt;<br>
&lt;br&gt;<br>
acl&nbsp;header&nbsp;req_header&nbsp;header_a&nbsp;-i&nbsp;true&lt;br&gt;<br>
acl&nbsp;header&nbsp;req_header&nbsp;header_b&nbsp;-i&nbsp;true&lt;br&gt;<br>
&lt;br&gt;<br>
#&nbsp;name1&nbsp;parent&lt;br&gt;<br>
cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18070&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=name1&lt;br&gt;<br>
cache_peer_access&nbsp;name1&nbsp;deny&nbsp;header&lt;br&gt;<br>
&lt;br&gt;<br>
#&nbsp;name2&nbsp;parent&lt;br&gt;<br>
cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18079&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=name2&lt;br&gt;<br>
cache_peer_access&nbsp;name2&nbsp;allow&nbsp;header&lt;br&gt;<br>
cache_peer_access&nbsp;name2&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;squid&nbsp;2.7&nbsp;it&nbsp;was&nbsp;working&nbsp;as&nbsp;expected&nbsp;(requests&nbsp;with&nbsp;header_a&nbsp;OR&lt;br&gt;<br>
header_b&nbsp;were&nbsp;going&nbsp;to&nbsp;the&nbsp;second&nbsp;parent,&nbsp;all&nbsp;other&nbsp;requests&nbsp;to&nbsp;the&lt;br&gt;<br>
first&nbsp;one).&lt;br&gt;<br>
&lt;br&gt;<br>
However&nbsp;with&nbsp;squid&nbsp;3.5&nbsp;the&nbsp;same&nbsp;config&nbsp;doesn&#39;t&nbsp;work&nbsp;as&nbsp;expected.&nbsp;ONLY&lt;br&gt;<br>
requests&nbsp;with&nbsp;header_b&nbsp;are&nbsp;going&nbsp;to&nbsp;the&nbsp;second&nbsp;parent&nbsp;and&nbsp;debug&nbsp;logs&lt;br&gt;<br>
show&nbsp;that&nbsp;squid&nbsp;only&nbsp;does&nbsp;verification&nbsp;of&nbsp;header_b.&lt;br&gt;<br>
&lt;br&gt;<br>
My&nbsp;current&nbsp;workaround&nbsp;is&nbsp;to&nbsp;use&nbsp;2&nbsp;different&nbsp;ACL&nbsp;names:&lt;br&gt;<br>
&lt;br&gt;<br>
acl&nbsp;header_a&nbsp;req_header&nbsp;header_a&nbsp;-i&nbsp;true&lt;br&gt;<br>
acl&nbsp;header_b&nbsp;req_header&nbsp;header_b&nbsp;-i&nbsp;true&lt;br&gt;<br>
&lt;br&gt;<br>
#&nbsp;name1&nbsp;parent&lt;br&gt;<br>
cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18070&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=name1&lt;br&gt;<br>
cache_peer_access&nbsp;name1&nbsp;deny&nbsp;header_a&lt;br&gt;<br>
cache_peer_access&nbsp;name1&nbsp;deny&nbsp;header_b&lt;br&gt;<br>
&lt;br&gt;<br>
#&nbsp;name2&nbsp;parent&lt;br&gt;<br>
cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18079&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=name2&lt;br&gt;<br>
cache_peer_access&nbsp;name2&nbsp;allow&nbsp;header_a&lt;br&gt;<br>
cache_peer_access&nbsp;name2&nbsp;allow&nbsp;header_b&lt;br&gt;<br>
cache_peer_access&nbsp;name2&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;I&nbsp;think&nbsp;it&nbsp;could&nbsp;be&nbsp;a&nbsp;bug.&nbsp;Multiple&nbsp;ACLs&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;should&lt;br&gt;<br>
work&nbsp;as&nbsp;OR,&nbsp;right?&nbsp;Do&nbsp;I&nbsp;understand&nbsp;it&nbsp;correctly?&nbsp;And&nbsp;it&nbsp;was&nbsp;working&nbsp;as&lt;br&gt;<br>
expected&nbsp;in&nbsp;2.7.&lt;br&gt;<br>
&lt;br&gt;<br>
Has&nbsp;anyone&nbsp;saw&nbsp;similar&nbsp;behavior?&nbsp;Should&nbsp;I&nbsp;report&nbsp;a&nbsp;bug?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
Good&nbsp;find.&nbsp;You&nbsp;are&nbsp;the&nbsp;first&nbsp;to&nbsp;mention&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;have&nbsp;had&nbsp;a&nbsp;look&nbsp;back&nbsp;into&nbsp;the&nbsp;code&nbsp;history&nbsp;and&nbsp;don&#39;t&nbsp;see&nbsp;this&nbsp;as&nbsp;ever&nbsp;being&nbsp;an&nbsp;intended&nbsp;behaviour&nbsp;for&nbsp;Squid-2.&nbsp;Just&nbsp;a&nbsp;side&nbsp;effect&nbsp;of&nbsp;how&nbsp;the&nbsp;Squid-2&nbsp;ACL&nbsp;lists&nbsp;happened&nbsp;to&nbsp;be&nbsp;stored&nbsp;internally.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;intended&nbsp;design&nbsp;for&nbsp;ACLs&nbsp;is&nbsp;that&nbsp;basic/primitive&nbsp;tests&nbsp;check&nbsp;one&nbsp;piece&nbsp;of&nbsp;state&nbsp;data&nbsp;and&nbsp;get&nbsp;chained&nbsp;explicitly&nbsp;in&nbsp;the&nbsp;access&nbsp;lines&nbsp;for&nbsp;AND/OR&nbsp;conditions.&nbsp;That&nbsp;way&nbsp;it&nbsp;is&nbsp;clear&nbsp;what&nbsp;is&nbsp;being&nbsp;processed&nbsp;and&nbsp;matched&nbsp;(or&nbsp;not&nbsp;matched).&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;for&nbsp;now&nbsp;I&nbsp;am&nbsp;making&nbsp;Squid&nbsp;produce&nbsp;a&nbsp;config&nbsp;ERROR&nbsp;when&nbsp;this&nbsp;config&nbsp;situation&nbsp;is&nbsp;found.&nbsp;The&nbsp;&#39;anyof&#39;&nbsp;or&nbsp;&#39;allof&#39;&nbsp;ACL&nbsp;types&nbsp;in&nbsp;3.4+&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;assemble&nbsp;a&nbsp;more&nbsp;complex&nbsp;test&nbsp;set&nbsp;checking&nbsp;different&nbsp;ACL&nbsp;primitives.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/l&lt;wbr&gt;istinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
