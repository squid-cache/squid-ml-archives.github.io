<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&nbsp;I&nbsp;have&nbsp;a&nbsp;question&nbsp;regarding&nbsp;a&nbsp;native&nbsp;FTP&nbsp;relay.&lt;br&gt;&lt;br&gt;I&nbsp;have&nbsp;tried&nbsp;to&nbsp;test&nbsp;this&nbsp;feature&nbsp;like&nbsp;this:&lt;br&gt;&lt;br&gt;[Filezilla&nbsp;Client,&nbsp;1.1.1.2]&nbsp;&lt;-----&gt;&nbsp;[&nbsp;Router:&nbsp;iptables&nbsp;+&nbsp;squid&nbsp;]&lt;br&gt;&lt;-----&gt;&nbsp;[vsftpd&nbsp;server,&nbsp;5.5.5.10]&lt;br&gt;&lt;br&gt;Firewall&nbsp;settings&nbsp;on&nbsp;the&nbsp;router&nbsp;are:&lt;br&gt;&lt;br&gt;ip&nbsp;route&nbsp;flush&nbsp;table&nbsp;100&lt;br&gt;ip&nbsp;rule&nbsp;add&nbsp;fwmark&nbsp;1&nbsp;lookup&nbsp;100&lt;br&gt;ip&nbsp;route&nbsp;add&nbsp;local&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp;dev&nbsp;lo&nbsp;table&nbsp;100&lt;br&gt;&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-N&nbsp;DIVERT&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;DIVERT&nbsp;-j&nbsp;MARK&nbsp;--set-mark&nbsp;0x01/0x01&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;DIVERT&nbsp;-j&nbsp;ACCEPT&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;socket&nbsp;-j&nbsp;DIVERT&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;21&nbsp;-j&nbsp;TPROXY&lt;br&gt;--tproxy-mark&nbsp;0x1/0x1&nbsp;--on-port&nbsp;2121&lt;br&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;TPROXY&lt;br&gt;--tproxy-mark&nbsp;0x1/0x1&nbsp;--on-port&nbsp;3128&lt;br&gt;&lt;br&gt;No&nbsp;other&nbsp;rules&nbsp;are&nbsp;defined,&nbsp;default&nbsp;policies&nbsp;in&nbsp;chains&nbsp;is&nbsp;ACCEPT.&lt;br&gt;&lt;br&gt;Squid&#39;s&nbsp;configuration&nbsp;file&nbsp;is&nbsp;attached.&lt;br&gt;&lt;br&gt;With&nbsp;HTTP&nbsp;traffic&nbsp;everything&nbsp;works&nbsp;fine,&nbsp;however&nbsp;FTP&nbsp;causes&nbsp;a&nbsp;problem.&lt;br&gt;A&nbsp;client&nbsp;successfully&nbsp;connects&nbsp;and&nbsp;authenticates,&nbsp;but&nbsp;when&nbsp;it&nbsp;tries&nbsp;to&lt;br&gt;execute&nbsp;LIST&nbsp;or&nbsp;RETR&nbsp;(when&nbsp;data&nbsp;connection&nbsp;should&nbsp;be&nbsp;established),&lt;br&gt;Filezilla&nbsp;says&nbsp;&quot;Connection&nbsp;closed&nbsp;by&nbsp;server&quot;.&nbsp;In&nbsp;squid&#39;s&nbsp;log&nbsp;I&nbsp;have&lt;br&gt;noticed&nbsp;some&nbsp;errors&nbsp;when&nbsp;establishing&nbsp;data&nbsp;connection&nbsp;(?),&nbsp;like&lt;br&gt;&quot;failed&nbsp;to&nbsp;connect&nbsp;FTP&nbsp;server&nbsp;data&nbsp;channel&quot;.&nbsp;The&nbsp;log&nbsp;is&nbsp;also&nbsp;attached.&lt;br&gt;&lt;br&gt;What&nbsp;can&nbsp;be&nbsp;wrong&nbsp;with&nbsp;this&nbsp;setup?&lt;/div&gt;<br>

</tt>
