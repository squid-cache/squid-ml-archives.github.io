<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;pretty&nbsp;sure&nbsp;this&nbsp;question&nbsp;has&nbsp;been&nbsp;asked&nbsp;multiple&nbsp;times&nbsp;already,&nbsp;but&nbsp;after&nbsp;reading&nbsp;everything&nbsp;I&nbsp;found&nbsp;I&nbsp;still&nbsp;can&#39;t&nbsp;figure&nbsp;out&nbsp;squid&nbsp;memory&nbsp;usage&nbsp;patterns.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&#39;re&nbsp;currently&nbsp;trying&nbsp;to&nbsp;upgrade&nbsp;from&nbsp;squid&nbsp;2.7&nbsp;to&nbsp;squid&nbsp;3.5&nbsp;and&nbsp;memory&nbsp;usage&nbsp;on&nbsp;squid&nbsp;3&nbsp;is&nbsp;much&nbsp;much&nbsp;higher&nbsp;compared&nbsp;to&nbsp;squid&nbsp;2&nbsp;with&nbsp;the&nbsp;same&nbsp;configuration.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;do&nbsp;I&nbsp;see:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid&nbsp;running&nbsp;for&nbsp;several&nbsp;days&nbsp;with&nbsp;low&nbsp;traffic:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;#&nbsp;top&lt;/div&gt;&lt;div&gt; PID&nbsp;USER&nbsp; &nbsp; &nbsp; PR&nbsp; NI&nbsp; VIRT&nbsp; RES&nbsp; SHR&nbsp;S&nbsp;%CPU&nbsp;%MEM&nbsp; &nbsp; TIME+&nbsp; COMMAND&lt;/div&gt;&lt;div&gt; 7367&nbsp;squid&nbsp; &nbsp; &nbsp;20&nbsp; &nbsp;0&nbsp;4780m&nbsp;4.4g&nbsp;5224&nbsp;S&nbsp; 6.0&nbsp;60.6&nbsp;105:01.76&nbsp;squid&nbsp;-N&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;it&nbsp;uses&nbsp;4.4GB&nbsp;resident&nbsp;memory.&nbsp;Ok,&nbsp;let&#39;s&nbsp;see&nbsp;important&nbsp;config&nbsp;options:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_mem&nbsp;2298756&nbsp;KB&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;maximum_object_size_in_memory&nbsp;8&nbsp;KB&lt;/div&gt;&lt;div&gt;memory_replacement_policy&nbsp;lru&lt;/div&gt;&lt;div&gt;cache_replacement_policy&nbsp;lru&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;cache_dir&nbsp;aufs&nbsp;/mnt/services/squid/cache&nbsp;445644&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;minimum_object_size&nbsp;64&nbsp;bytes&nbsp;#&nbsp;none-zero&nbsp;so&nbsp;we&nbsp;dont&nbsp;cache&nbsp;mistakes&lt;/div&gt;&lt;div&gt;maximum_object_size&nbsp;102400&nbsp;KB&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;we&nbsp;configured&nbsp;2.2GB&nbsp;memory&nbsp;cache&nbsp;and&nbsp;500GB&nbsp;disk&nbsp;cache.&nbsp;Disk&nbsp;cache&nbsp;is&nbsp;quite&nbsp;big&nbsp;but&nbsp;current&nbsp;usage&nbsp;is&nbsp;only&nbsp;3GB:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;#&nbsp;du&nbsp;-sh&nbsp;/mnt/services/squid/cache&nbsp;#&nbsp;cache_dir&lt;/div&gt;&lt;div&gt;3.0G&nbsp; /mnt/services/squid/cache&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;I&#39;m&nbsp;looking&nbsp;into&nbsp;this&nbsp;page &lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/SquidFaq/SquidMemory&quot;&gt;http://wiki.squid-cache.org/SquidFaq/SquidMemory&lt;/a&gt;&nbsp;and&nbsp;see:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;14&nbsp;MB&nbsp;of&nbsp;memory&nbsp;per&nbsp;1&nbsp;GB&nbsp;on&nbsp;disk&nbsp;for&nbsp;64-bit&nbsp;Squid&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Which&nbsp;means&nbsp;disk&nbsp;cache&nbsp;should&nbsp;use&nbsp;~50MB&nbsp;of&nbsp;RAM.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;these&nbsp;means&nbsp;we&nbsp;have&nbsp;~2.2GB&nbsp;ram&nbsp;used&nbsp;for&nbsp;everything&nbsp;else&nbsp;except&nbsp;cache_mem&nbsp;and&nbsp;disk&nbsp;cache&nbsp;index.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Let&#39;s&nbsp;see&nbsp;top&nbsp;pools&nbsp;from&nbsp;mgr:mem:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Pool&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (KB)&nbsp; &nbsp; &nbsp;%Tot&lt;/div&gt;&lt;div&gt;mem_node&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2298833&nbsp; 55.082&lt;/div&gt;&lt;div&gt;Short&nbsp;Strings&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;622365&nbsp; &nbsp;14.913&lt;/div&gt;&lt;div&gt;HttpHeaderEntry&nbsp; &nbsp; &nbsp; &nbsp;404531&nbsp; &nbsp;9.693&lt;/div&gt;&lt;div&gt;Long&nbsp;Strings&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 284520&nbsp; &nbsp;6.817&lt;/div&gt;&lt;div&gt;MemObject&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;182288&nbsp; &nbsp;4.368&lt;/div&gt;&lt;div&gt;HttpReply&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;155612&nbsp; &nbsp;3.729&lt;/div&gt;&lt;div&gt;StoreEntry&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 73965&nbsp; &nbsp; 1.772&lt;/div&gt;&lt;div&gt;Medium&nbsp;Strings&nbsp; &nbsp; &nbsp; &nbsp; 71152&nbsp; &nbsp; 1.705&lt;/div&gt;&lt;div&gt;cbdata&nbsp;MemBuf&nbsp;(12)&nbsp; &nbsp; 35573&nbsp; &nbsp; 0.852&lt;/div&gt;&lt;div&gt;LRU&nbsp;policy&nbsp;node&nbsp; &nbsp; &nbsp; &nbsp;30403&nbsp; &nbsp; 0.728&lt;/div&gt;&lt;div&gt;MD5&nbsp;digest&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11380&nbsp; &nbsp; 0.273&lt;/div&gt;&lt;div&gt;16K&nbsp;Buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1056&nbsp; &nbsp; &nbsp;0.025&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;These&nbsp;pools&nbsp;consume&nbsp;~35%&nbsp;of&nbsp;total&nbsp;squid&nbsp;memory&nbsp;usage:&nbsp;Short&nbsp;Strings,&nbsp;HttpHeaderEntry,&nbsp;Long&nbsp;Strings,&nbsp;HttpReply.&nbsp;Looks&nbsp;suspicious.&nbsp;On&nbsp;squid&nbsp;2&nbsp;same&nbsp;pools&nbsp;use&nbsp;10&nbsp;times&nbsp;less&nbsp;memory.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;found&nbsp;a&nbsp;bug&nbsp;which&nbsp;looks&nbsp;similar&nbsp;to&nbsp;our&nbsp;experience: &lt;a&nbsp;href=&quot;http://bugs.squid-cache.org/show_bug.cgi?id=4084&quot;&gt;http://bugs.squid-cache.org/show_bug.cgi?id=4084&lt;/a&gt;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;attaching&nbsp;our&nbsp;config,&nbsp;mgr:info,&nbsp;mgr:mem&nbsp;and&nbsp;some&nbsp;system&nbsp;info&nbsp;I&nbsp;collected.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Could&nbsp;someone&nbsp;say&nbsp;if&nbsp;this&nbsp;is&nbsp;normal&nbsp;and&nbsp;why&nbsp;it&#39;s&nbsp;so&nbsp;much&nbsp;different&nbsp;from&nbsp;squid&nbsp;2?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
