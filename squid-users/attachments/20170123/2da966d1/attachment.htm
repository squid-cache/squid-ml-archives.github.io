<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#4c4c4c&quot;&nbsp;link=&quot;#8793c1&quot;&nbsp;vlink=&quot;#8793c1&quot;&gt;&lt;div&gt;On&nbsp;Mon,&nbsp;2017-01-23&nbsp;at&nbsp;19:54&nbsp;-0700,&nbsp;Alex&nbsp;Rousskov&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;pre&gt;On&nbsp;01/23/2017&nbsp;04:28&nbsp;PM,&nbsp;David&nbsp;Touzeau&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
ssl_bump&nbsp;peek&nbsp;ssl_step1<br>
ssl_bump&nbsp;splice&nbsp;all<br>
<br>
sslproxy_flags&nbsp;DONT_VERIFY_PEER<br>
sslproxy_cert_error&nbsp;allow&nbsp;all<br>
&lt;/blockquote&gt;<br>
<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
When&nbsp;connecting&nbsp;to&nbsp;mozilla.org&nbsp;using&nbsp;transparent,&nbsp;we&nbsp;receive&nbsp;this&nbsp;error:<br>
<br>
*&nbsp;About&nbsp;to&nbsp;connect()&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://www.mozilla.org&quot;&gt;www.mozilla.org&lt;/a&gt;&nbsp;port&nbsp;443&nbsp;(#0)<br>
*&nbsp;&nbsp;&nbsp;Trying&nbsp;104.16.41.2...<br>
*&nbsp;connected<br>
*&nbsp;Connected&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://www.mozilla.org&quot;&gt;www.mozilla.org&lt;/a&gt;&nbsp;(104.16.41.2)&nbsp;port&nbsp;443&nbsp;(#0)<br>
*&nbsp;successfully&nbsp;set&nbsp;certificate&nbsp;verify&nbsp;locations:<br>
*&nbsp;&nbsp;&nbsp;CAfile:&nbsp;none<br>
&nbsp;&nbsp;CApath:&nbsp;/etc/ssl/certs<br>
*&nbsp;SSLv3,&nbsp;TLS&nbsp;handshake,&nbsp;Client&nbsp;hello&nbsp;(1):<br>
*&nbsp;error:140770FC:SSL&nbsp;routines:SSL23_GET_SERVER_HELLO:unknown&nbsp;protocol<br>
*&nbsp;Closing&nbsp;connection&nbsp;#0<br>
curl:&nbsp;(35)&nbsp;error:140770FC:SSL&nbsp;routines:SSL23_GET_SERVER_HELLO:unknown<br>
protocol<br>
<br>
<br>
And&nbsp;squid&nbsp;access.log<br>
<br>
1485110919.564&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;192.168.1.236&nbsp;TAG_NONE/403&nbsp;6263&nbsp;CONNECT<br>
104.16.41.2:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html<br>
&lt;/blockquote&gt;<br>
<br>
Amos,&nbsp;please&nbsp;note&nbsp;that&nbsp;the&nbsp;above&nbsp;failing&nbsp;test&nbsp;is&nbsp;done&nbsp;using&nbsp;curl,&nbsp;not<br>
some&nbsp;fancy/non-HTTP/websocket&nbsp;traffic&nbsp;from&nbsp;a&nbsp;&quot;browser&quot;.<br>
<br>
David,&nbsp;you&nbsp;need&nbsp;to&nbsp;figure&nbsp;out&nbsp;why&nbsp;Squid&nbsp;is&nbsp;denying&nbsp;the&nbsp;intercepted<br>
connection&nbsp;attempt&nbsp;(the&nbsp;/403&nbsp;part&nbsp;in&nbsp;your&nbsp;access.log).&nbsp;Check&nbsp;your<br>
http_access&nbsp;rules&nbsp;to&nbsp;start&nbsp;with.&nbsp;They&nbsp;were&nbsp;applied&nbsp;to&nbsp;the&nbsp;denied&nbsp;fake<br>
CONNECT&nbsp;request&nbsp;shown&nbsp;above.<br>
<br>
AFAICT,&nbsp;Squid&nbsp;denies&nbsp;the&nbsp;[fake]&nbsp;CONNECT&nbsp;without&nbsp;bumping&nbsp;the&nbsp;client<br>
connection&nbsp;to&nbsp;serve&nbsp;a&nbsp;secure&nbsp;error&nbsp;message.&nbsp;That&nbsp;is&nbsp;_not_&nbsp;what&nbsp;I&nbsp;would<br>
expect&nbsp;because&nbsp;usually&nbsp;Squid&nbsp;bumps&nbsp;to&nbsp;serve&nbsp;errors,&nbsp;even&nbsp;when&nbsp;dealing<br>
with&nbsp;non-bumping&nbsp;ssl_bump&nbsp;rules.&nbsp;However,&nbsp;I&nbsp;may&nbsp;be&nbsp;misinterpreting&nbsp;the<br>
&quot;unknown&nbsp;protocol&quot;&nbsp;part;&nbsp;perhaps&nbsp;OpenSSL&nbsp;can&nbsp;use&nbsp;that&nbsp;phrase&nbsp;for&nbsp;an<br>
unsupported&nbsp;TLS&nbsp;version&nbsp;as&nbsp;well?&nbsp;Or&nbsp;perhaps&nbsp;Squid&nbsp;failed&nbsp;to&nbsp;bump&nbsp;the<br>
client&nbsp;for&nbsp;some&nbsp;reason?<br>
<br>
Capture&nbsp;packets&nbsp;to&nbsp;see&nbsp;what&nbsp;Squid&nbsp;is&nbsp;sending&nbsp;to&nbsp;curl.<br>
<br>
<br>
HTH,<br>
<br>
Alex.<br>
<br>
<br>
&lt;/pre&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Seems&nbsp;like&nbsp;pretty&nbsp;standard&nbsp;stuff:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jan&nbsp;23&nbsp;20:09:04&nbsp;(squid):&nbsp;192.168.1.109&nbsp;-&nbsp;-&nbsp;[23/Jan/2017:20:09:04&nbsp;-0700]&nbsp;&quot;CONNECT&nbsp;104.16.40.2:443&nbsp;HTTP/1.1&quot;&nbsp;&lt;a&nbsp;href=&quot;www.mozilla.org&quot;&gt;www.mozilla.org&lt;/a&gt;&nbsp;-&nbsp;200&nbsp;916167&nbsp;TCP_TUNNEL:ORIGINAL_DST&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;TLSv12&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&lt;/span&gt;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;secp256r1&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;James&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
