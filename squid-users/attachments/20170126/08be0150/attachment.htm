<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Alex/Eliezer,&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Thanks&nbsp;for&nbsp;you&nbsp;earlier&nbsp;comments&nbsp;and&nbsp;apologies&nbsp;for&nbsp;not&nbsp;responding&nbsp;(and&nbsp;saying&nbsp;thank&nbsp;you&nbsp;previously,&nbsp;squid&nbsp;got&nbsp;back-burnered&nbsp;unfortunately)&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Getting&nbsp;logging&nbsp;working&nbsp;with&nbsp;transparent&nbsp;proxying&nbsp;was&nbsp;my&nbsp;initial&nbsp;step&nbsp;prior&nbsp;to&nbsp;looking&nbsp;at&nbsp;restricting&nbsp;specific&nbsp;sites&nbsp;via&nbsp;either&nbsp;ACLs&nbsp;or&nbsp;a&nbsp;URL&nbsp;rewriter&nbsp;(ufdbGuard,&nbsp;SquidGuard&nbsp;etc&nbsp;-&nbsp;although&nbsp;I&nbsp;don’t&nbsp;think&nbsp;SquidGuard&nbsp;works&nbsp;with&nbsp;SNI)&nbsp;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;To&nbsp;reiterate,&nbsp;my&nbsp;desire&nbsp;is&nbsp;to&nbsp;have&nbsp;Squid&nbsp;running&nbsp;and&nbsp;capable&nbsp;of&nbsp;blocking&nbsp;access&nbsp;to&nbsp;http&nbsp;and&nbsp;https&nbsp;sites&nbsp;primarily&nbsp;based&nbsp;on&nbsp;the&nbsp;server&nbsp;name&nbsp;requested&nbsp;by&nbsp;the&nbsp;client&nbsp;(so&nbsp;no&nbsp;need&nbsp;to&nbsp;go&nbsp;beyond&nbsp;a&nbsp;peek)&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;For&nbsp;HTTP&nbsp;requests&nbsp;this&nbsp;is&nbsp;obviously&nbsp;out&nbsp;of&nbsp;the&nbsp;box&nbsp;stuff&nbsp;but&nbsp;for&nbsp;HTTPS&nbsp;it&nbsp;seems&nbsp;more&nbsp;complicated.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;From&nbsp;everything&nbsp;I’ve&nbsp;read,&nbsp;it&nbsp;looks&nbsp;like&nbsp;the&nbsp;following&nbsp;ssl_bump&nbsp;lines&nbsp;should&nbsp;provide&nbsp;access&nbsp;to&nbsp;the&nbsp;SNI&nbsp;server&nbsp;name&nbsp;requested&nbsp;by&nbsp;the&nbsp;client.&nbsp;&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;ssl_bump&nbsp;peek&nbsp;all&lt;br&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;ssl_bump&nbsp;splice&nbsp;all&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;can’t&nbsp;help&nbsp;thinking&nbsp;that&nbsp;I&nbsp;must&nbsp;have&nbsp;something&nbsp;wrong&nbsp;with&nbsp;my&nbsp;config:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-&nbsp;Log&nbsp;output&nbsp;correctly&nbsp;shows&nbsp;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;-&nbsp;SNI&nbsp;server&nbsp;name&nbsp;via&nbsp;ssl::&gt;sni&nbsp;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;-&nbsp;Bump&nbsp;mode&nbsp;via&nbsp;ssl::bump_mode&nbsp;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-&nbsp;Implies&nbsp;my&nbsp;ssl_bump&nbsp;config&nbsp;is&nbsp;working&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-&nbsp;Restricting&nbsp;access&nbsp;via&nbsp;a&nbsp;squid&nbsp;ACL&nbsp;doesn’t&nbsp;use&nbsp;the&nbsp;SNI&nbsp;server&nbsp;name&nbsp;for&nbsp;an&nbsp;HTTPS&nbsp;request&nbsp;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-&nbsp;Works&nbsp;fine&nbsp;for&nbsp;HTTP&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Example&nbsp;ACL:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;blocked_sites&nbsp;ssl::server_name&nbsp;.&lt;a&nbsp;href=&quot;http://apple.com&quot;&nbsp;class=&quot;&quot;&gt;apple.com&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&nbsp;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;Menlo;&quot;&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;blocked_sites&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Example&nbsp;access&nbsp;log&nbsp;output:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;style=&quot;margin:&nbsp;0px;&quot;&nbsp;class=&quot;&quot;&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;style=&quot;font-size:&nbsp;11px;&quot;&nbsp;class=&quot;&quot;&gt;%ts.%03tu&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp;&nbsp;%6tr&nbsp;&nbsp;%&gt;a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%Ss/%03&gt;Hs&nbsp;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&quot;&gt;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&nbsp;&nbsp;&nbsp;%&lt;st&nbsp;&nbsp;%rm&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%ru&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%ssl::&gt;sni&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/font&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11px;&quot;&nbsp;class=&quot;&quot;&gt;%ssl::bump_mode&nbsp;&lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11px;&nbsp;font-family:&nbsp;'Courier&nbsp;New';&quot;&nbsp;class=&quot;&quot;&gt;%[un&nbsp;&nbsp;%Sh/%&lt;a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%mt&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;'Courier&nbsp;New';&quot;&nbsp;class=&quot;&quot;&gt;1485468402.401&nbsp;&nbsp;575&nbsp;&nbsp;&nbsp;10.1.0.1&nbsp;&nbsp;TCP_TUNNEL/200&nbsp;592&nbsp;&nbsp;CONNECT&nbsp;&nbsp;23.63.86.92:443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://store.apple.com&quot;&nbsp;class=&quot;&quot;&gt;store.apple.com&lt;/a&gt;&nbsp;&nbsp;peek&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;ORIGINAL_DST/23.63.86.92&nbsp;&nbsp;-&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&nbsp;class=&quot;&quot;&gt;1485469054.633&nbsp;&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;10.1.0.1&nbsp;&nbsp;TCP_DENIED/403&nbsp;3962&nbsp;GET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://store.apple.com/&quot;&nbsp;class=&quot;&quot;&gt;http://store.apple.com/&lt;/a&gt;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;HIER_NONE/-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text/html&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Example&nbsp;cache&nbsp;log&nbsp;output:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,5|&nbsp;&lt;a&nbsp;href=&quot;http://Acl.cc&quot;&nbsp;class=&quot;&quot;&gt;Acl.cc&lt;/a&gt;(138)&nbsp;matches:&nbsp;checking&nbsp;blocked_sites&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(42)&nbsp;match:&nbsp;checking&nbsp;'23.63.86.92'&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,7|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(32)&nbsp;aclHostDomainCompare:&nbsp;Match:23.63.86.92&nbsp;&lt;&gt;&nbsp;&nbsp;.&lt;a&nbsp;href=&quot;http://apple.com&quot;&nbsp;class=&quot;&quot;&gt;apple.com&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(47)&nbsp;match:&nbsp;'23.63.86.92'&nbsp;NOT&nbsp;found&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(42)&nbsp;match:&nbsp;checking&nbsp;'none'&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,7|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(32)&nbsp;aclHostDomainCompare:&nbsp;Match:none&nbsp;&lt;&gt;&nbsp;&nbsp;.&lt;a&nbsp;href=&quot;http://apple.com&quot;&nbsp;class=&quot;&quot;&gt;apple.com&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://ServerName.cc&quot;&nbsp;class=&quot;&quot;&gt;ServerName.cc&lt;/a&gt;(47)&nbsp;match:&nbsp;'none'&nbsp;NOT&nbsp;found&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://Acl.cc&quot;&nbsp;class=&quot;&quot;&gt;Acl.cc&lt;/a&gt;(158)&nbsp;matches:&nbsp;checked:&nbsp;blocked_sites&nbsp;=&nbsp;0&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,3|&nbsp;&lt;a&nbsp;href=&quot;http://Acl.cc&quot;&nbsp;class=&quot;&quot;&gt;Acl.cc&lt;/a&gt;(158)&nbsp;matches:&nbsp;checked:&nbsp;http_access#5&nbsp;=&nbsp;0&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2017/01/26&nbsp;21:54:21.745&nbsp;kid1|&nbsp;28,5|&nbsp;&lt;a&nbsp;href=&quot;http://Checklist.cc&quot;&nbsp;class=&quot;&quot;&gt;Checklist.cc&lt;/a&gt;(400)&nbsp;bannedAction:&nbsp;Action&nbsp;'ALLOWED/0is&nbsp;not&nbsp;banned&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;squid&nbsp;-v&nbsp;output:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.20&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Service&nbsp;Name:&nbsp;squid&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;configure&nbsp;options:&nbsp;&nbsp;'--build=x86_64-redhat-linux-gnu'&nbsp;'--host=x86_64-redhat-linux-gnu'&nbsp;'--program-prefix='&nbsp;'--prefix=/usr'&nbsp;'--exec-prefix=/usr'&nbsp;'--bindir=/usr/bin'&nbsp;'--sbindir=/usr/sbin'&nbsp;'--sysconfdir=/etc'&nbsp;'--datadir=/usr/share'&nbsp;'--includedir=/usr/include'&nbsp;'--libdir=/usr/lib64'&nbsp;'--libexecdir=/usr/libexec'&nbsp;'--sharedstatedir=/var/lib'&nbsp;'--mandir=/usr/share/man'&nbsp;'--infodir=/usr/share/info'&nbsp;'--disable-strict-error-checking'&nbsp;'--exec_prefix=/usr'&nbsp;'--libexecdir=/usr/lib64/squid'&nbsp;'--localstatedir=/var'&nbsp;'--datadir=/usr/share/squid'&nbsp;'--sysconfdir=/etc/squid'&nbsp;'--with-logdir=$(localstatedir)/log/squid'&nbsp;'--with-pidfile=$(localstatedir)/run/squid.pid'&nbsp;'--disable-dependency-tracking'&nbsp;'--enable-eui'&nbsp;'--enable-follow-x-forwarded-for'&nbsp;'--enable-auth'&nbsp;'--enable-auth-basic=DB,LDAP,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,SMB_LM,getpwnam'&nbsp;'--enable-auth-ntlm=smb_lm,fake'&nbsp;'--enable-auth-digest=file,LDAP,eDirectory'&nbsp;'--enable-auth-negotiate=kerberos'&nbsp;'--enable-external-acl-helpers=file_userip,LDAP_group,time_quota,session,unix_group,wbinfo_group'&nbsp;'--enable-cache-digests'&nbsp;'--enable-cachemgr-hostname=localhost'&nbsp;'--enable-delay-pools'&nbsp;'--enable-epoll'&nbsp;'--enable-ident-lookups'&nbsp;'--enable-linux-netfilter'&nbsp;'--enable-removal-policies=heap,lru'&nbsp;'--enable-snmp'&nbsp;'--enable-ssl-crtd'&nbsp;'--enable-storeio=aufs,diskd,ufs'&nbsp;'--enable-wccpv2'&nbsp;'--enable-esi'&nbsp;'--enable-ecap'&nbsp;'--with-aio'&nbsp;'--with-default-user=squid'&nbsp;'--with-dl'&nbsp;'--with-openssl'&nbsp;'--with-pthreads'&nbsp;'--disable-arch-native'&nbsp;'--disable-icap-client'&nbsp;'build_alias=x86_64-redhat-linux-gnu'&nbsp;'host_alias=x86_64-redhat-linux-gnu'&nbsp;'CFLAGS=-O2&nbsp;-g&nbsp;-pipe&nbsp;-Wall&nbsp;-Wp,-D_FORTIFY_SOURCE=2&nbsp;-fexceptions&nbsp;-fstack-protector-strong&nbsp;--param=ssp-buffer-size=4&nbsp;-grecord-gcc-switches&nbsp;&nbsp;&nbsp;-m64&nbsp;-mtune=generic&nbsp;-fpie'&nbsp;'LDFLAGS=-Wl,-z,relro&nbsp;&nbsp;-pie&nbsp;-Wl,-z,relro&nbsp;-Wl,-z,now'&nbsp;'CXXFLAGS=-O2&nbsp;-g&nbsp;-pipe&nbsp;-Wall&nbsp;-Wp,-D_FORTIFY_SOURCE=2&nbsp;-fexceptions&nbsp;-fstack-protector-strong&nbsp;--param=ssp-buffer-size=4&nbsp;-grecord-gcc-switches&nbsp;&nbsp;&nbsp;-m64&nbsp;-mtune=generic&nbsp;-fpie'&nbsp;'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Is&nbsp;there&nbsp;anything&nbsp;obvious&nbsp;that&nbsp;I&nbsp;am&nbsp;missing&nbsp;as&nbsp;I’m&nbsp;a&nbsp;bit&nbsp;stumped&nbsp;now.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Thanks&nbsp;again&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Mark&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;3&nbsp;Jan&nbsp;2017,&nbsp;at&nbsp;23:35,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;class=&quot;&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;01/03/2017&nbsp;04:11&nbsp;PM,&nbsp;Mark&nbsp;Hoare&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;I&nbsp;think&nbsp;these&nbsp;are&nbsp;hangovers&nbsp;from&nbsp;earlier&nbsp;syntax&nbsp;(ssl_bump&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;server-first&nbsp;all)&nbsp;which&nbsp;shouldn't&nbsp;be&nbsp;required&nbsp;under&nbsp;3.5.&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Please&nbsp;note&nbsp;that&nbsp;the&nbsp;depricated&nbsp;server-first&nbsp;is&nbsp;a&nbsp;&quot;bumping&quot;&nbsp;(not&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;splicing!)&nbsp;action,&nbsp;and&nbsp;you&nbsp;may&nbsp;see&nbsp;a&nbsp;lot&nbsp;more&nbsp;information&nbsp;in&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;bumping-Squid&nbsp;logs,&nbsp;naturally.&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Alex.&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;3&nbsp;Jan&nbsp;2017,&nbsp;at&nbsp;23:10,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;class=&quot;&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;01/03/2017&nbsp;03:41&nbsp;PM,&nbsp;Eliezer&nbsp;&nbsp;Croitoru&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Squid&nbsp;in&nbsp;intercept&nbsp;or&nbsp;tproxy&nbsp;mode&nbsp;will&nbsp;know&nbsp;one&nbsp;thing&nbsp;about&nbsp;the&nbsp;tunnel\connection:&nbsp;IP+port.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;...&nbsp;and&nbsp;SSL&nbsp;handshake&nbsp;information&nbsp;when&nbsp;peeking&nbsp;or&nbsp;staring&nbsp;at&nbsp;client/server.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Since&nbsp;you&nbsp;are&nbsp;using:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;ssl_bump&nbsp;peek&nbsp;all&lt;br&nbsp;class=&quot;&quot;&gt;ssl_bump&nbsp;splice&nbsp;all&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;The&nbsp;connections&nbsp;will&nbsp;always&nbsp;be&nbsp;spliced&nbsp;and&nbsp;you&nbsp;will&nbsp;never&nbsp;see&nbsp;any&lt;br&nbsp;class=&quot;&quot;&gt;url.(are&nbsp;you&nbsp;expecting&nbsp;only&nbsp;the&nbsp;SNI&nbsp;or&nbsp;also&nbsp;the&nbsp;url?)&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;AFAICT,&nbsp;Mark&nbsp;is&nbsp;expecting&nbsp;Squid&nbsp;to&nbsp;log&nbsp;one&nbsp;of&nbsp;the&nbsp;server&nbsp;names,&nbsp;not&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;HTTP&nbsp;request&nbsp;URL.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;I&nbsp;do&nbsp;not&nbsp;know&nbsp;but&nbsp;there&nbsp;might&nbsp;be&nbsp;a&nbsp;code&nbsp;that&nbsp;can&nbsp;report&nbsp;the&nbsp;SNI&nbsp;if&nbsp;exists&nbsp;in&nbsp;the&nbsp;logs.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;According&nbsp;to&nbsp;squid.conf.documented,&nbsp;the&nbsp;following&nbsp;logformat&nbsp;%code&nbsp;is&lt;br&nbsp;class=&quot;&quot;&gt;supported&nbsp;in&nbsp;modern&nbsp;Squids:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;ssl::&gt;sni&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SSL&nbsp;client&nbsp;SNI&nbsp;sent&nbsp;to&nbsp;Squid.&nbsp;Available&nbsp;only&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;after&nbsp;the&nbsp;peek,&nbsp;stare,&nbsp;or&nbsp;splice&nbsp;SSL&nbsp;bumping&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actions.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;This&nbsp;%code&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;default&nbsp;access.log&nbsp;line&nbsp;format,&nbsp;naturally.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Squid&nbsp;can&nbsp;also&nbsp;analyze&nbsp;CN&nbsp;and&nbsp;other&nbsp;server&nbsp;certificate&nbsp;fields,&nbsp;but&nbsp;there&lt;br&nbsp;class=&quot;&quot;&gt;is&nbsp;no&nbsp;code&nbsp;to&nbsp;log&nbsp;them&nbsp;IIRC.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Please&nbsp;note&nbsp;that&nbsp;the&nbsp;intercepted&nbsp;server&nbsp;IP&nbsp;address,&nbsp;the&nbsp;client-supplied&lt;br&nbsp;class=&quot;&quot;&gt;SNI&nbsp;name,&nbsp;the&nbsp;server-supplied&nbsp;common&nbsp;name&nbsp;(CN),&nbsp;the&nbsp;server-supplied&lt;br&nbsp;class=&quot;&quot;&gt;alternative&nbsp;names,&nbsp;and&nbsp;the&nbsp;host&nbsp;info&nbsp;in&nbsp;the&nbsp;encrypted&nbsp;client&nbsp;HTTP&lt;br&nbsp;class=&quot;&quot;&gt;request,&nbsp;may&nbsp;all&nbsp;be&nbsp;different.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Given&nbsp;the&nbsp;variety&nbsp;of&nbsp;information&nbsp;sources&nbsp;that&nbsp;might&nbsp;supply&nbsp;different&lt;br&nbsp;class=&quot;&quot;&gt;information,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;to&nbsp;me&nbsp;whether&nbsp;%ru&nbsp;should&nbsp;be&nbsp;based&nbsp;on&nbsp;SNI&lt;br&nbsp;class=&quot;&quot;&gt;information&nbsp;when&nbsp;both&nbsp;TCP-level&nbsp;and&nbsp;SNI&nbsp;information&nbsp;is&nbsp;available.&nbsp;Or&lt;br&nbsp;class=&quot;&quot;&gt;should&nbsp;it&nbsp;be&nbsp;based&nbsp;on&nbsp;CN?&nbsp;Or&nbsp;perhaps&nbsp;on&nbsp;CN&nbsp;_unless_&nbsp;SNI&nbsp;matches&nbsp;one&nbsp;of&lt;br&nbsp;class=&quot;&quot;&gt;the&nbsp;alternative&nbsp;names??&nbsp;This&nbsp;is&nbsp;a&nbsp;complicated&nbsp;issue;&nbsp;even&nbsp;the&nbsp;smart&lt;br&nbsp;class=&quot;&quot;&gt;server_name&nbsp;ACL&nbsp;needs&nbsp;parameters&nbsp;to&nbsp;clarify&nbsp;what&nbsp;&quot;server&nbsp;name(s)&quot;&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;admin&nbsp;really&nbsp;wants&nbsp;to&nbsp;use/trust...&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;According&nbsp;to&nbsp;Mark's&nbsp;email,&nbsp;%ru&nbsp;uses&nbsp;TCP-level&nbsp;info.&nbsp;We&nbsp;could&nbsp;either&lt;br&nbsp;class=&quot;&quot;&gt;change&nbsp;%ru&nbsp;to&nbsp;use&nbsp;the&nbsp;&quot;latest&quot;&nbsp;info&nbsp;(like&nbsp;the&nbsp;server_name&nbsp;ACL&nbsp;does)&nbsp;or&lt;br&nbsp;class=&quot;&quot;&gt;add&nbsp;a&nbsp;new&nbsp;logformat&nbsp;code&nbsp;that&nbsp;does&nbsp;that&nbsp;while&nbsp;leaving&nbsp;the&nbsp;old&nbsp;%ru&nbsp;and&lt;br&nbsp;class=&quot;&quot;&gt;friends&nbsp;alone.&nbsp;Given&nbsp;the&nbsp;complexity&nbsp;of&nbsp;the&nbsp;issue,&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;a&lt;br&nbsp;class=&quot;&quot;&gt;better&nbsp;approach.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;HTH,&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Alex.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;-----Original&nbsp;Message-----&lt;br&nbsp;class=&quot;&quot;&gt;From:&nbsp;squid-users&nbsp;[&lt;a&nbsp;href=&quot;mailto:squid-users-bounces@lists.squid-cache.org&quot;&nbsp;class=&quot;&quot;&gt;mailto:squid-users-bounces@lists.squid-cache.org&lt;/a&gt;]&nbsp;On&nbsp;Behalf&nbsp;Of&nbsp;Mark&nbsp;Hoare&lt;br&nbsp;class=&quot;&quot;&gt;Sent:&nbsp;Saturday,&nbsp;December&nbsp;31,&nbsp;2016&nbsp;4:38&nbsp;PM&lt;br&nbsp;class=&quot;&quot;&gt;To:&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;class=&quot;&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Subject:&nbsp;[squid-users]&nbsp;ssl_bump&nbsp;-&nbsp;peek&nbsp;&amp;&nbsp;splice&nbsp;logging&nbsp;IP&nbsp;rather&nbsp;than&nbsp;server&nbsp;name&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Extract&nbsp;from&nbsp;access&nbsp;log:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;1483193882.790&nbsp;&nbsp;&nbsp;&nbsp;870&nbsp;&lt;local&nbsp;ip&nbsp;removed&gt;&nbsp;TCP_TUNNEL/200&nbsp;5620&nbsp;CONNECT&nbsp;64.41.200.100:443&nbsp;-&nbsp;ORIGINAL_DST/64.41.200.100&nbsp;-&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;From&nbsp;the&nbsp;output&nbsp;above&nbsp;I&nbsp;would&nbsp;have&nbsp;expected&nbsp;some&nbsp;of&nbsp;the&nbsp;server&nbsp;name&nbsp;info&nbsp;to&nbsp;get&nbsp;into&nbsp;the&nbsp;access&nbsp;log.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;http_port&nbsp;3128&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;https_port&nbsp;3130&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_cert/squidCA.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;http_port&nbsp;3131&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_cert/squidCA.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;ssl_bump&nbsp;peek&nbsp;all&lt;br&nbsp;class=&quot;&quot;&gt;ssl_bump&nbsp;splice&nbsp;all&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
