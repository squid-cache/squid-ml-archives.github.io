<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi&nbsp;all,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;got&nbsp;a&nbsp;squid&nbsp;server&nbsp;running&nbsp;which&nbsp;allows&nbsp;direct&nbsp;proxy&nbsp;and&nbsp;also&nbsp;can&nbsp;intercept&nbsp;traffic:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.1:3128&quot;&gt;10.0.0.1:3128&lt;/a&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.1:3129&quot;&gt;10.0.0.1:3129&lt;/a&gt;&nbsp;intercept&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;is&nbsp;a&nbsp;URL&nbsp;rewriter&nbsp;which&nbsp;allows&nbsp;the&nbsp;incoming&nbsp;requests&nbsp;(this&nbsp;is&nbsp;just&nbsp;an&nbsp;example,&nbsp;I&nbsp;don&#39;t&nbsp;really&nbsp;allow&nbsp;all):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;url_rewrite_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;url_rewrite_program&nbsp;/usr/bin/myrewriter&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;rewriter&nbsp;will&nbsp;rewrite&nbsp;some&nbsp;URLs&nbsp;to&nbsp;a&nbsp;host&nbsp;on&nbsp;the&nbsp;same&nbsp;network,&nbsp;with&nbsp;the&nbsp;intention&nbsp;that&nbsp;the&nbsp;request&nbsp;should&nbsp;not&nbsp;be&nbsp;cached&nbsp;by&nbsp;squid,&nbsp;eg&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;http://example.net/somefile.bin&quot;&gt;http://example.net/somefile.bin&lt;/a&gt;&nbsp;-&gt;&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.2/example.net/somefile.bin&quot;&gt;http://10.0.0.2/example.net/somefile.bin&lt;/a&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;a&nbsp;cache_deny&nbsp;directive&nbsp;is&nbsp;used&nbsp;for&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;local_store&nbsp;dst&nbsp;10.0.0.2&lt;/div&gt;&lt;div&gt;cache&nbsp;deny&nbsp;local_store&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;when&nbsp;requesting&nbsp;this&nbsp;URL&nbsp;using&nbsp;a&nbsp;defined&nbsp;proxy&nbsp;the&nbsp;ACL&nbsp;matches&nbsp;and&nbsp;the&nbsp;request&nbsp;is&nbsp;not&nbsp;cached.&nbsp;If&nbsp;using&nbsp;intercept&nbsp;the&nbsp;ACL&nbsp;does&nbsp;not&nbsp;match&nbsp;and&nbsp;it&nbsp;does&nbsp;get&nbsp;cached&nbsp;(which&nbsp;caused&nbsp;some&nbsp;storage&nbsp;duplication&nbsp;on&nbsp;the&nbsp;network)&lt;/div&gt;&lt;div&gt;The&nbsp;debug&nbsp;info&nbsp;shows&nbsp;the&nbsp;following:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Proxy:&lt;/div&gt;&lt;div&gt;curl&nbsp;-x&nbsp;&quot;&lt;a&nbsp;href=&quot;http://10.0.0.1:3128&quot;&gt;10.0.0.1:3128&lt;/a&gt;&quot;&nbsp;&quot;&lt;a&nbsp;href=&quot;http://example.net/somefile.bin&quot;&gt;http://example.net/somefile.bin&lt;/a&gt;&quot;&nbsp;&gt;&nbsp;/dev/null&lt;/div&gt;&lt;div&gt;Ip.cc(95)&nbsp;aclIpAddrNetworkCompare:&nbsp;aclIpAddrNetworkCompare:&nbsp;compare:&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.2/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&quot;&gt;10.0.0.2/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&lt;/a&gt;&nbsp;(10.0.0.2)&nbsp; vs&nbsp;10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Intercept:&lt;/div&gt;&lt;div&gt;curl&nbsp;&quot;&lt;a&nbsp;href=&quot;http://example.net/somefile.bin&quot;&gt;http://example.net/somefile.bin&lt;/a&gt;&quot;&nbsp;&gt;&nbsp;/dev/null&nbsp;#&nbsp;Intercepted&nbsp;on&nbsp;the&nbsp;NAT&nbsp;tables&lt;/div&gt;&lt;div&gt;Ip.cc(95)&nbsp;aclIpAddrNetworkCompare:&nbsp;aclIpAddrNetworkCompare:&nbsp;compare:&nbsp;&lt;a&nbsp;href=&quot;http://93.184.216.34:80/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&quot;&gt;93.184.216.34:80/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&lt;/a&gt;&nbsp;(&lt;a&nbsp;href=&quot;http://93.184.216.34:80&quot;&gt;93.184.216.34:80&lt;/a&gt;)&nbsp; vs&nbsp;10.0.0.2-[::]/[ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;seems&nbsp;to&nbsp;show&nbsp;that&nbsp;the&nbsp;ACL&nbsp;is&nbsp;processed&nbsp;at&nbsp;a&nbsp;different&nbsp;stage&nbsp;for&nbsp;the&nbsp;two&nbsp;different&nbsp;modes.&nbsp;Now&nbsp;I&#39;m&nbsp;wondering&nbsp;if&nbsp;this&nbsp;is&nbsp;intentional&nbsp;and&nbsp;I&nbsp;shouldn&#39;t&nbsp;be&nbsp;using&nbsp;the&nbsp;&#39;dst&#39;&nbsp;ACL&nbsp;here,&nbsp;or&nbsp;should&nbsp;it&nbsp;be&nbsp;more&nbsp;consistant&nbsp;and&nbsp;give&nbsp;the&nbsp;same&nbsp;result&nbsp;regardless?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;solution&nbsp;to&nbsp;use&nbsp;the&nbsp;&#39;url_regex&#39;&nbsp;ACL&nbsp;instead&nbsp;which&nbsp;seems&nbsp;consistant&nbsp;between&nbsp;the&nbsp;two&nbsp;modes,&nbsp;but&nbsp;it&nbsp;may&nbsp;slightly&nbsp;affect&nbsp;performance.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;couldn&#39;t&nbsp;find&nbsp;a&nbsp;huge&nbsp;amount&nbsp;of&nbsp;info&nbsp;on&nbsp;what&nbsp;order&nbsp;the&nbsp;ACLs&nbsp;are&nbsp;processed,&nbsp;so&nbsp;if&nbsp;anybody&nbsp;could&nbsp;let&nbsp;me&nbsp;know&nbsp;what&nbsp;the&nbsp;expected&nbsp;behaviour&nbsp;should&nbsp;be&nbsp;that&nbsp;would&nbsp;be&nbsp;much&nbsp;appreciated.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Craig&lt;/div&gt;&lt;/div&gt;<br>

</tt>
