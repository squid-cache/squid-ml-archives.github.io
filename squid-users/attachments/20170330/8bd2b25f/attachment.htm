<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail-m_4367764167941461034gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;want&nbsp;to&nbsp;setup&nbsp;Squid&nbsp;as&nbsp;a&nbsp;HTTPS&nbsp;reverse&nbsp;proxy&nbsp;for&nbsp;several&nbsp;of&nbsp;our&nbsp;websites,&nbsp;but&nbsp;I&nbsp;have&nbsp;a&nbsp;certificate&nbsp;verification&nbsp;problem&nbsp;on&nbsp;Squid&nbsp;access.log.&lt;/div&gt;&lt;div&gt;Our&nbsp;upstream&nbsp;webservers&nbsp;are&nbsp;behind&nbsp;a&nbsp;VPN&nbsp;tunnel&nbsp;and&nbsp;only&nbsp;the&nbsp;Squid&nbsp;server&nbsp;can&nbsp;access&nbsp;it.&nbsp;(&lt;i&gt;We&nbsp;actually&nbsp;use&nbsp;Nginx&nbsp;for&nbsp;the&nbsp;same&nbsp;purpose&nbsp;but&nbsp;want&nbsp;to&nbsp;switch&nbsp;to&nbsp;Squid)&lt;/i&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HTTPS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HTTPS&lt;/div&gt;&lt;div&gt;[client&nbsp;browser]&nbsp;-----------------------&gt;&nbsp;[Squid]&nbsp;--------------------------&gt;&nbsp;[upstream&nbsp;server]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;run&nbsp;squid 3.4.8-6+deb8u4&nbsp;recompiled&nbsp;with&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&nbsp;--enable-ssl&nbsp;--with-open-ssl=&quot;/etc/ssl/&lt;wbr&gt;openssl.cnf&quot;&lt;/font&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&nbsp;on&nbsp;Debian&nbsp;Jessie.&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;certificate&nbsp;presented&nbsp;to&nbsp;the&nbsp;client&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;on&nbsp;the&nbsp;upstream&nbsp;server,&nbsp;a&nbsp;wildcard&nbsp;one&nbsp;signed&nbsp;by&nbsp;GeoTrust&nbsp;(with&nbsp;intermediate&nbsp;CA).&nbsp;It&nbsp;appears&nbsp;correctly&nbsp;in&nbsp;the&nbsp;browser.&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;comes&nbsp;from&nbsp;squid&nbsp;verification&nbsp;of&nbsp;upstream&nbsp;certificate.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;basic&nbsp;squid.conf&nbsp;looks&nbsp;like&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;https_port&nbsp;&lt;squid&nbsp;IP&gt;:443&nbsp;accel&nbsp;defaultsite=upstream1.domain.&lt;/span&gt;&lt;wbr&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;tld&nbsp;vhost&nbsp;cert=&lt;path&nbsp;to&nbsp;SSL&nbsp;cert&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;cache_peer&nbsp;&lt;upstream&nbsp;IP&gt;&nbsp;parent&nbsp;443&nbsp;0&nbsp;no-query&nbsp;originserver&nbsp;name=upstream1&nbsp;ssl &lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;upstream1&nbsp;dstdomain&nbsp;upstream1.domain.tld&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;cache_peer_access&nbsp;upstream1&nbsp;allow&nbsp;upstream1&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;logs&nbsp;are&nbsp;full&nbsp;of&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;fwdNegotiateSSL:&nbsp;Error&nbsp;negotiating&nbsp;SSL&nbsp;connection&nbsp;on&nbsp;FD&nbsp;14:&nbsp;error:14090086:SSL&nbsp;routines:SSL3_GET_SERVER_&lt;wbr&gt;CERTIFICATE:certificate&nbsp;verify&nbsp;failed&nbsp;(1/-1/0)&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;TCP&nbsp;connection&nbsp;to&nbsp;&lt;upstream&nbsp;IP&gt;&nbsp;failed&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;I&nbsp;verify&nbsp;with&nbsp;openssl&nbsp;the&nbsp;upstream&nbsp;server,&nbsp;I&nbsp;got&nbsp;an&nbsp;error&nbsp;but&nbsp;if&nbsp;I&nbsp;give&nbsp;it&nbsp;the&nbsp;intermediary&nbsp;CA&nbsp;certificate&nbsp;(to&nbsp;be&nbsp;precise&nbsp;I&nbsp;give&nbsp;it&nbsp;the&nbsp;full&nbsp;chain&nbsp;concatenated&nbsp;in&nbsp;one&nbsp;file),&nbsp;it&#39;s&nbsp;OK.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;$ openssl&nbsp;s_client&nbsp;-showcerts&nbsp;-connect&nbsp;upstream.domain.tld:443&nbsp;-CAfile&nbsp;&lt;path&nbsp;to&nbsp;full&nbsp;cert&nbsp;chain&gt;.pem &lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;CONNECTED(00000003)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=2&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;GeoTrust&nbsp;Global&nbsp;CA&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=1&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;RapidSSL&nbsp;SHA256&nbsp;CA&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=0&nbsp;CN&nbsp;=&nbsp;*.&lt;a&nbsp;href=&quot;http://fraudbuster.mobi&quot;&gt;fraudbuster.mobi&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;div&gt; &nbsp; &nbsp;Timeout&nbsp; &nbsp;:&nbsp;300&nbsp;(sec)&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp;Verify&nbsp;return&nbsp;code:&nbsp;0&nbsp;(ok)&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;squid,&nbsp;I&nbsp;tried&nbsp;several&nbsp;options&nbsp;for&nbsp;cache_peer&nbsp;(sslcapath&nbsp;and&nbsp;sslcafile...)&nbsp;but&nbsp;I&nbsp;keep&nbsp;having&nbsp;this&nbsp;error.&nbsp;Of&nbsp;course&nbsp;the&nbsp;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;sslflags=DONT_VERIFY_PEER,&lt;wbr&gt;DONT_VERIFY_DOMAIN&lt;/font&gt;&nbsp;options&nbsp;solve&nbsp;the&nbsp;problem,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;use&nbsp;this&nbsp;solution&nbsp;(my&nbsp;certificate&nbsp;is&nbsp;legitimate&nbsp;and&nbsp;want&nbsp;to&nbsp;validate&nbsp;it&nbsp;normally).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;and&nbsp;what&nbsp;should&nbsp;I&nbsp;do&nbsp;to&nbsp;make&nbsp;squid&nbsp;work&nbsp;in&nbsp;this&nbsp;setup?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Eric.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
