<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Mar&nbsp;31,&nbsp;2017&nbsp;at&nbsp;4:44&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;gmail-m_5619510244724927757gmail-&quot;&gt;On&nbsp;31/03/2017&nbsp;4:01&nbsp;a.m.,&nbsp;Eric&nbsp;Veiras&nbsp;Galisson&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hello,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;want&nbsp;to&nbsp;setup&nbsp;Squid&nbsp;as&nbsp;a&nbsp;HTTPS&nbsp;reverse&nbsp;proxy&nbsp;for&nbsp;several&nbsp;of&nbsp;our&nbsp;websites,&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;I&nbsp;have&nbsp;a&nbsp;certificate&nbsp;verification&nbsp;problem&nbsp;on&nbsp;Squid&nbsp;access.log.&lt;br&gt;<br>
&gt;&nbsp;Our&nbsp;upstream&nbsp;webservers&nbsp;are&nbsp;behind&nbsp;a&nbsp;VPN&nbsp;tunnel&nbsp;and&nbsp;only&nbsp;the&nbsp;Squid&nbsp;server&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;can&nbsp;access&nbsp;it.&nbsp;(*We&nbsp;actually&nbsp;use&nbsp;Nginx&nbsp;for&nbsp;the&nbsp;same&nbsp;purpose&nbsp;but&nbsp;want&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;switch&nbsp;to&nbsp;Squid)*&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;gmail-m_5619510244724927757gmail-&quot;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTTPS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTTPS&lt;br&gt;<br>
&gt;&nbsp;[client&nbsp;browser]&nbsp;-----------------------&gt;&nbsp;[Squid]&lt;br&gt;<br>
&gt;&nbsp;--------------------------&gt;&nbsp;[upstream&nbsp;server]&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;run&nbsp;squid&nbsp;3.4.8-6+deb8u4&nbsp;recompiled&nbsp;with&nbsp;--enable-ssl&lt;br&gt;<br>
&gt;&nbsp;--with-open-ssl=&quot;/etc/ssl/open&lt;wbr&gt;ssl.cnf&quot;&nbsp;on&nbsp;Debian&nbsp;Jessie.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;certificate&nbsp;presented&nbsp;to&nbsp;the&nbsp;client&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;on&nbsp;the&nbsp;upstream&lt;br&gt;<br>
&gt;&nbsp;server,&nbsp;a&nbsp;wildcard&nbsp;one&nbsp;signed&nbsp;by&nbsp;GeoTrust&nbsp;(with&nbsp;intermediate&nbsp;CA).&nbsp;It&lt;br&gt;<br>
&gt;&nbsp;appears&nbsp;correctly&nbsp;in&nbsp;the&nbsp;browser.&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;problem&nbsp;comes&nbsp;from&nbsp;squid&nbsp;verification&nbsp;of&nbsp;upstream&nbsp;certificate.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;/span&gt;...&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;gmail-m_5619510244724927757gmail-&quot;&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;and&nbsp;what&nbsp;should&nbsp;I&nbsp;do&nbsp;to&nbsp;make&nbsp;squid&nbsp;work&nbsp;in&nbsp;this&lt;br&gt;<br>
&gt;&nbsp;setup?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;The&nbsp;server&nbsp;(and&nbsp;Squid)&nbsp;should&nbsp;be&nbsp;supplying&nbsp;the&nbsp;intermediate&nbsp;cert&nbsp;along&lt;br&gt;<br>
with&nbsp;its&nbsp;own&nbsp;cert&nbsp;for&nbsp;best&nbsp;validation&nbsp;behaviour.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Both&nbsp;the&nbsp;server&nbsp;and&nbsp;squid&nbsp;(https_port&nbsp;cert=&nbsp;option)&nbsp;are&nbsp;actually&nbsp;using&nbsp;the&nbsp;same&nbsp;certificate:&nbsp;a&nbsp;single&nbsp;file&nbsp;with&nbsp;priv&nbsp;key,&nbsp;server&nbsp;certificate&nbsp;and&nbsp;intermediary&nbsp;cert&nbsp;CA.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
If&nbsp;it&nbsp;cannot,&nbsp;use&nbsp;the&nbsp;cache_peer&nbsp;sslcafile=&nbsp;option&nbsp;to&nbsp;provide&nbsp;Squid&nbsp;with&lt;br&gt;<br>
a&nbsp;PEM&nbsp;file&nbsp;containing&nbsp;the&nbsp;public&nbsp;certs&nbsp;of&nbsp;the&nbsp;whole&nbsp;chain&nbsp;(excluding&nbsp;the&lt;br&gt;<br>
server&nbsp;cert&nbsp;itself).&nbsp;Order&nbsp;of&nbsp;those&nbsp;certs&nbsp;in&nbsp;the&nbsp;file&nbsp;is&nbsp;important.&nbsp;I&#39;ve&lt;br&gt;<br>
forgotten&nbsp;which&nbsp;end&nbsp;of&nbsp;the&nbsp;chain&nbsp;to&nbsp;start&nbsp;with&nbsp;sorry,&nbsp;but&nbsp;it&nbsp;is&nbsp;one&nbsp;or&lt;br&gt;<br>
the&nbsp;other&nbsp;and&nbsp;definitely&nbsp;sequential.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;changed&nbsp;cache_peer&nbsp;directive&nbsp;to&nbsp;add&nbsp;sslcafile&nbsp;option&nbsp;to&nbsp;a&nbsp;PEM&nbsp;file&nbsp;containing&nbsp;root&nbsp;and&nbsp;intermediary&nbsp;CA&nbsp;certificate,&nbsp;in&nbsp;one&nbsp;order&nbsp;or&nbsp;the&nbsp;other.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;And&nbsp;when&nbsp;verifying&nbsp;with&nbsp;openssl&nbsp;s_client&nbsp;-showcerts&nbsp;-connect&nbsp;upstream1.domain.tld&nbsp;directly&nbsp;(no&nbsp;squid)&nbsp;or&nbsp;via&nbsp;squid,&nbsp;it&#39;s&nbsp;OK&nbsp;[1]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;$&nbsp;openssl&nbsp;s_client&nbsp;-showcerts&nbsp;-connect&nbsp;upstream.domain.tld:443&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;CONNECTED(00000003)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=2&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;GeoTrust&nbsp;Global&nbsp;CA&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=1&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;RapidSSL&nbsp;SHA256&nbsp;CA&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;depth=0&nbsp;CN&nbsp;=&nbsp;*.domain.tld&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;verify&nbsp;return:1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;---&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt; &nbsp; &nbsp;Verify&nbsp;return&nbsp;code:&nbsp;0&nbsp;(ok)&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;I&nbsp;still&nbsp;have&nbsp;the&nbsp;same&nbsp;error&nbsp;when&nbsp;connecting&nbsp;to&nbsp;the&nbsp;website&nbsp;with&nbsp;a&nbsp;browser.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
When&nbsp;that&nbsp;is&nbsp;working&nbsp;you&nbsp;should&nbsp;use&nbsp;the&nbsp;sslflags=NO_DEFAULT_CA&nbsp;option&nbsp;to&lt;br&gt;<br>
prevent&nbsp;MITM&nbsp;on&nbsp;those&nbsp;connections&nbsp;altering&nbsp;the&nbsp;chain&nbsp;-&nbsp;and&nbsp;saves&nbsp;a&nbsp;huge&lt;br&gt;<br>
amount&nbsp;of&nbsp;memory&nbsp;:-).&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;div&gt;[1]&nbsp;for&nbsp;this&nbsp;server&nbsp;at&nbsp;least,&nbsp;which&nbsp;is&nbsp;Apache&nbsp;2.4&nbsp;on&nbsp;Debian&nbsp;Jessie,&nbsp;old&nbsp;Apache&nbsp;2.2&nbsp;on&nbsp;Debian&nbsp;Wheezy&nbsp;don&#39;t&nbsp;work,&nbsp;but&nbsp;it&#39;s&nbsp;another&nbsp;problem.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
