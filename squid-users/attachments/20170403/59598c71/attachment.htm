<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Apr&nbsp;2,&nbsp;2017&nbsp;at&nbsp;10:27&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;1/04/2017&nbsp;4:42&nbsp;a.m.,&nbsp;Eric&nbsp;Veiras&nbsp;Galisson&nbsp;wrote:&lt;br&gt;<br>
&lt;div&gt;&lt;div&nbsp;class=&quot;gmail-h5&quot;&gt;&gt;&nbsp;On&nbsp;Fri,&nbsp;Mar&nbsp;31,&nbsp;2017&nbsp;at&nbsp;4:44&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;31/03/2017&nbsp;4:01&nbsp;a.m.,&nbsp;Eric&nbsp;Veiras&nbsp;Galisson&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Hello,&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;I&nbsp;want&nbsp;to&nbsp;setup&nbsp;Squid&nbsp;as&nbsp;a&nbsp;HTTPS&nbsp;reverse&nbsp;proxy&nbsp;for&nbsp;several&nbsp;of&nbsp;our&lt;br&gt;<br>
&gt;&gt;&nbsp;websites,&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;but&nbsp;I&nbsp;have&nbsp;a&nbsp;certificate&nbsp;verification&nbsp;problem&nbsp;on&nbsp;Squid&nbsp;access.log.&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;Our&nbsp;upstream&nbsp;webservers&nbsp;are&nbsp;behind&nbsp;a&nbsp;VPN&nbsp;tunnel&nbsp;and&nbsp;only&nbsp;the&nbsp;Squid&nbsp;server&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;can&nbsp;access&nbsp;it.&nbsp;(*We&nbsp;actually&nbsp;use&nbsp;Nginx&nbsp;for&nbsp;the&nbsp;same&nbsp;purpose&nbsp;but&nbsp;want&nbsp;to&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;switch&nbsp;to&nbsp;Squid)*&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTTPS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTTPS&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;[client&nbsp;browser]&nbsp;-----------------------&gt;&nbsp;[Squid]&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;--------------------------&gt;&nbsp;[upstream&nbsp;server]&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;I&nbsp;run&nbsp;squid&nbsp;3.4.8-6+deb8u4&nbsp;recompiled&nbsp;with&nbsp;--enable-ssl&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;--with-open-ssl=&quot;/etc/ssl/&lt;wbr&gt;openssl.cnf&quot;&nbsp;on&nbsp;Debian&nbsp;Jessie.&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;The&nbsp;certificate&nbsp;presented&nbsp;to&nbsp;the&nbsp;client&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;on&nbsp;the&nbsp;upstream&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;server,&nbsp;a&nbsp;wildcard&nbsp;one&nbsp;signed&nbsp;by&nbsp;GeoTrust&nbsp;(with&nbsp;intermediate&nbsp;CA).&nbsp;It&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;appears&nbsp;correctly&nbsp;in&nbsp;the&nbsp;browser.&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;The&nbsp;problem&nbsp;comes&nbsp;from&nbsp;squid&nbsp;verification&nbsp;of&nbsp;upstream&nbsp;certificate.&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;...&lt;br&gt;<br>
&gt;&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;and&nbsp;what&nbsp;should&nbsp;I&nbsp;do&nbsp;to&nbsp;make&nbsp;squid&nbsp;work&nbsp;in&nbsp;this&lt;br&gt;<br>
&gt;&gt;&gt;&nbsp;setup?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;server&nbsp;(and&nbsp;Squid)&nbsp;should&nbsp;be&nbsp;supplying&nbsp;the&nbsp;intermediate&nbsp;cert&nbsp;along&lt;br&gt;<br>
&gt;&gt;&nbsp;with&nbsp;its&nbsp;own&nbsp;cert&nbsp;for&nbsp;best&nbsp;validation&nbsp;behaviour.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Both&nbsp;the&nbsp;server&nbsp;and&nbsp;squid&nbsp;(https_port&nbsp;cert=&nbsp;option)&nbsp;are&nbsp;actually&nbsp;using&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;same&nbsp;certificate:&nbsp;a&nbsp;single&nbsp;file&nbsp;with&nbsp;priv&nbsp;key,&nbsp;server&nbsp;certificate&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;intermediary&nbsp;cert&nbsp;CA.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;That&nbsp;does&nbsp;not&nbsp;matter.&nbsp;TLS&nbsp;is&nbsp;point-to-point.&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;matters&nbsp;is&nbsp;that&nbsp;*any*&nbsp;software&nbsp;operating&nbsp;as&nbsp;the&nbsp;server&nbsp;endpoint&nbsp;of&lt;br&gt;<br>
a&nbsp;TLS&nbsp;connection&nbsp;sends&nbsp;the&nbsp;right&nbsp;details&nbsp;along&nbsp;with&nbsp;its&nbsp;cert.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;that&nbsp;is&nbsp;what&nbsp;I&#39;m&nbsp;doing:&nbsp;priv&nbsp;key,&nbsp;server&nbsp;cert&nbsp;+&nbsp;intermediate&nbsp;CA&nbsp;cert.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;openssl&nbsp;s_client&nbsp;is&nbsp;OK&nbsp;with&nbsp;TLS&nbsp;chain.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
Your&nbsp;setup&nbsp;is&nbsp;special&nbsp;in&nbsp;that&nbsp;it&nbsp;has&nbsp;multiple&nbsp;pieces&nbsp;of&nbsp;software&nbsp;using&lt;br&gt;<br>
the&nbsp;same&nbsp;cert&nbsp;(Squid&nbsp;and&nbsp;the&nbsp;peer&nbsp;web&nbsp;service).&nbsp;That&nbsp;is&nbsp;not&nbsp;great&nbsp;for&lt;br&gt;<br>
security&nbsp;(reduces&nbsp;the&nbsp;effective&nbsp;trust&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;cert),&nbsp;but&nbsp;is&nbsp;doable.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;I&nbsp;understand&nbsp;that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;<br>
&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;If&nbsp;it&nbsp;cannot,&nbsp;use&nbsp;the&nbsp;cache_peer&nbsp;sslcafile=&nbsp;option&nbsp;to&nbsp;provide&nbsp;Squid&nbsp;with&lt;br&gt;<br>
&gt;&gt;&nbsp;a&nbsp;PEM&nbsp;file&nbsp;containing&nbsp;the&nbsp;public&nbsp;certs&nbsp;of&nbsp;the&nbsp;whole&nbsp;chain&nbsp;(excluding&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;server&nbsp;cert&nbsp;itself).&nbsp;Order&nbsp;of&nbsp;those&nbsp;certs&nbsp;in&nbsp;the&nbsp;file&nbsp;is&nbsp;important.&nbsp;I&#39;ve&lt;br&gt;<br>
&gt;&gt;&nbsp;forgotten&nbsp;which&nbsp;end&nbsp;of&nbsp;the&nbsp;chain&nbsp;to&nbsp;start&nbsp;with&nbsp;sorry,&nbsp;but&nbsp;it&nbsp;is&nbsp;one&nbsp;or&lt;br&gt;<br>
&gt;&gt;&nbsp;the&nbsp;other&nbsp;and&nbsp;definitely&nbsp;sequential.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;changed&nbsp;cache_peer&nbsp;directive&nbsp;to&nbsp;add&nbsp;sslcafile&nbsp;option&nbsp;to&nbsp;a&nbsp;PEM&nbsp;file&lt;br&gt;<br>
&gt;&nbsp;containing&nbsp;root&nbsp;and&nbsp;intermediary&nbsp;CA&nbsp;certificate,&nbsp;in&nbsp;one&nbsp;order&nbsp;or&nbsp;the&nbsp;other.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;And&nbsp;when&nbsp;verifying&nbsp;with&nbsp;openssl&nbsp;s_client&nbsp;-showcerts&nbsp;-connect&lt;br&gt;<br>
&gt;&nbsp;upstream1.domain.tld&nbsp;directly&nbsp;(no&nbsp;squid)&nbsp;or&nbsp;via&nbsp;squid,&nbsp;it&#39;s&nbsp;OK&nbsp;[1]&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;$&nbsp;openssl&nbsp;s_client&nbsp;-showcerts&nbsp;-connect&nbsp;upstream.domain.tld:443&lt;br&gt;<br>
&gt;&nbsp;CONNECTED(00000003)&lt;br&gt;<br>
&gt;&nbsp;depth=2&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;GeoTrust&nbsp;Global&nbsp;CA&lt;br&gt;<br>
&gt;&nbsp;verify&nbsp;return:1&lt;br&gt;<br>
&gt;&nbsp;depth=1&nbsp;C&nbsp;=&nbsp;US,&nbsp;O&nbsp;=&nbsp;GeoTrust&nbsp;Inc.,&nbsp;CN&nbsp;=&nbsp;RapidSSL&nbsp;SHA256&nbsp;CA&lt;br&gt;<br>
&gt;&nbsp;verify&nbsp;return:1&lt;br&gt;<br>
&gt;&nbsp;depth=0&nbsp;CN&nbsp;=&nbsp;*.domain.tld&lt;br&gt;<br>
&gt;&nbsp;verify&nbsp;return:1&lt;br&gt;<br>
&gt;&nbsp;---&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Verify&nbsp;return&nbsp;code:&nbsp;0&nbsp;(ok)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;But&nbsp;I&nbsp;still&nbsp;have&nbsp;the&nbsp;same&nbsp;error&nbsp;when&nbsp;connecting&nbsp;to&nbsp;the&nbsp;website&nbsp;with&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;browser.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Exact&nbsp;same&nbsp;error?&nbsp;Since&nbsp;Squid&nbsp;is&nbsp;juggling&nbsp;multiple&nbsp;TLS&nbsp;connections&nbsp;for&lt;br&gt;<br>
the&nbsp;transaction&nbsp;I&nbsp;am&nbsp;looking&nbsp;at&nbsp;&quot;fwdNegotiateSSL&quot;&nbsp;in&nbsp;the&nbsp;log&nbsp;message&lt;br&gt;<br>
which&nbsp;is&nbsp;the&nbsp;only&nbsp;detail&nbsp;indicating&nbsp;what&nbsp;connection&nbsp;is&nbsp;having&nbsp;the&nbsp;issue.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;same&nbsp;error.&nbsp;If&nbsp;I&nbsp;try&nbsp;to&nbsp;access&nbsp;upstream1.domain.tld&nbsp;via&nbsp;a&nbsp;browser&nbsp;via&nbsp;squid,&nbsp;I&nbsp;got&nbsp;this&nbsp;in&nbsp;squid/cache.log&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;2017/04/03&nbsp;09:29:57&nbsp;kid1|&nbsp;fwdNegotiateSSL:&nbsp;Error&nbsp;negotiating&nbsp;SSL&nbsp;connection&nbsp;on&nbsp;FD&nbsp;14:&nbsp;error:14090086:SSL&nbsp;routines:SSL3_GET_SERVER_CERTIFICATE:certificate&nbsp;verify&nbsp;failed&nbsp;(1/-1/0)&lt;/div&gt;&lt;div&gt;2017/04/03&nbsp;09:29:57&nbsp;kid1|&nbsp;TCP&nbsp;connection&nbsp;to&nbsp;&lt;upstream&nbsp;IP&gt;/443&nbsp;failed&lt;/div&gt;&lt;div&gt;2017/04/03&nbsp;09:29:57&nbsp;kid1|&nbsp;fwdNegotiateSSL:&nbsp;Error&nbsp;negotiating&nbsp;SSL&nbsp;connection&nbsp;on&nbsp;FD&nbsp;14:&nbsp;error:14090086:SSL&nbsp;routines:SSL3_GET_SERVER_CERTIFICATE:certificate&nbsp;verify&nbsp;failed&nbsp;(1/-1/0)&lt;/div&gt;&lt;div&gt;2017/04/03&nbsp;09:29:57&nbsp;kid1|&nbsp;TCP&nbsp;connection&nbsp;to&nbsp;&lt;upstream&nbsp;IP&gt;/443&nbsp;failed&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;No&nbsp;request&nbsp;is&nbsp;visible&nbsp;in&nbsp;upstream&nbsp;Apache&nbsp;logs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
That&nbsp;Squid-&gt;server&nbsp;connection&nbsp;has&nbsp;zero&nbsp;difference&nbsp;between&nbsp;the&nbsp;browser&lt;br&gt;<br>
and&nbsp;the&nbsp;command&nbsp;line&nbsp;tool&nbsp;connecting&nbsp;to&nbsp;a&nbsp;reverse-proxy,&nbsp;or&nbsp;when&nbsp;both&lt;br&gt;<br>
are&nbsp;using&nbsp;opaque&nbsp;(non-Bumped)&nbsp;CONNECT&nbsp;tunnels.&nbsp;So&nbsp;one&nbsp;working&nbsp;and&nbsp;the&lt;br&gt;<br>
other&nbsp;not&nbsp;is&nbsp;impossible.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;I&nbsp;understand&nbsp;this.&nbsp;My&nbsp;problem&nbsp;now&nbsp;is&nbsp;finding&nbsp;what&nbsp;is&nbsp;failing&nbsp;in&nbsp;my&nbsp;setup.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Eric.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
