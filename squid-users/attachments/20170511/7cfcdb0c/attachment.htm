<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;Hi,&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Mi&nbsp;name&nbsp;is&nbsp;Juan,&nbsp;I&nbsp;am&nbsp;a&nbsp;Software&nbsp;Engineer&nbsp;from&nbsp;Uruguay. &lt;span&nbsp;style=&quot;font-size:small&quot;&gt;I&nbsp;think&nbsp;this&nbsp;message&nbsp;is&nbsp;more&nbsp;suited&nbsp;to&nbsp;the&nbsp;squid-dev&nbsp;mailing&nbsp;list&nbsp;due&nbsp;to&nbsp;the&nbsp;developer-oriented&nbsp;nature&nbsp;of&nbsp;the&nbsp;message&nbsp;but,&nbsp;given&nbsp;that&nbsp;the&nbsp;development&nbsp;list&nbsp;is&nbsp;for&nbsp;people&nbsp;who&nbsp;actually&nbsp;contributes&nbsp;code&nbsp;to&nbsp;Squid,&nbsp;I&nbsp;chose&nbsp;to&nbsp;post&nbsp;here.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;started&nbsp;using&nbsp;Squid&nbsp;a&nbsp;few&nbsp;days&nbsp;ago&nbsp;in&nbsp;order&nbsp;to&nbsp;test&nbsp;its&nbsp;content-adaptation&nbsp;capabilities.&nbsp;The&nbsp;plan&nbsp;was&nbsp;to&nbsp;test&nbsp;the&nbsp;ICAP&nbsp;implementation&nbsp;first&nbsp;and&nbsp;then&nbsp;maybe&nbsp;try&nbsp;the&nbsp;eCAP&nbsp;API&nbsp;as&nbsp;well.&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;In&nbsp;order&nbsp;to&nbsp;test&nbsp;ICAP,&nbsp;I&nbsp;based&nbsp;my&nbsp;code&nbsp;in&nbsp;the&nbsp;open&nbsp;source&nbsp;PYICAP&nbsp;project,&nbsp;I&nbsp;also&nbsp;ran&nbsp;some&nbsp;tests&nbsp;using&nbsp;the&nbsp;C-ICAP&nbsp;server.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;It&nbsp;came&nbsp;to&nbsp;my&nbsp;attention&nbsp;that,&nbsp;even&nbsp;when&nbsp;persistent&nbsp;connections&nbsp;is&nbsp;enabled,&nbsp;Squid&nbsp;closes&nbsp;the&nbsp;ICAP&nbsp;connection&nbsp;everytime&nbsp;a&nbsp;new&nbsp;request&nbsp;arrives,&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;1.&nbsp;A&nbsp;new&nbsp;request&nbsp;arrives&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;2.&nbsp;Squid&nbsp;creates&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;3.&nbsp;Content&nbsp;is&nbsp;adapted&nbsp;and&nbsp;returned&nbsp;to&nbsp;the&nbsp;client&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;4.&nbsp;Squid&nbsp;returns&nbsp;the&nbsp;connection&nbsp;to&nbsp;the&nbsp;connection&nbsp;pool&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;5.&nbsp;A&nbsp;new&nbsp;requests&nbsp;arrives&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;6.&nbsp;Squid&nbsp;closes&nbsp;the&nbsp;active&nbsp;connection&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;7.&nbsp;Squid&nbsp;opens&nbsp;a&nbsp;new&nbsp;connection&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Note:&nbsp;I&nbsp;am&nbsp;using&nbsp;only&nbsp;the&nbsp;RESPMOD&nbsp;method.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;This&nbsp;tests&nbsp;was&nbsp;performed&nbsp;using&nbsp;Squid&nbsp;3.5.x. &lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;downloaded&nbsp;the&nbsp;last&nbsp;available&nbsp;tarball&nbsp;(squid-4.0.19),&nbsp;and&nbsp;run&nbsp;the&nbsp;same&nbsp;test,&nbsp;which&nbsp;gave&nbsp;the&nbsp;same&nbsp;results.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;So&nbsp;I&nbsp;started&nbsp;digging&nbsp;into&nbsp;the&nbsp;source&nbsp;code&nbsp;and&nbsp;found&nbsp;something&nbsp;interesting:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;File:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; &nbsp;/src/adaptation/icap/&lt;wbr&gt;ServiceRep.cc&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Function: &lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; &nbsp;Adaptation::Icap::ServiceRep::&lt;wbr&gt;getConnection(bool&nbsp;retriableXact,&nbsp;bool&nbsp;&amp;reused)&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Code:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;div&gt; &nbsp; &nbsp;if&nbsp;(retriableXact)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;connection&nbsp;=&nbsp;theIdleConns-&gt;pop();&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;else&nbsp;{&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;theIdleConns-&gt;closeN(1);&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;}&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;The&nbsp;connection&nbsp;is&nbsp;taken&nbsp;from&nbsp;the&nbsp;set&nbsp;of&nbsp;idle&nbsp;connections&nbsp; ONLY&nbsp;if&nbsp;retriableXact&nbsp;is&nbsp;set&nbsp;to&nbsp;true.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;File:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; &nbsp;/src/adaptation/icap/Xaction.&lt;wbr&gt;cc&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Function:&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; &nbsp;Adaptation::Icap::Xaction::&lt;wbr&gt;openConnection()&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Xaction&nbsp;uses&nbsp;the&nbsp;member&nbsp;variable&nbsp;&#39;isRetriable&#39;&nbsp;as&nbsp;parameter&nbsp;for&nbsp;ServiceRep::getConnection.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;The&nbsp;function&nbsp;Xaction::disableRetries()&nbsp;is&nbsp;called&nbsp;from&nbsp;a&nbsp;lot&nbsp;of&nbsp;places,&nbsp;but&nbsp;in&nbsp;my&nbsp;test&nbsp;case&nbsp;was&nbsp;called&nbsp;only&nbsp;two&nbsp;times&nbsp;(per&nbsp;request):&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; 1.&nbsp;In&nbsp;the&nbsp;function Adaptation::Icap::&lt;wbr&gt;Xaction::noteCommRead,&nbsp;when&nbsp;Comm::ReadNow&nbsp;returns Comm::OK.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt; &nbsp; 2.&nbsp;In&nbsp;the&nbsp;function Adaptation::Icap::&lt;wbr&gt;Xaction::closeConnection,&nbsp;because reuseConnection&nbsp;is&nbsp;set&nbsp;to&nbsp;true.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;Xaction&nbsp;objects&nbsp;are&nbsp;reusable,&nbsp;it&nbsp;seems&nbsp;that&nbsp;they&nbsp;are&nbsp;because&nbsp;setting&nbsp;isRetriable&nbsp;to&nbsp;false&nbsp;is&nbsp;affecting&nbsp;the&nbsp;way&nbsp;connections&nbsp;are&nbsp;reused.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;Anyway,&nbsp;I&nbsp;think&nbsp;the&nbsp;concept&nbsp;of&nbsp;retriability&nbsp;shuld&nbsp;not&nbsp;be&nbsp;confused&nbsp;with&nbsp;the&nbsp;concept&nbsp;of&nbsp;reusability,&nbsp;but&nbsp;I&nbsp;haven&#39;t&nbsp;gone&nbsp;deep&nbsp;enough&nbsp;in&nbsp;order&nbsp;to&nbsp;ensure&nbsp;that.&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8px&quot;&gt;I&nbsp;appreciate&nbsp;your&nbsp;comments&nbsp;on&nbsp;this.&nbsp;Don&#39;t&nbsp;hesitate&nbsp;to&nbsp;contact&nbsp;me&nbsp;should&nbsp;a&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt;ny&nbsp;additional&nbsp;information&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:12.8px&quot;&gt; be&nbsp;needed.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Juan&lt;/div&gt;&lt;div&gt;:wq&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
