<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content:&nbsp;text/html;&nbsp;charset=utf-8&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/head&gt;<br>
&lt;body&gt;<br>
Thank&nbsp;you&nbsp;for&nbsp;all&nbsp;your&nbsp;suggestions&nbsp;Mister.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;improved&nbsp;my&nbsp;conf&nbsp;by&nbsp;them&nbsp;and&nbsp;disabled&nbsp;squidguard&nbsp;for&nbsp;testing&nbsp;and&nbsp;its<br>
working&nbsp;now&nbsp;fine&nbsp;without&nbsp;squidguard.&lt;br&gt;<br>
So&nbsp;I&nbsp;need&nbsp;to&nbsp;investigate&nbsp;why&nbsp;squidguard&nbsp;won't&nbsp;run&nbsp;with&nbsp;https&nbsp;sites&nbsp;on&nbsp;v<br>
3.5.25&lt;br&gt;<br>
&lt;br&gt;<br>
squidGuard&nbsp;-v&lt;br&gt;<br>
SquidGuard:&nbsp;1.5&nbsp;Berkeley&nbsp;DB&nbsp;5.3.28:&nbsp;(September&nbsp;&nbsp;9,&nbsp;2013)&lt;br&gt;<br>
&lt;br&gt;<br>
How&nbsp;can&nbsp;I&nbsp;find&nbsp;out&nbsp;what&nbsp;happens&nbsp;between&nbsp;Squid,&nbsp;SquidGuard&nbsp;at&nbsp;debian&nbsp;and<br>
Firefox&nbsp;at&nbsp;client&nbsp;side&nbsp;?&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;tried&nbsp;echo&nbsp;tests&nbsp;locally&nbsp;with&nbsp;squidguard&nbsp;but&nbsp;it&nbsp;only&nbsp;shows&nbsp;ERR&nbsp;results<br>
with&nbsp;https&nbsp;sites.&lt;br&gt;<br>
Http&nbsp;sites&nbsp;are&nbsp;working&nbsp;well&nbsp;as&nbsp;expected&nbsp;with&nbsp;squidguard&lt;br&gt;<br>
&lt;br&gt;<br>
Here&nbsp;my&nbsp;new&nbsp;squid.conf&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;span&nbsp;style=&quot;color:&nbsp;gray;&quot;&gt;05/29/17&nbsp;00:03:49,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a<br>
href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;:&lt;/span&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);margin:&nbsp;0&nbsp;0&nbsp;0<br>
0.8ex;padding:&nbsp;1ex&nbsp;0&nbsp;0&nbsp;1ex;&quot;&gt;On&nbsp;29/05/17&nbsp;07:52,&nbsp;Andi&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;installed&nbsp;Squid&nbsp;3.5.25&nbsp;at&nbsp;debian&nbsp;with&nbsp;libecap3&nbsp;too.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Now&nbsp;my&nbsp;old&nbsp;squid.conf&nbsp;file&nbsp;for&nbsp;v3.48&nbsp;not&nbsp;work&nbsp;anymore&nbsp;for&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;redirected&nbsp;https&nbsp;websites.&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;get&nbsp;SSL_ERROR_RX_RECORD_TOO_LONG&nbsp;in&nbsp;Firefox.&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;redirected&nbsp;them&nbsp;before&nbsp;by&nbsp;Shorewall&nbsp;and&nbsp;it&nbsp;worked&nbsp;with&nbsp;v3.48&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#SQUID-PORTS&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REDIRECT&nbsp;&nbsp;&nbsp;&nbsp;loc&nbsp;&nbsp;&nbsp;&nbsp;3140&nbsp;tcp&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;!192.168.1.254&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REDIRECT&nbsp;&nbsp;&nbsp;&nbsp;loc&nbsp;&nbsp;&nbsp;&nbsp;3139&nbsp;tcp&nbsp;&nbsp;&nbsp;&nbsp;www&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;!192.168.1.254&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;I&nbsp;change&nbsp;https_port&nbsp;to&nbsp;http_port&nbsp;and&nbsp;remove&nbsp;the&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;option&nbsp;for&nbsp;ssl_bump&nbsp;it&nbsp;works&nbsp;with&nbsp;expicit&nbsp;configured&nbsp;clients<br>
for&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;port&nbsp;even&nbsp;for&nbsp;gmail&nbsp;website&nbsp;too.&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;What&nbsp;I&nbsp;need&nbsp;to&nbsp;change&nbsp;to&nbsp;make&nbsp;squid&nbsp;3.5&nbsp;work&nbsp;transparently&nbsp;&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
SSL_ERROR_RX_RECORD_TOO_LONG&nbsp;is&nbsp;apparently&nbsp;what&nbsp;gets&nbsp;displayed&nbsp;if&nbsp;the&nbsp;&lt;br&gt;<br>
response&nbsp;coming&nbsp;back&nbsp;from&nbsp;an&nbsp;attempted&nbsp;TLS/SSL&nbsp;connection&nbsp;is&nbsp;not&nbsp;TLS/SSL<br>
&lt;br&gt;<br>
protocol.&nbsp;Such&nbsp;as&nbsp;Squid&nbsp;responding&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;error&nbsp;message,&nbsp;or&nbsp;&lt;br&gt;<br>
something&nbsp;like&nbsp;that&nbsp;happening.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;below&nbsp;config&nbsp;has&nbsp;port&nbsp;3128&nbsp;for&nbsp;explicit-proxy&nbsp;traffic,&nbsp;port&nbsp;3139&nbsp;&lt;br&gt;<br>
for&nbsp;intercepted&nbsp;port&nbsp;80&nbsp;traffic,&nbsp;and&nbsp;3140&nbsp;for&nbsp;intercepted&nbsp;port&nbsp;443<br>
traffic.&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;log&nbsp;startup&nbsp;confirms&nbsp;that:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&gt;&nbsp;2017/05/28&nbsp;16:07:55.701|&nbsp;Accepting&nbsp;HTTP&nbsp;Socket&nbsp;connections&nbsp;at&nbsp;&lt;br&gt;<br>
local=0.0.0.0:3138&nbsp;remote=[::]&nbsp;FD&nbsp;28&nbsp;flags=9&lt;br&gt;<br>
&nbsp;&gt;&nbsp;2017/05/28&nbsp;16:07:55.702|&nbsp;Accepting&nbsp;NAT&nbsp;intercepted&nbsp;HTTP&nbsp;Socket&nbsp;&lt;br&gt;<br>
connections&nbsp;at&nbsp;local=0.0.0.0:3139&nbsp;remote=[::]&nbsp;FD&nbsp;29&nbsp;flags=41&lt;br&gt;<br>
&nbsp;&gt;&nbsp;2017/05/28&nbsp;16:07:55.702|&nbsp;Accepting&nbsp;NAT&nbsp;intercepted&nbsp;SSL&nbsp;bumped&nbsp;HTTPS<br>
&lt;br&gt;<br>
Socket&nbsp;connections&nbsp;at&nbsp;local=0.0.0.0:3140&nbsp;remote=[::]&nbsp;FD&nbsp;30&nbsp;flags=41&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;first&nbsp;thing&nbsp;I&nbsp;would&nbsp;check&nbsp;is&nbsp;that&nbsp;the&nbsp;shorewall&nbsp;definitions&nbsp;of&nbsp;&lt;br&gt;<br>
&quot;https&quot;&nbsp;and&nbsp;&quot;www&quot;&nbsp;are&nbsp;actually&nbsp;80&nbsp;and&nbsp;443&nbsp;respectively.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;try&nbsp;to&nbsp;find&nbsp;out&nbsp;what&nbsp;Squid&nbsp;is&nbsp;sending&nbsp;to&nbsp;Firefox&nbsp;that&nbsp;would&nbsp;result<br>
&lt;br&gt;<br>
in&nbsp;that&nbsp;particular&nbsp;error.&nbsp;I&nbsp;suspect&nbsp;either&nbsp;ICAP&nbsp;or&nbsp;SquidGuard&nbsp;is&nbsp;trying<br>
&lt;br&gt;<br>
to&nbsp;change&nbsp;or&nbsp;produce&nbsp;a&nbsp;plan-text&nbsp;response&nbsp;to&nbsp;the&nbsp;initial&nbsp;CONNECT&nbsp;&lt;br&gt;<br>
messages&nbsp;Squid&nbsp;uses&nbsp;internally&nbsp;for&nbsp;the&nbsp;SSL-Bump&nbsp;steps.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
NP:&nbsp;the&nbsp;&quot;abandoning&quot;&nbsp;messages&nbsp;in&nbsp;cache.log&nbsp;are&nbsp;nothing&nbsp;to&nbsp;worry&nbsp;about&nbsp;&lt;br&gt;<br>
when&nbsp;you&nbsp;are&nbsp;ssl-bump'ing&nbsp;with&nbsp;Squid-3,&nbsp;it&nbsp;is&nbsp;just&nbsp;an&nbsp;annoying&nbsp;&lt;br&gt;<br>
side-effect&nbsp;of&nbsp;how&nbsp;SSL-Bump&nbsp;takes&nbsp;the&nbsp;connection&nbsp;away&nbsp;from&nbsp;the&nbsp;normal&nbsp;&lt;br&gt;<br>
CONNECT&nbsp;tunnel&nbsp;handling&nbsp;code.&nbsp;IIRC&nbsp;it&nbsp;has&nbsp;been&nbsp;fixed&nbsp;in&nbsp;Squid-4&nbsp;along&nbsp;&lt;br&gt;<br>
with&nbsp;a&nbsp;lot&nbsp;of&nbsp;similar&nbsp;little&nbsp;PITA&nbsp;things.&lt;br&gt;<br>
&lt;br&gt;<br>
PS.&nbsp;I've&nbsp;highlighted&nbsp;some&nbsp;improvements&nbsp;you&nbsp;can&nbsp;make&nbsp;to&nbsp;the&nbsp;config&nbsp;below.<br>
&lt;br&gt;<br>
They&nbsp;are&nbsp;not&nbsp;related&nbsp;to&nbsp;your&nbsp;problem&nbsp;though.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;squid&nbsp;-v&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.25&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Service&nbsp;Name:&nbsp;squid&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configure&nbsp;options:&nbsp;&nbsp;'--build=x86_64-linux-gnu'&nbsp;'--prefix=/usr'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--localstatedir=/var/squid'&nbsp;'--libexecdir=/lib/squid'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--srcdir=.'&nbsp;'--datadir=/share/squid'<br>
'--sysconfdir=/etc/squid'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--disable-ipv6'&nbsp;'--with-default-user=proxy'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--with-logdir=/var/log/squid35'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--with-pidfile=/var/run/squid35.pid'&nbsp;'--with-openssl'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-ssl-crtd'&nbsp;'--infodir=/share/info'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--includedir=/include'&nbsp;'--mandir=/usr/share/man'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-inline'&nbsp;'--disable-arch-native'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--disable-maintainer-mode'&nbsp;'--disable-dependency-tracking'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--disable-silent-rules'&nbsp;'--enable-async-io=8'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-storeio=ufs,aufs,diskd,rock'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-removal-policies=lru,heap'&nbsp;'--enable-delay-pools'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-cache-digests'&nbsp;'--enable-icap-client'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-follow-x-forwarded-for'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;<br>
'--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-auth-digest=file,LDAP'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-auth-negotiate=kerberos,wrapper'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-auth-ntlm=fake,smb_lm'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;<br>
'--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,unix_group,wbinfo_group'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-url-rewrite-helpers=fake'&nbsp;'--enable-eui'<br>
'--enable-esi'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--enable-icmp'&nbsp;'--enable-zph-qos'&nbsp;'--enable-ecap'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--disable-translation'&nbsp;'--with-filedescriptors=65536'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'--with-large-files'&nbsp;'--enable-linux-netfilter'&nbsp;'CFLAGS=-g&nbsp;-O2&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-fPIE&nbsp;-fstack-protector-strong&nbsp;-Wformat<br>
-Werror=format-security&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-Wall'&nbsp;'LDFLAGS=-fPIE&nbsp;-pie&nbsp;-Wl,-z,relro&nbsp;-Wl,-z,now'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'CPPFLAGS=-D_FORTIFY_SOURCE=2'&nbsp;'CXXFLAGS=-g&nbsp;-O2&nbsp;-fPIE&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-fstack-protector-strong&nbsp;-Wformat&nbsp;-Werror=format-security'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'build_alias=x86_64-linux-gnu'&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cat&nbsp;/etc/squid/squid.conf:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug_options&nbsp;ALL,6&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#0&nbsp;26,2&nbsp;83,2&nbsp;33,2&nbsp;17,2&nbsp;44,2&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logformat&nbsp;datetime&nbsp;&nbsp;%tl&nbsp;%6tr&nbsp;CLIENT:%&gt;a&nbsp;=&nbsp;=&nbsp;%Ss&nbsp;%&lt;Hs<br>
%rm=%&gt;ru&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--%[un&nbsp;%Sh/%&lt;a&nbsp;%mt&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;&nbsp;/var/log/squid35/access.log&nbsp;datetime&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forwarded_for&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error_directory&nbsp;/usr/share/squid/errors/de-de/&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Have&nbsp;you&nbsp;altered&nbsp;or&nbsp;otherwise&nbsp;touched&nbsp;the&nbsp;files&nbsp;in&nbsp;that&nbsp;directory?&lt;br&gt;<br>
If&nbsp;not&nbsp;I&nbsp;suggest&nbsp;using&nbsp;this&nbsp;instead:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;error_default_language&nbsp;de-de&lt;br&gt;<br>
&lt;&lt;a<br>
href=&quot;http://master.squid-cache.org/Doc/config/error_default_language/&quot;&gt;http://master.squid-cache.org/Doc/config/error_default_language/&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;localnet&nbsp;src&nbsp;192.168.1.0/24&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ftp&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;https&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gopher&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;wais&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;&nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http-mgmt&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gss-http&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;filemaker&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;multiling&nbsp;http&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;manager&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;to_localhost&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_reply_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
No&nbsp;need&nbsp;to&nbsp;explicitly&nbsp;&quot;allow&nbsp;all&quot;&nbsp;for&nbsp;replies.&nbsp;That&nbsp;happens&nbsp;anyway.&nbsp;That<br>
&lt;br&gt;<br>
directive&nbsp;is&nbsp;mostly&nbsp;useful&nbsp;to&nbsp;deny&nbsp;things.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icp_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icp_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;###&nbsp;NEW&nbsp;for&nbsp;v3.5x&nbsp;SSL-Bump&nbsp;###&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;always_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
That&nbsp;&quot;always_direct&quot;&nbsp;was&nbsp;a&nbsp;hack&nbsp;to&nbsp;workaround&nbsp;a&nbsp;bug&nbsp;in&nbsp;the&nbsp;first&nbsp;&lt;br&gt;<br>
ssl-bump&nbsp;code.&nbsp;It&nbsp;is&nbsp;long&nbsp;since&nbsp;irrelevant.&nbsp;I&nbsp;recommend&nbsp;removing&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;splice&nbsp;localhost&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#acl&nbsp;exclude_sites&nbsp;ssl::server_name_regex&nbsp;-i&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&quot;/var/lib/squidguard/db/BL/whitelist-ssl/whitelist.destdomainlist&quot;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#ssl_bump&nbsp;splice&nbsp;exclude_sites&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;stare&nbsp;step2&nbsp;all&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;don't&nbsp;need&nbsp;the&nbsp;&quot;all&quot;&nbsp;on&nbsp;the&nbsp;above&nbsp;lines.&nbsp;The&nbsp;&quot;step2&nbsp;all&quot;&nbsp;is&nbsp;both&nbsp;&lt;br&gt;<br>
unnecessary&nbsp;and&nbsp;adds&nbsp;confusion&nbsp;since&nbsp;that&nbsp;line&nbsp;does&nbsp;*not*&nbsp;apply&nbsp;to&nbsp;all&nbsp;&lt;br&gt;<br>
step2&nbsp;traffic&nbsp;-&nbsp;some&nbsp;was&nbsp;spliced&nbsp;instead&nbsp;by&nbsp;the&nbsp;previous&nbsp;line.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#############################&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;0.0.0.0:3138&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;0.0.0.0:3139&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslproxy_cert_adapt&nbsp;setCommonName&nbsp;ssl::certDomainMismatch&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https_port&nbsp;0.0.0.0:3140&nbsp;intercept&nbsp;ssl-bump&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=16MB&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cert=/etc/squid/myca.pem&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslproxy_options&nbsp;NO_SSLv2,NO_SSLv3,SINGLE_DH_USE&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslproxy_capath&nbsp;/etc/ssl/certs&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##sslproxy_cafile&nbsp;/etc/ssl/certs/ca-certificates.crt&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_program&nbsp;/bin/ssl_crtd&nbsp;-s&nbsp;/var/spool/squid_ssldb&nbsp;-M<br>
16MB&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_children&nbsp;10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_dir&nbsp;ufs&nbsp;/etc/squid/ssl_db&nbsp;100&nbsp;16&nbsp;256&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Why&nbsp;are&nbsp;you&nbsp;storing&nbsp;all&nbsp;cacheable&nbsp;*HTTP*&nbsp;objects&nbsp;into&nbsp;/etc/squid/ssl_db<br>
?&lt;br&gt;<br>
&nbsp;&nbsp;especially&nbsp;since&nbsp;your&nbsp;SSL&nbsp;certificate&nbsp;store&nbsp;is&nbsp;/var/spool/squid_ssldb<br>
?&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_mgr&nbsp;admin@mainrouter&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visible_hostname&nbsp;xxx&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpd_suppress_version_string&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coredump_dir&nbsp;/var/spool/squid&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;^ftp:&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10080&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;^gopher:&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4320&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_effective_user&nbsp;proxy&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;built&nbsp;this&nbsp;proxy&nbsp;with&nbsp;--with-default-user=proxy&nbsp;,&nbsp;which&nbsp;sets&nbsp;the&nbsp;&lt;br&gt;<br>
default&nbsp;value&nbsp;of&nbsp;cache_effective_user&nbsp;to&nbsp;&quot;proxy&quot;,&nbsp;no&nbsp;need&nbsp;to&nbsp;repeat&nbsp;that<br>
&lt;br&gt;<br>
in&nbsp;squid.conf.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_enable&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_send_client_ip&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_send_client_username&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_client_username_encode&nbsp;off&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_client_username_header&nbsp;X-Authenticated-User&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_preview_enable&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_preview_size&nbsp;1024&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_service&nbsp;service_req&nbsp;reqmod_precache&nbsp;bypass=0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap://127.0.0.1:1344/squidclamav&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap_service&nbsp;service_resp&nbsp;respmod_precache&nbsp;bypass=0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icap://127.0.0.1:1344/squidclamav&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adaptation_access&nbsp;service_req&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adaptation_access&nbsp;service_resp&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;redirect_program&nbsp;/usr/bin/squidGuard&nbsp;-c&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/etc/squidguard/squidGuard.conf&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_effective_group&nbsp;proxy&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;should&nbsp;be&nbsp;no&nbsp;need&nbsp;for&nbsp;that&nbsp;cache_effective_group&nbsp;directive&nbsp;to&nbsp;be&nbsp;&lt;br&gt;<br>
used.&nbsp;Simply&nbsp;check&nbsp;and&nbsp;limit&nbsp;the&nbsp;groups&nbsp;the&nbsp;cache_effective_user&nbsp;account<br>
&lt;br&gt;<br>
is&nbsp;a&nbsp;member&nbsp;of.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dns_nameservers&nbsp;8.8.8.8&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Using&nbsp;that&nbsp;DNS&nbsp;service&nbsp;directly&nbsp;in&nbsp;Squid&nbsp;is&nbsp;particularly&nbsp;nasty.&nbsp;Each&nbsp;DNS<br>
&lt;br&gt;<br>
query&nbsp;usually&nbsp;hits&nbsp;a&nbsp;different&nbsp;server&nbsp;in&nbsp;their&nbsp;farm&nbsp;and&nbsp;thus&nbsp;gets&nbsp;&lt;br&gt;<br>
different&nbsp;set&nbsp;of&nbsp;response&nbsp;IP&nbsp;addresses.&nbsp;I&nbsp;strongly&nbsp;recommend&nbsp;that&nbsp;you&nbsp;&lt;br&gt;<br>
setup&nbsp;some&nbsp;local&nbsp;DNS&nbsp;recursive&nbsp;resolver&nbsp;that&nbsp;both&nbsp;the&nbsp;clients&nbsp;and&nbsp;Squid<br>
&lt;br&gt;<br>
can&nbsp;use.&nbsp;That&nbsp;resolver&nbsp;can&nbsp;of&nbsp;course&nbsp;pass&nbsp;its&nbsp;traffic&nbsp;to&nbsp;8.8.8.8&nbsp;if&nbsp;you<br>
&lt;br&gt;<br>
actually&nbsp;need&nbsp;to.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
squid-users@lists.squid-cache.org&lt;br&gt;<br>
&lt;a<br>
href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
