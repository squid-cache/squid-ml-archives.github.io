<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;recently&nbsp;updated&nbsp;from&nbsp;squid&nbsp;v2&nbsp;to&nbsp;v3&nbsp;and&nbsp;now&nbsp;see&nbsp;huge&nbsp;increase&nbsp;in&nbsp;connections&nbsp;in&nbsp;TIME_WAIT&nbsp;state&nbsp;on&nbsp;our&nbsp;squid&nbsp;servers&nbsp;(verified&nbsp;that&nbsp;this&nbsp;is&nbsp;clients&nbsp;connections).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&nbsp;versions&nbsp;and&nbsp;amount&nbsp;of&nbsp;such&nbsp;connections&nbsp;under&nbsp;the&nbsp;same&nbsp;load&nbsp;with&nbsp;the&nbsp;same&nbsp;configs&nbsp;(except&nbsp;some&nbsp;incompatible&nbsp;stuff):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid&nbsp;2.7.STABLE9&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;configure&nbsp;options:&nbsp; &#39;--program-prefix=&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--exec-prefix=/usr&#39;&nbsp;&#39;--bindir=/usr/bin&#39;&nbsp;&#39;--sbindir=/usr/sbin&#39;&nbsp;&#39;--sysconfdir=/etc&#39;&nbsp;&#39;--includedir=/usr/include&#39;&nbsp;&#39;--libdir=/usr/lib&#39;&nbsp;&#39;--libexecdir=/usr/libexec&#39;&nbsp;&#39;--sharedstatedir=/usr/com&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--infodir=/usr/share/info&#39;&nbsp;&#39;--exec_prefix=/usr&#39;&nbsp;&#39;--bindir=/usr/sbin&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--datadir=/usr/share&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--enable-epoll&#39;&nbsp;&#39;--enable-removal-policies=heap,lru&#39;&nbsp;&#39;--enable-storeio=aufs&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--with-pthreads&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-useragent-log&#39;&nbsp;&#39;--enable-referer-log&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-maxfd=16384&#39;&nbsp;&#39;--enable-err-languages=English&#39;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;netstat&nbsp;-tn&nbsp;|&nbsp;grep&nbsp;TIME_WAIT&nbsp;|&nbsp;grep&nbsp;3128&nbsp;|&nbsp;wc&nbsp;-l&lt;/div&gt;&lt;div&gt;95&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid&nbsp;3.5.25&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;configure&nbsp;options:&nbsp; &#39;--program-prefix=&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--exec-prefix=/usr&#39;&nbsp;&#39;--bindir=/usr/sbin&#39;&nbsp;&#39;--sbindir=/usr/sbin&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--libdir=/usr/lib&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--includedir=/usr/include&#39;&nbsp;&#39;--datadir=/usr/share&#39;&nbsp;&#39;--sharedstatedir=/usr/com&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--infodir=/usr/share/info&#39;&nbsp;&#39;--enable-epoll&#39;&nbsp;&#39;--enable-removal-policies=heap,lru&#39;&nbsp;&#39;--enable-storeio=aufs&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--with-pthreads&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-useragent-log&#39;&nbsp;&#39;--enable-referer-log&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-maxfd=16384&#39;&nbsp;&#39;--enable-err-languages=English&#39;&nbsp;&#39;--enable-htcp&#39;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;netstat&nbsp;-tn&nbsp;|&nbsp;grep&nbsp;TIME_WAIT&nbsp;|&nbsp;grep&nbsp;3128&nbsp;|&nbsp;wc&nbsp;-l&lt;/div&gt;&lt;div&gt;11277&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Config:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:3128&quot;&gt;0.0.0.0:3128&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp; &nbsp; &nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp; #&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;ftp&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;gopher&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;wais&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http-mgmt&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;gss-http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;filemaker&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;multiling&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp; #&nbsp;unregistered&nbsp;ports&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;###&nbsp;START&nbsp;CUSTOM&lt;/div&gt;&lt;div&gt;acl&nbsp;Purge_method&nbsp;method&nbsp;PURGE&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Allow&nbsp;localhost&nbsp;to&nbsp;selectively&nbsp;flush&nbsp;the&nbsp;cache&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;Purge_method&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;Purge_method&lt;/div&gt;&lt;div&gt;###&nbsp;END&nbsp;CUSTOM&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;###&nbsp;ALLOW&nbsp;ACCESS&nbsp;TO&nbsp;ALL&nbsp;PORTS&lt;/div&gt;&lt;div&gt;#&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;manager&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;###&nbsp;START&nbsp;CUSTOM&lt;/div&gt;&lt;div&gt;#&nbsp;Disable&nbsp;icp&lt;/div&gt;&lt;div&gt;icp_port&nbsp;0&lt;/div&gt;&lt;div&gt;#&nbsp;Allow&nbsp;ICP&nbsp;queries&nbsp;from&nbsp;local&nbsp;networks&nbsp;only&lt;/div&gt;&lt;div&gt;icp_access&nbsp;allow&nbsp;localnet&lt;/div&gt;&lt;div&gt;icp_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;icp_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Disable&nbsp;htcp&lt;/div&gt;&lt;div&gt;htcp_port&nbsp;0&lt;/div&gt;&lt;div&gt;#&nbsp;Allow&nbsp;HTCP&nbsp;queries&nbsp;from&nbsp;local&nbsp;networks&nbsp;only&lt;/div&gt;&lt;div&gt;htcp_access&nbsp;allow&nbsp;localnet&lt;/div&gt;&lt;div&gt;htcp_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;htcp_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Check&nbsp;for&nbsp;custom&nbsp;request&nbsp;header&lt;/div&gt;&lt;div&gt;acl&nbsp;custom_acl&nbsp;req_header&nbsp;x-use-custom-proxy&nbsp;-i&nbsp;true&lt;/div&gt;&lt;div&gt;#&nbsp;Check&nbsp;for&nbsp;x-use-new-proxy&nbsp;request&nbsp;header&lt;/div&gt;&lt;div&gt;acl&nbsp;custom_new_acl&nbsp;req_header&nbsp;x-use-new-proxy&nbsp;-i&nbsp;true&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;first_proxy&lt;/div&gt;&lt;div&gt;cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18070&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=first_proxy&lt;/div&gt;&lt;div&gt;cache_peer_access&nbsp;first_proxy&nbsp;deny&nbsp;custom_acl&lt;/div&gt;&lt;div&gt;cache_peer_access&nbsp;first_proxy&nbsp;deny&nbsp;custom_new_acl&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;second_proxy&lt;/div&gt;&lt;div&gt;cache_peer&nbsp;127.0.0.1&nbsp;parent&nbsp;18079&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=second_proxy&lt;/div&gt;&lt;div&gt;cache_peer_access&nbsp;second_proxy&nbsp;allow&nbsp;custom_acl&lt;/div&gt;&lt;div&gt;cache_peer_access&nbsp;second_proxy&nbsp;allow&nbsp;custom_new_acl&lt;/div&gt;&lt;div&gt;cache_peer_access&nbsp;second_proxy&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;never_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_mem&nbsp;4620591&nbsp;KB&lt;/div&gt;&lt;div&gt;maximum_object_size_in_memory&nbsp;8&nbsp;KB&lt;/div&gt;&lt;div&gt;memory_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt;cache_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_dir&nbsp;aufs&nbsp;/mnt/services/squid/cache&nbsp;891289&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;minimum_object_size&nbsp;64&nbsp;bytes&nbsp;#&nbsp;none-zero&nbsp;so&nbsp;we&nbsp;dont&nbsp;cache&nbsp;mistakes&lt;/div&gt;&lt;div&gt;maximum_object_size&nbsp;102400&nbsp;KB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;logformat&nbsp;combined&nbsp;%&gt;a&nbsp;%ui&nbsp;%un&nbsp;[%tl]&nbsp;&quot;%rm&nbsp;%ru&nbsp;HTTP/%rv&quot;&nbsp;%&gt;Hs&nbsp;%&lt;st&nbsp;%tr&nbsp;&quot;%{Referer}&gt;h&quot;&nbsp;&quot;%{User-Agent}&gt;h&quot;&nbsp;%Ss:%Sh&lt;/div&gt;&lt;div&gt;logformat&nbsp;squid&nbsp;%ts.%03tu&nbsp;%6tr&nbsp;%&gt;a&nbsp;%Ss/%03&gt;Hs&nbsp;%&lt;st&nbsp;%rm&nbsp;%ru&nbsp;%un&nbsp;%Sh/%&lt;A&nbsp;%mt&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;access_log&nbsp;stdio:/var/log/squid/access.log&nbsp;combined&lt;/div&gt;&lt;div&gt;cache_log&nbsp;/var/log/squid/cache.log&lt;/div&gt;&lt;div&gt;cache_store_log&nbsp;none&lt;/div&gt;&lt;div&gt;logfile_rotate&nbsp;0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_db&nbsp;off&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;pid_filename&nbsp;/var/run/squid.pid&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/cache&lt;/div&gt;&lt;div&gt;###&nbsp;END&nbsp;CUSTOM&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^ftp:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1440&nbsp; &nbsp; 20%&nbsp; &nbsp; &nbsp;10080&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^gopher:&nbsp; &nbsp; &nbsp; &nbsp; 1440&nbsp; &nbsp; 0%&nbsp; &nbsp; &nbsp; 1440&lt;/div&gt;&lt;div&gt;#&nbsp;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp; &nbsp; &nbsp;0%&nbsp; &nbsp; &nbsp; 0&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;20%&nbsp; &nbsp; &nbsp;4320&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;###&nbsp;START&nbsp;CUSTOM&lt;/div&gt;&lt;div&gt;#&nbsp;don&#39;t&nbsp;cache&nbsp;errors&lt;/div&gt;&lt;div&gt;negative_ttl&nbsp;0&nbsp;minutes&lt;/div&gt;&lt;div&gt;#&nbsp;always&nbsp;fetch&nbsp;object&nbsp;from&nbsp;the&nbsp;beginning&nbsp;regardless&nbsp;of&nbsp;Range&nbsp;requests&lt;/div&gt;&lt;div&gt;range_offset_limit&nbsp;none&lt;/div&gt;&lt;div&gt;cache_effective_user&nbsp;squid&lt;/div&gt;&lt;div&gt;cache_effective_group&nbsp;squid&lt;/div&gt;&lt;div&gt;max_filedescriptors&nbsp;524288&lt;/div&gt;&lt;div&gt;via&nbsp;off&lt;/div&gt;&lt;div&gt;forwarded_for&nbsp;delete&lt;/div&gt;&lt;div&gt;###&nbsp;END&nbsp;CUSTOM&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;tried&nbsp;&quot;half_closed_clients&nbsp;on&quot;&nbsp;but&nbsp;it&nbsp;didn&#39;t&nbsp;help.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;ideas?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
