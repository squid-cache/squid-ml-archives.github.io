<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jun&nbsp;13,&nbsp;2017&nbsp;at&nbsp;3:15&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;13/06/17&nbsp;18:14,&nbsp;David&nbsp;Kewley&nbsp;wrote:&lt;br&gt;<br>
&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;This&nbsp;might&nbsp;be&nbsp;of&nbsp;help&nbsp;if&nbsp;you&nbsp;are&nbsp;not&nbsp;already&nbsp;aware&nbsp;of&nbsp;the&nbsp;risks&nbsp;and&nbsp;issues&nbsp;involved&nbsp;with&nbsp;spoofing&nbsp;and&nbsp;handling&nbsp;of&nbsp;non-local&nbsp;IPs;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://www.bcp38.info/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.bcp38.info/&lt;/a&gt;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;was&nbsp;aware&nbsp;of&nbsp;at&nbsp;least&nbsp;most&nbsp;of&nbsp;those&nbsp;issues,&nbsp;though&nbsp;I&#39;m&nbsp;not&nbsp;an&nbsp;expert&nbsp;on&nbsp;them.&nbsp;So&nbsp;the&nbsp;reference&nbsp;is&nbsp;useful,&nbsp;thanks. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;squid&nbsp;server&nbsp;will&nbsp;only&nbsp;accept&nbsp;connections&nbsp;from&nbsp;its&nbsp;internal&nbsp;IP&nbsp;spaces,&nbsp;and&nbsp;I&nbsp;only&nbsp;wanted&nbsp;it&nbsp;to&nbsp;spoof&nbsp;the&nbsp;actual&nbsp;client&nbsp;source&nbsp;IPs&nbsp;to&nbsp;make&nbsp;downstream&nbsp;decision&nbsp;making&nbsp;easier&nbsp;based&nbsp;on&nbsp;the&nbsp;IP&nbsp;headers&nbsp;(but&nbsp;X-Forwarded-For&nbsp;might&nbsp;be&nbsp;sufficient,&nbsp;as&nbsp;you&nbsp;pointed&nbsp;out).&nbsp;Also&nbsp;the&nbsp;actual&nbsp;egress&nbsp;point&nbsp;to&nbsp;the&nbsp;internet&nbsp;is&nbsp;a&nbsp;NAT&nbsp;device&nbsp;that&nbsp;always&nbsp;uses&nbsp;its&nbsp;external&nbsp;IP&nbsp;as&nbsp;the&nbsp;source&nbsp;IP.&nbsp;So&nbsp;I&nbsp;see&nbsp;zero&nbsp;risk&nbsp;of&nbsp;us&nbsp;leaking&nbsp;foreign&nbsp;spoofed&nbsp;source&nbsp;IP&nbsp;addresses.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;will&nbsp;take&nbsp;a&nbsp;look&nbsp;at&nbsp;our&nbsp;ingress&nbsp;filtering&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&#39;re&nbsp;rejecting&nbsp;external&nbsp;inbound&nbsp;packets&nbsp;claiming&nbsp;to&nbsp;be&nbsp;from&nbsp;our&nbsp;internal&nbsp;network.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Do&nbsp;you&nbsp;see&nbsp;anything&nbsp;obvious&nbsp;I&#39;m&nbsp;missing&nbsp;around&nbsp;what&nbsp;I&nbsp;should&nbsp;do&nbsp;for&nbsp;BCP38?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;taking&nbsp;seriously&nbsp;your&nbsp;warning&nbsp;about&nbsp;a&nbsp;significant&nbsp;performance&nbsp;impact.&nbsp;I&#39;ll&nbsp;be&nbsp;curious&nbsp;to&nbsp;see&nbsp;if&nbsp;similar&nbsp;issues&nbsp;impact&nbsp;our&nbsp;nginx&nbsp;reverse&nbsp;proxies&nbsp;that&nbsp;spoof&nbsp;the&nbsp;original&nbsp;source&nbsp;IP&nbsp;in&nbsp;the&nbsp;proxied&nbsp;connection.&nbsp;Makes&nbsp;sense&nbsp;it&nbsp;might.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt; &nbsp; &nbsp;Squid&nbsp;supports&nbsp;X-Forwarded-For&nbsp;fully&nbsp;-&nbsp;it&nbsp;was&nbsp;invented&nbsp;by&nbsp;Squid&lt;br&gt;<br>
 &nbsp; &nbsp;devs&nbsp;back&nbsp;in&nbsp;the&nbsp;day,&nbsp;and&nbsp;Squid&nbsp;is&nbsp;still&nbsp;the&nbsp;authoritative&lt;br&gt;<br>
 &nbsp; &nbsp;implementation&nbsp;for&nbsp;how&nbsp;it&nbsp;is&nbsp;supposed&nbsp;to&nbsp;work.&nbsp;As&nbsp;an&nbsp;old&nbsp;feature&lt;br&gt;<br>
 &nbsp; &nbsp;just&nbsp;about&nbsp;all&nbsp;other&nbsp;HTTP&nbsp;server&nbsp;and&nbsp;intermediary&nbsp;software&nbsp;have&lt;br&gt;<br>
 &nbsp; &nbsp;support&nbsp;for&nbsp;that&nbsp;too&nbsp;so&nbsp;you&nbsp;should&nbsp;have&nbsp;no&nbsp;issue&nbsp;pulling&nbsp;the&nbsp;data&lt;br&gt;<br>
 &nbsp; &nbsp;out&nbsp;at&nbsp;the&nbsp;receiving&nbsp;end,&nbsp;or&nbsp;in&nbsp;HTTP&nbsp;processing&nbsp;DPI&nbsp;software&nbsp;/&lt;br&gt;<br>
 &nbsp; &nbsp;firewalls&nbsp;etc.&nbsp;It&nbsp;is&nbsp;sent&nbsp;on&nbsp;all&nbsp;outgoing&nbsp;Squid&nbsp;messages&nbsp;unless&lt;br&gt;<br>
 &nbsp; &nbsp;you&nbsp;explicitly&nbsp;configure&nbsp;something&nbsp;else&nbsp;to&nbsp;happen&nbsp;with&nbsp;the&lt;br&gt;<br>
 &nbsp; &nbsp;forwarded_for&nbsp;directive.&lt;br&gt;<br>
 &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Doc/config/forwarded_for/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.squid-cache.org/D&lt;wbr&gt;oc/config/forwarded_for/&lt;/a&gt;&lt;br&gt;<br>
 &nbsp; &nbsp;&lt;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Doc/config/forwarded_for/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.squid-cache.org/Do&lt;wbr&gt;c/config/forwarded_for/&lt;/a&gt;&gt;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;ll&nbsp;ask&nbsp;the&nbsp;team&nbsp;managing&nbsp;the&nbsp;next-hop&nbsp;device&nbsp;to&nbsp;evaluate&nbsp;that&nbsp;possibility;&nbsp;it&nbsp;looks&nbsp;to&nbsp;me&nbsp;from&nbsp;the&nbsp;docs&nbsp;like&nbsp;it&nbsp;might&nbsp;work.&nbsp;Thanks&nbsp;for&nbsp;the&nbsp;suggestion.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
That&nbsp;would&nbsp;be&nbsp;best&nbsp;if&nbsp;it&nbsp;works.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;came&nbsp;up&nbsp;with&nbsp;a&nbsp;bodgy&nbsp;workaround&nbsp;using&nbsp;NAT&nbsp;after&nbsp;sending&nbsp;the&nbsp;earlier&nbsp;mail.&nbsp;So&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;other&nbsp;way&nbsp;than&nbsp;delivering&nbsp;the&nbsp;client-IP&nbsp;on&nbsp;the&nbsp;packets&nbsp;there&nbsp;is&nbsp;still&nbsp;something&nbsp;that&nbsp;might&nbsp;be&nbsp;done.&nbsp;But,&nbsp;that&nbsp;would&nbsp;still&nbsp;run&nbsp;up&nbsp;against&nbsp;HTTP&nbsp;multiplexing&nbsp;and&nbsp;also&nbsp;add&nbsp;all&nbsp;sorts&nbsp;of&nbsp;NAT&nbsp;related&nbsp;issues&nbsp;as&nbsp;well.&nbsp;So&nbsp;only&nbsp;a&nbsp;last&nbsp;resort&nbsp;really.&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&nbsp;I&#39;ll&nbsp;come&nbsp;back&nbsp;to&nbsp;you&nbsp;if&nbsp;I&nbsp;think&nbsp;that&nbsp;might&nbsp;be&nbsp;useful.&nbsp;For&nbsp;now&nbsp;I&#39;ll&nbsp;proceed&nbsp;with&nbsp;using&nbsp;squid&nbsp;in&nbsp;a&nbsp;more&nbsp;normal&nbsp;fashion,&nbsp;and&nbsp;work&nbsp;with&nbsp;the&nbsp;owners&nbsp;of&nbsp;our&nbsp;next-hop-device&nbsp;about&nbsp;using&nbsp;X-Forwarded-For&nbsp;for&nbsp;any&nbsp;decision&nbsp;making.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;will&nbsp;proceed&nbsp;assuming&nbsp;that&nbsp;squid&nbsp;will&nbsp;never&nbsp;support&nbsp;the&nbsp;sort&nbsp;of&nbsp;spoofing&nbsp;I&nbsp;was&nbsp;hoping&nbsp;for&nbsp;(since&nbsp;it&nbsp;would&nbsp;probably&nbsp;simplify&nbsp;things&nbsp;greatly&nbsp;for&nbsp;us),&nbsp;even&nbsp;though&nbsp;I&nbsp;believe&nbsp;in&nbsp;our&nbsp;design&nbsp;that&nbsp;spoofing&nbsp;would&nbsp;have&nbsp;been&nbsp;safe.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;David&lt;/div&gt;&lt;/div&gt;<br>

</tt>
