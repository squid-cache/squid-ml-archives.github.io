<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none;&quot;&gt;&lt;!--&nbsp;P&nbsp;{margin-top:0;margin-bottom:0;}&nbsp;--&gt;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&nbsp;id=&quot;divtagdefaultwrapper&quot;&nbsp;style=&quot;font-size:12pt;color:#000000;font-family:Calibri,Arial,Helvetica,sans-serif;&quot;&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;p&gt;Hello&nbsp;list,&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;I&nbsp;asked&nbsp;about&nbsp;a&nbsp;problem&nbsp;with&nbsp;NTLM-Authentication&nbsp;before.&nbsp;(&lt;span&gt;BH&nbsp;SPNEGO&nbsp;request&nbsp;invalid&nbsp;prefix&lt;/span&gt;;&nbsp;thats&nbsp;the&nbsp;error&nbsp;of&nbsp;the&nbsp;helper&nbsp;protocol&nbsp;&quot;&lt;span&gt;helper-protocol=squid-2.5-ntlmssp&lt;/span&gt;&quot;&nbsp;I&nbsp;used&nbsp;with&nbsp;NTLM,&nbsp;while&nbsp;basic&nbsp;works&nbsp;fine)&lt;/p&gt;<br>
&lt;p&gt;A&nbsp;user&nbsp;told&nbsp;me&nbsp;I&nbsp;should&nbsp;use&nbsp;&lt;span&gt;negotiate_kerberos_auth&lt;/span&gt;&nbsp;instead&nbsp;of&nbsp;&lt;span&gt;<br>
ntlm_auth.&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;Now&nbsp;here's&nbsp;my&nbsp;new&nbsp;problem:&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&gt;root@x-x-testproxy01:/etc/squid#&nbsp;/usr/lib/squid/negotiate_kerberos_auth&nbsp;-d&nbsp;-s&nbsp;HTTP/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
negotiate_kerberos_auth.cc(487):&nbsp;pid=5305&nbsp;:2017/06/13&nbsp;13:29:41|&nbsp;negotiate_kerberos_auth:&nbsp;INFO:&nbsp;Starting&nbsp;version&nbsp;3.0.4sq&lt;br&gt;<br>
negotiate_kerberos_auth.cc(546):&nbsp;pid=5305&nbsp;:2017/06/13&nbsp;13:29:41|&nbsp;negotiate_kerberos_auth:&nbsp;INFO:&nbsp;Setting&nbsp;keytab&nbsp;to&nbsp;FILE:/etc/squid/HTTP.keytab&lt;br&gt;<br>
negotiate_kerberos_auth.cc(570):&nbsp;pid=5305&nbsp;:2017/06/13&nbsp;13:29:41|&nbsp;negotiate_kerberos_auth:&nbsp;INFO:&nbsp;Changed&nbsp;keytab&nbsp;to&nbsp;MEMORY:negotiate_kerberos_auth_5305&lt;br&gt;<br>
testuser&nbsp;xxxxxxx&lt;br&gt;<br>
negotiate_kerberos_auth.cc(610):&nbsp;pid=5305&nbsp;:2017/06/13&nbsp;13:29:47|&nbsp;negotiate_kerberos_auth:&nbsp;DEBUG:&nbsp;Got&nbsp;'testuser&nbsp;xxxxxx'&nbsp;from&nbsp;squid&nbsp;(length:&nbsp;18).&lt;br&gt;<br>
negotiate_kerberos_auth.cc(647):&nbsp;pid=5305&nbsp;:2017/06/13&nbsp;13:29:47|&nbsp;negotiate_kerberos_auth:&nbsp;ERROR:&nbsp;Invalid&nbsp;request&nbsp;[testuser&nbsp;xxxxxxx]&lt;br&gt;<br>
BH&nbsp;Invalid&nbsp;request&lt;/div&gt;<br>
So&nbsp;my&nbsp;configuration&nbsp;has&nbsp;mistakes,&nbsp;but&nbsp;I&nbsp;can't&nbsp;find&nbsp;them.&nbsp;I&nbsp;don't&nbsp;really&nbsp;know&nbsp;where&nbsp;to&nbsp;search,&nbsp;or&nbsp;what&nbsp;works&nbsp;for&nbsp;sure.&nbsp;I&nbsp;tried&nbsp;many&nbsp;tutorials&nbsp;on&nbsp;krb5&nbsp;and&nbsp;samba.&nbsp;Every&nbsp;form&nbsp;of&nbsp;testing&nbsp;I&nbsp;tried&nbsp;works&nbsp;fine&nbsp;except&nbsp;indeed&nbsp;using&nbsp;the&nbsp;required&nbsp;kerberos&nbsp;authentication<br>
&nbsp;of&nbsp;my&nbsp;squid-proxy.&lt;br&gt;<br>
&lt;p&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;Tests&nbsp;that&nbsp;come&nbsp;to&nbsp;my&nbsp;mind:&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;kinit&nbsp;a&nbsp;user&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;/span&gt;Warning:&nbsp;Your&nbsp;password&nbsp;will&nbsp;expire&nbsp;in&nbsp;36&nbsp;days&nbsp;on&nbsp;Don&nbsp;20&nbsp;Jul&nbsp;2017&nbsp;13:23:54&nbsp;CEST&lt;br&gt;<br>
&lt;/p&gt;<br>
&lt;p&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;klist&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;span&gt;Ticket&nbsp;cache:&nbsp;FILE:/tmp/krb5cc_0&lt;br&gt;<br>
Default&nbsp;principal:&nbsp;testuser@X-XXX.LOCAL&lt;br&gt;<br>
&lt;br&gt;<br>
Valid&nbsp;starting&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Expires&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Service&nbsp;principal&lt;br&gt;<br>
2017-06-13&nbsp;13:38:37&nbsp;&nbsp;2017-06-13&nbsp;23:38:37&nbsp;&nbsp;krbtgt/X-XXX.LOCAL@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;renew&nbsp;until&nbsp;2017-06-14&nbsp;13:38:34&lt;/span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;klist&nbsp;-k&nbsp;on&nbsp;my&nbsp;HTTP.keytab&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&gt;Keytab&nbsp;name:&nbsp;FILE:/etc/squid/HTTP.keytab&lt;br&gt;<br>
KVNO&nbsp;Principal&lt;br&gt;<br>
----&nbsp;--------------------------------------------------------------------------&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/x-x-testproxy01.x-xxx.local@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/X-X-TESTPROXY01@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/X-X-TESTPROXY01@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/X-X-TESTPROXY01@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/X-X-TESTPROXY01@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;host/X-X-TESTPROXY01@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;X-X-TESTPROXY01$@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;X-X-TESTPROXY01$@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;X-X-TESTPROXY01$@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;X-X-TESTPROXY01$@X-XXX.LOCAL&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;1&nbsp;X-X-TESTPROXY01$@X-XXX.LOCAL&lt;br&gt;<br>
&lt;span&gt;&lt;/span&gt;&lt;br&gt;<br>
&lt;span&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;p&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;basic-auth&nbsp;using&nbsp;ntlm&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&gt;root@x-x-testproxy01:/etc/squid#&nbsp;/usr/bin/ntlm_auth&nbsp;--helper-protocol=squid-2.5-basic&nbsp;--username=testuser&nbsp;--password=xxxxxxxx&lt;br&gt;<br>
testuser&nbsp;xxxxxxxxxx&lt;br&gt;<br>
OK&lt;br&gt;<br>
testuser@x-xxx.local&nbsp;xxxxxxxx&lt;br&gt;<br>
OK&lt;br&gt;<br>
&lt;br&gt;<br>
wbinfo&nbsp;-u&lt;br&gt;<br>
administrator&lt;br&gt;<br>
testuser&lt;br&gt;<br>
...&lt;br&gt;<br>
wbinfo&nbsp;-g&lt;br&gt;<br>
&lt;span&gt;allowed&nbsp;rodc&nbsp;password&nbsp;replication&nbsp;group&lt;/span&gt;&lt;br&gt;<br>
&lt;span&gt;enterprise&nbsp;read-only&nbsp;domain&nbsp;controllers&lt;/span&gt;&lt;br&gt;<br>
...&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;div&gt;wbinfo&nbsp;--krb5auth=testuser%xxxxxxx&lt;br&gt;<br>
plaintext&nbsp;kerberos&nbsp;password&nbsp;authentication&nbsp;for&nbsp;[testuser%xxxxxxx]&nbsp;succeeded&nbsp;(requesting&nbsp;cctype:&nbsp;FILE)&lt;br&gt;<br>
&lt;br&gt;<br>
wbinfo&nbsp;-t&lt;br&gt;<br>
&lt;span&gt;checking&nbsp;the&nbsp;trust&nbsp;secret&nbsp;for&nbsp;domain&nbsp;X-XXX&nbsp;via&nbsp;RPC&nbsp;calls&nbsp;succeeded&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;div&gt;wbinfo&nbsp;--authenticate=testuser%xxxxxxxx&lt;br&gt;<br>
plaintext&nbsp;password&nbsp;authentication&nbsp;succeeded&lt;br&gt;<br>
challenge/response&nbsp;password&nbsp;authentication&nbsp;succeeded&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;div&gt;/usr/lib/squid/negotiate_kerberos_auth_test&nbsp;x-x-testproxy01.x-xxx.local&lt;br&gt;<br>
Token:&nbsp;YIIFOgYGKwYBBQUCoIIFLjCCBSqgJzAlBgkqhkiG9xIBAgIGBSsFAQUCBgkqhkiC9xIBAgIGBisGAQUCBaKCBP0EggT5YIIE9QYJKoZIhvcSAQICAQBuggTkMIIE4KADAgEFoQMCAQ6iBwMFAAAAAACjggP2YYID8jCCA&#43;6gAwIBBaENGwtYLU5FVC5MT0NBTKIuMCygAwIBA6ElMCMbBEhUVFAbG3gtbC10ZXN0cHJveHkwMS54LW5ldC5sb2NhbKOCA6YwggOioAMCARKhAwIBAaKCA5QEggOQIMtincRDtWjh44pew3twk26Gm9rTC7CbkobNrzaRq/weljVl5TSbMQTFIVRQXVe4CQBWJ/Gcg472cgLA3mjOH8Z30zxQFP8fsK46wAtTEzJhonzXLImhaPtXvCVz94xaCVG7cBlNJCUmZQHsQMxFsGJZfKCkDvztiNplXEEwRgT7S6f8HQNm62xPAyz9aK8Wqfz9suW5cSBk8wdRAQNleKP1Xe/2LqZ4jfDpodPdcy9A8vh1dKu4tmbz&#43;EJ/bKvWA&#43;/twuXiOhhGq4W39TlOu/3zD87pXAh65ka1QsepkCWgUMHImDw8nUr8Zvi4j4vI9WhyMyLFYBya8BvAX9kLg73zl80g82bQVIAb8QU3gS2Akhpd7r1flfUbfRDUQfuS/bsaHspZoP&#43;2c8&#43;Bxy38OML4Gg29y6fJvRNfDaCnqmTQdiPtyqELVUS&#43;4x7r260mM1wQKzD2Jb5pcz4wMHUK0sdw8xmMARGxB7XdyGSbo759GD6tOaTAKkNwccno6i9wyOoLqfhVRjE/K9FLCvCnzEFI07q1/dFz1Ce/ZzroW3nOwNQe3V6qqBELwuTvHgxIdGq4HEPeLqAUkVWxneXemRNbLKiOs/BIe3qkXxizgAkFLqRO5az2pVOD7/KBevxYZKeAgIuDsbIYG/u3Ic&#43;KtCDaaM/to2b41SB8ZOFKJau3BuMPOvZ4ipiMbv0N/Svk4Tg61BIhN3CJYKA3ep/3p3wSfJlkcYeRVkDpasQnmFnjxV2YS7Q8nvmf9LIz&#43;KIYBIT8X9yRPuV/E2lSELZlxJ8CySLFLUKgtMj97GPMlacc&#43;UN3lJjyoExUKHpMZtUmaKrw7ueT3wnLMWgx0BBPkiAebUAedKj9u9sEscFylmI/&#43;PdCCraMNbkOckCsggYXfJm6LxFZJhnDvw1&#43;Z87xsJFDs5fasF6j8REiG8aHTmKHgt2M9TmIRNo/PsYrZGvuVQhkk2fuyFxwwyfs7ysNEkOmBWlFlTEjddjT9YShHfV8Fo8&#43;M2UYY5nYiUIQq5BBfZ679ntivs7F80lKMOqhc7SOY63VwRJOwoq35&#43;bnsIB08b9cttySiOcFsZb6uTnYvHzUFVSUha4nxrg3zW3fL9KVu4XY&#43;lgCRZrBZMxioy6vbAOJBmpqXOJvel2gBbGN6PEd2ReeX43l1gcn&#43;Bd3mQykmUIEzMMuRpSHda9233aWHbwEZ9H9rOdJdhgX4U&#43;upIHQMIHNoAMCARKigcUEgcJu7kcC1zuJdhOQk&#43;YA0Hw2G9kyg46tpaNIgj1CEgkD/KE28kaKivCTZTnHfrNOpIOJaaiYw4RMwJsbgZdRU&#43;fz/jUwxvXdUSGon6JrU7S2XZ9CjXRXfdpXc4HjP0QW6Cql1SE95MpkcbMRH8FQvGNryBzsqIkELnvXceTGCmwlN3n60nqkoR5/41p2PtSz4hFMOVdT6AkPlNC5VTCtCZUj7YbrYVYImPnG3aAfQxXEHRy19/v0mL2845jZFA7Xw96s1A==&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
Sorry&nbsp;for&nbsp;posting&nbsp;so&nbsp;many&nbsp;output...&lt;br&gt;<br>
I&nbsp;already&nbsp;read&nbsp;many&nbsp;documentations,&nbsp;but&nbsp;no&nbsp;one&nbsp;really&nbsp;tests&nbsp;in&nbsp;small&nbsp;steps,&nbsp;they&nbsp;just&nbsp;assume&nbsp;that&nbsp;it&nbsp;works&nbsp;for&nbsp;everyone&nbsp;out&nbsp;of&nbsp;the&nbsp;box...&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;p&gt;Does&nbsp;anyone&nbsp;have&nbsp;a&nbsp;clue&nbsp;what&nbsp;could&nbsp;be&nbsp;my&nbsp;mistake?&lt;/p&gt;<br>
&lt;p&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;Thanks&nbsp;in&nbsp;advance.&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&gt;&lt;span&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
