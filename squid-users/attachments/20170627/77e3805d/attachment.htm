<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Jun&nbsp;26,&nbsp;2017&nbsp;at&nbsp;12:06&nbsp;PM,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;06/26/2017&nbsp;10:11&nbsp;AM,&nbsp;Razor&nbsp;Cross&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;are&nbsp;using&nbsp;squid&nbsp;3.5.&nbsp;for&nbsp;our&nbsp;server.&nbsp;Recently&nbsp;we&nbsp;have&nbsp;noticed&nbsp;that&lt;br&gt;<br>
&gt;&nbsp;squid&nbsp;is&nbsp;caching&nbsp;incomplete&nbsp;objects&nbsp;in&nbsp;case&nbsp;of&nbsp;chunked&nbsp;response.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;have&nbsp;gone&nbsp;through&nbsp;the&nbsp;squid&nbsp;code.&nbsp;It&nbsp;looks&nbsp;likes&nbsp;squid&nbsp;is&nbsp;caching&lt;br&gt;<br>
&gt;&nbsp;incomplete&nbsp;response&nbsp;in&nbsp;case&nbsp;of&nbsp;EOF&nbsp;from&nbsp;the&nbsp;server&nbsp;even&nbsp;though&nbsp;it&nbsp;does&lt;br&gt;<br>
&gt;&nbsp;not&nbsp;receive&nbsp;the&nbsp;last&nbsp;empty&nbsp;chunk.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp;if&nbsp;(eof)&nbsp;//&nbsp;already&nbsp;reached&nbsp;EOF&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;COMPLETE_NONPERSISTENT_MSG;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;You&nbsp;are&nbsp;looking&nbsp;at&nbsp;the&nbsp;wrong&nbsp;code.&nbsp;HttpStateData::&lt;wbr&gt;persistentConnStatus()&lt;br&gt;<br>
and&nbsp;related&nbsp;*_MSG&nbsp;codes&nbsp;do&nbsp;not&nbsp;determine&nbsp;whether&nbsp;the&nbsp;entire&nbsp;object&nbsp;was&lt;br&gt;<br>
received.&nbsp;They&nbsp;determine&nbsp;whether&lt;br&gt;<br>
&lt;br&gt;<br>
(a)&nbsp;Squid&nbsp;should&nbsp;expect&nbsp;more&nbsp;response&nbsp;bytes&nbsp;and&lt;br&gt;<br>
&lt;br&gt;<br>
(b)&nbsp;The&nbsp;connection&nbsp;can&nbsp;be&nbsp;kept&nbsp;open&nbsp;if&nbsp;no&nbsp;more&nbsp;response&nbsp;bytes&nbsp;are&nbsp;expected.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;COMPLETE_NONPERSISTENT_MSG&nbsp;return&nbsp;value&nbsp;is&nbsp;correct&nbsp;here&nbsp;(I&nbsp;am&lt;br&gt;<br>
ignoring&nbsp;the&nbsp;sad&nbsp;fact&nbsp;that&nbsp;we&nbsp;are&nbsp;abusing&nbsp;the&nbsp;word&nbsp;&quot;complete&quot;&nbsp;to&nbsp;cover&lt;br&gt;<br>
both&nbsp;whole&nbsp;and&nbsp;truncated&nbsp;responses).&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Is&nbsp;this&nbsp;expected?&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;our&nbsp;server&nbsp;ends&nbsp;up&nbsp;serving&lt;br&gt;<br>
&gt;&nbsp;bad&nbsp;objects&nbsp;to&nbsp;the&nbsp;user.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;&gt;What&nbsp;you&nbsp;describe&nbsp;sounds&nbsp;like&nbsp;a&nbsp;bug,&nbsp;but&nbsp;the&nbsp;exact&nbsp;code&nbsp;you&nbsp;are&nbsp;quoting&lt;br&gt;&gt;is&nbsp;not&nbsp;responsible&nbsp;for&nbsp;that&nbsp;bug.&nbsp;I&nbsp;di&nbsp;not&nbsp;study&nbsp;this&nbsp;in&nbsp;detail,&nbsp;but&nbsp;I&lt;br&gt;&gt;suspect&nbsp;that&nbsp;the&nbsp;COMPLETE_NONPERSISTENT_MSG&nbsp;case&nbsp;in&lt;br&gt;&gt;HttpStateData::&lt;wbr&gt;processReplyBody()&nbsp;should&nbsp;be&nbsp;changed&nbsp;to&nbsp;call&lt;br&gt;&gt;StoreEntry::lengthWentBad(&quot;&lt;wbr&gt;missing&nbsp;last-chunk&quot;)&nbsp;when&nbsp;lastChunk&nbsp;is&nbsp;false&lt;br&gt;&gt;&nbsp;and&nbsp;HttpStateData::flags.chunked&nbsp;is&nbsp;true.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;We&nbsp;are&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue&nbsp;.&nbsp;If&nbsp;server&nbsp;socket&nbsp;is&nbsp;closed&nbsp;after&nbsp;sending&nbsp;first&nbsp;chunk&nbsp;of&nbsp;data,&nbsp;squid&nbsp;is&nbsp;caching&nbsp;the&nbsp;partial&nbsp;object&nbsp;even&nbsp;though&nbsp;it&nbsp;did&nbsp;not&nbsp;receive&nbsp;the&nbsp;remaining&nbsp;chunks.&nbsp;I&nbsp;feel&nbsp;it&nbsp;has&nbsp;to&nbsp;make&nbsp;sure&nbsp;that&nbsp;lastchunk&nbsp;has&nbsp;received&nbsp;before&nbsp;caching&nbsp;the&nbsp;data.&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;-&nbsp;Cross<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
