<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Hi,&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I&nbsp;am&nbsp;setting&nbsp;up&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;that&nbsp;is&nbsp;doing&nbsp;whitelist<br>
work,&nbsp;and&nbsp;at&nbsp;the&nbsp;same&nbsp;time,&nbsp;doing&nbsp;the&nbsp;cache&nbsp;work.&lt;span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;whitelist&nbsp;works&nbsp;fine,&nbsp;HTTP&nbsp;cache&nbsp;verifed&nbsp;work&nbsp;cause&nbsp;I&nbsp;see&nbsp;TCP_MEM_HIT&nbsp;using&nbsp;this&nbsp;squid.conf,&nbsp;but&nbsp;don&#39;t&nbsp;see&nbsp;any&nbsp;HTTPS&nbsp;MEM&nbsp;HIT&nbsp;related&nbsp;log,&nbsp;every&nbsp;time&nbsp;seems&nbsp;a&nbsp;new&nbsp;connection.&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;For&nbsp;HTTPS&nbsp;traffic,&nbsp;I&nbsp;am&nbsp;getting&nbsp;TCP_TUNNEL/200&nbsp;all&nbsp;the&nbsp;time,<br>
the&nbsp;question&nbsp;is,&nbsp;how&nbsp;can&nbsp;I&nbsp;tell&nbsp;that&nbsp;a&nbsp;HTTPS&nbsp;traffic&nbsp;is&nbsp;actually&nbsp;using&nbsp;cache,&nbsp;or&nbsp;in&nbsp;this&nbsp;case,&nbsp;it&#39;s&nbsp;not&nbsp;using&nbsp;cache&nbsp;at&nbsp;all&nbsp;for&nbsp;HTTPS.&nbsp;I&nbsp;am&nbsp;using&nbsp;forward-proxy&nbsp;port&nbsp;in&nbsp;cache_peer.&lt;span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I&nbsp;understand&nbsp;that&nbsp;there&nbsp;is&nbsp;logformat&nbsp;to&nbsp;make&nbsp;access.log&nbsp;show&nbsp;hostname&nbsp;instead&nbsp;of&nbsp;ip,&nbsp;but&nbsp;this&nbsp;should&nbsp;not&nbsp;effect&nbsp;the&nbsp;MEM&nbsp;HIT&nbsp;log,&nbsp;right?&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt;Meanwhile,&nbsp;I&nbsp;am&nbsp;also&nbsp;trying&nbsp;to&nbsp;setup&nbsp;the&nbsp;sibling&nbsp;cache&nbsp;cluster,&nbsp;not&nbsp;sure&nbsp;if&nbsp;this&nbsp;related&nbsp;to&nbsp;HTTPS&nbsp;cache,&nbsp;I&nbsp;am&nbsp;also&nbsp;getting &lt;/span&gt;TCP_DENIED/403&nbsp;for squid-internal-dynamic/netdb&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html.&nbsp;I&nbsp;do&nbsp;see&nbsp;sibling&nbsp;hit&nbsp;for&nbsp;HTTP&nbsp;site.&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Here&nbsp;is&nbsp;my&nbsp;squid&nbsp;version:&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.25&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Service&nbsp;Name:&nbsp;squid&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;configure&nbsp;options:&nbsp; &#39;--prefix=/usr&#39;<br>
&#39;--includedir=/include&#39;&nbsp;&#39;--mandir=/share/man&#39;&nbsp;&#39;--infodir=/share/info&#39;<br>
&#39;--sysconfdir=/etc&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--libexecdir=/lib/squid3&#39;<br>
&#39;--srcdir=.&#39;&nbsp;&#39;--without-libcap&#39;&nbsp;&#39;--sysconfdir=/etc/squid3&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;<br>
&#39;--enable-inline&#39;&nbsp;&#39;--enable-async-io&#39;&nbsp;&#39;--enable-icmp&#39;&nbsp;&#39;--enable-useragent-log&#39;<br>
&#39;--enable-snmp&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-follow-x-forwarded-for&#39;<br>
&#39;--enable-storeio=aufs&#39;&nbsp;&#39;--enable-removal-policies=heap,lru&#39;<br>
&#39;--with-maxfd=16384&#39;&nbsp;&#39;--enable-poll&#39;&nbsp;&#39;--disable-ident-lookups&#39;&nbsp;&#39;--with-openssl&#39;<br>
&#39;--enable-ssl-crtd&#39;&nbsp;&#39;--with-default-user=proxy&#39;<br>
&#39;--with-swapdir=/var/spool/squid3&#39;&nbsp;&#39;--with-logdir=/var/log/squid3&#39;<br>
&#39;--with-pidfile=/var/run/squid3.pid&#39;&nbsp;&#39;--enable-linux-netfilter&#39;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;And&nbsp;my&nbsp;squid.conf&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#&nbsp;Squid&nbsp;normally&nbsp;listens&nbsp;to&nbsp;port&nbsp;3128&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_port&nbsp;3130&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_port&nbsp;3128&nbsp;intercept&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;allowed_http_sites&nbsp;dstdomain&nbsp;&quot;/etc/squid3/whitelist.txt&quot;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_access&nbsp;allow&nbsp;allowed_http_sites&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;https_port&nbsp;3129&nbsp;cert=/etc/squid3/squid.crt&nbsp;key=/etc/squid3/squid.key&nbsp;ssl-bump&nbsp;intercept&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;SSL_port&nbsp;port&nbsp;443&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_access&nbsp;allow&nbsp;SSL_port&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;allowed_https_sites&nbsp;ssl::server_name&nbsp;&quot;/etc/squid3/ssl_sites.txt&quot;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#sslcrtd_program&nbsp;/usr/local/squid/libexec/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;sslcrtd_program&nbsp;/lib/squid3/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ssl_bump&nbsp;peek&nbsp;step2&nbsp;allowed_https_sites&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ssl_bump&nbsp;splice&nbsp;step3&nbsp;allowed_https_sites&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ssl_bump&nbsp;terminate&nbsp;step2&nbsp;all&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;acl&nbsp;container_net&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.18.0.0/24&quot;&gt;172.18.0.0/24&lt;/a&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;tcp_outgoing_address&nbsp;10.0.8.41&nbsp;container_net&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;udp_outgoing_address&nbsp;10.0.8.41&nbsp;container_net&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_access&nbsp;allow&nbsp;container_net&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;icp_port&nbsp;3131&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;icp_access&nbsp;allow&nbsp;all&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#never_direct&nbsp;allow&nbsp;all&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;cache_peer&nbsp;10.0.8.48&nbsp;sibling&nbsp;3128&nbsp;3131&nbsp;proxy-only&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#cache_peer_access&nbsp;10.0.8.48&nbsp;allow&nbsp;all&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#&nbsp;Uncomment&nbsp;and&nbsp;adjust&nbsp;the&nbsp;following&nbsp;to&nbsp;add&nbsp;a&nbsp;disk&nbsp;cache&nbsp;directory.&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;hosts_file&nbsp;/etc/hosts&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;cache_replacement_policy&nbsp;heap&nbsp;LFUDA&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;cache_dir&nbsp;aufs&nbsp;/var/spool/squid3&nbsp;4000&nbsp;16&nbsp;256&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;log_icp_queries&nbsp;off&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;coredump_dir&nbsp;/var/spool/squid3&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;#refresh_pattern&nbsp;^https://.*\.raw.githubusercontent\.com/&nbsp;120000&nbsp;100%&nbsp;43200&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;refresh_pattern&nbsp;.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12000&nbsp; &nbsp; &nbsp; &nbsp;90%&nbsp; &nbsp; &nbsp;43200&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;http_access&nbsp;deny&nbsp;all&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Thanks,&lt;span&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Lei&lt;span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;<br>

</tt>
