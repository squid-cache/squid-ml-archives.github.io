<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;setting&nbsp;up&nbsp;the&nbsp;transparent&nbsp;HTTP/HTTPS&nbsp;proxy&nbsp;cluster&nbsp;with&nbsp;whiltelist&nbsp;only,&nbsp;and&nbsp;stuck&nbsp;at&nbsp;having&nbsp;issue&nbsp;&#39;ERROR&nbsp;500:&nbsp;Internal&nbsp;Server&nbsp;Error&#39;.&nbsp;After&nbsp;couple&nbsp;days&nbsp;tuning&nbsp;and&nbsp;digging,&nbsp;I&nbsp;narrow&nbsp;down&nbsp;the&nbsp;problem&nbsp;to&nbsp;directive&nbsp;&#39;never_direct&#39;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;removing&nbsp;this&nbsp;line,&nbsp;the&nbsp;error&nbsp;message&nbsp;is&nbsp;gone.&nbsp;But&nbsp;seems&nbsp;sibling&nbsp;cache&nbsp;will&nbsp;only&nbsp;work&nbsp;for&nbsp;HTTP,&nbsp;HTTPS&nbsp;will&nbsp;not&nbsp;go&nbsp;to&nbsp;sibling.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&nbsp;is&nbsp;my&nbsp;squid.conf&nbsp;snapshot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;http_port&nbsp;3130&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;intercept&lt;/div&gt;&lt;div&gt;acl&nbsp;allowed_http_sites&nbsp;dstdomain&nbsp;&quot;/etc/squid3/whitelist.txt&quot;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;allowed_http_sites&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;https_port&nbsp;3129&nbsp;cert=/etc/squid3/squid.crt&nbsp;key=/etc/squid3/squid.key&nbsp;ssl-bump&nbsp;intercept&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;/div&gt;&lt;div&gt;acl&nbsp;SSL_port&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;SSL_port&lt;/div&gt;&lt;div&gt;acl&nbsp;allowed_https_sites&nbsp;ssl::server_name&nbsp;&quot;/etc/squid3/ssl_sites.txt&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/lib/squid3/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;stare&nbsp;step2&nbsp;allowed_https_sites&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;step3&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;terminate&nbsp;step2&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;container_net&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.18.0.0/24&quot;&gt;172.18.0.0/24&lt;/a&gt;&lt;/div&gt;&lt;div&gt;tcp_outgoing_address&nbsp;10.0.8.41&nbsp;container_net&lt;/div&gt;&lt;div&gt;udp_outgoing_address&nbsp;10.0.8.41&nbsp;container_net&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;container_net&lt;/div&gt;&lt;div&gt;cache_peer&nbsp;10.0.8.48&nbsp;sibling&nbsp;3130&nbsp;3131&nbsp;ssl&nbsp;sslcafile=/etc/ca.pem&nbsp;sslflags=NO_DEFAULT_CA&nbsp;ssloptions=NO_SSLv3&lt;br&gt;&lt;/div&gt;&lt;div&gt;icp_port&nbsp;3131&lt;/div&gt;&lt;div&gt;icp_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;never_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;#&nbsp;Uncomment&nbsp;and&nbsp;adjust&nbsp;the&nbsp;following&nbsp;to&nbsp;add&nbsp;a&nbsp;disk&nbsp;cache&nbsp;directory.&lt;/div&gt;&lt;div&gt;hosts_file&nbsp;/etc/hosts&lt;/div&gt;&lt;div&gt;cache_replacement_policy&nbsp;heap&nbsp;LFUDA&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_dir&nbsp;aufs&nbsp;/var/spool/squid3&nbsp;40000&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;maximum_object_size&nbsp;32&nbsp;MB&lt;/div&gt;&lt;div&gt;log_icp_queries&nbsp;off&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/spool/squid3&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Lei&lt;/div&gt;&lt;/div&gt;<br>

</tt>
