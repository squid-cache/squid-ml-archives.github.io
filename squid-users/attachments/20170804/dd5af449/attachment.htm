<tt>
&lt;html&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;times&nbsp;new&nbsp;roman,&nbsp;new&nbsp;york,&nbsp;times,&nbsp;serif;&nbsp;font-size:&nbsp;14pt;&nbsp;color:&nbsp;#000000&quot;&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;&lt;div&gt;Hi&nbsp;everyone,&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;squid&nbsp;3.5.26&nbsp;with&nbsp;C-ICAP&nbsp;&nbsp;and&nbsp;here&nbsp;are&nbsp;the&nbsp;important&nbsp;lines:&lt;/div&gt;&quot;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;icap_enable&nbsp;on&lt;br&gt;icap_send_client_ip&nbsp;on&lt;br&gt;icap_send_client_username&nbsp;on&lt;br&gt;icap_client_username_header&nbsp;X-Authenticated-User&lt;br&gt;icap_preview_enable&nbsp;on&lt;br&gt;icap_preview_size&nbsp;1024&lt;br&gt;icap_service&nbsp;service_avi_req&nbsp;reqmod_precache&nbsp;icap://localhost:1344/echo&nbsp;bypass=off&lt;br&gt;adaptation_access&nbsp;service_avi_req&nbsp;allow&nbsp;all&lt;br&gt;icap_service&nbsp;service_avi_resp&nbsp;respmod_precache&nbsp;icap://localhost:1344/echo&nbsp;bypass=off&lt;br&gt;adaptation_access&nbsp;service_avi_resp&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;#url_rewrite_program&nbsp;/usr/bin/squidGuard&nbsp;-c&nbsp;/etc/squidguard/squidGuard.conf&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;http_port&nbsp;3128&lt;br&gt;http_port&nbsp;3129&nbsp;intercept&lt;br&gt;https_port&nbsp;3130&nbsp;intercept&nbsp;ssl-bump&nbsp;\&lt;br&gt;cert=/etc/squid/ssl_cert/myCA.pem&nbsp;\&lt;br&gt;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;sslcrtd_program&nbsp;/usr/local/squid/libexec/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;#acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;#acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;#acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;ssl_bump&nbsp;peek&nbsp;all&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;logformat&nbsp;squid&nbsp;%ssl::&gt;sni&lt;br&gt;adaptation_meta&nbsp;X-SNI&nbsp;&quot;%ssl::&gt;sni&quot;&nbsp;all&nbsp;&nbsp;&nbsp;#or&nbsp;connect&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;#request_header_add&nbsp;X-SNI&nbsp;&quot;%ssl::&gt;sni&quot;&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;&quot;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:&nbsp;12pt;&quot;&nbsp;data-mce-style=&quot;font-size:&nbsp;12pt;&quot;&gt;&lt;br&gt;&lt;div&gt;So&nbsp;i&nbsp;want&nbsp;to&nbsp;create&nbsp;an&nbsp;icap&nbsp;service&nbsp;like&nbsp;squidclamav&nbsp;but&nbsp;it&nbsp;must&nbsp;check&nbsp;SNI&nbsp;not&nbsp;URLs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;peek&nbsp;all&nbsp;the&nbsp;steps&nbsp;to&nbsp;get&nbsp;sni&nbsp;and&nbsp;in&nbsp;the&nbsp;squid&nbsp;access&nbsp;log,&nbsp;sni&nbsp;is&nbsp;printed&nbsp;.&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;read&nbsp;that&nbsp;adaptation_meta&nbsp;can&nbsp;send&nbsp;anything&nbsp;from&nbsp;squid&nbsp;to&nbsp;icap&nbsp;but&nbsp;clearly&nbsp;i&nbsp;use&nbsp;it&nbsp;incorretly:&nbsp;i&nbsp;can't&nbsp;see&nbsp;sni&nbsp;on&nbsp;icap&nbsp;access&nbsp;log&nbsp;or&nbsp;in&nbsp;icap&nbsp;headers.&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;adaptation_meta&nbsp;create&nbsp;a&nbsp;icap&nbsp;headers&nbsp;?&nbsp;Or&nbsp;should&nbsp;i&nbsp;use&nbsp;add_request_headers?&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;I&nbsp;know&nbsp;that&nbsp;squid&nbsp;can&nbsp;create&nbsp;a&nbsp;2nd&nbsp;fake&nbsp;connect&nbsp;with&nbsp;sni&nbsp;but&nbsp;here&nbsp;again&nbsp;icap&nbsp;just&nbsp;print&nbsp;the&nbsp;same&nbsp;connect&nbsp;2&nbsp;times&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;Thanks,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&nbsp;data-mce-style=&quot;font-family:&nbsp;'sans&nbsp;serif';&nbsp;font-size:&nbsp;16px;&nbsp;background-color:&nbsp;#ffffff;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
