<tt>
&lt;html&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;times&nbsp;new&nbsp;roman,&nbsp;new&nbsp;york,&nbsp;times,&nbsp;serif;&nbsp;font-size:&nbsp;14pt;&nbsp;color:&nbsp;#000000&quot;&gt;&lt;div&gt;&lt;br&gt;&gt;&gt;&nbsp;Hi&nbsp;everyone,&lt;br&gt;&gt;&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;squid&nbsp;3.5.26&nbsp;with&nbsp;C-ICAP&nbsp;&nbsp;and&nbsp;here&nbsp;are&nbsp;the&nbsp;&lt;br&gt;&gt;&gt;&nbsp;important&nbsp;lines:&lt;br&gt;&gt;&gt;&nbsp;&quot;&lt;br&gt;&gt;&gt;&nbsp;icap_enable&nbsp;on&lt;br&gt;&gt;&gt;&nbsp;icap_send_client_ip&nbsp;on&lt;br&gt;&gt;&gt;&nbsp;icap_send_client_username&nbsp;on&lt;br&gt;&gt;&gt;&nbsp;icap_client_username_header&nbsp;X-Authenticated-User&lt;br&gt;&gt;&gt;&nbsp;icap_preview_enable&nbsp;on&lt;br&gt;&gt;&gt;&nbsp;icap_preview_size&nbsp;1024&lt;br&gt;&gt;&gt;&nbsp;icap_service&nbsp;service_avi_req&nbsp;reqmod_precache&nbsp;icap://localhost:1344/echo&nbsp;&lt;br&gt;&gt;&gt;&nbsp;bypass=off&lt;br&gt;&gt;&gt;&nbsp;adaptation_access&nbsp;service_avi_req&nbsp;allow&nbsp;all&lt;br&gt;&gt;&gt;&nbsp;icap_service&nbsp;service_avi_resp&nbsp;respmod_precache&nbsp;&lt;br&gt;&gt;&gt;&nbsp;icap://localhost:1344/echo&nbsp;bypass=off&lt;br&gt;&gt;&gt;&nbsp;adaptation_access&nbsp;service_avi_resp&nbsp;allow&nbsp;all&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;#url_rewrite_program&nbsp;/usr/bin/squidGuard&nbsp;-c&nbsp;/etc/squidguard/squidGuard.conf&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;http_port&nbsp;3128&lt;br&gt;&gt;&gt;&nbsp;http_port&nbsp;3129&nbsp;intercept&lt;br&gt;&gt;&gt;&nbsp;https_port&nbsp;3130&nbsp;intercept&nbsp;ssl-bump&nbsp;\&lt;br&gt;&gt;&gt;&nbsp;cert=/etc/squid/ssl_cert/myCA.pem&nbsp;\&lt;br&gt;&gt;&gt;&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;&gt;&gt;&nbsp;sslcrtd_program&nbsp;/usr/local/squid/libexec/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;#acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;&gt;&gt;&nbsp;#acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;&gt;&gt;&nbsp;#acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;all&lt;br&gt;&gt;&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;NP:&nbsp;Peeking&nbsp;at&nbsp;step&nbsp;2&nbsp;precludes&nbsp;bumping.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;&gt;&nbsp;logformat&nbsp;squid&nbsp;%ssl::&gt;sni&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;Please&nbsp;do&nbsp;not&nbsp;redefine&nbsp;the&nbsp;built-in&nbsp;format&nbsp;name&nbsp;&quot;squid&quot;.&nbsp;Use&nbsp;a&nbsp;custom&nbsp;&lt;br&gt;&gt;name&nbsp;for&nbsp;custom&nbsp;formats.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ok&nbsp;it&nbsp;will&nbsp;be&nbsp;done&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;br&gt;&gt;&gt;&nbsp;adaptation_meta&nbsp;X-SNI&nbsp;&quot;%ssl::&gt;sni&quot;&nbsp;all&nbsp;&nbsp;&nbsp;#or&nbsp;connect&lt;br&gt;&gt;&gt;&nbsp;#request_header_add&nbsp;X-SNI&nbsp;&quot;%ssl::&gt;sni&quot;&nbsp;all&lt;br&gt;&gt;&gt;&nbsp;&quot;&lt;br&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&lt;br&gt;&gt;&gt;&nbsp;So&nbsp;i&nbsp;want&nbsp;to&nbsp;create&nbsp;an&nbsp;icap&nbsp;service&nbsp;like&nbsp;squidclamav&nbsp;but&nbsp;it&nbsp;must&nbsp;check&nbsp;&lt;br&gt;&gt;&gt;&nbsp;SNI&nbsp;not&nbsp;URLs.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;Any&nbsp;particular&nbsp;reason&nbsp;why?&lt;br&gt;&gt;&nbsp;SNI&nbsp;has&nbsp;almost&nbsp;nothing&nbsp;to&nbsp;do&nbsp;with&nbsp;the&nbsp;HTTP&nbsp;messages&nbsp;(plural).&nbsp;It&nbsp;is&nbsp;&lt;br&gt;&gt;&nbsp;simply&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;next-hop&nbsp;server&nbsp;(or&nbsp;proxy)&nbsp;they&nbsp;should&nbsp;be&nbsp;&lt;br&gt;&gt;&nbsp;delivered&nbsp;to&nbsp;on&nbsp;their&nbsp;way&nbsp;around&nbsp;the&nbsp;web.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;I&nbsp;thought&nbsp;squidclamav&nbsp;was&nbsp;an&nbsp;antivirus,&nbsp;not&nbsp;a&nbsp;URL&nbsp;blocklist&nbsp;checker.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;You're&nbsp;right:&nbsp;squidclamav&nbsp;is&nbsp;an&nbsp;antivirus&nbsp;but&nbsp;there&nbsp;are&nbsp;much&nbsp;more&nbsp;services,&nbsp;actually&nbsp;he&nbsp;can&nbsp;check&nbsp;url&nbsp;and&nbsp;match&nbsp;them&nbsp;to&nbsp;blacklist&nbsp;or&nbsp;whitelist.&lt;/div&gt;&lt;div&gt;I&nbsp;don't&nbsp;want&nbsp;to&nbsp;decrypt&nbsp;https&nbsp;trafic&nbsp;but&nbsp;i&nbsp;want&nbsp;to&nbsp;know&nbsp;where&nbsp;the&nbsp;client&nbsp;is&nbsp;trying&nbsp;to&nbsp;connect.&nbsp;I&nbsp;thought&nbsp;SNI&nbsp;was&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;know&nbsp;the&nbsp;server&nbsp;name&nbsp;and&nbsp;the&nbsp;domain&nbsp;without&nbsp;decrypting&nbsp;anything.&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Final&nbsp;goal&nbsp;is&nbsp;to&nbsp;blacklist&nbsp;for&nbsp;exemple&nbsp;google&nbsp;and&nbsp;when&nbsp;sni&nbsp;indicates&nbsp;www.google.com,&nbsp;c-icap&nbsp;denies&nbsp;the&nbsp;access.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;I&nbsp;peek&nbsp;all&nbsp;the&nbsp;steps&nbsp;to&nbsp;get&nbsp;sni&nbsp;and&nbsp;in&nbsp;the&nbsp;squid&nbsp;access&nbsp;log,&nbsp;sni&nbsp;is&nbsp;&lt;br&gt;&gt;&gt;&nbsp;printed&nbsp;.&lt;br&gt;&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;&gt;&nbsp;I&nbsp;read&nbsp;that&nbsp;adaptation_meta&nbsp;can&nbsp;send&nbsp;anything&nbsp;from&nbsp;squid&nbsp;to&nbsp;icap&nbsp;but&nbsp;&lt;br&gt;&gt;&gt;&nbsp;clearly&nbsp;i&nbsp;use&nbsp;it&nbsp;incorretly:&nbsp;i&nbsp;can't&nbsp;see&nbsp;sni&nbsp;on&nbsp;icap&nbsp;access&nbsp;log&nbsp;or&nbsp;in&nbsp;&lt;br&gt;&gt;&gt;&nbsp;icap&nbsp;headers.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;&nbsp;Your&nbsp;usage&nbsp;appears&nbsp;to&nbsp;be&nbsp;correct.&nbsp;I&nbsp;think&nbsp;there&nbsp;is&nbsp;no&nbsp;SNI&nbsp;being&nbsp;received&nbsp;&lt;br&gt;&gt;&nbsp;by&nbsp;Squid.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That's&nbsp;problematic&nbsp;because&nbsp;in&nbsp;my&nbsp;squid&nbsp;access&nbsp;log&nbsp;there&nbsp;are&nbsp;&quot;www.youtube.com&quot;&nbsp;&quot;www.google.com&quot;,&nbsp;that's&nbsp;exactly&nbsp;what&nbsp;i'm&nbsp;tryng&nbsp;to&nbsp;pass&nbsp;to&nbsp;c-icap.&nbsp;Seems&nbsp;like&nbsp;squid&nbsp;receives&nbsp;the&nbsp;sni.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&gt;&gt;&nbsp;Does&nbsp;adaptation_meta&nbsp;create&nbsp;a&nbsp;icap&nbsp;headers&nbsp;?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;It&nbsp;does.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;&gt;&nbsp;Or&nbsp;should&nbsp;i&nbsp;use&nbsp;&lt;br&gt;&gt;&gt;&nbsp;add_request_headers?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;No,&nbsp;that&nbsp;would&nbsp;add&nbsp;HTTP&nbsp;headers&nbsp;to&nbsp;the&nbsp;outgoing&nbsp;messages&nbsp;(to&nbsp;server&nbsp;or&nbsp;&lt;br&gt;&gt;to&nbsp;client).&lt;/div&gt;&lt;div&gt;&gt;&gt;&nbsp;&lt;br&gt;&gt;&gt;&nbsp;I&nbsp;know&nbsp;that&nbsp;squid&nbsp;can&nbsp;create&nbsp;a&nbsp;2nd&nbsp;fake&nbsp;connect&nbsp;with&nbsp;sni&nbsp;but&nbsp;here&nbsp;again&nbsp;&lt;br&gt;&gt;&gt;&nbsp;icap&nbsp;just&nbsp;print&nbsp;the&nbsp;same&nbsp;connect&nbsp;2&nbsp;times&lt;br&gt;&gt;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;That&nbsp;is&nbsp;correct,&nbsp;however&nbsp;SNI&nbsp;is&nbsp;not&nbsp;always&nbsp;sent&nbsp;by&nbsp;clients.&nbsp;Squid&nbsp;can&nbsp;&lt;br&gt;&gt;only&nbsp;use&nbsp;what&nbsp;it&nbsp;is&nbsp;given.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;If&nbsp;there&nbsp;is&nbsp;an&nbsp;SNI&nbsp;in&nbsp;that&nbsp;particular&nbsp;clientHello&nbsp;you&nbsp;have&nbsp;hit&nbsp;a&nbsp;bug&nbsp;in&nbsp;&lt;br&gt;&gt;Squid.&lt;/div&gt;&lt;div&gt;&gt;&lt;/div&gt;&lt;div&gt;&gt;Amos&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;Amos&nbsp;for&nbsp;the&nbsp;reply.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&gt;________&lt;span&nbsp;style=&quot;font-size:&nbsp;14pt;&quot;&gt;______________________________________&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
