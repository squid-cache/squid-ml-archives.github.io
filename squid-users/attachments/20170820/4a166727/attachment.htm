<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;For&nbsp;those&nbsp;looking&nbsp;into&nbsp;this&nbsp;topic,&nbsp;I&nbsp;was&nbsp;able&nbsp;to&nbsp;make&nbsp;it&nbsp;work&nbsp;on&nbsp;3.5. &lt;div&gt;The&nbsp;trick&nbsp;is&nbsp;to&nbsp;have&nbsp;&quot;ssl_bump&nbsp;splice&nbsp;all&quot;.&lt;/div&gt;&lt;div&gt;My&nbsp;upstream&nbsp;proxy&nbsp;is &lt;a&nbsp;href=&quot;http://10.1.7.7:3128&quot;&gt;10.1.7.7:3128&lt;/a&gt;.&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;all&nbsp;in&nbsp;Ubuntu&nbsp;16.04&nbsp;-&nbsp;however&nbsp;the&nbsp;squid&nbsp;package&nbsp;was&nbsp;rebuilt&nbsp;due&nbsp;to&nbsp;lack&nbsp;of&nbsp;--with-openssl&nbsp;and --enable-ssl&nbsp;(there&nbsp;are&nbsp;several&nbsp;guides&nbsp;on&nbsp;the&nbsp;internet&nbsp;on&nbsp;how&nbsp;to&nbsp;rebuild&nbsp;a&nbsp;package,&nbsp;I&nbsp;used&nbsp;&lt;a&nbsp;href=&quot;https://docs.diladele.com/administrator_guide_4_0/system_configuration/https_filtering/recompile_squid.html&quot;&gt;this&nbsp;one&lt;/a&gt;&nbsp;as&nbsp;reference,&nbsp;there&nbsp;are&nbsp;also&nbsp;third-party&nbsp;.debs&nbsp;if&nbsp;you&nbsp;trust&nbsp;them).&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*&nbsp;squid.conf:&lt;/div&gt;&lt;div&gt;-----------------------&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;localhost&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://127.0.0.0/8&quot;&gt;127.0.0.0/8&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.100.0/24&quot;&gt;192.168.100.0/24&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://192.168.101.0/24&quot;&gt;192.168.101.0/24&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&lt;span&nbsp;class=&quot;gmail-Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;http&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&lt;span&nbsp;class=&quot;gmail-Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;#&nbsp;https&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;http_access&nbsp;allow&nbsp; localhost&nbsp;localnet&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;http_access&nbsp;deny&nbsp;all&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;http_port&nbsp;3128&nbsp;accel&nbsp;vhost&nbsp;allow-direct&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;https_port&nbsp;3129&nbsp;ssl-bump&nbsp;intercept&nbsp;cert=/etc/squid/ssl_cert/myca.pem&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;cache_peer&nbsp;10.1.7.7&nbsp;parent&nbsp;3128&nbsp;0&nbsp;no-query&nbsp;no-digest&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;never_direct&nbsp;allow&nbsp;all&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;shutdown_lifetime&nbsp;2&nbsp;seconds&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*&nbsp;iptables&nbsp;(PRE-ROUTING&nbsp;required&nbsp;if&nbsp;you&#39;re&nbsp;using&nbsp;e.g.&nbsp;docker&nbsp;-&nbsp;your&nbsp;containers&nbsp;will&nbsp;also&nbsp;not&nbsp;need&nbsp;proxy&nbsp;config):&lt;/div&gt;&lt;div&gt;&lt;div&gt;-----------------------&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3129&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3128&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;owner&nbsp;!&nbsp;--uid-owner&nbsp;proxy&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-port&nbsp;3128&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace,&nbsp;monospace&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;owner&nbsp;!&nbsp;--uid-owner&nbsp;proxy&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-port&nbsp;3129&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jun&nbsp;13,&nbsp;2017&nbsp;at&nbsp;9:35&nbsp;AM,&nbsp;Madonna,&nbsp;A.&nbsp;(spir-it)&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:A.Madonna@rechtspraak.nl&quot;&nbsp;target=&quot;_blank&quot;&gt;A.Madonna@rechtspraak.nl&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hello&nbsp;Jeryl,&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;look&nbsp;on&nbsp;the&nbsp;mailing&nbsp;list&nbsp;we&nbsp;and&nbsp;many&nbsp;before&nbsp;us&nbsp;have&nbsp;this&nbsp;problem.&lt;br&gt;<br>
&lt;br&gt;<br>
Client&nbsp;----&gt;&nbsp;Squid&nbsp;proxy&nbsp;----&gt;&nbsp;Parent&nbsp;proxy&nbsp;----&gt;&nbsp;Internets&nbsp;(http&nbsp;/&nbsp;HTTPS)&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;already&nbsp;stated&nbsp;by&nbsp;1&nbsp;of&nbsp;the&nbsp;developers&nbsp;before,&nbsp;the&nbsp;code&nbsp;simply&nbsp;does&nbsp;not&nbsp;exist&nbsp;to&nbsp;handle&nbsp;this.&nbsp;cache_peer&nbsp;can&#39;t&nbsp;do&nbsp;a&nbsp;&quot;HTTP&nbsp;CONNECT&quot;,&nbsp;simulating&nbsp;the&nbsp;first&nbsp;client&nbsp;connection&nbsp;with&nbsp;a&nbsp;parent&nbsp;proxy.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;has&nbsp;been&nbsp;so&nbsp;for&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;5+&nbsp;years.&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;are&nbsp;now&nbsp;looking&nbsp;into&nbsp;a&nbsp;solution&nbsp;where&nbsp;we&nbsp;put&nbsp;something&nbsp;between&nbsp;the&nbsp;squid&nbsp;and&nbsp;the&nbsp;parent&nbsp;proxy&nbsp;which&nbsp;can&nbsp;provide&nbsp;a&nbsp;&quot;HTTP&nbsp;CONNECT&quot;&nbsp;in&nbsp;combination&nbsp;with&nbsp;ssl_bump&nbsp;preserving&nbsp;the&nbsp;original&nbsp;SNI(server&nbsp;name&nbsp;indication).&lt;br&gt;<br>
&lt;br&gt;<br>
Client&nbsp;----&gt;&nbsp;Squid&nbsp;proxy&nbsp;----&gt;&nbsp;&quot;HTTP&nbsp;CONNECT&quot;&nbsp;solution----&gt;Parent&nbsp;proxy&nbsp;----&gt;&nbsp;Internets&nbsp;(http&nbsp;/&nbsp;HTTPS)&lt;br&gt;<br>
&lt;br&gt;<br>
Kind&nbsp;regards,&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
-----Oorspronkelijk&nbsp;bericht-----&lt;br&gt;<br>
Van:&nbsp;squid-users&nbsp;[mailto:&lt;a&nbsp;href=&quot;mailto:squid-users-bounces@lists.squid-cache.org&quot;&gt;squid-users-bounces@&lt;wbr&gt;lists.squid-cache.org&lt;/a&gt;]&nbsp;Namens&nbsp;Amos&nbsp;Jeffries&lt;br&gt;<br>
Verzonden:&nbsp;dinsdag&nbsp;13&nbsp;juni&nbsp;2017&nbsp;5:41&lt;br&gt;<br>
Aan:&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
Onderwerp:&nbsp;Re:&nbsp;[squid-users]&nbsp;client--&gt;iptables--&gt;squid-&lt;wbr&gt;proxy-&gt;another-proxy&lt;br&gt;<br>
&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
On&nbsp;13/06/17&nbsp;08:33,&nbsp;JerylCook&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;I&#39;ve&nbsp;been&nbsp;stuck&nbsp;on&nbsp;this&nbsp;for&nbsp;a&nbsp;few&nbsp;days&nbsp;:P...&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt; &nbsp; I&nbsp;&#39;thought&#39;&nbsp;I&nbsp;had&nbsp;a&nbsp;fairly&nbsp;good&nbsp;understanding&nbsp;of&nbsp;squid&nbsp;+&nbsp;ssl_bump&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;not&nbsp;so&nbsp;sure.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;In&nbsp;a&nbsp;nutshell&nbsp;i&nbsp;am&nbsp;having&nbsp;an&nbsp;issue&nbsp;linking&nbsp;a&nbsp;second&nbsp;proxy&nbsp;server&nbsp;via&lt;br&gt;<br>
&gt;&nbsp;cache_peer.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;we&nbsp;have&nbsp;2&nbsp;boxes.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;*Configuration:*&lt;br&gt;<br>
&gt;&nbsp;1&nbsp;box,&nbsp;has&nbsp;iptables&nbsp;configured&nbsp;to&nbsp;send&nbsp;all&nbsp;outbound&nbsp;traffic&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.1:8999&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.1:8999&lt;/a&gt;&nbsp;which&nbsp;is&nbsp;the&nbsp;second&nbsp;box&#39;s&nbsp;squid&nbsp;server&nbsp;and&nbsp;port(8999)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;2nd&nbsp;box,&nbsp;has&nbsp;squid&nbsp;running&nbsp;on&nbsp;8999,&nbsp;we&nbsp;have&nbsp;another&nbsp;server&nbsp;running&nbsp;on&nbsp;8998.&lt;br&gt;<br>
&gt;&nbsp;both&nbsp;proxy&nbsp;servers&nbsp;are&nbsp;using&nbsp;the&nbsp;same&nbsp;&#39;CA&#39;.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;https&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.1:8999&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.1:8999&lt;/a&gt;&nbsp;transparent&nbsp;ssl-bump&nbsp;generate-host-certificates=on.&lt;wbr&gt;....&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.1:8998&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.1:8998&lt;/a&gt;&nbsp;8998&nbsp;0&nbsp;ssl&nbsp;default&nbsp;no-query&nbsp;no-digest&lt;br&gt;<br>
&gt;&nbsp;sslflags=DONT_VERIFY_PEER....&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;use-case:&lt;br&gt;<br>
&gt;&nbsp;wget&nbsp;&lt;a&nbsp;href=&quot;https://facebook.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://facebook.com&lt;/a&gt;&nbsp;--ca-cert=/dat/sharedCa.cer &nbsp;,&nbsp;on&nbsp;box&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;through&nbsp;iptables..&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;squid&nbsp;on&nbsp;box&nbsp;2&nbsp;generates&nbsp;and&nbsp;signs&nbsp;a&nbsp;certificate&nbsp;with&lt;br&gt;<br>
&gt;&nbsp;CN=&lt;a&nbsp;href=&quot;http://facebook.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;facebook.com&lt;/a&gt;&nbsp;for&nbsp;the&nbsp;client&lt;br&gt;<br>
&lt;br&gt;<br>
That&nbsp;sounds&nbsp;a&nbsp;little&nbsp;suspicious&nbsp;to&nbsp;me.&nbsp;FB&nbsp;have&nbsp;a&nbsp;more&nbsp;complicated&nbsp;CN&nbsp;in&nbsp;their&nbsp;real&nbsp;certs.&nbsp;You&nbsp;omitted&nbsp;your&nbsp;ssl_bump&nbsp;rules,&nbsp;so&nbsp;the&nbsp;type&nbsp;of&nbsp;bumping&nbsp;and&nbsp;details&nbsp;available&nbsp;are&nbsp;unknown&nbsp;-&nbsp;but&nbsp;I&nbsp;suspect&nbsp;they&nbsp;may&nbsp;not&nbsp;be&nbsp;doing&nbsp;what&nbsp;you&nbsp;expect&nbsp;in&nbsp;that&nbsp;case.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;2.&nbsp;client&nbsp;trusts&nbsp;the&nbsp;CA&nbsp;and&nbsp;cert.&lt;br&gt;<br>
&lt;br&gt;<br>
Which&nbsp;if&nbsp;the&nbsp;three&nbsp;CA&nbsp;involved?&nbsp;they&nbsp;need&nbsp;to&nbsp;trust&nbsp;the&nbsp;one&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;frontend&nbsp;Squid&nbsp;cert&nbsp;generator.&lt;br&gt;<br>
 &nbsp;Only&nbsp;frontend&nbsp;Squid&nbsp;needs&nbsp;to&nbsp;trust&nbsp;the&nbsp;backend&nbsp;peer&nbsp;CA.&nbsp;And&nbsp;likewise,&nbsp;only&nbsp;the&nbsp;backend&nbsp;peer&nbsp;needs&nbsp;to&nbsp;trust&nbsp;the&nbsp;origin&nbsp;CA.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;3.we&nbsp;want&nbsp;squid&nbsp;to&nbsp;send&nbsp;this&nbsp;proxied&nbsp;https&nbsp;request&nbsp;to&nbsp;the&nbsp;second&nbsp;proxy&lt;br&gt;<br>
&gt;&nbsp;server&nbsp;on&nbsp;:8998.&nbsp;this&nbsp;proxy&nbsp;server&nbsp;is&nbsp;set&nbsp;to&nbsp;generate&nbsp;impersonation&lt;br&gt;<br>
&gt;&nbsp;certs&nbsp;as&nbsp;well&nbsp;using&nbsp;the&nbsp;same&nbsp;rootCAKey&nbsp;that&nbsp;squid&nbsp;uses...&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;is&nbsp;where&nbsp;the&nbsp;current&nbsp;behaviour&nbsp;is&nbsp;lacking&nbsp;AFAIK.&nbsp;SSL-Bump&nbsp;assumes&nbsp;the&nbsp;client&nbsp;(frontend&nbsp;Squid)&nbsp;is&nbsp;either&nbsp;sending&nbsp;a&nbsp;CONNECT&nbsp;request&nbsp;to&nbsp;get&nbsp;the&nbsp;server&nbsp;details&nbsp;from,&nbsp;or&nbsp;that&nbsp;it&nbsp;is&nbsp;working&nbsp;with&nbsp;intercepted&nbsp;TLS&nbsp;rather&nbsp;than&nbsp;a&nbsp;TLS&nbsp;explicit&nbsp;proxy&nbsp;connection.&nbsp;So&nbsp;the&nbsp;backend&nbsp;behaviour&nbsp;is&nbsp;still&nbsp;very&nbsp;much&nbsp;just&nbsp;receive&nbsp;a&nbsp;request&nbsp;for&nbsp;https://&nbsp;URL&nbsp;and&nbsp;do&nbsp;the&nbsp;serve&nbsp;TLS&nbsp;thing&nbsp;-&nbsp;no&nbsp;mimicing&nbsp;on&nbsp;its&nbsp;client&nbsp;connection&nbsp;(AFAIK).&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;however,&nbsp;we&nbsp;keep&nbsp;getting&lt;br&gt;<br>
&gt;&nbsp;&quot;Failed&nbsp;to&nbsp;establish&nbsp;a&nbsp;secure&nbsp;connection,&nbsp;SQUID_ERR_SSL_HANDSHAKE&quot;,&lt;br&gt;<br>
&gt;&nbsp;Handshake&nbsp;with&nbsp;SSL&nbsp;Server&nbsp;failed:&nbsp;error:140770FC:SSL&nbsp;routines&lt;br&gt;<br>
&gt;&nbsp;SSL23_GET_SERVER_HELLO:&nbsp;unknown&nbsp;protocol&quot;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Does&nbsp;squid&nbsp;3.5.20&nbsp;support&nbsp;PROXY&nbsp;Protocol&nbsp;in&nbsp;cache_peer&nbsp;if&nbsp;you&nbsp;need&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;link&nbsp;a&nbsp;second&nbsp;proxy?&nbsp;or&nbsp;is&nbsp;my&nbsp;configuration&nbsp;messed&nbsp;up.&lt;br&gt;<br>
&lt;br&gt;<br>
Squid&nbsp;only&nbsp;supports&nbsp;receiving&nbsp;PROXY&nbsp;Protocol&nbsp;on&nbsp;the&nbsp;http_port&nbsp;directive.&lt;br&gt;<br>
Not&nbsp;yet&nbsp;sending&nbsp;to&nbsp;a&nbsp;cache_peer.&nbsp;Though&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;any&nbsp;relevance&nbsp;to&nbsp;PROXY&nbsp;Protocol&nbsp;in&nbsp;anything&nbsp;you&nbsp;have&nbsp;described&nbsp;about&nbsp;your&nbsp;configuration.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;the&nbsp;peer&nbsp;is&nbsp;sending&nbsp;an&nbsp;error&nbsp;back&nbsp;to&nbsp;Squid&nbsp;when&nbsp;it&nbsp;gets&nbsp;TLS&nbsp;instead&nbsp;of&nbsp;PROXY&nbsp;intro&nbsp;octets&nbsp;that&nbsp;would&nbsp;explain&nbsp;the&nbsp;SSL&nbsp;errors.&nbsp;It&nbsp;also&nbsp;would&nbsp;if&nbsp;the&nbsp;peer&nbsp;was&nbsp;sending&nbsp;back&nbsp;HTTP&nbsp;messages&nbsp;instead&nbsp;of&nbsp;TLS&nbsp;(HTTPS),&nbsp;which&nbsp;is&nbsp;a&nbsp;more&nbsp;common&nbsp;problem&nbsp;when&nbsp;the&nbsp;peer&nbsp;is&nbsp;an&nbsp;older&nbsp;Squid.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
SSL-Bump&nbsp;is&nbsp;supported&nbsp;to&nbsp;cache_peer&nbsp;when&nbsp;the&nbsp;peer&nbsp;connection&nbsp;is&nbsp;a&nbsp;TLS/SSL&nbsp;connection.&nbsp;Though&nbsp;be&nbsp;aware&nbsp;that&nbsp;the&nbsp;&quot;server&quot;&nbsp;frontend&nbsp;Squid&nbsp;mimics&nbsp;would&nbsp;then&nbsp;be&nbsp;the&nbsp;backend&nbsp;peer&#39;s&nbsp;certificate,&nbsp;not&nbsp;the&nbsp;origin&nbsp;server.&lt;br&gt;<br>
&lt;br&gt;<br>
Also,&nbsp;avoid&nbsp;DONT_VERIFY_PEER,&nbsp;it&nbsp;is&nbsp;really&nbsp;doing&nbsp;more&nbsp;harm&nbsp;than&nbsp;anything&nbsp;useful.&nbsp;Since&nbsp;this&nbsp;is&nbsp;a&nbsp;peer&nbsp;you&nbsp;know&nbsp;about&nbsp;you&nbsp;should&nbsp;also&nbsp;know&nbsp;its&nbsp;CA&nbsp;in&nbsp;advance.&nbsp;So&nbsp;use&nbsp;&quot;sslflags=NO_DEFAULT_CA&nbsp;sslcafile=...&quot;&nbsp;and&nbsp;Squid&nbsp;can&nbsp;do&nbsp;all&nbsp;the&nbsp;security&nbsp;checks&nbsp;just&nbsp;fine&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;its&nbsp;a&nbsp;custom&nbsp;CA&nbsp;or&nbsp;not.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;______________________________&lt;wbr&gt;__&lt;br&gt;<br>
&lt;br&gt;<br>
Informatie&nbsp;van&nbsp;de&nbsp;Raad&nbsp;voor&nbsp;de&nbsp;rechtspraak,&nbsp;de&nbsp;rechtbanken,&nbsp;de&nbsp;gerechtshoven&nbsp;en&nbsp;de&nbsp;bijzondere&nbsp;colleges&nbsp;vindt&nbsp;u&nbsp;op&nbsp;&lt;a&nbsp;href=&quot;http://www.rechtspraak.nl&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;www.rechtspraak.nl&lt;/a&gt;.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;br&gt;--------&lt;br&gt;&lt;br&gt;Diogenes&nbsp;S.&nbsp;de&nbsp;Jesus&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
