<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;setup&nbsp;tproxy&nbsp;with&nbsp;Squid&nbsp;3.5&nbsp;for&nbsp;the&nbsp;purpose&nbsp;of&nbsp;having&nbsp;the&nbsp;same&nbsp;outgoing&nbsp;ip&nbsp;as&nbsp;the&nbsp;connecting&nbsp;ip.&nbsp;(I&nbsp;have&nbsp;thousands&nbsp;of&nbsp;IPs&nbsp;and&nbsp;I&nbsp;can&nbsp;not&nbsp;add&nbsp;them&nbsp;one&nbsp;by&nbsp;one)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;started&nbsp;with&nbsp;a&nbsp;fresh&nbsp;install&nbsp;of&nbsp;Debian&nbsp;9,&nbsp;installed&nbsp;Squid&nbsp;by&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;apt&nbsp;install&nbsp;squid&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;then&nbsp;I&nbsp;added &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;http_port&nbsp;3129&nbsp;tproxy&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;to&nbsp;squid.conf&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;then&nbsp;ran&nbsp;the&nbsp;following&nbsp;commands&nbsp;for&nbsp;iptables&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-N&nbsp;DIVERT&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;DIVERT&nbsp;-j&nbsp;MARK&nbsp;--set-mark&nbsp;1&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;DIVERT&nbsp;-j&nbsp;ACCEPT&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iptables &nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;socket&nbsp;-j&nbsp;DIVERT&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iptables &nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;TPROXY&nbsp;--tproxy-mark&nbsp;0x1/0x1&nbsp;--on-port&nbsp;3129&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;use&nbsp;the&nbsp;proxy&nbsp;with&nbsp;no&nbsp;problems&nbsp;on&nbsp;port&nbsp;3128,&nbsp;but&nbsp;on&nbsp;Firefox&nbsp;I&nbsp;get&nbsp;a&nbsp;message&nbsp;&quot;The&nbsp;proxy&nbsp;server&nbsp;is&nbsp;refusing&nbsp;connections&quot;&nbsp;when&nbsp;I&nbsp;set&nbsp;the&nbsp;proxy&nbsp;to&nbsp;port&nbsp;3129.&nbsp;Did&nbsp;I&nbsp;miss&nbsp;any&nbsp;steps&nbsp;or&nbsp;am&nbsp;I&nbsp;doing&nbsp;something&nbsp;wrong?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;below&nbsp;is&nbsp;my&nbsp;full&nbsp;squid.conf&nbsp;file&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&lt;/div&gt;&lt;div&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt;http_port&nbsp;3128&lt;/div&gt;&lt;div&gt;http_port&nbsp;3129&nbsp;tproxy&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/spool/squid&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^ftp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1440 &nbsp; &nbsp;20% &nbsp; &nbsp; 10080&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^gopher: &nbsp; &nbsp; &nbsp; &nbsp;1440 &nbsp; &nbsp;0% &nbsp; &nbsp; &nbsp;1440&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0 &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp;0&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; 20% &nbsp; &nbsp; 4320&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
