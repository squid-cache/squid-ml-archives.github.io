<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;everyone,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;having&nbsp;problems&nbsp;using&nbsp;Squid&nbsp;with&nbsp;ICAP&nbsp;(C-ICAP&nbsp;and&nbsp;clamd).&nbsp;The&nbsp;thing&nbsp;that&nbsp;is&nbsp;bugging&nbsp;me&nbsp;is&nbsp;I&nbsp;had&nbsp;this&nbsp;was&nbsp;working&nbsp;fine&nbsp;and&nbsp;now&nbsp;it&nbsp;cannot&nbsp;connect&nbsp;to&nbsp;the&nbsp;local&nbsp;ICAP&nbsp;service.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Below&nbsp;is&nbsp;the&nbsp;debug&nbsp;section&nbsp;93,3&nbsp;to&nbsp;see&nbsp;what&nbsp;was&nbsp;going&nbsp;on&nbsp;when&nbsp;I&nbsp;restarted&nbsp;Squid:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.546&nbsp;kid1|&nbsp;93,3|&nbsp;ServiceRep.cc(712)&nbsp;detach:&nbsp;detaching&nbsp;ICAP&nbsp;service:&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/virus_scan&quot;&gt;127.0.0.1:1344/virus_scan&lt;/a&gt;&nbsp;[down,!opt]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.546&nbsp;kid1|&nbsp;93,3|&nbsp;ServiceRep.cc(712)&nbsp;detach:&nbsp;detaching&nbsp;ICAP&nbsp;service:&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/srv_content_filtering&quot;&gt;127.0.0.1:1344/srv_content_filtering&lt;/a&gt;&nbsp;[down,!opt]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,3|&nbsp;Service.cc(19)&nbsp;Service:&nbsp;creating&nbsp;adaptation&nbsp;service&nbsp;service_cfi_resp&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,3|&nbsp;Service.cc(19)&nbsp;Service:&nbsp;creating&nbsp;adaptation&nbsp;service&nbsp;service_avi_resp&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,3|&nbsp;Config.cc(195)&nbsp;finalize:&nbsp;Created&nbsp;2&nbsp;adaptation&nbsp;services&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;Adaptation&nbsp;support&nbsp;is&nbsp;on&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,2|&nbsp;Config.cc(211)&nbsp;FinalizeEach:&nbsp;Initialized&nbsp;2&nbsp;message&nbsp;adaptation&nbsp;services&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,2|&nbsp;Config.cc(211)&nbsp;FinalizeEach:&nbsp;Initialized&nbsp;1&nbsp;message&nbsp;adaptation&nbsp;service&nbsp;groups&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:34.548&nbsp;kid1|&nbsp;93,2|&nbsp;Config.cc(211)&nbsp;FinalizeEach:&nbsp;Initialized&nbsp;3&nbsp;message&nbsp;adaptation&nbsp;access&nbsp;rules&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.415&nbsp;kid1|&nbsp;93,3|&nbsp;AccessCheck.cc(196)&nbsp;callBack:&nbsp;NULL&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.415&nbsp;kid1|&nbsp;93,3|&nbsp;client_side_request.cc(1074)&nbsp;noteAdaptationAclCheckDone:&nbsp;0x10dd728&nbsp;adaptationAclCheckDone&nbsp;called&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AccessCheck.cc(196)&nbsp;callBack:&nbsp;0xd45b80*2&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;Xaction.cc(60)&nbsp;Xaction:&nbsp;Adaptation::Icap::ModXact&nbsp;constructed,&nbsp;this=0x124c4b8&nbsp;[icapxjob146537]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;Xaction.cc(60)&nbsp;Xaction:&nbsp;Adaptation::Icap::OptXact&nbsp;constructed,&nbsp;this=0x120c818&nbsp;[icapxjob146539]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;ServiceRep.cc(122)&nbsp;getConnection:&nbsp;got&nbsp;connection:&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;Xaction.cc(145)&nbsp;openConnection:&nbsp;Adaptation::Icap::OptXact&nbsp;opens&nbsp;connection&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://127.0.0.1:1344&quot;&gt;127.0.0.1:1344&lt;/a&gt;&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncCall.cc(26)&nbsp;AsyncCall:&nbsp;The&nbsp;AsyncCall&nbsp;Adaptation::Icap::Xaction::noteCommConnected&nbsp;constructed,&nbsp;this=0x10a1ed0&nbsp;[call901778]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncCall.cc(93)&nbsp;ScheduleCall:&nbsp;ConnOpener.cc(137)&nbsp;will&nbsp;call&nbsp;Adaptation::Icap::Xaction::noteCommConnected(local=[::]&nbsp;remote=&lt;a&nbsp;href=&quot;http://127.0.0.1:1344&quot;&gt;127.0.0.1:1344&lt;/a&gt;&nbsp;flags=1,&nbsp;errno=101,&nbsp;flag=-8,&nbsp;data=0x120c818)&nbsp;[call901778]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncCallQueue.cc(55)&nbsp;fireNext:&nbsp;entering&nbsp;Adaptation::Icap::Xaction::noteCommConnected(local=[::]&nbsp;remote=&lt;a&nbsp;href=&quot;http://127.0.0.1:1344&quot;&gt;127.0.0.1:1344&lt;/a&gt;&nbsp;flags=1,&nbsp;errno=101,&nbsp;flag=-8,&nbsp;data=0x120c818)&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncCall.cc(38)&nbsp;make:&nbsp;make&nbsp;call&nbsp;Adaptation::Icap::Xaction::noteCommConnected&nbsp;[call901778]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncJob.cc(123)&nbsp;callStart:&nbsp;Adaptation::Icap::OptXact&nbsp;status&nbsp;in:&nbsp;[/&nbsp;job146539]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,2|&nbsp;Xaction.cc(272)&nbsp;dieOnConnectionFailure:&nbsp;Adaptation::Icap::OptXact&nbsp;failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/virus_scan&quot;&gt;127.0.0.1:1344/virus_scan&lt;/a&gt;&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;ServiceRep.cc(161)&nbsp;noteConnectionFailed:&nbsp;Connection&nbsp;failed:&nbsp;failure&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;../../../src/base/AsyncJobCalls.h(177)&nbsp;dial:&nbsp;Adaptation::Icap::Xaction::noteCommConnected&nbsp;threw&nbsp;exception:&nbsp;cannot&nbsp;connect&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;service&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;Xaction.cc(71)&nbsp;~Xaction:&nbsp;Adaptation::Icap::OptXact&nbsp;destructed,&nbsp;this=0x120c818&nbsp;[icapxjob146539]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;AsyncCallQueue.cc(57)&nbsp;fireNext:&nbsp;leaving&nbsp;Adaptation::Icap::Xaction::noteCommConnected(local=[::]&nbsp;remote=&lt;a&nbsp;href=&quot;http://127.0.0.1:1344&quot;&gt;127.0.0.1:1344&lt;/a&gt;&nbsp;flags=1,&nbsp;errno=101,&nbsp;flag=-8,&nbsp;data=0x120c818)&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;Launcher.cc(95)&nbsp;noteXactAbort:&nbsp;cannot&nbsp;retry&nbsp;or&nbsp;repeat&nbsp;a&nbsp;failed&nbsp;transaction&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;93,3|&nbsp;ServiceRep.cc(534)&nbsp;noteAdaptationAnswer:&nbsp;failed&nbsp;to&nbsp;fetch&nbsp;options&nbsp;[down,!opt,fail1]&lt;/div&gt;&lt;div&gt;2017/11/02&nbsp;12:06:51.454&nbsp;kid1|&nbsp;optional&nbsp;ICAP&nbsp;service&nbsp;is&nbsp;down&nbsp;after&nbsp;an&nbsp;options&nbsp;fetch&nbsp;failure:&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/virus_scan&quot;&gt;127.0.0.1:1344/virus_scan&lt;/a&gt;&nbsp;[down,!opt]&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Looks&nbsp;like&nbsp;it&nbsp;load&nbsp;my&nbsp;rules&nbsp;and&nbsp;then&nbsp;tries&nbsp;to&nbsp;connect&nbsp;and&nbsp;fails.&nbsp;I&nbsp;read&nbsp;almost&nbsp;every&nbsp;post&nbsp;I&nbsp;could&nbsp;find&nbsp;but&nbsp;do&nbsp;not&nbsp;seem&nbsp;to&nbsp;have&nbsp;the&nbsp;same&nbsp;problem.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;use&nbsp;the&nbsp;c-icap-client&nbsp;and&nbsp;test&nbsp;each&nbsp;service.&nbsp;It&nbsp;looks&nbsp;fine.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&gt;#&nbsp;./c-icap-client&nbsp;-s&nbsp;virus_scan&lt;/div&gt;&lt;div&gt;ICAP&nbsp;server:localhost,&nbsp;ip:127.0.0.1,&nbsp;port:1344&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;OPTIONS:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Allow&nbsp;204:&nbsp;Yes&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Preview:&nbsp;1024&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Keep&nbsp;alive:&nbsp;Yes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ICAP&nbsp;HEADERS:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;ICAP/1.0&nbsp;200&nbsp;OK&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Methods:&nbsp;RESPMOD,&nbsp;REQMOD&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Service:&nbsp;C-ICAP/0.4.3&nbsp;server&nbsp;-&nbsp;Antivirus&nbsp;service&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;ISTag:&nbsp;CI0001-J8gT2j9ufFux2fjZGxq1qAAA&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Transfer-Preview:&nbsp;*&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Options-TTL:&nbsp;3600&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Date:&nbsp;Thu,&nbsp;02&nbsp;Nov&nbsp;2017&nbsp;16:17:15&nbsp;GMT&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Preview:&nbsp;1024&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Allow:&nbsp;204&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;Encapsulated:&nbsp;null-body=0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt;#&nbsp;./c-icap-client&nbsp;-s&nbsp;virus_scan&nbsp;-f&nbsp;/bin/ls&lt;/div&gt;&lt;div&gt;ICAP&nbsp;server:localhost,&nbsp;ip:127.0.0.1,&nbsp;port:1344&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;No&nbsp;modification&nbsp;needed&nbsp;(Allow&nbsp;204&nbsp;response)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;post&nbsp;some&nbsp;of&nbsp;my&nbsp;squid.conf&nbsp;file&nbsp;below&nbsp;for&nbsp;icap&nbsp;options:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;icap_enable&nbsp;on&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;adaptation_send_client_ip&nbsp;on&lt;/div&gt;&lt;div&gt;icap_persistent_connections&nbsp;on&lt;/div&gt;&lt;div&gt;icap_service_failure_limit&nbsp;-1&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;icap_send_client_ip&nbsp;on&lt;/div&gt;&lt;div&gt;icap_send_client_username&nbsp;on&lt;/div&gt;&lt;div&gt;icap_client_username_header&nbsp;X-Authenticated-User&lt;/div&gt;&lt;div&gt;icap_preview_enable&nbsp;on&lt;/div&gt;&lt;div&gt;icap_preview_size&nbsp;1024&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;icap_service&nbsp;service_cfi_resp&nbsp;respmod_precache&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/srv_content_filtering&quot;&gt;127.0.0.1:1344/srv_content_filtering&lt;/a&gt;&nbsp;routing=on&nbsp;bypass=on&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;icap_service&nbsp;service_avi_resp&nbsp;respmod_precache&nbsp;icap://&lt;a&nbsp;href=&quot;http://127.0.0.1:1344/virus_scan&quot;&gt;127.0.0.1:1344/virus_scan&lt;/a&gt;&nbsp;routing=on&nbsp;bypass=on&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;adaptation_service_chain&nbsp;check_services&nbsp;service_avi_resp&nbsp;service_cfi_resp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;adaptation_access&nbsp;check_services&nbsp;allow&nbsp;Antivirus_users&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;adaptation_access&nbsp;service_avi_resp&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;adaptation_access&nbsp;service_cfi_resp&nbsp;deny&nbsp;all&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;you&nbsp;need&nbsp;more&nbsp;information&nbsp;I&nbsp;can&nbsp;provide&nbsp;it.&nbsp;I&nbsp;am&nbsp;stuck&nbsp;at&nbsp;why&nbsp;this&nbsp;does&nbsp;not&nbsp;work&nbsp;anymore.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note:&nbsp;this&nbsp;is&nbsp;basic&nbsp;linux&nbsp;box&nbsp;running&nbsp;Squid&nbsp;3.5.22&nbsp;with&nbsp;C-ICAP&nbsp;0.4.3&nbsp;and&nbsp;ClamAV&nbsp;0.99.2&nbsp;also&nbsp;i&nbsp;am&nbsp;not&nbsp;using&nbsp;caching&nbsp;with&nbsp;squid.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;/div&gt;<br>

</tt>
