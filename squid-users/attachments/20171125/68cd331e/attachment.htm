<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#4c4c4c&quot;&nbsp;link=&quot;#8793c1&quot;&nbsp;vlink=&quot;#8793c1&quot;&gt;&lt;div&gt;On&nbsp;Sat,&nbsp;2017-11-25&nbsp;at&nbsp;23:48&nbsp;+1300,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;pre&gt;On&nbsp;25/11/17&nbsp;08:30,&nbsp;James&nbsp;Lay&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
Topic&nbsp;says&nbsp;it...this&nbsp;setup&nbsp;has&nbsp;been&nbsp;working&nbsp;well&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;but&nbsp;<br>
now&nbsp;there&nbsp;are&nbsp;some&nbsp;sites&nbsp;that&nbsp;are&nbsp;failing&nbsp;the&nbsp;TLS&nbsp;handshake.&nbsp;&nbsp;Here's&nbsp;my&nbsp;<br>
setup:<br>
<br>
acl&nbsp;localnet&nbsp;src&nbsp;192.168.1.0/24<br>
acl&nbsp;SSL_ports&nbsp;port&nbsp;443<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;80<br>
acl&nbsp;Safe_ports&nbsp;port&nbsp;443<br>
acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT<br>
acl&nbsp;allowed_http_sites&nbsp;url_regex&nbsp;&quot;/opt/etc/squid/http_url.txt&quot;<br>
<br>
http_access&nbsp;deny&nbsp;!Safe_ports<br>
http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_Ports<br>
http_access&nbsp;allow&nbsp;SSL_ports<br>
http_access&nbsp;allow&nbsp;allowed_http_sites<br>
http_access&nbsp;deny&nbsp;all<br>
<br>
<br>
ssl_bump&nbsp;peek&nbsp;all<br>
acl&nbsp;allowed_https_sites&nbsp;ssl::server_name_regex&nbsp;&quot;/opt/etc/squid/http_url.txt&quot;<br>
ssl_bump&nbsp;splice&nbsp;allowed_https_sites<br>
ssl_bump&nbsp;terminate&nbsp;all<br>
&lt;/blockquote&gt;<br>
<br>
<br>
Because&nbsp;you&nbsp;have&nbsp;&quot;peek&nbsp;all&quot;&nbsp;being&nbsp;performed&nbsp;the&nbsp;transaction&nbsp;MUST&nbsp;pass&nbsp;<br>
your&nbsp;regex&nbsp;patterns&nbsp;with&nbsp;both&nbsp;TLS&nbsp;SNI&nbsp;from&nbsp;the&nbsp;client&nbsp;*and*&nbsp;the&nbsp;server&nbsp;<br>
certificate&nbsp;SubjectName&nbsp;values.&nbsp;Either&nbsp;one&nbsp;not&nbsp;matching&nbsp;will&nbsp;perform&nbsp;<br>
that&nbsp;&quot;terminate&nbsp;all&quot;&nbsp;on&nbsp;the&nbsp;TLS&nbsp;handshake.<br>
<br>
&lt;/pre&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;Amos...do&nbsp;you&nbsp;have&nbsp;a&nbsp;suggestion&nbsp;for&nbsp;changing&nbsp;this&nbsp;to&nbsp;match&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;instead&nbsp;of&nbsp;both?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;James&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;pre&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
sslproxy_cert_error&nbsp;allow&nbsp;all<br>
sslproxy_capath&nbsp;/etc/ssl/certs<br>
sslproxy_flags&nbsp;DONT_VERIFY_PEER<br>
#sslproxy_options&nbsp;ALL<br>
&lt;/blockquote&gt;<br>
<br>
<br>
Also,&nbsp;please&nbsp;remove&nbsp;these&nbsp;&quot;*_error&nbsp;allow&nbsp;all&quot;&nbsp;and&nbsp;DONT_VERIFY_PEER&nbsp;lines&nbsp;<br>
from&nbsp;your&nbsp;config.&nbsp;They&nbsp;are&nbsp;actively&nbsp;harmful.<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
sslcrtd_program&nbsp;/opt/libexec/ssl_crtd&nbsp;-s&nbsp;/opt/var/ssl_db&nbsp;-M&nbsp;4MB<br>
sslcrtd_children&nbsp;5<br>
<br>
http_port&nbsp;3128&nbsp;intercept<br>
https_port&nbsp;3129&nbsp;intercept&nbsp;ssl-bump&nbsp;<br>
cert=/opt/etc/squid/certs/sslsplit_ca_cert.pem&nbsp;<br>
cafile=/opt/etc/squid/certs/sslsplit_ca_cert.pem&nbsp;<br>
key=/opt/etc/squid/certs/sslsplit_ca_key.pem&nbsp;<br>
&lt;/blockquote&gt;<br>
<br>
NP:&nbsp;when&nbsp;cert=&nbsp;and&nbsp;key=&nbsp;are&nbsp;in&nbsp;the&nbsp;same&nbsp;file&nbsp;you&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;specify&nbsp;<br>
key=.<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
generate-host-certificates=on&nbsp;<br>
dynamic_cert_mem_cache_size=4MB&nbsp;sslflags=NO_SESSION_REUSE<br>
<br>
&lt;/blockquote&gt;<br>
<br>
It&nbsp;is&nbsp;also&nbsp;best&nbsp;to&nbsp;add&nbsp;&quot;sslflags=NO_DEFAULT_CA&quot;&nbsp;to&nbsp;these&nbsp;ports&nbsp;for&nbsp;<br>
Squid-3.&nbsp;That&nbsp;will&nbsp;save&nbsp;a&nbsp;lot&nbsp;of&nbsp;useless&nbsp;memory&nbsp;overheads.<br>
<br>
<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
<br>
logformat&nbsp;mine&nbsp;%&gt;a&nbsp;%[ui&nbsp;%[un&nbsp;[%tl]&nbsp;&quot;%rm&nbsp;%ru&nbsp;HTTP/%rv&quot;&nbsp;%ssl::&gt;sni&nbsp;<br>
%ssl::&gt;cert_subject&nbsp;%&gt;Hs&nbsp;%&lt;st&nbsp;%Ss:%Sh<br>
<br>
&lt;/blockquote&gt;<br>
...<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
For&nbsp;example,&nbsp;the&nbsp;file&nbsp;http_url.txt&nbsp;contains:<br>
<br>
account\.elderscrollsonline\.com<br>
\.elderscrollsonline\.com<br>
elderscrollsonline\.com<br>
<br>
<br>
After&nbsp;doing&nbsp;some&nbsp;reading&nbsp;it&nbsp;looks&nbsp;like&nbsp;this&nbsp;is&nbsp;http2&nbsp;traffic:&nbsp;<br>
&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/Features/HTTP2&quot;&gt;https://wiki.squid-cache.org/Features/HTTP2&lt;/a&gt;.<br>
<br>
&lt;/blockquote&gt;<br>
<br>
There&nbsp;is&nbsp;no&nbsp;sign&nbsp;of&nbsp;HTTP/2&nbsp;in&nbsp;that&nbsp;PCAP&nbsp;trace.&nbsp;There&nbsp;is&nbsp;SPDY/3&nbsp;and&nbsp;<br>
HTTP/1.1&nbsp;being&nbsp;offered&nbsp;by&nbsp;the&nbsp;client.<br>
<br>
<br>
If&nbsp;that&nbsp;is&nbsp;from&nbsp;the&nbsp;client&nbsp;to&nbsp;Squid,&nbsp;then&nbsp;please&nbsp;check&nbsp;the&nbsp;matching&nbsp;<br>
Squid-&gt;server&nbsp;for&nbsp;what&nbsp;is&nbsp;going&nbsp;on&nbsp;there.<br>
<br>
<br>
<br>
If&nbsp;the&nbsp;problem&nbsp;remains&nbsp;please&nbsp;try&nbsp;Squid-4.&nbsp;It&nbsp;has&nbsp;more&nbsp;advanced&nbsp;TLS&nbsp;<br>
capabilities&nbsp;than&nbsp;Squid-3.<br>
<br>
Amos<br>
_______________________________________________<br>
squid-users&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;<br>
&lt;/pre&gt;&lt;/blockquote&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
