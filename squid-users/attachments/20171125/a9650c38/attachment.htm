<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#4c4c4c&quot;&nbsp;link=&quot;#8793c1&quot;&nbsp;vlink=&quot;#8793c1&quot;&gt;&lt;div&gt;On&nbsp;Sun,&nbsp;2017-11-26&nbsp;at&nbsp;01:33&nbsp;+1300,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;pre&gt;On&nbsp;26/11/17&nbsp;00:52,&nbsp;James&nbsp;Lay&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
On&nbsp;Sat,&nbsp;2017-11-25&nbsp;at&nbsp;23:48&nbsp;+1300,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
On&nbsp;25/11/17&nbsp;08:30,&nbsp;James&nbsp;Lay&nbsp;wrote:<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
Topic&nbsp;says&nbsp;it...this&nbsp;setup&nbsp;has&nbsp;been&nbsp;working&nbsp;well&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;but&nbsp;<br>
now&nbsp;there&nbsp;are&nbsp;some&nbsp;sites&nbsp;that&nbsp;are&nbsp;failing&nbsp;the&nbsp;TLS&nbsp;handshake.&nbsp;&nbsp;Here's&nbsp;<br>
my&nbsp;setup:&nbsp;acl&nbsp;localnet&nbsp;src&nbsp;192.168.1.0/24&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&nbsp;acl&nbsp;<br>
Safe_ports&nbsp;port&nbsp;80&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&nbsp;<br>
acl&nbsp;allowed_http_sites&nbsp;url_regex&nbsp;&quot;/opt/etc/squid/http_url.txt&quot;&nbsp;<br>
http_access&nbsp;deny&nbsp;!Safe_ports&nbsp;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_Ports&nbsp;<br>
http_access&nbsp;allow&nbsp;SSL_ports&nbsp;http_access&nbsp;allow&nbsp;allowed_http_sites&nbsp;<br>
http_access&nbsp;deny&nbsp;all&nbsp;ssl_bump&nbsp;peek&nbsp;all&nbsp;acl&nbsp;allowed_https_sites&nbsp;<br>
ssl::server_name_regex&nbsp;&quot;/opt/etc/squid/http_url.txt&quot;&nbsp;ssl_bump&nbsp;splice&nbsp;<br>
allowed_https_sites&nbsp;ssl_bump&nbsp;terminate&nbsp;all&nbsp;<br>
&lt;/blockquote&gt;<br>
<br>
<br>
<br>
Because&nbsp;you&nbsp;have&nbsp;&quot;peek&nbsp;all&quot;&nbsp;being&nbsp;performed&nbsp;the&nbsp;transaction&nbsp;MUST&nbsp;pass<br>
your&nbsp;regex&nbsp;patterns&nbsp;with&nbsp;both&nbsp;TLS&nbsp;SNI&nbsp;from&nbsp;the&nbsp;client&nbsp;*and*&nbsp;the&nbsp;server<br>
certificate&nbsp;SubjectName&nbsp;values.&nbsp;Either&nbsp;one&nbsp;not&nbsp;matching&nbsp;will&nbsp;perform<br>
that&nbsp;&quot;terminate&nbsp;all&quot;&nbsp;on&nbsp;the&nbsp;TLS&nbsp;handshake.<br>
<br>
&lt;/blockquote&gt;<br>
<br>
Thanks&nbsp;Amos...do&nbsp;you&nbsp;have&nbsp;a&nbsp;suggestion&nbsp;for&nbsp;changing&nbsp;this&nbsp;to&nbsp;match&nbsp;one&nbsp;or&nbsp;<br>
the&nbsp;other&nbsp;instead&nbsp;of&nbsp;both?<br>
&lt;/blockquote&gt;<br>
<br>
Doing&nbsp;the&nbsp;splice&nbsp;check&nbsp;before&nbsp;the&nbsp;peek&nbsp;should&nbsp;do&nbsp;that.&nbsp;First&nbsp;one&nbsp;of&nbsp;the&nbsp;<br>
server_names&nbsp;data&nbsp;sources&nbsp;to&nbsp;match&nbsp;will&nbsp;then&nbsp;splice&nbsp;and&nbsp;non-matches&nbsp;fall&nbsp;<br>
through&nbsp;to&nbsp;either&nbsp;peek&nbsp;or&nbsp;terminate&nbsp;if&nbsp;no&nbsp;more&nbsp;peeking&nbsp;possible.<br>
<br>
Amos<br>
&lt;/pre&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Perfect..I've&nbsp;modded&nbsp;my&nbsp;lines&nbsp;with:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;acl&nbsp;broken_https_sites&nbsp;ssl::server_name_regex&nbsp;&quot;/opt/etc/squid/broken_url.txt&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;ssl_bump&nbsp;splice&nbsp;broken_https_sites&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;ssl_bump&nbsp;peek&nbsp;all&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;acl&nbsp;allowed_https_sites&nbsp;ssl::server_name_regex&nbsp;&quot;/opt/etc/squid/http_url.txt&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;ssl_bump&nbsp;splice&nbsp;allowed_https_sites&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;ssl_bump&nbsp;terminate&nbsp;all&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;&lt;/font&gt;Hopefully&nbsp;that&nbsp;fixes&nbsp;these&nbsp;up.&nbsp;&nbsp;Another&nbsp;site&nbsp;besides&nbsp;the&nbsp;the&nbsp;one&nbsp;this&nbsp;thread&nbsp;is&nbsp;fbcdn.net.&nbsp;&nbsp;Again,&nbsp;these&nbsp;DID&nbsp;work,&nbsp;but&nbsp;something&nbsp;within&nbsp;the&nbsp;last&nbsp;month&nbsp;has&nbsp;changed...guessing&nbsp;Facebook&nbsp;and&nbsp;Elder&nbsp;Scrolls&nbsp;Online&nbsp;have&nbsp;added&nbsp;additional&nbsp;TLS&nbsp;security.&nbsp;&nbsp;Thanks&nbsp;as&nbsp;always&nbsp;Amos.&lt;font&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;James&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
