################################################################################
#                                                                              #
# SquidConf for ConAlzaNET                                                     #
# Make by YnievesDotNet <yoinier.hn@gmail.com>                                 #
#                                                                              #
#                                                                              #
################################################################################

################################################################################
#                                                                              #
# GENERAL SETUP                                                                #
#                                                                              #
################################################################################

http_port 3128 ssl-bump cert=/etc/squid/ssl_cert/ConAlza.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB# options=NO_SSLv3 dhparams=/etc/squid/ssl_cert/dhparam.pem
sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1
ssl_bump bump all
authenticate_ip_ttl 60 seconds

################################################################################
#                                                                              #
# AUTH CONFIGURATION                                                           #
#                                                                              #
################################################################################

# Basic auth rules
auth_param basic program /usr/lib64/squid/basic_ldap_auth -v 3 -b "OU=CONALZA,DC=conalza,DC=local" -D "CN=squid,OU=CONALZA,DC=conalza,DC=local" -w Prueba123 -f sAMAccountName=%s -h 172.25.1.254
external_acl_type ldapgroup %LOGIN /usr/lib64/squid/ext_ldap_group_acl -b "OU=CONALZA,DC=conalza,DC=local" -D "CN=squid,OU=CONALZA,DC=conalza,DC=local" -w Prueba123 -f "(&(objectclass=person)(sAMAccountName=%v)(memberof=CN=%a,OU=CONALZA,DC=conalza,DC=local))" -h 172.25.1.254

# Basic auth params
################################################################################
auth_param basic children 5
auth_param basic realm ConAlza Web-Proxy
auth_param basic credentialsttl 1 minute

################################################################################
#                                                                              #
# ACCESS CONTROL LISTS                                                         #
#                                                                              #
################################################################################

acl proxy src 172.25.100.4
follow_x_forwarded_for allow proxy
acl_uses_indirect_client on
delay_pool_uses_indirect_client on
log_uses_indirect_client on
adaptation_uses_indirect_client on
tproxy_uses_indirect_client on

################################################################################
#                                                                              #
# C-ICAP INTEGRATION                                                           #
#                                                                              #
################################################################################

icap_enable on
icap_send_client_ip on
icap_send_client_username on
icap_client_username_header X-Authenticated-User
icap_service service_req reqmod_precache bypass=1 icap://127.0.0.1:1344/squidclamav
adaptation_access service_req allow all
icap_service service_resp respmod_precache bypass=1 icap://127.0.0.1:1344/squidclamav
adaptation_access service_resp allow all

################################################################################
#                                                                              #
# Custom ACLs                                                                  #
#                                                                              #
################################################################################

# Local Networks
#acl localnet src 10.0.0.0/8		# RFC1918 possible internal network
#acl localnet src 172.16.0.0/12		# RFC1918 possible internal network
#acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
#acl localnet src fc00::/7		# RFC 4193 local private network range
#acl localnet src fe80::/10		# RFC 4291 link-local (directly plugged) machines

# Localhost
#acl localhost src 127.0.0.1

# Admin PC
acl adminPC src "/etc/squid/rules/adminPC"
acl ipBaneadas src "/etc/squid/rules/ipBaneadas"

# Limit URLs

# Delays Free
acl delaysFree dstdomain "/etc/squid/rules/delaysFree"

# Ports with access
acl SSL_ports port 443
acl SSL_ports port 21
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http

# SSL method access
acl CONNECT method CONNECT

# Cuba domains access from specified PC
acl cubaDomains dstdomain .cu
acl cubaPC src "/etc/squid/rules/cubaPC"

# Groups LDAPs
acl internet external ldapgroup internet
acl national external ldapgroup national
acl moderadoresSocNet external ldapgroup moderadoresSocNet
acl socialNetwork external ldapgroup socialNetwork socialTime
acl youtuber external ldapgroup youtuber socialTime

#acl una_ip max_user_ip -s 1
acl users proxy_auth REQUIRED
acl SQUISHLOC dst proxy.conalza.co.cu
acl SQUISHED1 proxy_auth "/etc/squid/squished"

# WorkTime
acl workTime time MTWHF 7:30-17:00
acl socialTime time MTWHF 11:00-13:00
acl socialTime time MTWHF 16:00-23:30
acl socialTime time AS 07:00-22:00

# Extensions

acl extDenied url_regex -i "/etc/squid/rules/extDenied"
acl extDownloads url_regex -i "/etc/squid/rules/extDownloads"
acl extDocuments url_regex -i "/etc/squid/rules/extDocuments"

# Social Domains
acl socialDomains dstdomain -i "/etc/squid/rules/socialDomains"

# Youtube Domains
acl youtubeDomains dstdomain "/etc/squid/rules/youtubeDomains"

# Media Streams
## MediaPlayer MMS Protocol
acl media rep_mime_type mms
acl mediapr url_regex dvrplayer mediastream ^mms://
## (Squid does not yet handle the URI as a known proto type.)
## Active Stream Format (Windows Media Player)
acl media rep_mime_type x-ms-asf
#acl mediapr urlpath_regex \.(afx|asf)(\?.*)?$
## Flash Video Format
acl media rep_mime_type video/flv video/x-flv
#acl mediapr urlpath_regex \.flv(\?.*)?$
## Flash General Media Scripts (Animation)
acl media rep_mime_type application/x-shockwave-flash
#acl mediapr urlpath_regex \.swf(\?.*)?$
## Others currently unknown
acl media rep_mime_type ms-hdr
acl media rep_mime_type x-fcs
http_access deny mediapr
http_reply_access deny media

################################################################################
#                                                                              #
# ACCESS PERMISSION CONTROL                                                    #
#                                                                              #
################################################################################

# Allow Localhost
#http_access allow localhost

# Deny unsafe ports
http_access deny !Safe_ports

#Denegando mas de una ip por usuario
#http_access deny una_ip

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Deny extensions
http_access deny extDenied

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access allow adminPC manager
http_access deny manager

#deny_info http://proxy.conalza.co.cu/index.php& SQUISHED1

#http_access deny ipBaneadas
http_access allow delaysFree
http_access allow cubaDomains cubaPC
http_access allow cubaDomains national
http_access allow cubaDomains internet
http_access deny SQUISHED1
http_access allow socialDomains moderadoresSocNet
http_access allow socialTime socialDomains socialNetwork
http_access allow socialTime youtubeDomains youtuber
http_access deny socialDomains
http_access deny youtubeDomains
http_access allow internet

# And finally deny all other access to this proxy
http_access deny all

################################################################################
#                                                                              #
# REWRITE RULES                                                                #
#                                                                              #
################################################################################

#url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
#url_rewrite_children 10

################################################################################
#                                                                              #
# DELAYS POOL SPEED CONFIG                                                     #
#                                                                              #
################################################################################

delay_initial_bucket_level 80

delay_pools 6

delay_class 1 1
delay_class 2 2
delay_class 3 2
delay_class 4 1
delay_class 5 1
delay_class 6 1

# unLimit Delay
delay_parameters 1 -1/-1

#50 KB/s all, 15 KB/s one
delay_parameters 2 50000/512000 15000/30000

#50 KB/s all, 40 KB/s individual
delay_parameters 3 512000/102400 40000/256000

#15 KB/s > 50 KB
delay_parameters 4 15000/50000

#10 KB/s shared
delay_parameters 5 10000/128000

#6 KB/s shared
delay_parameters 6 6000/128000

# unLimit delay
delay_access 1 allow delaysFree
delay_access 1 deny all

# Auth users in workTime
delay_access 2 allow users workTime !extDownloads !extDocuments !delaysFree
delay_access 2 deny all

# Auth users out workTime
delay_access 3 allow users !workTime !delaysFree
delay_access 3 deny all

# Auth users in Social Networks
#delay_access 4 allow socialNetworks !delaysFree
delay_access 4 deny all

# Documents files in workTime
delay_access 5 allow workTime extDocuments
delay_access 5 deny all

# Downloads files in workTime
delay_access 6 allow workTime extDownloads
delay_access 6 deny all


# 3 MB downloads and documents files in workTime
reply_body_max_size 3 MB workTime extDownloads !adminPC
reply_body_max_size 3 MB workTime extDocuments !adminPC

################################################################################
#                                                                              #
# LOGFILE PATHNAMES AND CACHE DIRECTORIES                                      #
#                                                                              #
################################################################################

#debug_options ALL,1 33,2 28,9
cache_mem 2048 MB
cache_dir ufs /var/spool/squid 20000 16 256
maximum_object_size 4096 KB
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log squid
cache_store_log none
coredump_dir /var/spool/squid

################################################################################
#                                                                              #
# REFRESH PATTERNS                                                             #
#                                                                              #
################################################################################

# Sites with 1 day refresch pattern
refresh_pattern ^http:\/\/granma.co.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/www.juventudrebelde.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/trabajadores.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/www.periodico26.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/www.cubadebate.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/www.prensalatina.cu*\/ 1440 40% 10080 reload-into-ims ignore-reload override-expire

# Sites with 1 month refresh pattern
refresh_pattern ^http:\/\/*.google.*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/www.ecured.cu*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/*.googleapis.com*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/*.alldatasheet.com*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/*.wikipedia.org*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire
refresh_pattern ^http:\/\/*.datasheetcatalog.com*\/ 20160 80% 40320 reload-into-ims ignore-reload override-expire

# Others refresh patterns
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
refresh_pattern .		0	20%	4320
