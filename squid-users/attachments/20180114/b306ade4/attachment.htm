<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;After&nbsp;migrating&nbsp;squid&nbsp;from&nbsp;non-SMP/aufs&nbsp;to&nbsp;SMP/rock&nbsp;memory&nbsp;cache&nbsp;hit&nbsp;ratio&nbsp;dropped&nbsp;significantly.&nbsp;Like&nbsp;from&nbsp;50-100%&nbsp;to&nbsp;1-5%.&nbsp;And&nbsp;disk&nbsp;cache&nbsp;hit&nbsp;ratio&nbsp;went&nbsp;up&nbsp;from&nbsp;15-50%&nbsp;to&nbsp;stable&nbsp;60-65%.&nbsp;From&nbsp;the&nbsp;brief&nbsp;log&nbsp;file&nbsp;check&nbsp;it&nbsp;looks&nbsp;like&nbsp;in&nbsp;SMP/rock&nbsp;mode&nbsp;squid&nbsp;avoids&nbsp;using&nbsp;memory&nbsp;for&nbsp;small&nbsp;files&nbsp;like&nbsp;1-3KB&nbsp;but&nbsp;uses&nbsp;it&nbsp;for&nbsp;10KB+&nbsp;files.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;started&nbsp;tracking&nbsp;down&nbsp;the&nbsp;issue&nbsp;with&nbsp;disabling&nbsp;disk&nbsp;cache&nbsp;completely&nbsp;and&nbsp;it&nbsp;didn&#39;t&nbsp;change&nbsp;anything,&nbsp;I&nbsp;just&nbsp;started&nbsp;to&nbsp;get&nbsp;MISS&nbsp;every&nbsp;time&nbsp;for&nbsp;the&nbsp;URL&nbsp;which&nbsp;was&nbsp;getting&nbsp;MEM_HIT&nbsp;with&nbsp;an&nbsp;old&nbsp;configuration.&nbsp;Then&nbsp;I&nbsp;changed&nbsp;&quot;workers&nbsp;2&quot;&nbsp;to&nbsp;&quot;workers&nbsp;1&quot;&nbsp;and&nbsp;started&nbsp;getting&nbsp;memory&nbsp;hits&nbsp;as&nbsp;before.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;it&nbsp;seems&nbsp;like&nbsp;the&nbsp;issue&nbsp;is&nbsp;with&nbsp;shared&nbsp;memory:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;squid&nbsp;doesn&#39;t&nbsp;use&nbsp;shared&nbsp;memory&nbsp;it&nbsp;works&nbsp;as&nbsp;expected.&nbsp;Even&nbsp;with&nbsp;multiple&nbsp;workers.&lt;/div&gt;&lt;div&gt;When&nbsp;squid&nbsp;uses&nbsp;shared&nbsp;memory&nbsp;it&nbsp;caches&nbsp;very&nbsp;small&nbsp;amount&nbsp;of&nbsp;objects.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Am&nbsp;I&nbsp;doing&nbsp;anything&nbsp;wrong?&nbsp;Which&nbsp;debug&nbsp;options&nbsp;should&nbsp;I&nbsp;enable&nbsp;to&nbsp;provide&nbsp;more&nbsp;information&nbsp;if&nbsp;it&nbsp;seems&nbsp;like&nbsp;a&nbsp;bug?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Config&nbsp;diff:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&nbsp;squid.conf.old &nbsp;2018-01-14&nbsp;02:01:19.000000000&nbsp;-0800&lt;/div&gt;&lt;div&gt;+++&nbsp;squid.conf.new &nbsp;2018-01-14&nbsp;02:01:16.000000000&nbsp;-0800&lt;/div&gt;&lt;div&gt;@@&nbsp;-1,5&nbsp;+1,8&nbsp;@@&lt;/div&gt;&lt;div&gt; http_port&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:3128&quot;&gt;0.0.0.0:3128&lt;/a&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;+workers&nbsp;2&lt;/div&gt;&lt;div&gt;+cpu_affinity_map&nbsp;process_numbers=1,2&nbsp;cores=1,2&lt;/div&gt;&lt;div&gt;+&lt;/div&gt;&lt;div&gt; acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt; &nbsp; &nbsp; #&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt; acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt; &nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt; acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;#&nbsp;RFC1918&nbsp;possible&nbsp;internal&nbsp;network&lt;/div&gt;&lt;div&gt;@@&nbsp;-94,13&nbsp;+97,12&nbsp;@@&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt; never_direct&nbsp;allow&nbsp;all&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;-cache_mem&nbsp;9420328&nbsp;KB&lt;/div&gt;&lt;div&gt;-maximum_object_size_in_memory&nbsp;32&nbsp;KB&lt;/div&gt;&lt;div&gt;+cache_mem&nbsp;12560438&nbsp;KB&lt;/div&gt;&lt;div&gt;+maximum_object_size_in_memory&nbsp;64&nbsp;KB&lt;/div&gt;&lt;div&gt; memory_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt; cache_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;-cache_dir&nbsp;aufs&nbsp;/mnt/services/squid/cache/cache0&nbsp;261120&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;-cache_dir&nbsp;aufs&nbsp;/mnt/services/squid/cache/cache1&nbsp;261120&nbsp;16&nbsp;256&lt;/div&gt;&lt;div&gt;+cache_dir&nbsp;rock&nbsp;/mnt/services/squid/cache&nbsp;522240&nbsp;swap-timeout=500&nbsp;max-swap-rate=1200&nbsp;slot-size=16384&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt; minimum_object_size&nbsp;64&nbsp;bytes&nbsp;#&nbsp;none-zero&nbsp;so&nbsp;we&nbsp;dont&nbsp;cache&nbsp;mistakes&lt;/div&gt;&lt;div&gt; maximum_object_size&nbsp;102400&nbsp;KB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;relevant&nbsp;config&nbsp;options&nbsp;together&nbsp;(SMP/rock):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;workers&nbsp;2&lt;/div&gt;&lt;div&gt;cpu_affinity_map&nbsp;process_numbers=1,2&nbsp;cores=1,2&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_mem&nbsp;12560438&nbsp;KB&lt;/div&gt;&lt;div&gt;maximum_object_size_in_memory&nbsp;64&nbsp;KB&lt;/div&gt;&lt;div&gt;memory_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt;cache_replacement_policy&nbsp;heap&nbsp;LRU&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cache_dir&nbsp;rock&nbsp;/mnt/services/squid/cache&nbsp;522240&nbsp;swap-timeout=500&nbsp;max-swap-rate=1200&nbsp;slot-size=16384&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;minimum_object_size&nbsp;64&nbsp;bytes&nbsp;#&nbsp;none-zero&nbsp;so&nbsp;we&nbsp;dont&nbsp;cache&nbsp;mistakes&lt;/div&gt;&lt;div&gt;maximum_object_size&nbsp;102400&nbsp;KB&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;negative_ttl&nbsp;0&nbsp;seconds&lt;/div&gt;&lt;div&gt;range_offset_limit&nbsp;none&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Squid&nbsp;version:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;3.5.27&lt;/div&gt;&lt;div&gt;Service&nbsp;Name:&nbsp;squid&lt;/div&gt;&lt;div&gt;configure&nbsp;options: &nbsp;&#39;--program-prefix=&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--exec-prefix=/usr&#39;&nbsp;&#39;--bindir=/usr/sbin&#39;&nbsp;&#39;--sbindir=/usr/sbin&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--libdir=/usr/lib&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--includedir=/usr/include&#39;&nbsp;&#39;--datadir=/usr/share&#39;&nbsp;&#39;--sharedstatedir=/usr/com&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--infodir=/usr/share/info&#39;&nbsp;&#39;--enable-epoll&#39;&nbsp;&#39;--enable-removal-policies=heap,lru&#39;&nbsp;&#39;--enable-storeio=aufs,rock&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--with-pthreads&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-maxfd=16384&#39;&nbsp;&#39;--enable-htcp&#39;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
