<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;My&nbsp;disks&nbsp;are&nbsp;fast&nbsp;(SSD)&nbsp;so&nbsp;I&nbsp;didn&#39;t&nbsp;see&nbsp;performance&nbsp;issues&nbsp;but&nbsp;it&nbsp;doesn&#39;t&nbsp;change&nbsp;the&nbsp;fact&nbsp;that&nbsp;memory&nbsp;hit&nbsp;ratio&nbsp;decreased&nbsp;in&nbsp;more&nbsp;than&nbsp;10&nbsp;times.&nbsp;And&nbsp;with&nbsp;both&nbsp;rock&nbsp;and&nbsp;shared&nbsp;memory&nbsp;cache&nbsp;enabled&nbsp;most&nbsp;of&nbsp;the&nbsp;files&nbsp;were&nbsp;saved&nbsp;into&nbsp;disk&nbsp;cache&nbsp;and&nbsp;not&nbsp;into&nbsp;memory&nbsp;cache&nbsp;and&nbsp;most&nbsp;of&nbsp;the&nbsp;hits&nbsp;were&nbsp;disk&nbsp;hits&nbsp;(according&nbsp;to&nbsp;log&nbsp;file).&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;already&nbsp;tried&nbsp;squid&nbsp;4&nbsp;and&nbsp;it&nbsp;works&nbsp;as&nbsp;expected.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So.&nbsp;Let&#39;s&nbsp;forget&nbsp;about&nbsp;rock&nbsp;because&nbsp;the&nbsp;issue&nbsp;I&nbsp;see&nbsp;is&nbsp;related&nbsp;to&nbsp;shared&nbsp;memory.&nbsp;For&nbsp;my&nbsp;test&nbsp;file&nbsp;with&nbsp;only&nbsp;memory&nbsp;cache&nbsp;enabled:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid&nbsp;3.5.27&nbsp;non-SMP&nbsp;-&nbsp;MISS&nbsp;first&nbsp;then&nbsp;always&nbsp;MEM_HIT&lt;/div&gt;&lt;div&gt;squid&nbsp;3.5.27&nbsp;SMP&nbsp;any&nbsp;amount&nbsp;of&nbsp;workers&nbsp;shared&nbsp;memory&nbsp;off&nbsp;-&nbsp;always&nbsp;MEM_HIT&nbsp;after&nbsp;all&nbsp;workers&nbsp;handled&nbsp;the&nbsp;request&nbsp;once&lt;/div&gt;&lt;div&gt;squid&nbsp;3.5.27Â SMP&nbsp;any&nbsp;amount&nbsp;of&nbsp;workers&nbsp;shared&nbsp;memory&nbsp;on&nbsp;-&nbsp;MISS&nbsp;every&nbsp;time.&lt;/div&gt;&lt;div&gt;squid&nbsp;4.0.22&nbsp;SMP&nbsp;2&nbsp;workers&nbsp;shared&nbsp;memory&nbsp;on&nbsp;-&nbsp;MISS&nbsp;first&nbsp;then&nbsp;always&nbsp;MEM_HIT&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;I&nbsp;would&nbsp;like&nbsp;to&nbsp;use&nbsp;squid&nbsp;4&nbsp;in&nbsp;production&nbsp;and&nbsp;I&nbsp;probably&nbsp;will&nbsp;since&nbsp;looks&nbsp;like&nbsp;SMP/shared_cache&nbsp;is&nbsp;broken&nbsp;in&nbsp;3,&nbsp;but&nbsp;the&nbsp;fact&nbsp;that&nbsp;you&nbsp;still&nbsp;haven&#39;t&nbsp;released&nbsp;it&nbsp;confuses&nbsp;me.&nbsp;IDK&nbsp;why&nbsp;it&#39;s&nbsp;still&nbsp;in&nbsp;beta/rc/whatever&nbsp;stage.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Jan&nbsp;15,&nbsp;2018&nbsp;at&nbsp;7:22&nbsp;AM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;On&nbsp;15/01/18&nbsp;18:53,&nbsp;Ivan&nbsp;Larionov&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
Hello!&lt;br&gt;<br>
&lt;br&gt;<br>
After&nbsp;migrating&nbsp;squid&nbsp;from&nbsp;non-SMP/aufs&nbsp;to&nbsp;SMP/rock&nbsp;memory&nbsp;cache&nbsp;hit&nbsp;ratio&nbsp;dropped&nbsp;significantly.&nbsp;Like&nbsp;from&nbsp;50-100%&nbsp;to&nbsp;1-5%.&nbsp;And&nbsp;disk&nbsp;cache&nbsp;hit&nbsp;ratio&nbsp;went&nbsp;up&nbsp;from&nbsp;15-50%&nbsp;to&nbsp;stable&nbsp;60-65%.&nbsp;From&nbsp;the&nbsp;brief&nbsp;log&nbsp;file&nbsp;check&nbsp;it&nbsp;looks&nbsp;like&nbsp;in&nbsp;SMP/rock&nbsp;mode&nbsp;squid&nbsp;avoids&nbsp;using&nbsp;memory&nbsp;for&nbsp;small&nbsp;files&nbsp;like&nbsp;1-3KB&nbsp;but&nbsp;uses&nbsp;it&nbsp;for&nbsp;10KB+&nbsp;files.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
AIUI,&nbsp;SMP-mode&nbsp;rock&nbsp;operates&nbsp;as&nbsp;a&nbsp;fully&nbsp;separate&nbsp;process&nbsp;(a&nbsp;&quot;Disker&quot;&nbsp;kid)&nbsp;which&nbsp;delivers&nbsp;its&nbsp;results&nbsp;as&nbsp;objects&nbsp;already&nbsp;in&nbsp;shared&nbsp;memory&nbsp;to&nbsp;the&nbsp;worker&nbsp;process.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;should&nbsp;be&nbsp;little&nbsp;or&nbsp;no&nbsp;gain&nbsp;from&nbsp;that&nbsp;promotion&nbsp;process&nbsp;anymore&nbsp;-&nbsp;which&nbsp;would&nbsp;only&nbsp;be&nbsp;moving&nbsp;the&nbsp;object&nbsp;between&nbsp;memory&nbsp;locations.&nbsp;In&nbsp;fact&nbsp;if&nbsp;cache_mem&nbsp;were&nbsp;not&nbsp;operating&nbsp;as&nbsp;shared&nbsp;memory&nbsp;even&nbsp;with&nbsp;SMP&nbsp;active&nbsp;(which&nbsp;is&nbsp;possible)&nbsp;the&nbsp;promotion&nbsp;would&nbsp;be&nbsp;an&nbsp;actively&nbsp;bad&nbsp;idea&nbsp;as&nbsp;it&nbsp;prevents&nbsp;other&nbsp;workers&nbsp;using&nbsp;the&nbsp;object&nbsp;in&nbsp;future.&lt;br&gt;<br>
&lt;br&gt;<br>
They&nbsp;show&nbsp;up&nbsp;as&nbsp;non-&nbsp;MEM_HIT&nbsp;because&nbsp;they&nbsp;are&nbsp;either&nbsp;REFRESH&nbsp;or&nbsp;stored&nbsp;in&nbsp;the&nbsp;Disker&nbsp;shared&nbsp;memory&nbsp;instead&nbsp;of&nbsp;the&nbsp;cache_mem&nbsp;shared&nbsp;memory.&nbsp;The&nbsp;Squid&nbsp;logging&nbsp;is&nbsp;not&nbsp;quite&nbsp;up&nbsp;to&nbsp;recording&nbsp;the&nbsp;slim&nbsp;distinction&nbsp;between&nbsp;which&nbsp;of&nbsp;multiple&nbsp;memory&nbsp;areas&nbsp;are&nbsp;being&nbsp;used.&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
I&nbsp;started&nbsp;tracking&nbsp;down&nbsp;the&nbsp;issue&nbsp;with&nbsp;disabling&nbsp;disk&nbsp;cache&nbsp;completely&nbsp;and&nbsp;it&nbsp;didn&#39;t&nbsp;change&nbsp;anything,&nbsp;I&nbsp;just&nbsp;started&nbsp;to&nbsp;get&nbsp;MISS&nbsp;every&nbsp;time&nbsp;for&nbsp;the&nbsp;URL&nbsp;which&nbsp;was&nbsp;getting&nbsp;MEM_HIT&nbsp;with&nbsp;an&nbsp;old&nbsp;configuration.&nbsp;Then&nbsp;I&nbsp;changed&nbsp;&quot;workers&nbsp;2&quot;&nbsp;to&nbsp;&quot;workers&nbsp;1&quot;&nbsp;and&nbsp;started&nbsp;getting&nbsp;memory&nbsp;hits&nbsp;as&nbsp;before.&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;it&nbsp;seems&nbsp;like&nbsp;the&nbsp;issue&nbsp;is&nbsp;with&nbsp;shared&nbsp;memory:&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;squid&nbsp;doesn&#39;t&nbsp;use&nbsp;shared&nbsp;memory&nbsp;it&nbsp;works&nbsp;as&nbsp;expected.&nbsp;Even&nbsp;with&nbsp;multiple&nbsp;workers.&lt;br&gt;<br>
When&nbsp;squid&nbsp;uses&nbsp;shared&nbsp;memory&nbsp;it&nbsp;caches&nbsp;very&nbsp;small&nbsp;amount&nbsp;of&nbsp;objects.&lt;br&gt;<br>
&lt;br&gt;<br>
Am&nbsp;I&nbsp;doing&nbsp;anything&nbsp;wrong?&nbsp;Which&nbsp;debug&nbsp;options&nbsp;should&nbsp;I&nbsp;enable&nbsp;to&nbsp;provide&nbsp;more&nbsp;information&nbsp;if&nbsp;it&nbsp;seems&nbsp;like&nbsp;a&nbsp;bug?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
Are&nbsp;you&nbsp;seeing&nbsp;an&nbsp;actual&nbsp;performance&nbsp;difference?&nbsp;if&nbsp;not&nbsp;I&nbsp;would&nbsp;not&nbsp;worry&nbsp;about&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
FYI:&nbsp;if&nbsp;you&nbsp;really&nbsp;want&nbsp;to&nbsp;track&nbsp;this&nbsp;down&nbsp;I&nbsp;suggest&nbsp;using&nbsp;Squid-4&nbsp;to&nbsp;do&nbsp;that.&nbsp;Squid-3&nbsp;is&nbsp;very&nbsp;near&nbsp;the&nbsp;end&nbsp;of&nbsp;its&nbsp;support&nbsp;lifetime&nbsp;and&nbsp;changes&nbsp;of&nbsp;a&nbsp;deep&nbsp;nature&nbsp;do&nbsp;not&nbsp;have&nbsp;much&nbsp;chance&nbsp;at&nbsp;all&nbsp;of&nbsp;getting&nbsp;in&nbsp;there&nbsp;now.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/l&lt;wbr&gt;istinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
