<tt>
Hello,&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;want&nbsp;to&nbsp;configure&nbsp;SQUID&nbsp;with&nbsp;two&nbsp;authentications&nbsp;methods:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Kerberos&nbsp;(to&nbsp;do&nbsp;SSO&nbsp;with&nbsp;posts&nbsp;in&nbsp;an&nbsp;ActiveDirectory&nbsp;domain)&lt;/div&gt;&lt;div&gt;-&nbsp;Basic&nbsp;(Open&nbsp;LDAP&nbsp;directory)&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;LDAP&nbsp;directory&nbsp;contains&nbsp;all&nbsp;the&nbsp;&quot;official&quot;&nbsp;accounts&nbsp;of&nbsp;people,&nbsp;the&nbsp;AD&nbsp;directory&nbsp;contains&nbsp;some&nbsp;accounts&nbsp;(same&nbsp;identifiers&nbsp;as&nbsp;on&nbsp;LDAP)&nbsp;and&nbsp;generic&nbsp;accounts.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;Everything&nbsp;works&nbsp;fine,&nbsp;but&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;add&nbsp;an&nbsp;extra&nbsp;check:&nbsp;The&nbsp;Kerberos&nbsp;account&nbsp;must&nbsp;also&nbsp;exist&nbsp;in&nbsp;the&nbsp;LDAP&nbsp;directory&nbsp;in&nbsp;order&nbsp;to&nbsp;not&nbsp;allow&nbsp;use&nbsp;of&nbsp;generic&nbsp;accounts.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;managed&nbsp;to&nbsp;do&nbsp;that&nbsp;with&nbsp;Squid&nbsp;but&nbsp;I&nbsp;get&nbsp;this&nbsp;behavior:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Account&nbsp;present&nbsp;in&nbsp;AD&nbsp;+&nbsp;LDAP:&nbsp;OK&lt;/div&gt;&lt;div&gt;-&nbsp;Account&nbsp;present&nbsp;in&nbsp;AD&nbsp;but&nbsp;not&nbsp;in&nbsp;LDAP:&nbsp;KO&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;force&nbsp;LDAP&nbsp;authentication&nbsp;if&nbsp;&quot;check_ldap &quot;&nbsp;fail&nbsp;?&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;&lt;br&nbsp;/&gt;&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;My&nbsp;config&nbsp;:&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;#&nbsp;KERBEROS&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;negotiate&nbsp;program&nbsp;/usr/lib/squid/negotiate_kerberos_auth&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;negotiate&nbsp;children&nbsp;50 &nbsp;startup=5&nbsp;idle=1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;negotiate&nbsp;keep_alive&nbsp;on&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;#&nbsp;LDAP&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;basic&nbsp;program&nbsp;/usr/lib/squid/basic_ldap_auth&nbsp;-v&nbsp;3&nbsp;-b&nbsp;&quot;ou=official&quot;&nbsp;-f&nbsp;&quot;(uid=%s)&quot;&nbsp;ldap.contonso.lan:389&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;basic&nbsp;children&nbsp;50&nbsp;startup=5&nbsp;idle=1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;auth_param&nbsp;basic&nbsp;credentialsttl&nbsp;1&nbsp;hours&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;#&nbsp;Extra&nbsp;check&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;external_acl_type&nbsp;check_ldap&nbsp;ipv4&nbsp;ttl=3600&nbsp;children-max=50&nbsp;%LOGIN&nbsp;/etc/squid/check_ldap_aca.sh&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;acl&nbsp;authenticated&nbsp;proxy_auth&nbsp;REQUIRED&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;acl&nbsp;check_ldap&nbsp;external&nbsp;check_ldap&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;http_access&nbsp;allow&nbsp;http&nbsp;port_80&nbsp;check_ldap&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;http_access&nbsp;allow&nbsp;https&nbsp;port_443&nbsp;check_ldap&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;http_access&nbsp;allow&nbsp;ftp&nbsp;port_21&nbsp;check_ldap&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;http_access&nbsp;deny&nbsp;!authenticated&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&quot;&gt;http_access&nbsp;deny&nbsp;all&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;&lt;br&nbsp;/&gt;&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;My&nbsp;check_ldap_aca.sh&nbsp;:&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;#!/bin/bash&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt;while&nbsp;read&nbsp;user&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;do&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;identifiant=(${user//@/&nbsp;})&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;&lt;br&nbsp;/&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;result=$(ldapsearch&nbsp;-LLL&nbsp;-h &lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Courier;&quot;&gt;ldap.contonso.lan&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt; -p&nbsp;389&nbsp;-D&nbsp;&quot;uid=usr-proxy&quot;&nbsp;-w&nbsp;***** &lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt;-b&nbsp;&quot;ou=&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Courier;&quot;&gt;official&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt;&quot;&nbsp;&quot;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Courier;&quot;&gt;(uid=%s)&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;&quot;Courier&nbsp;New&quot;;&quot;&gt;&quot;&nbsp;uid)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;[&nbsp;${#result}&nbsp;-gt&nbsp;4&nbsp;]&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;then&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo&nbsp;&quot;OK&nbsp;user=$identifiant&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;else&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo&nbsp;&quot;ERR&nbsp;user=$identifiant&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;fi&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Courier&nbsp;New&quot;&gt;done&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;!&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Chris&lt;/div&gt;&lt;/div&gt;<br>

</tt>
