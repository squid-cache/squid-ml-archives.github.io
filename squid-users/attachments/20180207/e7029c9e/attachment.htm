<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;Dear&nbsp;all,&nbsp;i&nbsp;use&nbsp;squid&nbsp;3.5.20&nbsp;on&nbsp;ubuntu14&nbsp;in&nbsp;TPROXY&nbsp;mode.&lt;br&gt;&lt;/div&gt;With&nbsp;basic&nbsp;config&nbsp;in&nbsp;squid.conf,&nbsp;but&nbsp;squid&nbsp;is&nbsp;run&nbsp;out&nbsp;of&nbsp;my&nbsp;server&#39;s&nbsp;memory.&lt;br&gt;&lt;/div&gt;Here&nbsp;is&nbsp;my&nbsp;configure&nbsp;option&nbsp;:&lt;br&gt;&lt;br&gt;&#39;--prefix=/usr&#39;&nbsp;&#39;--includedir=/usr/include&#39;&nbsp;&#39;--infodir=/usr/share/info&#39;&nbsp;&#39;--sysconfdir=/etc&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--srcdir=.&#39;&nbsp;&#39;--datadir=/usr/share/squid&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--enable-inline&#39;&nbsp;&#39;--enable-async-io=24&#39;&nbsp;&#39;--enable-storeio=ufs,aufs,diskd,rock&#39;&nbsp;&#39;--enable-removal-policies=lru,heap&#39;&nbsp;&#39;--enable-gnuregex&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-underscores&#39;&nbsp;&#39;--enable-icap-client&#39;&nbsp;&#39;--enable-follow-x-forwarded-for&#39;&nbsp;&#39;--enable-eui&#39;&nbsp;&#39;--enable-esi&#39;&nbsp;&#39;--enable-icmp&#39;&nbsp;&#39;--enable-zph-qos&#39;&nbsp;&#39;--enable-http-violations&#39;&nbsp;&#39;--enable-ssl-crtd&#39;&nbsp;&#39;--enable-linux-netfilter&#39;&nbsp;&#39;--enable-ltdl-install&#39;&nbsp;&#39;--enable-ltdl-convenience&#39;&nbsp;&#39;--enable-x-accelerator-vary&#39;&nbsp;&#39;--disable-maintainer-mode&#39;&nbsp;&#39;--disable-dependency-tracking&#39;&nbsp;&#39;--disable-silent-rules&#39;&nbsp;&#39;--disable-translation&#39;&nbsp;&#39;--disable-ipv6&#39;&nbsp;&#39;--disable-ident-lookups&#39;&nbsp;&#39;--with-swapdir=/var/spool/squid&#39;&nbsp;&#39;--with-logdir=/var/log/squid&#39;&nbsp;&#39;--with-pidfile=/var/run/squid.pid&#39;&nbsp;&#39;--with-aufs-threads=24&#39;&nbsp;&#39;--with-filedescriptors=65536&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-maxfd=65536&#39;&nbsp;&#39;--with-openssl&#39;&nbsp;&#39;--with-default-user=proxy&#39;&nbsp;&#39;--with-included-ltdl&#39;&lt;br&gt;--------------------------------------&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;And&nbsp;i&nbsp;apply&nbsp;this&nbsp;patch&nbsp;before&nbsp;compile&nbsp;for&nbsp;disabling&nbsp;host&nbsp;forgery&nbsp;checks&nbsp;:&lt;br&gt;&lt;br&gt;+diff&nbsp;-ur&nbsp;squid-3.5.20-orig/src/client_side_request.cc&nbsp;squid-3.5.20/src/client_side_request.cc&lt;br&gt;+---&nbsp;squid-3.5.20-orig/src/client_side_request.cc   &nbsp;2016-07-01&nbsp;13:37:50.000000000&nbsp;+0200&lt;br&gt;++++&nbsp;squid-3.5.20/src/client_side_request.cc   &nbsp;2017-03-10&nbsp;16:48:08.920084072&nbsp;+0100&lt;br&gt;+@@&nbsp;-530,6&nbsp;+530,10&nbsp;@@&lt;br&gt;+            &nbsp;}&lt;br&gt;+            &nbsp;debugs(85,&nbsp;3,&nbsp;HERE&nbsp;&lt;&lt;&nbsp;&quot;validate&nbsp;IP&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;clientConn-&gt;local&nbsp;&lt;&lt;&nbsp;&quot;&nbsp;non-match&nbsp;from&nbsp;Host:&nbsp;IP&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;ia-&gt;in_addrs[i]);&lt;br&gt;+        &nbsp;}&lt;br&gt;++   &nbsp;//&nbsp;disable&nbsp;fogery&nbsp;check.&nbsp;See&nbsp;&lt;a&nbsp;href=&quot;https://code.nethesis.it/Nethesis/dev/issues/5088&quot;&gt;https://code.nethesis.it/Nethesis/dev/issues/5088&lt;/a&gt;&lt;br&gt;++       &nbsp;http-&gt;request-&gt;flags.hostVerified&nbsp;=&nbsp;true;&lt;br&gt;++       &nbsp;http-&gt;doCallouts();&lt;br&gt;++       &nbsp;return;&lt;br&gt;+    &nbsp;}&lt;br&gt;+    &nbsp;debugs(85,&nbsp;3,&nbsp;HERE&nbsp;&lt;&lt;&nbsp;&quot;FAIL:&nbsp;validate&nbsp;IP&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;clientConn-&gt;local&nbsp;&lt;&lt;&nbsp;&quot;&nbsp;possible&nbsp;from&nbsp;Host:&quot;);&lt;br&gt;+    &nbsp;hostHeaderVerifyFailed(&quot;local&nbsp;IP&quot;,&nbsp;&quot;any&nbsp;domain&nbsp;IP&quot;);&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;here&nbsp;is&nbsp;my&nbsp;squid.conf&nbsp;(&nbsp;i&nbsp;don&#39;t&nbsp;post&nbsp;my&nbsp;http_access&nbsp;for&nbsp;clearly&nbsp;view&nbsp;:()&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;#&nbsp;Squid&nbsp;normally&nbsp;listens&nbsp;to&nbsp;port&nbsp;3128&lt;br&gt;###############################################################################&lt;br&gt;&lt;br&gt;https_port&nbsp;3130&nbsp;tproxy&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&nbsp;cert=/etc/squid/ssl/e1f19c0494badc8dc14e8c4c56a8b97a.dyn&lt;br&gt;http_port&nbsp;3129&nbsp;tproxy&lt;br&gt;http_port&nbsp;3128&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;#&nbsp;squid&nbsp;ssl_bump&nbsp;option&lt;br&gt;###############################################################################&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;block&nbsp;ssl::server_name&nbsp;&quot;/etc/squid/block_domain.txt&quot;&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;terminate&nbsp;block&lt;br&gt;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;sslproxy_options&nbsp;NO_SSLv2,NO_SSLv3,No_Compression&lt;br&gt;sslproxy_cipher &nbsp;ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL&lt;br&gt;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;sslproxy_foreign_intermediate_certs&nbsp;/etc/squid/intermediate_ca.pem&lt;br&gt;&lt;br&gt;sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;sslcrtd_children&nbsp;8&nbsp;startup=1&nbsp;idle=1&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;##&nbsp;LOGFILE&nbsp;OPTIONS&lt;br&gt;###############################################################################&lt;br&gt;&lt;br&gt;mime_table&nbsp;/etc/squid/mime.conf&lt;br&gt;pid_filename&nbsp;/var/run/squid.pid&lt;br&gt;&lt;br&gt;include&nbsp;/etc/squid/logging.conf&lt;br&gt;###############################################################################&lt;br&gt;##&nbsp;OPTIONS&nbsp;FOR&nbsp;TROUBLESHOOTING&lt;br&gt;###############################################################################&lt;br&gt;&lt;br&gt;coredump_dir&nbsp;/var/spool/squid&lt;br&gt;debug_options&nbsp;ALL,1&lt;br&gt;cache_effective_user&nbsp;squid&lt;br&gt;cache_effective_group&nbsp;squid&lt;br&gt;###############################################################################&lt;br&gt;##&nbsp;PERSISTENT&nbsp;CONNECTION&nbsp;HANDLING&lt;br&gt;###############################################################################&lt;br&gt; &lt;br&gt;detect_broken_pconn&nbsp;off&lt;br&gt;client_persistent_connections&nbsp;off&lt;br&gt;server_persistent_connections&nbsp;on&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;##&nbsp;ERROR&nbsp;PAGE&nbsp;OPTIONS&lt;br&gt;###############################################################################&lt;br&gt;error_directory&nbsp;/usr/share/squid/errors/en&lt;br&gt;error_log_languages&nbsp;off&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;##&nbsp;DNS&nbsp;OPTIONS&lt;br&gt;###############################################################################&lt;br&gt;check_hostnames&nbsp;off&lt;br&gt;hosts_file&nbsp;/etc/hosts&lt;br&gt;connect_retries&nbsp;2&lt;br&gt;ipcache_low&nbsp;90&lt;br&gt;ipcache_size&nbsp;5024      &nbsp;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;DNS&nbsp;IP&nbsp;cache&nbsp;entries.&lt;br&gt;fqdncache_size&nbsp;3024    &nbsp;#&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;FQDN&nbsp;cache&nbsp;entries.&lt;br&gt;pipeline_prefetch&nbsp;100&lt;br&gt;&lt;br&gt;###############################################################################&lt;br&gt;## &nbsp;MISCELLANEOUS&lt;br&gt;###############################################################################&lt;br&gt;&lt;br&gt;max_filedescriptors&nbsp;65536&lt;br&gt;&lt;br&gt;------------------------------------------------------------------------&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;my&nbsp;squid&nbsp;spent&nbsp;alot&nbsp;of&nbsp;memory.&nbsp;I&nbsp;have&nbsp;about&nbsp;200&nbsp;user,&nbsp;and&nbsp;my&nbsp;server&nbsp;is&nbsp;4gb&nbsp;dram&nbsp;with&nbsp;8gb&nbsp;swap&nbsp;dram&nbsp;but&nbsp;not&nbsp;enough&nbsp;!&lt;br&gt;            &nbsp;total      &nbsp;used      &nbsp;free    &nbsp;shared   &nbsp;buffers    &nbsp;cached&lt;br&gt;Mem:         &nbsp;3.8G      &nbsp;3.4G      &nbsp;503M      &nbsp;736K      &nbsp;181M      &nbsp;1.7G&lt;br&gt;-/+&nbsp;buffers/cache:      &nbsp;1.5G      &nbsp;2.4G&lt;br&gt;Swap:        &nbsp;8.1G      &nbsp;9.3M      &nbsp;8.1G&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;is&nbsp;any&nbsp;issue&nbsp;with&nbsp;my&nbsp;squid&nbsp;??&nbsp;How&nbsp;can&nbsp;i&nbsp;fix&nbsp;it&nbsp;?&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;attach&nbsp;files&nbsp;for&nbsp;detail&nbsp;(squid.conf&nbsp;and&nbsp;squid-3.5.20-ssl-forgery.patch)&lt;br&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Thanks&nbsp;&amp;&nbsp;Best&nbsp;Regards,&lt;br&gt;--------------&lt;br&gt;&lt;/div&gt;Đỗ&nbsp;Hoàng&nbsp;Minh&nbsp;Hưng&lt;br&gt;&lt;/div&gt;Gmail&nbsp;:&nbsp;&lt;a&nbsp;href=&quot;mailto:hoangminhung@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;hoangminhung@gmail.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;SĐT&nbsp;:&nbsp;01234454115&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
