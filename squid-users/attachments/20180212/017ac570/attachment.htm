<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Feb&nbsp;9,&nbsp;2018&nbsp;at&nbsp;7:50&nbsp;PM,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;I&nbsp;cannot&nbsp;answer&nbsp;your&nbsp;question&nbsp;for&nbsp;aufs,&nbsp;but&nbsp;please&nbsp;note&nbsp;that&nbsp;rock&lt;br&gt;<br>
cache_dirs&nbsp;do&nbsp;not&nbsp;support/have/use&nbsp;a&nbsp;configurable&nbsp;replacement&nbsp;policy:&lt;br&gt;<br>
Each&nbsp;incoming&nbsp;object&nbsp;is&nbsp;assigned&nbsp;a&nbsp;slot&nbsp;based&nbsp;on&nbsp;its&nbsp;key&nbsp;hash.&nbsp;With&lt;br&gt;<br>
modern&nbsp;rock&nbsp;code,&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;remove&nbsp;that&nbsp;limitation&nbsp;IIRC,&nbsp;but&lt;br&gt;<br>
nobody&nbsp;have&nbsp;done&nbsp;that.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yeah&nbsp;I&nbsp;figured&nbsp;this&nbsp;out&nbsp;from&nbsp;the&nbsp;source&nbsp;code&nbsp;and&nbsp;I&#39;m&nbsp;extremely&nbsp;surprised&nbsp;by&nbsp;the&nbsp;fact&nbsp;that&nbsp;it&nbsp;was&nbsp;never&nbsp;mentioned&nbsp;in&nbsp;documentation.&nbsp;I&nbsp;think&nbsp;it&nbsp;will&nbsp;be&nbsp;a&nbsp;huge&nbsp;blocker&nbsp;in&nbsp;our&nbsp;squid&nbsp;4&nbsp;+&nbsp;SMP&nbsp;+&nbsp;rock&nbsp;migration&nbsp;plan.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;what&nbsp;does&nbsp;rock&nbsp;do&nbsp;when&nbsp;storage&nbsp;is&nbsp;full&nbsp;then?&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;If&nbsp;you&#39;re&nbsp;wondering&nbsp;why&nbsp;would&nbsp;we&nbsp;need&nbsp;to&nbsp;know&nbsp;that&nbsp;–&nbsp;it&#39;s&nbsp;related&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;GDPR&nbsp;and&nbsp;removing&nbsp;data&nbsp;of&nbsp;closed&nbsp;customer&#39;s&nbsp;accounts.&nbsp;We&nbsp;need&nbsp;to&nbsp;make&lt;br&gt;<br>
&gt;&nbsp;sure&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;any&nbsp;&quot;not&nbsp;being&nbsp;accessed&nbsp;anymore&quot;&nbsp;objects&nbsp;older&lt;br&gt;<br>
&gt;&nbsp;than&nbsp;&quot;data&nbsp;retention&nbsp;period&quot;&nbsp;days.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;If&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;get&nbsp;this&nbsp;right,&nbsp;then&nbsp;I&nbsp;would&nbsp;not&nbsp;trust&nbsp;replacement&lt;br&gt;<br>
policy&nbsp;metadata&nbsp;with&nbsp;this:&nbsp;The&nbsp;corresponding&nbsp;code&nbsp;interfaces&nbsp;look&lt;br&gt;<br>
unreliable&nbsp;to&nbsp;me,&nbsp;and&nbsp;access&nbsp;counts/timestamps&nbsp;for&nbsp;a&nbsp;ufs-based&nbsp;cache_dir&lt;br&gt;<br>
are&nbsp;not&nbsp;updated&nbsp;across&nbsp;Squid&nbsp;restarts&nbsp;when&nbsp;the&nbsp;swap&nbsp;log&nbsp;is&nbsp;lost&nbsp;(at&nbsp;least).&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;actually&nbsp;fine,&nbsp;we&nbsp;never&nbsp;restart&nbsp;squid&nbsp;and&nbsp;if&nbsp;it&nbsp;restarted&nbsp;by&nbsp;any&nbsp;unexpected&nbsp;reason&nbsp;(host&nbsp;reboot,&nbsp;crash&nbsp;or&nbsp;w/e)&nbsp;we&nbsp;just&nbsp;replace&nbsp;the&nbsp;host.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
I&nbsp;would&nbsp;instead&nbsp;configure&nbsp;Squid&nbsp;to&nbsp;prohibit&nbsp;serving&nbsp;hits&nbsp;that&nbsp;are&nbsp;too&lt;br&gt;<br>
old.&nbsp;That&nbsp;solution&nbsp;does&nbsp;not&nbsp;match&nbsp;your&nbsp;problem&nbsp;exactly,&nbsp;but&nbsp;it&nbsp;may&nbsp;be&lt;br&gt;<br>
good&nbsp;enough&nbsp;and&nbsp;should&nbsp;work&nbsp;a&nbsp;lot&nbsp;more&nbsp;reliably&nbsp;across&nbsp;all&nbsp;cache_dirs.&lt;br&gt;<br>
If&nbsp;there&nbsp;is&nbsp;no&nbsp;&quot;age&quot;&nbsp;ACL&nbsp;to&nbsp;use&nbsp;with&nbsp;the&nbsp;send_hit&nbsp;directive,&nbsp;then&nbsp;you&lt;br&gt;<br>
may&nbsp;need&nbsp;to&nbsp;add&nbsp;one.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Doc/config/send_hit/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.squid-cache.org/&lt;wbr&gt;Doc/config/send_hit/&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;may&nbsp;also&nbsp;be&nbsp;able&nbsp;to&nbsp;accomplish&nbsp;the&nbsp;same&nbsp;using&nbsp;refresh_pattern,&nbsp;but&nbsp;I&lt;br&gt;<br>
am&nbsp;a&nbsp;little&nbsp;worroed&nbsp;about&nbsp;various&nbsp;exceptional/special&nbsp;conditions&lt;br&gt;<br>
implemented&nbsp;on&nbsp;top&nbsp;of&nbsp;that&nbsp;directive.&nbsp;Others&nbsp;on&nbsp;this&nbsp;list&nbsp;may&nbsp;offer&lt;br&gt;<br>
better&nbsp;guidance&nbsp;in&nbsp;this&nbsp;area.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;was&nbsp;thinking&nbsp;about&nbsp;similar&nbsp;solution&nbsp;but&nbsp;this&nbsp;is&nbsp;exactly&nbsp;why&nbsp;I&nbsp;wasn&#39;t&nbsp;able&nbsp;to&nbsp;use&nbsp;it&nbsp;–&nbsp;there&nbsp;seems&nbsp;to&nbsp;be&nbsp;no&nbsp;acl&nbsp;suitable&nbsp;for&nbsp;such&nbsp;task.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;can&nbsp;always&nbsp;just&nbsp;replace&nbsp;the&nbsp;host&nbsp;every&nbsp;month&nbsp;or&nbsp;something&nbsp;like&nbsp;this&nbsp;but&nbsp;it&#39;ll&nbsp;mean&nbsp;starting&nbsp;with&nbsp;a&nbsp;cold&nbsp;cache&nbsp;every&nbsp;time&nbsp;which&nbsp;I&nbsp;wanted&nbsp;to&nbsp;avoid.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;found&nbsp;this&nbsp;debug&nbsp;option&nbsp;for&nbsp;heap&nbsp;which&nbsp;could&nbsp;probably&nbsp;help&nbsp;in&nbsp;understanding&nbsp;of&nbsp;approximate&nbsp;cache&nbsp;age&nbsp;but&nbsp;it&nbsp;doesn&#39;t&nbsp;work&nbsp;with&nbsp;rock&nbsp;because&nbsp;rock&nbsp;uses&nbsp;some&nbsp;&quot;simple&nbsp;scan&quot;&nbsp;policy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&gt; src/repl/heap/store_repl_heap.cc: &nbsp; &nbsp; &nbsp; &nbsp;debugs(81,&nbsp;3,&nbsp;&quot;Heap&nbsp;age&nbsp;set&nbsp;to&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;h-&gt;theHeap-&gt;age);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
