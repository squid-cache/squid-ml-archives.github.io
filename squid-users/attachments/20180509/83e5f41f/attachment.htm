<tt>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;div&gt;Hi,&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;At&nbsp;the &lt;span&nbsp;style=&quot;font-family:sans-serif;font-size:12.8px&quot;&gt;wccp0 &lt;/span&gt; interface&nbsp;do&nbsp;you&nbsp;see&nbsp;bidirectional&nbsp;http&nbsp;traffic?&nbsp;If&nbsp;the&nbsp;squid&nbsp;box&nbsp;has&nbsp;multiple&nbsp;interfaces,&nbsp;do&nbsp;you&nbsp;see&nbsp;traffic&nbsp;on&nbsp;its&nbsp;wan&nbsp;interface?&nbsp;That&nbsp;traffic&nbsp;might&nbsp;need&nbsp;NATing.&nbsp;Also&nbsp;I&nbsp;would&nbsp;check&nbsp;if&nbsp;squidbox&nbsp;drops&nbsp;any&nbsp;packages&nbsp;in&nbsp;case&nbsp;you&nbsp;have&nbsp;firewall&nbsp;configured&nbsp;on&nbsp;it.&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Alex&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;Wed,&nbsp;May&nbsp;9,&nbsp;2018,&nbsp;07:22&nbsp;Ilias&nbsp;Clifton&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:adilias3@gmx.com&quot;&gt;adilias3@gmx.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;<br>
Hello,&lt;br&gt;<br>
 &lt;br&gt;<br>
I&#39;ve&nbsp;been&nbsp;trying&nbsp;to&nbsp;get&nbsp;WCCP&nbsp;working&nbsp;but&nbsp;have&nbsp;been&nbsp;banging&nbsp;my&nbsp;head&nbsp;against&nbsp;a&nbsp;wall,&nbsp;so&nbsp;thought&nbsp;I&nbsp;would&nbsp;ask&nbsp;for&nbsp;help.&lt;br&gt;<br>
 &lt;br&gt;<br>
There&nbsp;are&nbsp;2&nbsp;internal&nbsp;subnets&nbsp;that&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;use&nbsp;the&nbsp;squid&nbsp;proxy:&nbsp;&lt;a&nbsp;href=&quot;http://172.28.30.128/25&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.28.30.128/25&lt;/a&gt;&nbsp;and&nbsp;&lt;a&nbsp;href=&quot;http://172.28.29.0/25&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.28.29.0/25&lt;/a&gt;&lt;br&gt;<br>
 &lt;br&gt;<br>
I&nbsp;have&nbsp;squid&nbsp;v3.5.25&nbsp;running&nbsp;on&nbsp;Ubuntu&nbsp;16&nbsp;:&nbsp;172.28.28.252&lt;br&gt;<br>
 &lt;br&gt;<br>
I&nbsp;have&nbsp;a&nbsp;Cisco&nbsp;1841&nbsp;-&nbsp;Adv&nbsp;IP&nbsp;-&nbsp;12.4,&nbsp;see&nbsp;relevent&nbsp;config:&lt;br&gt;<br>
 &lt;br&gt;<br>
#Inside&nbsp;Interface&lt;br&gt;<br>
interface&nbsp;FastEthernet0/1&lt;br&gt;<br>
 ip&nbsp;address&nbsp;172.28.28.1&nbsp;255.255.255.240&lt;br&gt;<br>
 ip&nbsp;wccp&nbsp;web-cache&nbsp;redirect&nbsp;in&lt;br&gt;<br>
 ip&nbsp;nat&nbsp;inside&lt;br&gt;<br>
 ip&nbsp;virtual-reassembly&nbsp;max-reassemblies&nbsp;64&lt;br&gt;<br>
 no&nbsp;ip&nbsp;mroute-cache&lt;br&gt;<br>
 duplex&nbsp;auto&lt;br&gt;<br>
 speed&nbsp;auto&lt;br&gt;<br>
 &lt;br&gt;<br>
#Loopback&nbsp;for&nbsp;wccp&nbsp;router&nbsp;ID&lt;br&gt;<br>
interface&nbsp;Loopback0&lt;br&gt;<br>
 ip&nbsp;address&nbsp;172.28.28.33&nbsp;255.255.255.255&lt;br&gt;<br>
 &lt;br&gt;<br>
ip&nbsp;wccp&nbsp;web-cache&nbsp;redirect-list&nbsp;PROXY_USERS&nbsp;group-list&nbsp;SQUID&lt;br&gt;<br>
 &lt;br&gt;<br>
ip&nbsp;access-list&nbsp;extended&nbsp;PROXY_USERS&lt;br&gt;<br>
 deny&nbsp; &nbsp;tcp&nbsp;host&nbsp;172.28.28.252&nbsp;any&lt;br&gt;<br>
 permit&nbsp;tcp&nbsp;172.28.30.128&nbsp;0.0.0.127&nbsp;any&nbsp;eq&nbsp;www&lt;br&gt;<br>
 permit&nbsp;tcp&nbsp;172.28.29.0&nbsp;0.0.0.127&nbsp;any&nbsp;eq&nbsp;www&lt;br&gt;<br>
 deny&nbsp; &nbsp;ip&nbsp;any&nbsp;any&lt;br&gt;<br>
 &lt;br&gt;<br>
ip&nbsp;access-list&nbsp;standard&nbsp;SQUID&lt;br&gt;<br>
 permit&nbsp;172.28.28.252&lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
On&nbsp;the&nbsp;Ubuntu&nbsp;box,&nbsp;I&nbsp;have&nbsp;the&nbsp;squid&nbsp;with&nbsp;the&nbsp;following&nbsp;config:&lt;br&gt;<br>
 &lt;br&gt;<br>
http_port&nbsp;3128&lt;br&gt;<br>
http_port&nbsp;3129&nbsp;intercept &lt;br&gt;<br>
acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.28.28.0/22&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.28.28.0/22&lt;/a&gt;&nbsp;  &lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
http_access&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
visible_hostname&nbsp;Squid&lt;br&gt;<br>
wccp2_router&nbsp;172.28.28.1&lt;br&gt;<br>
wccp2_forwarding_method&nbsp;gre&lt;br&gt;<br>
wccp2_return_method&nbsp;gre&lt;br&gt;<br>
wccp2_service&nbsp;standard&nbsp;0&lt;br&gt;<br>
 &lt;br&gt;<br>
If&nbsp;clients&nbsp;are&nbsp;manually&nbsp;set&nbsp;to&nbsp;use&nbsp;the&nbsp;proxy&nbsp;on&nbsp;port&nbsp;3128,&nbsp;they&nbsp;work&nbsp;correctly.&lt;br&gt;<br>
 &lt;br&gt;<br>
Again&nbsp;on&nbsp;the&nbsp;Ubuntu&nbsp;box,&nbsp;I&nbsp;have&nbsp;setup&nbsp;the&nbsp;following&nbsp;gre&nbsp;tunnel.&lt;br&gt;<br>
 &lt;br&gt;<br>
ip&nbsp;tunnel&nbsp;add&nbsp;wccp0&nbsp;mode&nbsp;gre&nbsp;remote&nbsp;172.28.28.33&nbsp;local&nbsp;172.28.28.252&nbsp;dev&nbsp;ens33&nbsp;ttl&nbsp;255&lt;br&gt;<br>
 &lt;br&gt;<br>
and&nbsp;the&nbsp;following&nbsp;redirect&nbsp;using&nbsp;iptables..&lt;br&gt;<br>
 &lt;br&gt;<br>
iptables&nbsp;-t&nbsp;nat -A&nbsp;PREROUTING&nbsp;-i&nbsp;wccp0&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3129&lt;br&gt;<br>
 &lt;br&gt;<br>
In&nbsp;sysctl.conf,&nbsp;I&nbsp;have&nbsp;disabled&nbsp;reverse&nbsp;path&nbsp;filtering&nbsp;and&nbsp;enabled&nbsp;ip&nbsp;forarding.&lt;br&gt;<br>
 &lt;br&gt;<br>
net.ipv4.conf.default.rp_filter=0&lt;br&gt;<br>
net.ipv4.conf.all.rp_filter=0&lt;br&gt;<br>
net.ipv4.ip_forward=1&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;starting&nbsp;squid,&nbsp;using&nbsp;tcpdump,&nbsp;i&nbsp;see&nbsp;traffic&nbsp;between&nbsp;the&nbsp;Ubuntu&nbsp;box&nbsp;and&nbsp;the&nbsp;router&nbsp;on&nbsp;udp&nbsp;port&nbsp;2048&lt;br&gt;<br>
&lt;br&gt;<br>
00:39:34.587799&nbsp;IP&nbsp;172.28.28.252.2048&nbsp;&gt;&nbsp;172.28.28.1.2048:&nbsp;UDP,&nbsp;length&nbsp;144&lt;br&gt;<br>
00:39:34.590399&nbsp;IP&nbsp;172.28.28.1.2048&nbsp;&gt;&nbsp;172.28.28.252.2048:&nbsp;UDP,&nbsp;length&nbsp;140&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;see&nbsp;the&nbsp;following&nbsp;message&nbsp;on&nbsp;the&nbsp;router..&lt;br&gt;<br>
%WCCP-5-SERVICEFOUND:&nbsp;Service&nbsp;web-cache&nbsp;acquired&nbsp;on&nbsp;WCCP&nbsp;client&nbsp;172.28.28.252&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;looks&nbsp;like&nbsp;it&#39;s&nbsp;working&nbsp;ok&nbsp;so&nbsp;far...&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;I&nbsp;try&nbsp;and&nbsp;browse&nbsp;to&nbsp;a&nbsp;site&nbsp;from&nbsp;a&nbsp;client..&lt;br&gt;<br>
$&nbsp;wget&nbsp;&lt;a&nbsp;href=&quot;http://www.google.com&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.google.com&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;the&nbsp;Ubuntu&nbsp;box,&nbsp;I&nbsp;see&nbsp;gre&nbsp;traffic&nbsp;on&nbsp;the&nbsp;ethernet&nbsp;interface..&lt;br&gt;<br>
00:44:22.340734&nbsp;IP&nbsp;172.28.28.33&nbsp;&gt;&nbsp;&lt;a&nbsp;href=&quot;http://172.28.28.252&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.28.28.252&lt;/a&gt;:&nbsp;GREv0,&nbsp;length&nbsp;72:&nbsp;gre-proto-0x883e&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;see&nbsp;the&nbsp;un-encapsulated&nbsp;traffic&nbsp;on&nbsp;the&nbsp;wccp0&nbsp;interface:&lt;br&gt;<br>
00:56:26.888519&nbsp;IP&nbsp;172.28.29.4.52128&nbsp;&gt;&nbsp;216.58.203.100.80&lt;br&gt;<br>
&lt;br&gt;<br>
Which&nbsp;is&nbsp;correctly&nbsp;showing&nbsp;original&nbsp;client&nbsp;IP&nbsp;and&nbsp;destination&nbsp;IP.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;can&nbsp;see&nbsp;hits&nbsp;on&nbsp;the&nbsp;iptable&nbsp;redirect&nbsp;rule:&lt;br&gt;<br>
pkts&nbsp;bytes&nbsp;target &nbsp; &nbsp; prot&nbsp;opt&nbsp;in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp; &lt;br&gt;<br>
 &nbsp;429&nbsp;26280&nbsp;REDIRECT &nbsp; tcp &nbsp;-- &nbsp;wccp0 &nbsp;any &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:http&nbsp;redir&nbsp;ports&nbsp;3129&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;there&nbsp;is&nbsp;no&nbsp;response&nbsp;from&nbsp;squid&nbsp;on&nbsp;the&nbsp;Ubuntu&nbsp;box&nbsp;:-(&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;don&#39;t&nbsp;see&nbsp;anything&nbsp;helpful&nbsp;in&nbsp;either&nbsp;access.log&nbsp;or&nbsp;cache.log.&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;m&nbsp;not&nbsp;sure&nbsp;if&nbsp;there&nbsp;is&nbsp;anything&nbsp;else&nbsp;that&nbsp;could&nbsp;be&nbsp;dropping&nbsp;the&nbsp;packet&nbsp;apart&nbsp;from&nbsp;return&nbsp;path&nbsp;filtering..&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;someone&nbsp;could&nbsp;give&nbsp;me&nbsp;some&nbsp;pointers&nbsp;or&nbsp;any&nbsp;further&nbsp;debugging&nbsp;I&nbsp;could&nbsp;try,&nbsp;that&nbsp;would&nbsp;be&nbsp;great.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
 &lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&nbsp;rel=&quot;noreferrer&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
