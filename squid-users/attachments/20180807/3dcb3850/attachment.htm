<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;Amos:&nbsp;yes&nbsp;agree&nbsp;that&nbsp;I&nbsp;should&nbsp;have&nbsp;told&nbsp;forward&nbsp;proxy.&lt;div&gt;&lt;br&gt;&lt;div&gt;When&nbsp;I&nbsp;remove&nbsp;the&nbsp;originserver&nbsp;option&nbsp;from&nbsp;cache_peer,&nbsp;the&nbsp;forward&nbsp;proxy&nbsp;is&nbsp;working&nbsp;so&nbsp;which&nbsp;means&nbsp;the&nbsp;rewriter&nbsp;is&nbsp;not&nbsp;precluding&nbsp;from&nbsp;happening.&nbsp;Does&nbsp;that&nbsp;give&nbsp;any&nbsp;clue&nbsp;to&nbsp;us? &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Moreover&nbsp;the&nbsp;reverse&nbsp;proxy&nbsp;is&nbsp;in&nbsp;next&nbsp;hop&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;not&nbsp;in&nbsp;internet.&nbsp;Time&nbsp;being,&nbsp;we&nbsp;are&nbsp;ok&nbsp;to&nbsp;have&nbsp;insecure&nbsp;channel&nbsp;between&nbsp;client&nbsp;and&nbsp;squid.&nbsp;Do&nbsp;you&nbsp;have&nbsp;any&nbsp;sample&nbsp;config&nbsp;that&nbsp;that&nbsp;uses&nbsp;a&nbsp;parent&nbsp;proxy&nbsp;to&nbsp;do&nbsp;both&nbsp;forward/reverse&nbsp;proxy?&nbsp;Or&nbsp;do&nbsp;you&nbsp;see&nbsp;my&nbsp;config&nbsp;is&nbsp;good&nbsp;enough&nbsp;for&nbsp;this&nbsp;requirement.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Aug&nbsp;7,&nbsp;2018&nbsp;at&nbsp;9:07&nbsp;PM,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;span&nbsp;class=&quot;&quot;&gt;On&nbsp;08/08/18&nbsp;01:04,&nbsp;Hariharan&nbsp;Sethuraman&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;have&nbsp;our&nbsp;company&nbsp;proxy&nbsp;and&nbsp;this&nbsp;is&nbsp;how&nbsp;the&nbsp;topology&nbsp;is&nbsp;expected&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;look&nbsp;like&nbsp;for&nbsp;the&nbsp;deployment:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Client&lt;br&gt;<br>
&gt;&nbsp;-------------------squid-host.&lt;wbr&gt;com---------------------------&lt;wbr&gt;company-proxy------------&lt;wbr&gt;Internet&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Now&nbsp;I&nbsp;need&nbsp;to&nbsp;allow&nbsp;reverse&nbsp;proxy(3128)&nbsp;for&nbsp;some&nbsp;request&nbsp;from&nbsp;the&nbsp;client&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;tunnel&nbsp;(3129)&nbsp;as&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;This&nbsp;reads&nbsp;like&nbsp;you&nbsp;don&#39;t&nbsp;understand&nbsp;what&nbsp;either&nbsp;of&nbsp;those&nbsp;terms&nbsp;mean.&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;proxies&nbsp;port&nbsp;3129&nbsp;is&nbsp;setup&nbsp;for&nbsp;forward-proxy&nbsp;traffic.&lt;br&gt;<br>
&lt;br&gt;<br>
&quot;tunnel&quot;&nbsp;is&nbsp;and&nbsp;action&nbsp;that&nbsp;can&nbsp;be&nbsp;done&nbsp;by&nbsp;clients.&nbsp;Also&nbsp;the&nbsp;term&nbsp;used&lt;br&gt;<br>
to&nbsp;describe&nbsp;the&nbsp;*payload*&nbsp;of&nbsp;a&nbsp;CONNECT&nbsp;message.&nbsp;The&nbsp;action&nbsp;a&lt;br&gt;<br>
forward-proxy&nbsp;performs&nbsp;when&nbsp;receiving&nbsp;a&nbsp;CONNECT&nbsp;is&nbsp;usually&nbsp;to&nbsp;setup&nbsp;a&lt;br&gt;<br>
tunnel&nbsp;CONNECT-ion&nbsp;for&nbsp;non-HTTP&nbsp;use.&lt;br&gt;<br>
&lt;br&gt;<br>
Using&nbsp;port&nbsp;3128&nbsp;for&nbsp;reverse-proxy&nbsp;traffic&nbsp;is&nbsp;a&nbsp;very&nbsp;bad&nbsp;idea.&nbsp;That&nbsp;port&lt;br&gt;<br>
is&nbsp;a&nbsp;well-known&nbsp;port&nbsp;and&nbsp;also&nbsp;reserved&nbsp;for&nbsp;explicit&nbsp;/&nbsp;forward-proxy&nbsp;traffic.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Configuration:&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&nbsp;accel&nbsp;allow-direct&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3129&lt;br&gt;<br>
&gt;&nbsp;never_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;always_direct&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;...&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;company-proxy&nbsp;parent&nbsp;80 &nbsp; &nbsp; &nbsp; 0 &nbsp;no-query&nbsp;no-digest&lt;br&gt;<br>
&gt;&nbsp;login=PASS&nbsp;originserver&lt;br&gt;<br>
&gt;&nbsp;url_rewrite_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;url_rewrite_program &nbsp;/usr/bin/python&nbsp;./rewriter_program.py&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Usecases:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1)&nbsp;Reverse&nbsp;proxy:&nbsp;Now&nbsp;I&nbsp;can&nbsp;successfully&nbsp;get&nbsp;the&nbsp;response&nbsp;for&nbsp;the&nbsp;query&lt;br&gt;<br>
&gt;&nbsp;like&nbsp;curl&nbsp;-X&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://squid-host.com:3128/microsoftapi/api/something&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://squid-host.com:3128/&lt;wbr&gt;microsoftapi/api/something&lt;/a&gt;.&lt;br&gt;<br>
&gt;&nbsp;Basically&nbsp;I&nbsp;rewrite&nbsp;URL&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://microsft.com/api/something&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://microsft.com/api/&lt;wbr&gt;something&lt;/a&gt;&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;through&nbsp;company-proxy&nbsp;I&nbsp;get&nbsp;the&nbsp;response&nbsp;successfully&nbsp;from&nbsp;e.g.,&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;&lt;a&nbsp;href=&quot;http://microsoft.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;microsoft.com&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://microsoft.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://microsoft.com&lt;/a&gt;&gt;.&lt;br&gt;<br>
&lt;br&gt;<br>
Re-writing&nbsp;message&nbsp;URLs&nbsp;across&nbsp;the&nbsp;insecure&nbsp;/&nbsp;secure&nbsp;boundary&nbsp;is&nbsp;a&nbsp;very&lt;br&gt;<br>
bad&nbsp;idea.&nbsp;All&nbsp;Cookies&nbsp;and&nbsp;other&nbsp;things&nbsp;in&nbsp;both&nbsp;message&nbsp;headers&nbsp;and&lt;br&gt;<br>
payload&nbsp;content&nbsp;which&nbsp;are&nbsp;tied&nbsp;to&nbsp;either&nbsp;the&nbsp;TLS&nbsp;or&nbsp;the&nbsp;Origin&nbsp;state&lt;br&gt;<br>
will&nbsp;be&nbsp;broken.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;client&nbsp;thinks&nbsp;it&nbsp;is&nbsp;talking&nbsp;to&nbsp;an&nbsp;insecure&nbsp;server,&nbsp;and&nbsp;the&nbsp;server&lt;br&gt;<br>
thinks&nbsp;it&nbsp;is&nbsp;connected&nbsp;to&nbsp;a&nbsp;secure&nbsp;client.&nbsp;They&nbsp;also&nbsp;have&nbsp;very&nbsp;different&lt;br&gt;<br>
ideas&nbsp;about&nbsp;the&nbsp;Origin&nbsp;scope&nbsp;for&nbsp;stateful&nbsp;security&nbsp;things&nbsp;-&nbsp;especially&lt;br&gt;<br>
when&nbsp;re-writing&nbsp;across&nbsp;domains&nbsp;like&nbsp;this.&nbsp;That&nbsp;means&nbsp;they&nbsp;each&nbsp;believe&lt;br&gt;<br>
different&nbsp;range&nbsp;of&nbsp;actions&nbsp;are&nbsp;valid,&nbsp;and&nbsp;that&nbsp;impacts&nbsp;on&nbsp;what&nbsp;they&lt;br&gt;<br>
expect&nbsp;the&nbsp;other&nbsp;agents&nbsp;behaviour&nbsp;to&nbsp;be&nbsp;in&nbsp;reaction&nbsp;to&nbsp;any&nbsp;given&nbsp;message.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2)&nbsp;Tunnel:&nbsp;It&nbsp;fails&nbsp;when&nbsp;the&nbsp;client&nbsp;do&nbsp;a&nbsp;query&nbsp;like&nbsp;curl&nbsp;-x&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://squid-host.com:3129&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://squid-host.com:3129&lt;/a&gt;&nbsp;-X&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;https://googlecloudapis.com/api/something&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://googlecloudapis.com/&lt;wbr&gt;api/something&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;HTTP/1.1&nbsp;503&nbsp;Service&nbsp;Unavailable&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Server:&nbsp;squid/3.5.20&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Mime-Version:&nbsp;1.0&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Date:&nbsp;Tue,&nbsp;07&nbsp;Aug&nbsp;2018&nbsp;12:36:07&nbsp;GMT&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Type:&nbsp;text/html;charset=utf-8&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Length:&nbsp;3879&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Squid-Error:&nbsp;ERR_CANNOT_FORWARD&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Vary:&nbsp;Accept-Language&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Language:&nbsp;en&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;br&gt;<br>
&gt;&nbsp;*&nbsp;The&nbsp;requested&nbsp;URL&nbsp;returned&nbsp;error:&nbsp;503&lt;br&gt;<br>
&gt;&nbsp;*&nbsp;CONNECT&nbsp;phase&nbsp;completed!&lt;br&gt;<br>
&lt;/span&gt;&gt;&nbsp;*&nbsp;Connection&nbsp;#0&nbsp;to&nbsp;host&nbsp;&lt;a&nbsp;href=&quot;http://squidhostname.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;squidhostname.com&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://squidhostname.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://squidhostname.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&gt;&nbsp;left&nbsp;intact&lt;br&gt;<br>
&gt;&nbsp;Now,&nbsp;if&nbsp;I&nbsp;remove&nbsp;the&nbsp;origin&nbsp;server,&nbsp;the&nbsp;TUNNEL&nbsp;goes&nbsp;through&nbsp;and&nbsp;getting&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;response&nbsp;but&nbsp;the&nbsp;reverse&nbsp;proxy&nbsp;fails.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Please&nbsp;add&nbsp;the&nbsp;--verbose&nbsp;option&nbsp;to&nbsp;your&nbsp;curl&nbsp;test&nbsp;commands&nbsp;to&nbsp;see&nbsp;what&lt;br&gt;<br>
is&nbsp;actually&nbsp;being&nbsp;sent&nbsp;to&nbsp;the&nbsp;proxy.&nbsp;Then&nbsp;test&nbsp;what&nbsp;your&nbsp;re-writer&nbsp;is&lt;br&gt;<br>
causing&nbsp;to&nbsp;happen&nbsp;on&nbsp;those&nbsp;received&nbsp;URI.&lt;br&gt;<br>
&lt;br&gt;<br>
Note&nbsp;that&nbsp;all&nbsp;the&nbsp;re-writer&nbsp;does&nbsp;is&nbsp;change&nbsp;the&nbsp;URI.&nbsp;It&nbsp;does&nbsp;not&nbsp;change&lt;br&gt;<br>
the&nbsp;method&nbsp;or&nbsp;other&nbsp;request&nbsp;details.&nbsp;If&nbsp;it&nbsp;produces&nbsp;an&nbsp;invalid&nbsp;or&lt;br&gt;<br>
unreachable&nbsp;URI&nbsp;there&nbsp;is&nbsp;nothing&nbsp;Squid&nbsp;can&nbsp;do&nbsp;but&nbsp;present&nbsp;the&nbsp;client&lt;br&gt;<br>
with&nbsp;an&nbsp;error.&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Could&nbsp;you&nbsp;let&nbsp;me&nbsp;know&nbsp;how&nbsp;I&nbsp;can&nbsp;handle&nbsp;both&nbsp;tunneling&nbsp;and&nbsp;reverse&nbsp;proxy&lt;br&gt;<br>
&gt;&nbsp;through&nbsp;same&nbsp;cache&nbsp;peer?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;Both&nbsp;are&nbsp;already&nbsp;supported&nbsp;and&nbsp;work&nbsp;without&nbsp;any&nbsp;fancy&nbsp;setup.&nbsp;I&nbsp;think&nbsp;you&lt;br&gt;<br>
are&nbsp;hitting&nbsp;something&nbsp;else&nbsp;which&nbsp;should&nbsp;become&nbsp;clearer&nbsp;when&nbsp;you&nbsp;see&nbsp;what&lt;br&gt;<br>
curl&nbsp;is&nbsp;actually&nbsp;doing.&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.&lt;wbr&gt;org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/&lt;wbr&gt;listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
