<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;div&nbsp;class=&quot;ydpe265b750yahoo-style-wrap&quot;&nbsp;style=&quot;font-family:Helvetica&nbsp;Neue,&nbsp;Helvetica,&nbsp;Arial,&nbsp;sans-serif;font-size:16px;&quot;&gt;&lt;div&nbsp;id=&quot;ydpe265b750yiv0571450082&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;ydpe265b750yiv0571450082ydp8c8e88aeyahoo-style-wrap&quot;&nbsp;style=&quot;font-family:Helvetica&nbsp;Neue,&nbsp;Helvetica,&nbsp;Arial,&nbsp;sans-serif;font-size:16px;&quot;&gt;&lt;div&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;tanx&nbsp;again.&lt;/div&gt;&lt;div&gt;Ok,&nbsp;if&nbsp;I&nbsp;want&nbsp;to&nbsp;know&nbsp;connmark&nbsp;of&nbsp;packets&nbsp;and&nbsp;connection&nbsp;in&nbsp;squid&nbsp;and&nbsp;then&nbsp;select&nbsp;them&nbsp;with&nbsp;an&nbsp;ACL&nbsp;inside&nbsp;of&nbsp;squid&nbsp;&nbsp;and&nbsp;then&nbsp;again&nbsp;mark&nbsp;them&nbsp;with&nbsp;&quot;&lt;span&gt;tcp_outgoing_mark&lt;/span&gt;&quot;,&nbsp;is&nbsp;that&nbsp;possible??&lt;/div&gt;&lt;div&gt;&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;&lt;a&nbsp;href=&quot;http://www.squid-cache.org/Doc/config/clientside_mark/&quot;&gt;this&nbsp;page&lt;/a&gt;&nbsp;i&nbsp;don't&nbsp;see&nbsp;what&nbsp;you&nbsp;said!&lt;/div&gt;&lt;div&gt;The&nbsp;ACL&nbsp;that&nbsp;be&nbsp;configured&nbsp;only&nbsp;match&nbsp;with&nbsp;clients&nbsp;source&nbsp;ip&nbsp;addresses&nbsp;or&nbsp;domain&nbsp;and&nbsp;...,&nbsp;not&nbsp;connmark!&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;yiv0571450082yqt5395990750&quot;&nbsp;id=&quot;yiv0571450082yqt01300&quot;&gt;&lt;div&nbsp;class=&quot;yiv0571450082yahoo_quoted&quot;&nbsp;id=&quot;yiv0571450082yahoo_quoted_9672806010&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;style=&quot;font-family:'Helvetica&nbsp;Neue',&nbsp;Helvetica,&nbsp;Arial,&nbsp;sans-serif;font-size:13px;color:#26282a;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Saturday,&nbsp;October&nbsp;13,&nbsp;2018,&nbsp;5:47:49&nbsp;AM&nbsp;GMT+3:30,&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;squid3@treenet.co.nz&gt;&nbsp;wrote:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;13/10/18&nbsp;5:13&nbsp;AM,&nbsp;morteza&nbsp;omidian&nbsp;wrote:&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;Tank&nbsp;you,&nbsp;I&nbsp;see&nbsp;it&nbsp;now.&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;It&nbsp;does&nbsp;not&nbsp;help&nbsp;me,&nbsp;I&nbsp;want&nbsp;to&nbsp;have&nbsp;an&nbsp;acl&nbsp;to&nbsp;select&nbsp;traffic&nbsp;(HTTP&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;traffic&nbsp;that&nbsp;comes&nbsp;from&nbsp;client&nbsp;to&nbsp;squid)&nbsp;that&nbsp;have&nbsp;a&nbsp;specific&nbsp;packet&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;mark&nbsp;and&nbsp;then&nbsp;send&nbsp;them&nbsp;out&nbsp;with&nbsp;another&nbsp;mark.&nbsp;like&nbsp;this:&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;In&nbsp;iptables-mangle-PREROUTING:&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;iptables&nbsp;-t&nbsp;mangle&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;MARK&nbsp;--set-mark&nbsp;1&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;In&nbsp;Squid&nbsp;Configuration:&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;acl&nbsp;MARKED_PACKETS&nbsp;nfmark&nbsp;1&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;tcp_outgoing_mark&nbsp;1&nbsp;MARKED_PACKETS&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;Is&nbsp;that&nbsp;possible&nbsp;or&nbsp;not?&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;What&nbsp;you&nbsp;ask&nbsp;for&nbsp;is&nbsp;not&nbsp;possible.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;What&nbsp;you&nbsp;are&nbsp;trying&nbsp;to&nbsp;do&nbsp;*is*&nbsp;possible&nbsp;...&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;I&nbsp;want&nbsp;this&nbsp;kind&nbsp;of&nbsp;marks&nbsp;because&nbsp;I&nbsp;need&nbsp;to&nbsp;determine&nbsp;source&nbsp;interface&lt;br&nbsp;clear=&quot;none&quot;&gt;&gt;&nbsp;of&nbsp;packets&nbsp;after&nbsp;they&nbsp;go&nbsp;out&nbsp;of&nbsp;squid!&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;Two&nbsp;things:&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&nbsp;1)&nbsp;the&nbsp;rules&nbsp;you&nbsp;have&nbsp;above&nbsp;*do&nbsp;not*&nbsp;do&nbsp;what&nbsp;you&nbsp;say&nbsp;you&nbsp;are&nbsp;wanting.&lt;br&nbsp;clear=&quot;none&quot;&gt;The&nbsp;iptables&nbsp;rule&nbsp;marks&nbsp;*everything*&nbsp;on&nbsp;every&nbsp;interface&nbsp;with&nbsp;0x1.&lt;br&nbsp;clear=&quot;none&quot;&gt;Overwriting&nbsp;whatever&nbsp;Squid&nbsp;would&nbsp;set.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&nbsp;2)&nbsp;MARK&nbsp;is&nbsp;the&nbsp;wrong&nbsp;iptables&nbsp;feature&nbsp;to&nbsp;be&nbsp;using.&nbsp;It&nbsp;only&nbsp;marks&nbsp;a&lt;br&nbsp;clear=&quot;none&quot;&gt;*single*&nbsp;packet&nbsp;per&nbsp;rule/table&nbsp;evaluation&nbsp;and&nbsp;is&nbsp;not&nbsp;accessible&nbsp;to&nbsp;any&lt;br&nbsp;clear=&quot;none&quot;&gt;software&nbsp;higher&nbsp;up&nbsp;the&nbsp;network&nbsp;stack&nbsp;than&nbsp;iptables&nbsp;itself.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;What&nbsp;you&nbsp;should&nbsp;be&nbsp;using&nbsp;is&nbsp;-j&nbsp;CONNMARK.&nbsp;Once&nbsp;a&nbsp;CONNMARK&nbsp;is&nbsp;set&nbsp;on&nbsp;a&lt;br&nbsp;clear=&quot;none&quot;&gt;connection&nbsp;it&nbsp;is&nbsp;copied&nbsp;by&nbsp;iptables&nbsp;to&nbsp;each&nbsp;following&nbsp;packet&nbsp;on&nbsp;that&lt;br&nbsp;clear=&quot;none&quot;&gt;same&nbsp;connection.&nbsp;It&nbsp;is&nbsp;also&nbsp;available&nbsp;to&nbsp;layer-4&nbsp;software&nbsp;like&nbsp;Squid&lt;br&nbsp;clear=&quot;none&quot;&gt;which&nbsp;have&nbsp;*nothing*&nbsp;to&nbsp;do&nbsp;with&nbsp;individual&nbsp;packets.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;The&nbsp;clientside_mark&nbsp;ACL&nbsp;in&nbsp;Squid&nbsp;matches&nbsp;these&nbsp;values&nbsp;and&nbsp;does&nbsp;exactly&lt;br&nbsp;clear=&quot;none&quot;&gt;what&nbsp;you&nbsp;are&nbsp;wanting.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;Think&nbsp;of&nbsp;thing&nbsp;this&nbsp;way:&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&nbsp;MARK&nbsp;-&nbsp;stays&nbsp;within&nbsp;nftables/iptables.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&nbsp;CONNMARK&nbsp;-&nbsp;stays&nbsp;within&nbsp;the&nbsp;machine.&nbsp;Can&nbsp;go&nbsp;to&nbsp;other&nbsp;software&nbsp;within&lt;br&nbsp;clear=&quot;none&quot;&gt;the&nbsp;same&nbsp;machine.&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&nbsp;TOS&nbsp;-&nbsp;goes&nbsp;to&nbsp;other&nbsp;machines,&nbsp;and&nbsp;possibly&nbsp;networks.&lt;div&nbsp;class=&quot;yiv0571450082yqt1893407520&quot;&nbsp;id=&quot;yiv0571450082yqtfd95480&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;Amos&lt;br&nbsp;clear=&quot;none&quot;&gt;_______________________________________________&lt;br&nbsp;clear=&quot;none&quot;&gt;squid-users&nbsp;mailing&nbsp;list&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;a&nbsp;rel=&quot;nofollow&quot;&nbsp;shape=&quot;rect&quot;&nbsp;ymailto=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;a&nbsp;rel=&quot;nofollow&quot;&nbsp;shape=&quot;rect&quot;&nbsp;target=&quot;_blank&quot;&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&nbsp;clear=&quot;none&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
