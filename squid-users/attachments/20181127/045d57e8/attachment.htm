<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;have&nbsp;an&nbsp;issue&nbsp;with&nbsp;access_log&nbsp;acls&nbsp;when&nbsp;a&nbsp;load&nbsp;balancer&nbsp;sends&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP&nbsp;probe.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;goal&nbsp;is&nbsp;to&nbsp;not&nbsp;log&nbsp;errors&nbsp;caused&nbsp;by&nbsp;the&nbsp;TCP&nbsp;probes&nbsp;of&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;load&nbsp;balancer. &nbsp;All&nbsp;other&nbsp;errors&nbsp;must&nbsp;be&nbsp;logged.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;did&nbsp;a&nbsp;test&nbsp;with&nbsp;the&nbsp;following&nbsp;acls&nbsp;on&nbsp;one&nbsp;of&nbsp;our&nbsp;test&nbsp;systems<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;issue:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;tt&gt;logformat&nbsp;combha&nbsp;%&gt;a&nbsp;%ui&nbsp;%un&nbsp;[%tl]&nbsp;&quot;%rm&nbsp;%ru&nbsp;HTTP/%rv&quot;&nbsp;%&gt;Hs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&lt;st&nbsp;%Ss:%Sh&nbsp;%&gt;ha&lt;/tt&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tt&gt;&lt;tt&gt;acl&nbsp;src_lb&nbsp;src&nbsp;10.2.2.254/32&lt;/tt&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tt&gt;&lt;tt&gt;acl&nbsp;src_lb&nbsp;src&nbsp;10.2.2.107/32&lt;/tt&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tt&gt;&lt;tt&gt;access_log&nbsp;stdio:/local/squid4/logs/&lt;b&gt;lb&lt;/b&gt;access.log<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;combha&nbsp;src_lb&lt;/tt&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;stdio:/local/squid4/logs/access.log  &nbsp;combha&nbsp;!src_lb&lt;/tt&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;logging&nbsp;is&nbsp;almost&nbsp;as&nbsp;expected:&nbsp;all&nbsp;HTTP(S)&nbsp;traffic&nbsp;from<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.2.2.107&nbsp;goes&nbsp;to&nbsp;lbaccess.log&nbsp;and&nbsp;all&nbsp;other&nbsp;traffic&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access.log,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;b&gt;but&lt;/b&gt;&nbsp;imitating&nbsp;the&nbsp;TCP&nbsp;probe&nbsp;of&nbsp;the&nbsp;LB&nbsp;with&nbsp;a&nbsp;telnet&nbsp;session<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;10.2.2.107&nbsp;to&nbsp;the&nbsp;squid&nbsp;server&nbsp;which&nbsp;is&nbsp;immediately<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;terminated&nbsp;or&nbsp;sends&nbsp;garbage,&nbsp;is&nbsp;logged&nbsp;with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-end-before-headers&nbsp;to&nbsp;access.log,&nbsp;not&nbsp;lbaccess.log.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;It&nbsp;seems&nbsp;that&nbsp;Squid,&nbsp;at&nbsp;the&nbsp;moment&nbsp;that&nbsp;it&nbsp;logs&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-end-before-headers&nbsp;error,&nbsp;does&nbsp;not&nbsp;consider&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;acls&nbsp;or&nbsp;maybe&nbsp;has&nbsp;not&nbsp;yet&nbsp;processed&nbsp;the&nbsp;source&nbsp;IP&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;the&nbsp;right&nbsp;decision.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Should&nbsp;the&nbsp;above&nbsp;acls&nbsp;send&nbsp;the&nbsp;errors&nbsp;to&nbsp;lbaccess.log&nbsp;? &nbsp;If&nbsp;not,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;what&nbsp;set&nbsp;of&nbsp;acls&nbsp;can&nbsp;do&nbsp;it?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Thanks,&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Marcus&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tt&gt;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;tt&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tt&gt;&lt;/p&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
