<tt>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Hi,&nbsp;thanks&nbsp;very&nbsp;much&nbsp;for&nbsp;all&nbsp;the&nbsp;advices!&lt;div&nbsp;dir=&quot;auto&quot;&gt;About&nbsp;the&nbsp;action&nbsp;to&nbsp;generate&nbsp;the&nbsp;certificate&nbsp;I&#39;ve&nbsp;followed&nbsp;the&nbsp;squid&nbsp;wiki,&nbsp;that&nbsp;doesn&#39;t&nbsp;modify&nbsp;(if&nbsp;I&nbsp;remember&nbsp;correctly)&nbsp;openssl&nbsp;conf&nbsp;to&nbsp;create&nbsp;it&nbsp;.&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Do&nbsp;you&nbsp;have&nbsp;some&nbsp;link&nbsp;to&nbsp;a&nbsp;good&nbsp;howto&nbsp;about&nbsp;that?&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Thanjs&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;Il&nbsp;gio&nbsp;4&nbsp;apr&nbsp;2019,&nbsp;12:35&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&nbsp;ha&nbsp;scritto:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;On&nbsp;4/04/19&nbsp;10:11&nbsp;pm,&nbsp;Davide&nbsp;Belloni&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&lt;br&gt;<br>
&gt;&nbsp;I&#39;ve&nbsp;a&nbsp;problem&nbsp;in&nbsp;Ubuntu&nbsp;18.04.2&nbsp;with&nbsp;Squid&nbsp;4.6&nbsp;compiled&nbsp;with&nbsp;OpenSSL&lt;br&gt;<br>
&gt;&nbsp;1.1&nbsp;about&nbsp;ssl_bump.&nbsp;The&nbsp;same&nbsp;configuration&nbsp;works&nbsp;in&nbsp;Squid&nbsp;3.5&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;OpenSSL&nbsp;1.0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Here&nbsp;the&nbsp;relevant&nbsp;conf&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ...&lt;br&gt;<br>
&gt; &nbsp; &nbsp; http_port&nbsp;3128&nbsp;ssl-bump&nbsp;options=ALL:NO_SSLv3&nbsp;connection-auth=off&lt;br&gt;<br>
&gt; &nbsp; &nbsp; generate-host-certificates=off&nbsp;cert=/etc/squid/squidCA.pem&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;several&nbsp;differences&nbsp;which&nbsp;are&nbsp;relevant&nbsp;here.&lt;br&gt;<br>
&lt;br&gt;<br>
Firstly,&nbsp;the&nbsp;options=&nbsp;setting&nbsp;in&nbsp;v4&nbsp;is&nbsp;buggy&nbsp;right&nbsp;now.&lt;br&gt;<br>
&lt;br&gt;<br>
Secondly,&nbsp;that&nbsp;&quot;ALL&quot;&nbsp;setting&nbsp;enables&nbsp;a&nbsp;large&nbsp;number&nbsp;of&nbsp;highly&nbsp;unsafe&lt;br&gt;<br>
OpenSSL&nbsp;features.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;good&nbsp;idea&nbsp;to&nbsp;use&nbsp;that.&lt;br&gt;<br>
&lt;br&gt;<br>
Thirdly,&nbsp;v4&nbsp;now&nbsp;checks&nbsp;the&nbsp;contents&nbsp;of&nbsp;that&nbsp;squidCA.pem&nbsp;file&nbsp;and&nbsp;only&lt;br&gt;<br>
loads&nbsp;the&nbsp;actually&nbsp;needed&nbsp;cert/key/chain&nbsp;objects.&nbsp;v3&nbsp;would&nbsp;load&lt;br&gt;<br>
everything&nbsp;even&nbsp;if&nbsp;the&nbsp;cert&nbsp;properties&nbsp;were&nbsp;forbidden&nbsp;for&nbsp;use&nbsp;by&nbsp;a&nbsp;proxy&lt;br&gt;<br>
or&nbsp;HTTP&nbsp;server.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp; #&nbsp;Not&nbsp;bypass&nbsp;server&nbsp;certificate&nbsp;validation&nbsp;errors&lt;br&gt;<br>
&gt; &nbsp; &nbsp; sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; #&nbsp;This&nbsp;one&nbsp;return&nbsp;errors&nbsp;with&nbsp;debian&nbsp;on&nbsp;GCP&lt;br&gt;<br>
&gt; &nbsp; &nbsp; (&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery&lt;/a&gt;)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; host_verify_strict&nbsp;off&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;above&nbsp;two&nbsp;directives&nbsp;are&nbsp;setting&nbsp;the&nbsp;defaults.&nbsp;It&nbsp;is&nbsp;only&nbsp;a&nbsp;waste&nbsp;of&lt;br&gt;<br>
CPU&nbsp;cycles&nbsp;to&nbsp;configure&nbsp;that&nbsp;in&nbsp;any&nbsp;Squid&nbsp;version.&nbsp;No&nbsp;need&nbsp;to&nbsp;configure&lt;br&gt;<br>
these&nbsp;at&nbsp;all.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; sslproxy_session_cache_size&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ssl_bump&nbsp;peek&nbsp;step2&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; #&nbsp;API&nbsp;Google&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_urls&nbsp;url_regex&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_urls&nbsp;url_regex&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_urls&nbsp;url_regex&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_urls&nbsp;url_regex&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})&lt;br&gt;<br>
&lt;br&gt;<br>
These&nbsp;regex&nbsp;are&nbsp;overly&nbsp;complex.&nbsp;These&nbsp;two&nbsp;patterns&nbsp;cover&nbsp;the&nbsp;same&nbsp;set&nbsp;of&lt;br&gt;<br>
URLs:&lt;br&gt;<br>
&lt;br&gt;<br>
 acl&nbsp;api_google_urls&nbsp;url_regex&nbsp;\&lt;br&gt;<br>
 &nbsp; \.google(apis)?\.com(:443)?($|\/)&lt;br&gt;<br>
 &nbsp; ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_ssl&nbsp;ssl::server_name_regex&nbsp;.*\.googleapis\.com&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_ssl&nbsp;ssl::server_name_regex&nbsp;.*\.google\.com&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_ssl&nbsp;ssl::server_name_regex&nbsp;.*\.cloud\.google\.com&lt;br&gt;<br>
&lt;br&gt;<br>
Same&nbsp;with&nbsp;these&nbsp;ones:&lt;br&gt;<br>
&lt;br&gt;<br>
 acl&nbsp;api_google_ssl&nbsp;ssl::server_name_regex&nbsp;\.google(apis)?\.com&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp; acl&nbsp;api_google_ips&nbsp;src &lt;a&nbsp;href=&quot;http://127.0.0.1/32&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1/32&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; http_access&nbsp;allow&nbsp;api_google_ips&nbsp;api_google_urls&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ssl_bump&nbsp;splice&nbsp;step3&nbsp;api_google_ips&nbsp;api_google_ssl&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ssl_bump&nbsp;terminate&nbsp;step3&nbsp;all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ...&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
...&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&#39;m&nbsp;upgrading&nbsp;to&nbsp;Squid4&nbsp;with&nbsp;OpenSSL&nbsp;1.1&nbsp;because&nbsp;with&nbsp;Squid3&nbsp;Ive&nbsp;some&lt;br&gt;<br>
&gt;&nbsp;connections&nbsp;that&nbsp;get&nbsp;stuck&nbsp;(for&nbsp;example&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://packages.cloud.google.com/apt/doc/apt-key.gpg&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://packages.cloud.google.com/apt/doc/apt-key.gpg&lt;/a&gt;)&nbsp;I&nbsp;think&nbsp;for&lt;br&gt;<br>
&gt;&nbsp;unsupported&nbsp;ciphers.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;But&nbsp;with&nbsp;Squid4&nbsp;and&nbsp;OpenSSL1.1&nbsp;I&#39;ve&nbsp;this&nbsp;lines&nbsp;in&nbsp;cache&nbsp;log:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 2019/04/04&nbsp;08:49:15&nbsp;kid1|&nbsp;ERROR:&nbsp;client&nbsp;https&nbsp;start&nbsp;failed&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; allocate&nbsp;handle:&nbsp;error:140AB043:SSL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; routines:SSL_CTX_use_certificate:passed&nbsp;a&nbsp;null&nbsp;parameter&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Check&nbsp;the&nbsp;SquidCA.pem&nbsp;file&nbsp;actually&nbsp;contains&nbsp;a&nbsp;valid&nbsp;X.509&nbsp;server&nbsp;CA&lt;br&gt;<br>
certificate&nbsp;and&nbsp;matching&nbsp;key.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 2019/04/04&nbsp;08:49:15&nbsp;kid1|&nbsp;ERROR:&nbsp;could&nbsp;not&nbsp;create&nbsp;TLS&nbsp;server&nbsp;context&lt;br&gt;<br>
&gt; &nbsp; &nbsp; for&nbsp;local=&lt;a&nbsp;href=&quot;http://127.0.0.1:3128&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1:3128&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://127.0.0.1:3128&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://127.0.0.1:3128&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; remote=&lt;a&nbsp;href=&quot;http://127.0.0.1:39203&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1:39203&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://127.0.0.1:39203&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://127.0.0.1:39203&lt;/a&gt;&gt;&nbsp;FD&nbsp;19&nbsp;flags=1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;must&nbsp;be&nbsp;fixed&nbsp;before&nbsp;any&nbsp;more&nbsp;advanced&nbsp;tests&nbsp;are&nbsp;worth&nbsp;performing.&lt;br&gt;<br>
Their&nbsp;results&nbsp;will&nbsp;be&nbsp;invalid&nbsp;until&nbsp;Squid&nbsp;has&nbsp;an&nbsp;operational&nbsp;TLS&nbsp;context.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&nbsp;rel=&quot;noreferrer&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
