<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;secure&nbsp;ICAP&nbsp;connections&nbsp;between&nbsp;my&nbsp;Squid&nbsp;proxy&nbsp;and&nbsp;my&nbsp;ICAP&nbsp;Server.&nbsp;On&nbsp;my&nbsp;ICAP&nbsp;Server,&nbsp;i&nbsp;use&nbsp;stunnel&nbsp;with&nbsp;this&nbsp;configuration&nbsp;file&nbsp;(with&nbsp;self&nbsp;signed&nbsp;certificate):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;cert&nbsp;=&nbsp;crt.pem&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;key=&nbsp;key.pem&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;CAfile=crt.pem&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;[icaps]&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;accept&nbsp;= &lt;a&nbsp;href=&quot;http://10.2.2.236:11344/&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344&lt;/a&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;connect&nbsp;= &lt;a&nbsp;href=&quot;http://10.2.2.236:1344/&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:1344&lt;/a&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;squid.conf&nbsp;file&nbsp;on&nbsp;the&nbsp;proxy&nbsp;Squid:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;icap_enable&nbsp;on&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;icap_send_client_ip&nbsp;on&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;icap_service&nbsp;service_req&nbsp;reqmod_precache&nbsp;icaps://&lt;a&nbsp;href=&quot;http://10.2.2.236:11344/request&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344/request&lt;/a&gt; tls-cafile=crt.pem&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;adaptation_access&nbsp;service_req&nbsp;allow&nbsp;all&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;//to&nbsp;decrypt&nbsp;ssl&nbsp;traffic&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;&lt;div&gt;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;cert=/usr/local/squid/etc/ssl_cert/myCA.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;/div&gt;&lt;div&gt;sslcrtd_program&nbsp;/usr/local/squid/libexec/security_file_certgen&nbsp;-s&nbsp;/usr/local/squid/var/logs/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;bump&nbsp;all&lt;/div&gt;&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;However&nbsp;i&nbsp;have&nbsp;still&nbsp;these&nbsp;errors:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &lt;i&gt;WARNING:&nbsp;Squid&nbsp;got&nbsp;an&nbsp;invalid&nbsp;ICAP&nbsp;OPTIONS&nbsp;response&nbsp;from&nbsp;service&nbsp;icaps://&lt;a&nbsp;href=&quot;http://10.2.2.236:11344/request&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344/request&lt;/a&gt;;&nbsp;error:&nbsp;unsupported&nbsp;status&nbsp;code&nbsp;of&nbsp;OPTIONS&nbsp;response&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;2019/05/06&nbsp;17:50:27&nbsp;kid1|&nbsp;essential&nbsp;ICAP&nbsp;service&nbsp;is&nbsp;down&nbsp;after&nbsp;an&nbsp;options&nbsp;fetch&nbsp;failure:&nbsp;icaps://&lt;a&nbsp;href=&quot;http://10.2.2.236:11344/request&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344/request&lt;/a&gt; [down,!valid]&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;2019/05/06&nbsp;17:53:28&nbsp;kid1|&nbsp;WARNING:&nbsp;Squid&nbsp;got&nbsp;an&nbsp;invalid&nbsp;ICAP&nbsp;OPTIONS&nbsp;response&nbsp;from&nbsp;service&nbsp;icaps://&lt;a&nbsp;href=&quot;http://10.2.2.236:11344/request&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344/request&lt;/a&gt;;&nbsp;error:&nbsp;unsupported&nbsp;status&nbsp;code&nbsp;of&nbsp;OPTIONS&nbsp;response&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;2019/05/06&nbsp;17:56:28&nbsp;kid1|&nbsp;WARNING:&nbsp;Squid&nbsp;got&nbsp;an&nbsp;invalid&nbsp;ICAP&nbsp;OPTIONS&nbsp;response&nbsp;from&nbsp;service&nbsp;icaps://&lt;a&nbsp;href=&quot;http://10.2.2.236:11344/request&quot;&nbsp;target=&quot;_blank&quot;&gt;10.2.2.236:11344/request&lt;/a&gt;;&nbsp;error:&nbsp;unsupported&nbsp;status&nbsp;code&nbsp;of&nbsp;OPTIONS&nbsp;response&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;from&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;stunnel&nbsp;logs&nbsp;the&nbsp;ssl&nbsp;initiation&nbsp;worked&nbsp;fine&nbsp;but&nbsp;it&nbsp;can&#39;t&nbsp;connect to&nbsp;the&nbsp;port1344I&nbsp;ensure&nbsp;that&nbsp;non&nbsp;secure&nbsp;ICAP&nbsp;works&nbsp;perfectly&nbsp;and&nbsp;my&nbsp;iptables&nbsp;rules&nbsp;are&nbsp;fine.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;your&nbsp;help.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Kind&nbsp;regards,&lt;/div&gt;&lt;div&gt;Tran&nbsp;Dac.&lt;/div&gt;&lt;/div&gt;<br>

</tt>
