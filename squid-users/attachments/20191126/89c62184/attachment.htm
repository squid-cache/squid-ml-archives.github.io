<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi&nbsp;Alex,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;i&nbsp;have&nbsp;done&nbsp;some&nbsp;more&nbsp;troubleshooting&nbsp;and&nbsp;my&nbsp;external&nbsp;proxy&nbsp;is&nbsp;good,&nbsp;i&nbsp;get&nbsp;no&nbsp;errors&nbsp;and&nbsp;i&nbsp;have&nbsp;got&nbsp;one&nbsp;of&nbsp;my&nbsp;DMZ&nbsp;hosts&nbsp;connected&nbsp;to&nbsp;it&nbsp;and&nbsp;i&nbsp;can&nbsp;browse&nbsp;the&nbsp;web,&nbsp;but&nbsp;my&nbsp;internal&nbsp;proxy&nbsp;cant&nbsp;contact&nbsp;my&nbsp;external&nbsp;proxy,&nbsp;this&nbsp;is&nbsp;the&nbsp;error&nbsp;when&nbsp;i&nbsp;run&nbsp;it&nbsp;-&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2019/11/26&nbsp;22:53:28|&nbsp;Error&nbsp;parsing&nbsp;SSL&nbsp;Server&nbsp;Hello&nbsp;Message&nbsp;on&nbsp;FD&nbsp;15&lt;br&gt;2019/11/26&nbsp;22:53:28|&nbsp;ERROR:&nbsp;negotiating&nbsp;TLS&nbsp;on&nbsp;FD&nbsp;15:&nbsp;error:140770FC:SSL&nbsp;routines:SSL23_GET_SERVER_HELLO:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unknown&nbsp;protocol&nbsp;(1/-1/0)&lt;br&gt;2019/11/26&nbsp;22:53:28|&nbsp;TCP&nbsp;connection&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://172.16.55.21/3128&quot;&gt;172.16.55.21/3128&lt;/a&gt;&nbsp;failed&lt;br&gt;2019/11/26&nbsp;22:53:28|&nbsp;Detected&nbsp;DEAD&nbsp;Parent:&nbsp;172.16.55.21&lt;br&gt;2019/11/26&nbsp;22:53:28|&nbsp;Error&nbsp;negotiating&nbsp;SSL&nbsp;connection&nbsp;on&nbsp;FD&nbsp;13:&nbsp;error:00000001:lib(0):func(0):reason(1)&nbsp;(&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1/0)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;this&nbsp;is&nbsp;my&nbsp;config&nbsp;on&nbsp;my&nbsp;internal&nbsp;proxy&nbsp;-&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&lt;br&gt;#&nbsp;Recommended&nbsp;minimum&nbsp;configuration:&lt;br&gt;#&lt;br&gt;&lt;br&gt;#SSL&lt;br&gt;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;\&lt;br&gt;cert=/etc/squid/ssl_cert/myCA.pem&nbsp;\&lt;br&gt;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;sslcrtd_program&nbsp;/usr/local/squid/libexec/security_file_certgen&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;&lt;br&gt;#&nbsp;Example&nbsp;rule&nbsp;allowing&nbsp;access&nbsp;from&nbsp;your&nbsp;local&nbsp;networks.&lt;br&gt;#&nbsp;Adapt&nbsp;to&nbsp;list&nbsp;your&nbsp;(internal)&nbsp;IP&nbsp;networks&nbsp;from&nbsp;where&nbsp;browsing&lt;br&gt;#&nbsp;should&nbsp;be&nbsp;allowed&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;0.0.0.1-0.255.255.255&nbsp; #&nbsp;RFC&nbsp;1122&nbsp;&quot;this&quot;&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://100.64.0.0/10&quot;&gt;100.64.0.0/10&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;6598&nbsp;shared&nbsp;address&nbsp;space&nbsp;(CGN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://169.254.0.0/16&quot;&gt;169.254.0.0/16&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;3927&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;br&gt;&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;ftp&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;https&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;gopher&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;wais&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp; #&nbsp;unregistered&nbsp;ports&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http-mgmt&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;gss-http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;filemaker&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;multiling&nbsp;http&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;&lt;br&gt;#squid&nbsp;proxy&nbsp;in&nbsp;DMZ&nbsp;on&nbsp;internet&lt;br&gt;cache_peer&nbsp;172.16.55.21&nbsp;parent&nbsp;3128&nbsp;0&nbsp;default&lt;br&gt;acl&nbsp;all&nbsp;src&nbsp;all&lt;br&gt;http_access&nbsp;allow&nbsp;all&lt;br&gt;never_direct&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;#&lt;br&gt;#&nbsp;Recommended&nbsp;minimum&nbsp;Access&nbsp;Permission&nbsp;configuration:&lt;br&gt;#&lt;br&gt;#&nbsp;Deny&nbsp;requests&nbsp;to&nbsp;certain&nbsp;unsafe&nbsp;ports&lt;br&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;&lt;br&gt;#&nbsp;Deny&nbsp;CONNECT&nbsp;to&nbsp;other&nbsp;than&nbsp;secure&nbsp;SSL&nbsp;ports&lt;br&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;&lt;br&gt;#&nbsp;Only&nbsp;allow&nbsp;cachemgr&nbsp;access&nbsp;from&nbsp;localhost&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;http_access&nbsp;deny&nbsp;manager&lt;br&gt;&lt;br&gt;#&nbsp;We&nbsp;strongly&nbsp;recommend&nbsp;the&nbsp;following&nbsp;be&nbsp;uncommented&nbsp;to&nbsp;protect&nbsp;innocent&lt;br&gt;#&nbsp;web&nbsp;applications&nbsp;running&nbsp;on&nbsp;the&nbsp;proxy&nbsp;server&nbsp;who&nbsp;think&nbsp;the&nbsp;only&lt;br&gt;#&nbsp;one&nbsp;who&nbsp;can&nbsp;access&nbsp;services&nbsp;on&nbsp;&quot;localhost&quot;&nbsp;is&nbsp;a&nbsp;local&nbsp;user&lt;br&gt;#http_access&nbsp;deny&nbsp;to_localhost&lt;br&gt;&lt;br&gt;#&lt;br&gt;#&nbsp;INSERT&nbsp;YOUR&nbsp;OWN&nbsp;RULE(S)&nbsp;HERE&nbsp;TO&nbsp;ALLOW&nbsp;ACCESS&nbsp;FROM&nbsp;YOUR&nbsp;CLIENTS&lt;br&gt;#&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;my&nbsp;external&nbsp;proxy&nbsp;uses&nbsp;the&nbsp;same&nbsp;config&nbsp;but&nbsp;without&nbsp;the&nbsp;lines&nbsp;&quot;squid&nbsp;proxy&nbsp;in&nbsp;DMZ&nbsp;on&nbsp;internet&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;thanks,&lt;/div&gt;&lt;div&gt;rob&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Tue,&nbsp;26&nbsp;Nov&nbsp;2019&nbsp;at&nbsp;16:59,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;11/26/19&nbsp;10:54&nbsp;AM,&nbsp;robert&nbsp;k&nbsp;Wild&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;as&nbsp;i&nbsp;have&nbsp;configured&nbsp;both&nbsp;internal&nbsp;proxy&nbsp;(non&nbsp;internet&nbsp;facing)&nbsp;and&lt;br&gt;<br>
&gt;&nbsp;external&nbsp;proxy&nbsp;(internet&nbsp;facing)&nbsp;from&nbsp;source,&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Please&nbsp;show&nbsp;the&nbsp;essential&nbsp;parts&nbsp;of&nbsp;both&nbsp;internal&nbsp;and&nbsp;external&nbsp;Squid&lt;br&gt;<br>
configurations&nbsp;for&nbsp;the&nbsp;broken&nbsp;setup&nbsp;(at&nbsp;least).&lt;br&gt;<br>
&lt;br&gt;<br>
It&nbsp;is&nbsp;difficult&nbsp;to&nbsp;guess&nbsp;what&nbsp;went&nbsp;wrong&nbsp;because&nbsp;the&nbsp;guide&nbsp;you&nbsp;are&lt;br&gt;<br>
quoting&nbsp;does&nbsp;not&nbsp;talk&nbsp;about&nbsp;internal&nbsp;and&nbsp;external&nbsp;proxy&nbsp;instances&nbsp;_and_,&lt;br&gt;<br>
in&nbsp;most&nbsp;cases,&nbsp;simply&nbsp;adding&nbsp;a&nbsp;valid&nbsp;http_port&nbsp;line&nbsp;has&nbsp;no&nbsp;effect&nbsp;on&lt;br&gt;<br>
test&nbsp;cases&nbsp;that&nbsp;worked&nbsp;before&nbsp;--&nbsp;the&nbsp;new&nbsp;port&nbsp;will&nbsp;be&nbsp;unused&nbsp;by&nbsp;the&nbsp;old&lt;br&gt;<br>
test&nbsp;traffic.&nbsp;It&nbsp;is&nbsp;not&nbsp;even&nbsp;clear&nbsp;which&nbsp;proxy&nbsp;you&nbsp;are&nbsp;adding&nbsp;the&lt;br&gt;<br>
SslBump&nbsp;configuration&nbsp;to.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thank&nbsp;you,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;followed&nbsp;this&nbsp;guide&nbsp;-&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;it&nbsp;works&nbsp;if&nbsp;i&nbsp;comment&nbsp;out&nbsp;the&nbsp;ssl&nbsp;lines&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#SSL&lt;br&gt;<br>
&gt;&nbsp;#http_port&nbsp;3128&nbsp;ssl-bump&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;#cert=/etc/squid/ssl_cert/myCA.pem&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;#generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;<br>
&gt;&nbsp;#sslcrtd_program&nbsp;/usr/local/squid/libexec/security_file_certgen&nbsp;-s&lt;br&gt;<br>
&gt;&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&gt;&nbsp;#acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;#ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
&gt;&nbsp;#ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;as&nbsp;soon&nbsp;as&nbsp;i&nbsp;uncomment&nbsp;them&nbsp;it&nbsp;breaks&nbsp;the&nbsp;link&nbsp;between&nbsp;both&nbsp;servers&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;this&nbsp;is&nbsp;the&nbsp;error&nbsp;i&nbsp;get&nbsp;from&nbsp;the&nbsp;internal&nbsp;proxy&nbsp;when&nbsp;it&nbsp;tries&nbsp;to&nbsp;contact&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;external&nbsp;proxy&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://i.postimg.cc/JzC29gh8/ssl.png&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://i.postimg.cc/JzC29gh8/ssl.png&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;--&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Regards,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Robert&nbsp;K&nbsp;Wild.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Regards,&nbsp;&lt;br&gt;&lt;br&gt;Robert&nbsp;K&nbsp;Wild.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
