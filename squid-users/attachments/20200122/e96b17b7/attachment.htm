<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;<br>
Message:&nbsp;5&lt;br&gt;<br>
Date:&nbsp;Wed,&nbsp;22&nbsp;Jan&nbsp;2020&nbsp;18:36:37&nbsp;+1300&lt;br&gt;<br>
From:&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&lt;br&gt;<br>
To:&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
Subject:&nbsp;Re:&nbsp;[squid-users]&nbsp;Issues&nbsp;with&nbsp;TLS&nbsp;inspection&nbsp;Intercept&nbsp;Mode.&lt;br&gt;<br>
Message-ID:&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:2fa147c4-e499-9244-d2d1-c52438e2f4f4@treenet.co.nz&quot;&nbsp;target=&quot;_blank&quot;&gt;2fa147c4-e499-9244-d2d1-c52438e2f4f4@treenet.co.nz&lt;/a&gt;&gt;&lt;br&gt;<br>
Content-Type:&nbsp;text/plain;&nbsp;charset=utf-8&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;22/01/20&nbsp;7:39&nbsp;am,&nbsp;aashutosh&nbsp;kalyankar&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;problem&nbsp;I&nbsp;am&nbsp;seeing&nbsp;is&nbsp;the&nbsp;intercept&nbsp;port&nbsp;initiates&nbsp;HTTP&nbsp;connection&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;self-IP&nbsp;instead&nbsp;of&nbsp;the&nbsp;web&nbsp;server&nbsp;IP&nbsp;it&nbsp;gets&nbsp;from&nbsp;the&nbsp;DNS&nbsp;request.&lt;br&gt;<br>
&lt;br&gt;<br>
Neither&nbsp;of&nbsp;those&nbsp;IPs&nbsp;should&nbsp;be&nbsp;used.&lt;br&gt;<br>
&lt;br&gt;<br>
Self-IP&nbsp;indicates&nbsp;that&nbsp;the&nbsp;traffic&nbsp;is&nbsp;being&nbsp;delivered&nbsp;to&nbsp;the&nbsp;proxy&nbsp;port&lt;br&gt;<br>
as&nbsp;explicit&nbsp;proxy&nbsp;traffic.&nbsp;Or&nbsp;that&nbsp;the&nbsp;NAT&nbsp;system&nbsp;is&nbsp;broken.&nbsp;We&nbsp;usually&lt;br&gt;<br>
get&nbsp;this&nbsp;complaint&nbsp;from&nbsp;people&nbsp;who&nbsp;are&nbsp;testing&nbsp;their&nbsp;proxy&nbsp;by&nbsp;sending&lt;br&gt;<br>
traffic&nbsp;directly&nbsp;to&nbsp;the&nbsp;proxy&nbsp;port.&lt;br&gt;<br>
&lt;br&gt;<br>
DNS&nbsp;is&nbsp;only&nbsp;involved&nbsp;to&nbsp;validate&nbsp;the&nbsp;HTTP&nbsp;Host&nbsp;header&nbsp;against&nbsp;the&nbsp;IP&lt;br&gt;<br>
address&nbsp;to&nbsp;forbid&nbsp;caching&nbsp;dangerous&nbsp;contents.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp; Filtered Tcpdump&lt;br&gt;<br>
&gt;&nbsp;screenshot @ &lt;a&nbsp;href=&quot;https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Screenshots&nbsp;are&nbsp;rarely&nbsp;useful.&nbsp;You&nbsp;are&nbsp;logging&nbsp;level&nbsp;11,3&nbsp;to&nbsp;cache.log,&lt;br&gt;<br>
so&nbsp;there&nbsp;should&nbsp;be&nbsp;full&nbsp;HTTP&nbsp;message&nbsp;traces&nbsp;with&nbsp;related&nbsp;connection&lt;br&gt;<br>
details&nbsp;and&nbsp;flow&nbsp;direction&nbsp;(client&nbsp;vs&nbsp;server).&nbsp;That&nbsp;would&nbsp;be&nbsp;more&nbsp;useful.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;I&nbsp;do&nbsp;see&nbsp;in&nbsp;the&nbsp;image&nbsp;is&nbsp;several&nbsp;&quot;GET&nbsp;http://&quot;&nbsp;lines.&nbsp;That&lt;br&gt;<br>
absolute-form&nbsp;URL&nbsp;syntax&nbsp;is&nbsp;for&nbsp;explicit&nbsp;proxy&nbsp;traffic.&nbsp;Traffic&lt;br&gt;<br>
intercepted&nbsp;from&nbsp;port&nbsp;80&nbsp;or&nbsp;443&nbsp;would&nbsp;use&nbsp;origin-form&nbsp;URLs.&lt;br&gt;<br>
 -&nbsp;This&nbsp;reinforces&nbsp;the&nbsp;idea&nbsp;that&nbsp;you&nbsp;are&nbsp;probably&nbsp;testing&nbsp;the&nbsp;proxy&lt;br&gt;<br>
wrong&nbsp;-&nbsp;eg&nbsp;direct&nbsp;curl&nbsp;requests&nbsp;to&nbsp;the&nbsp;proxy?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Server&nbsp;IP:&nbsp;Eth0:&nbsp;IP:&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148/26&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.22.22.148/26&lt;/a&gt;&nbsp;(Same&lt;br&gt;<br>
&gt;&nbsp;eth0&nbsp;interface&nbsp;reaches&nbsp;the&nbsp;internet&nbsp;gateway).&lt;br&gt;<br>
&gt;&nbsp;Configurations&nbsp;for &lt;br&gt;<br>
&gt;&nbsp;1)&nbsp;Nat&nbsp;table: &lt;br&gt;<br>
&gt;&nbsp;Chain&nbsp;PREROUTING(policy&nbsp;ACCEPT&nbsp;23&nbsp;packets,&nbsp;1632&nbsp;bytes)&lt;br&gt;<br>
&gt;&nbsp;num&nbsp; &nbsp;pkts&nbsp;bytes&nbsp;target&nbsp; &nbsp; &nbsp;prot&nbsp;opt&nbsp;in &nbsp; &nbsp;out&nbsp; &nbsp;source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;br&gt;<br>
&gt;&nbsp;destination&nbsp; &nbsp; &lt;br&gt;<br>
&gt;&nbsp;1&nbsp; &nbsp; &nbsp; &nbsp;66&nbsp;3960&nbsp;REDIRECT&nbsp; &nbsp;tcp&nbsp;--&nbsp;eth0&nbsp;*&nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;0.0.0.0/0&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;0.0.0.0/0&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp;dpt:80&nbsp;/*&lt;br&gt;<br>
&gt;&nbsp;Redirect&nbsp;http&nbsp;traffic&nbsp;eth0:80&nbsp;to&nbsp;eth0:3128&nbsp;*/&nbsp;redir&nbsp;ports&nbsp;3128&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;are&nbsp;missing&nbsp;the&nbsp;PREROUTING&nbsp;rule&nbsp;which&nbsp;would&nbsp;ACCEPT&nbsp;traffic&nbsp;outbound&lt;br&gt;<br>
from&nbsp;the&nbsp;proxy&nbsp;to&nbsp;port&nbsp;80.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;As&nbsp;suggested,&nbsp;taking&nbsp;reference&nbsp;from&nbsp;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect&quot;&gt;https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect&lt;/a&gt;,&nbsp;I&nbsp;added&nbsp;the&nbsp;following&nbsp;rules.&nbsp;The&nbsp;only&nbsp;additional&nbsp;part&nbsp;is&nbsp;the&nbsp;Separation&nbsp;of&nbsp;HTTP&nbsp;and&nbsp;HTTPS&nbsp;traffic&nbsp;rules.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;trebuchet&nbsp;ms,&nbsp;sans-serif&quot;&gt;&lt;b&gt;NAT&nbsp;TABLE&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt;&lt;b&gt; Chain&nbsp;PREROUTING&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt; 1&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0&nbsp;ACCEPT&nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;172.22.22.148&nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:80&nbsp;/*&nbsp;Accept&nbsp;http&nbsp;traffic&nbsp;at&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:80&quot;&gt;172.22.22.148:80&lt;/a&gt;&nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt;2&nbsp; &nbsp; &nbsp; &nbsp;79&nbsp; 4740&nbsp;REDIRECT&nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:80&nbsp;/*&nbsp;Redirect&nbsp;eth0:80&nbsp;to&nbsp;eth0:3129&nbsp;*/&nbsp;redir&nbsp;ports&nbsp;3129&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;3&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0&nbsp;ACCEPT&nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;172.22.22.148&nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:443&nbsp;/*&nbsp;Accept&nbsp;https&nbsp;traffic&nbsp;at&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:443&quot;&gt;172.22.22.148:443&lt;/a&gt;&nbsp;*/&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;size=&quot;1&quot;&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;4&nbsp; &nbsp; &nbsp; 565&nbsp;33900&nbsp;REDIRECT&nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:443&nbsp;/*&nbsp;Redirect&nbsp;eth0:443&nbsp;to&nbsp;eth0:3130&nbsp;*/&nbsp;redir&nbsp;ports&nbsp;3130&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;&lt;b&gt;Chain&nbsp;POSTROUTING&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;1&nbsp; &nbsp; &nbsp;365K&nbsp; &nbsp;23M&nbsp;MASQUERADE&nbsp; all&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp; Allows&nbsp;NAT&nbsp;To&nbsp;happen&nbsp;*/&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;trebuchet&nbsp;ms,&nbsp;sans-serif&quot;&gt;&lt;b&gt;Mangle&nbsp;Table &lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;size=&quot;1&quot;&gt;&lt;b&gt;Chain&nbsp;PREROUTING&lt;font&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;1&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0&nbsp;DROP&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:3129&lt;br&gt;2&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp;0&nbsp;DROP&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:3130&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt; This&nbsp;config&nbsp;page&nbsp;details&nbsp;what&nbsp;you&nbsp;need&nbsp;for&nbsp;REDIRECT&nbsp;interception&nbsp;on&lt;br&gt;<br>
iptables:&lt;br&gt;<br>
 &lt;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Note&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;place&nbsp;the&nbsp;intercept&nbsp;flag&nbsp;on&nbsp;port&nbsp;3128.&nbsp;That&nbsp;is&lt;br&gt;<br>
because&nbsp;Squid&nbsp;will&nbsp;generate&nbsp;URLs&nbsp;with&nbsp;its&nbsp;hostname&nbsp;and&nbsp;that&nbsp;port&nbsp;for&lt;br&gt;<br>
clients&nbsp;to&nbsp;use&nbsp;directly&nbsp;when&nbsp;needed&nbsp;(error&nbsp;page&nbsp;contents,&nbsp;manager&lt;br&gt;<br>
reports,&nbsp;etc).&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;Using&nbsp;ports&nbsp;3129&nbsp;for&nbsp;http&nbsp;and&nbsp;3130&nbsp;for&nbsp;https. &lt;/font&gt;&lt;/div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:3129&quot;&gt;172.22.22.148:3129&lt;/a&gt;&nbsp;intercept&lt;br&gt;https_port&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:3130&quot;&gt;172.22.22.148:3130&lt;/a&gt;&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_certs/myCA.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;/font&gt;&lt;br&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;I&nbsp;am&nbsp;missing&nbsp;some&nbsp;conf&nbsp;or&nbsp;the&nbsp;next&nbsp;steps&nbsp;I&nbsp;should&lt;br&gt;<br>
&gt;&nbsp;try&nbsp;to&nbsp;get&nbsp;this&nbsp;running.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Firstly,&nbsp;add&nbsp;that&nbsp;missing&nbsp;NAT&nbsp;rule.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
Secondly,&nbsp;make&nbsp;sure&nbsp;that&nbsp;your&nbsp;tests&nbsp;are&nbsp;accurately&nbsp;emulating&nbsp;how&nbsp;clients&lt;br&gt;<br>
would&nbsp;&quot;use&quot;&nbsp;the&nbsp;proxy.&nbsp;That&nbsp;means&nbsp;making&nbsp;connections&nbsp;from&nbsp;a&nbsp;test&nbsp;machine&lt;br&gt;<br>
directly&nbsp;to&nbsp;the&nbsp;Internet&nbsp;and&nbsp;seeing&nbsp;if&nbsp;the&nbsp;routing&nbsp;and&nbsp;NAT&nbsp;delivers&nbsp;the&lt;br&gt;<br>
traffic&nbsp;to&nbsp;Squid&nbsp;properly.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;using&nbsp;a&nbsp;chromebook&nbsp;to&nbsp;test.&nbsp;In&nbsp;the&nbsp;configuration&nbsp;section&nbsp;of&nbsp;the&nbsp;wireless&nbsp;network&nbsp;there&nbsp;is&nbsp;an&nbsp;option&nbsp;to&nbsp;add&nbsp;proxy&nbsp;hostname&nbsp;and&nbsp;proxy&nbsp;port&nbsp;based&nbsp;on&nbsp;protocols.  &lt;/div&gt;&lt;div&gt;Http&nbsp;proxy &nbsp; &nbsp; : &nbsp;proxy-tls&nbsp;80&lt;/div&gt;&lt;div&gt;HTTPS&nbsp;proxy: &nbsp;proxy-tls&nbsp;443&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
 -&nbsp;Use&nbsp;cache.log&nbsp;to&nbsp;view&nbsp;the&nbsp;traffic&nbsp;coming&nbsp;into&nbsp;the&nbsp;proxy.&nbsp;It&nbsp;will&nbsp;be&lt;br&gt;<br>
request&nbsp;messages&nbsp;with&nbsp;a&nbsp;prefix&nbsp;line&nbsp;indicating&nbsp;&quot;Client&nbsp;HTTP&nbsp;request&quot;.&lt;br&gt;<br>
Make&nbsp;sure&nbsp;that&nbsp;prefix&nbsp;line&nbsp;says&nbsp;the&nbsp;remote&nbsp;Internet&nbsp;IP&nbsp;address&nbsp;and&nbsp;port&lt;br&gt;<br>
80/443&nbsp;you&nbsp;were&nbsp;testing&nbsp;with.&lt;br&gt;<br>
 -&nbsp;If&nbsp;you&nbsp;want&nbsp;confirm&nbsp;that&nbsp;access.log&nbsp;has&nbsp;a&nbsp;transaction&nbsp;entry&nbsp;for&nbsp;the&lt;br&gt;<br>
URL&nbsp;you&nbsp;tested&nbsp;with&nbsp;ORIGINAL_DST&nbsp;and&nbsp;the&nbsp;server&nbsp;IP.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;Sample&nbsp;cache.log&nbsp;for&nbsp;a&nbsp;test&nbsp;I&nbsp;did&nbsp;for&nbsp;&lt;a&nbsp;href=&quot;http://neverssl.com&quot;&gt;neverssl.com&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&nbsp;size=&quot;1&quot;&gt;2020/01/22&nbsp;17:08:30.236&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2346)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;local=&lt;a&nbsp;href=&quot;http://172.22.22.148:80&quot;&gt;172.22.22.148:80&lt;/a&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://172.22.22.151:34728&quot;&gt;172.22.22.151:34728&lt;/a&gt;&nbsp;FD&nbsp;12&nbsp;flags=33&lt;br&gt;2020/01/22&nbsp;17:08:30.236&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(2347)&nbsp;parseHttpRequest:&nbsp;HTTP&nbsp;Client&nbsp;REQUEST:&lt;br&gt;---------&lt;br&gt;GET&nbsp;&lt;a&nbsp;href=&quot;http://neverssl.com/&quot;&gt;http://neverssl.com/&lt;/a&gt;&nbsp;HTTP/1.1&lt;br&gt;Host:&nbsp;&lt;a&nbsp;href=&quot;http://neverssl.com&quot;&gt;neverssl.com&lt;/a&gt;&lt;br&gt;Proxy-Connection:&nbsp;keep-alive&lt;br&gt;DNT:&nbsp;1&lt;br&gt;Upgrade-Insecure-Requests:&nbsp;1&lt;br&gt;User-Agent:&nbsp;Mozilla/5.0&nbsp;(X11;&nbsp;CrOS&nbsp;x86_64&nbsp;12499.12.0)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/78.0.3904.26&nbsp;Safari/537.36&lt;br&gt;Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&lt;br&gt;Accept-Encoding:&nbsp;gzip,&nbsp;deflate&lt;br&gt;Accept-Language:&nbsp;en-US,en;q=0.9,en-GB;q=0.8,ar;q=0.7&lt;br&gt;&lt;br&gt;&lt;br&gt;----------&lt;br&gt;2020/01/22&nbsp;17:08:30.249&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(774)&nbsp;storeCreatePureEntry:&nbsp;storeCreateEntry:&nbsp;&#39;&lt;a&nbsp;href=&quot;http://neverssl.com/&quot;&gt;http://neverssl.com/&lt;/a&gt;&#39;&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;MemObject.cc(97)&nbsp;MemObject:&nbsp;new&nbsp;MemObject&nbsp;0x7f3055a51990&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(499)&nbsp;setReleaseFlag:&nbsp;StoreEntry::setReleaseFlag:&nbsp;&#39;[null_store_key]&#39;&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;store_key_md5.cc(89)&nbsp;storeKeyPrivate:&nbsp;storeKeyPrivate:&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;http://neverssl.com/&quot;&gt;http://neverssl.com/&lt;/a&gt;&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(447)&nbsp;hashInsert:&nbsp;StoreEntry::hashInsert:&nbsp;Inserting&nbsp;Entry&nbsp;e:=XI/0x7f3055a51910*0&nbsp;key&nbsp;&#39;17D405610D6C945224B64DBB3180E9CB&#39;&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(483)&nbsp;lock:&nbsp;storeCreateEntry&nbsp;locked&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=XIV/0x7f3055a51910*1&lt;br&gt;2020/01/22&nbsp;17:08:30.250&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(483)&nbsp;lock:&nbsp;clientReplyContext::setReplyToStoreEntry&nbsp;locked&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=XIV/0x7f3055a51910*2&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(483)&nbsp;lock:&nbsp;StoreEntry::storeErrorResponse&nbsp;locked&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=XIV/0x7f3055a51910*3&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(1862)&nbsp;replaceHttpReply:&nbsp;StoreEntry::replaceHttpReply:&nbsp;&lt;a&nbsp;href=&quot;http://neverssl.com/&quot;&gt;http://neverssl.com/&lt;/a&gt;&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(949)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(1048)&nbsp;complete:&nbsp;storeComplete:&nbsp;&#39;17D405610D6C945224B64DBB3180E9CB&#39;&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(1337)&nbsp;validLength:&nbsp;storeEntryValidLength:&nbsp;Checking&nbsp;&#39;17D405610D6C945224B64DBB3180E9CB&#39;&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,2|&nbsp;store.cc(949)&nbsp;checkCachable:&nbsp;StoreEntry::checkCachable:&nbsp;NO:&nbsp;not&nbsp;cachable&lt;br&gt;2020/01/22&nbsp;17:08:30.258&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(521)&nbsp;unlock:&nbsp;StoreEntry::storeErrorResponse&nbsp;unlocking&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=sXINV/0x7f3055a51910*3&lt;br&gt;2020/01/22&nbsp;17:08:30.259&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(483)&nbsp;lock:&nbsp;store_client::copy&nbsp;locked&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=sXINV/0x7f3055a51910*3&lt;br&gt;2020/01/22&nbsp;17:08:30.259&nbsp;kid1|&nbsp;20,3|&nbsp;store.cc(483)&nbsp;lock:&nbsp;ClientHttpRequest::loggingEntry&nbsp;locked&nbsp;key&nbsp;17D405610D6C945224B64DBB3180E9CB&nbsp;e:=sXINV/0x7f3055a51910*4&lt;br&gt;2020/01/22&nbsp;17:08:30.259&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(1392)&nbsp;sendStartOfMessage:&nbsp;HTTP&nbsp;Client&nbsp;local=&lt;a&nbsp;href=&quot;http://172.22.22.148:80&quot;&gt;172.22.22.148:80&lt;/a&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://172.22.22.151:34728&quot;&gt;172.22.22.151:34728&lt;/a&gt;&nbsp;FD&nbsp;12&nbsp;flags=33&lt;br&gt;2020/01/22&nbsp;17:08:30.259&nbsp;kid1|&nbsp;11,2|&nbsp;client_side.cc(1393)&nbsp;sendStartOfMessage:&nbsp;HTTP&nbsp;Client&nbsp;REPLY:&lt;br&gt;---------&lt;br&gt;HTTP/1.1&nbsp;403&nbsp;Forbidden&lt;br&gt;Server:&nbsp;squid/3.5.19&lt;br&gt;Mime-Version:&nbsp;1.0&lt;br&gt;Date:&nbsp;Thu,&nbsp;23&nbsp;Jan&nbsp;2020&nbsp;01:08:30&nbsp;GMT&lt;br&gt;Content-Type:&nbsp;text/html;charset=utf-8&lt;br&gt;Content-Length:&nbsp;3861&lt;br&gt;X-Squid-Error:&nbsp;ERR_ACCESS_DENIED&nbsp;0&lt;br&gt;Vary:&nbsp;Accept-Language&lt;br&gt;Content-Language:&nbsp;en-us&lt;br&gt;X-Cache:&nbsp;MISS&nbsp;from&nbsp;proxy-tls&lt;br&gt;X-Cache-Lookup:&nbsp;NONE&nbsp;from&nbsp;proxy-tls:8080&lt;br&gt;Via:&nbsp;1.1&nbsp;proxy-tls&nbsp;(squid/3.5.19)&lt;br&gt;Connection:&nbsp;keep-alive&lt;/font&gt;&lt;br&gt;&lt;br&gt;complete&nbsp;file:&lt;a&nbsp;href=&quot;https://pastebin.com/iBvy9naz&quot;&gt;https://pastebin.com/iBvy9naz&lt;/a&gt;&lt;br&gt;&lt;div&gt;---------- &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thirdly,&nbsp;some&nbsp;squid.conf&nbsp;improvements&nbsp;for&nbsp;other&nbsp;problems&nbsp;you&nbsp;have&nbsp;either&lt;br&gt;<br>
not&nbsp;noticed&nbsp;or&nbsp;not&nbsp;encountered&nbsp;yet:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;3)&nbsp;Squid.conf&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
...&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;my_machine&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.0/24&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.22.22.0/24&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;my_machine&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;ap_clients&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.10.0/24&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.10.0/24&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;local_clients&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.18.10.0/24&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.18.10.0/24&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.0/8&lt;/a&gt; &nbsp; &lt;br&gt;<br>
...&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;ap_clients&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;local_clients&lt;br&gt;<br>
&lt;br&gt;<br>
It&nbsp;looks&nbsp;sub-optimal&nbsp;to&nbsp;have&nbsp;these&nbsp;as&nbsp;separate&nbsp;ACLs.&nbsp;May&nbsp;as&nbsp;well&nbsp;use&lt;br&gt;<br>
config&nbsp;comments&nbsp;to&nbsp;document&nbsp;what&nbsp;ranges&nbsp;are&nbsp;which&nbsp;clients&nbsp;and&nbsp;put&nbsp;them&lt;br&gt;<br>
all&nbsp;in&nbsp;localnet&nbsp;(that&nbsp;is&nbsp;what&nbsp;it&nbsp;is&nbsp;for).&lt;br&gt;<br>
&lt;br&gt;<br>
eg:&lt;br&gt;<br>
 #&nbsp;AP&nbsp;clients&lt;br&gt;<br>
 acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.10.0/24&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.10.0/24&lt;/a&gt;&lt;br&gt;<br>
 #&nbsp;Local&nbsp;clients&lt;br&gt;<br>
 acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.18.10.0/24&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.18.10.0/24&lt;/a&gt;&lt;br&gt;<br>
 #&nbsp;LAN&lt;br&gt;<br>
 acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;10.0.0.0/8&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
 http_access&nbsp;allow&nbsp;localnet&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Updated&nbsp;as&nbsp;suggested:) &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;purge&nbsp;method&nbsp;PURGE&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;purge&lt;br&gt;<br>
&lt;br&gt;<br>
PURGE&nbsp;is&nbsp;largely&nbsp;obsoleted&nbsp;(by&nbsp;HTCP&nbsp;CLR&nbsp;feature)&nbsp;and&nbsp;requires&nbsp;Squid&nbsp;to&lt;br&gt;<br>
perform&nbsp;a&nbsp;relatively&nbsp;large&nbsp;amount&nbsp;of&nbsp;processing&nbsp;per-request.&nbsp;Unless&nbsp;you&lt;br&gt;<br>
have&nbsp;tools&nbsp;that&nbsp;use&nbsp;it&nbsp;specifically&nbsp;it&nbsp;is&nbsp;best&nbsp;to&nbsp;remove&nbsp;all&nbsp;mention&nbsp;of&lt;br&gt;<br>
it&nbsp;from&nbsp;the&nbsp;config&nbsp;file&nbsp;to&nbsp;let&nbsp;Squid&nbsp;avoid&nbsp;all&nbsp;that&nbsp;work.&nbsp;If&nbsp;any&nbsp;mention&lt;br&gt;<br>
remains&nbsp;Squid&nbsp;will&nbsp;auto-activate&nbsp;the&nbsp;cache&nbsp;indexing&nbsp;work.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;do&nbsp;have&nbsp;tools&nbsp;using&nbsp;it.&nbsp;Then&nbsp;it&nbsp;is&nbsp;past&nbsp;time&nbsp;to&nbsp;consider/plan&lt;br&gt;<br>
moving&nbsp;those&nbsp;tools&nbsp;and&nbsp;Squid&nbsp;to&nbsp;using&nbsp;HTCP&nbsp;CLR&nbsp;instead.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&lt;br&gt;<br>
 ...&nbsp;this&nbsp;is&nbsp;where&nbsp;all&nbsp;your&nbsp;custom&nbsp;http_access&nbsp;rules&nbsp;are&nbsp;supposed&nbsp;to&nbsp;be.&lt;br&gt;<br>
The&nbsp;Safe_ports&nbsp;and&nbsp;SSL_Ports&nbsp;lines&nbsp;above&nbsp;are&nbsp;DoS&nbsp;and&nbsp;hijack&nbsp;protections.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;IIUC,&nbsp;These&nbsp;are&nbsp;not&nbsp;required&nbsp;to&nbsp;be&nbsp;here&nbsp;so&nbsp;I&nbsp;commented&nbsp;out&nbsp;those&nbsp;lines. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
 *&nbsp;DoS&nbsp;protections&nbsp;need&nbsp;to&nbsp;be&nbsp;first&nbsp;to&nbsp;do&nbsp;their&nbsp;job&nbsp;of&nbsp;minimizing&nbsp;the&lt;br&gt;<br>
CPU&nbsp;impact&nbsp;effectively.&nbsp;It&nbsp;is&nbsp;counter&nbsp;productive&nbsp;to&nbsp;have&nbsp;allow&#39;s&nbsp;earlier&lt;br&gt;<br>
than&nbsp;here.&lt;br&gt;<br>
&lt;br&gt;<br>
 *&nbsp;It&nbsp;is&nbsp;risky&nbsp;to&nbsp;let&nbsp;clients&nbsp;hijack&nbsp;the&nbsp;proxy&nbsp;and&nbsp;Squid&nbsp;cannot&nbsp;handle&lt;br&gt;<br>
native&nbsp;traffic&nbsp;to&nbsp;or&nbsp;from&nbsp;those&nbsp;ports&nbsp;anyway.&nbsp;If&nbsp;you&nbsp;need&nbsp;a&nbsp;specific&lt;br&gt;<br>
port&nbsp;available&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_reply_access&nbsp;allow&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
Above&nbsp;is&nbsp;the&nbsp;default&nbsp;reply&nbsp;handling.&nbsp;No&nbsp;need&nbsp;to&nbsp;specify.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;8080&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:3128&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.22.22.148:3128&lt;/a&gt;&nbsp;intercept&lt;br&gt;<br>
&gt;&nbsp;https_port&nbsp;&lt;a&nbsp;href=&quot;http://172.22.22.148:3129&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.22.22.148:3129&lt;/a&gt;&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_certs/myCA.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_program&nbsp;/usr/lib/squid/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&lt;br&gt;<br>
You&nbsp;do&nbsp;need&nbsp;at&nbsp;least&nbsp;one&nbsp;non-intercept&nbsp;port&nbsp;for&nbsp;the&nbsp;direct-to-proxy&lt;br&gt;<br>
communications&nbsp;that&nbsp;are&nbsp;needed&nbsp;occasionally.&nbsp;Port&nbsp;3128&nbsp;is&nbsp;reserved&nbsp;for&lt;br&gt;<br>
that.&nbsp;It&nbsp;is&nbsp;best&nbsp;to&nbsp;pick&nbsp;a&nbsp;random&nbsp;other&nbsp;port&nbsp;number&nbsp;for&nbsp;the&nbsp;intercepted&lt;br&gt;<br>
traffic&nbsp;to&nbsp;arrive&nbsp;at&nbsp;and&nbsp;leave&nbsp;3128&nbsp;for&nbsp;the&nbsp;normal&nbsp;proxy&nbsp;traffic.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
NP:&nbsp;while&nbsp;this&nbsp;&quot;works&quot;&nbsp;bumping&nbsp;without&nbsp;any&nbsp;details&nbsp;about&nbsp;the&nbsp;server&lt;br&gt;<br>
(obtained&nbsp;at&nbsp;step2)&nbsp;can&nbsp;cause&nbsp;a&nbsp;lot&nbsp;of&nbsp;connection&nbsp;compatibility&nbsp;problems&lt;br&gt;<br>
and&nbsp;undesirable&nbsp;security&nbsp;side&nbsp;effects. &nbsp;Prefer&nbsp;to&nbsp;stare&nbsp;at&nbsp;step2&nbsp;and&lt;br&gt;<br>
bump&nbsp;at&nbsp;step&nbsp;3.&nbsp;Do&nbsp;this&nbsp;step2&nbsp;bump&nbsp;only&nbsp;as&nbsp;a&nbsp;last-resort&nbsp;(ie&nbsp;restrict&nbsp;it&lt;br&gt;<br>
to&nbsp;sites&nbsp;that&nbsp;are&nbsp;broken&nbsp;and&nbsp;cannot&nbsp;be&nbsp;worked&nbsp;around&nbsp;in&nbsp;other&nbsp;ways).&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt; &lt;/div&gt;&lt;div&gt;As&nbsp;suggested,&nbsp;updated&nbsp;it&nbsp;to&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;br&gt;ssl_bump&nbsp;stare&nbsp;step2&lt;br&gt;ssl_bump&nbsp;bump&nbsp;step3&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;host_verify_strict&nbsp;off&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;above&nbsp;is&nbsp;the&nbsp;default,&nbsp;no&nbsp;need&nbsp;to&nbsp;specify.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;oyster-vpn-test&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://oyster-vpn-test.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;oyster-vpn-test.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;cache&nbsp;deny&nbsp;oyster-vpn-test&lt;br&gt;<br>
&gt;&nbsp;visible_hostname&nbsp;&lt;a&nbsp;href=&quot;http://togo.mtv.corp.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;togo.mtv.corp.google.com&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Er&nbsp;...&nbsp;AFAIK&nbsp;Google&nbsp;does&nbsp;not&nbsp;use&nbsp;that&nbsp;domain&nbsp;for&nbsp;their&nbsp;machine&lt;br&gt;<br>
hostnames.&nbsp;You&nbsp;sure&nbsp;you&nbsp;want&nbsp;to&nbsp;advertise&nbsp;your&nbsp;network&nbsp;as&nbsp;*.&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&nbsp;?&lt;br&gt;<br>
&lt;br&gt;<br>
Also,&nbsp;you&nbsp;only&nbsp;need&nbsp;a&nbsp;visible_hostname&nbsp;line&nbsp;if&nbsp;Squid&nbsp;is&nbsp;unable&nbsp;to&nbsp;pull&lt;br&gt;<br>
the&nbsp;machines&nbsp;hostname&nbsp;from&nbsp;the&nbsp;OS&nbsp;configuration.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;your&nbsp;time&nbsp;and&nbsp;help &nbsp;Amos.  &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
------------------------------&lt;br&gt;<br>
&lt;br&gt;<br>
Subject:&nbsp;Digest&nbsp;Footer&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
------------------------------&lt;br&gt;<br>
&lt;br&gt;<br>
End&nbsp;of&nbsp;squid-users&nbsp;Digest,&nbsp;Vol&nbsp;65,&nbsp;Issue&nbsp;30&lt;br&gt;<br>
*******************************************&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
