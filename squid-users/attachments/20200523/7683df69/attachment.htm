<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Squid&nbsp;4.9&lt;/div&gt;&lt;div&gt;Ubuntu&nbsp;18.04.03&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;implement&nbsp;ssl-bumping&nbsp;into&nbsp;the&nbsp;frontend&nbsp;of&nbsp;a&nbsp;squid&nbsp;smp&nbsp;setup,&nbsp;but&nbsp;I&nbsp;keep&nbsp;getting&nbsp;the&nbsp;following&nbsp;error:&lt;div&gt;FATAL:&nbsp;Ipc::Mem::Segment::open&nbsp;failed&nbsp;to&nbsp;shm_open(/squid-tls_session_cache.shm):&nbsp;(2)&nbsp;No&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;shm&nbsp;is&nbsp;working&nbsp;correctly&nbsp;and&nbsp;generating/reading&nbsp;from&nbsp;other&nbsp;squid&nbsp;shm&nbsp;files,&nbsp;but&nbsp;not&nbsp;properly&nbsp;generating&nbsp;this&nbsp;file&nbsp;upon&nbsp;start-up&nbsp;in&nbsp;SMP&nbsp;mode.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;ssl-bump&nbsp;configuration&nbsp;works&nbsp;fine&nbsp;in&nbsp;non-smp&nbsp;mode.&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;guessing&nbsp;it&#39;s&nbsp;some&nbsp;sort&nbsp;of&nbsp;race&nbsp;condition&nbsp;to&nbsp;do&nbsp;with&nbsp;improperly&nbsp;setup&nbsp;config&nbsp;files&nbsp;for&nbsp;ssl-bumping,&nbsp;but&nbsp;unsure&nbsp;of&nbsp;how&nbsp;to&nbsp;correct&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;in&nbsp;advance&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;##########&nbsp;squid.conf&nbsp;#########&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;debug_options&nbsp;ALL,3&lt;br&gt;#&lt;br&gt;#&nbsp;Recommended&nbsp;minimum&nbsp;configuration:&lt;br&gt;#&lt;br&gt;&lt;br&gt;#&nbsp;Example&nbsp;rule&nbsp;allowing&nbsp;access&nbsp;from&nbsp;your&nbsp;local&nbsp;networks.&lt;br&gt;#&nbsp;Adapt&nbsp;to&nbsp;list&nbsp;your&nbsp;(internal)&nbsp;IP&nbsp;networks&nbsp;from&nbsp;where&nbsp;browsing&lt;br&gt;#&nbsp;should&nbsp;be&nbsp;allowed&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;0.0.0.1-0.255.255.255&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;1122&nbsp;&quot;this&quot;&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://100.64.0.0/10&quot;&gt;100.64.0.0/10&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;6598&nbsp;shared&nbsp;address&nbsp;space&nbsp;(CGN)&lt;br&gt;acl&nbsp;localhet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://169.254.0.0/16&quot;&gt;169.254.0.0/16&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;3927&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;br&gt;&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;ftp&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;https&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gopher&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;wais&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;&nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;http-mgmt&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;gss-http&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;filemaker&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;multiling&nbsp;http&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;&lt;br&gt;#&nbsp;Deny&nbsp;requests&nbsp;to&nbsp;certain&nbsp;unsafe&nbsp;ports&lt;br&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;&lt;br&gt;#&nbsp;Deny&nbsp;CONNECT&nbsp;to&nbsp;other&nbsp;than&nbsp;secure&nbsp;SSL&nbsp;ports&lt;br&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;&lt;br&gt;#&nbsp;Only&nbsp;allow&nbsp;cachemgr&nbsp;access&nbsp;from&nbsp;localhost&lt;br&gt;#http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;#http_access&nbsp;deny&nbsp;manager&lt;br&gt;&lt;br&gt;#&nbsp;Set&nbsp;cache&nbsp;user&lt;br&gt;cache_effective_user&nbsp;nobody&lt;/div&gt;&lt;div&gt;&lt;br&gt;workers&nbsp;3&lt;br&gt;if&nbsp;${process_number}&nbsp;=&nbsp;1&lt;br&gt;include&nbsp;/etc/squid/frontend.conf&lt;br&gt;else&lt;br&gt;include&nbsp;/etc/squid/backend.conf&lt;br&gt;endif&lt;br&gt;&lt;br&gt;http_access&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;#&lt;br&gt;#&nbsp;Add&nbsp;any&nbsp;of&nbsp;your&nbsp;own&nbsp;refresh_pattern&nbsp;entries&nbsp;above&nbsp;these.&lt;br&gt;#&lt;br&gt;refresh_pattern&nbsp;^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10080&lt;br&gt;refresh_pattern&nbsp;^gopher:&nbsp;1440&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1440&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&lt;br&gt;refresh_pattern&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4320&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#######&nbsp;frontend.conf&nbsp;-&nbsp;some&nbsp;names&nbsp;changed/omitted##########&lt;/div&gt;&lt;div&gt;#&nbsp;Squid&nbsp;normally&nbsp;listens&nbsp;to&nbsp;port&nbsp;3128&nbsp;&lt;br&gt;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;\&lt;br&gt;cert=/etc/squid/ssl_cert/mycert.pem&nbsp;\&lt;br&gt;key=/etc/squid/ssl_cert/mycert.pem&nbsp;\&lt;br&gt;generate-host-certificates=on&nbsp;\&lt;br&gt;dynamic_cert_mem_cache_size=4mb&lt;br&gt;&lt;br&gt;#&nbsp;Where&nbsp;to&nbsp;look&nbsp;for&nbsp;ssl&nbsp;cert&lt;br&gt;sslcrtd_program&nbsp;/usr/lib/squid/security_file_certgen&nbsp;-s&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;&lt;br&gt;#&nbsp;Enable&nbsp;URL&nbsp;Params&lt;br&gt;strip_query_terms&nbsp;off&lt;br&gt;&lt;br&gt;#&nbsp;add&nbsp;user&nbsp;authentication&nbsp;and&nbsp;similar&nbsp;options&nbsp;here&lt;br&gt;http_access&nbsp;allow&nbsp;manager&nbsp;localhost&lt;br&gt;http_access&nbsp;deny&nbsp;manager&lt;br&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;&lt;br&gt;#&nbsp;add&nbsp;backends&nbsp;-&nbsp;one&nbsp;line&nbsp;for&nbsp;each&nbsp;additional&nbsp;worker&nbsp;you&nbsp;configured&lt;br&gt;#&nbsp;NOTE&nbsp;how&nbsp;the&nbsp;port&nbsp;number&nbsp;matches&nbsp;the&nbsp;kid&nbsp;number&lt;br&gt;cache_peer&nbsp;localhost&nbsp;parent&nbsp;4002&nbsp;0&nbsp;carp&nbsp;login=PASS&nbsp;name=backend-kid2&lt;br&gt;cache_peer&nbsp;localhost&nbsp;parent&nbsp;4003&nbsp;0&nbsp;carp&nbsp;login=PASS&nbsp;name=backend-kid3&lt;br&gt;&lt;br&gt;#you&nbsp;want&nbsp;the&nbsp;frontend&nbsp;to&nbsp;have&nbsp;a&nbsp;significant&nbsp;cache_mem&lt;br&gt;cache_mem&nbsp;512&nbsp;MB&lt;br&gt;&lt;br&gt;#&nbsp;change&nbsp;/tmp&nbsp;to&nbsp;your&nbsp;own&nbsp;log&nbsp;directory,&nbsp;e.g.&nbsp;/var/log/squid&lt;br&gt;access_log&nbsp;/var/log/squid/frontend.access.log&lt;br&gt;cache_log&nbsp;/var/log/squid/frontend.cache.log&lt;br&gt;&lt;br&gt;#&nbsp;the&nbsp;frontend&nbsp;requires&nbsp;a&nbsp;different&nbsp;name&nbsp;to&nbsp;the&nbsp;backend(s)&lt;br&gt;visible_hostname&nbsp;Squid-Test&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;##########&nbsp;backend.conf&nbsp;#############&lt;/div&gt;&lt;div&gt;#&nbsp;each&nbsp;backend&nbsp;must&nbsp;listen&nbsp;on&nbsp;a&nbsp;unique&nbsp;port&lt;br&gt;#&nbsp;without&nbsp;this&nbsp;the&nbsp;CARP&nbsp;algorithm&nbsp;would&nbsp;be&nbsp;useless&lt;br&gt;http_port&nbsp;400${process_number}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;TODO:&nbsp;Change&nbsp;512&nbsp;to&nbsp;larger&nbsp;after&nbsp;testing&nbsp;is&nbsp;done&lt;br&gt;cache_dir&nbsp;rock&nbsp;/var/log/squid/cacheRock&nbsp;512&nbsp;max-size=32768&lt;br&gt;&lt;br&gt;#&nbsp;NP:&nbsp;for&nbsp;now&nbsp;AUFS&nbsp;does&nbsp;not&nbsp;support&nbsp;SMP&nbsp;but&nbsp;the&nbsp;CARP&nbsp;algorithm&nbsp;helps&nbsp;reduce&nbsp;object&nbsp;duplications&lt;/div&gt;&lt;div&gt;#&nbsp;TODO:&nbsp;Change&nbsp;512&nbsp;to&nbsp;larger&nbsp;after&nbsp;testing&nbsp;is&nbsp;done  &lt;br&gt;cache_dir&nbsp;aufs&nbsp;/var/log/squid/cache${process_number}&nbsp;512&nbsp;128&nbsp;128&nbsp;min-size=32769&lt;br&gt;&lt;br&gt;#&nbsp;the&nbsp;default&nbsp;maximum&nbsp;cached&nbsp;object&nbsp;size&nbsp;is&nbsp;a&nbsp;bit&nbsp;small&lt;br&gt;#&nbsp;you&nbsp;want&nbsp;the&nbsp;backend&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;cache&nbsp;some&nbsp;fairly&nbsp;large&nbsp;objects&lt;br&gt;maximum_object_size&nbsp;512&nbsp;MB&lt;br&gt;&lt;br&gt;#&nbsp;you&nbsp;want&nbsp;the&nbsp;backend&nbsp;to&nbsp;have&nbsp;a&nbsp;small&nbsp;cache_mem&lt;br&gt;cache_mem&nbsp;4&nbsp;MB&lt;br&gt;&lt;br&gt;#&nbsp;the&nbsp;backends&nbsp;require&nbsp;a&nbsp;different&nbsp;name&nbsp;to&nbsp;frontends,&nbsp;but&nbsp;can&nbsp;share&nbsp;one&lt;br&gt;#&nbsp;this&nbsp;prevents&nbsp;forwarding&nbsp;loops&nbsp;between&nbsp;backends&nbsp;while&nbsp;allowing&lt;br&gt;#&nbsp;frontend&nbsp;to&nbsp;forward&nbsp;via&nbsp;the&nbsp;backend&lt;br&gt;visible_hostname&nbsp;Squid-Test${process_number}&lt;br&gt;&lt;br&gt;#&nbsp;change&nbsp;/var/log/squid&nbsp;to&nbsp;your&nbsp;own&nbsp;log&nbsp;directory&lt;br&gt;access_log&nbsp;/var/log/squid/backend${process_number}.access.log&lt;br&gt;cache_log&nbsp;/var/log/squid/backend${process_number}.cache.log&lt;br&gt;&lt;br&gt;#&nbsp;add&nbsp;just&nbsp;enough&nbsp;access&nbsp;permissions&nbsp;to&nbsp;allow&nbsp;the&nbsp;frontend&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
