<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;have&nbsp;the&nbsp;following&nbsp;setup:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid&nbsp;-v&lt;br&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;4.8&lt;br&gt;Service&nbsp;Name:&nbsp;squid&lt;br&gt;201909121340&lt;br&gt;&lt;br&gt;This&nbsp;binary&nbsp;uses&nbsp;OpenSSL&nbsp;1.0.2k-fips&nbsp; 26&nbsp;Jan&nbsp;2017.&nbsp;For&nbsp;legal&nbsp;restrictions&nbsp;on&nbsp;distribution&nbsp;see&nbsp;&lt;a&nbsp;href=&quot;https://www.openssl.org/source/license.html&quot;&gt;https://www.openssl.org/source/license.html&lt;/a&gt;&lt;br&gt;&lt;br&gt;configure&nbsp;options:&nbsp; &#39;--enable-ssl-crtd&#39;&nbsp;&#39;--enable-build-info=201909121340&#39;&nbsp;&#39;--disable-arch-native&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--enable-wccpv2&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--enable-icap-client&#39;&nbsp;&#39;--with-openssl&#39;&nbsp;&#39;--enable-ssl&#39;&nbsp;&#39;--enable-ltdl-convenience&#39;&nbsp;&#39;--enable-linux-netfilter&#39;&nbsp;&#39;--enable-auth&#39;&nbsp;&#39;--with-libcap&#39;&nbsp;&#39;--with-default-user=squid&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--with-logdir=/var/log/squid&#39;&nbsp;&#39;--with-swapdir=/var/spool/squid&#39;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squid.conf&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; qos_flows&nbsp;mark&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iptables&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; target&nbsp; &nbsp; &nbsp;prot&nbsp;opt&nbsp;in&nbsp; &nbsp; &nbsp;out&nbsp; &nbsp; &nbsp;source&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination&lt;br&gt; &nbsp; &nbsp; CONNMARK&nbsp; &nbsp;tcp&nbsp; -- &nbsp;interface2 &nbsp;*&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:443&nbsp;CONNMARK&nbsp;xset&nbsp;0x6b0000/0x7fff0000&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;DNAT&nbsp; &nbsp; &nbsp; &nbsp;tcp&nbsp; --&nbsp; *&nbsp; &nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp&nbsp;dpt:443&nbsp;mark&nbsp;match&nbsp;0x6b0000&nbsp;to:IP:9443&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ip&nbsp;rule&nbsp;show&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; 204:&nbsp; &nbsp; from&nbsp;all&nbsp;fwmark&nbsp;0x6b0000/0x7fff0000&nbsp;lookup&nbsp;107&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ip&nbsp;route&nbsp;show&nbsp;table&nbsp;107&lt;br&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt;&nbsp;dev&nbsp;interface2&nbsp;scope&nbsp;link&lt;br&gt; &nbsp; &nbsp; 127.0.0.1&nbsp;dev&nbsp;lo&nbsp;scope&nbsp;link&lt;br&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt;&nbsp;dev&nbsp;interface2&nbsp;scope&nbsp;link&lt;br&gt; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt;&nbsp;dev&nbsp;interface2&nbsp;scope&nbsp;link&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;do&nbsp;see&nbsp;the&nbsp;packet&nbsp;in&nbsp;squid&nbsp;log&nbsp;which&nbsp;appears&nbsp;to&nbsp;have&nbsp;the&nbsp;mark&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2020/05/26&nbsp;17:22:20.557&nbsp;kid3|&nbsp;28,3|&nbsp;Eui48.cc(516)&nbsp;lookup:&nbsp;id=0x17b20b4&nbsp;192.168.128.2&nbsp;NOT&nbsp;found&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2020/05/26&nbsp;17:22:20.557&nbsp;kid3|&nbsp;17,3|&nbsp;QosConfig.cc(148)&nbsp;getNfmarkCallback:&nbsp;0x6b0000&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2020/05/26&nbsp;17:22:20.557&nbsp;kid3|&nbsp;51,3|&nbsp;fd.cc(198)&nbsp;fd_open:&nbsp;fd_open()&nbsp;FD&nbsp;26&nbsp;HTTP&nbsp;Request&lt;br&gt;2020/05/26&nbsp;17:22:20.557&nbsp;kid3|&nbsp;5,5|&nbsp;TcpAcceptor.cc(301)&nbsp;acceptOne:&nbsp;Listener:&nbsp;local=localIP&nbsp;remote=[::]&nbsp;FD&nbsp;23&nbsp;flags=33&nbsp;ac&lt;br&gt;cepted&nbsp;new&nbsp;connection&nbsp;local=websiteIP&nbsp;remote=&lt;a&nbsp;href=&quot;http://192.168.128.2:59769&quot;&gt;192.168.128.2:59769&lt;/a&gt;&nbsp;FD&nbsp;26&nbsp;flags=33&nbsp;handler&nbsp;Subscription:&nbsp;0xee7580*1&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;doesn&#39;t&nbsp;seem&nbsp;to&nbsp;preserve the&nbsp;mark&nbsp;when&nbsp;making&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;server.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;two&nbsp;questions&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;it&nbsp;better&nbsp;to&nbsp;use&nbsp;tproxy&nbsp;versus&nbsp;dnat&nbsp;when&nbsp;trying&nbsp;to&nbsp;preserve&nbsp;the&nbsp;mark? &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;also&nbsp;appears&nbsp;even&nbsp;though&nbsp;I&nbsp;mark&nbsp;the&nbsp;packet&nbsp;and&nbsp;have&nbsp;a&nbsp;separate&nbsp;routing&nbsp;table&nbsp;the&nbsp;packet&nbsp;never&nbsp;seems&nbsp;to&nbsp;make&nbsp;it&nbsp;to&nbsp;squid&nbsp;unless&nbsp;I&nbsp;have&nbsp;a&nbsp;route&nbsp;for&nbsp;the&nbsp;source&nbsp;address&nbsp;in&nbsp;the&nbsp;main&nbsp;table,&nbsp;is&nbsp;there&nbsp;a&nbsp;way&nbsp;to&nbsp;make&nbsp;squid&nbsp;use&nbsp;the&nbsp;second&nbsp;routing&nbsp;table?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
