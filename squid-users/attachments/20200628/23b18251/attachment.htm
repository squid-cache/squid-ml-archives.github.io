<tt>
&lt;html&nbsp;style=&quot;direction:&nbsp;ltr;&quot;&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;style&nbsp;type=&quot;text/css&quot;&gt;body&nbsp;p&nbsp;{&nbsp;margin-bottom:&nbsp;0cm;&nbsp;margin-top:&nbsp;0pt;&nbsp;}&nbsp;&lt;/style&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bidimailui-charset-is-forced=&quot;true&quot;&nbsp;style=&quot;direction:&nbsp;ltr;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Hi,&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Thank&nbsp;you&nbsp;all&nbsp;for&nbsp;the&nbsp;great&nbsp;work&nbsp;on&nbsp;Squid.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;got&nbsp;last&nbsp;week&nbsp;a&nbsp;bad&nbsp;&quot;issue&quot;&nbsp;where&nbsp;a&nbsp;squid&nbsp;Version&nbsp;4.0.23&nbsp;set&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send&nbsp;requests&nbsp;to&nbsp;4&nbsp;VMs&nbsp;didn't&nbsp;detect&nbsp;a&nbsp;dead&nbsp;peer.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;On&nbsp;each&nbsp;VM&nbsp;are&nbsp;running&nbsp;Apache&nbsp;as&nbsp;the&nbsp;frontal,&nbsp;and&nbsp;php-fpm&nbsp;as&nbsp;php<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scripts&nbsp;execution.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Squid&nbsp;is&nbsp;using&nbsp;sourcehash&nbsp;load&nbsp;balancing&nbsp;algorithm.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;But,&nbsp;if&nbsp;the&nbsp;php-fpm&nbsp;is&nbsp;down&nbsp;or&nbsp;busy,&nbsp;Apache&nbsp;will&nbsp;return&nbsp;a&nbsp;504<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Gateway&nbsp;timeout&nbsp;to&nbsp;Squid&nbsp;and&nbsp;browser,&nbsp;and&nbsp;squid&nbsp;will&nbsp;continue&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send&nbsp;requests&nbsp;to&nbsp;same&nbsp;Apache,&nbsp;even&nbsp;if&nbsp;the&nbsp;answer&nbsp;will&nbsp;always&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HTTP&nbsp;code&nbsp;504,&nbsp;because&nbsp;Apache&nbsp;is&nbsp;ALIVE.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Apache&nbsp;is&nbsp;there,&nbsp;respawning,&nbsp;but&nbsp;the&nbsp;user&nbsp;is&nbsp;not&nbsp;getting&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;right&nbsp;answer.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;And&nbsp;all&nbsp;IPs&nbsp;that&nbsp;are&nbsp;connecting&nbsp;to&nbsp;this&nbsp;VM,&nbsp;will&nbsp;fail,&nbsp;so&nbsp;25%&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all&nbsp;users&nbsp;will&nbsp;suffer&nbsp;unavailability.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;have&nbsp;setup&nbsp;some&nbsp;watchdogs&nbsp;scripts&nbsp;that&nbsp;will&nbsp;now,&nbsp;from&nbsp;the&nbsp;VM<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intern&nbsp;itself,&nbsp;check&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;504&nbsp;code&nbsp;returned&nbsp;by&nbsp;Apache,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;in&nbsp;that&nbsp;case,&nbsp;will&nbsp;restart&nbsp;php-fpm.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;But&nbsp;how&nbsp;to&nbsp;tell&nbsp;squid&nbsp;to&nbsp;mark&nbsp;dead&nbsp;a&nbsp;peer&nbsp;that&nbsp;returns&nbsp;504&nbsp;code&nbsp;?&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Thanks&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Patrick&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>
<br>

</tt>
