<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;Amos,&nbsp;Kerberos&nbsp;is&nbsp;really&nbsp;hard&nbsp;to&nbsp;learn&nbsp;for&nbsp;a&nbsp;rookie&nbsp;like&nbsp;me,&nbsp;but&nbsp;you&nbsp;explained&nbsp;it&nbsp;in&nbsp;an&nbsp;excellent&nbsp;and&nbsp;concise&nbsp;way.&nbsp;&lt;br&gt;In&nbsp;my&nbsp;case,&nbsp;the&nbsp;SQUID&nbsp;servers&nbsp;are&nbsp;joined&nbsp;to&nbsp;the&nbsp;domain&nbsp;with&nbsp;their&nbsp;respective&nbsp;SPN&nbsp;and&nbsp;UPN&nbsp;that&nbsp;I&nbsp;mentioned&nbsp;in&nbsp;the&nbsp;msktutil&nbsp;command.&lt;br&gt;And&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;the&nbsp;Load&nbsp;Balancer&nbsp;HAProxy&nbsp;I&nbsp;used&nbsp;a&nbsp;user&nbsp;account&nbsp;and&nbsp;I&nbsp;set&nbsp;that&nbsp;the&nbsp;password&nbsp;does&nbsp;not&nbsp;expire.&nbsp;I&nbsp;know&nbsp;this&nbsp;may&nbsp;not&nbsp;be&nbsp;the&nbsp;safest&nbsp;way&nbsp;to&nbsp;do&nbsp;it,&nbsp;but&nbsp;I&nbsp;couldn&#39;t&nbsp;find&nbsp;a&nbsp;way&nbsp;to&nbsp;do&nbsp;it&nbsp;with&nbsp;a&nbsp;computer&nbsp;account.&nbsp;I&nbsp;guess&nbsp;I&nbsp;should&nbsp;join&nbsp;the&nbsp;HAProxy&nbsp;to&nbsp;the&nbsp;domain&nbsp;as&nbsp;well.&nbsp;&lt;br&gt;The&nbsp;detail,&nbsp;as&nbsp;you&nbsp;mentioned,&nbsp;is&nbsp;that&nbsp;the&nbsp;DNS&nbsp;A&nbsp;record&nbsp;(eg&nbsp;inet.mydomain.local)&nbsp;is&nbsp;to&nbsp;match&nbsp;exactly&nbsp;the&nbsp;SPN&nbsp;for&nbsp;that&nbsp;user&nbsp;account,&nbsp;which&nbsp;at&nbsp;this&nbsp;point&nbsp;is&nbsp;a&nbsp;service&nbsp;account.&lt;br&gt;&lt;br&gt;&lt;div&gt;Thanks&nbsp;again&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Gabriel&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;El&nbsp;vie.,&nbsp;24&nbsp;de&nbsp;jul.&nbsp;de&nbsp;2020&nbsp;a&nbsp;la(s)&nbsp;00:10,&nbsp;Amos&nbsp;Jeffries&nbsp;(&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;)&nbsp;escribió:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;24/07/20&nbsp;5:09&nbsp;am,&nbsp;Service&nbsp;MV&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;Klaus,&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;think&nbsp;something&nbsp;similar.&nbsp;But&nbsp;I&nbsp;understand&nbsp;that&nbsp;you&nbsp;can&nbsp;use&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;Kerberos&nbsp;delegation&nbsp;in&nbsp;AD.&nbsp;That&#39;s&nbsp;partly&nbsp;why&nbsp;I&#39;m&nbsp;not&nbsp;convinced&nbsp;by&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;documentation&nbsp;I&nbsp;read,&nbsp;which&nbsp;tells&nbsp;me&nbsp;to&nbsp;create&nbsp;a&nbsp;user&nbsp;account&nbsp;in&nbsp;Active&lt;br&gt;<br>
&gt;&nbsp;Directory.&nbsp;And&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;what&nbsp;a&nbsp;user&nbsp;account&nbsp;has&nbsp;to&nbsp;do&nbsp;here.&lt;br&gt;<br>
&gt;&nbsp;Maybe&nbsp;the&nbsp;documentation&nbsp;is&nbsp;wrong&nbsp;and&nbsp;actually&nbsp;refers&nbsp;to&nbsp;a&nbsp;computer&lt;br&gt;<br>
&gt;&nbsp;account,&nbsp;and&nbsp;the&nbsp;operation&nbsp;of&nbsp;adding&nbsp;a&nbsp;Service&nbsp;Principal&nbsp;Name&nbsp;should&nbsp;be&lt;br&gt;<br>
&gt;&nbsp;done&nbsp;to&nbsp;the&nbsp;computer&nbsp;object.&nbsp;I&nbsp;don&#39;t&nbsp;know.&nbsp;But&nbsp;I&#39;m&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;do&nbsp;it&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;see&nbsp;what&nbsp;I&nbsp;can&nbsp;achieve.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Kerberos&nbsp;authentication&nbsp;in&nbsp;HTTP&nbsp;uses&nbsp;the&nbsp;Negotiate&nbsp;scheme.&nbsp;The&nbsp;model&nbsp;for&lt;br&gt;<br>
that&nbsp;scheme&nbsp;is&nbsp;that&nbsp;it&nbsp;authenticates&nbsp;the&nbsp;exact&nbsp;TCP&nbsp;connection&nbsp;over&nbsp;which&lt;br&gt;<br>
the&nbsp;credentials&nbsp;are&nbsp;transmitted.&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;for&nbsp;it&nbsp;to&nbsp;work&nbsp;*through*&nbsp;a&nbsp;proxy&nbsp;(eg&nbsp;HAProxy)&nbsp;that&nbsp;proxy&nbsp;must&nbsp;ensure&lt;br&gt;<br>
the&nbsp;*two*&nbsp;TCP&nbsp;connections&nbsp;it&nbsp;is&nbsp;handling&nbsp;(from-client&nbsp;and&nbsp;to-Squid)&nbsp;are&lt;br&gt;<br>
pinned&nbsp;together&nbsp;with&nbsp;all&nbsp;HTTP&nbsp;multiplexing&nbsp;features&nbsp;disabled&nbsp;_and_&nbsp;the&lt;br&gt;<br>
Proxy-Auth*&nbsp;headers&nbsp;are&nbsp;not&nbsp;touched&nbsp;or&nbsp;used&nbsp;along&nbsp;the&nbsp;way.&lt;br&gt;<br>
&lt;br&gt;<br>
 =&gt;&nbsp;If&nbsp;either&nbsp;of&nbsp;those&nbsp;conditions&nbsp;is&nbsp;broken&nbsp;the&nbsp;auth&nbsp;will&nbsp;not&nbsp;work&nbsp;and&lt;br&gt;<br>
users&nbsp;will&nbsp;definitely&nbsp;get&nbsp;the&nbsp;behaviour&nbsp;you&nbsp;are&nbsp;seeing.&nbsp;That&nbsp;behaviour&lt;br&gt;<br>
may&nbsp;also&nbsp;occur&nbsp;anyway&nbsp;if&nbsp;later&nbsp;stages&nbsp;are&nbsp;broken&nbsp;-&nbsp;this&nbsp;is&nbsp;just&nbsp;the&lt;br&gt;<br>
first&nbsp;and&nbsp;most&nbsp;non-obvious&nbsp;problem&nbsp;for&nbsp;beginners.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
[&nbsp;below&nbsp;is&nbsp;simplified&nbsp;a&nbsp;bit/lot&nbsp;to&nbsp;ensure&nbsp;you&nbsp;have&nbsp;the&nbsp;basic&lt;br&gt;<br>
understanding.&nbsp;There&nbsp;is&nbsp;a&nbsp;steep&nbsp;learning&nbsp;curve&nbsp;for&nbsp;Kerberos&nbsp;tools&nbsp;and&lt;br&gt;<br>
one&nbsp;needs&nbsp;basics&nbsp;before&nbsp;troubleshooting&nbsp;exposes&nbsp;the&nbsp;gory&nbsp;details&nbsp;]&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;HTTP&nbsp;agent&nbsp;which&nbsp;is&nbsp;doing&nbsp;the&nbsp;Kerberos&nbsp;auth&nbsp;validation&nbsp;(eg&nbsp;Squid)&lt;br&gt;<br>
must&nbsp;be&nbsp;configured&nbsp;with&nbsp;an&nbsp;account&nbsp;that&nbsp;can&nbsp;perform&nbsp;authentication&nbsp;tasks&lt;br&gt;<br>
with&nbsp;the&nbsp;central&nbsp;domain&nbsp;server.&lt;br&gt;<br>
 This&nbsp;can&nbsp;be&nbsp;either&nbsp;User&nbsp;or&nbsp;Machine&nbsp;account&nbsp;as&nbsp;you&nbsp;know.&nbsp;The&nbsp;important&lt;br&gt;<br>
difference&nbsp;is&nbsp;their&nbsp;policy&nbsp;on&nbsp;passwords.&nbsp;User&nbsp;accounts&nbsp;need&nbsp;password&lt;br&gt;<br>
rotation,&nbsp;machines&nbsp;are&nbsp;effectively&nbsp;permanent.&nbsp;Since&nbsp;keytab&nbsp;used&nbsp;by&nbsp;Squid&lt;br&gt;<br>
has&nbsp;to&nbsp;be&nbsp;re-generated&nbsp;every&nbsp;time&nbsp;the&nbsp;account&nbsp;password&nbsp;changes&nbsp;User&lt;br&gt;<br>
accounts&nbsp;are&nbsp;naturally&nbsp;far&nbsp;more&nbsp;complex&nbsp;to&nbsp;administrate&nbsp;for&nbsp;reliable&nbsp;auth.&lt;br&gt;<br>
&lt;br&gt;<br>
 =&gt;&nbsp;So&nbsp;...&nbsp;your&nbsp;choice&nbsp;and&nbsp;YMMV.&nbsp;But&nbsp;we&nbsp;recommend&nbsp;a&nbsp;machine&nbsp;account&lt;br&gt;<br>
unless&nbsp;you&nbsp;have&nbsp;reason&nbsp;to&nbsp;go&nbsp;the&nbsp;more&nbsp;complex&nbsp;way.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
At&nbsp;the&nbsp;other&nbsp;end&nbsp;the&nbsp;client&nbsp;software&nbsp;needs&nbsp;a&nbsp;keytab&nbsp;with&nbsp;a&nbsp;&quot;Principal&quot;&lt;br&gt;<br>
name&nbsp;telling&nbsp;it&nbsp;what&nbsp;to&nbsp;request&nbsp;from&nbsp;the&nbsp;central&nbsp;domain&nbsp;server&nbsp;when&nbsp;it&lt;br&gt;<br>
needs&nbsp;a&nbsp;token&nbsp;that&nbsp;Squid&nbsp;can&nbsp;validate.&lt;br&gt;<br>
&lt;br&gt;<br>
 =&gt;&nbsp;The&nbsp;principal&nbsp;name&nbsp;has&nbsp;to&nbsp;match&nbsp;up&nbsp;with&nbsp;the&nbsp;account&nbsp;details&nbsp;used&nbsp;by&lt;br&gt;<br>
the&nbsp;proxy&nbsp;which&nbsp;is&nbsp;checking&nbsp;the&nbsp;auth&nbsp;credentials.&nbsp;This&nbsp;is&nbsp;why&nbsp;the&nbsp;middle&lt;br&gt;<br>
proxy&nbsp;(eg&nbsp;HAProxy)&nbsp;cannot&nbsp;touch&nbsp;the&nbsp;authentication&nbsp;on&nbsp;its&nbsp;way&nbsp;to&nbsp;Squid.&lt;br&gt;<br>
&lt;br&gt;<br>
 =&gt;&nbsp;The&nbsp;principal&nbsp;name&nbsp;is&nbsp;also&nbsp;case-sensitive&nbsp;and&nbsp;and&nbsp;must&nbsp;survive&lt;br&gt;<br>
*exact*&nbsp;string&nbsp;comparisons&nbsp;despite&nbsp;DNS&nbsp;resolve&nbsp;being&nbsp;involved&nbsp;[&nbsp;because&lt;br&gt;<br>
reasons&nbsp;:(&nbsp;]. &nbsp;So&nbsp;be&nbsp;sure&nbsp;to&nbsp;use&nbsp;full&nbsp;FQDN&nbsp;rather&nbsp;than&nbsp;host&nbsp;name&lt;br&gt;<br>
abbreviations.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&#39;ll&nbsp;be&nbsp;back.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;El&nbsp;jue.,&nbsp;23&nbsp;de&nbsp;jul.&nbsp;de&nbsp;2020&nbsp;a&nbsp;la(s)&nbsp;13:16,&nbsp;Klaus&nbsp;Brandl&nbsp;escribió:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Hi&nbsp;Gabriel,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; same&nbsp;problem&nbsp;here&nbsp;on&nbsp;our&nbsp;HA&nbsp;systems.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; I&nbsp;think,&nbsp;this&nbsp;is&nbsp;caused&nbsp;by&nbsp;kerberos&nbsp;overall,&nbsp;the&nbsp;tickets&nbsp;are&nbsp;always&lt;br&gt;<br>
&gt; &nbsp; &nbsp; bound&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; the&nbsp;hosts&nbsp;realname&nbsp;and&nbsp;address,&nbsp;look&nbsp;at&nbsp;&quot;klist&quot;&nbsp;on&nbsp;your&nbsp;client,&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; only&lt;br&gt;<br>
&gt; &nbsp; &nbsp; exactly&nbsp;this&nbsp;name&nbsp;could&nbsp;be&nbsp;used&nbsp;as&nbsp;proxy&nbsp;entry.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Indeed.&nbsp;Use&nbsp;of&nbsp;wrong&nbsp;names&nbsp;(eg&nbsp;not&nbsp;using&nbsp;the&nbsp;full&nbsp;FQDN),&nbsp;wrong&nbsp;case,&nbsp;or&lt;br&gt;<br>
the&nbsp;hostnames&nbsp;not&nbsp;being&nbsp;DNS&nbsp;resolvable&nbsp;are&nbsp;common&nbsp;causes&nbsp;of&nbsp;Kerberos&nbsp;not&lt;br&gt;<br>
working.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Amos&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
