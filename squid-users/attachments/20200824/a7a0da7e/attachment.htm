<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=Windows-1252&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none;&quot;&gt;&nbsp;P&nbsp;{margin-top:0;margin-bottom:0;}&nbsp;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;<br>
Hi,<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I'm&nbsp;currently&nbsp;trying&nbsp;to&nbsp;configure&nbsp;transparent&nbsp;SSL&nbsp;proxying&nbsp;and&nbsp;running&nbsp;into&nbsp;a&nbsp;strange&nbsp;error&nbsp;that&nbsp;has&nbsp;me&nbsp;scratching&nbsp;my&nbsp;head&nbsp;for&nbsp;hours.&nbsp;I'm&nbsp;using&nbsp;Squid&nbsp;4.11&nbsp;(I&nbsp;also&nbsp;tried&nbsp;this&nbsp;with&nbsp;4.12)&nbsp;with&nbsp;SSL&nbsp;support&nbsp;from&nbsp;here&nbsp;-&nbsp;http://squid411.diladele.com/ubuntu/&nbsp;on<br>
&nbsp;Ubuntu&nbsp;18.04.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;set&nbsp;up&nbsp;the&nbsp;necessary&nbsp;iptables&nbsp;forwarding&nbsp;ports&nbsp;and&nbsp;SSL&nbsp;certificates&nbsp;and&nbsp;it&nbsp;sometimes&nbsp;works&nbsp;(as&nbsp;you&nbsp;will&nbsp;see&nbsp;below).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;My&nbsp;current&nbsp;configuration&nbsp;adds&nbsp;just&nbsp;the&nbsp;following&nbsp;to&nbsp;the&nbsp;default&nbsp;squid.conf&nbsp;file:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;INSERT&nbsp;YOUR&nbsp;OWN&nbsp;RULE(S)&nbsp;HERE&nbsp;TO&nbsp;ALLOW&nbsp;ACCESS&nbsp;FROM&nbsp;YOUR&nbsp;CLIENTS&lt;/div&gt;<br>
&lt;div&gt;#&lt;/div&gt;<br>
&lt;div&gt;include&nbsp;/etc/squid/conf.d/*&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;Example&nbsp;rule&nbsp;allowing&nbsp;access&nbsp;from&nbsp;your&nbsp;local&nbsp;networks.&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;Adapt&nbsp;localnet&nbsp;in&nbsp;the&nbsp;ACL&nbsp;section&nbsp;to&nbsp;list&nbsp;your&nbsp;(internal)&nbsp;IP&nbsp;networks&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;from&nbsp;where&nbsp;browsing&nbsp;should&nbsp;be&nbsp;allowed&lt;/div&gt;<br>
&lt;div&gt;#http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;<br>
&lt;div&gt;debug_options&nbsp;ALL,1,&nbsp;33,2&nbsp;2&nbsp;28,9&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_port&nbsp;3129&nbsp;intercept&lt;/div&gt;<br>
&lt;div&gt;https_port&nbsp;3130&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_cert/squid-ca.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;/div&gt;<br>
&lt;div&gt;sslcrtd_program&nbsp;/usr/lib/squid/security_file_certgen&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;whitelist&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;whitelist_http&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;splice&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;whitelist&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;whitelist_http&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;And&nbsp;finally&nbsp;deny&nbsp;all&nbsp;other&nbsp;access&nbsp;to&nbsp;this&nbsp;proxy&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;so&nbsp;the&nbsp;above&nbsp;configuration&nbsp;should&nbsp;allow&nbsp;anyone&nbsp;with&nbsp;access&nbsp;to&nbsp;the&nbsp;Squid&nbsp;proxy&nbsp;access&nbsp;to&nbsp;httpbin.org&nbsp;over&nbsp;both&nbsp;HTTP&nbsp;and&nbsp;HTTPS&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;when&nbsp;I&nbsp;try&nbsp;to&nbsp;access:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http://httpbin.org&nbsp;(not&nbsp;SSL)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;it&nbsp;works&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;when&nbsp;I&nbsp;try&nbsp;to&nbsp;access:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;https://httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;it&nbsp;fails&nbsp;as&nbsp;shown&nbsp;below&nbsp;(I'm&nbsp;running&nbsp;this&nbsp;on&nbsp;the&nbsp;Squid&nbsp;proxy&nbsp;machine&nbsp;itself):&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;$&nbsp;wget&nbsp;https://httpbin.org&lt;/div&gt;<br>
&lt;div&gt;--2020-08-24&nbsp;17:48:34--&nbsp;&nbsp;https://httpbin.org/&lt;/div&gt;<br>
&lt;div&gt;Resolving&nbsp;httpbin.org&nbsp;(httpbin.org)...&nbsp;54.236.246.173,&nbsp;3.220.112.94&lt;/div&gt;<br>
&lt;div&gt;Connecting&nbsp;to&nbsp;httpbin.org&nbsp;(httpbin.org)|54.236.246.173|:443...&nbsp;connected.&lt;/div&gt;<br>
&lt;div&gt;ERROR:&nbsp;cannot&nbsp;verify&nbsp;httpbin.org's&nbsp;certificate,&nbsp;issued&nbsp;by&nbsp;‘O=Internet&nbsp;Widgits&nbsp;Pty&nbsp;Ltd,ST=Some-State,C=AU’:&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;Self-signed&nbsp;certificate&nbsp;encountered.&lt;/div&gt;<br>
&lt;div&gt;To&nbsp;connect&nbsp;to&nbsp;httpbin.org&nbsp;insecurely,&nbsp;use&nbsp;`--no-check-certificate'.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;$&nbsp;wget&nbsp;https://httpbin.org&nbsp;--no-check-certificate&lt;/div&gt;<br>
&lt;div&gt;--2020-08-24&nbsp;17:48:40--&nbsp;&nbsp;https://httpbin.org/&lt;/div&gt;<br>
&lt;div&gt;Resolving&nbsp;httpbin.org&nbsp;(httpbin.org)...&nbsp;3.220.112.94,&nbsp;54.236.246.173&lt;/div&gt;<br>
&lt;div&gt;Connecting&nbsp;to&nbsp;httpbin.org&nbsp;(httpbin.org)|3.220.112.94|:443...&nbsp;connected.&lt;/div&gt;<br>
&lt;div&gt;WARNING:&nbsp;cannot&nbsp;verify&nbsp;httpbin.org's&nbsp;certificate,&nbsp;issued&nbsp;by&nbsp;‘O=Internet&nbsp;Widgits&nbsp;Pty&nbsp;Ltd,ST=Some-State,C=AU’:&lt;/div&gt;<br>
&lt;div&gt;&nbsp;&nbsp;Self-signed&nbsp;certificate&nbsp;encountered.&lt;/div&gt;<br>
&lt;div&gt;HTTP&nbsp;request&nbsp;sent,&nbsp;awaiting&nbsp;response...&nbsp;403&nbsp;Forbidden&lt;/div&gt;<br>
&lt;div&gt;2020-08-24&nbsp;17:48:40&nbsp;ERROR&nbsp;403:&nbsp;Forbidden.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;looking&nbsp;at&nbsp;access.log&nbsp;shows:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;1598305800.974&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;192.168.123.214&nbsp;TCP_DENIED/200&nbsp;0&nbsp;CONNECT&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;for&nbsp;the&nbsp;first&nbsp;request&nbsp;(without&nbsp;the&nbsp;--no-check-certificate)&nbsp;and&nbsp;the&nbsp;following&nbsp;for&nbsp;the&nbsp;2nd&nbsp;request&nbsp;(with&nbsp;the&nbsp;--no-check-certificate):&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;1598305812.292&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;192.168.123.214&nbsp;TCP_DENIED/200&nbsp;0&nbsp;CONNECT&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;1598305812.300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;192.168.123.214&nbsp;NONE/403&nbsp;3795&nbsp;GET&nbsp;https://httpbin.org/&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;looking&nbsp;at&nbsp;cache.log&nbsp;shows:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;cat&nbsp;/var/log/squid/cache.log&nbsp;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;&quot;28&quot;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:50:00.972&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:50:00.972&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:50:12.290&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:50:12.290&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;so&nbsp;it&nbsp;never&nbsp;matches&nbsp;on&nbsp;the&nbsp;httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;now,&nbsp;if&nbsp;I&nbsp;add&nbsp;the&nbsp;following&nbsp;line&nbsp;to&nbsp;my&nbsp;configuration:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;right&nbsp;before&nbsp;the:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;line&nbsp;it&nbsp;works&nbsp;and&nbsp;I&nbsp;see&nbsp;the&nbsp;following&nbsp;in&nbsp;access.log:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;1598305979.004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;192.168.123.214&nbsp;NONE/200&nbsp;0&nbsp;CONNECT&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;1598305980.016&nbsp;&nbsp;&nbsp;1012&nbsp;192.168.123.214&nbsp;TCP_TUNNEL/200&nbsp;15370&nbsp;CONNECT&nbsp;httpbin.org:443&nbsp;-&nbsp;ORIGINAL_DST/54.236.246.173&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;and&nbsp;I&nbsp;see&nbsp;the&nbsp;following&nbsp;in&nbsp;cache.log:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#&nbsp;cat&nbsp;/var/log/squid/cache.log&nbsp;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;&quot;28&quot;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.000&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.000&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;RegexData.cc(43)&nbsp;match:&nbsp;checking&nbsp;'httpbin.org:443'&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(42)&nbsp;match:&nbsp;checking&nbsp;'httpbin.org'&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:httpbin.org&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(47)&nbsp;match:&nbsp;'httpbin.org'&nbsp;found&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;What's&nbsp;puzzling&nbsp;is&nbsp;why&nbsp;adding&nbsp;the&nbsp;'allow&nbsp;localnet'&nbsp;line&nbsp;changes&nbsp;the&nbsp;ACL&nbsp;logic&nbsp;for&nbsp;.httpbin.org&nbsp;and&nbsp;why&nbsp;the&nbsp;original&nbsp;configuration&nbsp;does&nbsp;not&nbsp;work.&nbsp;Any&nbsp;ideas?&nbsp;Thanks&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;PS.&nbsp;I&nbsp;reproduced&nbsp;the&nbsp;exact&nbsp;same&nbsp;scenario&nbsp;on&nbsp;Ubuntu&nbsp;20.04&nbsp;with&nbsp;Squid&nbsp;4.12&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
