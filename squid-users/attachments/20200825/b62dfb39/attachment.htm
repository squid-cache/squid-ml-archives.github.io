<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=Windows-1252&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none;&quot;&gt;&nbsp;P&nbsp;{margin-top:0;margin-bottom:0;}&nbsp;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;<br>
Thanks&nbsp;but&nbsp;even&nbsp;with&nbsp;the&nbsp;--no-check-certificate&nbsp;option&nbsp;and&nbsp;using&nbsp;a&nbsp;bump&nbsp;instead&nbsp;of&nbsp;splicing,&nbsp;it&nbsp;still&nbsp;fails&nbsp;as&nbsp;shown&nbsp;above&nbsp;unless&nbsp;I&nbsp;add&nbsp;the&nbsp;localnet&nbsp;rule.&nbsp;The&nbsp;question&nbsp;is:&nbsp;why&nbsp;does&nbsp;the&nbsp;same&nbsp;ACL&nbsp;line:<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;whitelist&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;suddenly&nbsp;work&nbsp;when&nbsp;I&nbsp;add&nbsp;an&nbsp;unrelated&nbsp;ACL&nbsp;line&nbsp;after&nbsp;it&nbsp;(http_access&nbsp;allow&nbsp;localnet)?&nbsp;Why&nbsp;does&nbsp;it&nbsp;correctly&nbsp;determine&nbsp;the&nbsp;domain&nbsp;httpbin.org&nbsp;in&nbsp;the&nbsp;later&nbsp;case&nbsp;as&nbsp;shown&nbsp;by&nbsp;cache.log?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;updated&nbsp;my&nbsp;splice&nbsp;to&nbsp;a&nbsp;bump&nbsp;instead&nbsp;so&nbsp;my&nbsp;config&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;whitelist&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;whitelist_http&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;/div&gt;<br>
&lt;div&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;/div&gt;<br>
&lt;div&gt;ssl_bump&nbsp;bump&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;whitelist&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;whitelist_http&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;#http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;and&nbsp;so&nbsp;it&nbsp;will&nbsp;bump&nbsp;all&nbsp;connections:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;I&nbsp;then&nbsp;ran:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;wget&nbsp;https://httpbin.org&nbsp;--no-check-certificate&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;and&nbsp;get&nbsp;the&nbsp;following&nbsp;(it&nbsp;fails):&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;cat&nbsp;access.log&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;1598316641.358&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;192.168.123.214&nbsp;TCP_DENIED/200&nbsp;0&nbsp;CONNECT&nbsp;3.220.112.94:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;1598316641.366&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;192.168.123.214&nbsp;NONE/403&nbsp;3789&nbsp;GET&nbsp;https://httpbin.org/&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;cat&nbsp;cache.log&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:50:41.356&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:3.220.112.94&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:50:41.356&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:3.220.112.94&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;while&nbsp;once&nbsp;I&nbsp;add&nbsp;the&nbsp;localnet&nbsp;rule:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;it&nbsp;succeeds&nbsp;and&nbsp;access.log&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;1598316682.044&nbsp;&nbsp;&nbsp;&nbsp;753&nbsp;192.168.123.214&nbsp;NONE/200&nbsp;0&nbsp;CONNECT&nbsp;54.236.246.173:443&nbsp;-&nbsp;ORIGINAL_DST/54.236.246.173&nbsp;-&lt;/div&gt;<br>
&lt;div&gt;1598316682.329&nbsp;&nbsp;&nbsp;&nbsp;260&nbsp;192.168.123.214&nbsp;TCP_REFRESH_MODIFIED/200&nbsp;9936&nbsp;GET&nbsp;https://httpbin.org/&nbsp;-&nbsp;ORIGINAL_DST/54.236.246.173&nbsp;text/html&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;and&nbsp;cache.log&nbsp;shows&nbsp;that&nbsp;it&nbsp;actually&nbsp;does&nbsp;the&nbsp;proper&nbsp;domain&nbsp;comparison:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;cat&nbsp;cache.log&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin.org&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:21.292&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:21.292&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:22.071&nbsp;kid1|&nbsp;28,3|&nbsp;RegexData.cc(43)&nbsp;match:&nbsp;checking&nbsp;'https://httpbin.org/'&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:22.071&nbsp;kid1|&nbsp;28,4|&nbsp;ServerName.cc(82)&nbsp;check_cert_domain:&nbsp;Verifying&nbsp;certificate&nbsp;name/subjectAltName&nbsp;httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:22.071&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(42)&nbsp;match:&nbsp;checking&nbsp;'httpbin.org'&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:22.071&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&nbsp;aclHostDomainCompare:&nbsp;Match:httpbin.org&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;/div&gt;<br>
&lt;div&gt;2020/08/24&nbsp;20:51:22.071&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(47)&nbsp;match:&nbsp;'httpbin.org'&nbsp;found&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;From&nbsp;my&nbsp;understanding,&nbsp;Squid&nbsp;should&nbsp;perform&nbsp;the&nbsp;exact&nbsp;same&nbsp;steps&nbsp;in&nbsp;both&nbsp;cases&nbsp;BUT&nbsp;then&nbsp;allow&nbsp;the&nbsp;connection&nbsp;because&nbsp;of&nbsp;the&nbsp;localnet&nbsp;ACL&nbsp;line&nbsp;that&nbsp;it&nbsp;sees&nbsp;right&nbsp;before&nbsp;the&nbsp;deny&nbsp;all&nbsp;line,&nbsp;not&nbsp;because&nbsp;it&nbsp;suddenly&nbsp;was&nbsp;able&nbsp;to&nbsp;match&nbsp;httpbin.org&nbsp;using&nbsp;a&nbsp;domain<br>
&nbsp;compare&nbsp;as&nbsp;shown&nbsp;by&nbsp;the&nbsp;debug&nbsp;logs.&nbsp;What&nbsp;am&nbsp;I&nbsp;missing?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Even&nbsp;if&nbsp;I&nbsp;add&nbsp;a&nbsp;peek&nbsp;at&nbsp;step2,&nbsp;the&nbsp;behavior&nbsp;is&nbsp;still&nbsp;the&nbsp;same&nbsp;for&nbsp;the&nbsp;first&nbsp;scenario&nbsp;although&nbsp;I&nbsp;no&nbsp;longer&nbsp;need&nbsp;to&nbsp;use&nbsp;--no-check-certificate&nbsp;in&nbsp;the&nbsp;2nd&nbsp;scenario&nbsp;(where&nbsp;I&nbsp;whitelist&nbsp;localnet)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;PS.&nbsp;I'm&nbsp;using&nbsp;the&nbsp;current&nbsp;iptable&nbsp;rules&nbsp;and&nbsp;making&nbsp;the&nbsp;wget&nbsp;call&nbsp;from&nbsp;a&nbsp;normal&nbsp;user&nbsp;account&nbsp;(so&nbsp;neither&nbsp;root&nbsp;or&nbsp;proxy):&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-m&nbsp;owner&nbsp;--uid-owner&nbsp;root&nbsp;-j&nbsp;RETURN&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-m&nbsp;owner&nbsp;--uid-owner&nbsp;proxy&nbsp;-j&nbsp;RETURN&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3129&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-m&nbsp;owner&nbsp;--uid-owner&nbsp;root&nbsp;-j&nbsp;RETURN&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-m&nbsp;owner&nbsp;--uid-owner&nbsp;proxy&nbsp;-j&nbsp;RETURN&lt;/div&gt;<br>
&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;OUTPUT&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;3130&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;appendonsend&quot;&gt;&lt;/div&gt;<br>
&lt;hr&nbsp;style=&quot;display:inline-block;width:98%&quot;&nbsp;tabindex=&quot;-1&quot;&gt;<br>
&lt;div&nbsp;id=&quot;divRplyFwdMsg&quot;&nbsp;dir=&quot;ltr&quot;&gt;&lt;font&nbsp;face=&quot;Calibri,&nbsp;sans-serif&quot;&nbsp;style=&quot;font-size:11pt&quot;&nbsp;color=&quot;#000000&quot;&gt;&lt;b&gt;From:&lt;/b&gt;&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;rousskov@measurement-factory.com&gt;&lt;br&gt;<br>
&lt;b&gt;Sent:&lt;/b&gt;&nbsp;Tuesday,&nbsp;August&nbsp;25,&nbsp;2020&nbsp;8:41&nbsp;AM&lt;br&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;Mathew&nbsp;Brown&nbsp;&lt;mbrown8918@outlook.com&gt;;&nbsp;squid-users@lists.squid-cache.org&nbsp;&lt;squid-users@lists.squid-cache.org&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[squid-users]&nbsp;Strange&nbsp;Squid&nbsp;SSL&nbsp;Interception&nbsp;Behavior&lt;/font&gt;<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;BodyFragment&quot;&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11pt;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;PlainText&quot;&gt;On&nbsp;8/24/20&nbsp;6:21&nbsp;PM,&nbsp;Mathew&nbsp;Brown&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;whitelist&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;whitelist_http&nbsp;ssl::server_name&nbsp;.httpbin.org&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;splice&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;whitelist&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;whitelist_http&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;rules&nbsp;above&nbsp;only&nbsp;allow&nbsp;CONNECT&nbsp;requests&nbsp;to&nbsp;.httpbin.org&nbsp;domains.&lt;br&gt;<br>
&lt;br&gt;<br>
During&nbsp;step1,&nbsp;when&nbsp;Squid&nbsp;intercepts&nbsp;a&nbsp;TLS&nbsp;connection&nbsp;to&nbsp;an&nbsp;IP&nbsp;address&nbsp;of&lt;br&gt;<br>
an&nbsp;.httpbin.org&nbsp;domain,&nbsp;Squid&nbsp;http_access&nbsp;rules&nbsp;are&nbsp;applied&nbsp;to&nbsp;a&nbsp;(fake)&lt;br&gt;<br>
CONNECT&nbsp;request&nbsp;to&nbsp;the&nbsp;destination&nbsp;IP&nbsp;address.&nbsp;There&nbsp;are&nbsp;no&nbsp;domain&nbsp;names&lt;br&gt;<br>
at&nbsp;that&nbsp;TCP-level&nbsp;bumping&nbsp;stage.&nbsp;Thus,&nbsp;you&nbsp;place&nbsp;your&nbsp;Squid&nbsp;at&nbsp;the&nbsp;mercy&lt;br&gt;<br>
of&nbsp;reverse&nbsp;DSN&nbsp;lookups.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;my&nbsp;environment,&nbsp;reverse&nbsp;DNS&nbsp;does&nbsp;not&nbsp;work&nbsp;for&nbsp;httpbin.org&nbsp;the&nbsp;way&nbsp;you&lt;br&gt;<br>
may&nbsp;expect:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;$&nbsp;host&nbsp;54.236.246.173&lt;br&gt;<br>
&gt;&nbsp;173.246.236.54.in-addr.arpa&nbsp;domain&nbsp;name&nbsp;pointer&nbsp;ec2-54-236-246-173.compute-1.amazonaws.com.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;above&nbsp;AWS&nbsp;domain&nbsp;name&nbsp;does&nbsp;not&nbsp;match&nbsp;your&nbsp;whitelist&nbsp;ACLs,&nbsp;of&nbsp;course,&lt;br&gt;<br>
and,&nbsp;hence,&nbsp;the&nbsp;fake&nbsp;CONNECT&nbsp;request&nbsp;is&nbsp;denied.&nbsp;Denied&nbsp;requests&nbsp;are&lt;br&gt;<br>
bumped&nbsp;to&nbsp;deliver&nbsp;the&nbsp;error&nbsp;message.&nbsp;Bumped&nbsp;requests&nbsp;require&lt;br&gt;<br>
--no-check-certificate&nbsp;or&nbsp;other&nbsp;means&nbsp;of&nbsp;trusting&nbsp;Squid's&nbsp;CA&nbsp;certificate.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;cannot&nbsp;explicitly&nbsp;allow&nbsp;CONNECT&nbsp;requests&nbsp;to&nbsp;httpbin.org&nbsp;IP&lt;br&gt;<br>
addresses&nbsp;(e.g.,&nbsp;because&nbsp;they&nbsp;change&nbsp;too&nbsp;often),&nbsp;then&nbsp;consider&nbsp;allowing&lt;br&gt;<br>
CONNECT&nbsp;to&nbsp;safe&nbsp;ports&nbsp;at&nbsp;any&nbsp;address&nbsp;at&nbsp;step1.&nbsp;If&nbsp;you&nbsp;only&nbsp;intercept&lt;br&gt;<br>
connections&nbsp;to&nbsp;httpbin.org&nbsp;IPs,&nbsp;then&nbsp;you&nbsp;can&nbsp;probably&nbsp;relax&nbsp;your&nbsp;step1&lt;br&gt;<br>
http_access&nbsp;rules&nbsp;to&nbsp;allow&nbsp;all&nbsp;CONNECTs&nbsp;(to&nbsp;safe&nbsp;addresses).&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;many&nbsp;similar&nbsp;questions&nbsp;about&nbsp;allowing&nbsp;CONNECT&nbsp;to&nbsp;IP&nbsp;addresses&lt;br&gt;<br>
on&nbsp;this&nbsp;mailing&nbsp;list.&nbsp;You&nbsp;may&nbsp;be&nbsp;able&nbsp;to&nbsp;find&nbsp;more&nbsp;detailed&nbsp;advice&nbsp;or&lt;br&gt;<br>
instructions&nbsp;by&nbsp;searching&nbsp;for&nbsp;those&nbsp;mailing&nbsp;list&nbsp;threads.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;$&nbsp;wget&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org&quot;&gt;https://httpbin.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;--2020-08-24&nbsp;17:48:34--&nbsp;&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org/&quot;&gt;https://httpbin.org/&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;Resolving&nbsp;httpbin.org&nbsp;(httpbin.org)...&nbsp;54.236.246.173,&nbsp;3.220.112.94&lt;br&gt;<br>
&gt;&nbsp;Connecting&nbsp;to&nbsp;httpbin.org&nbsp;(httpbin.org)|54.236.246.173|:443...&nbsp;connected.&lt;br&gt;<br>
&gt;&nbsp;ERROR:&nbsp;cannot&nbsp;verify&nbsp;httpbin.org's&nbsp;certificate,&nbsp;issued&nbsp;by&nbsp;‘O=Internet&lt;br&gt;<br>
&gt;&nbsp;Widgits&nbsp;Pty&nbsp;Ltd,ST=Some-State,C=AU’:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;Self-signed&nbsp;certificate&nbsp;encountered.&lt;br&gt;<br>
&gt;&nbsp;To&nbsp;connect&nbsp;to&nbsp;httpbin.org&nbsp;insecurely,&nbsp;use&nbsp;`--no-check-certificate'.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;$&nbsp;wget&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org&quot;&gt;https://httpbin.org&lt;/a&gt;&nbsp;--no-check-certificate&lt;br&gt;<br>
&gt;&nbsp;--2020-08-24&nbsp;17:48:40--&nbsp;&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org/&quot;&gt;https://httpbin.org/&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;Resolving&nbsp;httpbin.org&nbsp;(httpbin.org)...&nbsp;3.220.112.94,&nbsp;54.236.246.173&lt;br&gt;<br>
&gt;&nbsp;Connecting&nbsp;to&nbsp;httpbin.org&nbsp;(httpbin.org)|3.220.112.94|:443...&nbsp;connected.&lt;br&gt;<br>
&gt;&nbsp;WARNING:&nbsp;cannot&nbsp;verify&nbsp;httpbin.org's&nbsp;certificate,&nbsp;issued&nbsp;by&nbsp;‘O=Internet&lt;br&gt;<br>
&gt;&nbsp;Widgits&nbsp;Pty&nbsp;Ltd,ST=Some-State,C=AU’:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;Self-signed&nbsp;certificate&nbsp;encountered.&lt;br&gt;<br>
&gt;&nbsp;HTTP&nbsp;request&nbsp;sent,&nbsp;awaiting&nbsp;response...&nbsp;403&nbsp;Forbidden&lt;br&gt;<br>
&gt;&nbsp;2020-08-24&nbsp;17:48:40&nbsp;ERROR&nbsp;403:&nbsp;Forbidden.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;looking&nbsp;at&nbsp;access.log&nbsp;shows:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1598305800.974&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;192.168.123.214&nbsp;TCP_DENIED/200&nbsp;0&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;for&nbsp;the&nbsp;first&nbsp;request&nbsp;(without&nbsp;the&nbsp;--no-check-certificate)&nbsp;and&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;following&nbsp;for&nbsp;the&nbsp;2nd&nbsp;request&nbsp;(with&nbsp;the&nbsp;--no-check-certificate):&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1598305812.292&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;192.168.123.214&nbsp;TCP_DENIED/200&nbsp;0&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;1598305812.300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;192.168.123.214&nbsp;NONE/403&nbsp;3795&nbsp;GET&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://httpbin.org/&quot;&gt;https://httpbin.org/&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;looking&nbsp;at&nbsp;cache.log&nbsp;shows:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;cat&nbsp;/var/log/squid/cache.log&nbsp;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;&quot;28&quot;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:50:00.972&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:50:00.972&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:50:12.290&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:50:12.290&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;so&nbsp;it&nbsp;never&nbsp;matches&nbsp;on&nbsp;the&nbsp;httpbin.org&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;now,&nbsp;if&nbsp;I&nbsp;add&nbsp;the&nbsp;following&nbsp;line&nbsp;to&nbsp;my&nbsp;configuration:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;localnet&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;right&nbsp;before&nbsp;the:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;line&nbsp;it&nbsp;works&nbsp;and&nbsp;I&nbsp;see&nbsp;the&nbsp;following&nbsp;in&nbsp;access.log:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1598305979.004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;192.168.123.214&nbsp;NONE/200&nbsp;0&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;54.236.246.173:443&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;1598305980.016&nbsp;&nbsp;&nbsp;1012&nbsp;192.168.123.214&nbsp;TCP_TUNNEL/200&nbsp;15370&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;httpbin.org:443&nbsp;-&nbsp;ORIGINAL_DST/54.236.246.173&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;I&nbsp;see&nbsp;the&nbsp;following&nbsp;in&nbsp;cache.log:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;cat&nbsp;/var/log/squid/cache.log&nbsp;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;&quot;28&quot;&nbsp;|&nbsp;grep&nbsp;-i&nbsp;httpbin&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.000&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.000&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:54.236.246.173&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;RegexData.cc(43)&nbsp;match:&nbsp;checking&lt;br&gt;<br>
&gt;&nbsp;'httpbin.org:443'&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(42)&nbsp;match:&nbsp;checking&lt;br&gt;<br>
&gt;&nbsp;'httpbin.org'&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,7|&nbsp;ServerName.cc(32)&lt;br&gt;<br>
&gt;&nbsp;aclHostDomainCompare:&nbsp;Match:httpbin.org&nbsp;&lt;&gt;&nbsp;&nbsp;.httpbin.org&lt;br&gt;<br>
&gt;&nbsp;2020/08/24&nbsp;17:52:59.005&nbsp;kid1|&nbsp;28,3|&nbsp;ServerName.cc(47)&nbsp;match:&lt;br&gt;<br>
&gt;&nbsp;'httpbin.org'&nbsp;found&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;What's&nbsp;puzzling&nbsp;is&nbsp;why&nbsp;adding&nbsp;the&nbsp;'allow&nbsp;localnet'&nbsp;line&nbsp;changes&nbsp;the&nbsp;ACL&lt;br&gt;<br>
&gt;&nbsp;logic&nbsp;for&nbsp;.httpbin.org&nbsp;and&nbsp;why&nbsp;the&nbsp;original&nbsp;configuration&nbsp;does&nbsp;not&nbsp;work.&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;ideas?&nbsp;Thanks&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;PS.&nbsp;I&nbsp;reproduced&nbsp;the&nbsp;exact&nbsp;same&nbsp;scenario&nbsp;on&nbsp;Ubuntu&nbsp;20.04&nbsp;with&nbsp;Squid&nbsp;4.12&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;squid-users@lists.squid-cache.org&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
