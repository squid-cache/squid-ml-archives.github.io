<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Hi,&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;create&nbsp;for&nbsp;my&nbsp;home&nbsp;network&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;implement&nbsp;filtering&nbsp;rules&nbsp;based&nbsp;on&nbsp;website&nbsp;names&nbsp;mainly.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;have&nbsp;been&nbsp;looking&nbsp;at&nbsp;using&nbsp;a&nbsp;Raspberry&nbsp;pi&nbsp;3B+&nbsp;running&nbsp;pi&nbsp;OS.&nbsp;I<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configured&nbsp;it&nbsp;to&nbsp;be&nbsp;a&nbsp;Wifi&nbsp;access&nbsp;point&nbsp;using&nbsp;RaspAP&nbsp;quick<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;install.&nbsp;The&nbsp;Wifi&nbsp;network&nbsp;on&nbsp;which&nbsp;the&nbsp;filtering&nbsp;option&nbsp;is&nbsp;to&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;implemented&nbsp;is&nbsp;with&nbsp;IP&nbsp;10.3.141.xxx.&nbsp;The&nbsp;router&nbsp;is&nbsp;at&nbsp;address<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.3.141.1.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;have&nbsp;the&nbsp;following&nbsp;squid.conf&nbsp;file&nbsp;which&nbsp;I&nbsp;tried&nbsp;to&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;based&nbsp;on&nbsp;different&nbsp;mails,&nbsp;websites&nbsp;and&nbsp;blogs&nbsp;I&nbsp;read&nbsp;:&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&nbsp;#https&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;563&nbsp;#&nbsp;snews&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;873&nbsp;#&nbsp;rsync&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;#&nbsp;ftp&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp;#&nbsp;gopher&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp;#&nbsp;wais&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;#&nbsp;unregistered&nbsp;ports&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp;#&nbsp;http-mgmt&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp;#&nbsp;gss-http&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp;#&nbsp;filemaker&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp;#&nbsp;multiling&nbsp;http&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Le&nbsp;réseau&nbsp;local&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;LocalNet&nbsp;src&nbsp;10.3.141.0/24&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;bump_step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;bump_step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;bump_step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Définition&nbsp;des&nbsp;autorisations&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;manager&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;localhost&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;allow&nbsp;LocalNet&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#Définition&nbsp;des&nbsp;ports&nbsp;d'écoute&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;8080&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http_port&nbsp;3128&nbsp;intercept&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https_port&nbsp;3129&nbsp;intercept&nbsp;ssl-bump&nbsp;\&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;tls-cert=/etc/squid/cert/example.crt&nbsp;\&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;tls-key=/etc/squid/cert/example.key&nbsp;\&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;generate-host-certificates=on &nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_program&nbsp;/usr/lib/squid/security_file_certgen&nbsp;-s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslcrtd_children&nbsp;5&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;peek&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acl&nbsp;tls_whitelist&nbsp;ssl::server_name&nbsp;.example.com&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;splice&nbsp;tls_whitelist&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssl_bump&nbsp;terminate&nbsp;all&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coredump_dir&nbsp;/var/spool/squid&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;^ftp:&nbsp;1440&nbsp;20%&nbsp;10080&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;^gopher:&nbsp;1440&nbsp;0%&nbsp;1440&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;0%&nbsp;0&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;refresh_pattern&nbsp;.&nbsp;0&nbsp;20%&nbsp;4320&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_dir&nbsp;ufs&nbsp;/cache&nbsp;400&nbsp;16&nbsp;256&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_access_log&nbsp;/var/log/squid/access.log&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache_effective_user&nbsp;proxy&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;If&nbsp;I&nbsp;set&nbsp;up&nbsp;on&nbsp;a&nbsp;device&nbsp;connected&nbsp;to&nbsp;the&nbsp;access&nbsp;point&nbsp;a&nbsp;proxy<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;manually&nbsp;ie&nbsp;10.3.141.1&nbsp;on&nbsp;port&nbsp;8080,&nbsp;I&nbsp;can&nbsp;access&nbsp;the&nbsp;internet.&nbsp;If<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;put&nbsp;the&nbsp;following&nbsp;rules&nbsp;for&nbsp;iptables&nbsp;to&nbsp;use&nbsp;in&nbsp;files&nbsp;rules.v4&nbsp;:&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;*nat&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;PREROUTING&nbsp;-i&nbsp;eth0&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;DNAT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--to-destination&nbsp;10.3.141.1:3128&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;PREROUTING&nbsp;-i&nbsp;eth0&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--to-ports&nbsp;3128&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;PREROUTING&nbsp;-i&nbsp;eth0&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;DNAT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--to-destination&nbsp;10.3.141.1:3129&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;PREROUTING&nbsp;-i&nbsp;eth0&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--to-ports&nbsp;3129&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-A&nbsp;POSTROUTING&nbsp;-s&nbsp;10.3.141.0/24&nbsp;-o&nbsp;eth0&nbsp;-j&nbsp;MASQUERADE&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Now,&nbsp;if&nbsp;I&nbsp;remove&nbsp;the&nbsp;manual&nbsp;proxy&nbsp;configuration&nbsp;of&nbsp;the&nbsp;device<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connected&nbsp;to&nbsp;the&nbsp;access&nbsp;point,&nbsp;I&nbsp;can't&nbsp;connect&nbsp;to&nbsp;the&nbsp;internet.&nbsp;If<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;leave&nbsp;the&nbsp;manual&nbsp;proxy&nbsp;configuration&nbsp;it&nbsp;does&nbsp;work&nbsp;and&nbsp;there&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activity&nbsp;logged&nbsp;in&nbsp;/var/log/squid/access.log.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;what&nbsp;might&nbsp;be&nbsp;wrong&nbsp;in&nbsp;my&nbsp;configuration&nbsp;if<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;possible.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Best&nbsp;regards,&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;JF&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
