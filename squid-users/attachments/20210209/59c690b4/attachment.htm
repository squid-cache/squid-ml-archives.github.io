<tt>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Maybe&nbsp;its&nbsp;apparmor.&lt;div&nbsp;dir=&quot;auto&quot;&gt;pinger&nbsp;needs&nbsp;to&nbsp;have&nbsp;a&nbsp;setuid&nbsp;permission&nbsp;as&nbsp;root.&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;its&nbsp;a&nbsp;pinger&nbsp;and&nbsp;needs&nbsp;root&nbsp;privleges&nbsp;as&nbsp;far&nbsp;as&nbsp;i&nbsp;remember.&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Eliezer&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Tue,&nbsp;Feb&nbsp;9,&nbsp;2021,&nbsp;17:03&nbsp;Chris&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:ml%2Bsquidusers@kisswebdev.com&quot;&gt;ml+squidusers@kisswebdev.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
thank&nbsp;you&nbsp;Amos,&nbsp;this&nbsp;is&nbsp;bringing&nbsp;me&nbsp;into&nbsp;the&nbsp;right&nbsp;direction.&lt;br&gt;<br>
&lt;br&gt;<br>
Now&nbsp;I&nbsp;know&nbsp;what&nbsp;I&#39;ll&nbsp;have&nbsp;to&nbsp;debug:&nbsp;the&nbsp;pinger.&lt;br&gt;<br>
&lt;br&gt;<br>
Cache.log&nbsp;shows:&lt;br&gt;<br>
&lt;br&gt;<br>
2021/02/09&nbsp;14:49:27|&nbsp;pinger:&nbsp;Initialising&nbsp;ICMP&nbsp;pinger&nbsp;...&lt;br&gt;<br>
2021/02/09&nbsp;14:49:27|&nbsp;pinger:&nbsp;ICMP&nbsp;socket&nbsp;opened.&lt;br&gt;<br>
2021/02/09&nbsp;14:49:27|&nbsp;pinger:&nbsp;ICMPv6&nbsp;socket&nbsp;opened&lt;br&gt;<br>
2021/02/09&nbsp;14:49:27|&nbsp;Pinger&nbsp;exiting.&lt;br&gt;<br>
&lt;br&gt;<br>
and&nbsp;that&nbsp;last&nbsp;line&nbsp;&quot;pinger&nbsp;exiting&quot;&nbsp;looks&nbsp;like&nbsp;a&nbsp;problem&nbsp;here.&lt;br&gt;<br>
&lt;br&gt;<br>
Squid&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;package&nbsp;from&nbsp;ubuntu&nbsp;bionic,&nbsp;it&#39;s&nbsp;configured&nbsp;with&nbsp;&lt;br&gt;<br>
&quot;--enable-icmp&quot;&nbsp;as&nbsp;stated&nbsp;by&nbsp;squid&nbsp;-v.&lt;br&gt;<br>
&lt;br&gt;<br>
Now&nbsp;I&nbsp;explicitly&nbsp;wrote&nbsp;a&nbsp;&quot;pinger_enable&nbsp;on&quot;&nbsp;and&nbsp;the&nbsp;pinger_program&nbsp;path&nbsp;&lt;br&gt;<br>
(in&nbsp;this&nbsp;case:&nbsp;&quot;/usr/lib/squid/pinger&quot;&nbsp;)&nbsp;into&nbsp;the&nbsp;squid.confÂ &nbsp;(as&nbsp;well&nbsp;&lt;br&gt;<br>
as&nbsp;icmp_query&nbsp;on)&nbsp;and&nbsp;reconfigured&nbsp;but&nbsp;the&nbsp;cache.log&nbsp;still&nbsp;shows:&lt;br&gt;<br>
&lt;br&gt;<br>
&quot;Pinger&nbsp;exiting&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
So&nbsp;I&nbsp;don&#39;t&nbsp;understand&nbsp;why&nbsp;the&nbsp;pinger&nbsp;is&nbsp;exiting.&nbsp;The&nbsp;pinger_program&nbsp;is&nbsp;&lt;br&gt;<br>
owned&nbsp;by&nbsp;root&nbsp;and&nbsp;has&nbsp;0755&nbsp;execution&nbsp;rights.&nbsp;Normal&nbsp;ping&nbsp;commands&nbsp;do&nbsp;&lt;br&gt;<br>
work&nbsp;and&nbsp;show&nbsp;the&nbsp;one&nbsp;originserver&nbsp;at&nbsp;ttl=53&nbsp;and&nbsp;time=50&nbsp;while&nbsp;the&nbsp;other&nbsp;&lt;br&gt;<br>
is&nbsp;at&nbsp;ttl=56&nbsp;and&nbsp;time=155&nbsp;-&nbsp;so&nbsp;a&nbsp;RTT&nbsp;comparison&nbsp;for&nbsp;weighted-round-robin&nbsp;&lt;br&gt;<br>
should&nbsp;work&nbsp;here.&lt;br&gt;<br>
&lt;br&gt;<br>
Any&nbsp;hints&nbsp;on&nbsp;how&nbsp;I&nbsp;can&nbsp;find&nbsp;out&nbsp;why&nbsp;the&nbsp;pinger&nbsp;is&nbsp;exiting?&nbsp;Right&nbsp;now&nbsp;I&#39;m&nbsp;&lt;br&gt;<br>
debuging&nbsp;with&nbsp;debug_options&nbsp;ALL,1&nbsp;44,3&nbsp;15,8&nbsp;but&nbsp;don&#39;t&nbsp;see&nbsp;a&nbsp;reason&nbsp;why&nbsp;&lt;br&gt;<br>
the&nbsp;pinger&nbsp;exits.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;Originservers&nbsp;are&nbsp;defined&nbsp;by&nbsp;(with&nbsp;icp/htcp&nbsp;disabled):&lt;br&gt;<br>
&lt;br&gt;<br>
cache_peer&nbsp;[ipv4_address_srv1]&nbsp;parent&nbsp;[http_port]&nbsp;0&nbsp;no-digest&nbsp;&lt;br&gt;<br>
no-netdb-exchange&nbsp;weighted-round-robin&nbsp;originserver&nbsp;name=srv1&nbsp;&lt;br&gt;<br>
forceddomain=[domainname]&lt;br&gt;<br>
&lt;br&gt;<br>
cache_peer&nbsp;[ipv4_address_srv2]&nbsp;parent&nbsp;[http_port]&nbsp;0&nbsp;no-digest&nbsp;&lt;br&gt;<br>
no-netdb-exchange&nbsp;weighted-round-robin&nbsp;originserver&nbsp;name=srv2&nbsp;&lt;br&gt;<br>
forceddomain=[domainname]&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;help,&lt;br&gt;<br>
&lt;br&gt;<br>
Chris&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;09.02.21&nbsp;04:23,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;9/02/21&nbsp;3:40&nbsp;am,&nbsp;Chris&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;use&nbsp;squid&nbsp;(version&nbsp;3.5.27)&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;in&nbsp;reverse&nbsp;proxy&nbsp;mode&nbsp;in&nbsp;regard&nbsp;to&nbsp;originserver&nbsp;health&nbsp;checks&nbsp;and&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;load&nbsp;balancing.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;So&nbsp;far&nbsp;I&nbsp;had&nbsp;been&nbsp;using&nbsp;the&nbsp;round-robin&nbsp;originserver&nbsp;cache&nbsp;peer&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;selection&nbsp;algorithm&nbsp;while&nbsp;using&nbsp;weight&nbsp;to&nbsp;favor&nbsp;originservers&nbsp;with&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;closer&nbsp;proximity/lower&nbsp;latency.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Ok.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;problem:&nbsp;if&nbsp;one&nbsp;cache_peer&nbsp;is&nbsp;dead&nbsp;it&nbsp;takes&nbsp;ages&nbsp;for&nbsp;squid&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;choose&nbsp;the&nbsp;second&nbsp;originserver.&nbsp;It&nbsp;does&nbsp;look&nbsp;as&nbsp;if&nbsp;(e.g.&nbsp;if&nbsp;one&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;originserver&nbsp;has&nbsp;a&nbsp;weight&nbsp;of&nbsp;32,&nbsp;the&nbsp;other&nbsp;of&nbsp;2)&nbsp;squid&nbsp;tries&nbsp;the&nbsp;dead&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;server&nbsp;several&nbsp;times&nbsp;before&nbsp;accessing&nbsp;the&nbsp;other&nbsp;one.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;DEAD&nbsp;check&nbsp;by&nbsp;default&nbsp;requires&nbsp;10&nbsp;failures&nbsp;in&nbsp;a&nbsp;row&nbsp;to&nbsp;trigger.&nbsp;&lt;br&gt;<br>
&gt;&nbsp;This&nbsp;is&nbsp;configurable&nbsp;with&nbsp;the&nbsp;connect-fail-limit=N&nbsp;option.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Now&nbsp;instead&nbsp;of&nbsp;using&nbsp;round-robin&nbsp;plus&nbsp;weight&nbsp;it&nbsp;would&nbsp;be&nbsp;best&nbsp;to&nbsp;use&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;weighted-round-robin.&nbsp;But&nbsp;as&nbsp;I&nbsp;understand&nbsp;it,&nbsp;this&nbsp;wouldn&#39;t&nbsp;work&nbsp;with&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;originserver&nbsp;if&nbsp;(as&nbsp;it&#39;s&nbsp;normally&nbsp;the&nbsp;case)&nbsp;the&nbsp;originserver&nbsp;won&#39;t&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;handle&nbsp;icp&nbsp;or&nbsp;htcp&nbsp;requests.&nbsp;Did&nbsp;I&nbsp;miss&nbsp;sth.&nbsp;here?&nbsp;Would&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;background-ping&nbsp;work?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Well,&nbsp;kind&nbsp;of.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;ICP/HTCP&nbsp;is&nbsp;just&nbsp;a&nbsp;protocol.&nbsp;Most&nbsp;origin&nbsp;servers&nbsp;do&nbsp;not&nbsp;support&nbsp;them,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;some&nbsp;do.&nbsp;Especially&nbsp;if&nbsp;the&nbsp;server&nbsp;is&nbsp;not&nbsp;a&nbsp;true&nbsp;origin&nbsp;but&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;reverse-proxy.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&nbsp;tried&nbsp;weighted-round-robin&nbsp;and&nbsp;background-ping&nbsp;on&nbsp;originservers&nbsp;but&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;got&nbsp;only&nbsp;an&nbsp;evenly&nbsp;distributed&nbsp;request&nbsp;handling&nbsp;even&nbsp;if&nbsp;ones&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;originservers&nbsp;rtt&nbsp;would&nbsp;be&nbsp;less&nbsp;than&nbsp;half&nbsp;of&nbsp;the&nbsp;others.&nbsp;But&nbsp;then&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;again,&nbsp;those&nbsp;originservers&nbsp;won&#39;t&nbsp;handle&nbsp;icp&nbsp;requests.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;RTT&nbsp;is&nbsp;retrieved&nbsp;from&nbsp;ICMP&nbsp;data&nbsp;primarily.&nbsp;Check&nbsp;your&nbsp;Squid&nbsp;is&nbsp;built&nbsp;&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;--enable-icmp,&nbsp;the&nbsp;pinger&nbsp;helper&nbsp;is&nbsp;operational,&nbsp;and&nbsp;that&nbsp;ICMP&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Echo&nbsp;traffic&nbsp;is&nbsp;working&nbsp;on&nbsp;all&nbsp;possible&nbsp;network&nbsp;routes&nbsp;between&nbsp;your&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;and&nbsp;the&nbsp;peer&nbsp;server(s).&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;So&nbsp;what&#39;s&nbsp;the&nbsp;best&nbsp;solution&nbsp;to&nbsp;a)&nbsp;choose&nbsp;the&nbsp;originserver&nbsp;with&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;lowest&nbsp;rtt&nbsp;and&nbsp;b)&nbsp;still&nbsp;have&nbsp;a&nbsp;fast&nbsp;switch&nbsp;if&nbsp;one&nbsp;of&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&gt;&nbsp;originservers&nbsp;switches&nbsp;into&nbsp;dead&nbsp;state?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Check&nbsp;whether&nbsp;the&nbsp;RTT&nbsp;is&nbsp;actually&nbsp;being&nbsp;measured&nbsp;properly&nbsp;by&nbsp;Squid&nbsp;&lt;br&gt;<br>
&gt;&nbsp;(debug_options&nbsp;ALL,1&nbsp;44,3&nbsp;15,8).&nbsp;If&nbsp;the&nbsp;peers&nbsp;are&nbsp;fast&nbsp;enough&nbsp;&lt;br&gt;<br>
&gt;&nbsp;responding&nbsp;or&nbsp;close&nbsp;enough&nbsp;in&nbsp;the&nbsp;network&nbsp;RTT&nbsp;could&nbsp;come&nbsp;out&nbsp;as&nbsp;a&nbsp;0&nbsp;&lt;br&gt;<br>
&gt;&nbsp;value&nbsp;or&nbsp;some&nbsp;N&nbsp;value&nbsp;equal&nbsp;for&nbsp;both&nbsp;peer.&nbsp;ie.&nbsp;neither&nbsp;being&nbsp;&quot;closer&quot;.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Amos&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&nbsp;rel=&quot;noreferrer&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&nbsp;rel=&quot;noreferrer&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
