<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;your&nbsp;answers&nbsp;Alex.&lt;br&gt;&lt;br&gt;&lt;/div&gt;For&nbsp;case&nbsp;1,&nbsp;I&nbsp;understand&nbsp;that&nbsp;should&nbsp;not&nbsp;be&nbsp;a&nbsp;problem,&nbsp;since&nbsp;squid&nbsp;is&nbsp;the&nbsp;one&nbsp;asking&nbsp;for&nbsp;DNS&nbsp;resolution.&lt;br&gt;&lt;/div&gt;For&nbsp;case&nbsp;2&nbsp;and&nbsp;3,&nbsp;what&nbsp;you&nbsp;are&nbsp;saying&nbsp;is&nbsp;that&nbsp;the&nbsp;browser&nbsp;is&nbsp;requesting&nbsp;the&nbsp;DNS&nbsp;lookup&nbsp;first,&nbsp;correct?&nbsp;Hence&nbsp;the&nbsp;need&nbsp;for&nbsp;a&nbsp;reverse&nbsp;DNS&nbsp;from&nbsp;squid,&nbsp;since&nbsp;squid&nbsp;does&nbsp;not&nbsp;know&nbsp;at&nbsp;that&nbsp;point&nbsp;what&nbsp;domain&nbsp;the&nbsp;IP&nbsp;belongs&nbsp;to.&nbsp;But&nbsp;they&nbsp;still&nbsp;had&nbsp;to&nbsp;query&nbsp;the&nbsp;DNS&nbsp;server,&nbsp;so&nbsp;that&nbsp;entry&nbsp;is&nbsp;in&nbsp;that&nbsp;DNS&nbsp;cache,&nbsp;and&nbsp;it&nbsp;should&nbsp;have&nbsp;the&nbsp;same&nbsp;domain&nbsp;as&nbsp;the&nbsp;lookup&nbsp;that&nbsp;the&nbsp;user&nbsp;entered.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;if&nbsp;I&nbsp;have&nbsp;a&nbsp;local&nbsp;dns&nbsp;(maybe&nbsp;dnsmasq)&nbsp;that&nbsp;both&nbsp;squid&nbsp;and&nbsp;the&nbsp;user&nbsp;use,&nbsp;from&nbsp;what&nbsp;I&nbsp;understand&nbsp;I&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;use&nbsp;squid&#39;s&nbsp;dns_nameservers&nbsp;directive&nbsp;to&nbsp;point&nbsp;to&nbsp;that&nbsp;DNS,&nbsp;and&nbsp;it&nbsp;should&nbsp;return&nbsp;fine&nbsp;since&nbsp;it&nbsp;is&nbsp;stored&nbsp;right&nbsp;there&nbsp;in&nbsp;the&nbsp;cache.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;the&nbsp;user&nbsp;is&nbsp;trying&nbsp;to&nbsp;use&nbsp;a&nbsp;different&nbsp;DNS&nbsp;server&nbsp;other&nbsp;than&nbsp;the&nbsp;local&nbsp;one,&nbsp;then&nbsp;fine,&nbsp;I&nbsp;will&nbsp;just&nbsp;decrypt&nbsp;their&nbsp;traffic&nbsp;as&nbsp;punishment.&nbsp;ğŸ˜&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Fri,&nbsp;Feb&nbsp;26,&nbsp;2021&nbsp;at&nbsp;9:44&nbsp;AM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2/26/21&nbsp;7:35&nbsp;AM,&nbsp;Justin&nbsp;Michael&nbsp;Schwartzbeck&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;Yes,&nbsp;many&nbsp;HTTPS&nbsp;transactions&nbsp;do&nbsp;not&nbsp;expose&nbsp;destination&nbsp;domain&nbsp;until&nbsp;it&lt;br&gt;<br>
&gt;&gt;&nbsp;is&nbsp;too&nbsp;late&nbsp;to&nbsp;decide&nbsp;whether&nbsp;to&nbsp;bump&nbsp;them,&nbsp;and&nbsp;reverse&nbsp;DNS&nbsp;lookups&nbsp;are&lt;br&gt;<br>
&gt;&gt;&nbsp;often&nbsp;unreliable.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;wonder&nbsp;why&nbsp;this&nbsp;would&nbsp;be.&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;suspect&nbsp;you&nbsp;assume&nbsp;that&nbsp;a&nbsp;forward&nbsp;DNS&nbsp;lookup&nbsp;(A&nbsp;or&nbsp;AAAA&nbsp;query)&nbsp;answer&lt;br&gt;<br>
is&nbsp;always&nbsp;the&nbsp;&quot;opposite&quot;&nbsp;of&nbsp;a&nbsp;reverse&nbsp;DSN&nbsp;lookup&nbsp;(PTR&nbsp;query)&nbsp;answer.&lt;br&gt;<br>
AFAIK,&nbsp;that&nbsp;is&nbsp;not&nbsp;how&nbsp;DNS&nbsp;is&nbsp;defined.&nbsp;From&nbsp;DNS&nbsp;point&nbsp;of&nbsp;view,&nbsp;each&nbsp;of&lt;br&gt;<br>
those&nbsp;answers&nbsp;is&nbsp;totally&nbsp;independent&nbsp;--&nbsp;there&nbsp;is&nbsp;no&nbsp;1:1&nbsp;or&nbsp;even&nbsp;1:N&lt;br&gt;<br>
mapping&nbsp;between&nbsp;them;&nbsp;the&nbsp;answers&nbsp;even&nbsp;come&nbsp;from&nbsp;different&nbsp;DNS&nbsp;zones!Â &nbsp;A&lt;br&gt;<br>
caching&nbsp;DNS&nbsp;resolver&nbsp;would&nbsp;probably&nbsp;violate&nbsp;the&nbsp;DNS&nbsp;protocol&nbsp;if&nbsp;it&nbsp;uses&lt;br&gt;<br>
a&nbsp;cached&nbsp;A&nbsp;or&nbsp;AAAA&nbsp;record&nbsp;to&nbsp;answer&nbsp;a&nbsp;PTR&nbsp;query.&nbsp;Disclaimer:&nbsp;I&nbsp;am&nbsp;not&nbsp;a&lt;br&gt;<br>
DNS&nbsp;expert.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;From&nbsp;my&nbsp;understanding,&nbsp;when&nbsp;you&nbsp;open&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;browser&nbsp;and&nbsp;browse&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://www.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;www.google.com&lt;/a&gt;,&nbsp;the&nbsp;very&lt;br&gt;<br>
&gt;&nbsp;first&nbsp;thing&nbsp;that&nbsp;happens&nbsp;is&nbsp;you&nbsp;do&nbsp;a&nbsp;DNS&nbsp;resolution&nbsp;so&nbsp;that&nbsp;you&nbsp;know&lt;br&gt;<br>
&gt;&nbsp;what&nbsp;IP&nbsp;to&nbsp;send&nbsp;the&nbsp;CONNECT&nbsp;request&nbsp;and&nbsp;subsequent&nbsp;HTTPS&nbsp;records&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;first&nbsp;place.&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;happens&nbsp;depends&nbsp;on&nbsp;the&nbsp;browser&nbsp;and&nbsp;the&nbsp;proxy&nbsp;port:&lt;br&gt;<br>
&lt;br&gt;<br>
1.&nbsp;For&nbsp;forward&nbsp;proxies:&nbsp;Some&nbsp;browsers&nbsp;will&nbsp;not&nbsp;do&nbsp;DNS&nbsp;lookups.&nbsp;They&nbsp;will&lt;br&gt;<br>
send&nbsp;a&nbsp;CONNECT&nbsp;request&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://example.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;example.com&lt;/a&gt;,&nbsp;allowing&nbsp;Squid&nbsp;to&nbsp;do&nbsp;the&nbsp;DNS&lt;br&gt;<br>
lookup.&nbsp;In&nbsp;this&nbsp;case,&nbsp;Squid&nbsp;dstdomain&nbsp;configured&nbsp;with&nbsp;a&nbsp;host&nbsp;name&nbsp;will&lt;br&gt;<br>
work&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
2.&nbsp;For&nbsp;forward&nbsp;proxies:&nbsp;Some&nbsp;browsers&nbsp;do&nbsp;DNS&nbsp;lookups.&nbsp;They&nbsp;will&nbsp;send&nbsp;a&lt;br&gt;<br>
CONNECT&nbsp;request&nbsp;to&nbsp;one&nbsp;of&nbsp;the&nbsp;returned&nbsp;IP&nbsp;addresses.&lt;br&gt;<br>
&lt;br&gt;<br>
3.&nbsp;For&nbsp;interception&nbsp;proxies:&nbsp;All&nbsp;browsers&nbsp;do&nbsp;DNS&nbsp;lookups.&nbsp;They&nbsp;open&nbsp;a&lt;br&gt;<br>
TCP&nbsp;connection&nbsp;to&nbsp;one&nbsp;of&nbsp;the&nbsp;returned&nbsp;IP&nbsp;addresses.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;cases&nbsp;2&nbsp;and&nbsp;3,&nbsp;Squid&nbsp;dstdomain&nbsp;will&nbsp;have&nbsp;to&nbsp;do&nbsp;a&nbsp;reverse&nbsp;DNS&nbsp;lookup&lt;br&gt;<br>
(PTR&nbsp;query).&nbsp;In&nbsp;many&nbsp;cases,&nbsp;that&nbsp;lookup&nbsp;either&nbsp;fails&nbsp;or&nbsp;returns&nbsp;a&lt;br&gt;<br>
different&nbsp;domain&nbsp;name&nbsp;than&nbsp;the&nbsp;domain&nbsp;the&nbsp;browser&nbsp;started&nbsp;with.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;So&nbsp;we&nbsp;would&nbsp;have&nbsp;the&nbsp;IP&nbsp;already,&nbsp;and&nbsp;the&nbsp;hostname&nbsp;that&nbsp;was&lt;br&gt;<br>
&gt;&nbsp;looked&nbsp;up&nbsp;already&nbsp;in&nbsp;the&nbsp;DNS&nbsp;cache,&nbsp;right?&nbsp;Why&nbsp;wouldn&#39;t&nbsp;squid&nbsp;just&nbsp;be&lt;br&gt;<br>
&gt;&nbsp;able&nbsp;to&nbsp;reach&nbsp;in&nbsp;there,&nbsp;match&nbsp;the&nbsp;IP&nbsp;that&nbsp;DNS&nbsp;returned,&nbsp;and&nbsp;then&nbsp;pull&lt;br&gt;<br>
&gt;&nbsp;that&nbsp;hostname&nbsp;out&nbsp;to&nbsp;compare&nbsp;against&nbsp;the&nbsp;ACLs?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Thu,&nbsp;Feb&nbsp;25,&nbsp;2021&nbsp;at&nbsp;2:57&nbsp;PM&nbsp;Alex&nbsp;Rousskov&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;mailto:&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â On&nbsp;2/25/21&nbsp;2:07&nbsp;PM,&nbsp;Justin&nbsp;Michael&nbsp;Schwartzbeck&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;I&nbsp;have&nbsp;thus&nbsp;far&nbsp;used&nbsp;dstdomain&nbsp;acl&nbsp;for&nbsp;bypassing&nbsp;ssl&nbsp;bump&nbsp;on&nbsp;sites&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â that&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;we&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;decrypt,&nbsp;like&nbsp;banking&nbsp;sites.&nbsp;It&nbsp;seems&nbsp;to&nbsp;work&nbsp;for&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â some&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;sites,&nbsp;but&nbsp;not&nbsp;for&nbsp;others.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â Yes,&nbsp;many&nbsp;HTTPS&nbsp;transactions&nbsp;do&nbsp;not&nbsp;expose&nbsp;destination&nbsp;domain&nbsp;until&nbsp;it&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â is&nbsp;too&nbsp;late&nbsp;to&nbsp;decide&nbsp;whether&nbsp;to&nbsp;bump&nbsp;them,&nbsp;and&nbsp;reverse&nbsp;DNS&nbsp;lookups&nbsp;are&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â often&nbsp;unreliable.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;I&nbsp;was&nbsp;thinking&nbsp;about&nbsp;this,&nbsp;and&nbsp;it&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;if&nbsp;we&nbsp;are&nbsp;using&nbsp;the&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;squid&nbsp;proxy&nbsp;with&nbsp;a&nbsp;dns&nbsp;server,&nbsp;we&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;check&nbsp;the&nbsp;dns&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â cache&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â &gt;&nbsp;for&nbsp;that&nbsp;IP,&nbsp;and&nbsp;find&nbsp;the&nbsp;associated&nbsp;hostname,&nbsp;and&nbsp;then&nbsp;match&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â against&nbsp;that.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â When&nbsp;you&nbsp;use&nbsp;dstdomain,&nbsp;Squid&nbsp;will&nbsp;do&nbsp;a&nbsp;(reverse)&nbsp;DNS&nbsp;query&nbsp;for&nbsp;you&nbsp;as&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â necessary&nbsp;(including&nbsp;DNS&nbsp;cache&nbsp;lookups)&nbsp;unless&nbsp;you&nbsp;specify&nbsp;a&nbsp;-n&nbsp;option&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â that&nbsp;is&nbsp;documented&nbsp;to&nbsp;disable&nbsp;all&nbsp;such&nbsp;operations.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â In&nbsp;many&nbsp;cases,&nbsp;you&nbsp;should&nbsp;be&nbsp;using&nbsp;ssl::server_name&nbsp;instead&nbsp;of&nbsp;dstdomain&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â or&nbsp;dst&nbsp;ACL,&nbsp;but&nbsp;you&nbsp;may&nbsp;have&nbsp;to&nbsp;use&nbsp;a&nbsp;combination&nbsp;of&nbsp;various&nbsp;ACLs&nbsp;to&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â cover&nbsp;all&nbsp;the&nbsp;cases&nbsp;you&nbsp;care&nbsp;about.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â HTH,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;Â &nbsp;Â &nbsp;Â Alex.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
