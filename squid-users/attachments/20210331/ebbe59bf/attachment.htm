<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&#39;ve&nbsp;recently&nbsp;had&nbsp;an&nbsp;incident&nbsp;where&nbsp;misbehaving&nbsp;cluster&nbsp;of&nbsp;clients&nbsp;started&nbsp;fetching&nbsp;4MB&nbsp;file&nbsp;from&nbsp;squid&nbsp;cache&nbsp;with&nbsp;~1200&nbsp;RPS&nbsp;(slowed&nbsp;down&nbsp;to&nbsp;600&nbsp;RPS&nbsp;later)&nbsp;which&nbsp;resulted&nbsp;in&nbsp;up&nbsp;to&nbsp;2Gb/s&nbsp;of&nbsp;traffic&nbsp;sent&nbsp;to&nbsp;clients&nbsp;from&nbsp;each&nbsp;of&nbsp;our&nbsp;squid&nbsp;hosts&nbsp;and&nbsp;quickly&nbsp;overloaded&nbsp;squid.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;use client_delay_pools&nbsp;to&nbsp;limit&nbsp;bandwidth&nbsp;per&nbsp;client&nbsp;and&nbsp;prevent&nbsp;misbehaving&nbsp;actors&nbsp;from&nbsp;saturating&nbsp;client-side&nbsp;network /&nbsp;CPU&nbsp;on&nbsp;squid&nbsp;hosts.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However I&nbsp;can&#39;t&nbsp;get&nbsp;it&nbsp;to&nbsp;work&nbsp;reliably.&nbsp;It&nbsp;seems&nbsp;to&nbsp;be&nbsp;working&nbsp;as&nbsp;expected&nbsp;for&nbsp;cache&nbsp;MISS,&nbsp;e.g.&nbsp;getting&nbsp;a&nbsp;speed&nbsp;limit&nbsp;of&nbsp;10MB/s.&nbsp;But&nbsp;it&#39;s&nbsp;completely&nbsp;broken&nbsp;for&nbsp;cache&nbsp;HIT,&nbsp;speed&nbsp;I&#39;m&nbsp;getting&nbsp;is&nbsp;~5KB/s!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;The&nbsp;following&nbsp;configuration:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_delay_pools&nbsp;1&lt;br&gt;client_delay_access&nbsp;1&nbsp;allow&nbsp;localnet&lt;br&gt;client_delay_access&nbsp;1&nbsp;deny&nbsp;all&lt;br&gt;client_delay_parameters&nbsp;1&nbsp;10000000&nbsp;20000000&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Testing&nbsp;with&nbsp;an&nbsp;already&nbsp;cached&nbsp;big&nbsp;object&nbsp;(2GB&nbsp;ISO&nbsp;file).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_delay_pools&nbsp;disabled&nbsp;MISS:&nbsp;20MB/s&nbsp;(probably&nbsp;speed&nbsp;limit&nbsp;on&nbsp;origin&nbsp;side)&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_delay_pools&nbsp;disabled&nbsp;HIT:&nbsp;110MB/s&nbsp;(probably&nbsp;EBS&nbsp;disk&nbsp;speed)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_delay_pools&nbsp;enabled&nbsp;MISS:&nbsp;10MB/s&nbsp;(limit&nbsp;from&nbsp;client_delay_parameters)&lt;br&gt;&lt;/div&gt;&lt;div&gt;client_delay_pools&nbsp;enabled&nbsp;HIT:&nbsp;5KB/s&nbsp;(what&nbsp;???)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;retested&nbsp;with&nbsp;a&nbsp;smaller&nbsp;file&nbsp;(337MB)&nbsp;but&nbsp;it&nbsp;made&nbsp;no&nbsp;difference.&nbsp;Still&nbsp;got&nbsp;5KB&nbsp;download&nbsp;speed&nbsp;on&nbsp;cache&nbsp;HIT.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;ideas?&nbsp;Am&nbsp;I&nbsp;doing&nbsp;something&nbsp;wrong?&nbsp;Any&nbsp;other&nbsp;ways&nbsp;to&nbsp;limit&nbsp;client-side&nbsp;bandwidth?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Squid&nbsp;version:&lt;div&gt;&lt;br&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;4.14&lt;br&gt;Service&nbsp;Name:&nbsp;squid&lt;br&gt;configure&nbsp;options:&nbsp; &#39;--program-prefix=&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--exec-prefix=/usr&#39;&nbsp;&#39;--bindir=/usr/sbin&#39;&nbsp;&#39;--sbindir=/usr/sbin&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--libdir=/usr/lib&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--includedir=/usr/include&#39;&nbsp;&#39;--datadir=/usr/share/squid&#39;&nbsp;&#39;--sharedstatedir=/usr/com&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--mandir=/usr/share/man&#39;&nbsp;&#39;--infodir=/usr/share/info&#39;&nbsp;&#39;--enable-epoll&#39;&nbsp;&#39;--enable-removal-policies=heap,lru&#39;&nbsp;&#39;--enable-storeio=aufs,rock&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--with-pthreads&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-maxfd=16384&#39;&nbsp;&#39;--enable-htcp&#39;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;With&nbsp;best&nbsp;regards,&nbsp;Ivan&nbsp;Larionov.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
