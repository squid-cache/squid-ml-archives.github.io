<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thank&nbsp;you!&nbsp;Yes,&nbsp;it&nbsp;works&nbsp;fine&nbsp;with&nbsp;5&nbsp;peers.&nbsp;So,&nbsp;what&nbsp;would&nbsp;be&nbsp;the&nbsp;best&nbsp;solution&nbsp;to&nbsp;handle&nbsp;5000&nbsp;peers? &lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Mon,&nbsp;Apr&nbsp;12,&nbsp;2021&nbsp;at&nbsp;6:03&nbsp;PM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;4/10/21&nbsp;5:03&nbsp;PM,&nbsp;koshik&nbsp;moshik&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;run&nbsp;a&nbsp;Squid&nbsp;proxy&nbsp;Server&nbsp;witth&nbsp;about&nbsp;5000&nbsp;cache&nbsp;peers.&nbsp;I&lt;br&gt;<br>
&gt;&nbsp;am&nbsp;running&nbsp;a&nbsp;dedicated&nbsp;server&nbsp;with&nbsp;6&nbsp;cores&nbsp;and&nbsp;32GB&nbsp;RAM&nbsp;on&nbsp;Ubuntu&nbsp;16. &lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Could&nbsp;you&nbsp;tell&nbsp;me&nbsp;what&nbsp;else&nbsp;is&nbsp;needed&nbsp;/&nbsp;not&nbsp;needed&nbsp;in&nbsp;my&nbsp;squid.config?&nbsp;I&lt;br&gt;<br>
&gt;&nbsp;am&nbsp;encountering&nbsp;a&nbsp;high&nbsp;CPU&nbsp;usage&nbsp;and&nbsp;would&nbsp;like&nbsp;to&nbsp;create&nbsp;a&nbsp;very&lt;br&gt;<br>
&gt;&nbsp;efficient&nbsp;proxy&nbsp;server.&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
IIRC,&nbsp;Squid&nbsp;code&nbsp;is&nbsp;not&nbsp;optimized&nbsp;for&nbsp;handling&nbsp;a&nbsp;large&nbsp;number&nbsp;of&lt;br&gt;<br>
cache_peers:&nbsp;Several&nbsp;cache&nbsp;peer&nbsp;selection&nbsp;steps&nbsp;involve&nbsp;linear&nbsp;searches.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;do&nbsp;not&nbsp;know&nbsp;what&nbsp;exactly&nbsp;causes&nbsp;high&nbsp;CPU&nbsp;usage&nbsp;in&nbsp;your&nbsp;environment&nbsp;but&lt;br&gt;<br>
it&nbsp;could&nbsp;be&nbsp;those&nbsp;linear&nbsp;searches.&nbsp;You&nbsp;can&nbsp;test&nbsp;that&nbsp;(indirectly)&nbsp;by&lt;br&gt;<br>
decreasing&nbsp;the&nbsp;number&nbsp;of&nbsp;cache_peers&nbsp;from&nbsp;5000&nbsp;to,&nbsp;say,&nbsp;5.&nbsp;That&nbsp;is&nbsp;a&lt;br&gt;<br>
weak&nbsp;test,&nbsp;of&nbsp;course,&nbsp;because&nbsp;other&nbsp;cache_peer-related&nbsp;overheads&nbsp;could&lt;br&gt;<br>
be&nbsp;to&nbsp;blame,&nbsp;but&nbsp;I&nbsp;would&nbsp;start&nbsp;there.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Down&nbsp;below&nbsp;you&nbsp;can&nbsp;find&nbsp;my&nbsp;squid.config(I&nbsp;deleted&nbsp;the&nbsp;other&nbsp;cache_peer&lt;br&gt;<br>
&gt;&nbsp;lines):&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;-----------&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;dns_v4_first&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;SSL_ports&nbsp;port&nbsp;1-65535&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;Safe_ports&nbsp;port&nbsp;1-65535&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;!Safe_ports&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;program&nbsp;/usr/lib/squid/basic_ncsa_auth&nbsp;/etc/squid/.htpasswd&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;children&nbsp;5&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;realm&nbsp;Squid&nbsp;Basic&nbsp;Authentication&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;auth_param&nbsp;basic&nbsp;credentialsttl&nbsp;5&nbsp;hours&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;password&nbsp;proxy_auth&nbsp;REQUIRED&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;password&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#http_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;never_direct&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ident_access&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_mem&nbsp;1&nbsp;GB&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;maximum_object_size_in_memory&nbsp;16&nbsp;MB&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;coredump_dir&nbsp;/var/spool/squid&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#Rules&nbsp;to&nbsp;anonymize&nbsp;http&nbsp;headers&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;forwarded_for&nbsp;off&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Allow&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Authorization&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;WWW-Authenticate&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Proxy-Authorization&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Proxy-Authenticate&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Cache-Control&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Content-Encoding&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Content-Length&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Content-Type&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Date&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Expires&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Host&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;If-Modified-Since&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Last-Modified&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Location&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Pragma&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Accept&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Accept-Charset&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Accept-Encoding&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Accept-Language&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Content-Language&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Mime-Version&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Retry-After&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Title&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Connection&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Proxy-Connection&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;User-Agent&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;Cookie&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;request_header_access&nbsp;All&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;Add&nbsp;any&nbsp;of&nbsp;your&nbsp;own&nbsp;refresh_pattern&nbsp;entries&nbsp;above&nbsp;these.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#refresh_pattern&nbsp;^ftp:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1440&nbsp; &nbsp; 20%&nbsp; &nbsp; &nbsp;10080&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#refresh_pattern&nbsp;^gopher:&nbsp; &nbsp; &nbsp; &nbsp; 1440&nbsp; &nbsp; 0%&nbsp; &nbsp; &nbsp; 1440&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp; &nbsp; &nbsp;0%&nbsp; &nbsp; &nbsp; 0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#refresh_pattern&nbsp;(Release|Packages(.gz)*)$&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp;20%&nbsp; &nbsp; &nbsp;2880&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#refresh_pattern&nbsp;.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; &nbsp;20%&nbsp; &nbsp; &nbsp;4320&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;################################&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;me&nbsp;proxy_auth&nbsp;ye-1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_peer &lt;a&nbsp;href=&quot;http://my.proxy.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;my.proxy.com&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://my.proxy.com/&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://my.proxy.com/&lt;/a&gt;&gt; parent&nbsp;31280&lt;br&gt;<br>
&gt;&nbsp;login=user1:password1&nbsp;no-query&nbsp;name=a1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;a1&nbsp;allow&nbsp;me&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_peer_access&nbsp;a1&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
