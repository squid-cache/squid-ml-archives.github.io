<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;I&#39;ve&nbsp;found&nbsp;a&nbsp;resolution&nbsp;using&nbsp;a&nbsp;bit&nbsp;better&nbsp;regex:&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;acl&nbsp;blackList&nbsp;url_regex&nbsp;^https?:\/\/.*$&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;looking&nbsp;at&nbsp;the&nbsp;debug&nbsp;it&nbsp;doing&nbsp;exactly&nbsp;what&nbsp;I&nbsp;wanted,&nbsp;however,&nbsp;I&nbsp;now&nbsp;have&nbsp;a&nbsp;different&nbsp;issue&nbsp;how&nbsp;to&nbsp;handle&nbsp;a&nbsp;302&nbsp;MOVED&nbsp;when&nbsp;the&nbsp;move&nbsp;is&nbsp;to&nbsp;a&nbsp;different&nbsp;domain,&nbsp;e.g.&nbsp;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;a&nbsp;href=&quot;http://packages.gitlab.com&quot;&gt;packages.gitlab.com&lt;/a&gt;&nbsp;are&nbsp;moved&nbsp;to&nbsp;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;a&nbsp;href=&quot;http://d20rj4el6vkp4c.cloudfront.net&quot;&gt;d20rj4el6vkp4c.cloudfront.net&lt;/a&gt;.&nbsp;Is&nbsp;squid&nbsp;stateful&nbsp;in&nbsp;a&nbsp;way&nbsp;that&nbsp;it&#39;s&nbsp;able&nbsp;to&nbsp;remember&nbsp;those&nbsp;packets&nbsp;are&nbsp;coming&nbsp;from&nbsp;the&nbsp;same&nbsp;session?&nbsp;What&nbsp;would&nbsp;be&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;resolve&nbsp;the&nbsp;issue&nbsp;other&nbsp;than&nbsp;just&nbsp;keep&nbsp;adding&nbsp;domain&nbsp;if&nbsp;a&nbsp;thing&nbsp;like&nbsp;this&nbsp;happens.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;Thanks&lt;/span&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Thu,&nbsp;Apr&nbsp;15,&nbsp;2021&nbsp;at&nbsp;1:03&nbsp;PM&nbsp;Miroslaw&nbsp;Malinowski&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mr.miroslaw.malinowski@gmail.com&quot;&gt;mr.miroslaw.malinowski@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;use&nbsp;Opnsense&nbsp;built-in&nbsp;squid&nbsp;config&nbsp;to&nbsp;set&nbsp;up&nbsp;a&nbsp;transparent&nbsp;proxy&nbsp;for&nbsp;server&nbsp;updates&nbsp;and&nbsp;block&nbsp;everything&nbsp;else.&lt;/div&gt;&lt;div&gt;In&nbsp;GUI&nbsp;they&nbsp;use&nbsp;url_regex&nbsp;for&nbsp;whitelist&nbsp;and&nbsp;blacklist,&nbsp;when&nbsp;I&nbsp;simple&nbsp;per&nbsp;domain&nbsp;whitelist&nbsp;and&nbsp;blacklist&nbsp;it&#39;s&nbsp;working&nbsp;as&nbsp;expected,&nbsp;e.g.&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;-&nbsp;Whitelist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(whiteList)<br>
&lt;/span&gt;&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;archive\.ubuntu\.com&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;-&nbsp;Blacklist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(blackList)<br>
&lt;/span&gt;&lt;br&gt;acl&nbsp;blackList&nbsp;url_regex&nbsp;packages\.gitlab\.com&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;list&nbsp;(Allow)&nbsp;whitelist<br>
&lt;/span&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;whiteList<br>
&lt;br&gt;#&nbsp;ACL&nbsp;list&nbsp;(Deny)&nbsp;blacklist<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;blackList&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;However,&nbsp;when&nbsp;I&nbsp;do&nbsp;wildcard&nbsp;in&nbsp;blacklist&nbsp;I&nbsp;also&nbsp;get&nbsp;all&nbsp;https&nbsp;domain&nbsp;blocked&nbsp;even&nbsp;when&nbsp;I&#39;ve&nbsp;tried&nbsp;to&nbsp;explicitly&nbsp;allow&nbsp;it&nbsp;with&nbsp;&lt;a&nbsp;href=&quot;https://archive&quot;&nbsp;target=&quot;_blank&quot;&gt;https://archive&lt;/a&gt;\.ubuntu\.com&nbsp;,&nbsp;e.g.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;-&nbsp;Whitelist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(whiteList)<br>
&lt;/span&gt;&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;archive\.ubuntu\.com&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;-&nbsp;Blacklist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(blackList)<br>
&lt;/span&gt;&lt;br&gt;acl&nbsp;blackList&nbsp;url_regex&nbsp;.*&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#&nbsp;ACL&nbsp;list&nbsp;(Allow)&nbsp;whitelist<br>
&lt;/span&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;whiteList<br>
&lt;br&gt;#&nbsp;ACL&nbsp;list&nbsp;(Deny)&nbsp;blacklist<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;blackList&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;I&nbsp;get:&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;Err:7&nbsp;&lt;a&nbsp;href=&quot;https://repos.influxdata.com/ubuntu&quot;&nbsp;target=&quot;_blank&quot;&gt;https://repos.influxdata.com/ubuntu&lt;/a&gt;&nbsp;focal&nbsp;InRelease<br>
&lt;/span&gt;&lt;br&gt;&nbsp; 403&nbsp; Forbidden&nbsp;[IP:&nbsp;52.84.95.46&nbsp;443]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;What&nbsp;I&#39;m&nbsp;trying&nbsp;to&nbsp;say&nbsp;is&nbsp;with&nbsp;blacklist&nbsp;as&nbsp;.&nbsp;is&nbsp;blocking&nbsp;all&nbsp;https&nbsp;traffic&nbsp;even&nbsp;if&nbsp;whitelisted,&nbsp;is&nbsp;this&nbsp;an&nbsp;expected&nbsp;behaviour&nbsp;or&nbsp;I&#39;m&nbsp;doing&nbsp;something&nbsp;wrong&nbsp;or&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;done&nbsp;with&nbsp;url_regex&nbsp;and&nbsp;I&nbsp;should&nbsp;do&nbsp;it&nbsp;at&nbsp;backend&nbsp;manually.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;My&nbsp;config:&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(0,0,0);background-color:rgb(255,255,255)&quot;&gt;#<br>
&lt;/span&gt;&lt;br&gt;#&nbsp;Automatic&nbsp;generated&nbsp;configuration&nbsp;for&nbsp;Squid.<br>
&lt;br&gt;#&nbsp;Do&nbsp;not&nbsp;edit&nbsp;this&nbsp;file&nbsp;manually.<br>
&lt;br&gt;#<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Setup&nbsp;transparent&nbsp;mode&nbsp;listeners&nbsp;on&nbsp;loopback&nbsp;interfaces<br>
&lt;br&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://127.0.0.1:3128&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1:3128&lt;/a&gt;&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;http_port&nbsp;[::1]:3128&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;https_port&nbsp;&lt;a&nbsp;href=&quot;http://127.0.0.1:3129&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1:3129&lt;/a&gt;&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;https_port&nbsp;[::1]:3129&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Setup&nbsp;regular&nbsp;listeners&nbsp;configuration<br>
&lt;br&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://172.16.230.252:3128&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.230.252:3128&lt;/a&gt;&nbsp; ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://172.16.230.254:3128&quot;&nbsp;target=&quot;_blank&quot;&gt;172.16.230.254:3128&lt;/a&gt;&nbsp; ssl-bump&nbsp;cert=/var/squid/ssl/ca.pem&nbsp;dynamic_cert_mem_cache_size=10MB&nbsp;generate-host-certificates=on<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;setup&nbsp;ssl&nbsp;re-cert<br>
&lt;br&gt;sslcrtd_program&nbsp;/usr/local/libexec/squid/security_file_certgen&nbsp;-s&nbsp;/var/squid/ssl_crtd&nbsp;-M&nbsp;10MB<br>
&lt;br&gt;sslcrtd_children&nbsp;5<br>
&lt;br&gt;<br>
&lt;br&gt;tls_outgoing_options&nbsp;options=NO_TLSv1&nbsp;cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;setup&nbsp;ssl&nbsp;bump&nbsp;acl&#39;s<br>
&lt;br&gt;acl&nbsp;bump_step1&nbsp;at_step&nbsp;SslBump1<br>
&lt;br&gt;acl&nbsp;bump_step2&nbsp;at_step&nbsp;SslBump2<br>
&lt;br&gt;acl&nbsp;bump_step3&nbsp;at_step&nbsp;SslBump3<br>
&lt;br&gt;acl&nbsp;bump_nobumpsites&nbsp;ssl::server_name&nbsp;&quot;/usr/local/etc/squid/nobumpsites.acl&quot;<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;configure&nbsp;bump<br>
&lt;br&gt;ssl_bump&nbsp;peek&nbsp;bump_step1&nbsp;all<br>
&lt;br&gt;ssl_bump&nbsp;peek&nbsp;bump_step2&nbsp;bump_nobumpsites<br>
&lt;br&gt;ssl_bump&nbsp;splice&nbsp;bump_step3&nbsp;bump_nobumpsites<br>
&lt;br&gt;ssl_bump&nbsp;stare&nbsp;bump_step2<br>
&lt;br&gt;ssl_bump&nbsp;bump&nbsp;bump_step3<br>
&lt;br&gt;<br>
&lt;br&gt;sslproxy_cert_error&nbsp;deny&nbsp;all<br>
&lt;br&gt;<br>
&lt;br&gt;acl&nbsp;ftp&nbsp;proto&nbsp;FTP<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;ftp<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Setup&nbsp;ftp&nbsp;proxy<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Rules&nbsp;allowing&nbsp;access&nbsp;from&nbsp;your&nbsp;local&nbsp;networks.<br>
&lt;br&gt;#&nbsp;Generated&nbsp;list&nbsp;of&nbsp;(internal)&nbsp;IP&nbsp;networks&nbsp;from&nbsp;where&nbsp;browsing<br>
&lt;br&gt;#&nbsp;should&nbsp;be&nbsp;allowed.&nbsp;(Allow&nbsp;interface&nbsp;subnets).<br>
&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;net&gt;/24&nbsp;#&nbsp;Possible&nbsp;internal&nbsp;network&nbsp;(interfaces&nbsp;v4)<br>
&lt;br&gt;#&nbsp;Default&nbsp;allow&nbsp;for&nbsp;local-link&nbsp;and&nbsp;private&nbsp;networks<br>
&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7&nbsp;      #&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range<br>
&lt;br&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10&nbsp;     #&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Allow&nbsp;localhost&nbsp;for&nbsp;PURGE&nbsp;cache&nbsp;if&nbsp;enabled<br>
&lt;br&gt;acl&nbsp;PURGE&nbsp;method&nbsp;PURGE<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;PURGE<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;PURGE<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;lists<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Whitelist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(whiteList)<br>
&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;packages\.wazuh\.com<br>
&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;archive\.ubuntu\.com<br>
&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;security\.ubuntu\.com<br>
&lt;br&gt;acl&nbsp;whiteList&nbsp;url_regex&nbsp;repos\.influxdata\.com<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Blacklist&nbsp;-&nbsp;User&nbsp;defined&nbsp;(blackList)<br>
&lt;br&gt;acl&nbsp;blackList&nbsp;url_regex&nbsp;.*<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Remote&nbsp;fetched&nbsp;Blacklist&nbsp;(remoteblacklist)<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Block&nbsp;browser/user-agent&nbsp;-&nbsp;User&nbsp;defined&nbsp;(browser)<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;SSL&nbsp;ports,&nbsp;default&nbsp;are&nbsp;configured&nbsp;in&nbsp;config.xml<br>
&lt;br&gt;#&nbsp;Configured&nbsp;SSL&nbsp;ports&nbsp;(if&nbsp;defaults&nbsp;are&nbsp;not&nbsp;listed,&nbsp;then&nbsp;they&nbsp;have&nbsp;been&nbsp;removed&nbsp;from&nbsp;the&nbsp;configuration!):<br>
&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Default&nbsp;Safe&nbsp;ports&nbsp;are&nbsp;now&nbsp;defined&nbsp;in&nbsp;config.xml<br>
&lt;br&gt;#&nbsp;Configured&nbsp;Safe&nbsp;ports&nbsp;(if&nbsp;defaults&nbsp;are&nbsp;not&nbsp;listed,&nbsp;then&nbsp;they&nbsp;have&nbsp;been&nbsp;removed&nbsp;from&nbsp;the&nbsp;configuration!):<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;Safe_ports<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&nbsp;#&nbsp;http<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;21&nbsp;#&nbsp;ftp<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443&nbsp;#&nbsp;https<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;70&nbsp;#&nbsp;gopher<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;210&nbsp;#&nbsp;wais<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;1025-65535&nbsp;#&nbsp;unregistered&nbsp;ports<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;280&nbsp;#&nbsp;http-mgmt<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;488&nbsp;#&nbsp;gss-http<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;591&nbsp;#&nbsp;filemaker<br>
&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;777&nbsp;#&nbsp;multiling&nbsp;http<br>
&lt;br&gt;acl&nbsp;CONNECT&nbsp;method&nbsp;CONNECT<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ICAP&nbsp;SETTINGS<br>
&lt;br&gt;#&nbsp;disable&nbsp;icap<br>
&lt;br&gt;icap_enable&nbsp;off<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Pre-auth&nbsp;plugins<br>
&lt;br&gt;include&nbsp;/usr/local/etc/squid/pre-auth/*.conf<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Authentication&nbsp;Settings<br>
&lt;br&gt;<br>
<br>
&lt;br&gt;#&nbsp;ACL&nbsp;list&nbsp;(Allow)&nbsp;whitelist<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;whiteList<br>
&lt;br&gt;<br>
&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;<br>
#<br>
&lt;br&gt;#&nbsp;ACL&nbsp;list&nbsp;(Deny)&nbsp;blacklist<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;blackList<br>
&lt;br&gt;<br>
<br>
&lt;br&gt;#&nbsp;Google&nbsp;Suite&nbsp;Filter<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;YouTube&nbsp;Filter<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Deny&nbsp;requests&nbsp;to&nbsp;certain&nbsp;unsafe&nbsp;ports<br>
&lt;br&gt;<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;!Safe_ports&nbsp; &lt;br&gt;#&nbsp;Deny&nbsp;CONNECT&nbsp;to&nbsp;other&nbsp;than&nbsp;secure&nbsp;SSL&nbsp;ports<br>
&lt;br&gt;<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;CONNECT&nbsp;!SSL_ports&nbsp; &lt;br&gt;<br>
&lt;br&gt;#&nbsp;Only&nbsp;allow&nbsp;cachemgr&nbsp;access&nbsp;from&nbsp;localhost<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;manager<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;We&nbsp;strongly&nbsp;recommend&nbsp;the&nbsp;following&nbsp;be&nbsp;uncommented&nbsp;to&nbsp;protect&nbsp;innocent<br>
&lt;br&gt;#&nbsp;web&nbsp;applications&nbsp;running&nbsp;on&nbsp;the&nbsp;proxy&nbsp;server&nbsp;who&nbsp;think&nbsp;the&nbsp;only<br>
&lt;br&gt;#&nbsp;one&nbsp;who&nbsp;can&nbsp;access&nbsp;services&nbsp;on&nbsp;&quot;localhost&quot;&nbsp;is&nbsp;a&nbsp;local&nbsp;user<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;to_localhost<br>
&lt;br&gt;<br>
<br>
&lt;br&gt;#&nbsp;Auth&nbsp;plugins<br>
&lt;br&gt;include&nbsp;/usr/local/etc/squid/auth/*.conf<br>
&lt;br&gt;<br>
&lt;br&gt;#<br>
&lt;br&gt;#&nbsp;Access&nbsp;Permission&nbsp;configuration:<br>
&lt;br&gt;#<br>
&lt;br&gt;#&nbsp;Deny&nbsp;request&nbsp;from&nbsp;unauthorized&nbsp;clients<br>
&lt;br&gt;<br>
&lt;br&gt;#<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;localnet&nbsp;-&nbsp;default&nbsp;these&nbsp;include&nbsp;ranges&nbsp;from&nbsp;selected&nbsp;interfaces&nbsp;(Allow&nbsp;local&nbsp;subnets)<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;localnet<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;ACL&nbsp;-&nbsp;localhost<br>
&lt;br&gt;http_access&nbsp;allow&nbsp;localhost<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Deny&nbsp;all&nbsp;other&nbsp;access&nbsp;to&nbsp;this&nbsp;proxy<br>
&lt;br&gt;http_access&nbsp;deny&nbsp;all<br>
&lt;br&gt;#&nbsp;Post-auth&nbsp;plugins<br>
&lt;br&gt;include&nbsp;/usr/local/etc/squid/post-auth/*.conf<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Caching&nbsp;settings<br>
&lt;br&gt;cache_mem&nbsp;1000&nbsp;MB<br>
&lt;br&gt;maximum_object_size&nbsp;200&nbsp;MB<br>
&lt;br&gt;cache_replacement_policy&nbsp;heap&nbsp;LFUDA<br>
&lt;br&gt;cache_dir&nbsp;ufs&nbsp;/var/squid/cache&nbsp;100000&nbsp;16&nbsp;256<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Leave&nbsp;coredumps&nbsp;in&nbsp;the&nbsp;first&nbsp;cache&nbsp;dir<br>
&lt;br&gt;coredump_dir&nbsp;/var/squid/cache<br>
&lt;br&gt;<br>
&lt;br&gt;#<br>
&lt;br&gt;#&nbsp;Add&nbsp;any&nbsp;of&nbsp;your&nbsp;own&nbsp;refresh_pattern&nbsp;entries&nbsp;above&nbsp;these.<br>
&lt;br&gt;#<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Linux&nbsp;package&nbsp;cache:<br>
&lt;br&gt;refresh_pattern&nbsp;pkg\.tar\.xz$&nbsp;  0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;d?rpm$&nbsp;         0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;deb$&nbsp;           0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;udeb$&nbsp;          0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;Packages\.bz2$&nbsp; 0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;Sources\.bz2$&nbsp;  0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;Release\.gpg$&nbsp;  0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;refresh_pattern&nbsp;Release$&nbsp;       0&nbsp;      20%&nbsp;    4320&nbsp;refresh-ims<br>
&lt;br&gt;#&nbsp;&lt;a&nbsp;href=&quot;http://wiki.squid-cache.org/SquidFaq/WindowsUpdate&quot;&nbsp;target=&quot;_blank&quot;&gt;http://wiki.squid-cache.org/SquidFaq/WindowsUpdate&lt;/a&gt;<br>
&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;&lt;a&nbsp;href=&quot;http://microsoft.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd)&quot;&nbsp;target=&quot;_blank&quot;&gt;microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)&lt;/a&gt;&nbsp;    4320&nbsp;80%&nbsp;129600&nbsp;reload-into-ims<br>
&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;&lt;a&nbsp;href=&quot;http://windowsupdate.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd)&quot;&nbsp;target=&quot;_blank&quot;&gt;windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)&lt;/a&gt;&nbsp;4320&nbsp;80%&nbsp;129600&nbsp;reload-into-ims<br>
&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;&lt;a&nbsp;href=&quot;http://windows.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd)&quot;&nbsp;target=&quot;_blank&quot;&gt;windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)&lt;/a&gt;&nbsp;      4320&nbsp;80%&nbsp;129600&nbsp;reload-into-ims<br>
&lt;br&gt;<br>
&lt;br&gt;refresh_pattern&nbsp;^ftp:&nbsp;          1440&nbsp;   20%&nbsp;    10080<br>
&lt;br&gt;refresh_pattern&nbsp;^gopher:&nbsp;       1440&nbsp;   0%&nbsp;     1440<br>
&lt;br&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0&nbsp;    0%&nbsp;     0<br>
&lt;br&gt;refresh_pattern&nbsp;.&nbsp;              0&nbsp;      20%&nbsp;    4320<br>
&lt;br&gt;<br>
&lt;br&gt;#&nbsp;Squid&nbsp;Options<br>
&lt;br&gt;#&nbsp;dns_v4_first&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;preference&nbsp;to&nbsp;make&nbsp;Squid&nbsp;contact&nbsp;dual-stack&nbsp;websites&nbsp;over&nbsp;IPv4&nbsp;first<br>
&lt;br&gt;dns_v4_first&nbsp;on<br>
&lt;br&gt;pinger_enable&nbsp;off<br>
&lt;br&gt;access_log&nbsp;stdio:/var/log/squid/access.log&nbsp;squid<br>
&lt;br&gt;cache_store_log&nbsp;stdio:/var/log/squid/store.log<br>
&lt;br&gt;#&nbsp;URI&nbsp;hanlding&nbsp;with&nbsp;Whitespaces&nbsp;(default=strip)<br>
&lt;br&gt;uri_whitespace&nbsp;strip<br>
&lt;br&gt;#&nbsp;X-Forwarded&nbsp;header&nbsp;handling&nbsp;(default=on)<br>
&lt;br&gt;forwarded_for&nbsp;on<br>
&lt;br&gt;#&nbsp;Disable&nbsp;squid&nbsp;logfile&nbsp;rotate&nbsp;to&nbsp;use&nbsp;system&nbsp;defaults<br>
&lt;br&gt;logfile_rotate&nbsp;0<br>
&lt;br&gt;#&nbsp;Define&nbsp;visible&nbsp;email<br>
&lt;br&gt;cache_mgr&nbsp;admin@localhost.local<br>
&lt;br&gt;error_directory&nbsp;/usr/local/etc/squid/errors/local&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;Thanks&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
