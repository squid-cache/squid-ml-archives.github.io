<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Good&nbsp;morning,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;looking&nbsp;to&nbsp;run&nbsp;Squid&nbsp;as&nbsp;a&nbsp;forward&nbsp;proxy&nbsp;with&nbsp;basic&nbsp;auth&nbsp;in&nbsp;Docker&nbsp;on&nbsp;AWS&nbsp;ECS&nbsp;behind&nbsp;a&nbsp;network&nbsp;load&nbsp;balancer.&nbsp;I&nbsp;seem&nbsp;to&nbsp;have&nbsp;things&nbsp;up&nbsp;and&nbsp;running&nbsp;for&nbsp;the&nbsp;most&nbsp;part;&nbsp;however,&nbsp;I&nbsp;am&nbsp;having&nbsp;difficulty&nbsp;in&nbsp;getting&nbsp;proxy&nbsp;protocol&nbsp;to&nbsp;work&nbsp;so&nbsp;that&nbsp;I&nbsp;get&nbsp;access&nbsp;to&nbsp;client&nbsp;IP&nbsp;addresses&nbsp;beyond&nbsp;that&nbsp;of&nbsp;the&nbsp;private&nbsp;IPs&nbsp;of&nbsp;my&nbsp;NLB.&nbsp;As&nbsp;soon&nbsp;as&nbsp;I&nbsp;enable&nbsp;proxy&nbsp;protocol&nbsp;v2&nbsp;on&nbsp;the&nbsp;AWS&nbsp;NLB,&nbsp;requests&nbsp;to&nbsp;Squid&nbsp;start&nbsp;failing&nbsp;with&nbsp;errors&nbsp;similar&nbsp;to&nbsp;the&nbsp;following:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Squid&nbsp;log:&nbsp;`1634330668.200&nbsp; &nbsp; &nbsp; 5&nbsp;&lt;nlb-private-ip&gt;&nbsp;NONE_NONE/400&nbsp;2032&nbsp;-&nbsp;error:invalid-request&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html`&lt;/div&gt;&lt;div&gt;Client&nbsp;log:&nbsp;`X-Squid-Error:&nbsp;ERR_PROTOCOL_UNKNOWN&nbsp;0`&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&nbsp;Environment&nbsp;and&nbsp;Configuration&nbsp;details&nbsp;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Operating&nbsp;System:&nbsp;Alpine&nbsp;Linux&nbsp;3.14.2&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;$&nbsp;squid&nbsp;-v&lt;br&gt;Squid&nbsp;Cache:&nbsp;Version&nbsp;5.0.6&lt;br&gt;Service&nbsp;Name:&nbsp;squid&lt;br&gt;&lt;br&gt;This&nbsp;binary&nbsp;uses&nbsp;OpenSSL&nbsp;1.1.1l&nbsp; 24&nbsp;Aug&nbsp;2021.&nbsp;For&nbsp;legal&nbsp;restrictions&nbsp;on&nbsp;distribution&nbsp;see&nbsp;&lt;a&nbsp;href=&quot;https://www.openssl.org/source/license.html&quot;&gt;https://www.openssl.org/source/license.html&lt;/a&gt;&lt;br&gt;&lt;br&gt;configure&nbsp;options:&nbsp; &#39;--build=x86_64-alpine-linux-musl&#39;&nbsp;&#39;--host=x86_64-alpine-linux-musl&#39;&nbsp;&#39;--prefix=/usr&#39;&nbsp;&#39;--datadir=/usr/share/squid&#39;&nbsp;&#39;--sysconfdir=/etc/squid&#39;&nbsp;&#39;--libexecdir=/usr/lib/squid&#39;&nbsp;&#39;--localstatedir=/var&#39;&nbsp;&#39;--with-logdir=/var/log/squid&#39;&nbsp;&#39;--disable-strict-error-checking&#39;&nbsp;&#39;--disable-arch-native&#39;&nbsp;&#39;--enable-removal-policies=lru,heap&#39;&nbsp;&#39;--enable-auth-digest&#39;&nbsp;&#39;--enable-auth-basic=getpwnam,NCSA,SMB,SMB_LM,RADIUS&#39;&nbsp;&#39;--enable-epoll&#39;&nbsp;&#39;--enable-external-acl-helpers=file_userip,unix_group,wbinfo_group&#39;&nbsp;&#39;--enable-auth-ntlm=fake,SMB_LM&#39;&nbsp;&#39;--enable-auth-negotiate=kerberos,wrapper&#39;&nbsp;&#39;--disable-mit&#39;&nbsp;&#39;--enable-heimdal&#39;&nbsp;&#39;--enable-delay-pools&#39;&nbsp;&#39;--enable-openssl&#39;&nbsp;&#39;--enable-ssl-crtd&#39;&nbsp;&#39;--enable-linux-netfilter&#39;&nbsp;&#39;--enable-ident-lookups&#39;&nbsp;&#39;--enable-useragent-log&#39;&nbsp;&#39;--enable-cache-digests&#39;&nbsp;&#39;--enable-referer-log&#39;&nbsp;&#39;--enable-async-io&#39;&nbsp;&#39;--enable-truncate&#39;&nbsp;&#39;--enable-arp-acl&#39;&nbsp;&#39;--enable-htcp&#39;&nbsp;&#39;--enable-carp&#39;&nbsp;&#39;--enable-poll&#39;&nbsp;&#39;--enable-follow-x-forwarded-for&#39;&nbsp;&#39;--with-large-files&#39;&nbsp;&#39;--with-default-user=squid&#39;&nbsp;&#39;--with-openssl&#39;&nbsp;&#39;build_alias=x86_64-alpine-linux-musl&#39;&nbsp;&#39;host_alias=x86_64-alpine-linux-musl&#39;&nbsp;&#39;CC=gcc&#39;&nbsp;&#39;CFLAGS=-Os&nbsp;-fomit-frame-pointer&#39;&nbsp;&#39;CPPFLAGS=-Os&nbsp;-fomit-frame-pointer&#39;&nbsp;&#39;CXX=g++&#39;&nbsp;&#39;CXXFLAGS=-Os&nbsp;-fomit-frame-pointer&#39;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;$&nbsp;cat&nbsp;/etc/squid/squid.conf&lt;br&gt;auth_param&nbsp;basic&nbsp;program&nbsp;/usr/lib/squid/basic_ncsa_auth&nbsp;/etc/squid/passwd&lt;br&gt;auth_param&nbsp;basic&nbsp;realm&nbsp;proxy&lt;br&gt;&lt;br&gt;acl&nbsp;authenticated&nbsp;proxy_auth&nbsp;REQUIRED&lt;br&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;br&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80&lt;br&gt;&lt;br&gt;http_access&nbsp;allow&nbsp;authenticated&lt;br&gt;http_port&nbsp;3128&lt;br&gt;&lt;br&gt;cache&nbsp;deny&nbsp;all&lt;br&gt;&lt;br&gt;pid_file&lt;/div&gt;&lt;div&gt;name&nbsp;/var/run/squid/squid.pid&lt;br&gt;&lt;br&gt;visible_hostname&nbsp;&lt;dns-for-nlb&gt;&lt;br&gt;&lt;br&gt;debug_options&nbsp;ALL,1&lt;br&gt;&lt;br&gt;acl&nbsp;hasRequest&nbsp;has&nbsp;request&lt;br&gt;access_log&nbsp;stdio:/proc/self/fd/1&nbsp;hasRequest&lt;br&gt;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;looked&nbsp;into&nbsp;`proxy_protocol_access`&nbsp;and&nbsp;`http_port require-proxy-header`,&nbsp;but&nbsp;those&nbsp;both&nbsp;appear&nbsp;to&nbsp;be&nbsp;options&nbsp;to&nbsp;provide&nbsp;access&nbsp;control&nbsp;to&nbsp;Squid&nbsp;around&nbsp;proxy&nbsp;information.&nbsp;I&#39;m&nbsp;simply&nbsp;looking&nbsp;to&nbsp;keep&nbsp;the&nbsp;basic&nbsp;auth&nbsp;in&nbsp;place&nbsp;as&nbsp;the&nbsp;access&nbsp;control&nbsp;mechanism&nbsp;while&nbsp;getting&nbsp;at&nbsp;the&nbsp;forwarded&nbsp;client&nbsp;information&nbsp;for&nbsp;logging&nbsp;purposes.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;there&nbsp;something&nbsp;silly&nbsp;that&nbsp;I&#39;m&nbsp;missing&nbsp;to&nbsp;get&nbsp;proxy&nbsp;protocol&nbsp;working&nbsp;with&nbsp;Squid&nbsp;and&nbsp;AWS&nbsp;NLBs?&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;Thanks,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&nbsp;data-smartmail=&quot;gmail_signature&quot;&gt;Ty&lt;/div&gt;&lt;/div&gt;<br>

</tt>
