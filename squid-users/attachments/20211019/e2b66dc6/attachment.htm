<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Shucks.&nbsp;No&nbsp;dice.&nbsp;I&nbsp;tried&nbsp;the&nbsp;following&nbsp;three&nbsp;variations,&nbsp;which&nbsp;all&nbsp;resulted&nbsp;in&nbsp;the&nbsp;same&nbsp;&quot;invalid&nbsp;magic&quot;&nbsp;proxy&nbsp;protocol&nbsp;errors&nbsp;in&nbsp;the&nbsp;squid&nbsp;logs&nbsp;and&nbsp;connection&nbsp;aborted&nbsp;errors&nbsp;in&nbsp;the&nbsp;curl&nbsp;logs&nbsp;as&nbsp;before:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;curl&nbsp;--haproxy-protocol&nbsp;--proxy&nbsp;http://&lt;un&gt;:&lt;pw&gt;@localhost:3128&nbsp;-v&nbsp;&lt;a&nbsp;href=&quot;https://www.google.com&quot;&gt;https://www.google.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;curl&nbsp;--haproxy-protocol&nbsp;--proxy&nbsp;http://&lt;un&gt;:&lt;pw&gt;@localhost:3128&nbsp;-v&nbsp;--header&nbsp;&quot;X-Forwarded-For:&nbsp;192.168.0.2&quot;&nbsp;&lt;a&nbsp;href=&quot;https://www.google.com&quot;&gt;https://www.google.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;curl&nbsp;--haproxy-protocol&nbsp;--proxy&nbsp;http://&lt;un&gt;:&lt;pw&gt;@localhost:3128&nbsp;-v&nbsp;--proxy-header&nbsp;&quot;X-Forwarded-For:&nbsp;192.168.0.2&quot;&nbsp;&lt;a&nbsp;href=&quot;https://www.google.com&quot;&gt;https://www.google.com&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;`--haproxy-protocol`&nbsp;option&nbsp;seems&nbsp;like&nbsp;it&nbsp;should&nbsp;have&nbsp;done&nbsp;the&nbsp;trick.&nbsp;Am&nbsp;I&nbsp;just&nbsp;shooting&nbsp;myself&nbsp;in&nbsp;the&nbsp;foot&nbsp;with&nbsp;bad&nbsp;curl&nbsp;commands?&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Mon,&nbsp;Oct&nbsp;18,&nbsp;2021&nbsp;at&nbsp;5:32&nbsp;PM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;10/18/21&nbsp;5:16&nbsp;PM,&nbsp;Ty&nbsp;Martin&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Ah,&nbsp;yep.&nbsp;Adding&nbsp;the&nbsp;following&nbsp;to&nbsp;my&nbsp;config&nbsp;got&nbsp;things&nbsp;working&nbsp;in&nbsp;AWS:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;private&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.0.0.0/8&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.0.0.0/8&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;proxy_protocol_access&nbsp;allow&nbsp;private&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3128&nbsp;require-proxy-header&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;was&nbsp;trying&nbsp;to&nbsp;test&nbsp;it&nbsp;locally&nbsp;without&nbsp;success&nbsp;by&nbsp;running&nbsp;the&nbsp;Docker&lt;br&gt;<br>
&gt;&nbsp;container&nbsp;and&nbsp;hitting&nbsp;it&nbsp;with&nbsp;a&nbsp;curl&nbsp;along&nbsp;the&nbsp;lines&nbsp;of:&lt;br&gt;<br>
&gt;&nbsp;`curl&nbsp;--proxy&nbsp;http://&lt;un&gt;:&lt;pw&gt;@localhost:3128&nbsp;-v&nbsp;--header&lt;br&gt;<br>
&gt;&nbsp;&quot;X-Forwarded-For:&nbsp;192.168.0.2&quot;&nbsp;&lt;a&nbsp;href=&quot;https://www.google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://www.google.com&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;test&nbsp;using&nbsp;curl,&nbsp;try&nbsp;curl&nbsp;--haproxy-protocol&nbsp;...&lt;br&gt;<br>
&lt;br&gt;<br>
PROXY&nbsp;protocol&nbsp;(all&nbsp;versions)&nbsp;is&nbsp;not&nbsp;HTTP.&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;---&nbsp;Resulting&nbsp;Squid&nbsp;logs&nbsp;---&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&nbsp;squid-proxy_1&nbsp; |&nbsp;2021/10/18&nbsp;19:55:33|&nbsp;PROXY&nbsp;protocol&nbsp;error:&nbsp;invalid&nbsp;magic&lt;br&gt;<br>
&gt;&nbsp;squid-proxy_1&nbsp; |&nbsp; &nbsp; &nbsp;exception&nbsp;location:&nbsp;Parser.cc(260)&nbsp;Parse&nbsp;from&nbsp;conn6&lt;br&gt;<br>
&gt;&nbsp;local=&lt;a&nbsp;href=&quot;http://172.24.0.2:3128&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.24.0.2:3128&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://172.24.0.2:3128&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://172.24.0.2:3128&lt;/a&gt;&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://172.24.0.1:65426&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.24.0.1:65426&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://172.24.0.1:65426&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://172.24.0.1:65426&lt;/a&gt;&gt;&nbsp;FD&nbsp;12&nbsp;flags=1&lt;br&gt;<br>
&gt;&nbsp;squid-proxy_1&nbsp; |&nbsp; &nbsp; &nbsp;connection:&nbsp;conn6&nbsp;local=&lt;a&nbsp;href=&quot;http://172.24.0.2:3128&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.24.0.2:3128&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://172.24.0.2:3128&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://172.24.0.2:3128&lt;/a&gt;&gt;&nbsp;remote=&lt;a&nbsp;href=&quot;http://172.24.0.1:65426&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;172.24.0.1:65426&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://172.24.0.1:65426&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://172.24.0.1:65426&lt;/a&gt;&gt;&nbsp;FD&nbsp;12&nbsp;flags=1&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;---&nbsp;Resulting&nbsp;client&nbsp;logs&nbsp;---&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&nbsp;*&nbsp;Proxy&nbsp;CONNECT&nbsp;aborted&lt;br&gt;<br>
&gt;&nbsp;*&nbsp;CONNECT&nbsp;phase&nbsp;completed!&lt;br&gt;<br>
&gt;&nbsp;*&nbsp;Closing&nbsp;connection&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;curl:&nbsp;(56)&nbsp;Proxy&nbsp;CONNECT&nbsp;aborted&lt;br&gt;<br>
&gt;&nbsp;```&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;idea&nbsp;offhand&nbsp;what&nbsp;I&#39;m&nbsp;missing&nbsp;from&nbsp;the&nbsp;local&nbsp;testing&nbsp;scenario?&nbsp;I&lt;br&gt;<br>
&gt;&nbsp;thought&nbsp;adding&nbsp;a&nbsp;&quot;X-Forwarded-For&quot;&nbsp;header&nbsp;via&nbsp;curl&nbsp;would&nbsp;be&nbsp;treated&nbsp;as&lt;br&gt;<br>
&gt;&nbsp;proxy&nbsp;protocol&nbsp;v1&nbsp;by&nbsp;Squid,&nbsp;but&nbsp;the&nbsp;&quot;invalid&nbsp;magic&quot;&nbsp;protocol&nbsp;error&nbsp;gives&lt;br&gt;<br>
&gt;&nbsp;me&nbsp;the&nbsp;impression&nbsp;I&#39;m&nbsp;not&nbsp;going&nbsp;about&nbsp;it&nbsp;the&nbsp;right&nbsp;way.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Mon,&nbsp;Oct&nbsp;18,&nbsp;2021&nbsp;at&nbsp;12:48&nbsp;PM&nbsp;Alex&nbsp;Rousskov&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;mailto:&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;10/18/21&nbsp;12:11&nbsp;PM,&nbsp;Ty&nbsp;Martin&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;I&nbsp;am&nbsp;looking&nbsp;to&nbsp;run&nbsp;Squid&nbsp;as&nbsp;a&nbsp;forward&nbsp;proxy&nbsp;with&nbsp;basic&nbsp;auth&nbsp;in&nbsp;Docker&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;on&nbsp;AWS&nbsp;ECS&nbsp;behind&nbsp;a&nbsp;network&nbsp;load&nbsp;balancer.&nbsp;I&nbsp;seem&nbsp;to&nbsp;have&nbsp;things&lt;br&gt;<br>
&gt; &nbsp; &nbsp; up&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;running&nbsp;for&nbsp;the&nbsp;most&nbsp;part;&nbsp;however,&nbsp;I&nbsp;am&nbsp;having&nbsp;difficulty&nbsp;in&nbsp;getting&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;proxy&nbsp;protocol&nbsp;to&nbsp;work&nbsp;so&nbsp;that&nbsp;I&nbsp;get&nbsp;access&nbsp;to&nbsp;client&nbsp;IP&nbsp;addresses&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;beyond&nbsp;that&nbsp;of&nbsp;the&nbsp;private&nbsp;IPs&nbsp;of&nbsp;my&nbsp;NLB.&nbsp;As&nbsp;soon&nbsp;as&nbsp;I&nbsp;enable&nbsp;proxy&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;protocol&nbsp;v2&nbsp;on&nbsp;the&nbsp;AWS&nbsp;NLB,&nbsp;requests&nbsp;to&nbsp;Squid&nbsp;start&nbsp;failing&nbsp;with&lt;br&gt;<br>
&gt; &nbsp; &nbsp; errors&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;similar&nbsp;to&nbsp;the&nbsp;following:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;Squid&nbsp;log:&nbsp;`1634330668.200&nbsp; &nbsp; &nbsp; 5&nbsp;&lt;nlb-private-ip&gt;&nbsp;NONE_NONE/400&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 2032&nbsp;-&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;error:invalid-request&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html`&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;Client&nbsp;log:&nbsp;`X-Squid-Error:&nbsp;ERR_PROTOCOL_UNKNOWN&nbsp;0`&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &gt;&nbsp;http_port&nbsp;3128&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; You&nbsp;must&nbsp;use&nbsp;require-proxy-header&nbsp;http_port&nbsp;option&nbsp;to&nbsp;tell&nbsp;Squid&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; always&nbsp;expect/require&nbsp;PROXY&nbsp;protocol&nbsp;messages&nbsp;on&nbsp;connections&nbsp;to&nbsp;that&lt;br&gt;<br>
&gt; &nbsp; &nbsp; listening &nbsp;port.&nbsp;Otherwise,&nbsp;Squid&nbsp;will&nbsp;expect&nbsp;naked&nbsp;HTTP&nbsp;traffic&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; fail&nbsp;to&nbsp;parse&nbsp;incoming&nbsp;(PROXY&nbsp;protocol)&nbsp;connection&nbsp;bytes.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; According&nbsp;to&nbsp;proxy_protocol_access&nbsp;documentation,&nbsp;after&nbsp;adding&lt;br&gt;<br>
&gt; &nbsp; &nbsp; require-proxy-header&nbsp;to&nbsp;http_port,&nbsp;you&nbsp;must&nbsp;also&nbsp;use&lt;br&gt;<br>
&gt; &nbsp; &nbsp; proxy_protocol_access&nbsp;to&nbsp;tell&nbsp;Squid&nbsp;which&nbsp;TCP&nbsp;connections&nbsp;to&nbsp;allow&nbsp;on&lt;br&gt;<br>
&gt; &nbsp; &nbsp; that&nbsp;port&nbsp;(and,&nbsp;hence,&nbsp;which&nbsp;PROXY&nbsp;protocol&nbsp;messages&nbsp;to&nbsp;trust).&nbsp;Denied&lt;br&gt;<br>
&gt; &nbsp; &nbsp; connections&nbsp;will&nbsp;be&nbsp;closed.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; HTH,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Alex.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
