<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hey Alex,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;If&nbsp;there&nbsp;are&nbsp;a&nbsp;lot&nbsp;more&nbsp;requests&nbsp;than&nbsp;your&nbsp;users/TTLs&nbsp;should&nbsp;generate,&lt;br&gt;then&nbsp;you&nbsp;may&nbsp;be&nbsp;able&nbsp;to&nbsp;decrease&nbsp;db&nbsp;load&nbsp;by&nbsp;figuring&nbsp;out&nbsp;where&nbsp;the&nbsp;extra&lt;br&gt;requests&nbsp;are&nbsp;coming&nbsp;from.&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;actually,&nbsp;I&nbsp;don&#39;t&nbsp;think&nbsp;it&nbsp;matters&nbsp;much&nbsp;now&nbsp;that&nbsp;I&nbsp;think&nbsp;about&nbsp;it&nbsp;again,&nbsp;since&nbsp;as&nbsp;per&nbsp;my&nbsp;requirements,&lt;/div&gt;&lt;div&gt;I&nbsp;need&nbsp;to&nbsp;reload&nbsp;the&nbsp;cache&nbsp;every&nbsp;60&nbsp;seconds,&nbsp;which&nbsp;means&nbsp;that&nbsp;even&nbsp;if&nbsp;it&nbsp;is&nbsp;perfect,&nbsp;MariaDB&nbsp;will&nbsp;still &lt;/div&gt;&lt;div&gt;get&nbsp;a&nbsp;high&nbsp;load.&nbsp;I&nbsp;think&nbsp;the&nbsp;second&nbsp;approach&nbsp;will&nbsp;be&nbsp;better&nbsp;suited.&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;and/or&nbsp;adding&nbsp;database&lt;br&gt;power&nbsp;(e.g.,&nbsp;by&nbsp;introducing&nbsp;additional&nbsp;databases&nbsp;running&nbsp;on&nbsp;previously&lt;br&gt;unused&nbsp;hardware&nbsp;--&nbsp;just&nbsp;like&nbsp;your&nbsp;MariaDB&nbsp;idea).&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;is&nbsp;an&nbsp;excellent&nbsp;point, &nbsp;I&nbsp;think&nbsp;I&nbsp;will&nbsp;work&nbsp;on&nbsp;a&nbsp;central&nbsp;connection&nbsp;aggregator&nbsp;as&nbsp;you&nbsp;suggested,&lt;/div&gt;&lt;div&gt;and&nbsp;also&nbsp;put&nbsp;in&nbsp;more&nbsp;DB&nbsp;power&nbsp;via&nbsp;Redis&nbsp;on&nbsp;K8S.&nbsp;This&nbsp;way&nbsp;it&nbsp;will&nbsp;best&nbsp;fast&nbsp;and&nbsp;scale&nbsp;automatically.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;aggregating&nbsp;helper-db&nbsp;connections&nbsp;(helpers&nbsp;can&nbsp;be&nbsp;written&nbsp;to&lt;br&gt;talk&nbsp;through&nbsp;a&nbsp;central&nbsp;connection&nbsp;aggregator)&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; That&nbsp;sounds&nbsp;like&nbsp;exactly&nbsp;what&nbsp;I&nbsp;am&nbsp;looking&nbsp;for,&nbsp;how&nbsp;would&nbsp;one&nbsp;go&nbsp;about&nbsp;doing&nbsp;this?&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Tue,&nbsp;Feb&nbsp;8,&nbsp;2022&nbsp;at&nbsp;4:41&nbsp;PM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2/8/22&nbsp;09:13,&nbsp;roee&nbsp;klinger&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;am&nbsp;running&nbsp;multiple&nbsp;instances&nbsp;of&nbsp;Squid&nbsp;in&nbsp;a&nbsp;K8S&nbsp;environment,&nbsp;each&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;instance&nbsp;has&nbsp;a&nbsp;helper that&nbsp;authenticates&nbsp;users&nbsp;based&nbsp;on&nbsp;their&nbsp;&lt;br&gt;<br>
&gt;&nbsp;username&nbsp;and&nbsp;password,&nbsp;the&nbsp;scripts&nbsp;are&nbsp;written&nbsp;in&nbsp;Python.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;been&nbsp;facing&nbsp;an&nbsp;issue,&nbsp;that&nbsp;when&nbsp;under&nbsp;load,&nbsp;the&nbsp;helpers&nbsp;(even&nbsp;&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;3600&nbsp;sec&nbsp;TTL)&nbsp;swamp&nbsp;the&nbsp;MariaDB&nbsp;instance,&nbsp;causing it&nbsp;to&nbsp;reach&nbsp;100%&nbsp;&lt;br&gt;<br>
&gt;&nbsp;CPU,&nbsp;basically I&nbsp;believe&nbsp;because&nbsp;each&nbsp;helper&nbsp;opens&nbsp;up&nbsp;its&nbsp;own&nbsp;connection&nbsp;&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;MariaDB,&nbsp;which&nbsp;ends&nbsp;up&nbsp;as&nbsp;a&nbsp;lot&nbsp;of&nbsp;connections.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;My&nbsp;initial&nbsp;idea&nbsp;was&nbsp;to&nbsp;create&nbsp;a&nbsp;Redis&nbsp;DB&nbsp;next&nbsp;to&nbsp;each&nbsp;Squid&nbsp;instance&nbsp;and&nbsp;&lt;br&gt;<br>
&gt;&nbsp;connect&nbsp;each&nbsp;Squid&nbsp;to&nbsp;its&nbsp;own&nbsp;dedicated&nbsp;Redis.&nbsp;I&nbsp;will&nbsp;sync&nbsp;Redis&nbsp;with&nbsp;&lt;br&gt;<br>
&gt;&nbsp;MariaDB&nbsp;every&nbsp;minute,&nbsp;thus&nbsp;decreasing&nbsp;the&nbsp;connections&nbsp;count&nbsp;from&nbsp;a&nbsp;few&nbsp;&lt;br&gt;<br>
&gt;&nbsp;100s&nbsp;to&nbsp;just&nbsp;1&nbsp;every&nbsp;minute.&nbsp;This&nbsp;will&nbsp;also&nbsp;improve&nbsp;speeds&nbsp;since&nbsp;Redis&nbsp;&lt;br&gt;<br>
&gt;&nbsp;is&nbsp;much&nbsp;faster&nbsp;than&nbsp;MariaDB.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;problem&nbsp;is,&nbsp;however,&nbsp;that&nbsp;there&nbsp;will&nbsp;still&nbsp;be&nbsp;many&nbsp;connections&nbsp;from&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;to&nbsp;Redis,&nbsp;and&nbsp;I&nbsp;probably&nbsp;that&nbsp;will&nbsp;consume&nbsp;a&nbsp;lot&nbsp;of&nbsp;DB&nbsp;resources&nbsp;&lt;br&gt;<br>
&gt;&nbsp;as&nbsp;well,&nbsp;which&nbsp;I&nbsp;don&#39;t&nbsp;actually&nbsp;know&nbsp;how&nbsp;to&nbsp;optimize,&nbsp;since&nbsp;it&nbsp;seems&nbsp;&lt;br&gt;<br>
&gt;&nbsp;that&nbsp;Squid&nbsp;opens&nbsp;many&nbsp;processes,&nbsp;and&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;get&nbsp;them&nbsp;to&nbsp;talk&nbsp;&lt;br&gt;<br>
&gt;&nbsp;to&nbsp;each&nbsp;other&nbsp;(expect&nbsp;TTL&nbsp;values,&nbsp;which&nbsp;seems&nbsp;not&nbsp;to&nbsp;help&nbsp;in&nbsp;my&nbsp;case,&nbsp;&lt;br&gt;<br>
&gt;&nbsp;which&nbsp;I&nbsp;also&nbsp;don&#39;t&nbsp;understand&nbsp;why&nbsp;that&nbsp;is).&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;is&nbsp;the&nbsp;best&nbsp;practice&nbsp;to&nbsp;handle&nbsp;this?&nbsp;considering&nbsp;I&nbsp;have&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;following&nbsp;requirements:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 1.&nbsp;Fast&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 2.&nbsp;Refresh&nbsp;data&nbsp;every&nbsp;minute&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 3.&nbsp;Consume&nbsp;as&nbsp;least&nbsp;amount&nbsp;of&nbsp;DB&nbsp;resources&nbsp;as&nbsp;possible&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;would&nbsp;start&nbsp;from&nbsp;the&nbsp;beginning:&nbsp;Does&nbsp;the&nbsp;aggregate&nbsp;number&nbsp;of&nbsp;database&nbsp;&lt;br&gt;<br>
requests&nbsp;match&nbsp;your&nbsp;expectations?&nbsp;In&nbsp;other&nbsp;words,&nbsp;do&nbsp;you&nbsp;see&nbsp;lots&nbsp;of&nbsp;&lt;br&gt;<br>
database&nbsp;requests&nbsp;that&nbsp;should&nbsp;not&nbsp;be&nbsp;there&nbsp;given&nbsp;your&nbsp;user&nbsp;access&nbsp;&lt;br&gt;<br>
patterns&nbsp;and&nbsp;authentication&nbsp;TTLs?&nbsp;In&nbsp;yet&nbsp;other&nbsp;words,&nbsp;are&nbsp;there&nbsp;many&nbsp;&lt;br&gt;<br>
repeated&nbsp;authentication&nbsp;accesses&nbsp;that&nbsp;should&nbsp;have&nbsp;been&nbsp;authentication&nbsp;&lt;br&gt;<br>
cache&nbsp;hits?&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;there&nbsp;are&nbsp;a&nbsp;lot&nbsp;more&nbsp;requests&nbsp;than&nbsp;your&nbsp;users/TTLs&nbsp;should&nbsp;generate,&nbsp;&lt;br&gt;<br>
then&nbsp;you&nbsp;may&nbsp;be&nbsp;able&nbsp;to&nbsp;decrease&nbsp;db&nbsp;load&nbsp;by&nbsp;figuring&nbsp;out&nbsp;where&nbsp;the&nbsp;extra&nbsp;&lt;br&gt;<br>
requests&nbsp;are&nbsp;coming&nbsp;from.&nbsp;For&nbsp;example,&nbsp;it&nbsp;is&nbsp;possible&nbsp;that&nbsp;your&nbsp;&lt;br&gt;<br>
authentication&nbsp;cache&nbsp;key&nbsp;includes&nbsp;some&nbsp;noise&nbsp;that&nbsp;renders&nbsp;caching&nbsp;&lt;br&gt;<br>
ineffective&nbsp;(e.g.,&nbsp;see&nbsp;comments&nbsp;about&nbsp;key_extras&nbsp;in&nbsp;&lt;br&gt;<br>
squid.conf.documented).&nbsp;Or&nbsp;maybe&nbsp;you&nbsp;need&nbsp;a&nbsp;bigger&nbsp;authentication&nbsp;cache.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;the&nbsp;total&nbsp;stream&nbsp;of&nbsp;authentication&nbsp;requests&nbsp;during&nbsp;peak&nbsp;hours&nbsp;is&nbsp;&lt;br&gt;<br>
reasonable,&nbsp;with&nbsp;few&nbsp;unwarranted&nbsp;cache&nbsp;misses,&nbsp;then&nbsp;you&nbsp;can&nbsp;start&nbsp;&lt;br&gt;<br>
working&nbsp;on&nbsp;aggregating&nbsp;helper-db&nbsp;connections&nbsp;(helpers&nbsp;can&nbsp;be&nbsp;written&nbsp;to&nbsp;&lt;br&gt;<br>
talk&nbsp;through&nbsp;a&nbsp;central&nbsp;connection&nbsp;aggregator)&nbsp;and/or&nbsp;adding&nbsp;database&nbsp;&lt;br&gt;<br>
power&nbsp;(e.g.,&nbsp;by&nbsp;introducing&nbsp;additional&nbsp;databases&nbsp;running&nbsp;on&nbsp;previously&nbsp;&lt;br&gt;<br>
unused&nbsp;hardware&nbsp;--&nbsp;just&nbsp;like&nbsp;your&nbsp;MariaDB&nbsp;idea).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
