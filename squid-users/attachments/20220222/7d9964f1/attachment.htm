<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Well&nbsp;this&nbsp;was&nbsp;a&nbsp;wild&nbsp;ride,&nbsp;I&nbsp;actually&nbsp;tracked&nbsp;the&nbsp;problem&nbsp;back&nbsp;to....&nbsp;dns64/nat64!!!!!!!!!&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;I&nbsp;discovered&nbsp;is&nbsp;that&nbsp;the&nbsp;affected&nbsp;webserver&nbsp;didn&#39;t&nbsp;actually&nbsp;have&nbsp;ipv6&nbsp;-&nbsp;it&nbsp;only&nbsp;had&nbsp;2&nbsp;ipv4&nbsp;addresses.&nbsp;But&nbsp;something&nbsp;in&nbsp;my&nbsp;DNS-tree&nbsp;(I&#39;m&nbsp;suspecting&nbsp;the&nbsp;local&nbsp;systemd-resolve,&nbsp;but&nbsp;can&#39;t&nbsp;actually&nbsp;find&nbsp;any&nbsp;direct&nbsp;evidence)&nbsp;had&nbsp;whacked&nbsp;fake &nbsp;DNS64/NAT64&nbsp;records&nbsp;for&nbsp;each&nbsp;of&nbsp;them.&nbsp;I&#39;ve&nbsp;never&nbsp;seen&nbsp;them&nbsp;before&nbsp;so&nbsp;didn&#39;t&nbsp;realise&nbsp;&quot;64:ff9b:XXXXXXXX&quot;&nbsp;was&nbsp;a&nbsp;&quot;special&quot;&nbsp;IPv6&nbsp;range.&nbsp;I&nbsp;directly&nbsp;queried&nbsp;our&nbsp;upstream&nbsp;DNS&nbsp;recursive&nbsp;name&nbsp;server&nbsp;and&nbsp;it&nbsp;didn&#39;t&nbsp;have&nbsp;those&nbsp;IPv6&nbsp;records&nbsp;-&nbsp;but&nbsp;the&nbsp;local&nbsp;systemd-resolve&nbsp;would&nbsp;not&nbsp;give&nbsp;them&nbsp;up.&nbsp;So&nbsp;I&nbsp;down/up-ed&nbsp;the&nbsp;interface&nbsp;(resetting&nbsp;systemd-resolve)&nbsp;and&nbsp;the&nbsp;problem&nbsp;disappeared. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;new&nbsp;information&nbsp;really&nbsp;doesn&#39;t&nbsp;change&nbsp;the&nbsp;nature&nbsp;of&nbsp;the&nbsp;question,&nbsp;but&nbsp;I&#39;m&nbsp;afraid&nbsp;the&nbsp;problem&nbsp;is&nbsp;now&nbsp;resolved&nbsp;(for&nbsp;the&nbsp;moment)&nbsp;so&nbsp;debugging&nbsp;won&#39;t&nbsp;catch&nbsp;it.&nbsp;If&nbsp;it&nbsp;happens&nbsp;again&nbsp;(I&nbsp;have&nbsp;never&nbsp;seen&nbsp;this&nbsp;before)&nbsp;I&#39;ll&nbsp;be&nbsp;sure&nbsp;to&nbsp;do&nbsp;the&nbsp;debugging&nbsp;thang.&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Tue,&nbsp;Feb&nbsp;22,&nbsp;2022&nbsp;at&nbsp;3:16&nbsp;AM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2/20/22&nbsp;20:43,&nbsp;Jason&nbsp;Haar&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&#39;ve&nbsp;noticed&nbsp;that&nbsp;the&nbsp;Internet&nbsp;ipv6&nbsp;is&nbsp;not&nbsp;quite&nbsp;as&nbsp;reliable&nbsp;as&nbsp;ipv4,&nbsp;in&nbsp;&lt;br&gt;<br>
&gt;&nbsp;that&nbsp;squid reports&nbsp;it&nbsp;cannot&nbsp;connect&nbsp;to&nbsp;web&nbsp;servers&nbsp;with&nbsp;an&nbsp;ipv6&nbsp;error&nbsp;&lt;br&gt;<br>
&gt;&nbsp;when&nbsp;the&nbsp;web&nbsp;server&nbsp;is&nbsp;still&nbsp;available&nbsp;over&nbsp;ipv4.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;eg&nbsp;right&nbsp;now&nbsp;one&nbsp;of&nbsp;our&nbsp;Internet-based&nbsp;web&nbsp;apps&nbsp;(which&nbsp;has&nbsp;2&nbsp;ipv6&nbsp;and&nbsp;2&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ipv4&nbsp;IP&nbsp;addresses&nbsp;mapped&nbsp;to&nbsp;it&#39;s&nbsp;DNS&nbsp;name)&nbsp;is&nbsp;not&nbsp;responding&nbsp;over&nbsp;ipv6&nbsp;&lt;br&gt;<br>
&gt;&nbsp;for&nbsp;some&nbsp;reason&nbsp;(I&nbsp;dunno&nbsp;-&nbsp;not&nbsp;involved&nbsp;myself)&nbsp;-&nbsp;but&nbsp;is&nbsp;working&nbsp;fine&nbsp;&lt;br&gt;<br>
&gt;&nbsp;over&nbsp;ipv4.&nbsp;Squid-5.4&nbsp;is&nbsp;erroring&nbsp;out&nbsp;-&nbsp;saying&nbsp;that&nbsp;it&nbsp;cannot&nbsp;connect&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;first&nbsp;ipv6&nbsp;address&nbsp;with&nbsp;a&nbsp;&quot;no&nbsp;route&nbsp;to&nbsp;host&quot;&nbsp;error.&nbsp;But&nbsp;if&nbsp;I&nbsp;use&nbsp;&lt;br&gt;<br>
&gt;&nbsp;good-ol&#39;&nbsp;telnet&nbsp;to&nbsp;the&nbsp;DNS&nbsp;name,&nbsp;telnet&nbsp;shows&nbsp;it&nbsp;trying-and-failing&nbsp;&lt;br&gt;<br>
&gt;&nbsp;against&nbsp;both&nbsp;ipv6&nbsp;addresses&nbsp;and&nbsp;then&nbsp;succeeds&nbsp;against&nbsp;the&nbsp;ipv4.&nbsp;ie&nbsp;it&nbsp;&lt;br&gt;<br>
&gt;&nbsp;works&nbsp;and&nbsp;squid&nbsp;doesn&#39;t.&nbsp;BTW&nbsp;the&nbsp;same&nbsp;squid&nbsp;server&nbsp;is&nbsp;currently&nbsp;fine&nbsp;&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;ipv6&nbsp;clients&nbsp;talking&nbsp;to&nbsp;it&nbsp;and&nbsp;it&nbsp;talking&nbsp;over&nbsp;ipv6&nbsp;to&nbsp;Internet&nbsp;&lt;br&gt;<br>
&gt;&nbsp;hosts&nbsp;like&nbsp;&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;google.com&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://google.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://google.com&lt;/a&gt;&gt;&nbsp;-&nbsp;ie&nbsp;this&nbsp;is&nbsp;an&nbsp;ipv6&nbsp;outage&nbsp;on&nbsp;&lt;br&gt;<br>
&gt;&nbsp;one&nbsp;Internet&nbsp;host&nbsp;where&nbsp;it&#39;s&nbsp;ipv4&nbsp;is&nbsp;still&nbsp;working.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;This&nbsp;doesn&#39;t&nbsp;seem&nbsp;like&nbsp;a&nbsp;negative_dns_ttl&nbsp;setting&nbsp;issue,&nbsp;it&nbsp;seems&nbsp;like&nbsp;&lt;br&gt;<br>
&gt;&nbsp;squid just&nbsp;tries&nbsp;one&nbsp;address&nbsp;on&nbsp;a&nbsp;multiple-IP&nbsp;DNS&nbsp;record&nbsp;and&nbsp;stops&nbsp;&lt;br&gt;<br>
&gt;&nbsp;trying?&nbsp;I&nbsp;even&nbsp;got&nbsp;tcpdump&nbsp;up&nbsp;and&nbsp;can&nbsp;see&nbsp;that&nbsp;when&nbsp;I&nbsp;do&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&quot;shift-reload&quot;&nbsp;on&nbsp;the&nbsp;webpage,&nbsp;squid&nbsp;only&nbsp;sends&nbsp;a&nbsp;few&nbsp;SYN&nbsp;packets&nbsp;to&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;same&nbsp;non-working&nbsp;IPv6&nbsp;address&nbsp;-&nbsp;it&nbsp;doesn&#39;t&nbsp;even&nbsp;try&nbsp;the&nbsp;other&nbsp;3&nbsp;IPs?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;also&nbsp;checked&nbsp;squidcachemgr.cgi&nbsp;and&nbsp;the&nbsp;DNS&nbsp;record&nbsp;isn&#39;t&nbsp;even&nbsp;cached&nbsp;in&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&quot;FQDN&nbsp;Cache&nbsp;Stats&nbsp;and&nbsp;Contents&quot;,&nbsp;which&nbsp;I&nbsp;guess&nbsp;is&nbsp;consistent&nbsp;with&nbsp;it&#39;s&nbsp;&lt;br&gt;<br>
&gt;&nbsp;opinion&nbsp;that&nbsp;it&#39;s&nbsp;not&nbsp;working.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;ideas&nbsp;what&#39;s&nbsp;going&nbsp;on&nbsp;there?&nbsp;thanks!&lt;br&gt;<br>
&lt;br&gt;<br>
Squid&nbsp;is&nbsp;supposed&nbsp;to&nbsp;send&nbsp;both&nbsp;A&nbsp;and&nbsp;AAAA&nbsp;DNS&nbsp;queries&nbsp;for&nbsp;the&nbsp;uncached&nbsp;&lt;br&gt;<br>
domain&nbsp;and&nbsp;then&nbsp;try&nbsp;the&nbsp;first&nbsp;IP&nbsp;it&nbsp;can&nbsp;DNS-resolve&nbsp;and&nbsp;TCP-connect&nbsp;to.&nbsp;&lt;br&gt;<br>
If&nbsp;that&nbsp;winning&nbsp;destination&nbsp;does&nbsp;not&nbsp;work&nbsp;at&nbsp;HTTP&nbsp;level,&nbsp;then&nbsp;Squid&nbsp;may,&nbsp;&lt;br&gt;<br>
in&nbsp;some&nbsp;cases,&nbsp;try&nbsp;other&nbsp;destinations.&nbsp;There&nbsp;are&nbsp;lots&nbsp;of&nbsp;variables&nbsp;and&nbsp;&lt;br&gt;<br>
nuances&nbsp;related&nbsp;to&nbsp;the&nbsp;associated&nbsp;Happy&nbsp;Eyeballs&nbsp;and&nbsp;reforwarding&nbsp;&lt;br&gt;<br>
algorithms.&nbsp;It&nbsp;is&nbsp;impossible&nbsp;to&nbsp;say&nbsp;for&nbsp;sure&nbsp;what&nbsp;is&nbsp;going&nbsp;on&nbsp;in&nbsp;your&nbsp;&lt;br&gt;<br>
specific&nbsp;case&nbsp;without&nbsp;more&nbsp;information.&lt;br&gt;<br>
&lt;br&gt;<br>
Your&nbsp;best&nbsp;bet&nbsp;may&nbsp;be&nbsp;to&nbsp;share&nbsp;an&nbsp;ALL,9&nbsp;cache.log&nbsp;that&nbsp;reproduces&nbsp;the&nbsp;&lt;br&gt;<br>
problem&nbsp;using&nbsp;a&nbsp;single&nbsp;isolated&nbsp;test&nbsp;transaction:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Cheers&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jason&nbsp;Haar&lt;/div&gt;&lt;div&gt;Information&nbsp;Security&nbsp;Manager,&nbsp;Trimble&nbsp;Navigation&nbsp;Ltd.&lt;/div&gt;&lt;div&gt;Phone:&nbsp;+1&nbsp;408&nbsp;481&nbsp;8171&lt;/div&gt;&lt;div&gt;PGP&nbsp;Fingerprint:&nbsp;7A2E&nbsp;0407&nbsp;C9A6&nbsp;CAF6&nbsp;2B9F&nbsp;8422&nbsp;C063&nbsp;5EBB&nbsp;FE1D&nbsp;66D1&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
