<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;Hi,&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;Does&nbsp;anyone&nbsp;have&nbsp;recommendations&nbsp;on&nbsp;scaling&nbsp;concurrent&nbsp;connections&nbsp;through&nbsp;the&nbsp;squid&nbsp;proxy&nbsp;to&nbsp;above&nbsp;the&nbsp;ephemeral&nbsp;port&nbsp;range?&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;I&nbsp;have&nbsp;squid&nbsp;v5.5&nbsp;on&nbsp;Ubuntu&nbsp;with&nbsp;about&nbsp;48K&nbsp;ephemeral&nbsp;ports&nbsp;available&nbsp;with&nbsp;the&nbsp;ip_local_port_range.&nbsp;The&nbsp;squid&nbsp;is&nbsp;bound&nbsp;to&nbsp;listen&nbsp;on&nbsp;port&nbsp;3128&nbsp;and&nbsp;has&nbsp;a&nbsp;single&nbsp;tcp_outgoing_address&nbsp;configured.&nbsp;We&nbsp;notice&nbsp;that&nbsp;after&nbsp;about&nbsp;40-45k&nbsp;concurrent&nbsp;connections&nbsp;through&nbsp;the&nbsp;proxy&nbsp;it is&nbsp;unable&nbsp;to&nbsp;reuse&nbsp;ports&nbsp;and&nbsp;it&nbsp;severely&nbsp;limits&nbsp;local&nbsp;ports&nbsp;available&nbsp;to&nbsp;other&nbsp;applications&nbsp;running&nbsp;on&nbsp;the&nbsp;system.&nbsp;The&nbsp;squid&nbsp;is&nbsp;setup&nbsp;to&nbsp;run&nbsp;30&nbsp;workers;&nbsp;total&nbsp;CPU&nbsp;is&nbsp;still&nbsp;under&nbsp;10%&nbsp;during&nbsp;peak&nbsp;connection&nbsp;rates.&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;Is&nbsp;any&nbsp;build&nbsp;config&nbsp;flag&nbsp;required&nbsp;to&nbsp;enable&nbsp;SO_REUSEPORT&nbsp;or&nbsp;SO_REUSEADDR&nbsp;on&nbsp;the&nbsp;outbound&nbsp;TCP&nbsp;sessions&nbsp;opened&nbsp;by&nbsp;squid?&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;It&nbsp;does&nbsp;not&nbsp;appear&nbsp;that&nbsp;there&nbsp;is&nbsp;an&nbsp;option&nbsp;to&nbsp;use&nbsp;the&nbsp;IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;flag&nbsp;which&nbsp;can&nbsp;help&nbsp;with&nbsp;ephemeral&nbsp;port&nbsp;reuse.&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &lt;/span&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;We&nbsp;have&nbsp;tried&nbsp;enabling&nbsp;tcp_tw_reuse,&nbsp;ip_autobind_reuse&nbsp;and&nbsp;ip_nonlocal_bind&nbsp;flags,&nbsp;but&nbsp;unable&nbsp;to&nbsp;get&nbsp;the&nbsp;system&nbsp;reuse&nbsp;the&nbsp;ephemeral&nbsp;ports.&nbsp;The&nbsp;fs.file-max&nbsp;is&nbsp;set&nbsp;to&nbsp;4M.&nbsp;Pasted&nbsp;some&nbsp;errors&nbsp;below.&nbsp;Any&nbsp;suggestions&nbsp;are&nbsp;appreciated!&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;Thanks&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;Praveen&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;2022/05/19&nbsp;23:35:00&nbsp;kid12|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;3075&nbsp;to&nbsp;&lt;&lt;i&gt;IP&lt;/i&gt;&gt;:&nbsp;(99)&nbsp;Cannot&nbsp;assign&nbsp;requested&nbsp;address&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &nbsp; &nbsp;&lt;/span&gt;current&nbsp;master&nbsp;transaction:&nbsp;master48536607&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;2022/05/19&nbsp;23:35:00&nbsp;kid23|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;1320&nbsp;to&nbsp;&lt;&lt;i&gt;IP&lt;/i&gt;&gt;:&nbsp;(99)&nbsp;Cannot&nbsp;assign&nbsp;requested&nbsp;address&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &nbsp; &nbsp;&lt;/span&gt;current&nbsp;master&nbsp;transaction:&nbsp;master26662366&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;2022/05/19&nbsp;23:37:30&nbsp;kid13|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;3346&nbsp;to&nbsp;&lt;&lt;i&gt;IP&lt;/i&gt;&gt;:&nbsp;(98)&nbsp;Address&nbsp;already&nbsp;in&nbsp;use&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &nbsp; &nbsp;&lt;/span&gt;current&nbsp;master&nbsp;transaction:&nbsp;master11976056&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;2022/05/19&nbsp;23:37:30&nbsp;kid12|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;6459&nbsp;to&nbsp;&lt;&lt;i&gt;IP&lt;/i&gt;&gt;:&nbsp;(98)&nbsp;Address&nbsp;already&nbsp;in&nbsp;use&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;&lt;span&nbsp;class=&quot;gmail-Apple-converted-space&quot;&gt; &nbsp; &nbsp;&lt;/span&gt;current&nbsp;master&nbsp;transaction:&nbsp;master48561031&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;While&nbsp;the&nbsp;system&nbsp;is&nbsp;in&nbsp;this&nbsp;state,&nbsp;local&nbsp;curl’s&nbsp;to&nbsp;another&nbsp;endpoint&nbsp;on&nbsp;the&nbsp;same&nbsp;node&nbsp;are&nbsp;not&nbsp;able&nbsp;to&nbsp;obtain&nbsp;a&nbsp;TCP&nbsp;socket.&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p2&quot;&nbsp;style=&quot;margin:0px;font:13px&nbsp;&quot;Helvetica&nbsp;Neue&quot;;min-height:15px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;/p&gt;&lt;p&nbsp;class=&quot;gmail-p1&quot;&nbsp;style=&quot;margin:0px;font-variant-numeric:normal;font-variant-east-asian:normal;font-stretch:normal;font-size:13px;line-height:normal;font-family:&quot;Helvetica&nbsp;Neue&quot;&quot;&gt;curl:&nbsp;(7)&nbsp;Couldn&#39;t&nbsp;connect&nbsp;to&nbsp;server&lt;/p&gt;&lt;/div&gt;<br>

</tt>
