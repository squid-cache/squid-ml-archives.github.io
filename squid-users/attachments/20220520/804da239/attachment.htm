<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Alex,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;going&nbsp;through&nbsp;several&nbsp;steps&nbsp;to&nbsp;help&nbsp;mitigate&nbsp;src&nbsp;port&nbsp;exhaustion.&nbsp;We&nbsp;are&nbsp;looking&nbsp;to&nbsp;achieve&nbsp;400-500%&nbsp;more&nbsp;concurrent connections&nbsp;if&nbsp;we&nbsp;could&nbsp;:)&nbsp;as&nbsp;there&nbsp;is&nbsp;a&nbsp;significant buffer&nbsp;on&nbsp;the&nbsp;available&nbsp;CPU. &lt;/div&gt;&lt;div&gt;The&nbsp;option&nbsp;to&nbsp;use&nbsp;multiple&nbsp;tcp_outoing_addresses&nbsp;appears&nbsp;to&nbsp;be&nbsp;promising&nbsp;along&nbsp;with&nbsp;some&nbsp;tweaks&nbsp;to&nbsp;the&nbsp;TCP&nbsp;timeouts.&nbsp;I&nbsp;guess&nbsp;we&nbsp;could&nbsp;use&nbsp;ACLs&nbsp;to&nbsp;pick&nbsp;a&nbsp;different&nbsp;outbound&nbsp;IP&nbsp;based&nbsp;on&nbsp;the&nbsp;requesting&nbsp;client&#39;s&nbsp;prefix.&nbsp;We&nbsp;had&nbsp;not&nbsp;considered&nbsp;that&nbsp;option&nbsp;as&nbsp;the&nbsp;ephemeral&nbsp;ports&nbsp;were&nbsp;no&nbsp;longer&nbsp;available to&nbsp;other&nbsp;applications&nbsp;when&nbsp;squid&nbsp;uses&nbsp;most&nbsp;of&nbsp;them&nbsp;with&nbsp;a&nbsp;single&nbsp;outbound&nbsp;IP&nbsp;configured.&nbsp;We&nbsp;are&nbsp;also&nbsp;looking&nbsp;to&nbsp;modify&nbsp;the&nbsp;code&nbsp;to&nbsp;use&nbsp;the&nbsp;IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;as&nbsp;that&nbsp;could&nbsp;help&nbsp;delay&nbsp;port&nbsp;assignment&nbsp;with&nbsp;the&nbsp;bind()&nbsp;call&nbsp;on&nbsp;the&nbsp;outbound&nbsp;TCP&nbsp;sessions&nbsp;(to&nbsp;hopefully&nbsp;allow&nbsp;access&nbsp;to&nbsp;the&nbsp;4-tuple&nbsp;on&nbsp;the&nbsp;socket).&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;div&gt;Praveen&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Thu,&nbsp;May&nbsp;19,&nbsp;2022&nbsp;at&nbsp;7:18&nbsp;PM&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;5/19/22&nbsp;20:22,&nbsp;Praveen&nbsp;Ponakanti&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Does&nbsp;anyone&nbsp;have&nbsp;recommendations&nbsp;on&nbsp;scaling&nbsp;concurrent&nbsp;connections&nbsp;&lt;br&gt;<br>
&gt;&nbsp;through&nbsp;the&nbsp;squid&nbsp;proxy&nbsp;to&nbsp;above&nbsp;the&nbsp;ephemeral&nbsp;port&nbsp;range?&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;know&nbsp;of&nbsp;several&nbsp;solutions,&nbsp;but&nbsp;not&nbsp;all&nbsp;of&nbsp;them&nbsp;are&nbsp;probably&nbsp;applicable&nbsp;&lt;br&gt;<br>
to&nbsp;your&nbsp;specific&nbsp;situation:&lt;br&gt;<br>
&lt;br&gt;<br>
1.&nbsp;Decrease&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;closed&nbsp;TCP&nbsp;connections&nbsp;occupy&nbsp;the&nbsp;port.&nbsp;&lt;br&gt;<br>
For&nbsp;example,&nbsp;if&nbsp;you&nbsp;have&nbsp;many&nbsp;connections&nbsp;in&nbsp;TIME_WAIT&nbsp;state,&nbsp;and&nbsp;can&nbsp;&lt;br&gt;<br>
afford&nbsp;to&nbsp;lower&nbsp;that&nbsp;state&nbsp;duration,&nbsp;it&nbsp;may&nbsp;help&nbsp;free&nbsp;ports&nbsp;faster.&lt;br&gt;<br>
&lt;br&gt;<br>
2.&nbsp;If&nbsp;outgoing&nbsp;connections&nbsp;are&nbsp;closed&nbsp;faster&nbsp;(i.e.&nbsp;after&nbsp;fewer&nbsp;requests)&nbsp;&lt;br&gt;<br>
than&nbsp;they&nbsp;should&nbsp;be,&nbsp;then&nbsp;fix&nbsp;that&nbsp;problem&nbsp;to&nbsp;increase&nbsp;connection&nbsp;reuse&nbsp;&lt;br&gt;<br>
(and,&nbsp;hence,&nbsp;decrease&nbsp;port&nbsp;pressure).&nbsp;This&nbsp;solution&nbsp;is&nbsp;usually&nbsp;&lt;br&gt;<br>
applicable&nbsp;to&nbsp;environments&nbsp;where&nbsp;you&nbsp;control&nbsp;both&nbsp;ends&nbsp;of&nbsp;the&nbsp;connection&nbsp;&lt;br&gt;<br>
and&nbsp;see&nbsp;some&nbsp;premature&nbsp;closures.&lt;br&gt;<br>
&lt;br&gt;<br>
3.&nbsp;Use&nbsp;more&nbsp;outgoing&nbsp;IP&nbsp;addresses.&nbsp;Without&nbsp;modifications,&nbsp;Squid&nbsp;would&nbsp;&lt;br&gt;<br>
not&nbsp;automatically&nbsp;pick&nbsp;the&nbsp;next&nbsp;outgoing&nbsp;IP&nbsp;address&nbsp;after&nbsp;using&nbsp;up&nbsp;most&nbsp;&lt;br&gt;<br>
of&nbsp;the&nbsp;ports&nbsp;on&nbsp;the&nbsp;previous&nbsp;one,&nbsp;but&nbsp;perhaps&nbsp;the&nbsp;OS&nbsp;would&nbsp;do&nbsp;the&nbsp;right&nbsp;&lt;br&gt;<br>
thing&nbsp;_for_&nbsp;Squid?&nbsp;Not&nbsp;sure.&nbsp;You&nbsp;can&nbsp;use&nbsp;tcp_outgoing_address&nbsp;with&nbsp;&lt;br&gt;<br>
random&nbsp;ACLs&nbsp;to&nbsp;force-spread&nbsp;the&nbsp;load&nbsp;across&nbsp;multiple&nbsp;IPs&nbsp;(and,&nbsp;hence,&nbsp;&lt;br&gt;<br>
multiple&nbsp;port&nbsp;banks).&nbsp;This&nbsp;does&nbsp;not&nbsp;work&nbsp;if&nbsp;you&nbsp;must&nbsp;use&nbsp;a&nbsp;single&nbsp;&lt;br&gt;<br>
outgoing&nbsp;IP&nbsp;for&nbsp;some&nbsp;reason.&lt;br&gt;<br>
&lt;br&gt;<br>
4.&nbsp;Modify&nbsp;Squid&nbsp;to&nbsp;retry&nbsp;port&nbsp;binding&nbsp;errors.&nbsp;This&nbsp;is&nbsp;easy&nbsp;to&nbsp;do&nbsp;but&nbsp;&lt;br&gt;<br>
(without&nbsp;#5&nbsp;below)&nbsp;it&nbsp;will&nbsp;not&nbsp;help&nbsp;much&nbsp;once&nbsp;ephemeral&nbsp;ports&nbsp;become&nbsp;&lt;br&gt;<br>
scarce&nbsp;(in&nbsp;my&nbsp;experience;&nbsp;I&nbsp;have&nbsp;not&nbsp;checked&nbsp;what&nbsp;the&nbsp;latest&nbsp;kernels&nbsp;are&nbsp;&lt;br&gt;<br>
capable&nbsp;of&nbsp;in&nbsp;this&nbsp;area).&lt;br&gt;<br>
&lt;br&gt;<br>
5.&nbsp;If&nbsp;you&nbsp;need,&nbsp;say,&nbsp;20-30%&nbsp;more&nbsp;concurrency&nbsp;(rather&nbsp;than&nbsp;100+%)&nbsp;and&nbsp;&lt;br&gt;<br>
cannot&nbsp;use&nbsp;multiple&nbsp;outbound&nbsp;IP&nbsp;addresses,&nbsp;then&nbsp;would&nbsp;be&nbsp;possible&nbsp;to&nbsp;&lt;br&gt;<br>
modify&nbsp;Squid&nbsp;to&nbsp;implement&nbsp;a&nbsp;manual&nbsp;port&nbsp;allocation&nbsp;algorithm&nbsp;that&nbsp;&lt;br&gt;<br>
usually&nbsp;works&nbsp;a&nbsp;lot&nbsp;more&nbsp;reliable&nbsp;under&nbsp;load&nbsp;than&nbsp;ephemeral&nbsp;ports&nbsp;&lt;br&gt;<br>
administered&nbsp;by&nbsp;the&nbsp;OS&nbsp;(last&nbsp;time&nbsp;I&nbsp;checked,&nbsp;which&nbsp;was&nbsp;a&nbsp;few&nbsp;years&nbsp;ago).&nbsp;&lt;br&gt;<br>
You&nbsp;will&nbsp;still&nbsp;be&nbsp;bound&nbsp;by&nbsp;the&nbsp;TCP&nbsp;limit&nbsp;of&nbsp;64K&nbsp;ports&nbsp;(minus&nbsp;whatever&nbsp;&lt;br&gt;<br>
you&nbsp;want&nbsp;to&nbsp;leave&nbsp;for&nbsp;other&nbsp;applications&nbsp;that&nbsp;open&nbsp;outgoing&nbsp;connections)&nbsp;&lt;br&gt;<br>
and&nbsp;various&nbsp;TCP-level&nbsp;timeouts,&nbsp;of&nbsp;course,&nbsp;but&nbsp;the&nbsp;number&nbsp;of&nbsp;cases&nbsp;where&nbsp;&lt;br&gt;<br>
Squid&nbsp;cannot&nbsp;open&nbsp;a&nbsp;port&nbsp;because&nbsp;of&nbsp;OS&nbsp;port&nbsp;mismanagement&nbsp;will&nbsp;go&nbsp;down.&lt;br&gt;<br>
&lt;br&gt;<br>
FWIW,&nbsp;we&nbsp;successfully&nbsp;use&nbsp;solutions&nbsp;3,&nbsp;4,&nbsp;and&nbsp;5&nbsp;in&nbsp;Web&nbsp;Polygraph&nbsp;&lt;br&gt;<br>
benchmark&nbsp;(that&nbsp;can&nbsp;be&nbsp;configured&nbsp;to&nbsp;create&nbsp;lots&nbsp;of&nbsp;outgoing&nbsp;connections).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;squid&nbsp;v5.5&nbsp;on&nbsp;Ubuntu&nbsp;with&nbsp;about&nbsp;48K&nbsp;ephemeral&nbsp;ports&nbsp;available&nbsp;&lt;br&gt;<br>
&gt;&nbsp;with&nbsp;the&nbsp;ip_local_port_range.&nbsp;The&nbsp;squid&nbsp;is&nbsp;bound&nbsp;to&nbsp;listen&nbsp;on&nbsp;port&nbsp;3128&nbsp;&lt;br&gt;<br>
&gt;&nbsp;and&nbsp;has&nbsp;a&nbsp;single&nbsp;tcp_outgoing_address&nbsp;configured.&nbsp;We&nbsp;notice&nbsp;that&nbsp;after&nbsp;&lt;br&gt;<br>
&gt;&nbsp;about&nbsp;40-45k&nbsp;concurrent&nbsp;connections&nbsp;through&nbsp;the&nbsp;proxy&nbsp;it is&nbsp;unable&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;reuse&nbsp;ports&nbsp;and&nbsp;it&nbsp;severely&nbsp;limits&nbsp;local&nbsp;ports&nbsp;available&nbsp;to&nbsp;other&nbsp;&lt;br&gt;<br>
&gt;&nbsp;applications&nbsp;running&nbsp;on&nbsp;the&nbsp;system.&nbsp;The&nbsp;squid&nbsp;is&nbsp;setup&nbsp;to&nbsp;run&nbsp;30&nbsp;&lt;br&gt;<br>
&gt;&nbsp;workers;&nbsp;total&nbsp;CPU&nbsp;is&nbsp;still&nbsp;under&nbsp;10%&nbsp;during&nbsp;peak&nbsp;connection&nbsp;rates.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Is&nbsp;any&nbsp;build&nbsp;config&nbsp;flag&nbsp;required&nbsp;to&nbsp;enable&nbsp;SO_REUSEPORT&nbsp;or&nbsp;SO_REUSEADDR&nbsp;&lt;br&gt;<br>
&gt;&nbsp;on&nbsp;the&nbsp;outbound&nbsp;TCP&nbsp;sessions&nbsp;opened&nbsp;by&nbsp;squid?&lt;br&gt;<br>
&lt;br&gt;<br>
Squid&nbsp;can&nbsp;be&nbsp;configured&nbsp;to&nbsp;use&nbsp;SO_REUSEPORT&nbsp;on&nbsp;_incoming_&nbsp;connections&nbsp;&lt;br&gt;<br>
(see&nbsp;*_port&nbsp;worker-queues),&nbsp;but&nbsp;that&nbsp;is&nbsp;not&nbsp;what&nbsp;you&nbsp;are&nbsp;asking&nbsp;about.&nbsp;&lt;br&gt;<br>
Outside&nbsp;of&nbsp;that&nbsp;worker-queues&nbsp;feature,&nbsp;Squid&nbsp;will&nbsp;not&nbsp;set&nbsp;SO_REUSEPORT&nbsp;&lt;br&gt;<br>
AFAICT.&lt;br&gt;<br>
&lt;br&gt;<br>
Squid&nbsp;does&nbsp;set&nbsp;SO_REUSEADDR&nbsp;unless&nbsp;you&nbsp;use&nbsp;the&nbsp;-R&nbsp;command&nbsp;line&nbsp;option&nbsp;&lt;br&gt;<br>
AFAICT.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;does&nbsp;not&nbsp;appear&nbsp;that&nbsp;there&nbsp;is&nbsp;an&nbsp;option&nbsp;to&nbsp;use&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;flag&nbsp;which&nbsp;can&nbsp;help&nbsp;with&nbsp;ephemeral&nbsp;port&nbsp;&lt;br&gt;<br>
&gt;&nbsp;reuse.&lt;br&gt;<br>
&lt;br&gt;<br>
No.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;We&nbsp;have&nbsp;tried&nbsp;enabling&nbsp;tcp_tw_reuse,&nbsp;ip_autobind_reuse&nbsp;and&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ip_nonlocal_bind&nbsp;flags,&nbsp;but&nbsp;unable&nbsp;to&nbsp;get&nbsp;the&nbsp;system&nbsp;reuse&nbsp;the&nbsp;ephemeral&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ports.&nbsp;The&nbsp;fs.file-max&nbsp;is&nbsp;set&nbsp;to&nbsp;4M.&nbsp;Pasted&nbsp;some&nbsp;errors&nbsp;below.&nbsp;Any&nbsp;&lt;br&gt;<br>
&gt;&nbsp;suggestions&nbsp;are&nbsp;appreciated!&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;2022/05/19&nbsp;23:35:00&nbsp;kid12|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;3075&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;/IP/&gt;:&nbsp;(99)&nbsp;Cannot&nbsp;assign&nbsp;requested&nbsp;address&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;current&nbsp;master&nbsp;transaction:&nbsp;master48536607&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2022/05/19&nbsp;23:35:00&nbsp;kid23|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;1320&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;/IP/&gt;:&nbsp;(99)&nbsp;Cannot&nbsp;assign&nbsp;requested&nbsp;address&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;current&nbsp;master&nbsp;transaction:&nbsp;master26662366&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2022/05/19&nbsp;23:37:30&nbsp;kid13|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;3346&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;/IP/&gt;:&nbsp;(98)&nbsp;Address&nbsp;already&nbsp;in&nbsp;use&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;current&nbsp;master&nbsp;transaction:&nbsp;master11976056&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;2022/05/19&nbsp;23:37:30&nbsp;kid12|&nbsp;commBind&nbsp;Cannot&nbsp;bind&nbsp;socket&nbsp;FD&nbsp;6459&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;/IP/&gt;:&nbsp;(98)&nbsp;Address&nbsp;already&nbsp;in&nbsp;use&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;current&nbsp;master&nbsp;transaction:&nbsp;master48561031&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;While&nbsp;the&nbsp;system&nbsp;is&nbsp;in&nbsp;this&nbsp;state,&nbsp;local&nbsp;curl’s&nbsp;to&nbsp;another&nbsp;endpoint&nbsp;on&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;same&nbsp;node&nbsp;are&nbsp;not&nbsp;able&nbsp;to&nbsp;obtain&nbsp;a&nbsp;TCP&nbsp;socket.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;curl:&nbsp;(7)&nbsp;Couldn&#39;t&nbsp;connect&nbsp;to&nbsp;server&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
