<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;patched&nbsp;in&nbsp;a&nbsp;small&nbsp;code&nbsp;diff&nbsp;to&nbsp;add&nbsp;the IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;flag&nbsp;and&nbsp;it&nbsp;has&nbsp;been&nbsp;working fine&nbsp;as&nbsp;we&nbsp;can&nbsp;see&nbsp;outbound&nbsp;TCP&nbsp;ports&nbsp;being&nbsp;reused&nbsp;with&nbsp;different&nbsp;destination&nbsp;IP&nbsp;addresses.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Have&nbsp;some&nbsp;followup questions.&lt;/div&gt;&lt;div&gt;A&nbsp;lot&nbsp;of&nbsp;the&nbsp;client&nbsp;requests&nbsp;in&nbsp;our&nbsp;setup&nbsp;go&nbsp;to&nbsp;a&nbsp;small&nbsp;set&nbsp;of&nbsp;destination&nbsp;webservers (&nbsp;&lt;&nbsp;10),&nbsp;so&nbsp;we&nbsp;still&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;running&nbsp;out&nbsp;of&nbsp;ports&nbsp;for&nbsp;concurrent&nbsp;connections&nbsp;to&nbsp;a&nbsp;single&nbsp;destination&nbsp;webserver.&nbsp;We&nbsp;have&nbsp;not&nbsp;enabled&nbsp;the&nbsp;squid&nbsp;for&nbsp;caching&nbsp;and&nbsp;run&nbsp;multiple&nbsp;instances&nbsp;each&nbsp;with&nbsp;30&nbsp;workers. &lt;/div&gt;&lt;div&gt;-&nbsp;Is&nbsp;there&nbsp;some&nbsp;config&nbsp;knob&nbsp;available&nbsp;to&nbsp;have&nbsp;squid&nbsp;efficiently&nbsp;reuse&nbsp;outbound connections&nbsp;across&nbsp;multiple&nbsp;client&nbsp;requests?&nbsp;It&nbsp;appears&nbsp;that&nbsp;each&nbsp;client&#39;s&nbsp;request&nbsp;creates&nbsp;a&nbsp;separate&nbsp;TCP&nbsp;connection&nbsp;to&nbsp;the&nbsp;dest&nbsp;webserver&nbsp;even&nbsp;if&nbsp;they&nbsp;are&nbsp;the&nbsp;same.&nbsp;This&nbsp;happens&nbsp;for&nbsp;both&nbsp;HTTP&nbsp;and&nbsp;HTTPS.&nbsp;How&nbsp;do&nbsp;we&nbsp;enable&nbsp;connection&nbsp;pooling&nbsp;if&nbsp;that&nbsp;is&nbsp;available&nbsp;with&nbsp;squid?&lt;/div&gt;&lt;div&gt;-&nbsp;If&nbsp;this&nbsp;is&nbsp;something&nbsp;that&nbsp;isn&#39;t&nbsp;supported&nbsp;with&nbsp;v5.5,&nbsp;do&nbsp;you&nbsp;recommend investigating&nbsp;code&nbsp;modifications to&nbsp;allow&nbsp;the&nbsp;reuse&nbsp;of&nbsp;outbound&nbsp;connections?&nbsp;Any&nbsp;suggestions&nbsp;or&nbsp;gotchas&nbsp;before&nbsp;we&nbsp;go&nbsp;about&nbsp;this&nbsp;approach?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;looked&nbsp;into&nbsp;the&nbsp;multiple&nbsp;tcp_oubound_adress&nbsp;option&nbsp;but&nbsp;would&nbsp;prefer&nbsp;not&nbsp;to&nbsp;go&nbsp;that&nbsp;route.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;div&gt;Praveen&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Fri,&nbsp;May&nbsp;20,&nbsp;2022&nbsp;at&nbsp;9:31&nbsp;PM&nbsp;Amos&nbsp;Jeffries&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:squid3@treenet.co.nz&quot;&gt;squid3@treenet.co.nz&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;20/05/22&nbsp;19:44,&nbsp;Praveen&nbsp;Ponakanti&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&nbsp;Alex,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Thanks&nbsp;for&nbsp;going&nbsp;through&nbsp;several&nbsp;steps&nbsp;to&nbsp;help&nbsp;mitigate&nbsp;src&nbsp;port&nbsp;&lt;br&gt;<br>
&gt;&nbsp;exhaustion.&nbsp;We&nbsp;are&nbsp;looking&nbsp;to&nbsp;achieve&nbsp;400-500%&nbsp;more&nbsp;&lt;br&gt;<br>
&gt;&nbsp;concurrent connections&nbsp;if&nbsp;we&nbsp;could&nbsp;:)&nbsp;as&nbsp;there&nbsp;is&nbsp;a&nbsp;significant buffer&nbsp;&lt;br&gt;<br>
&gt;&nbsp;on&nbsp;the&nbsp;available&nbsp;CPU.&lt;br&gt;<br>
&lt;br&gt;<br>
Then&nbsp;you&nbsp;require&nbsp;at&nbsp;least&nbsp;4,&nbsp;maybe&nbsp;5,&nbsp;IP&nbsp;addresses&nbsp;to&nbsp;handle&nbsp;that&nbsp;many&nbsp;&lt;br&gt;<br>
concurrent&nbsp;connections&nbsp;with&nbsp;Squid.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;The&nbsp;option&nbsp;to&nbsp;use&nbsp;multiple&nbsp;tcp_outoing_addresses&nbsp;appears&nbsp;to&nbsp;be&nbsp;promising&nbsp;&lt;br&gt;<br>
&gt;&nbsp;along&nbsp;with&nbsp;some&nbsp;tweaks&nbsp;to&nbsp;the&nbsp;TCP&nbsp;timeouts.&nbsp;I&nbsp;guess&nbsp;we&nbsp;could&nbsp;use&nbsp;ACLs&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;pick&nbsp;a&nbsp;different&nbsp;outbound&nbsp;IP&nbsp;based&nbsp;on&nbsp;the&nbsp;requesting&nbsp;client&#39;s&nbsp;prefix.&nbsp;We&nbsp;&lt;br&gt;<br>
&gt;&nbsp;had&nbsp;not&nbsp;considered&nbsp;that&nbsp;option&nbsp;as&nbsp;the&nbsp;ephemeral&nbsp;ports&nbsp;were&nbsp;no&nbsp;longer&nbsp;&lt;br&gt;<br>
&gt;&nbsp;available to&nbsp;other&nbsp;applications&nbsp;when&nbsp;squid&nbsp;uses&nbsp;most&nbsp;of&nbsp;them&nbsp;with&nbsp;a&nbsp;&lt;br&gt;<br>
&gt;&nbsp;single&nbsp;outbound&nbsp;IP&nbsp;configured.&nbsp;We&nbsp;are&nbsp;also&nbsp;looking&nbsp;to&nbsp;modify&nbsp;the&nbsp;code&nbsp;to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;use&nbsp;the&nbsp;IP_BIND_ADDRESS_NO_PORT&nbsp;sockopt&nbsp;as&nbsp;that&nbsp;could&nbsp;help&nbsp;delay&nbsp;port&nbsp;&lt;br&gt;<br>
&gt;&nbsp;assignment&nbsp;with&nbsp;the&nbsp;bind()&nbsp;call&nbsp;on&nbsp;the&nbsp;outbound&nbsp;TCP&nbsp;sessions&nbsp;(to&nbsp;&lt;br&gt;<br>
&gt;&nbsp;hopefully&nbsp;allow&nbsp;access&nbsp;to&nbsp;the&nbsp;4-tuple&nbsp;on&nbsp;the&nbsp;socket).&lt;br&gt;<br>
&lt;br&gt;<br>
Patches&nbsp;welcome.&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;please&nbsp;be&nbsp;aware&nbsp;that&nbsp;use&nbsp;of&nbsp;the&nbsp;4-tuple&nbsp;is&nbsp;often&nbsp;no&nbsp;different&nbsp;&lt;br&gt;<br>
from&nbsp;the&nbsp;3-tuple&nbsp;since&nbsp;the&nbsp;dst-port&nbsp;is&nbsp;typically&nbsp;identical&nbsp;for&nbsp;all&nbsp;&lt;br&gt;<br>
outgoing&nbsp;traffic&nbsp;to&nbsp;a&nbsp;given&nbsp;dst-IP.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers&lt;br&gt;<br>
Amos&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
