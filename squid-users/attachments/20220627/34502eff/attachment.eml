[From nobody Thu Jan  9 08:31:07 2025
X-Envelope-From: &lt;bruno.larini@riosoft.com.br&gt;
X-Envelope-To: &lt;squid-users@lists.squid-cache.org&gt;
Received: from mail.riosoft.com.br (unknown)
 by lists.squid-cache.org (Postfix 3.4.13/8.13.0) with SMTP id unknown
 Mon, 27 Jun 2022 22:01:38 +0000
 (envelope-from &lt;bruno.larini@riosoft.com.br&gt;);
Authentication-Results: lists.squid-cache.org; dkim=pass (1024-bit key;
 unprotected) header.d=riosoft.com.br header.i=@riosoft.com.br
 header.a=rsa-sha256 header.s=default header.b=mrezFjrz; 
 dkim-atps=neutral
dkim-signature: v=1; c=relaxed;
 h=to:from:subject:date:message-id:mime-version:content-type; 
 d=riosoft.com.br; s=default; a=rsa-sha256;
 bh=Es++gENVQRhyXszIrQLZukf/BnhHF4qYDkILfx890BQ=;
 b=mrezFjrzD3FOmFCVsHeOTnJJMwSYZUt4foxUaNTXeGZbjL427aq75I2b+ippYVorE
 cnWckR1cdXcJYJyXUaQ5OyCcYTzC1Xh8IyZxsaLNI3Q2irHAdpNleeeM8sRTzPLBEzu
 eFp0Ief49aLpxwwPRGmyxbr6WdzyOW7UWo/XpRE=;
Received: from ([171.171.0.1]) by riosoft.com.br with MailEnable WebMail;
 Mon, 27 Jun 2022 19:01:25 -0300
To: &lt;squid-users@lists.squid-cache.org&gt;
From: &lt;bruno.larini@riosoft.com.br&gt;
Subject: Squid also checking for IP on ACL
Date: Mon, 27 Jun 2022 19:01:25 -0300
Message-ID: &lt;81A0AB184EDF469FBCEE36ECE596E6C5.MAI@riosoft.com.br&gt;
MIME-Version: 1.0
X-MimeOLE: Produced By MailEnable WebMail.NET V2.0.0.0
X-Mailer: MailEnable WebMail.NET
Content-Type: multipart/alternative;
 boundary=&quot;__=_AltPart_487443364_1540656760&quot;

This is a multi-part message in MIME format.

--__=_AltPart_487443364_1540656760
Content-Type: text/plain;
	charset=&quot;UTF-8&quot;
Content-Transfer-Encoding: quoted-printable

Hi list. 
 
I have a pretty simple configuration for website filtering (intercepted) and =
ssl_bump, which follows below. 
However, for some reason, it seems Squid resolves the website domain address,=
 then uses the IP to compare with the ACLs. 
As the IP is not included in the ACL, the access to the website is denied. 
Before that, it already checked for the domain name. I can tell based on the =
error from the browser. 
I'm using Squid version 5.5. 
 
For example, while trying to open https://repo.maven.apache.org/ (included in=
 the allowed sites), the browser shows the error: 
 
    The following error was encountered while trying to retrieve the URL: htt=
ps://199.232.192.215/* 
 
    Access Denied. 
 
If I replace 'deny all' with 'allow all', the website will open as expected. 
Is there something wrong with my config=3F I have something similar running a=
nd working on version 4.4 (unless I'm missing something). 
I'm still only splicing for now. 
 
Thanks for the help! 
 
 
### SQUID.CONF 
... 
# 
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS 
# 
 
acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot; 
http_access allow allowed_sites 
 
acl step1 at_step SslBump1 
ssl_bump peek step1 
ssl_bump splice all 
 
tls_outgoing_options capath=3D/etc/pki/tls/certs options=3DALL 
 
sslcrtd_program /usr/lib64/squid/security_file_certgen -s /var/lib/squid/ssl_=
db -M 8MB 
sslcrtd_children 3 
 
http_access allow localhost 
 
# And finally deny all other access to this proxy 
http_access deny all 
 
# Squid normally listens to port 3128 
http_port 192.168.10.10:8080 
http_port 192.168.10.10:3128 intercept 
https_port 192.168.10.10:3129 tls-cert=3D/etc/squid/ssl/squidCA.pem tls-key=
=3D/etc/squid/ssl/squidCA.key ssl-bump intercept generate-host-certificates=
=3Don dynamic_cert_mem_cache_size=3D8MB 
... 
 
### IPTABLES 
... 
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 80 -j=
 REDIRECT --to-port 3128 
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 443 -=
j REDIRECT --to-port 3129 
...

--__=_AltPart_487443364_1540656760
Content-Type: text/html;
	charset=&quot;UTF-8&quot;
Content-Transfer-Encoding: quoted-printable

Hi list. &lt;br&gt; &lt;br&gt;I have a pretty simple configuration for website filtering =
(intercepted) and ssl_bump, which follows below. &lt;br&gt;However, for some reason=
, it seems Squid resolves the website domain address, then uses the IP to com=
pare with the ACLs. &lt;br&gt;As the IP is not included in the ACL, the access to t=
he website is denied. &lt;br&gt;Before that, it already checked for the domain name=
. I can tell based on the error from the browser. &lt;br&gt;I'm using Squid version=
 5.5. &lt;br&gt; &lt;br&gt;For example, while trying to open &lt;a class=3D&quot;moz-txt-link-fre=
etext&quot; href=3D&quot;https://repo.maven.apache.org/&quot; target=3D'_blank'&gt;https://repo=
.maven.apache.org/&lt;/a&gt; (included in the allowed sites), the browser shows the=
 error: &lt;br&gt; &lt;br&gt;&nbsp;&nbsp;&nbsp; The following error was encountered while=
 trying to retrieve the URL: &lt;a class=3D&quot;moz-txt-link-freetext&quot; href=3D&quot;https=
://199.232.192.215/*&quot; target=3D'_blank'&gt;https://199.232.192.215/*&lt;/a&gt; &lt;br&gt; &lt;b=
r&gt;&nbsp;&nbsp;&nbsp; Access Denied. &lt;br&gt; &lt;br&gt;If I replace 'deny all' with 'al=
low all', the website will open as expected. &lt;br&gt;Is there something wrong wit=
h my config=3F I have something similar running and working on version 4.4 (u=
nless I'm missing something). &lt;br&gt;I'm still only splicing for now. &lt;br&gt; &lt;br&gt;T=
hanks for the help! &lt;br&gt; &lt;br&gt; &lt;br&gt;### SQUID.CONF &lt;br&gt;... &lt;br&gt;# &lt;br&gt;# INSERT Y=
OUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS &lt;br&gt;# &lt;br&gt; &lt;br&gt;acl all=
owed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot; &lt;br&gt;http_access allow all=
owed_sites &lt;br&gt; &lt;br&gt;acl step1 at_step SslBump1 &lt;br&gt;ssl_bump peek step1 &lt;br&gt;ss=
l_bump splice all &lt;br&gt; &lt;br&gt;tls_outgoing_options capath=3D/etc/pki/tls/certs o=
ptions=3DALL &lt;br&gt; &lt;br&gt;sslcrtd_program /usr/lib64/squid/security_file_certgen =
-s /var/lib/squid/ssl_db -M 8MB &lt;br&gt;sslcrtd_children 3 &lt;br&gt; &lt;br&gt;http_access a=
llow localhost &lt;br&gt; &lt;br&gt;# And finally deny all other access to this proxy &lt;br=
&gt;http_access deny all &lt;br&gt; &lt;br&gt;# Squid normally listens to port 3128 &lt;br&gt;http=
_port 192.168.10.10:8080 &lt;br&gt;http_port 192.168.10.10:3128 intercept &lt;br&gt;https=
_port 192.168.10.10:3129 tls-cert=3D/etc/squid/ssl/squidCA.pem tls-key=3D/etc=
/squid/ssl/squidCA.key ssl-bump intercept generate-host-certificates=3Don dyn=
amic_cert_mem_cache_size=3D8MB &lt;br&gt;... &lt;br&gt; &lt;br&gt;### IPTABLES &lt;br&gt;... &lt;br&gt;ipta=
bles -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 80 -j RED=
IRECT --to-port 3128 &lt;br&gt;iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.=
0/24 -p tcp --dport 443 -j REDIRECT --to-port 3129 &lt;br&gt;...




--__=_AltPart_487443364_1540656760--
]