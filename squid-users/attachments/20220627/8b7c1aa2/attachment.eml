[From nobody Thu Jan  9 08:31:07 2025
X-Envelope-From: &lt;bruno.larini@riosoft.com.br&gt;
X-Envelope-To: &lt;squid-users@lists.squid-cache.org&gt;
Received: from mail.riosoft.com.br (unknown)
 by lists.squid-cache.org (Postfix 3.4.13/8.13.0) with SMTP id unknown
 Mon, 27 Jun 2022 21:53:14 +0000
 (envelope-from &lt;bruno.larini@riosoft.com.br&gt;);
Authentication-Results: lists.squid-cache.org; dkim=pass (1024-bit key;
 unprotected) header.d=riosoft.com.br header.i=@riosoft.com.br
 header.a=rsa-sha256 header.s=default header.b=LfbyIyB7; 
 dkim-atps=neutral
dkim-signature: v=1; c=relaxed;
 h=message-id:date:mime-version:to:from:subject:content-type:content-transfer-encoding;
 d=riosoft.com.br; s=default; a=rsa-sha256;
 bh=eWPJFdoV/S4t34cKScy8r0FXg0eCYO8kvRa76aLeDNM=;
 b=LfbyIyB7T3ZKSKQOahfbO6SOMvBnD4fZp3mK/AR3zVz7bcmabgYuKvbP5cmrH8xRX
 9Vn4WGdfY6GEK2QZMX3p8fM/+kNf/zE5/iKog9GyNK2B+nLQXKrs7KeYG7+SqRViV6E
 olhYq13zu5kWYUM6ASTV8pNQhuXBxsataR32f2s=;
Received: from [171.171.0.181] ([171.171.0.181]) by riosoft.com.br with
 MailEnable ESMTPSA (version=TLS1_2
 cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA_P256);
 Mon, 27 Jun 2022 18:53:00 -0300
Message-ID: &lt;beb371f2-b136-d203-dfc6-4d0988eb6deb@riosoft.com.br&gt;
Date: Mon, 27 Jun 2022 18:53:00 -0300
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101
 Thunderbird/91.10.0
Content-Language: pt-BR
To: &quot;squid-users@lists.squid-cache.org&quot; &lt;squid-users@lists.squid-cache.org&gt;
From: Bruno de Paula Larini &lt;bruno.larini@riosoft.com.br&gt;
Subject: Squid also checking for IP on ACL
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit

Hi list.

I have a pretty simple configuration for website filtering (intercepted) 
and ssl_bump, which follows below.
However, for some reason, it seems Squid resolves the website domain 
address, then uses the IP to compare with the ACLs.
As the IP is not included in the ACL, the access to the website is denied.
Before that, it already checked for the domain name. I can tell based on 
the error from the browser.
I'm using Squid version 5.5.

For example, while trying to open https://repo.maven.apache.org/ 
(included in the allowed sites), the browser shows the error:

     The following error was encountered while trying to retrieve the 
URL: https://199.232.192.215/*

     Access Denied.

If I replace 'deny all' with 'allow all', the website will open as expected.
Is there something wrong with my config? I have something similar 
running and working on version 4.4 (unless I'm missing something).
I'm still only splicing for now.

Thanks for the help!


### SQUID.CONF
...
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot;
http_access allow allowed_sites

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump splice all

tls_outgoing_options capath=/etc/pki/tls/certs options=ALL

sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
/var/lib/squid/ssl_db -M 8MB
sslcrtd_children 3

http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 192.168.10.10:8080
http_port 192.168.10.10:3128 intercept
https_port 192.168.10.10:3129 tls-cert=/etc/squid/ssl/squidCA.pem 
tls-key=/etc/squid/ssl/squidCA.key ssl-bump intercept 
generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
...

### IPTABLES
...
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
80 -j REDIRECT --to-port 3128
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
443 -j REDIRECT --to-port 3129
...
]