[From nobody Thu Jan  9 08:31:07 2025
X-Envelope-From: &lt;bruno.larini@riosoft.com.br&gt;
X-Envelope-To: &lt;squid-users@lists.squid-cache.org&gt;
Received: from mail.riosoft.com.br (unknown)
 by lists.squid-cache.org (Postfix 3.4.13/8.13.0) with SMTP id unknown
 Tue, 28 Jun 2022 18:32:34 +0000
 (envelope-from &lt;bruno.larini@riosoft.com.br&gt;);
Authentication-Results: lists.squid-cache.org; dkim=pass (1024-bit key;
 unprotected) header.d=riosoft.com.br header.i=@riosoft.com.br
 header.a=rsa-sha256 header.s=default header.b=Li0RPq8k; 
 dkim-atps=neutral
dkim-signature: v=1; c=relaxed;
 h=message-id:date:mime-version:subject:to:references:from:in-reply-to:content-type:content-transfer-encoding;
 d=riosoft.com.br; s=default; a=rsa-sha256;
 bh=jJV9ytV45NVMquOog0joKKLkfToPbwpkf5jTm33O0xM=;
 b=Li0RPq8kAbFlS3M3zf72+4PFJdlTUeTS5O+vpK/TAhph/y7j4xkKH757Rvfv+qFD3
 yHQXHyT0SCwJ811tTswFLv/ZEwew1Q3uIPnflTD0cVYSM3+CWu/1b6vOf5B4wB5H+wg
 5Y/fs08cHjLL6l3rq3vrT6bQrISlYmTvcIZ0ga8=;
Received: from [171.171.0.181] ([171.171.0.181]) by riosoft.com.br with
 MailEnable ESMTPSA (version=TLS1_2
 cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA_P256);
 Tue, 28 Jun 2022 15:32:29 -0300
Message-ID: &lt;3bf3765b-7bed-a230-21da-a2cda97ca164@riosoft.com.br&gt;
Date: Tue, 28 Jun 2022 15:32:29 -0300
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101
 Thunderbird/91.10.0
Subject: Re: [squid-users] Squid checking for both dstdomain and IP
Content-Language: pt-BR
To: squid-users@lists.squid-cache.org
References: &lt;419c10f1-b987-68de-c968-a1507eacfc22@riosoft.com.br&gt;
 &lt;32a5bc9e-2900-9b33-061b-e3880694b30b@measurement-factory.com&gt;
From: Bruno de Paula Larini &lt;bruno.larini@riosoft.com.br&gt;
In-Reply-To: &lt;32a5bc9e-2900-9b33-061b-e3880694b30b@measurement-factory.com&gt;
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 8bit

Thanks for replying.
I was already following the provided link for reference.
It seems that splicing on step2 was correct, but in fact there were 
other things that I missed.

acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot;
# Creates acl containing domain names for splice.
acl spliced_sites ssl::server_name &quot;/etc/squid/allowed-sites.txt&quot;
http_access allow allowed_sites
# This eliminates the browser error containing the IP from the website.
# &gt;&gt; I don't know if there are caveats for allowing free access to 
SSL_ports. &lt;&lt;
http_access allow SSL_ports

acl step1 at_step SslBump1
acl step2 at_step SslBump2

ssl_bump peek step1
ssl_bump splice step2 spliced_sites
# Same effect of 'deny all' for https websites.
ssl_bump terminate all
...

*Apparently* that does it.
If I stated anything wrong, please correct me.

Cheers.


Em 28/06/2022 10:52, Alex Rousskov escreveu:
&gt; On 6/28/22 08:08, Bruno de Paula Larini wrote:
&gt;
&gt;&gt; I have a pretty simple configuration for website filtering 
&gt;&gt; (intercepted) and ssl_bump, which follows below.
&gt;&gt; However, for some reason, it seems Squid resolves the website domain 
&gt;&gt; address, then uses the IP to compare with the ACLs.
&gt;
&gt; Most likely, what is actually happening is that Squid does not have 
&gt; domain information during SslBump step1, and then gets that 
&gt; information during step2. Squid http_access rules apply to each 
&gt; SslBump step, so you have to write them accordingly.
&gt;
&gt; Available to Squid information and expected Squid behavior is 
&gt; documented for each step at the following wiki page. There are bugs in 
&gt; that algorithm _implementation_, but they are being fixed, and I am 
&gt; not aware of better docs: 
&gt; https://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps
&gt;
&gt;
&gt; HTH,
&gt;
&gt; Alex.
&gt;
&gt;
&gt;&gt; As the IP is not included in the ACL, the access to the website is 
&gt;&gt; denied.
&gt;&gt; Before that, it already checked for the domain name. I can tell based 
&gt;&gt; on the error from the browser.
&gt;&gt; I'm using Squid version 5.5.
&gt;&gt;
&gt;&gt; For example, while trying to open https://repo.maven.apache.org/ 
&gt;&gt; (included in the allowed sites), the browser shows the error:
&gt;&gt;
&gt;&gt;      The following error was encountered while trying to retrieve the 
&gt;&gt; URL: https://199.232.192.215/*
&gt;&gt;
&gt;&gt;      Access Denied.
&gt;&gt;
&gt;&gt; If I replace 'deny all' with 'allow all', the website will open as 
&gt;&gt; expected.
&gt;&gt; Is there something wrong with my config? I have something similar 
&gt;&gt; running and working on version 4.4 (unless I'm missing something).
&gt;&gt; I'm still only splicing for now.
&gt;&gt;
&gt;&gt; Thanks for the help!
&gt;&gt;
&gt;&gt;
&gt;&gt; ### SQUID.CONF
&gt;&gt; ...
&gt;&gt; #
&gt;&gt; # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
&gt;&gt; #
&gt;&gt;
&gt;&gt; acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot;
&gt;&gt; http_access allow allowed_sites
&gt;&gt;
&gt;&gt; acl step1 at_step SslBump1
&gt;&gt; ssl_bump peek step1
&gt;&gt; ssl_bump splice all
&gt;&gt;
&gt;&gt; tls_outgoing_options capath=/etc/pki/tls/certs options=ALL
&gt;&gt;
&gt;&gt; sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
&gt;&gt; /var/lib/squid/ssl_db -M 8MB
&gt;&gt; sslcrtd_children 3
&gt;&gt;
&gt;&gt; http_access allow localhost
&gt;&gt;
&gt;&gt; # And finally deny all other access to this proxy
&gt;&gt; http_access deny all
&gt;&gt;
&gt;&gt; # Squid normally listens to port 3128
&gt;&gt; http_port 192.168.10.10:8080
&gt;&gt; http_port 192.168.10.10:3128 intercept
&gt;&gt; https_port 192.168.10.10:3129 tls-cert=/etc/squid/ssl/squidCA.pem 
&gt;&gt; tls-key=/etc/squid/ssl/squidCA.key ssl-bump intercept 
&gt;&gt; generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
&gt;&gt; ...
&gt;&gt;
&gt;&gt; ### IPTABLES
&gt;&gt; ...
&gt;&gt; iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp 
&gt;&gt; --dport 80 -j REDIRECT --to-port 3128
&gt;&gt; iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp 
&gt;&gt; --dport 443 -j REDIRECT --to-port 3129
&gt;&gt; ...
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; squid-users mailing list
&gt;&gt; squid-users@lists.squid-cache.org
&gt;&gt; http://lists.squid-cache.org/listinfo/squid-users
&gt;
&gt; _______________________________________________
&gt; squid-users mailing list
&gt; squid-users@lists.squid-cache.org
&gt; http://lists.squid-cache.org/listinfo/squid-users

]