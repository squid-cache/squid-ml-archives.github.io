<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hey&nbsp;Alex,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;the&nbsp;quick&nbsp;and&nbsp;detailed&nbsp;response!&nbsp;I&nbsp;inherited&nbsp;this&nbsp;service&nbsp;recently&nbsp;-&nbsp;would&nbsp;you&nbsp;recommend&nbsp;upgrading&nbsp;to&nbsp;5?&nbsp;My&nbsp;configs&nbsp;are&nbsp;fairly&nbsp;simple,&nbsp;so&nbsp;upgrade should&nbsp;be&nbsp;easy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s&nbsp;my&nbsp;desired&nbsp;flow&nbsp;-&nbsp;let&nbsp;&quot;reverse&quot;&nbsp;and&nbsp;&quot;parent&quot;&nbsp;represent&nbsp;the&nbsp;IPs&nbsp;of&nbsp;those&nbsp;proxies,&nbsp;and&nbsp;&quot;target&quot;&nbsp;represent&nbsp;the&nbsp;target&nbsp;API&nbsp;hostname.&lt;br&gt;&lt;br&gt;Application&nbsp;sends&nbsp;GET&nbsp;(POST,&nbsp;PUT,&nbsp;etc)&nbsp;&lt;a&nbsp;href=&quot;http://reverse/some/path&quot;&gt;http://reverse/some/path&lt;/a&gt;&lt;br&gt;(Note:&nbsp;Application&nbsp;doesn&#39;t&nbsp;know&nbsp;target,&nbsp;and&nbsp;couldn&#39;t&nbsp;reach&nbsp;it&nbsp;if&nbsp;it&nbsp;did.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;Reverse&nbsp;adds&nbsp;headers&nbsp;to&nbsp;the&nbsp;request&lt;br&gt;Reverse&nbsp;sends&nbsp;the&nbsp;request&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://target/some/path&quot;&gt;https://target/some/path&lt;/a&gt;,&nbsp;using parent&nbsp;as&nbsp;a&nbsp;forward&nbsp;proxy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;parent&nbsp;proxy&nbsp;in&nbsp;my&nbsp;test&nbsp;case&nbsp;accepts&nbsp;TCP,&nbsp;although&nbsp;if&nbsp;possible&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;support&nbsp;parent&nbsp;TLS&nbsp;proxies&nbsp;as&nbsp;well&nbsp;-&nbsp;this&nbsp;reverse&nbsp;proxy&nbsp;is&nbsp;deployed&nbsp;in&nbsp;different&nbsp;environments&nbsp;where&nbsp;the&nbsp;parent&nbsp;proxy&nbsp;may&nbsp;differ.&lt;/div&gt;&lt;div&gt;&lt;br&gt;I&nbsp;set&nbsp;this&nbsp;up&nbsp;outside&nbsp;of&nbsp;a&nbsp;docker&nbsp;and&nbsp;without&nbsp;trying&nbsp;to&nbsp;force&nbsp;ssl.&nbsp;The&nbsp;config&nbsp;below&nbsp;was&nbsp;my&nbsp;first&nbsp;attempt&nbsp;-&nbsp;it&nbsp;works&nbsp;&lt;i&gt;if&lt;/i&gt; the&nbsp;reverse&nbsp;proxy&nbsp;has&nbsp;direct&nbsp;internet&nbsp;access,&nbsp;but&nbsp;just&nbsp;hangs&nbsp;otherwise;&nbsp;my&nbsp;understanding&nbsp;is&nbsp;that&nbsp;requests&nbsp;that&nbsp;use&nbsp;the&nbsp;first cache_peer&nbsp;do&nbsp;not&nbsp;use&nbsp;the&nbsp;second&nbsp;to&nbsp;proxy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Reverse&nbsp;proxy&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;http_port&nbsp;80&nbsp;accel&nbsp;vhost&nbsp;defaultsite=&lt;a&nbsp;href=&quot;http://www.google.com&quot;&gt;www.google.com&lt;/a&gt;&lt;br&gt;cache_peer&nbsp;&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&nbsp;parent&nbsp;80&nbsp;0&nbsp;no-query&nbsp;originserver&nbsp;forceddomain=&lt;a&nbsp;href=&quot;http://www.google.com&quot;&gt;www.google.com&lt;/a&gt;&nbsp;name=target&lt;br&gt;request_header_add&nbsp;Joel&nbsp;Joel&lt;br&gt;&lt;br&gt;#&nbsp;Simplified&nbsp;acl&lt;br&gt;http_access&nbsp;allow&nbsp;all&lt;br&gt;cache_peer_access&nbsp;target&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;#&nbsp;Parent&nbsp;proxy&lt;br&gt;cache_peer&nbsp;10.60.4.178&nbsp;parent&nbsp;3128&nbsp;0&nbsp;no-query&nbsp;default&lt;br&gt;acl&nbsp;all&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0.0.0.0&quot;&gt;0.0.0.0/0.0.0.0&lt;/a&gt;&lt;br&gt;never_direct&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;This&nbsp;was&nbsp;my&nbsp;second&nbsp;attempt,&nbsp;using&nbsp;forceddomain&nbsp;to&nbsp;replace&nbsp;the&nbsp;host&nbsp;header&nbsp;but&nbsp;sending&nbsp;the&nbsp;request&nbsp;directly&nbsp;to&nbsp;the&nbsp;parent&nbsp;proxy.&nbsp;This&nbsp;results&nbsp;in&nbsp;the&nbsp;parent&nbsp;receiving&nbsp;GET&nbsp;/,&nbsp;which&nbsp;it&nbsp;does&nbsp;not&nbsp;understand&nbsp;(it&nbsp;expects&nbsp;GET&nbsp;target/somepath).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Reverse&nbsp;proxy&nbsp;directly&nbsp;to&nbsp;forward&nbsp;proxy&nbsp;&lt;a&nbsp;href=&quot;http://google.com&quot;&gt;google.com&lt;/a&gt;&lt;br&gt;http_port&nbsp;80&nbsp;accel&nbsp;vhost&nbsp;defaultsite=&lt;a&nbsp;href=&quot;http://www.google.com&quot;&gt;www.google.com&lt;/a&gt;&lt;br&gt;cache_peer&nbsp;10.60.4.178&nbsp;parent&nbsp;3128&nbsp;0&nbsp;no-query&nbsp;originserver&nbsp;forceddomain=&lt;a&nbsp;href=&quot;http://www.google.com&quot;&gt;www.google.com&lt;/a&gt;&nbsp;name=parent&lt;br&gt;request_header_add&nbsp;Joel&nbsp;Joel&lt;br&gt;&lt;br&gt;#&nbsp;Misc&lt;br&gt;cache&nbsp;deny&nbsp;all&lt;br&gt;shutdown_lifetime&nbsp;1&nbsp;seconds&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;suspect&nbsp;this&nbsp;would&nbsp;need&nbsp;a&nbsp;url&nbsp;rewriter&nbsp;to&nbsp;force&nbsp;the&nbsp;url&nbsp;to&nbsp;target&nbsp;-&nbsp;I&#39;m&nbsp;failing&nbsp;to&nbsp;get&nbsp;any&nbsp;of&nbsp;the&nbsp;example&nbsp;rewriters&nbsp;working&nbsp;(maybe&nbsp;due&nbsp;to&nbsp;the&nbsp;old&nbsp;squid&nbsp;version?)&nbsp;so&nbsp;I&nbsp;haven&#39;t&nbsp;been&nbsp;able&nbsp;to&nbsp;test&nbsp;that&nbsp;yet.&nbsp;But&nbsp;I&nbsp;suspect&nbsp;it&nbsp;will&nbsp;fail&nbsp;for&nbsp;HTTPS,&nbsp;because&nbsp;the&nbsp;rewritten&nbsp;URL&nbsp;will&nbsp;be&nbsp;sent&nbsp;as&nbsp;GET&nbsp;target/something&nbsp;to&nbsp;the&nbsp;parent&nbsp;proxy,&nbsp;instead&nbsp;of&nbsp;CONNECT&nbsp;target/something&nbsp;-&nbsp;I&nbsp;still&nbsp;think&nbsp;I&#39;m&nbsp;missing&nbsp;something&nbsp;to&nbsp;get&nbsp;my&nbsp;squid&nbsp;to&nbsp;use&nbsp;the&nbsp;forward&nbsp;&lt;i&gt;as&nbsp;a&nbsp;proxy&lt;/i&gt; while&nbsp;itself&nbsp;functioning&nbsp;in&nbsp;reverse.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ll&nbsp;rewrite&nbsp;these&nbsp;for&nbsp;squid&nbsp;5&nbsp;and&nbsp;try&nbsp;to&nbsp;get&nbsp;URL&nbsp;rewriting&nbsp;working.&nbsp;In&nbsp;the&nbsp;meantime,&nbsp;could&nbsp;you&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;either&nbsp;of&nbsp;these&nbsp;two&nbsp;general&nbsp;approaches&nbsp;is&nbsp;remotely&nbsp;correct&nbsp;and&nbsp;if&nbsp;so,&nbsp;what&nbsp;I&nbsp;can&nbsp;do&nbsp;to&nbsp;get&nbsp;further&nbsp;with&nbsp;them?&lt;/div&gt;&lt;div&gt;&lt;br&gt;Thanks&nbsp;so&nbsp;much!&nbsp;If&nbsp;you&nbsp;happen&nbsp;to&nbsp;be&nbsp;on&nbsp;StackOverflow,&nbsp;I&#39;ve&nbsp;asked&nbsp;the&nbsp;question&nbsp;with&nbsp;a&nbsp;bounty&nbsp;&lt;a&nbsp;href=&quot;https://stackoverflow.com/questions/73286678/reverse-proxy-with-http-inbound-https-outbound-and-parent-proxy/73293978?noredirect=1#comment129465312_73293978&quot;&gt;there&lt;/a&gt;&nbsp;as&nbsp;well&nbsp;(although&nbsp;less&nbsp;squid-specific).&lt;/div&gt;&lt;/div&gt;<br>

</tt>
