<tt>
&lt;html&nbsp;xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;<br>
&lt;head&gt;<br>
&lt;title&gt;&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
&lt;div&nbsp;name=&quot;messageBodySection&quot;&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Thank&nbsp;you&nbsp;for&nbsp;the&nbsp;advice,&nbsp;Alex.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;just&nbsp;wanted&nbsp;to&nbsp;update&nbsp;anyone&nbsp;following&nbsp;or&nbsp;who&nbsp;might&nbsp;follow&nbsp;that&nbsp;the&nbsp;problem&nbsp;ended&nbsp;up&nbsp;being&nbsp;in&lt;br&nbsp;/&gt;<br>
my&nbsp;Logstash&nbsp;server,&nbsp;not&nbsp;in&nbsp;Squid,&nbsp;it&nbsp;performed&nbsp;too&nbsp;slow&nbsp;due&nbsp;to&nbsp;a&nbsp;miss&nbsp;configuration,&nbsp;so&nbsp;Squid&nbsp;kept&lt;br&nbsp;/&gt;<br>
sending&nbsp;logs&nbsp;but&nbsp;the&nbsp;slow&nbsp;server&nbsp;got&nbsp;over&nbsp;flooded.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
After&nbsp;fixing&nbsp;the&nbsp;server&nbsp;I&nbsp;simply&nbsp;set&nbsp;these&nbsp;configuration&nbsp;normally:&lt;br&nbsp;/&gt;<br>
access_log&nbsp;tcp://server:port&nbsp;logformat=logs&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;name=&quot;messageSignatureSection&quot;&gt;&lt;br&nbsp;/&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;and&nbsp;everything&nbsp;seems&nbsp;to&nbsp;be&nbsp;working&nbsp;fine&nbsp;by&nbsp;default.&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;I&nbsp;did&nbsp;however&nbsp;notice&nbsp;that&nbsp;UDP&nbsp;does&nbsp;aggregate&nbsp;logs&nbsp;before&nbsp;sending&nbsp;them,&nbsp;and&nbsp;TCP&nbsp;does&nbsp;not,&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;even&nbsp;when&nbsp;set&nbsp;explicitly.&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;If&nbsp;anybody&nbsp;runs&nbsp;into&nbsp;this&nbsp;issue&nbsp;in&nbsp;the&nbsp;future&nbsp;it&nbsp;might&nbsp;be&nbsp;worth&nbsp;to&nbsp;follow&nbsp;Alex&nbsp;advice&nbsp;on&nbsp;how&nbsp;to&nbsp;get&#160;&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;this&nbsp;to&nbsp;work.&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Thanks,&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Roee&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;name=&quot;messageReplySection&quot;&gt;On&nbsp;13&nbsp;Sep&nbsp;2022,&nbsp;6:30&nbsp;+0300,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;rousskov@measurement-factory.com&gt;,&nbsp;wrote:&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;style=&quot;border-left-color:&nbsp;grey;&nbsp;border-left-width:&nbsp;thin;&nbsp;border-left-style:&nbsp;solid;&nbsp;margin:&nbsp;5px&nbsp;5px;padding-left:&nbsp;10px;&quot;&gt;On&nbsp;9/12/22&nbsp;18:20,&nbsp;roee&nbsp;klinger&nbsp;wrote:&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;advice,&nbsp;as&nbsp;suggested&nbsp;I&nbsp;tested&nbsp;a&nbsp;both&nbsp;TCP&nbsp;and&nbsp;UDP,&nbsp;and&lt;br&nbsp;/&gt;<br>
found&nbsp;TCP&nbsp;to&nbsp;be&nbsp;so&nbsp;slow&lt;br&nbsp;/&gt;<br>
that&nbsp;is&nbsp;it&nbsp;practically&nbsp;unusable,&nbsp;UDP&nbsp;however&nbsp;works&nbsp;fine,&nbsp;but&nbsp;has&nbsp;the&lt;br&nbsp;/&gt;<br>
normal&nbsp;disadvantages&nbsp;of&nbsp;UDP.&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;<br>
Glad&nbsp;that&nbsp;test&nbsp;yielded&nbsp;useful&nbsp;results&nbsp;in&nbsp;your&nbsp;environment!&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;It&nbsp;seems&nbsp;that&nbsp;TCP&nbsp;sends&nbsp;each&nbsp;message&nbsp;by&nbsp;itself,&nbsp;and&nbsp;UDP&nbsp;sends&nbsp;them&nbsp;in&lt;br&nbsp;/&gt;<br>
bulk&nbsp;(10-20&nbsp;at&nbsp;a&nbsp;time),&lt;br&nbsp;/&gt;<br>
which&nbsp;seems&nbsp;to&nbsp;be&nbsp;a&nbsp;big&nbsp;part&nbsp;of&nbsp;the&nbsp;performance&nbsp;difference,&nbsp;in&nbsp;fact&nbsp;TCP&lt;br&nbsp;/&gt;<br>
is&nbsp;so&nbsp;slow&nbsp;that&nbsp;it&nbsp;causes&nbsp;Squid&nbsp;to&nbsp;crash&nbsp;after&nbsp;a&nbsp;while.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
After&nbsp;carefully&nbsp;reading&nbsp;the&nbsp;logs,&nbsp;I&nbsp;tried&nbsp;to&nbsp;get&nbsp;TCP&nbsp;to&nbsp;send&nbsp;in&nbsp;bulk&nbsp;as&lt;br&nbsp;/&gt;<br>
well&nbsp;by&nbsp;configuring:&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
logformat&nbsp;logstash&nbsp;%ts.%03tu&nbsp;%6tr&nbsp;%&gt;a&nbsp;%&lt;la&nbsp;%&gt;lp&nbsp;%Ss/%03&gt;Hs&nbsp;%&lt;st&nbsp;%rm&lt;br&nbsp;/&gt;<br>
%ru&nbsp;%[un&nbsp;%Sh/%&lt;a&nbsp;%mt&nbsp;%{Client-Tags}&gt;h&lt;br&nbsp;/&gt;<br>
access_log&nbsp;tcp://127.0.0.1:5400&nbsp;logformat=logstash&nbsp;buffer-size=64KB&lt;br&nbsp;/&gt;<br>
buffered_logs&nbsp;on&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
But&nbsp;it&nbsp;seems&nbsp;to&nbsp;still&nbsp;be&nbsp;sending&nbsp;the&nbsp;logs&nbsp;line&nbsp;by&nbsp;line,&nbsp;am&nbsp;I&nbsp;missing&lt;br&nbsp;/&gt;<br>
something?&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;have&nbsp;not&nbsp;tested&nbsp;this,&nbsp;but&nbsp;if&nbsp;my&nbsp;interpretation&nbsp;of&nbsp;the&nbsp;underlying&nbsp;code&lt;br&nbsp;/&gt;<br>
is&nbsp;correct,&nbsp;then&nbsp;the&nbsp;TCP&nbsp;logging&nbsp;module&nbsp;code&nbsp;does&nbsp;not&nbsp;flush&nbsp;the&nbsp;buffer&lt;br&nbsp;/&gt;<br>
when&nbsp;it&nbsp;accumulates&nbsp;(close&nbsp;to)&nbsp;buffer-size&nbsp;bytes.&nbsp;Instead,&nbsp;the&nbsp;module&lt;br&nbsp;/&gt;<br>
starts&nbsp;writing&nbsp;its&nbsp;buffer&nbsp;after&nbsp;accumulating&nbsp;more&nbsp;than&nbsp;16KB&nbsp;(2*MAX_URL).&lt;br&nbsp;/&gt;<br>
How&nbsp;long&nbsp;are&nbsp;your&nbsp;typical&nbsp;access.log&nbsp;records?&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
Each&nbsp;write(2)&nbsp;call&nbsp;of&nbsp;a&nbsp;buffering&nbsp;TCP&nbsp;logging&nbsp;module&nbsp;during&nbsp;normal&nbsp;Squid&lt;br&nbsp;/&gt;<br>
operation&nbsp;should&nbsp;be&nbsp;16KB,&nbsp;regardless&nbsp;of&nbsp;the&nbsp;buffer-size&nbsp;setting.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
FWIW,&nbsp;the&nbsp;official&nbsp;access_log&nbsp;buffer-size&nbsp;documentation&nbsp;hints&nbsp;at&lt;br&nbsp;/&gt;<br>
module-specific&nbsp;flushing&nbsp;algorithms.&nbsp;I&nbsp;cannot&nbsp;describe&nbsp;the&nbsp;exact&lt;br&nbsp;/&gt;<br>
algorithm&nbsp;used&nbsp;by&nbsp;the&nbsp;TCP&nbsp;logging&nbsp;module&nbsp;in&nbsp;a&nbsp;few&nbsp;words,&nbsp;but&nbsp;it&nbsp;is&nbsp;not&lt;br&nbsp;/&gt;<br>
as&nbsp;simple&nbsp;as&nbsp;&quot;accumulate&nbsp;buffer-size&nbsp;bytes&nbsp;and&nbsp;then&nbsp;write&nbsp;the&lt;br&nbsp;/&gt;<br>
accumulated&nbsp;bytes&quot;.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
HTH,&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
Alex.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;On&nbsp;9&nbsp;Sep&nbsp;2022,&nbsp;19:57&nbsp;+0300,&nbsp;Alex&nbsp;Rousskov&nbsp;wrote:&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;On&nbsp;9/9/22&nbsp;08:49,&nbsp;roee&nbsp;klinger&nbsp;wrote:&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Hello,&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;have&nbsp;just&nbsp;recently&nbsp;started&nbsp;exploring&nbsp;ingesting&nbsp;logs&nbsp;from&nbsp;Squid&nbsp;via&lt;br&nbsp;/&gt;<br>
Logstash&nbsp;(TCP&nbsp;log&nbsp;ingestion)&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;now&nbsp;have&nbsp;to&nbsp;make&nbsp;the&nbsp;decision&nbsp;of&nbsp;how&nbsp;to&nbsp;deploy&nbsp;Logstash,&nbsp;it&nbsp;seems&nbsp;to&lt;br&nbsp;/&gt;<br>
me&nbsp;that&nbsp;I&nbsp;have&nbsp;two&nbsp;options:&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
1.&nbsp;Deploy&nbsp;a&nbsp;Logstash&nbsp;instance&nbsp;for&nbsp;every&nbsp;region&nbsp;where&nbsp;I&nbsp;have&nbsp;a&nbsp;Squid&lt;br&nbsp;/&gt;<br>
instance&nbsp;running,&nbsp;resulting&nbsp;in&nbsp;the&nbsp;lowest&nbsp;latency&nbsp;possible&nbsp;between&lt;br&nbsp;/&gt;<br>
Squid&nbsp;and&nbsp;Logstash.&lt;br&nbsp;/&gt;<br>
2.&nbsp;Deploy&nbsp;a&nbsp;central&nbsp;Logstash&nbsp;instance&nbsp;for&nbsp;all&nbsp;Squid&nbsp;instance&nbsp;worldwide,&lt;br&nbsp;/&gt;<br>
which&nbsp;is&nbsp;the&nbsp;cheapest&nbsp;and&nbsp;easiest&nbsp;option,&nbsp;but&nbsp;will&nbsp;have&nbsp;high&nbsp;latency&lt;br&nbsp;/&gt;<br>
for&nbsp;some&nbsp;of&nbsp;the&nbsp;Squid&nbsp;instance&nbsp;which&nbsp;are&nbsp;located&nbsp;far&nbsp;away&lt;br&nbsp;/&gt;<br>
geographically&nbsp;from&nbsp;the&nbsp;Logstash&nbsp;instance.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;already&nbsp;know&nbsp;that&nbsp;if&nbsp;the&nbsp;log&nbsp;server&nbsp;crashes&nbsp;in&nbsp;Squid,&nbsp;then&nbsp;Squid&nbsp;will&lt;br&nbsp;/&gt;<br>
crash&nbsp;with&nbsp;a&nbsp;fatal&nbsp;error,&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;<br>
FYI:&nbsp;Logging&nbsp;error&nbsp;handling&nbsp;is&nbsp;configurable&nbsp;via&nbsp;&quot;access_log&nbsp;on-error&quot;.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;so&nbsp;Squid&nbsp;takes&nbsp;logging&nbsp;very&nbsp;seriously,&nbsp;so&nbsp;my&lt;br&nbsp;/&gt;<br>
question&nbsp;is:&nbsp;does&nbsp;TCP&nbsp;logging&nbsp;performance&nbsp;in&nbsp;Squid&nbsp;effect&nbsp;the&nbsp;total&lt;br&nbsp;/&gt;<br>
request&nbsp;performance,&nbsp;or&nbsp;are&nbsp;they&nbsp;independent&nbsp;from&nbsp;each&nbsp;other?&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;<br>
TCP&nbsp;logger&nbsp;uses&nbsp;asynchronous&nbsp;non-blocking&nbsp;I/O.&nbsp;Individual&nbsp;HTTP&lt;br&nbsp;/&gt;<br>
transactions&nbsp;do&nbsp;not&nbsp;wait&nbsp;for&nbsp;individual&nbsp;log&nbsp;records&nbsp;to&nbsp;be&nbsp;sent.&nbsp;Needless&lt;br&nbsp;/&gt;<br>
to&nbsp;say,&nbsp;logging&nbsp;does&nbsp;consume&nbsp;resources&nbsp;and,&nbsp;hence,&nbsp;may&nbsp;affect&nbsp;overall&lt;br&nbsp;/&gt;<br>
HTTP&nbsp;transaction&nbsp;performance.&nbsp;And&nbsp;if&nbsp;the&nbsp;log&nbsp;record&nbsp;recipient&nbsp;is&nbsp;too&lt;br&nbsp;/&gt;<br>
slow,&nbsp;then&nbsp;Squid&nbsp;will&nbsp;die&nbsp;and/or&nbsp;log&nbsp;records&nbsp;will&nbsp;be&nbsp;dropped.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;What&nbsp;would&nbsp;be&nbsp;you&nbsp;recommendations,&nbsp;if&nbsp;request&nbsp;performance&nbsp;is&nbsp;crucial&lt;br&nbsp;/&gt;<br>
(and&nbsp;log&nbsp;performance&nbsp;is&nbsp;not)?&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;<br>
I&nbsp;would&nbsp;not&nbsp;be&nbsp;surprised&nbsp;if&nbsp;you&nbsp;would&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;measure&nbsp;meaningful&lt;br&nbsp;/&gt;<br>
performance&nbsp;difference&nbsp;among&nbsp;these&nbsp;modules.&nbsp;From&nbsp;general&nbsp;performance&lt;br&nbsp;/&gt;<br>
point&nbsp;of&nbsp;view,&nbsp;and&nbsp;module-specific&nbsp;bugs&nbsp;and&nbsp;limitations&nbsp;notwithstanding,&lt;br&nbsp;/&gt;<br>
I&nbsp;would&nbsp;expect&nbsp;&quot;daemon&quot;&nbsp;and&nbsp;&quot;udp&quot;&nbsp;modules&nbsp;to&nbsp;have&nbsp;smaller&nbsp;performance&lt;br&nbsp;/&gt;<br>
overhead/cost&nbsp;for&nbsp;Squid&nbsp;workers&nbsp;than&nbsp;the&nbsp;&quot;tcp&quot;&nbsp;module&nbsp;because&nbsp;I&nbsp;expect&lt;br&nbsp;/&gt;<br>
that&nbsp;TCP&nbsp;has&nbsp;to&nbsp;&quot;do&nbsp;more&quot;&nbsp;than&nbsp;stdout&nbsp;I/O&nbsp;and&nbsp;UDP.&nbsp;However,&nbsp;I&nbsp;would&nbsp;not&lt;br&nbsp;/&gt;<br>
base&nbsp;this&nbsp;decision&nbsp;on&nbsp;such&nbsp;high-level&nbsp;speculations&nbsp;and&nbsp;test&nbsp;various&lt;br&nbsp;/&gt;<br>
options&nbsp;instead.&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
HTH,&lt;br&nbsp;/&gt;<br>
&lt;br&nbsp;/&gt;<br>
Alex.&lt;br&nbsp;/&gt;<br>
_______________________________________________&lt;br&nbsp;/&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&nbsp;/&gt;<br>
squid-users@lists.squid-cache.org&lt;br&nbsp;/&gt;<br>
http://lists.squid-cache.org/listinfo/squid-users&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&nbsp;/&gt;&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
