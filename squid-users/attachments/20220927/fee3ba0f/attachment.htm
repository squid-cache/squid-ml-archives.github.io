<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&nbsp;style=&quot;display:none;&quot;&gt;&nbsp;P&nbsp;{margin-top:0;margin-bottom:0;}&nbsp;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana,&nbsp;Geneva,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&nbsp;class=&quot;elementToProof&quot;&gt;<br>
I&nbsp;will&nbsp;take&nbsp;a&nbsp;look,&nbsp;thank's&nbsp;for&nbsp;help&nbsp;&lt;span&nbsp;id=&quot;ðŸ™‚&quot;&gt;ðŸ™‚&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Verdana,&nbsp;Geneva,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;Signature&quot;&gt;<br>
&lt;div&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;Verdana,&nbsp;Geneva,&nbsp;sans-serif;&quot;&gt;Regards,&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;&gt;<br>
&lt;div&nbsp;style=&quot;margin:0px;text-align:start;background-color:white&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Verdana,&nbsp;Geneva,&nbsp;sans-serif;&quot;&gt;ThÃ©o&nbsp;BARRAGUÃ‰&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;signature_bookmark&quot;&gt;&lt;/div&gt;<br>
&lt;div&nbsp;id=&quot;appendonsend&quot;&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-family:Verdana,Geneva,sans-serif;&nbsp;font-size:12pt;&nbsp;color:rgb(0,0,0)&quot;&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;hr&nbsp;tabindex=&quot;-1&quot;&nbsp;style=&quot;display:inline-block;&nbsp;width:98%&quot;&gt;<br>
&lt;div&nbsp;id=&quot;divRplyFwdMsg&quot;&nbsp;dir=&quot;ltr&quot;&gt;&lt;font&nbsp;face=&quot;Calibri,&nbsp;sans-serif&quot;&nbsp;color=&quot;#000000&quot;&nbsp;style=&quot;font-size:11pt&quot;&gt;&lt;b&gt;From:&lt;/b&gt;&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;rousskov@measurement-factory.com&gt;&lt;br&gt;<br>
&lt;b&gt;Sent:&lt;/b&gt;&nbsp;Monday,&nbsp;September&nbsp;26,&nbsp;2022&nbsp;3:25&nbsp;PM&lt;br&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;ThÃ©o&nbsp;BARRAGUE&nbsp;&lt;Theo.BARRAGUE.ext@boursorama.fr&gt;;&nbsp;squid-users@lists.squid-cache.org&nbsp;&lt;squid-users@lists.squid-cache.org&gt;&lt;br&gt;<br>
&lt;b&gt;Cc:&lt;/b&gt;&nbsp;Olivier&nbsp;HANESSE&nbsp;&lt;Olivier.HANESSE@boursorama.fr&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[squid-users]&nbsp;Use&nbsp;ICP&nbsp;RTT&nbsp;with&nbsp;HTTPS&nbsp;request&lt;/font&gt;<br>
&lt;div&gt;&nbsp;&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;BodyFragment&quot;&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11pt&quot;&gt;<br>
&lt;div&nbsp;class=&quot;PlainText&quot;&gt;On&nbsp;9/26/22&nbsp;05:51,&nbsp;ThÃ©o&nbsp;BARRAGUE&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;entry&nbsp;is&nbsp;null&nbsp;so&nbsp;peerGetSomeNeighbor&nbsp;is&nbsp;never&nbsp;called&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;did&nbsp;not&nbsp;check&nbsp;all&nbsp;the&nbsp;details,&nbsp;but&nbsp;it&nbsp;looks&nbsp;like&nbsp;Squid&nbsp;ICMP&nbsp;code&nbsp;&lt;br&gt;<br>
(ab)uses&nbsp;StoreEntry-linked&nbsp;metadata.&nbsp;Basic&nbsp;CONNECT&nbsp;tunnels&nbsp;lack&nbsp;&lt;br&gt;<br>
StoreEntry&nbsp;because&nbsp;they&nbsp;are&nbsp;not&nbsp;reading/writing&nbsp;data&nbsp;from/to&nbsp;Store.&nbsp;The&nbsp;&lt;br&gt;<br>
combination&nbsp;is&nbsp;essentially&nbsp;a&nbsp;Squid&nbsp;bug&nbsp;--&nbsp;basic&nbsp;CONNECT&nbsp;tunnels&nbsp;cannot&nbsp;&lt;br&gt;<br>
use&nbsp;ICMP&nbsp;features.&lt;br&gt;<br>
&lt;br&gt;<br>
Most&nbsp;likely,&nbsp;the&nbsp;correct&nbsp;long-term&nbsp;solution&nbsp;here&nbsp;is&nbsp;to&nbsp;remove&nbsp;StoreEntry&nbsp;&lt;br&gt;<br>
use&nbsp;from&nbsp;ICMP&nbsp;code&nbsp;--&nbsp;I&nbsp;bet&nbsp;that&nbsp;code&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;genuine&nbsp;need&nbsp;for&nbsp;&lt;br&gt;<br>
Store&nbsp;access&nbsp;and&nbsp;should&nbsp;store&nbsp;its&nbsp;essential&nbsp;metadata&nbsp;elsewhere.&nbsp;That&nbsp;&lt;br&gt;<br>
proper&nbsp;solution&nbsp;will&nbsp;require&nbsp;non-trivial&nbsp;development.&nbsp;For&nbsp;a&nbsp;possibly&nbsp;&lt;br&gt;<br>
simpler&nbsp;workaround,&nbsp;one&nbsp;could&nbsp;consider&nbsp;creating&nbsp;a&nbsp;temporary&nbsp;StoreEntry&nbsp;&lt;br&gt;<br>
object&nbsp;for&nbsp;ICMP&nbsp;use&nbsp;(instead&nbsp;of&nbsp;disabling&nbsp;ICMP&nbsp;for&nbsp;entry-less&nbsp;use&nbsp;cases).&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F&quot;&nbsp;data-auth=&quot;NotApplicable&quot;&gt;https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(163)&nbsp;peerSelect:&nbsp;CONNECT&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(472)&nbsp;peerSelectFoo:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONNECT&nbsp;api.gouv.fr&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(485)&nbsp;peerSelectFoo:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;DIRECT_UNKNOWN&nbsp;(never_direct&nbsp;to&nbsp;be&nbsp;checked)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(70)&nbsp;preCheck:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x5653abfc4b68&nbsp;checking&nbsp;slow&nbsp;rules&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Ip.cc(538)&nbsp;match:&nbsp;aclIpMatchIp:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'10.25.41.21:34896'&nbsp;found&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&nbsp;all&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;never_direct#1&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;never_direct&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(63)&nbsp;markFinished:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x5653abfc4b68&nbsp;answer&nbsp;ALLOWED&nbsp;for&nbsp;match&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(163)&nbsp;checkCallback:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ACLChecklist::checkCallback:&nbsp;0x5653abfc4b68&nbsp;answer=ALLOWED&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(195)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerCheckNeverDirectDone:&nbsp;peerCheckNeverDirectDone:&nbsp;ALLOWED&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(201)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerCheckNeverDirectDone:&nbsp;direct&nbsp;=&nbsp;DIRECT_NO&nbsp;(never_direct&nbsp;allow)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(472)&nbsp;peerSelectFoo:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONNECT&nbsp;api.gouv.fr&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(712)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeParent:&nbsp;CONNECT&nbsp;api.gouv.fr&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;15,3|&nbsp;neighbors.cc(332)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getRoundRobinParent:&nbsp;returning&nbsp;NULL&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;15,3|&nbsp;neighbors.cc(382)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getWeightedRoundRobinParent:&nbsp;getWeightedRoundRobinParent:&nbsp;returning&nbsp;NULL&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(70)&nbsp;preCheck:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f030&nbsp;checking&nbsp;fast&nbsp;rules&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Ip.cc(538)&nbsp;match:&nbsp;aclIpMatchIp:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'10.25.41.21:34896'&nbsp;found&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&nbsp;all&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc02#1&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc02&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(63)&nbsp;markFinished:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f030&nbsp;answer&nbsp;ALLOWED&nbsp;for&nbsp;match&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;15,3|&nbsp;neighbors.cc(294)&nbsp;getFirstUpParent:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getFirstUpParent:&nbsp;returning&nbsp;10.26.8.10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;44,3|&nbsp;peer_select.cc(978)&nbsp;peerAddFwdServer:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adding&nbsp;FIRSTUP_PARENT/10.26.8.10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Checklist.cc(70)&nbsp;preCheck:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f0d0&nbsp;checking&nbsp;fast&nbsp;rules&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Ip.cc(538)&nbsp;match:&nbsp;aclIpMatchIp:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'10.25.41.21:34896'&nbsp;found&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.381|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&nbsp;all&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc02#1&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc02&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Checklist.cc(63)&nbsp;markFinished:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f0d0&nbsp;answer&nbsp;ALLOWED&nbsp;for&nbsp;match&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,3|&nbsp;peer_select.cc(971)&nbsp;peerAddFwdServer:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skipping&nbsp;ANY_OLD_PARENT/10.26.8.10;&nbsp;have&nbsp;FIRSTUP_PARENT/10.26.8.10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Checklist.cc(70)&nbsp;preCheck:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f0d0&nbsp;checking&nbsp;fast&nbsp;rules&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Ip.cc(538)&nbsp;match:&nbsp;aclIpMatchIp:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'10.25.41.21:34896'&nbsp;found&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&nbsp;all&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc01#1&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Acl.cc(151)&nbsp;matches:&nbsp;checked:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peer_access&nbsp;squid-2.inf-proxy03-d01.dc01&nbsp;=&nbsp;1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;28,3|&nbsp;Checklist.cc(63)&nbsp;markFinished:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffd6220f0d0&nbsp;answer&nbsp;ALLOWED&nbsp;for&nbsp;match&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,3|&nbsp;peer_select.cc(978)&nbsp;peerAddFwdServer:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adding&nbsp;ANY_OLD_PARENT/127.0.0.1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;15,3|&nbsp;neighbors.cc(472)&nbsp;getDefaultParent:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getDefaultParent:&nbsp;returning&nbsp;NULL&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(295)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;Find&nbsp;IP&nbsp;destination&nbsp;for:&nbsp;api.gouv.fr:443'&nbsp;via&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.26.8.10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(295)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;Find&nbsp;IP&nbsp;destination&nbsp;for:&nbsp;api.gouv.fr:443'&nbsp;via&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;127.0.0.1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(316)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;Found&nbsp;sources&nbsp;for&nbsp;'api.gouv.fr:443'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(317)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;always_direct&nbsp;=&nbsp;DENIED&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(318)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;never_direct&nbsp;=&nbsp;ALLOWED&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(328)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;cache_peer&nbsp;=&nbsp;local=0.0.0.0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;flags=1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(328)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;cache_peer&nbsp;=&nbsp;local=0.0.0.0&nbsp;remote=127.0.0.1:3129&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags=1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;44,2|&nbsp;peer_select.cc(331)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths:&nbsp;timedout&nbsp;=&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;26,3|&nbsp;tunnel.cc(1249)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelPeerSelectComplete:&nbsp;paths=2,&nbsp;p[0]={local=0.0.0.0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;flags=1},&nbsp;serverDest[0]={local=0.0.0.0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;flags=1}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;17,3|&nbsp;FwdState.cc(1369)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetMarkingsToServer:&nbsp;from&nbsp;0.0.0.0&nbsp;netfilter&nbsp;mark&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;26,3|&nbsp;AsyncCall.cc(25)&nbsp;AsyncCall:&nbsp;The&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AsyncCall&nbsp;tunnelConnectDone&nbsp;constructed,&nbsp;this=0x5653abf924a0&nbsp;[call164]&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;5,3|&nbsp;ConnOpener.cc(43)&nbsp;ConnOpener:&nbsp;will&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect&nbsp;to&nbsp;local=0.0.0.0&nbsp;remote=10.26.8.10:3129&nbsp;flags=1&nbsp;with&nbsp;30&nbsp;timeout&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;50,3|&nbsp;comm.cc(350)&nbsp;comm_openex:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comm_openex:&nbsp;Attempt&nbsp;open&nbsp;socket&nbsp;for:&nbsp;0.0.0.0&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;50,3|&nbsp;comm.cc(393)&nbsp;comm_openex:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comm_openex:&nbsp;Opened&nbsp;socket&nbsp;local=0.0.0.0&nbsp;remote=[::]&nbsp;FD&nbsp;14&nbsp;flags=1&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;family=2,&nbsp;type=1,&nbsp;protocol=6&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;51,3|&nbsp;fd.cc(198)&nbsp;fd_open:&nbsp;fd_open()&nbsp;FD&nbsp;14&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;api.gouv.fr:443&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.382|&nbsp;5,3|&nbsp;ConnOpener.cc(291)&nbsp;createFd:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=0.0.0.0&nbsp;remote=10.26.8.10:3129&nbsp;flags=1&nbsp;will&nbsp;timeout&nbsp;in&nbsp;30&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;AsyncCall.cc(92)&nbsp;ScheduleCall:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConnOpener.cc(139)&nbsp;will&nbsp;call&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelConnectDone(local=10.25.8.10:58500&nbsp;remote=10.26.8.10:3129&nbsp;FD&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14&nbsp;flags=1,&nbsp;data=0x5653abfa3598)&nbsp;[call164]&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;AsyncCallQueue.cc(55)&nbsp;fireNext:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entering&nbsp;tunnelConnectDone(local=10.25.8.10:58500&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1,&nbsp;data=0x5653abfa3598)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;AsyncCall.cc(37)&nbsp;make:&nbsp;make&nbsp;call&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelConnectDone&nbsp;[call164]&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;14,3|&nbsp;Address.cc(382)&nbsp;lookupHostIP:&nbsp;Given&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Non-IP&nbsp;'api.gouv.fr':&nbsp;Name&nbsp;or&nbsp;service&nbsp;not&nbsp;known&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;38,3|&nbsp;net_db.cc(355)&nbsp;netdbSendPing:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;netdbSendPing:&nbsp;pinging&nbsp;api.gouv.fr&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;37,2|&nbsp;IcmpSquid.cc(59)&nbsp;SendEcho:&nbsp;&nbsp;Socket&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Closed.&nbsp;Aborted&nbsp;send&nbsp;to&nbsp;10.26.8.10,&nbsp;opcode&nbsp;3,&nbsp;len&nbsp;10&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;tunnel.cc(1163)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelRelayConnectRequest:&nbsp;local=10.25.8.10:58500&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1,&nbsp;tunnelState=0x5653abfa3598&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;22,3|&nbsp;refresh.cc(648)&nbsp;getMaxAge:&nbsp;getMaxAge:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'api.gouv.fr:443'&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;11,2|&nbsp;tunnel.cc(1177)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelRelayConnectRequest:&nbsp;Tunnel&nbsp;Server&nbsp;REQUEST:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=10.25.8.10:58500&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----------&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONNECT&nbsp;api.gouv.fr:443&nbsp;HTTP/1.1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User-Agent:&nbsp;curl/7.52.1&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Host:&nbsp;api.gouv.fr:443&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X-Forwarded-For:&nbsp;unknown&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cache-Control:&nbsp;max-age=259200&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Connection:&nbsp;close&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----------&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;5,3|&nbsp;comm.cc(559)&nbsp;commSetConnTimeout:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=10.25.8.10:58500&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1&nbsp;timeout&nbsp;900&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;5,3|&nbsp;comm.cc(559)&nbsp;commSetConnTimeout:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=10.25.8.10:58500&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1&nbsp;timeout&nbsp;900&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;AsyncCallQueue.cc(57)&nbsp;fireNext:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leaving&nbsp;tunnelConnectDone(local=10.25.8.10:58500&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1,&nbsp;data=0x5653abfa3598)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;5,3|&nbsp;IoCallback.cc(116)&nbsp;finish:&nbsp;called&nbsp;for&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local=10.25.8.10:58500&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1&nbsp;(0,&nbsp;0)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2022/09/26&nbsp;09:07:52.393|&nbsp;26,3|&nbsp;tunnel.cc(929)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelConnectReqWriteDone:&nbsp;local=10.25.8.10:58500&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote=10.26.8.10:3129&nbsp;FD&nbsp;14&nbsp;flags=1,&nbsp;flag=0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;seems&nbsp;/peerGetSomeParent/&nbsp;is&nbsp;called&nbsp;and&nbsp;this&nbsp;method&nbsp;never&nbsp;issue&nbsp;an&nbsp;ICP&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;staticvoid&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeParent(ps_state&nbsp;*&nbsp;ps)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CachePeer&nbsp;*p;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpRequest&nbsp;*request&nbsp;=&nbsp;ps-&gt;request;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hier_code&nbsp;code&nbsp;=&nbsp;HIER_NONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;request-&gt;method&nbsp;&lt;&lt;&nbsp;'&nbsp;'&nbsp;&lt;&lt;&nbsp;request-&gt;url.host());&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;direct&nbsp;==&nbsp;DIRECT_YES)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((p&nbsp;=&nbsp;peerSourceHashSelectParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;SOURCEHASH_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#if&nbsp;USE_AUTH&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;peerUserHashSelectParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;USERHASH_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;carpSelectParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;CARP;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;getRoundRobinParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;ROUNDROBIN_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;getWeightedRoundRobinParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;ROUNDROBIN_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;getFirstUpParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;FIRSTUP_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;((p&nbsp;=&nbsp;getDefaultParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;DEFAULT_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(code&nbsp;!=&nbsp;HIER_NONE)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerAddFwdServer(ps,&nbsp;p,&nbsp;code);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Instead&nbsp;of&nbsp;/peerGetSomeNeighbor/&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;peerGetSomeNeighbor&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Selects&nbsp;a&nbsp;neighbor&nbsp;(parent&nbsp;or&nbsp;sibling)&nbsp;based&nbsp;on&nbsp;one&nbsp;of&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;following&nbsp;methods:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cache&nbsp;Digests&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CARP&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ICMP&nbsp;Netdb&nbsp;RTT&nbsp;estimates&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ICP/HTCP&nbsp;queries&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;staticvoid&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeNeighbor(ps_state&nbsp;*&nbsp;ps)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StoreEntry&nbsp;*entry&nbsp;=&nbsp;ps-&gt;entry;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpRequest&nbsp;*request&nbsp;=&nbsp;ps-&gt;request;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CachePeer&nbsp;*p;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hier_code&nbsp;code&nbsp;=&nbsp;HIER_NONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(entry-&gt;ping_status&nbsp;==&nbsp;PING_NONE);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;direct&nbsp;==&nbsp;DIRECT_YES)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry-&gt;ping_status&nbsp;=&nbsp;PING_DONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#if&nbsp;USE_CACHE_DIGESTS&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((p&nbsp;=&nbsp;neighborsDigestSelect(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(neighborType(p,&nbsp;request-&gt;url)&nbsp;==&nbsp;PEER_PARENT)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;CD_PARENT_HIT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;CD_SIBLING_HIT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((p&nbsp;=&nbsp;netdbClosestParent(request)))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;CLOSEST_PARENT;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(peerSelectIcpPing(request,&nbsp;ps-&gt;direct,&nbsp;entry))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelect:&nbsp;Doing&nbsp;ICP&nbsp;pings&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;ping.start&nbsp;=&nbsp;current_time;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;ping.n_sent&nbsp;=&nbsp;neighborsUdpPing(request,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerHandlePingReply,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;ps-&gt;ping.n_replies_expected,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;ps-&gt;ping.timeout);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;ping.n_sent&nbsp;==&nbsp;0)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;DBG_CRITICAL,&nbsp;&quot;WARNING:&nbsp;neighborsUdpPing&nbsp;returned&nbsp;0&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelect:&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;ps-&gt;ping.n_replies_expected&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;ICP&nbsp;replies&nbsp;expected,&nbsp;RTT&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;ps-&gt;ping.timeout&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;msec&quot;);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;ping.n_replies_expected&nbsp;&gt;&nbsp;0)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry-&gt;ping_status&nbsp;=&nbsp;PING_WAITING;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eventAdd(&quot;peerPingTimeout&quot;,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerPingTimeout,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.001&nbsp;*&nbsp;ps-&gt;ping.timeout,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(code&nbsp;!=&nbsp;HIER_NONE)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(p);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerAddFwdServer(ps,&nbsp;p,&nbsp;code);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry-&gt;ping_status&nbsp;=&nbsp;PING_DONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;These&nbsp;functions&nbsp;are&nbsp;called&nbsp;from&nbsp;/peerSelectFoo/&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;staticvoid&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectFoo(ps_state&nbsp;*&nbsp;ps)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!cbdataReferenceValid(ps-&gt;callback_data))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;Aborting&nbsp;peer&nbsp;selection.&nbsp;Parent&nbsp;Job&nbsp;went&nbsp;away.&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete&nbsp;ps;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StoreEntry&nbsp;*entry&nbsp;=&nbsp;ps-&gt;entry;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpRequest&nbsp;*request&nbsp;=&nbsp;ps-&gt;request;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;request-&gt;method&nbsp;&lt;&lt;&nbsp;'&nbsp;'&nbsp;&lt;&lt;&nbsp;request-&gt;url.host());&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;If&nbsp;we&nbsp;don't&nbsp;know&nbsp;whether&nbsp;DIRECT&nbsp;is&nbsp;permitted&nbsp;...&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;direct&nbsp;==&nbsp;DIRECT_UNKNOWN)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ps-&gt;always_direct&nbsp;==&nbsp;ACCESS_DUNNO)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(always_direct&nbsp;to&nbsp;be&nbsp;checked)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;check&nbsp;always_direct;&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ACLFilledChecklist&nbsp;*ch&nbsp;=&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newACLFilledChecklist(Config.accessList.AlwaysDirect,&nbsp;request,&nbsp;NULL);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch-&gt;al&nbsp;=&nbsp;ps-&gt;al;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;acl_checklist&nbsp;=&nbsp;ch;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;acl_checklist-&gt;nonBlockingCheck(peerCheckAlwaysDirectDone,&nbsp;ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(ps-&gt;never_direct&nbsp;==&nbsp;ACCESS_DUNNO)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(never_direct&nbsp;to&nbsp;be&nbsp;checked)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;check&nbsp;never_direct;&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ACLFilledChecklist&nbsp;*ch&nbsp;=&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newACLFilledChecklist(Config.accessList.NeverDirect,&nbsp;request,&nbsp;NULL);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch-&gt;al&nbsp;=&nbsp;ps-&gt;al;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;acl_checklist&nbsp;=&nbsp;ch;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;acl_checklist-&gt;nonBlockingCheck(peerCheckNeverDirectDone,&nbsp;ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(request-&gt;flags.noDirect)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;if&nbsp;we&nbsp;are&nbsp;accelerating,&nbsp;direct&nbsp;is&nbsp;not&nbsp;an&nbsp;option.&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;direct&nbsp;=&nbsp;DIRECT_NO;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(forced&nbsp;non-direct)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(request-&gt;flags.loopDetected)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;if&nbsp;we&nbsp;are&nbsp;in&nbsp;a&nbsp;forwarding-loop,&nbsp;direct&nbsp;is&nbsp;not&nbsp;an&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;option.&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;direct&nbsp;=&nbsp;DIRECT_YES;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(forwarding&nbsp;loop&nbsp;detected)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(peerCheckNetdbDirect(ps))&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;direct&nbsp;=&nbsp;DIRECT_YES;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(checkNetdbDirect)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps-&gt;direct&nbsp;=&nbsp;DIRECT_MAYBE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;(default)&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(44,&nbsp;3,&nbsp;&quot;peerSelectFoo:&nbsp;direct&nbsp;=&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;DirectStr[ps-&gt;direct]);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!entry&nbsp;||&nbsp;entry-&gt;ping_status&nbsp;==&nbsp;PING_NONE)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectPinned(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(entry&nbsp;==&nbsp;NULL)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void)&nbsp;0;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_NONE)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeNeighbor(ps);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_WAITING)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_WAITING)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeNeighborReplies(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry-&gt;ping_status&nbsp;=&nbsp;PING_DONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(ps-&gt;direct)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DIRECT_YES:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeDirect(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;DIRECT_NO:&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeParent(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetAllParents(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Config.onoff.prefer_direct)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeDirect(ps);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(request-&gt;flags.hierarchical&nbsp;||&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!Config.onoff.nonhierarchical_direct)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeParent(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetAllParents(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!Config.onoff.prefer_direct)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerGetSomeDirect(ps);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;resolve&nbsp;the&nbsp;possible&nbsp;peers&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelectDnsPaths(ps);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;/entry/&nbsp;is&nbsp;/null/&nbsp;so&nbsp;/peerGetSomeNeighbor/&nbsp;is&nbsp;never&nbsp;called&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;if&nbsp;(entry&nbsp;==&nbsp;NULL)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void)&nbsp;0;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_NONE)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;peerGetSomeNeighbor(ps);&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;if&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_WAITING)&lt;br&gt;<br>
&gt;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(entry-&gt;ping_status&nbsp;==&nbsp;PING_WAITING)&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;peerGetSomeNeighborReplies(ps);&lt;br&gt;<br>
&gt;&nbsp;entry-&gt;ping_status&nbsp;=&nbsp;PING_DONE;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Because&nbsp;of&nbsp;/tunnelStart/&nbsp;method&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelStart(ClientHttpRequest&nbsp;*&nbsp;http)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(26,&nbsp;3,&nbsp;HERE);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Create&nbsp;state&nbsp;structure.&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TunnelStateData&nbsp;*tunnelState&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ErrorState&nbsp;*err&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpRequest&nbsp;*request&nbsp;=&nbsp;http-&gt;request;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*url&nbsp;=&nbsp;http-&gt;uri;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;client_addr.isNoAddr()&nbsp;&nbsp;indicates&nbsp;this&nbsp;is&nbsp;an&nbsp;&quot;internal&quot;&nbsp;request&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;from&nbsp;peer_digest.c,&nbsp;asn.c,&nbsp;netdb.c,&nbsp;etc&nbsp;and&nbsp;should&nbsp;always&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;allowed.&nbsp;&nbsp;yuck,&nbsp;I&nbsp;know.&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Config.accessList.miss&nbsp;&amp;&amp;&nbsp;!request-&gt;client_addr.isNoAddr())&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Check&nbsp;if&nbsp;this&nbsp;host&nbsp;is&nbsp;allowed&nbsp;to&nbsp;fetch&nbsp;MISSES&nbsp;from&nbsp;us&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(miss_access)&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;default&nbsp;is&nbsp;to&nbsp;allow.&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ACLFilledChecklist&nbsp;ch(Config.accessList.miss,&nbsp;request,&nbsp;NULL);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch.al&nbsp;=&nbsp;http-&gt;al;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch.src_addr&nbsp;=&nbsp;request-&gt;client_addr;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch.my_addr&nbsp;=&nbsp;request-&gt;my_addr;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ch.syncAle(request,&nbsp;http-&gt;log_uri);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ch.fastCheck().denied())&nbsp;{&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(26,&nbsp;4,&nbsp;HERE&nbsp;&lt;&lt;&nbsp;&quot;MISS&nbsp;access&nbsp;forbidden.&quot;);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;newErrorState(ERR_FORWARDING_DENIED,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Http::scForbidden,&nbsp;request);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http-&gt;al-&gt;http.code&nbsp;=&nbsp;Http::scForbidden;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errorSend(http-&gt;getConn()-&gt;clientConnection,&nbsp;err);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(26,&nbsp;3,&nbsp;request-&gt;method&nbsp;&lt;&lt;&nbsp;'&nbsp;'&nbsp;&lt;&lt;&nbsp;url&nbsp;&lt;&lt;&nbsp;'&nbsp;'&nbsp;&lt;&lt;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request-&gt;http_ver);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++statCounter.server.all.requests;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++statCounter.server.other.requests;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelState&nbsp;=&nbsp;newTunnelStateData(http);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#if&nbsp;USE_DELAY_POOLS&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//server.setDelayId&nbsp;called&nbsp;from&nbsp;tunnelConnectDone&nbsp;after&nbsp;server&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;side&nbsp;connection&nbsp;established&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endif&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peerSelect(&amp;(tunnelState-&gt;serverDestinations),&nbsp;request,&nbsp;http-&gt;al,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelPeerSelectComplete,&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tunnelState);&lt;br&gt;<br>
&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Any&nbsp;ideas&nbsp;?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Regards,&lt;br&gt;<br>
&gt;&nbsp;ThÃ©o&nbsp;BARRAGUÃ‰&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
