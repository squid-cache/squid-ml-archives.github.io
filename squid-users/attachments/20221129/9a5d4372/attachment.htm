<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi&nbsp;there,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;setting&nbsp;up&nbsp;an&nbsp;HTTP/HTTPS&nbsp;transparent&nbsp;proxy,&nbsp;meaning&nbsp;the&nbsp;clients&nbsp;not&nbsp;need&nbsp;any&nbsp;certificates&nbsp;for&nbsp;using&nbsp;the&nbsp;proxy.&nbsp;This&nbsp;works&nbsp;fine&nbsp;on&nbsp;version&nbsp;3.5&nbsp;of&nbsp;Squid,&nbsp;however&nbsp;after&nbsp;upgrading&nbsp;to&nbsp;5.7&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;logs&nbsp;change:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1669723133.174&nbsp; &nbsp;8037&nbsp;10.184.19.220&nbsp;TCP_TUNNEL/500&nbsp;6207&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://54.240.253.128:443&quot;&gt;54.240.253.128:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://54.240.253.128&quot;&gt;54.240.253.128&lt;/a&gt;&nbsp;-&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Directive:&nbsp;logformat&nbsp;squid&nbsp;%ts.%03tu&nbsp;%&gt;a&nbsp;%Ss/%03&gt;Hs&nbsp;%ssl::&gt;sni&nbsp;%ssl::bump_mode&nbsp;ssl::&gt;cert_subject&nbsp;%&lt;ru&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;version&nbsp;3.5&nbsp;we&nbsp;were&nbsp;obtaining&nbsp;the&nbsp;domain&nbsp;name&nbsp;(an&nbsp;aws&nbsp;service)&nbsp;in&nbsp;the&nbsp;place&nbsp;of&nbsp;ORIGINAL_DST.&nbsp;Also&nbsp;now&nbsp;we&nbsp;are&nbsp;not&nbsp;seeing&nbsp;any&nbsp;information&nbsp;about&nbsp;the&nbsp;bump_mode&nbsp;in&nbsp;no&nbsp;one&nbsp;of&nbsp;the&nbsp;connections&nbsp;while&nbsp;before&nbsp;we&nbsp;were&nbsp;seeing&nbsp;it.&nbsp;One&nbsp;could&nbsp;trough&nbsp;that&nbsp;it&nbsp;could&nbsp;be&nbsp;because&nbsp;of&nbsp;the&nbsp;/500&nbsp;message,&nbsp;however&nbsp;on&nbsp;a&nbsp;200&nbsp;one&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;http://docs.ansble.com&quot;&gt;docs.ansble.com&lt;/a&gt;&nbsp;it&nbsp;also&nbsp;don´t&nbsp;show&nbsp;any&nbsp;data&nbsp;on&nbsp;the&nbsp;sni&nbsp;field:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1669723513.363&nbsp; &nbsp; 332&nbsp;10.184.19.220&nbsp;TCP_TUNNEL/200&nbsp;38192&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://104.26.0.234:443&quot;&gt;104.26.0.234:443&lt;/a&gt;&nbsp;-&nbsp;ORIGINAL_DST/&lt;a&nbsp;href=&quot;http://104.26.0.234&quot;&gt;104.26.0.234&lt;/a&gt;&nbsp;-&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also&nbsp;the&nbsp;500&nbsp;looks&nbsp;to&nbsp;come&nbsp;from&nbsp;the&nbsp;squid&nbsp;not&nbsp;understanding&nbsp;something&nbsp;on&nbsp;the&nbsp;SSL&nbsp;negotiation:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,4|&nbsp;support.cc(248)&nbsp;check_domain:&nbsp;Verifying&nbsp;server&nbsp;domain&nbsp;&lt;a&nbsp;href=&quot;http://arsenal.us-west-2.amazonaws.com&quot;&gt;arsenal.us-west-2.amazonaws.com&lt;/a&gt;&nbsp;to&nbsp;certificate&nbsp;name/subjectAltName&nbsp;&lt;a&nbsp;href=&quot;http://arsenal.us-west-2.amazonaws.com&quot;&gt;arsenal.us-west-2.amazonaws.com&lt;/a&gt;<br>
&lt;/span&gt;&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;bio.cc(136)&nbsp;read:&nbsp;FD&nbsp;28&nbsp;read&nbsp;347&nbsp;&lt;=&nbsp;65535<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;Io.cc(91)&nbsp;Handshake:&nbsp;-1/0&nbsp;for&nbsp;TLS&nbsp;connection&nbsp;0x558453168970&nbsp;over&nbsp;conn99&nbsp;local=SQUID-INTERNAL-IP:44264&nbsp;remote=&lt;a&nbsp;href=&quot;http://54.240.251.223:443&quot;&gt;54.240.251.223:443&lt;/a&gt;&nbsp;ORIGINAL_DST&nbsp;FD&nbsp;28&nbsp;flags=1<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,2|&nbsp;PeerConnector.cc(256)&nbsp;handleNegotiationResult:&nbsp;ERROR:&nbsp;failure&nbsp;while&nbsp;establishing&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;FD:&nbsp;280x558452b68980*1<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;NegotiationHistory.cc(85)&nbsp;retrieveNegotiatedInfo:&nbsp;SSL&nbsp;connection&nbsp;info&nbsp;on&nbsp;FD&nbsp;28&nbsp;SSL&nbsp;version&nbsp;NONE/0.0&nbsp;negotiated&nbsp;cipher&nbsp;<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;PeekingPeerConnector.cc(84)&nbsp;checkForPeekAndSpliceMatched:&nbsp;Will&nbsp;check&nbsp;for&nbsp;peek&nbsp;and&nbsp;splice&nbsp;on&nbsp;FD&nbsp;28<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;PeekingPeerConnector.cc(395)&nbsp;serverCertificateVerified:&nbsp;HTTPS&nbsp;server&nbsp;CN:&nbsp;&lt;a&nbsp;href=&quot;http://arsenal.us-west-2.amazonaws.com&quot;&gt;arsenal.us-west-2.amazonaws.com&lt;/a&gt;&nbsp;bumped:&nbsp;conn99&nbsp;local=SQUID-INTERNAL-IP:44264&nbsp;remote=&lt;a&nbsp;href=&quot;http://54.240.251.223:443&quot;&gt;54.240.251.223:443&lt;/a&gt;&nbsp;ORIGINAL_DST&nbsp;FD&nbsp;28&nbsp;flags=1<br>
&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;div&gt;&lt;span&gt;&lt;span&gt;&lt;span&nbsp;class=&quot;gmail-prismjs&nbsp;gmail-css-14r4yet&quot;&gt;&lt;code&nbsp;style=&quot;white-space:pre&quot;&gt;2022/11/29&nbsp;10:32:38.943&nbsp;kid1|&nbsp;83,5|&nbsp;PeekingPeerConnector.cc(273)&nbsp;startTunneling:&nbsp;will&nbsp;tunnel&nbsp;instead&nbsp;of&nbsp;negotiating&nbsp;TLS&lt;/code&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;is&nbsp;clear&nbsp;that&nbsp;in&nbsp;creates&nbsp;the&nbsp;tunnel&nbsp;so&nbsp;the&nbsp;500&nbsp;probably&nbsp;is&nbsp;that&nbsp;error?&nbsp;Why&nbsp;the&nbsp;bump/sni&nbsp;messages&nbsp;never&nbsp;log&nbsp;anything&nbsp;(according&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/Features/SslPeekAndSplice&quot;&gt;https://wiki.squid-cache.org/Features/SslPeekAndSplice&lt;/a&gt;&nbsp;they&nbsp;should&nbsp;log&nbsp;splice&nbsp;not&nbsp;-).&nbsp;This&nbsp;is&nbsp;the&nbsp;config&nbsp;for&nbsp;bumping:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;....&nbsp;http&nbsp;rules&nbsp;...&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;allowed_https_sites&nbsp;ssl::server_name_regex&nbsp;&quot;/etc/squid/whitelist.txt&quot;&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step2&nbsp;allowed_https_sites&lt;br&gt;ssl_bump&nbsp;splice&nbsp;step3&nbsp;allowed_https_sites&lt;br&gt;ssl_bump&nbsp;terminate&nbsp;step2&nbsp;all&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ip&nbsp;tables&nbsp;simply&nbsp;redirect:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-j&nbsp;REDIRECT&nbsp;--to-port&nbsp;3129&lt;/div&gt;&lt;div&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-j&nbsp;REDIRECT&nbsp;--to-port&nbsp;3130&nbsp;#&nbsp;https&nbsp;port&nbsp;on&nbsp;squid:&nbsp;https_port&nbsp;3130&nbsp;intercept&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl/dummy.pem&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;in&nbsp;advance,&nbsp;i&nbsp;have&nbsp;been&nbsp;trying&nbsp;this&nbsp;for&nbsp;a&nbsp;week&nbsp;now&nbsp;reading&nbsp;a&nbsp;lot&nbsp;of&nbsp;posts&nbsp;but&nbsp;not&nbsp;luck...&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
