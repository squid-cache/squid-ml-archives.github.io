<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;class=&quot;gmail-im&quot;&gt;&gt;Does&nbsp;child&nbsp;Squid&nbsp;bump&nbsp;the&nbsp;TLS&nbsp;client&nbsp;connection,&nbsp;tunnel&nbsp;it,&nbsp;or&lt;br&gt;<br>
&gt;terminates&nbsp;it&nbsp;(i.e.&nbsp;the&nbsp;child&nbsp;works&nbsp;as&nbsp;a&nbsp;reverse&nbsp;proxy)?&lt;br&gt;<br>
&lt;br&gt;&lt;/span&gt;*&nbsp;client&nbsp;connects&nbsp;to&nbsp;child&nbsp;Squid&#39;s&nbsp;http_port&nbsp;without&nbsp;&quot;ssl-bump&quot;.&lt;br&gt;*&nbsp;client&nbsp;sends&nbsp;a&nbsp;plain&nbsp;text&nbsp;CONNECT&nbsp;request&nbsp;to&nbsp;child&nbsp;Squid.&lt;br&gt;*&nbsp;child&nbsp;Squid&nbsp;connects&nbsp;to&nbsp;parent&nbsp;using&nbsp;cache_peer&nbsp;with&nbsp;mTLS.&lt;span&nbsp;class=&quot;gmail-im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;What&nbsp;are&nbsp;those&nbsp;TLS&nbsp;alerts?&lt;br&gt;&lt;/span&gt;<br>
Code&nbsp;21&nbsp;-&nbsp;decryption_failed_RESERVED(21).&lt;span&nbsp;class=&quot;gmail-im&quot;&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;If&nbsp;those&nbsp;TLS&nbsp;alerts&nbsp;are&nbsp;close_notify&nbsp;alerts,&nbsp;then&nbsp;the&nbsp;RST&nbsp;packets&nbsp;you&lt;br&gt;<br>
&gt;are&nbsp;seeing&nbsp;are&nbsp;probably&nbsp;triggered&nbsp;by&nbsp;the&nbsp;other&nbsp;side&nbsp;doing&nbsp;clean&nbsp;TLS&lt;br&gt;<br>
&gt;shutdown&nbsp;(i.e.&nbsp;sending&nbsp;a&nbsp;TLS&nbsp;close_notify&nbsp;alert&nbsp;before&nbsp;closing&nbsp;the&lt;br&gt;<br>
&gt;connection),&nbsp;either&nbsp;after&nbsp;receiving&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(unlikely&nbsp;with&lt;br&gt;<br>
&gt;half_closed_clients&nbsp;off?)&nbsp;or&nbsp;while&nbsp;that&nbsp;FIN&nbsp;packet&nbsp;is&nbsp;being&nbsp;generated&nbsp;or&lt;br&gt;<br>
&gt;is&nbsp;in-flight.&nbsp;When&nbsp;Such&nbsp;RST&nbsp;packets&nbsp;would&nbsp;be&nbsp;sent&nbsp;by&nbsp;the&nbsp;TCP&nbsp;stack&lt;br&gt;<br>
&gt;rather&nbsp;than&nbsp;Squid&nbsp;code&nbsp;itself.&nbsp;They&nbsp;may&nbsp;be&nbsp;an&nbsp;indication&nbsp;of&nbsp;a&nbsp;benign&lt;br&gt;<br>
&gt;race&nbsp;condition,&nbsp;a&nbsp;bug,&nbsp;or&nbsp;some&nbsp;other&nbsp;deficiency.&lt;br&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
half_closed_clients&nbsp;is&nbsp;off&lt;span&nbsp;class=&quot;gmail-im&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;Higher-level&nbsp;information&nbsp;(who&nbsp;initiates&nbsp;closure&nbsp;and&nbsp;why)&nbsp;may&nbsp;be&nbsp;needed&lt;br&gt;<br>
&gt;to&nbsp;figure&nbsp;this&nbsp;out.&nbsp;I&nbsp;recommend&nbsp;sharing&nbsp;a&nbsp;link&nbsp;to&nbsp;a&nbsp;compressed&nbsp;ALL,9&lt;br&gt;<br>
&gt;cache.log&nbsp;reproducing&nbsp;the&nbsp;problem&nbsp;with&nbsp;a&nbsp;single&nbsp;transaction&nbsp;_combined_&lt;br&gt;<br>
&gt;with&nbsp;a&nbsp;matching&nbsp;packet&nbsp;trace&nbsp;file&nbsp;in&nbsp;libpcap&nbsp;format.&lt;br&gt;<br>
&lt;br&gt;&lt;/span&gt;<br>
There&nbsp;is&nbsp;no&nbsp;other&nbsp;way&nbsp;than&nbsp;turning&nbsp;debug&nbsp;on.&lt;br&gt;<br>
&lt;br&gt;<br>
Maciek&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;wt.,&nbsp;28&nbsp;lut&nbsp;2023&nbsp;o&nbsp;15:15 Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;napisał(a):&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2/28/23&nbsp;08:35,&nbsp;Maciej&nbsp;Leks&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Am&nbsp;I&nbsp;right&nbsp;in&nbsp;saying&nbsp;that&nbsp;RST&nbsp;it&#39;s&nbsp;a&nbsp;design&nbsp;intent&nbsp;of&nbsp;squid&nbsp;to&nbsp;end&lt;br&gt;<br>
&gt;&nbsp;connections&nbsp;quickly?&nbsp;I&#39;ve&nbsp;started&nbsp;digging&nbsp;into&nbsp;the&nbsp;squid&nbsp;code&nbsp;and&nbsp;see&lt;br&gt;<br>
&gt;&nbsp;SO_LINGER&nbsp;and&nbsp;timeout&nbsp;set&nbsp;to&nbsp;0,&nbsp;which&nbsp;means&nbsp;that&nbsp;it&#39;s&nbsp;done&nbsp;on&nbsp;purpose&lt;br&gt;<br>
&gt;&nbsp;not&nbsp;to&nbsp;hang&nbsp;on&nbsp;connections&nbsp;in&nbsp;TIME_WAIT&nbsp;state?&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;child&nbsp;Squid&nbsp;bump&nbsp;the&nbsp;TLS&nbsp;client&nbsp;connection,&nbsp;tunnel&nbsp;it,&nbsp;or&nbsp;&lt;br&gt;<br>
terminates&nbsp;it&nbsp;(i.e.&nbsp;the&nbsp;child&nbsp;works&nbsp;as&nbsp;a&nbsp;reverse&nbsp;proxy)?&lt;br&gt;<br>
&lt;br&gt;<br>
What&nbsp;are&nbsp;those&nbsp;TLS&nbsp;alerts?&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;those&nbsp;TLS&nbsp;alerts&nbsp;are&nbsp;close_notify&nbsp;alerts,&nbsp;then&nbsp;the&nbsp;RST&nbsp;packets&nbsp;you&nbsp;&lt;br&gt;<br>
are&nbsp;seeing&nbsp;are&nbsp;probably&nbsp;triggered&nbsp;by&nbsp;the&nbsp;other&nbsp;side&nbsp;doing&nbsp;clean&nbsp;TLS&nbsp;&lt;br&gt;<br>
shutdown&nbsp;(i.e.&nbsp;sending&nbsp;a&nbsp;TLS&nbsp;close_notify&nbsp;alert&nbsp;before&nbsp;closing&nbsp;the&nbsp;&lt;br&gt;<br>
connection),&nbsp;either&nbsp;after&nbsp;receiving&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(unlikely&nbsp;with&nbsp;&lt;br&gt;<br>
half_closed_clients&nbsp;off?)&nbsp;or&nbsp;while&nbsp;that&nbsp;FIN&nbsp;packet&nbsp;is&nbsp;being&nbsp;generated&nbsp;or&nbsp;&lt;br&gt;<br>
is&nbsp;in-flight.&nbsp;When&nbsp;Such&nbsp;RST&nbsp;packets&nbsp;would&nbsp;be&nbsp;sent&nbsp;by&nbsp;the&nbsp;TCP&nbsp;stack&nbsp;&lt;br&gt;<br>
rather&nbsp;than&nbsp;Squid&nbsp;code&nbsp;itself.&nbsp;They&nbsp;may&nbsp;be&nbsp;an&nbsp;indication&nbsp;of&nbsp;a&nbsp;benign&nbsp;&lt;br&gt;<br>
race&nbsp;condition,&nbsp;a&nbsp;bug,&nbsp;or&nbsp;some&nbsp;other&nbsp;deficiency.&lt;br&gt;<br>
&lt;br&gt;<br>
Higher-level&nbsp;information&nbsp;(who&nbsp;initiates&nbsp;closure&nbsp;and&nbsp;why)&nbsp;may&nbsp;be&nbsp;needed&nbsp;&lt;br&gt;<br>
to&nbsp;figure&nbsp;this&nbsp;out.&nbsp;I&nbsp;recommend&nbsp;sharing&nbsp;a&nbsp;link&nbsp;to&nbsp;a&nbsp;compressed&nbsp;ALL,9&nbsp;&lt;br&gt;<br>
cache.log&nbsp;reproducing&nbsp;the&nbsp;problem&nbsp;with&nbsp;a&nbsp;single&nbsp;transaction&nbsp;_combined_&nbsp;&lt;br&gt;<br>
with&nbsp;a&nbsp;matching&nbsp;packet&nbsp;trace&nbsp;file&nbsp;in&nbsp;libpcap&nbsp;format.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;wt.,&nbsp;28&nbsp;lut&nbsp;2023&nbsp;o&nbsp;08:12&nbsp;Maciej&nbsp;Leks&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:maciej.leks@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;maciej.leks@gmail.com&lt;/a&gt;&gt;&nbsp;napisał(a):&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;For&nbsp;a&nbsp;couple&nbsp;of&nbsp;days&nbsp;we&#39;ve &nbsp;been&nbsp;encountering&nbsp;many&nbsp;ECONNRESET&nbsp;error&lt;br&gt;<br>
&gt;&gt;&nbsp;messages&nbsp;in&nbsp;our&nbsp;nodejs&nbsp;client&nbsp;to&nbsp;Salesforce.&nbsp;Even&nbsp;if&nbsp;access.log&nbsp;shows&lt;br&gt;<br>
&gt;&gt;&nbsp;only&nbsp;/200&nbsp;tshark&nbsp;shows&nbsp;a&nbsp;messy&nbsp;communication&nbsp;between&nbsp;client-&gt;squid&lt;br&gt;<br>
&gt;&gt;&nbsp;(child&nbsp;squid).&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;architecture:&nbsp;nodejs&nbsp;client-&gt;3..*&nbsp;child&nbsp;squid-&gt;2*parent&lt;br&gt;<br>
&gt;&gt;&nbsp;squids-&gt;cloud&nbsp;Salesforce&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Some&nbsp;examples&nbsp;([RST]]:&nbsp;46&nbsp;1.015513576&nbsp;100.121.10.169&nbsp;→&nbsp;100.113.27.73&lt;br&gt;<br>
&gt;&gt;&nbsp;TCP&nbsp;66&nbsp;46098&nbsp;→&nbsp;3128&nbsp;[ACK]&nbsp;Seq=1721&nbsp;Ack=140135&nbsp;Win=214656&nbsp;Len=0&lt;br&gt;<br>
&gt;&gt;&nbsp;TSval=2672547296&nbsp;TSecr=1443424287&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; 47&nbsp;1.016152326&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;66&nbsp;3128&nbsp;→&nbsp;46098&lt;br&gt;<br>
&gt;&gt;&nbsp;[FIN,&nbsp;ACK]&nbsp;Seq=140135&nbsp;Ack=1721&nbsp;Win=42368&nbsp;Len=0&nbsp;TSval=1443424288&lt;br&gt;<br>
&gt;&gt;&nbsp;TSecr=2672547296&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; 48&nbsp;1.017856001&nbsp;100.121.10.169&nbsp;→&nbsp;100.113.27.73&nbsp;TLSv1.2&nbsp;97&nbsp;Encrypted&nbsp;Alert&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; 49&nbsp;1.017893411&nbsp;100.121.10.169&nbsp;→&nbsp;100.113.27.73&nbsp;TCP&nbsp;66&nbsp;46098&nbsp;→&nbsp;3128&lt;br&gt;<br>
&gt;&gt;&nbsp;[FIN,&nbsp;ACK]&nbsp;Seq=1752&nbsp;Ack=140136&nbsp;Win=214656&nbsp;Len=0&nbsp;TSval=2672547298&lt;br&gt;<br>
&gt;&gt;&nbsp;TSecr=1443424288&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; 50&nbsp;1.018002285&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;54&nbsp;3128&nbsp;→&nbsp;46098&lt;br&gt;<br>
&gt;&gt;&nbsp;[RST]&nbsp;Seq=140136&nbsp;Win=0&nbsp;Len=0&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; 51&nbsp;1.018019806&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;54&nbsp;3128&nbsp;→&nbsp;46098&lt;br&gt;<br>
&gt;&gt;&nbsp;[RST]&nbsp;Seq=140136&nbsp;Win=0&nbsp;Len=0&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;[RST,ACK]:&lt;br&gt;<br>
&gt;&gt;&nbsp;592&nbsp;67.664585034&nbsp;100.121.10.169&nbsp;→&nbsp;100.113.27.73&nbsp;TLSv1.2&nbsp;97&nbsp;Encrypted&nbsp;Alert&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp;593&nbsp;67.664737552&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;66&nbsp;3128&nbsp;→&nbsp;52202&lt;br&gt;<br>
&gt;&gt;&nbsp;[ACK]&nbsp;Seq=7973&nbsp;Ack=1129&nbsp;Win=42752&nbsp;Len=0&nbsp;TSval=1443490937&lt;br&gt;<br>
&gt;&gt;&nbsp;TSecr=2672613945&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp;594&nbsp;67.664841613&nbsp;100.121.10.169&nbsp;→&nbsp;100.113.27.73&nbsp;TCP&nbsp;66&nbsp;52202&nbsp;→&nbsp;3128&lt;br&gt;<br>
&gt;&gt;&nbsp;[FIN,&nbsp;ACK]&nbsp;Seq=1129&nbsp;Ack=7973&nbsp;Win=42368&nbsp;Len=0&nbsp;TSval=2672613945&lt;br&gt;<br>
&gt;&gt;&nbsp;TSecr=1443490937&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp;595&nbsp;67.664895660&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;66&nbsp;3128&nbsp;→&nbsp;52202&lt;br&gt;<br>
&gt;&gt;&nbsp;[RST,&nbsp;ACK]&nbsp;Seq=7973&nbsp;Ack=1129&nbsp;Win=42752&nbsp;Len=0&nbsp;TSval=1443490937&lt;br&gt;<br>
&gt;&gt;&nbsp;TSecr=2672613945&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp;596&nbsp;67.664936264&nbsp;100.113.27.73&nbsp;→&nbsp;100.121.10.169&nbsp;TCP&nbsp;54&nbsp;3128&nbsp;→&nbsp;52202&lt;br&gt;<br>
&gt;&gt;&nbsp;[RST]&nbsp;Seq=7973&nbsp;Win=0&nbsp;Len=0&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&#39;m&nbsp;wondering&nbsp;how&nbsp;to&nbsp;debug&nbsp;it&nbsp;(what&nbsp;exactly)&nbsp;and&nbsp;whether&nbsp;the&nbsp;reason&lt;br&gt;<br>
&gt;&gt;&nbsp;may&nbsp;be&nbsp;on&nbsp;the&nbsp;squid&nbsp;side&nbsp;(specific&nbsp;configuration?).&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;env:&nbsp;GKE/k8s&lt;br&gt;<br>
&gt;&gt;&nbsp;client&nbsp;container:&nbsp;alpine&nbsp;linux&lt;br&gt;<br>
&gt;&gt;&nbsp;child&nbsp;squid&nbsp;container:&nbsp;alpine&nbsp;linux&lt;br&gt;<br>
&gt;&gt;&nbsp;version:&nbsp;5.7&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Cheers,&lt;br&gt;<br>
&gt;&gt;&nbsp;Maciek&nbsp;Leks&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
