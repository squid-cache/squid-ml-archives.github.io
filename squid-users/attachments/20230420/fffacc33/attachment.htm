<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thank&nbsp;you! &nbsp;so&nbsp;ok. &lt;br&gt;&lt;br&gt;I&nbsp;configured&nbsp;like: &lt;br&gt;&lt;br&gt;cache_peer&nbsp;peerG1.com&nbsp;parent&nbsp;40001&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=peerG1 &lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;color:rgb(80,0,80)&quot;&gt;external_acl_type&nbsp;ext_proxy_g1_type&nbsp;%LOGIN&nbsp;%DST&nbsp;/usr/local/bin/g1.py &lt;br&gt;&lt;/span&gt;&lt;br&gt;acl proxy_g1_ext_mark_acl &nbsp;ext_proxy_g1_type &lt;br&gt;&lt;br&gt;acl proxy_g1_ext_marked_acl &nbsp;annotate_transaction&nbsp;proxy=g1&lt;span&nbsp;class=&quot;gmail-im&quot;&nbsp;style=&quot;color:rgb(80,0,80)&quot;&gt;&lt;br&gt;&lt;br&gt;acl &lt;span&nbsp;style=&quot;color:rgb(0,0,0);white-space:pre-wrap&quot;&gt;proxy_peerG1_acl&lt;/span&gt; note&nbsp;proxy&nbsp;g1&lt;br&gt;&lt;br&gt;&lt;/span&gt;http_access&nbsp;deny&nbsp;proxy_g1_ext_mark_acl  proxy_g1_ext_marked_acl !all &nbsp; (&nbsp;looks&nbsp;like&nbsp;this&nbsp;rule&nbsp;making&nbsp;the&nbsp;main&nbsp;magic&nbsp;of&nbsp;all, &nbsp;)&lt;br&gt;.....&lt;br&gt;others&nbsp;http_access&nbsp;rules&lt;br&gt;&lt;br&gt;And&nbsp;this&nbsp;above&nbsp;works. &lt;br&gt;BUT &lt;br&gt;I&nbsp;am&nbsp;worried about&nbsp;why&nbsp;this&nbsp;my&nbsp;external&nbsp;script&nbsp;for&nbsp;ACL &nbsp;type&nbsp;loads&nbsp;the&nbsp;one&nbsp;of&nbsp;core&nbsp;of&nbsp;CPU&nbsp;to&nbsp;100%.....???&nbsp;(&nbsp;I&nbsp;used&nbsp;three&nbsp;of&nbsp;workers&nbsp;in&nbsp;config,&nbsp;but&nbsp;I&nbsp;can&nbsp;see&nbsp;a&nbsp;six&nbsp;process&nbsp;called&nbsp;like&nbsp;my&nbsp;external&nbsp;helper&nbsp;script,&nbsp;looks&nbsp;like&nbsp;squid&nbsp;runs&nbsp;x2&nbsp;process&nbsp;for&nbsp;external&nbsp;ACL&nbsp;)&lt;br&gt;&lt;br&gt;&lt;br&gt;Because&nbsp;if&nbsp;I&nbsp;will&nbsp;put&nbsp;the&nbsp;one&nbsp;more&nbsp;group&nbsp;of&nbsp;users&nbsp;(that&nbsp;must&nbsp;to&nbsp;use&nbsp;another&nbsp;cache_peer&nbsp;)&nbsp;-&nbsp;I&nbsp;will&nbsp;need&nbsp;to&nbsp;create&nbsp;one&nbsp;more&nbsp;external&nbsp;script&nbsp;that&nbsp;will&nbsp;making&nbsp;to&nbsp;check&nbsp;an&nbsp;existed&nbsp;users&nbsp;from&nbsp;an&nbsp;other DB&nbsp;table &lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;ср,&nbsp;19&nbsp;апр.&nbsp;2023 г.&nbsp;в&nbsp;22:39,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;4/19/23&nbsp;13:30,&nbsp;Alexeyяр&nbsp;Gruzdov&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;cache_peer&nbsp;peerG1.com&nbsp;parent&nbsp;40001&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=peerG1&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;external_acl_type&nbsp;ext_proxy_g1_type&nbsp;%LOGIN&nbsp;%DST&nbsp;/usr/local/bin/g1.py&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl proxy_g1_ext_acl ext_proxy_g1_type&lt;br&gt;<br>
&lt;br&gt;<br>
OK.&nbsp;I&nbsp;assume&nbsp;that&nbsp;/usr/local/bin/g1.py&nbsp;will&nbsp;only&nbsp;match&nbsp;users&nbsp;that&nbsp;should&nbsp;&lt;br&gt;<br>
go&nbsp;to&nbsp;cache_peer&nbsp;called&nbsp;peerG1.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl proxy_g1_ext_acl_mark &nbsp;annotate_transaction&nbsp;proxy=g1&lt;br&gt;<br>
&lt;br&gt;<br>
Please&nbsp;note&nbsp;that&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;annotate_transaction&nbsp;ACL&nbsp;--&nbsp;&lt;br&gt;<br>
&quot;proxy_g1_ext_acl_mark&quot;&nbsp;--&nbsp;implies&nbsp;a&nbsp;relationship&nbsp;to&nbsp;the&nbsp;external&nbsp;ACL&nbsp;&lt;br&gt;<br>
named&nbsp;&quot;proxy_g1_ext_acl&quot;,&nbsp;but&nbsp;there&nbsp;is&nbsp;no&nbsp;such&nbsp;relationship.&nbsp;Squid&nbsp;does&nbsp;&lt;br&gt;<br>
not&nbsp;care&nbsp;about&nbsp;ACL&nbsp;names,&nbsp;but&nbsp;this&nbsp;naming&nbsp;problem&nbsp;may&nbsp;indicate&nbsp;a&nbsp;&lt;br&gt;<br>
misunderstanding.&nbsp;To&nbsp;follow&nbsp;your&nbsp;naming&nbsp;scheme,&nbsp;this&nbsp;ACL&nbsp;should&nbsp;be&nbsp;&lt;br&gt;<br>
called&nbsp;something&nbsp;like&nbsp;&quot;proxy_g1_mark_acl&quot;&nbsp;or&nbsp;&quot;mark_for_proxy_g1_acl&quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;proxy_peerG1_acl note&nbsp;proxy&nbsp;g1&lt;br&gt;<br>
&lt;br&gt;<br>
OK.&nbsp;FWIW,&nbsp;a&nbsp;more&nbsp;consistent&nbsp;ACL&nbsp;name&nbsp;would&nbsp;have&nbsp;been&nbsp;&lt;br&gt;<br>
&quot;proxy_g1_marked_acl&quot;&nbsp;or&nbsp;&quot;marked_for_proxy_g1_acl&quot;.&nbsp;Again,&nbsp;Squid&nbsp;does&nbsp;&lt;br&gt;<br>
not&nbsp;really&nbsp;care&nbsp;about&nbsp;these&nbsp;names,&nbsp;so&nbsp;use&nbsp;whatever&nbsp;you&nbsp;think&nbsp;is&nbsp;&lt;br&gt;<br>
consistent/meaningful/etc.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;proxy_g1_ext_acl&nbsp;!all&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;line&nbsp;has&nbsp;no&nbsp;(positive)&nbsp;effect.&nbsp;Squid&nbsp;will&nbsp;evaluate&nbsp;the&nbsp;external&nbsp;&lt;br&gt;<br>
ACL,&nbsp;but&nbsp;since&nbsp;the&nbsp;rule,&nbsp;as&nbsp;a&nbsp;whole,&nbsp;will&nbsp;never&nbsp;match&nbsp;due&nbsp;to&nbsp;&quot;!all&quot;,&nbsp;and&nbsp;&lt;br&gt;<br>
since&nbsp;the&nbsp;external&nbsp;ACL&nbsp;has&nbsp;no&nbsp;(relevant)&nbsp;side&nbsp;effects,&nbsp;you&nbsp;can&nbsp;just&nbsp;&lt;br&gt;<br>
delete&nbsp;this&nbsp;line&nbsp;from&nbsp;your&nbsp;configuration.&lt;br&gt;<br>
&lt;br&gt;<br>
Needless&nbsp;to&nbsp;say,&nbsp;if&nbsp;you&nbsp;delete&nbsp;this&nbsp;line,&nbsp;then&nbsp;proxy_g1_ext_acl&nbsp;will&nbsp;be&nbsp;&lt;br&gt;<br>
unused,&nbsp;which&nbsp;should&nbsp;tell&nbsp;you&nbsp;that&nbsp;this&nbsp;configuration&nbsp;is&nbsp;not&nbsp;doing&nbsp;what&nbsp;&lt;br&gt;<br>
you&nbsp;want.&nbsp;See&nbsp;below&nbsp;for&nbsp;a&nbsp;fix&nbsp;recommendation.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;deny&nbsp;proxy_g1_ext_acl_mark&nbsp;!all&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;line&nbsp;will&nbsp;mark&nbsp;_all_&nbsp;transactions.&nbsp;You&nbsp;only&nbsp;want&nbsp;to&nbsp;mark&nbsp;&lt;br&gt;<br>
transactions&nbsp;that&nbsp;also&nbsp;matched&nbsp;proxy_g1_ext_acl.&nbsp;That&nbsp;&quot;b&nbsp;only&nbsp;if&nbsp;a&quot;&nbsp;&lt;br&gt;<br>
logic&nbsp;is&nbsp;accomplished&nbsp;by&nbsp;using&nbsp;_both_&nbsp;ACLs&nbsp;in&nbsp;the&nbsp;same&nbsp;rule:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; http_access&nbsp;deny&nbsp;proxy_g1_ext_acl&nbsp;proxy_g1_ext_acl_mark&nbsp;!all&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;the&nbsp;above&nbsp;http_access&nbsp;rule&nbsp;(instead&nbsp;of&nbsp;the&nbsp;earlier&nbsp;two),&nbsp;Squid&nbsp;will&nbsp;&lt;br&gt;<br>
evaluate&nbsp;the&nbsp;external&nbsp;ACL,&nbsp;and,&nbsp;if&nbsp;it&nbsp;matches,&nbsp;Squid&nbsp;will&nbsp;also&nbsp;evaluate&nbsp;&lt;br&gt;<br>
the&nbsp;annotation-setting&nbsp;ACL.&nbsp;The&nbsp;whole&nbsp;rule&nbsp;will&nbsp;then&nbsp;be&nbsp;rejected&nbsp;due&nbsp;to&nbsp;&lt;br&gt;<br>
&quot;!all&quot;,&nbsp;but&nbsp;not&nbsp;until&nbsp;it&nbsp;annotates&nbsp;the&nbsp;transaction&nbsp;(if&nbsp;the&nbsp;external&nbsp;ACL&nbsp;&lt;br&gt;<br>
matches).&nbsp;Again,&nbsp;in&nbsp;this&nbsp;sketch,&nbsp;we&nbsp;are&nbsp;using&nbsp;this&nbsp;rule&nbsp;for&nbsp;its&nbsp;&lt;br&gt;<br>
annotation&nbsp;side&nbsp;effect&nbsp;only.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;And&nbsp;this&nbsp;works&nbsp;like&nbsp;I&nbsp;need&nbsp;now....&lt;br&gt;<br>
&lt;br&gt;<br>
AFAICT,&nbsp;if&nbsp;the&nbsp;tests&nbsp;indicate&nbsp;that&nbsp;this&nbsp;configuration&nbsp;works,&nbsp;then&nbsp;the&nbsp;&lt;br&gt;<br>
tests&nbsp;are&nbsp;broken.&nbsp;IMHO,&nbsp;you&nbsp;should&nbsp;fix&nbsp;the&nbsp;tests&nbsp;(while&nbsp;you&nbsp;have&nbsp;a&nbsp;&lt;br&gt;<br>
broken&nbsp;configuration&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;test&nbsp;the&nbsp;tests)&nbsp;before&nbsp;&lt;br&gt;<br>
proceeding&nbsp;with&nbsp;the&nbsp;configuration&nbsp;fix.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
P.S.&nbsp;Please&nbsp;keep&nbsp;this&nbsp;email&nbsp;thread&nbsp;on&nbsp;squid-users&nbsp;instead&nbsp;of&nbsp;responding&nbsp;&lt;br&gt;<br>
to&nbsp;me&nbsp;personally.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;ср,&nbsp;19&nbsp;апр.&nbsp;2023 г.&nbsp;в&nbsp;21:01,&nbsp;Alexeyяр&nbsp;Gruzdov:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; so,&nbsp;ok &nbsp;-&nbsp;Lets&nbsp;limit&nbsp;just&nbsp;to&nbsp;one&nbsp;cache&nbsp;peer&nbsp;and&nbsp;one&nbsp;single&nbsp;ACL&nbsp;(just&lt;br&gt;<br>
&gt; &nbsp; &nbsp; to&nbsp;understand&nbsp;the&nbsp;logic):&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; cache_peer&nbsp;peerG1.com&nbsp;parent&nbsp;40001&nbsp;0&nbsp;no-query&nbsp;no-digest&nbsp;name=peerG1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; external_acl_type&nbsp;ext_proxy_g1_type&nbsp;%LOGIN&nbsp;%DST&lt;br&gt;<br>
&gt; &nbsp; &nbsp; /usr/local/bin/g1.py &nbsp; (this&nbsp;will&nbsp;answer&nbsp;&quot;OK&quot; &nbsp;or&nbsp;&quot;ERR&quot;,&nbsp;depends&nbsp;if&lt;br&gt;<br>
&gt; &nbsp; &nbsp; user&nbsp;consists&nbsp;in&nbsp;DB)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; acl proxy_g1_ext_acl &nbsp;ext_proxy_g1_type annotate_transaction&lt;br&gt;<br>
&gt; &nbsp; &nbsp; proxy=g1 &nbsp; (If&nbsp;I&nbsp;right&nbsp;understood&nbsp;here&nbsp;is&nbsp;a&nbsp;key&nbsp;point&nbsp;of&nbsp;how&nbsp;to&nbsp;add&lt;br&gt;<br>
&gt; &nbsp; &nbsp; the&nbsp;tag&nbsp;to&nbsp;transaction&nbsp;related&nbsp;with&nbsp;user)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; acl&nbsp;proxy_peerG1_acl note&nbsp;proxy&nbsp;g1 &nbsp;(here&nbsp;we&nbsp;create&nbsp;the&nbsp;ACL&nbsp;based&lt;br&gt;<br>
&gt; &nbsp; &nbsp; on&nbsp;the&nbsp;tag&nbsp;and&nbsp;this&nbsp;is&nbsp;fast&nbsp;ACL&nbsp;yet&nbsp;and&nbsp;we&nbsp;should&nbsp;to&nbsp;use&nbsp;it&nbsp;in&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cache_peer_access)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; http_access&nbsp;deny&nbsp;proxy_g1_ext_acl&nbsp;!all&lt;br&gt;<br>
&gt; &nbsp; &nbsp; ......&lt;others&nbsp;http&nbsp;access&nbsp;rules&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cache_peer_access&nbsp;peerG1&nbsp;allow&nbsp;proxy_peerG1_acl&lt;br&gt;<br>
&gt; &nbsp; &nbsp; cache_peer_access&nbsp;peerG1&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Is&nbsp;that&nbsp;correct&nbsp;?&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; вт,&nbsp;18&nbsp;апр.&nbsp;2023 г.&nbsp;в&nbsp;23:44,&nbsp;Alex&nbsp;Rousskov&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;mailto:&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&gt;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; On&nbsp;4/18/23&nbsp;11:41,&nbsp;Alexeyяр&nbsp;Gruzdov&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;Could&nbsp;you&nbsp;explain&nbsp;me&nbsp;how&nbsp;the&nbsp;annotation&nbsp;transaction&nbsp;works&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; how&nbsp;it&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;related&nbsp;to&nbsp;acl&nbsp;that&nbsp;I&nbsp;could&nbsp;to&nbsp;use&nbsp;with&nbsp;cache_peers&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; Transactions&nbsp;have&nbsp;a&nbsp;(possibly&nbsp;empty)&nbsp;set&nbsp;of&nbsp;name=value&nbsp;annotations.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; During&nbsp;Squid&nbsp;configuration&nbsp;time,&nbsp;Squid&nbsp;parses&nbsp;all&nbsp;ACL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; declarations&nbsp;in&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; your&nbsp;configuration&nbsp;file.&nbsp;When&nbsp;Squid&nbsp;parses&nbsp;an&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotation_transaction&nbsp;ACL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; declaration,&nbsp;Squid&nbsp;remembers&nbsp;what&nbsp;transaction&nbsp;annotation&nbsp;to&nbsp;add&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; in&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; future,&nbsp;[every&nbsp;time]&nbsp;when&nbsp;that&nbsp;ACL&nbsp;is&nbsp;evaluated&nbsp;(e.g.,&nbsp;used&nbsp;in&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; http_access&nbsp;rule&nbsp;that&nbsp;Squid&nbsp;reaches&nbsp;during&nbsp;transaction&nbsp;processing).&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; When&nbsp;evaluated,&nbsp;an&nbsp;&quot;annotation_transaction&quot;&nbsp;ACL&nbsp;simply&nbsp;adds&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; previously&nbsp;configured&nbsp;annotation&nbsp;to&nbsp;the&nbsp;current&nbsp;transaction&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; returns&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; a&nbsp;&quot;yes,&nbsp;this&nbsp;transaction&nbsp;matches&quot;&nbsp;result.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; When&nbsp;evaluated,&nbsp;a&nbsp;&quot;note&quot;&nbsp;ACL&nbsp;returns&nbsp;a&nbsp;&quot;yes,&nbsp;this&nbsp;transaction&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; matches&quot;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; result&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;current&nbsp;transaction&nbsp;already&nbsp;has&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; matching&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotation.&nbsp;This&nbsp;ACL&nbsp;does&nbsp;not&nbsp;modify&nbsp;the&nbsp;set&nbsp;of&nbsp;transaction&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotations.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; The&nbsp;combination&nbsp;of&nbsp;annotate_transaction&nbsp;and&nbsp;note&nbsp;ACLs&nbsp;allows&nbsp;you&nbsp;to&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotate&nbsp;a&nbsp;transaction&nbsp;at&nbsp;one&nbsp;time&nbsp;and&nbsp;check&nbsp;previously&nbsp;set&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; transaction&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotations&nbsp;at&nbsp;another&nbsp;time.&nbsp;The&nbsp;timing&nbsp;and&nbsp;meaning&nbsp;of&nbsp;those&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotations&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; are&nbsp;up&nbsp;to&nbsp;you.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;ok!&nbsp;Lets&nbsp;look&nbsp;to&nbsp;my&nbsp;case&nbsp;example:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;cache_peer&nbsp;peerG1.com&nbsp;parent&nbsp;40001&nbsp;0&nbsp;no-query&nbsp;no-digest&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; name=peerG1 round-robin&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;cache_peer_access &nbsp;peerG1&nbsp;allow&nbsp;proxy_peerG1_acl&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;cache_peer_access &nbsp;peerG1&nbsp;allow&nbsp;proxy_all_acl&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;cache_peer_access &nbsp;peerG1&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;acl&nbsp;proxy_peerG1_acl &nbsp;proxy_auth &nbsp;&quot;../users.peerG1.txt&quot;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;acl&nbsp;proxy_all_acl &nbsp;proxy_auth &nbsp;&quot;../users.all.txt&quot;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; [&nbsp;I&nbsp;added&nbsp;the&nbsp;missing&nbsp;&quot;acl&nbsp;&quot;&nbsp;directive&nbsp;to&nbsp;the&nbsp;above&nbsp;ACL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; declarations&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; stripped&nbsp;rules&nbsp;for&nbsp;two&nbsp;out&nbsp;of&nbsp;three&nbsp;cache_peers&nbsp;]&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; As&nbsp;you&nbsp;know,&nbsp;the&nbsp;above&nbsp;cache_peer_access&nbsp;configuration&nbsp;is&nbsp;not&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; supported&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; because&nbsp;it&nbsp;uses&nbsp;&quot;slow&quot;&nbsp;proxy_auth&nbsp;ACLs&nbsp;in&nbsp;cache_peer_access&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; directives&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; that&nbsp;only&nbsp;support&nbsp;&quot;fast&quot;&nbsp;ACLs.&nbsp;It&nbsp;does&nbsp;not&nbsp;matter&nbsp;(to&nbsp;me),&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; whether&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; above&nbsp;appears&nbsp;to&nbsp;&quot;work&quot;&nbsp;in&nbsp;some&nbsp;environments.&nbsp;YMMV.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; To&nbsp;fix&nbsp;this&nbsp;problem,&nbsp;we&nbsp;can&nbsp;use&nbsp;http_access&nbsp;rules&nbsp;to&nbsp;essentially&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; remember&nbsp;proxy_auth&nbsp;evaluation&nbsp;results&nbsp;(at&nbsp;http_access&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; evaluation&nbsp;time)&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; as&nbsp;transaction&nbsp;annotations.&nbsp;Here&nbsp;is&nbsp;an&nbsp;untested&nbsp;sketch&nbsp;that&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; omits&nbsp;other&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; (important&nbsp;but&nbsp;irrelevant&nbsp;here)&nbsp;http_access&nbsp;rules&nbsp;and&nbsp;assumes&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; that&nbsp;these&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; sketched&nbsp;http_access&nbsp;rules&nbsp;_are_&nbsp;evaluated:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;if&nbsp;proxy_peerG1_acl&nbsp;matches,&nbsp;evaluate&nbsp;mark_for_peerG1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http_access&nbsp;deny&nbsp;proxy_peerG1_acl&nbsp;mark_for_peerG1&nbsp;!all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;if&nbsp;proxy_all_acl&nbsp;matches,&nbsp;evaluate&nbsp;mark_for_all_peers&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http_access&nbsp;deny&nbsp;proxy_all_acl&nbsp;mark_for_all_peers&nbsp;!all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; Now&nbsp;we&nbsp;can&nbsp;use&nbsp;those&nbsp;remembered&nbsp;proxy_...&nbsp;acl&nbsp;evaluation&nbsp;results&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; (i.e.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; we&nbsp;can&nbsp;check&nbsp;for&nbsp;the&nbsp;matching&nbsp;annotations)&nbsp;in&nbsp;cache_peer_access&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; rules:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache_peer_access&nbsp;peerG1&nbsp;allow&nbsp;marked_for_peerG1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache_peer_access&nbsp;peerG1&nbsp;allow&nbsp;marked_for_all_peers&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cache_peer_access&nbsp;peerG1&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; where&nbsp;the&nbsp;new&nbsp;ACLs&nbsp;mentioned&nbsp;above&nbsp;are&nbsp;declared&nbsp;along&nbsp;these&nbsp;lines:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl&nbsp;mark_for_peerG1&nbsp;annotate_transaction&nbsp;for_peer_=G1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl&nbsp;mark_for_all_peers&nbsp;annotate_transaction&nbsp;for_all_peers_=true&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl&nbsp;marked_for_peerG1&nbsp;note&nbsp;for_peer_&nbsp;G1&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl&nbsp;marked_for_all_peers&nbsp;note&nbsp;for_all_peers_&nbsp;true&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; This&nbsp;can&nbsp;probably&nbsp;be&nbsp;simplified&nbsp;further&nbsp;by&nbsp;using&nbsp;for_peer_=ALL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; instead&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; of&nbsp;for_all_peers_=true&nbsp;annotation,&nbsp;but&nbsp;I&nbsp;wanted&nbsp;to&nbsp;preserve&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; symmetry&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; with&nbsp;your&nbsp;original&nbsp;configuration.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;And&nbsp;these&nbsp;all&nbsp;works&nbsp;like&nbsp;I&nbsp;need,&nbsp;But&nbsp;-&nbsp;once&nbsp;I&nbsp;am&nbsp;changing&nbsp;a&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; list&nbsp;of&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;users&nbsp;(add&nbsp;or&nbsp;remove)&nbsp;-&nbsp;I&nbsp;need&nbsp;to&nbsp;use&nbsp;&quot;squid&nbsp;-k&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; reconfigure&quot;......&nbsp;but&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&gt;&nbsp;of&nbsp;course&nbsp;better&nbsp;to&nbsp;go&nbsp;without&nbsp;this&nbsp;reconfigure&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; One&nbsp;can&nbsp;avoid&nbsp;reconfiguration&nbsp;using&nbsp;an&nbsp;external&nbsp;ACL&nbsp;script&nbsp;that&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; gives&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; Squid&nbsp;the&nbsp;right&nbsp;for_peer_=...&nbsp;annotations&nbsp;(instead&nbsp;of&nbsp;using&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &quot;constant&quot;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp;&quot;hard-coded&quot;&nbsp;annotate_transaction&nbsp;ACLs&nbsp;to&nbsp;store&nbsp;the&nbsp;same&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; annotations).&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; However,&nbsp;it&nbsp;may&nbsp;be&nbsp;better&nbsp;to&nbsp;make&nbsp;the&nbsp;above&nbsp;sketch&nbsp;to&nbsp;work&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; _before_&nbsp;you&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; replace&nbsp;mark_for_peerG1&nbsp;ACLs/rules&nbsp;with&nbsp;an&nbsp;external&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; mark_for_the_right_peer&nbsp;ACL.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; HTH,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; Alex.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; P.S.&nbsp;This&nbsp;thread&nbsp;continues&nbsp;the&nbsp;discussion&nbsp;started&nbsp;at&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;https://bugs.squid-cache.org/show_bug.cgi?id=5268&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugs.squid-cache.org/show_bug.cgi?id=5268&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;https://bugs.squid-cache.org/show_bug.cgi?id=5268&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugs.squid-cache.org/show_bug.cgi?id=5268&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; _______________________________________________&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;mailto:&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;http://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; --&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; С&nbsp;уважением&nbsp;к&nbsp;Вам&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Алексей&lt;br&gt;<br>
&gt; &nbsp; &nbsp; +79043828661&lt;br&gt;<br>
&gt; &nbsp; &nbsp; 620000&nbsp;г.Екатеринбург&nbsp; 2022&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;--&nbsp;&lt;br&gt;<br>
&gt;&nbsp;С&nbsp;уважением&nbsp;к&nbsp;Вам&lt;br&gt;<br>
&gt;&nbsp;Алексей&lt;br&gt;<br>
&gt;&nbsp;+79043828661&lt;br&gt;<br>
&gt;&nbsp;620000&nbsp;г.Екатеринбург&nbsp; 2022&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;gmail_signature_prefix&quot;&gt;--&nbsp;&lt;/span&gt;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_signature&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;С&nbsp;уважением&nbsp;к&nbsp;Вам&lt;div&gt;Алексей&lt;br&gt;+79043828661&lt;br&gt;&lt;div&gt;620000&nbsp;г.Екатеринбург&nbsp; 2022&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
