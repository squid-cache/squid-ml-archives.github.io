<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#464646&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;have&nbsp;a&nbsp;&quot;problem&quot;&nbsp;with&nbsp;ACLs,&nbsp;and&nbsp;I&nbsp;don't&nbsp;know&nbsp;how&nbsp;to&nbsp;address&nbsp;this<br>
&nbsp;&nbsp;&nbsp;&nbsp;situation&nbsp;in&nbsp;Squid&nbsp;5.8&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Let&nbsp;me&nbsp;explain:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;have&nbsp;an&nbsp;Active&nbsp;Directory&nbsp;group&nbsp;named&nbsp;limited_users&nbsp;that&nbsp;is&nbsp;only<br>
&nbsp;&nbsp;&nbsp;&nbsp;allowed&nbsp;to&nbsp;surf&nbsp;on&nbsp;a&nbsp;very&nbsp;limited&nbsp;list&nbsp;of&nbsp;websites.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;users&nbsp;are&nbsp;therefore&nbsp;forbidden&nbsp;to&nbsp;surf&nbsp;on&nbsp;all&nbsp;sites&nbsp;not&nbsp;listed<br>
&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;allowed_domains&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;we&nbsp;have&nbsp;websites&nbsp;in&nbsp;noauth_sites&nbsp;that&nbsp;do&nbsp;not&nbsp;need<br>
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;be&nbsp;authenticated&nbsp;by&nbsp;squid&nbsp;but&nbsp;are&nbsp;not&nbsp;allowed&nbsp;to&nbsp;be&nbsp;used&nbsp;by<br>
&nbsp;&nbsp;&nbsp;&nbsp;limited_users&nbsp;group&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;logic,&nbsp;we&nbsp;would&nbsp;write&nbsp;the&nbsp;following&nbsp;ACLs.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;class=&quot;moz-signature&quot;&nbsp;cols=&quot;72&quot;&gt;external_acl_type&nbsp;ads_group&nbsp;ttl=3600&nbsp;negative_ttl=1&nbsp;concurrency=50&nbsp;children-startup=1&nbsp;children-idle=1&nbsp;children-max=20&nbsp;ipv4&nbsp;%LOGIN&nbsp;/lib/squid3/groups.pl<br>
<br>
acls&nbsp;limited_users&nbsp;ads_group&nbsp;limited_users<br>
acls&nbsp;allowed_domains&nbsp;dstdomain&nbsp;siteallowed.com<br>
acls&nbsp;allowed_domains&nbsp;dstdomain&nbsp;siteallowed.fr<br>
acls&nbsp;allowed_domains&nbsp;dstdomain&nbsp;siteallowed.ch<br>
<br>
acls&nbsp;noauth_sites&nbsp;dstdomain&nbsp;office365.com<br>
<br>
<br>
http_access&nbsp;deny&nbsp;!allowed_domains&nbsp;limited_users&nbsp;all&nbsp;#ACL1<br>
http_access&nbsp;allow&nbsp;noauth_sites&nbsp;#ACL2&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;But&nbsp;in&nbsp;this&nbsp;case,&nbsp;accessing&nbsp;to&nbsp;office365.com&nbsp;force&nbsp;Squid&nbsp;to&nbsp;send&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;407&nbsp;Authentication &nbsp;request&nbsp;in&nbsp;order&nbsp;to&nbsp;calculate&nbsp;the&nbsp;limited_users<br>
&nbsp;&nbsp;&nbsp;&nbsp;in &nbsp;#ACL1,&nbsp;then&nbsp;the&nbsp;second&nbsp;ACL&nbsp;is&nbsp;not&nbsp;effective&nbsp;because&nbsp;the&nbsp;request<br>
&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;blocked&nbsp;before&nbsp;by&nbsp;the&nbsp;407.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;%LOGIN&nbsp;switch&nbsp;in&nbsp;the&nbsp;external&nbsp;ACL&nbsp;ads_group&nbsp;activates&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;identification&nbsp;mode.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;we&nbsp;use&nbsp;the&nbsp;%un&nbsp;switch&nbsp;instead&nbsp;,&nbsp;it&nbsp;works&nbsp;but&nbsp;it&nbsp;becomes&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;counter,&nbsp;ACL#1&nbsp;is&nbsp;not&nbsp;processed&nbsp;anymore&nbsp;since&nbsp;the&nbsp;authentication&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;not&nbsp;requested&nbsp;because&nbsp;the&nbsp;%un&nbsp;switch&nbsp;is&nbsp;too&nbsp;smooth.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;What&nbsp;I&nbsp;don't&nbsp;understand&nbsp;is&nbsp;that&nbsp;SQUID&nbsp;is&nbsp;trying&nbsp;to&nbsp;calculate&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;limited_user&nbsp;object&nbsp;when&nbsp;the&nbsp;first&nbsp;allowed_domain&nbsp;object&nbsp;already<br>
&nbsp;&nbsp;&nbsp;&nbsp;returns&nbsp;FALSE.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Whatever&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;objects&nbsp;that&nbsp;follow&nbsp;allowed_domain,&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;rule&nbsp;will&nbsp;always&nbsp;fail.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;the&nbsp;case&nbsp;where&nbsp;limited_user&nbsp;is&nbsp;in&nbsp;the&nbsp;first&nbsp;place,&nbsp;the&nbsp;logic&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;correct.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Two&nbsp;questions:&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;for&nbsp;SQUID&nbsp;to&nbsp;not&nbsp;compute&nbsp;all&nbsp;http_access&nbsp;objects &nbsp;if<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;first&nbsp;one&nbsp;fails?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;What&nbsp;would&nbsp;be&nbsp;the&nbsp;best&nbsp;rule&nbsp;that&nbsp;could&nbsp;meet&nbsp;this&nbsp;goal?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;regards&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
