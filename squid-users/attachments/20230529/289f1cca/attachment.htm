<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;need&nbsp;to&nbsp;configure&nbsp;a&nbsp;dedicated&nbsp;proxy&nbsp;server&nbsp;to&nbsp;provide&nbsp;caching&nbsp;of&nbsp;online&nbsp;video&nbsp;broadcasts&nbsp;in&nbsp;order&nbsp;to&nbsp;reduce&nbsp;the&nbsp;load&nbsp;on&nbsp;the&nbsp;uplink&nbsp;proxy.&lt;br&gt;&lt;/div&gt;&lt;div&gt;Hundreds&nbsp;of&nbsp;users&nbsp;will&nbsp;access&nbsp;the&nbsp;same&nbsp;video-chunks&nbsp;simultaneously.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;developed&nbsp;a&nbsp;simple&nbsp;configuration&nbsp;for&nbsp;the&nbsp;test&nbsp;purposes&nbsp;(it&nbsp;is&nbsp;shown&nbsp;below).&lt;br&gt;&lt;/div&gt;&lt;div&gt;The &lt;b&nbsp;style=&quot;font-family:monospace&quot;&gt;collapsed_forwarding&lt;/b&gt; option&nbsp;is&nbsp;on.&lt;/div&gt;&lt;div&gt;I&nbsp;selected&nbsp;a&nbsp;couple&nbsp;of&nbsp;cacheable&nbsp;resources&nbsp;in&nbsp;the&nbsp;internet&nbsp;for&nbsp;testing:&lt;/div&gt;&lt;div&gt; -&nbsp;small&nbsp;size&nbsp;(~400&nbsp;KB): &lt;a&nbsp;href=&quot;https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf&quot;&gt;https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf&lt;/a&gt;&lt;/div&gt;&lt;div&gt; -&nbsp;large&nbsp;(~8&nbsp;MB): &lt;a&nbsp;href=&quot;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&quot;&gt;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&lt;/a&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;test&nbsp;simultaneous&nbsp;connections&nbsp;I&nbsp;am&nbsp;forking&nbsp;curl&nbsp;using&nbsp;a&nbsp;simple&nbsp;script&nbsp;(it&nbsp;is&nbsp;also&nbsp;shown&nbsp;below).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;I&nbsp;run&nbsp;a&nbsp;test&nbsp;(500&nbsp;curl&nbsp;threads&nbsp;to&nbsp;&lt;a&nbsp;href=&quot;https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf&quot;&gt;https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf&lt;/a&gt;)&nbsp;I&nbsp;see&nbsp;lots&nbsp;of TCP_MISS/200&nbsp;with FIRSTUP_PARENT/parent_proxy&nbsp;records&nbsp;in&nbsp;the&nbsp;logs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;simple&nbsp;analysis&nbsp;shows a&nbsp;low&nbsp;percentage&nbsp;of&nbsp;cache&nbsp;hits:&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;14&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; 24&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp;457&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; 10&nbsp;TCP_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; &nbsp;9&nbsp;TCP_SWAPFAIL_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;Hit&nbsp;ratio&nbsp;is&nbsp;about&nbsp;(500-457-9)*100/500=6.8%&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Almost&nbsp;the&nbsp;same&nbsp;situation&nbsp;we&nbsp;see&nbsp;when&nbsp;run&nbsp;200&nbsp;threads:&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;15:45&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; &nbsp;4&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp;140&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; 40&nbsp;TCP_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; 16&nbsp;TCP_SWAPFAIL_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;time&nbsp;the&nbsp;Hit&nbsp;ratio&nbsp;is&nbsp;about&nbsp;(200-140-16)*100/500=21%&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;50&nbsp;threads&nbsp;the&nbsp;Hit&nbsp;ratio&nbsp;is&nbsp;90%:&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;15:50&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; 27&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; &nbsp;1&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; 18&nbsp;TCP_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; &nbsp;4&nbsp;TCP_SWAPFAIL_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;thought&nbsp;that&nbsp;it&nbsp;should&nbsp;always&nbsp;be&nbsp;near&nbsp;99%&nbsp;-&nbsp;only&nbsp;the&nbsp;first&nbsp;request&nbsp;to&nbsp;an&nbsp;URL&nbsp;should&nbsp;be&nbsp;forwarded&nbsp;to&nbsp;the&nbsp;parent&nbsp;proxy&nbsp;and&nbsp;all&nbsp;subsequent&nbsp;requests&nbsp;should&nbsp;be&nbsp;served&nbsp;from&nbsp;the&nbsp;cache.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;situation&nbsp;is&nbsp;even&nbsp;worse&nbsp;with&nbsp;downloading&nbsp;a&nbsp;large&nbsp;file:&lt;br&gt;&lt;/div&gt;&lt;div&gt;500&nbsp;threads&nbsp;(0.4%):&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;17:2&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; 10&nbsp;TCP_CF_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; &nbsp;2&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp;488&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;200&nbsp;threads&nbsp;(3%):&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;17:3&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; &nbsp;9&nbsp;TCP_CF_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; &nbsp;6&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp;180&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;br&gt; &nbsp; &nbsp; &nbsp;5&nbsp;TCP_SWAPFAIL_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;50&nbsp;threads&nbsp;(98%):&lt;/div&gt;&lt;div&gt; &lt;font&nbsp;face=&quot;monospace&quot;&gt;cat&nbsp;/var/log/squid.user/access.log|&nbsp;grep&nbsp;&#39;2023-05-29&nbsp;17:36&#39;&nbsp;|&nbsp;grep&nbsp;pdf&nbsp; |&nbsp;awk&nbsp;&#39;{print&nbsp;$5&quot;&nbsp;&quot;&nbsp;$10}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&lt;br&gt; &nbsp; &nbsp; 25&nbsp;TCP_CF_HIT/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; 12&nbsp;TCP_CF_MISS/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; 12&nbsp;TCP_HIT/200/-&nbsp;HIER_NONE/-&lt;br&gt; &nbsp; &nbsp; &nbsp;1&nbsp;TCP_MISS/200/200&nbsp;FIRSTUP_PARENT/parent_proxy&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Could&nbsp;you&nbsp;clarify&nbsp;if&nbsp;this&nbsp;behavior&nbsp;of&nbsp;my&nbsp;squid&nbsp;is&nbsp;a&nbsp;bug/misconfiguration,&nbsp;or&nbsp;if&nbsp;I&#39;m&nbsp;running&nbsp;into&nbsp;server&nbsp;performance&nbsp;limitations&nbsp;(squid&nbsp;is&nbsp;running&nbsp;on&nbsp;a&nbsp;VM&nbsp;with&nbsp;22&nbsp;cores)?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Kind&nbsp;regards,&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; Ankor&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;squid.conf:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;workers&nbsp;21&lt;br&gt;&lt;br&gt;sslcrtd_program&nbsp;/data/squid.user/usr/lib/squid/security_file_certgen&nbsp;-s&nbsp;/data/squid.user/var/lib/squid/ssl_db&nbsp;-M&nbsp;20MB&lt;br&gt;sslcrtd_children&nbsp;21&lt;br&gt;&lt;br&gt;logformat&nbsp;extended-squid&nbsp;%{%Y-%m-%d&nbsp;%H:%M:%S}tl|&nbsp;%6tr&nbsp;%&gt;a&nbsp;%Ss/%03&gt;Hs/%&lt;Hs&nbsp;%&lt;st&nbsp;%rm&nbsp;%ru&nbsp;%un&nbsp;%Sh/%&lt;A&nbsp;%mt&nbsp;%ea&lt;br&gt;&lt;br&gt;logfile_rotate&nbsp;0&lt;br&gt;access_log&nbsp;daemon:/var/log/squid.user/access.log&nbsp;logformat=extended-squid&nbsp;on-error=drop&lt;br&gt;&lt;br&gt;cache_peer&nbsp;parent_proxy&nbsp; parent&nbsp;3128&nbsp;0&lt;br&gt;never_direct&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;cachemgr_passwd&nbsp;pass&nbsp;config&lt;br&gt;&lt;br&gt;acl&nbsp;PURGE&nbsp;method&nbsp;PURGE&lt;br&gt;http_access&nbsp;allow&nbsp;PURGE&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;http_access&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;http_port&nbsp;3131&nbsp;ssl-bump&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=20MB&nbsp;tls-cert=/etc/squid.user/sslbump/bump.crt&nbsp;tls-key=/etc/squid.user/sslbump/bump.key&lt;br&gt;sslproxy_cert_error&nbsp;allow&nbsp;all&lt;br&gt;&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;acl&nbsp;step2&nbsp;at_step&nbsp;SslBump2&lt;br&gt;acl&nbsp;step3&nbsp;at_step&nbsp;SslBump3&lt;br&gt;&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;bump&nbsp;step2&lt;br&gt;ssl_bump&nbsp;bump&nbsp;step3&lt;br&gt;&lt;br&gt;cache_dir&nbsp;rock&nbsp;/data/squid.user/cache&nbsp;20000&nbsp;max-size=12000000&lt;br&gt;cache_swap_low&nbsp;85&lt;br&gt;cache_swap_high&nbsp;90&lt;br&gt;&lt;br&gt;&lt;b&gt;collapsed_forwarding&nbsp;on&lt;/b&gt;&lt;br&gt;&lt;br&gt;pinger_enable&nbsp;off&lt;br&gt;max_filedesc&nbsp;8192&lt;br&gt;shutdown_lifetime&nbsp;5&nbsp;seconds&lt;br&gt;netdb_filename&nbsp;none&lt;br&gt;log_icp_queries&nbsp;off&lt;br&gt;client_request_buffer_max_size&nbsp;100&nbsp;MB&lt;br&gt;&lt;br&gt;via&nbsp;off&lt;br&gt;forwarded_for&nbsp;delete&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;coredump_dir&nbsp;/data/squid.user/var/cache/squid&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;curl_forker.sh:&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;#!/bin/sh&lt;br&gt;N=100&lt;br&gt;URL=&lt;a&nbsp;href=&quot;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&quot;&gt;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&lt;/a&gt;&lt;br&gt;&lt;br&gt;if&nbsp;[[&nbsp; -n&nbsp;$1&nbsp;&amp;&amp;&nbsp; $1&nbsp;=~&nbsp;help$&nbsp; ]];&lt;br&gt;then&lt;br&gt; &nbsp; echo&nbsp;&quot;Usage:&nbsp;$0&nbsp;[&lt;cnt&gt;]&nbsp;[&lt;url&gt;]&quot;&lt;br&gt; &nbsp; echo&lt;br&gt; &nbsp; echo&nbsp;&quot;Example:&nbsp;$0&nbsp;10&nbsp;&lt;a&nbsp;href=&quot;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&quot;&gt;https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf&lt;/a&gt;&quot;;&lt;br&gt; &nbsp; echo&lt;br&gt; &nbsp; exit;&lt;br&gt;fi&lt;br&gt;&lt;br&gt;while&nbsp;[[&nbsp;$#&nbsp;-gt&nbsp;0&nbsp;]]&lt;br&gt;do&lt;br&gt; &nbsp;if&nbsp;[[&nbsp;$1&nbsp;=~&nbsp;^[0-9]+$&nbsp;]]&lt;br&gt; &nbsp;then&lt;br&gt; &nbsp; &nbsp; N=$1&lt;br&gt; &nbsp;else&lt;br&gt; &nbsp; &nbsp; URL=$1&lt;br&gt; &nbsp;fi&lt;br&gt; &nbsp;shift&lt;br&gt;done&lt;br&gt;&lt;br&gt;echo&nbsp;$URL&lt;br&gt;echo&nbsp;$N&nbsp;threads&lt;br&gt;&lt;br&gt;for&nbsp;i&nbsp;in&nbsp;`seq&nbsp;$N`&lt;br&gt;do&lt;br&gt; &nbsp;nohup&nbsp;curl&nbsp;--tlsv1.2&nbsp;-k&nbsp; &nbsp;--proxy&nbsp;0001vsg01:3131&nbsp; -v&nbsp;$URL&nbsp; &gt;/dev/null&nbsp; 2&gt;&amp;1&nbsp;&amp;&lt;br&gt;done&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
