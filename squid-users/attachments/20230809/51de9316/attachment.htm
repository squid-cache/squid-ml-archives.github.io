<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=UTF-8&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&gt;<br>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;Hi,&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;we&nbsp;have&nbsp;been&nbsp;having&nbsp;some&nbsp;issues&nbsp;lately&nbsp;with&nbsp;our&nbsp;Squid&nbsp;proxies&nbsp;on&nbsp;version&nbsp;6.1.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;We&nbsp;also&nbsp;have&nbsp;the&nbsp;patch&nbsp;for&nbsp;the&nbsp;REQMOD&nbsp;satisfaction&nbsp;regression&nbsp;installed:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/squid-cache/squid/pull/1400&quot;&gt;https://github.com/squid-cache/squid/pull/1400&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;The&nbsp;issue:&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;When&nbsp;there&nbsp;is&nbsp;a&nbsp;request&nbsp;sent&nbsp;to&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;and&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;is&nbsp;replying&nbsp;with&nbsp;a&nbsp;modified&nbsp;response,&nbsp;this&nbsp;modified&nbsp;response,&nbsp;after&nbsp;checking&nbsp;through&nbsp;receivedWholeAdeptedReply,&nbsp;doesn't&nbsp;set&nbsp;a&nbsp;BAD_LENGTH,&nbsp;which&nbsp;usually&nbsp;turns&nbsp;into&nbsp;a&nbsp;STREAM_UNPLANNED_COMPLETE,&nbsp;but&nbsp;rather&nbsp;a&nbsp;STREAM_COMPLETE&nbsp;(in&nbsp;Http::Stream::writeComplete).&nbsp;This&nbsp;in&nbsp;turn&nbsp;calls&nbsp;ConnStateData::kick&nbsp;on&nbsp;the&nbsp;current&nbsp;context,&nbsp;which&nbsp;has&nbsp;an&nbsp;empty&nbsp;pipeline&nbsp;at&nbsp;some&nbsp;point.&nbsp;Because&nbsp;this&nbsp;case&nbsp;is&nbsp;not&nbsp;specifically&nbsp;checked&nbsp;and&nbsp;the&nbsp;connection&nbsp;is&nbsp;just&nbsp;abandoned,&nbsp;the&nbsp;socket&nbsp;is&nbsp;never&nbsp;removed.&nbsp;This&nbsp;causes&nbsp;a&nbsp;lot&nbsp;of&nbsp;open&nbsp;connections&nbsp;and&nbsp;a&nbsp;high&nbsp;amount&nbsp;of&nbsp;file&nbsp;descriptors&nbsp;for&nbsp;the&nbsp;corresponding&nbsp;squid&nbsp;processes&nbsp;that&nbsp;we&nbsp;frequently&nbsp;run&nbsp;into&nbsp;limits.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;As&nbsp;a&nbsp;hot&nbsp;fix&nbsp;I&nbsp;made&nbsp;the&nbsp;following&nbsp;changes&nbsp;in&nbsp;order&nbsp;to&nbsp;accommodate&nbsp;for&nbsp;this&nbsp;specific&nbsp;case:&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;---&nbsp;a/src/client_side.cc&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;+++&nbsp;a/src/client_side.cc&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;@@&nbsp;-989,6&nbsp;+989,9&nbsp;@@&nbsp;ConnStateData::kick()&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(flags.readMore)&nbsp;{&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(33,&nbsp;3,&nbsp;clientConnection&nbsp;&lt;&lt;&nbsp;&quot;:&nbsp;calling&nbsp;readNextRequest()&quot;);&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readNextRequest();&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;+&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(pipeline.empty())&nbsp;{&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(33,&nbsp;3,&nbsp;&quot;pipeline&nbsp;is&nbsp;empty&nbsp;-&nbsp;closing&nbsp;connection&quot;);&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientConnection-&gt;close();&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;XXX:&nbsp;Can&nbsp;this&nbsp;happen?&nbsp;CONNECT&nbsp;tunnels&nbsp;have&nbsp;deferredRequest&nbsp;set.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugs(33,&nbsp;DBG_IMPORTANT,&nbsp;MYNAME&nbsp;&lt;&lt;&nbsp;&quot;abandoning&nbsp;&quot;&nbsp;&lt;&lt;&nbsp;clientConnection);&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;This&nbsp;issue&nbsp;also&nbsp;seems&nbsp;to&nbsp;happen&nbsp;if&nbsp;the&nbsp;ICAP&nbsp;server&nbsp;has&nbsp;specific&nbsp;responses&nbsp;-&nbsp;it&nbsp;seems&nbsp;as&nbsp;if&nbsp;the&nbsp;STREAM_COMPLETE&nbsp;case&nbsp;happens&nbsp;(implying&nbsp;receivedWholeAdaptedReply)&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;Connection:&nbsp;closed&nbsp;response&nbsp;from&nbsp;ICAP,&nbsp;rather&nbsp;than&nbsp;Connection:&nbsp;keep-alive.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;the&nbsp;connection&nbsp;is&nbsp;torn&nbsp;down&nbsp;with&nbsp;a&nbsp;STREAM_UNPLANNED_COMPLETE.&nbsp;The&nbsp;patch,&nbsp;setting&nbsp;receivedWholeAdaptedReply&nbsp;always&nbsp;to&nbsp;true&nbsp;in&nbsp;those&nbsp;cases&nbsp;also&nbsp;means&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;never&nbsp;closed&nbsp;and&nbsp;abandoned&nbsp;all&nbsp;the&nbsp;time&nbsp;if&nbsp;it&nbsp;includes&nbsp;REQMOD&nbsp;it&nbsp;seems,&nbsp;rather&nbsp;than&nbsp;just&nbsp;doing&nbsp;that&nbsp;if&nbsp;the&nbsp;response&nbsp;from&nbsp;ICAP&nbsp;implies&nbsp;a&nbsp;closed&nbsp;connection.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;I&nbsp;was&nbsp;not&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue&nbsp;with&nbsp;version&nbsp;5.8&nbsp;as&nbsp;of&nbsp;now,&nbsp;so&nbsp;this&nbsp;seems&nbsp;to&nbsp;be&nbsp;something&nbsp;specific&nbsp;to&nbsp;6.1.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Do&nbsp;you&nbsp;have&nbsp;any&nbsp;remarks&nbsp;on&nbsp;the&nbsp;change?&nbsp;Maybe&nbsp;you&nbsp;have&nbsp;some&nbsp;more&nbsp;insight&nbsp;on&nbsp;the&nbsp;interplay&nbsp;of&nbsp;the&nbsp;code&nbsp;or&nbsp;what&nbsp;seems&nbsp;to&nbsp;be&nbsp;causing&nbsp;the&nbsp;issue&nbsp;in&nbsp;detail.&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Sincerely,&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;Leonardo&nbsp;Martinho&lt;br&gt;&lt;/div&gt;&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
