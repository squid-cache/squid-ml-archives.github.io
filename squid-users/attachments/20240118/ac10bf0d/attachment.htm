<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&nbsp;Hoping&nbsp;someone&nbsp;can&nbsp;help&nbsp;me&nbsp;with&nbsp;this&nbsp;issue&nbsp;that&nbsp;I&nbsp;have&nbsp;been&nbsp;struggling&nbsp;with&nbsp;for&nbsp;days&nbsp;now.&nbsp; &nbsp;I&nbsp;am&nbsp;setting&nbsp;up&nbsp;squid&nbsp;on&nbsp;an&nbsp;ubuntu&nbsp;PC&nbsp;to&nbsp;forward&nbsp;HTTPS&nbsp;requests&nbsp;to&nbsp;an&nbsp;API&nbsp;and&nbsp;an&nbsp;s3&nbsp;bucket&nbsp;under&nbsp;my&nbsp;control&nbsp;on&nbsp;amazon&nbsp;AWS. &nbsp;The&nbsp;reason&nbsp;I&nbsp;am&nbsp;setting&nbsp;up&nbsp;the&nbsp;proxy&nbsp;is&nbsp;two-fold...&lt;br&gt;&lt;br&gt;1)&nbsp;To&nbsp;reduce&nbsp;costs&nbsp;from&nbsp;AWS.&lt;br&gt;2)&nbsp;To&nbsp;provide&nbsp;content&nbsp;to&nbsp;the&nbsp;client&nbsp;on&nbsp;the&nbsp;ubuntu&nbsp;PC&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;networking&nbsp;issue&nbsp;somewhere&nbsp;in&nbsp;between&nbsp;the&nbsp;ubuntu&nbsp;PC&nbsp;and&nbsp;AWS.&lt;br&gt;&lt;br&gt;Item&nbsp;1&nbsp;is&nbsp;going&nbsp;well&nbsp;so&nbsp;far.&nbsp; &nbsp;Item&nbsp;2&nbsp;is&nbsp;not&nbsp;going&nbsp;well.&nbsp; &nbsp;Setup&nbsp;details&nbsp;...&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;squid&nbsp;-&nbsp;setup&nbsp;cache&nbsp;folder&lt;/b&gt;&lt;br&gt;mkdir&nbsp;-p&nbsp;/var/cache/squid&lt;br&gt;chown&nbsp;-R&nbsp;proxy:proxy&nbsp; /var/cache/squid&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;ssl&nbsp;-&nbsp;generate&nbsp;key&lt;/b&gt;&lt;br&gt;apt&nbsp;--yes&nbsp;install&nbsp;squid-openssl&nbsp;libnss3-tools&lt;br&gt;openssl&nbsp;req&nbsp;-new&nbsp;-newkey&nbsp;rsa:2048&nbsp;-days&nbsp;365&nbsp;-nodes&nbsp;-x509&nbsp;\&lt;br&gt; &nbsp;-subj&nbsp;&quot;/C=US/ST=Denial/L=Springfield/O=Dis/CN=&lt;a&nbsp;href=&quot;http://www.example.com&quot;&gt;www.example.com&lt;/a&gt;&quot;&nbsp;\&lt;br&gt; &nbsp;-keyout&nbsp;/etc/squid/stuff.pem&nbsp;-out&nbsp;/etc/squid/stuff.pem&lt;br&gt;chown&nbsp;root:proxy&nbsp;/etc/squid/stuff.pem&nbsp;&lt;br&gt;chmod&nbsp;644&nbsp; /etc/squid/stuff.pem&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;ssl&nbsp;-&nbsp;ssl&nbsp;DB&lt;/b&gt;&lt;br&gt;mkdir&nbsp;-p&nbsp;/var/lib/squid&lt;br&gt;rm&nbsp;-rf&nbsp;/var/lib/squid/ssl_db&lt;br&gt;/usr/lib/squid/security_file_certgen&nbsp;-c&nbsp;-s&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;chown&nbsp;-R&nbsp;proxy:proxy&nbsp;/var/lib/squid/ssl_db&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;/etc/squid/squid.conf&nbsp;:&lt;/b&gt;&lt;br&gt;acl&nbsp;to_aws&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://amazonaws.com&quot;&gt;amazonaws.com&lt;/a&gt;&lt;br&gt;acl&nbsp;from_local&nbsp;src&nbsp;localhost&lt;br&gt;http_access&nbsp;allow&nbsp;to_aws&lt;br&gt;http_access&nbsp;allow&nbsp;from_local&lt;br&gt;cache&nbsp;allow&nbsp;all&lt;br&gt;cache_dir&nbsp;ufs&nbsp;/var/cache/squid&nbsp;1024&nbsp;16&nbsp;256&lt;br&gt;offline_mode&nbsp;on&lt;br&gt;http_port&nbsp;3129&nbsp;ssl-bump&nbsp;cert=/etc/squid/stuff.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;sslcrtd_program&nbsp;/usr/lib/squid/security_file_certgen&nbsp;-s&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&nbsp;&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&nbsp;&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&nbsp;&lt;br&gt;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;cache_store_log&nbsp;stdio:/var/log/squid/store.log&lt;br&gt;logfile_rotate&nbsp;0&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;/usr/bin/proxy-test&nbsp;:&lt;/b&gt;&lt;br&gt;#!/bin/bash&lt;br&gt;curl&nbsp;--proxy&nbsp;&lt;a&nbsp;href=&quot;http://localhost:3129&quot;&gt;http://localhost:3129&lt;/a&gt;&nbsp;\&lt;br&gt; &nbsp;--cacert&nbsp;/etc/squid/stuff.pem&nbsp;\&lt;br&gt; &nbsp;-v&nbsp;&quot;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&quot;&gt;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&lt;/a&gt;&quot;&nbsp;\&lt;br&gt; &nbsp;-H&nbsp;&quot;Authorization:&nbsp;token&nbsp;MYTOKEN&quot;&nbsp;\&lt;br&gt; &nbsp;-H&nbsp;&quot;Content-Type:&nbsp;application/json&quot;&nbsp;\&lt;br&gt; &nbsp;--output&nbsp;&quot;/tmp/stuff.json&quot;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;When&nbsp;network&nbsp;connectivity&nbsp;is&nbsp;GOOD,&nbsp;everything&nbsp;works&nbsp;well&nbsp;and&nbsp;I&nbsp;get&nbsp;cache&nbsp;HITS&nbsp;...&nbsp; &lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;/var/log/squid/access.log&lt;/b&gt;&lt;br&gt;1705587538.837&nbsp; &nbsp; 238&nbsp;127.0.0.1&nbsp;NONE_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&gt;stuff.amazonaws.com:443&lt;/a&gt;&nbsp;-&nbsp;HIER_DIRECT/&lt;a&nbsp;href=&quot;http://3.136.246.238&quot;&gt;3.136.246.238&lt;/a&gt;&nbsp;-&lt;br&gt;1705587538.838&nbsp; &nbsp; &nbsp; 0&nbsp;127.0.0.1&nbsp;TCP_MEM_HIT/200&nbsp;32818&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&quot;&gt;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;application/json&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;extract&nbsp;from&nbsp;/usr/bin/proxy-test&nbsp;output&lt;/b&gt;&lt;br&gt;&lt;&nbsp;HTTP/1.1&nbsp;200&nbsp;OK&lt;br&gt;&lt;&nbsp;Date:&nbsp;Thu,&nbsp;18&nbsp;Jan&nbsp;2024&nbsp;13:38:01&nbsp;GMT&lt;br&gt;&lt;&nbsp;Content-Type:&nbsp;application/json&lt;br&gt;&lt;&nbsp;Content-Length:&nbsp;32187&lt;br&gt;&lt;&nbsp;x-amzn-RequestId:&nbsp;8afba80e-6df7-4d5b-a34b-a70bd9b54380&lt;br&gt;&lt;&nbsp;Last-Modified:&nbsp;2024-01-03T11:23:19.000Z&lt;br&gt;&lt;&nbsp;Access-Control-Allow-Origin:&nbsp;*&lt;br&gt;&lt;&nbsp;x-amz-apigw-id:&nbsp;RvN1CF2_iYcEokA=&lt;br&gt;&lt;&nbsp;Cache-Control:&nbsp;max-age=2147483648,public,stale-if-error&lt;br&gt;&lt;&nbsp;ETag:&nbsp;&quot;53896156c4e8e26933188a092c4e40f1&quot;&lt;br&gt;&lt;&nbsp;X-Amzn-Trace-Id:&nbsp;Root=1-65a929b9-3bd3285934151c1a2495481a&lt;br&gt;&lt;&nbsp;Age:&nbsp;2578&lt;br&gt;&lt;&nbsp;Warning:&nbsp;110&nbsp;squid/5.7&nbsp;&quot;Response&nbsp;is&nbsp;stale&quot;&lt;br&gt;&lt;&nbsp;X-Cache:&nbsp;HIT&nbsp;from&nbsp;ubuntu-pc&lt;br&gt;&lt;&nbsp;X-Cache-Lookup:&nbsp;HIT&nbsp;from&nbsp;ubuntu-pc:3129&lt;br&gt;&lt;&nbsp;Via:&nbsp;1.1&nbsp;ubuntu-pc&nbsp;(squid/5.7)&lt;br&gt;&lt;&nbsp;Connection:&nbsp;keep-alive&lt;br&gt;&lt;br&gt;&lt;br&gt;When&nbsp;network&nbsp;connectivity&nbsp;is&nbsp;BAD,&nbsp;I&nbsp;get&nbsp;errors&nbsp;and&nbsp;a&nbsp;cache&nbsp;MISS.&nbsp; &nbsp;In&nbsp;this&nbsp;test&nbsp;case&nbsp;I&nbsp;unplugged&nbsp;the&nbsp;ethernet&nbsp;cable&nbsp;from&nbsp;the&nbsp;back&nbsp;on&nbsp;the&nbsp;ubuntu-pc&nbsp;...&nbsp;&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;/var/log/squid/access.log&lt;/b&gt;&lt;br&gt;1705588717.420&nbsp; &nbsp; &nbsp;11&nbsp;127.0.0.1&nbsp;NONE_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&gt;stuff.amazonaws.com:443&lt;/a&gt;&nbsp;-&nbsp;HIER_DIRECT/&lt;a&nbsp;href=&quot;http://3.135.162.228&quot;&gt;3.135.162.228&lt;/a&gt;&nbsp;-&lt;br&gt;1705588717.420&nbsp; &nbsp; &nbsp; 0&nbsp;127.0.0.1&nbsp;NONE_NONE/503&nbsp;4087&nbsp;GET&nbsp;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&quot;&gt;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&lt;/a&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;br&gt;&lt;br&gt;&lt;b&gt;#&nbsp;extract&nbsp;from&nbsp;/usr/bin/proxy-test&nbsp;output&lt;/b&gt;&lt;br&gt;&lt;&nbsp;HTTP/1.1&nbsp;503&nbsp;Service&nbsp;Unavailable&lt;br&gt;&lt;&nbsp;Server:&nbsp;squid/5.7&lt;br&gt;&lt;&nbsp;Mime-Version:&nbsp;1.0&lt;br&gt;&lt;&nbsp;Date:&nbsp;Thu,&nbsp;18&nbsp;Jan&nbsp;2024&nbsp;14:38:37&nbsp;GMT&lt;br&gt;&lt;&nbsp;Content-Type:&nbsp;text/html;charset=utf-8&lt;br&gt;&lt;&nbsp;Content-Length:&nbsp;3692&lt;br&gt;&lt;&nbsp;X-Squid-Error:&nbsp;ERR_CONNECT_FAIL&nbsp;101&lt;br&gt;&lt;&nbsp;Vary:&nbsp;Accept-Language&lt;br&gt;&lt;&nbsp;Content-Language:&nbsp;en&lt;br&gt;&lt;&nbsp;X-Cache:&nbsp;MISS&nbsp;from&nbsp;ubuntu-pc&lt;br&gt;&lt;&nbsp;X-Cache-Lookup:&nbsp;NONE&nbsp;from&nbsp;ubuntu-pc:3129&lt;br&gt;&lt;&nbsp;Via:&nbsp;1.1&nbsp;ubuntu-pc&nbsp;(squid/5.7)&lt;br&gt;&lt;&nbsp;Connection:&nbsp;close&lt;br&gt;&lt;br&gt;I&nbsp;have&nbsp;also&nbsp;seen&nbsp;it&nbsp;error&nbsp;in&nbsp;a&nbsp;different&nbsp;way&nbsp;with&nbsp;a&nbsp;502&nbsp;but&nbsp;with&nbsp;the&nbsp;same&nbsp;ultimate&nbsp;result.&lt;br&gt;&lt;br&gt;My&nbsp;expectation/hope&nbsp;is&nbsp;that&nbsp;squid&nbsp;would&nbsp;return&nbsp;the&nbsp;cached&nbsp;object&nbsp;on&nbsp;any&nbsp;network&nbsp;failure&nbsp;in&nbsp;between&nbsp;ubuntu-pc&nbsp;and&nbsp;the&nbsp;AWS&nbsp;endpoint&nbsp;-&nbsp;and&nbsp;continue&nbsp;to&nbsp;return&nbsp;this&nbsp;cached&nbsp;object&nbsp;forever. &nbsp; Is&nbsp;this&nbsp;something&nbsp;squid&nbsp;can&nbsp;do?&nbsp; &nbsp;It&nbsp;would&nbsp;seem&nbsp;that&nbsp;offline_mode&nbsp;should&nbsp;do&nbsp;this?&lt;br&gt;&lt;br&gt;Hope&nbsp;you&nbsp;can&nbsp;help,&lt;br&gt;&lt;br&gt;Robin&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
