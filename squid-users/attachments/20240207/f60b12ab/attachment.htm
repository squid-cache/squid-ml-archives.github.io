<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;just&nbsp;started&nbsp;my&nbsp;enhanced&nbsp;logging&nbsp;journey&nbsp;and&nbsp;have&nbsp;a&nbsp;small&nbsp;snippet&nbsp;below&nbsp;that&nbsp;might&nbsp;illuminate&nbsp;the&nbsp;issue&nbsp;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;2024/02/07&nbsp;17:06:39.212&nbsp;kid1|&nbsp;88,3|&nbsp;client_side_reply.cc(507)&nbsp;handleIMSReply:&nbsp;origin&nbsp;replied&nbsp;with&nbsp;error&nbsp;502,&nbsp;forwarding&nbsp;to&nbsp;client&nbsp;due&nbsp;to&nbsp;fail_on_validation_err&lt;/i&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;few&nbsp;lines&nbsp;below&nbsp;in&nbsp;the&nbsp;log&nbsp;it&nbsp;looks&nbsp;like&nbsp;squid&nbsp;sent&nbsp;:-&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;2024/02/07&nbsp;17:06:39.212&nbsp;kid1|&nbsp;11,2|&nbsp;Stream.cc(280)&nbsp;sendStartOfMessage:&nbsp;HTTP&nbsp;Client&nbsp;REPLY:&lt;br&gt;---------&lt;br&gt;HTTP/1.1&nbsp;502&nbsp;Bad&nbsp;Gateway&lt;br&gt;Server:&nbsp;squid/5.7&lt;br&gt;Mime-Version:&nbsp;1.0&lt;br&gt;Date:&nbsp;Wed,&nbsp;07&nbsp;Feb&nbsp;2024&nbsp;17:06:39&nbsp;GMT&lt;br&gt;Content-Type:&nbsp;text/html;charset=utf-8&lt;br&gt;Content-Length:&nbsp;3853&lt;br&gt;X-Squid-Error:&nbsp;ERR_READ_ERROR&nbsp;0&lt;br&gt;Vary:&nbsp;Accept-Language&lt;br&gt;Content-Language:&nbsp;en&lt;br&gt;X-Cache:&nbsp;MISS&nbsp;from&nbsp;labs-maul-st-15&lt;br&gt;X-Cache-Lookup:&nbsp;HIT&nbsp;from&nbsp;labs-maul-st-15:3129&lt;br&gt;Via:&nbsp;1.1&nbsp;labs-maul-st-15&nbsp;(squid/5.7)&lt;br&gt;Connection:&nbsp;close&lt;/i&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;logs&nbsp;are&nbsp;quite&nbsp;large&nbsp;and&nbsp;contain&nbsp;URLs&nbsp;I&nbsp;cannot&nbsp;put&nbsp;here. &nbsp; The&nbsp;logs&nbsp;were&nbsp;generated&nbsp;with&nbsp;debug_options&nbsp;to&nbsp;ALL,3. &nbsp; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;ideas? &nbsp; Or&nbsp;should&nbsp;I&nbsp;generate&nbsp;more&nbsp;detailed&nbsp;logs&nbsp;and&nbsp;send&nbsp;them&nbsp;privately?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;again,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Robin&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Fri,&nbsp;2&nbsp;Feb&nbsp;2024&nbsp;at&nbsp;11:20,&nbsp;Robin&nbsp;Carlisle&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:robin.carlisle@framestore.com&quot;&nbsp;target=&quot;_blank&quot;&gt;robin.carlisle@framestore.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi,&nbsp;thanks&nbsp;for&nbsp;your&nbsp;reply. &nbsp; &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;been&nbsp;looking&nbsp;at&nbsp;: &lt;a&nbsp;href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control&quot;&nbsp;target=&quot;_blank&quot;&gt;https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;i&gt;The&nbsp;stale-if-error&nbsp;response&nbsp;directive&nbsp;indicates&nbsp;that&nbsp;the&nbsp;cache&nbsp;can&nbsp;reuse&nbsp;a&nbsp;stale&nbsp;response&nbsp;when&nbsp;an&nbsp;upstream&nbsp;server&nbsp;generates&nbsp;an&nbsp;error,&nbsp;or&nbsp;when&nbsp;the&nbsp;error&nbsp;is&nbsp;generated&nbsp;locally.&nbsp;Here,&nbsp;an&nbsp;error&nbsp;is&nbsp;considered&nbsp;any&nbsp;response&nbsp;with&nbsp;a&nbsp;status&nbsp;code&nbsp;of&nbsp;500,&nbsp;502,&nbsp;503,&nbsp;or&nbsp;504.&lt;br&gt;&lt;br&gt;Cache-Control:&nbsp;max-age=604800,&nbsp;stale-if-error=86400&lt;br&gt;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;response&nbsp;is&nbsp;fresh&nbsp;for&nbsp;7&nbsp;days&nbsp;(604800s).&nbsp;Afterwards,&nbsp;it&nbsp;becomes&nbsp;stale,&nbsp;but&nbsp;can&nbsp;be&nbsp;used&nbsp;for&nbsp;an&nbsp;extra&nbsp;1&nbsp;day&nbsp;(86400s)&nbsp;when&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered.&lt;br&gt;&lt;br&gt;After&nbsp;the&nbsp;stale-if-error&nbsp;period&nbsp;passes,&nbsp;the&nbsp;client&nbsp;will&nbsp;receive&nbsp;any&nbsp;error&nbsp;generated&lt;/i&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;what&nbsp;you&nbsp;have&nbsp;said&nbsp;and&nbsp;what&nbsp;the&nbsp;above&nbsp;docs&nbsp;say&nbsp;-&nbsp;I&nbsp;am&nbsp;still&nbsp;confused&nbsp;as&nbsp;it&nbsp;looks&nbsp;like&nbsp;(in&nbsp;my&nbsp;test&nbsp;cases)&nbsp;the&nbsp;cached&nbsp;response&nbsp;can&nbsp;be&nbsp;used&nbsp;for&nbsp;3600&nbsp;secs&nbsp;(this&nbsp;works),&nbsp;after&nbsp;which&nbsp;the&nbsp;cached&nbsp;response&nbsp;can&nbsp;still&nbsp;be&nbsp;used&nbsp;for&nbsp;an&nbsp;additional&nbsp;31536000&nbsp;seconds&nbsp;on&nbsp;an&nbsp;error&nbsp;(this&nbsp;doesnt&nbsp;work).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;going&nbsp;to&nbsp;dig&nbsp;into&nbsp;the&nbsp;error&nbsp;logging you&nbsp;suggested&nbsp;to&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;make&nbsp;sense&nbsp;of&nbsp;that&nbsp;-&nbsp;and&nbsp;will&nbsp;send&nbsp;on&nbsp;if&nbsp;I&nbsp;can&#39;t.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;v&nbsp;much&nbsp;for&nbsp;your&nbsp;help&nbsp;again,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Robin&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Thu,&nbsp;1&nbsp;Feb&nbsp;2024&nbsp;at&nbsp;18:27,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2024-02-01&nbsp;12:03,&nbsp;Robin&nbsp;Carlisle&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&nbsp;I&nbsp;am&nbsp;having&nbsp;trouble&nbsp;with&nbsp;stale-if-error&nbsp;response.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;I&nbsp;am&nbsp;interpreting&nbsp;Squid&nbsp;code&nbsp;correctly,&nbsp;in&nbsp;primary&nbsp;use&nbsp;cases:&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;without&nbsp;a&nbsp;Cache-Control:stale-if-error=X&nbsp;in&nbsp;the&nbsp;original&nbsp;response,&nbsp;&lt;br&gt;<br>
Squid&nbsp;sends&nbsp;a&nbsp;stale&nbsp;object&nbsp;if&nbsp;revalidation&nbsp;results&nbsp;in&nbsp;a&nbsp;5xx&nbsp;error;&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;with&nbsp;a&nbsp;Cache-Control:stale-if-error=X&nbsp;and&nbsp;object&nbsp;age&nbsp;at&nbsp;most&nbsp;X,&nbsp;Squid&nbsp;&lt;br&gt;<br>
sends&nbsp;a&nbsp;stale&nbsp;object&nbsp;if&nbsp;revalidation&nbsp;results&nbsp;in&nbsp;a&nbsp;5xx&nbsp;error;&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;with&nbsp;a&nbsp;Cache-Control:stale-if-error=X&nbsp;and&nbsp;object&nbsp;age&nbsp;exceeding&nbsp;X,&nbsp;&lt;br&gt;<br>
Squid&nbsp;forwards&nbsp;the&nbsp;5xx&nbsp;error&nbsp;response&nbsp;if&nbsp;revalidation&nbsp;results&nbsp;in&nbsp;a&nbsp;5xx&nbsp;&lt;br&gt;<br>
error;&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;other&nbsp;words,&nbsp;stale-if-error=X&nbsp;turns&nbsp;on&nbsp;a&nbsp;&quot;fail&nbsp;on&nbsp;validation&nbsp;errors&quot;&nbsp;&lt;br&gt;<br>
behavior&nbsp;for&nbsp;stale&nbsp;objects&nbsp;older&nbsp;than&nbsp;X.&nbsp;It&nbsp;has&nbsp;no&nbsp;other&nbsp;effects.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;your&nbsp;test&nbsp;case,&nbsp;the&nbsp;stale&nbsp;objects&nbsp;are&nbsp;much&nbsp;younger&nbsp;than&nbsp;&lt;br&gt;<br>
stale-if-error&nbsp;value&nbsp;(e.g.,&nbsp;Age~=3601&nbsp;vs.&nbsp;stale-if-error=31536000).&nbsp;&lt;br&gt;<br>
Thus,&nbsp;stale-if-error&nbsp;should&nbsp;have&nbsp;no&nbsp;relevant&nbsp;effect.&lt;br&gt;<br>
&lt;br&gt;<br>
Something&nbsp;else&nbsp;is&nbsp;probably&nbsp;preventing&nbsp;your&nbsp;Squid&nbsp;from&nbsp;serving&nbsp;the&nbsp;stale&nbsp;&lt;br&gt;<br>
response&nbsp;when&nbsp;facing&nbsp;a&nbsp;5xx&nbsp;error.&nbsp;I&nbsp;do&nbsp;not&nbsp;know&nbsp;what&nbsp;that&nbsp;something&nbsp;is.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;recommend&nbsp;sharing&nbsp;(privately&nbsp;if&nbsp;you&nbsp;need&nbsp;to&nbsp;protect&nbsp;sensitive&nbsp;info)&nbsp;a&nbsp;&lt;br&gt;<br>
pointer&nbsp;to&nbsp;a&nbsp;compressed&nbsp;ALL,9&nbsp;cache.log&nbsp;collected&nbsp;while&nbsp;reproducing&nbsp;the&nbsp;&lt;br&gt;<br>
problem&nbsp;(using&nbsp;two&nbsp;transactions&nbsp;similar&nbsp;to&nbsp;the&nbsp;ones&nbsp;you&nbsp;have&nbsp;shared&nbsp;&lt;br&gt;<br>
below&nbsp;--&nbsp;a&nbsp;successful&nbsp;stale&nbsp;hit&nbsp;and&nbsp;a&nbsp;problematic&nbsp;one):&nbsp;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Alternatively,&nbsp;you&nbsp;can&nbsp;try&nbsp;to&nbsp;study&nbsp;cache.log&nbsp;yourself&nbsp;after&nbsp;setting&nbsp;&lt;br&gt;<br>
debug_options&nbsp;to&nbsp;ALL,3.&nbsp;Searching&nbsp;for&nbsp;&quot;refresh&quot;&nbsp;and&nbsp;&quot;handleIMSReply&quot;&nbsp;may&nbsp;&lt;br&gt;<br>
yield&nbsp;enough&nbsp;clues.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
HTH,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;/etc/squid/squid.conf&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;to_aws&nbsp;dstdomain&nbsp;.&lt;a&nbsp;href=&quot;http://amazonaws.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;amazonaws.com&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://amazonaws.com&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://amazonaws.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;from_local&nbsp;src&nbsp;localhost&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;to_aws&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_access&nbsp;allow&nbsp;from_local&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache&nbsp;allow&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_dir&nbsp;ufs&nbsp;/var/cache/squid&nbsp;1024&nbsp;16&nbsp;256&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;http_port&nbsp;3129&nbsp;ssl-bump&nbsp;cert=/etc/squid/maul.pem&nbsp;&lt;br&gt;<br>
&gt;&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;sslcrtd_program&nbsp;/usr/lib/squid/security_file_certgen&nbsp;-s&nbsp;&lt;br&gt;<br>
&gt;&nbsp;/var/lib/squid/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;step1&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;sslproxy_cert_error&nbsp;deny&nbsp;all&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;cache_store_log&nbsp;stdio:/var/log/squid/store.log&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;logfile_rotate&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;shutdown_lifetime&nbsp;3&nbsp;seconds&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;/usr/bin/proxy-test&nbsp;:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#!/bin/bash&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;curl&nbsp;--proxy&nbsp;&lt;a&nbsp;href=&quot;http://localhost:3129&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://localhost:3129&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://localhost:3129&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://localhost:3129&lt;/a&gt;&gt;&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp;  --cacert&nbsp;/etc/squid/stuff.pem&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp;  -v&nbsp;&quot;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&lt;/a&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/api/v1/stuff/stuff.json&lt;/a&gt;&gt;&quot;&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp;  -H&nbsp;&quot;Authorization:&nbsp;token&nbsp;MYTOKEN&quot;&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp;  -H&nbsp;&quot;Content-Type:&nbsp;application/json&quot;&nbsp;\&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp;  --output&nbsp;&quot;/tmp/stuff.json&quot;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Tests &nbsp;..........&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;At&nbsp;this&nbsp;point&nbsp;in&nbsp;time&nbsp;the&nbsp;network&nbsp;cable&nbsp;is&nbsp;unattached. &nbsp;Squid&nbsp;returns&nbsp;&lt;br&gt;<br>
&gt;&nbsp;the&nbsp;cached&nbsp;object&nbsp;it&nbsp;got&nbsp;when&nbsp;the&nbsp;network&nbsp;was&nbsp;online&nbsp;earlier.&nbsp;The&nbsp;Age&nbsp;of&nbsp;&lt;br&gt;<br>
&gt;&nbsp;this&nbsp;object&nbsp;is&nbsp;just&nbsp;still&nbsp;under&nbsp;the&nbsp;max_age&nbsp;of&nbsp;3600.&nbsp; &nbsp; &nbsp;Previously&nbsp;I&nbsp;&lt;br&gt;<br>
&gt;&nbsp;was&nbsp;using&nbsp;offline_mode&nbsp;but&nbsp;I&nbsp;found&nbsp;that&nbsp;it&nbsp;did&nbsp;not&nbsp;try&nbsp;to&nbsp;revalidate&nbsp;&lt;br&gt;<br>
&gt;&nbsp;from&nbsp;the&nbsp;origin&nbsp;after&nbsp;the&nbsp;object&nbsp;expired&nbsp;(defined&nbsp;via&nbsp;max-age&nbsp;response).&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp;My&nbsp;understanding&nbsp;is&nbsp;that&nbsp;stale-if-error&nbsp;should&nbsp;work&nbsp;under&nbsp;my&nbsp;&lt;br&gt;<br>
&gt;&nbsp;circumstances.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;/var/log/squid/access.log&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1706799404.440 &nbsp; &nbsp; &nbsp;6&nbsp;127.0.0.1&nbsp;NONE_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;stuff.amazonaws.com:443&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://stuff.amazonaws.com:443&lt;/a&gt;&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1706799404.440 &nbsp; &nbsp; &nbsp;0&nbsp;127.0.0.1&nbsp;TCP_MEM_HIT/200&nbsp;20726&nbsp;GET&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/stuff.json&lt;/a&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/stuff.json&lt;/a&gt;&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;application/json&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;extract&nbsp;from&nbsp;/usr/bin/proxy-test&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;HTTP/1.1&nbsp;200&nbsp;OK&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Date:&nbsp;Thu,&nbsp;01&nbsp;Feb&nbsp;2024&nbsp;13:57:11&nbsp;GMT&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Type:&nbsp;application/json&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Length:&nbsp;20134&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;x-amzn-RequestId:&nbsp;3a2d3b26-df73-4b30-88cb-1a9268fa0df2&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Last-Modified:&nbsp;2024-02-01T13:00:45.000Z&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Access-Control-Allow-Origin:&nbsp;*&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;x-amz-apigw-id:&nbsp;SdZwpG7qiYcERUQ=&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Cache-Control:&nbsp;public,&nbsp;max-age=3600,&nbsp;stale-if-error=31536000&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;ETag:&nbsp;&quot;cec102b43372840737ab773c2e77858b&quot;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Amzn-Trace-Id:&nbsp;Root=1-65bba337-292be751134161b03555cdd6&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Age:&nbsp;3573&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Cache:&nbsp;HIT&nbsp;from&nbsp;labs-maul-st-31&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Cache-Lookup:&nbsp;HIT&nbsp;from&nbsp;labs-maul-st-31:3129&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Via:&nbsp;1.1&nbsp;labs-maul-st-31&nbsp;(squid/5.7)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Connection:&nbsp;keep-alive&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Below&nbsp;..&nbsp;the&nbsp;curl&nbsp;script&nbsp;executes&nbsp;again. &nbsp;The&nbsp;Age&nbsp;has&nbsp;gone&nbsp;over&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;max-age&nbsp;so&nbsp;squid&nbsp;attempted&nbsp;to&nbsp;refresh&nbsp;from&nbsp;the&nbsp;origin. &nbsp;The&nbsp;machine&nbsp;is&nbsp;&lt;br&gt;<br>
&gt;&nbsp;still&nbsp;offline&nbsp;so&nbsp;the&nbsp;refresh&nbsp;failed.&nbsp; &nbsp;I&nbsp;expected&nbsp;that&nbsp;the&nbsp;&lt;br&gt;<br>
&gt;&nbsp;stale-if-error&nbsp;response&nbsp;would&nbsp;instruct&nbsp;squid&nbsp;to&nbsp;return&nbsp;the&nbsp;cached&nbsp;object&nbsp;&lt;br&gt;<br>
&gt;&nbsp;as&nbsp;a&nbsp;200.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;/var/log/squid/access.log&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1706799434.464 &nbsp; &nbsp; &nbsp;5&nbsp;127.0.0.1&nbsp;NONE_NONE/200&nbsp;0&nbsp;CONNECT&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;stuff.amazonaws.com:443&lt;/a&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;http://stuff.amazonaws.com:443&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://stuff.amazonaws.com:443&lt;/a&gt;&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;-&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;1706799434.464 &nbsp; &nbsp; &nbsp;0&nbsp;127.0.0.1&nbsp;TCP_REFRESH_FAIL_ERR/502&nbsp;4235&nbsp;GET&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/stuff.json&lt;/a&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&lt;a&nbsp;href=&quot;https://stuff.amazonaws.com/stuff.json&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://stuff.amazonaws.com/stuff.json&lt;/a&gt;&gt;&nbsp;-&nbsp;HIER_NONE/-&nbsp;text/html&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;extract&nbsp;from&nbsp;/usr/bin/proxy-test&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;HTTP/1.1&nbsp;502&nbsp;Bad&nbsp;Gateway&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Server:&nbsp;squid/5.7&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Mime-Version:&nbsp;1.0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Date:&nbsp;Thu,&nbsp;01&nbsp;Feb&nbsp;2024&nbsp;14:57:14&nbsp;GMT&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Type:&nbsp;text/html;charset=utf-8&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Length:&nbsp;3853&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Squid-Error:&nbsp;ERR_READ_ERROR&nbsp;0&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Vary:&nbsp;Accept-Language&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Content-Language:&nbsp;en&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Cache:&nbsp;MISS&nbsp;from&nbsp;labs-maul-st-31&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;X-Cache-Lookup:&nbsp;HIT&nbsp;from&nbsp;labs-maul-st-31:3129&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Via:&nbsp;1.1&nbsp;labs-maul-st-31&nbsp;(squid/5.7)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;&nbsp;Connection:&nbsp;close&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Hope&nbsp;someone&nbsp;can&nbsp;help&nbsp;me&nbsp;with&nbsp;this. &nbsp;All&nbsp;the&nbsp;best,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Robin&nbsp;Carlisle&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;_______________________________________________&lt;br&gt;<br>
&gt;&nbsp;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;https://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
