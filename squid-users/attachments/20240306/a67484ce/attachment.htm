<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Good&nbsp;morning,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;been&nbsp;using&nbsp;squid&nbsp;(version squid-5.5-6.el9_3.5)&nbsp;under&nbsp;RHEL9&nbsp;as&nbsp;a&nbsp;simple&nbsp;pass-through&nbsp;proxy&nbsp;without&nbsp;issue&nbsp;for&nbsp;the&nbsp;past&nbsp;month&nbsp;or&nbsp;so.&nbsp;Recently&nbsp;our&nbsp;security&nbsp;team&nbsp;implemented&nbsp;an&nbsp;IPS&nbsp;product&nbsp;that&nbsp;intercepts&nbsp;domain&nbsp;names&nbsp;known&nbsp;to&nbsp;be&nbsp;associated&nbsp;with&nbsp;malware&nbsp;and&nbsp;ransomware&nbsp;command&nbsp;and&nbsp;control.&nbsp;Once&nbsp;this&nbsp;was&nbsp;in&nbsp;place,&nbsp;we&nbsp;started&nbsp;having&nbsp;issues&nbsp;with&nbsp;the&nbsp;behavior&nbsp;of&nbsp;squid.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Through&nbsp;some&nbsp;troubleshooting,&nbsp;it&nbsp;appears&nbsp;that&nbsp;what&nbsp;is&nbsp;happening&nbsp;is&nbsp;that&nbsp;that&nbsp;when&nbsp;a&nbsp;user&#39;s&nbsp;machine&nbsp;make&nbsp;a&nbsp;request&nbsp;through&nbsp;squid&nbsp;for&nbsp;one&nbsp;of&nbsp;these&nbsp;bad&nbsp;domains,&nbsp;the&nbsp;request&nbsp;is&nbsp;dropped&nbsp;by&nbsp;the&nbsp;IPS,&nbsp;squid&nbsp;waits&nbsp;for&nbsp;the&nbsp;DNS&nbsp;timeout,&nbsp;and&nbsp;then&nbsp;all&nbsp;requests&nbsp;made&nbsp;to&nbsp;squid&nbsp;after&nbsp;that&nbsp;result&nbsp;in NONE_NONE/500&nbsp;errors,&nbsp;and&nbsp;it&nbsp;never&nbsp;seems&nbsp;to&nbsp;recover&nbsp;until&nbsp;we&nbsp;do&nbsp;a&nbsp;restart&nbsp;or&nbsp;reload&nbsp;of&nbsp;the&nbsp;service.&lt;br&gt;&lt;br&gt;Initially&nbsp;the&nbsp;dns_timeout&nbsp;was&nbsp;set&nbsp;for&nbsp;30&nbsp;seconds.&nbsp;I&nbsp;reduced&nbsp;this,&nbsp;thinking&nbsp;that&nbsp;perhaps&nbsp;requests&nbsp;were&nbsp;building&nbsp;up&nbsp;or&nbsp;something&nbsp;along&nbsp;those&nbsp;lines.&nbsp;I&nbsp;set&nbsp;it&nbsp;to&nbsp;5&nbsp;seconds,&nbsp;but&nbsp;that&nbsp;just&nbsp;got&nbsp;us&nbsp;to&nbsp;a&nbsp;failure&nbsp;state&nbsp;faster.&lt;br&gt;&lt;br&gt;I&nbsp;also&nbsp;found&nbsp;the&nbsp;negative_dns_ttl&nbsp;setting&nbsp;and&nbsp;thought&nbsp;it&nbsp;might&nbsp;be&nbsp;having&nbsp;an&nbsp;effect,&nbsp;but&nbsp;setting&nbsp;this&nbsp;to&nbsp;0&nbsp;seconds&nbsp;resulted&nbsp;in&nbsp;no&nbsp;change&nbsp;to&nbsp;the&nbsp;behavior.&lt;br&gt;&lt;br&gt;Are&nbsp;there&nbsp;any&nbsp;configuration&nbsp;tips&nbsp;that&nbsp;anyone&nbsp;can&nbsp;provide&nbsp;that&nbsp;might&nbsp;work&nbsp;better&nbsp;with&nbsp;dropped/intercepted&nbsp;DNS&nbsp;requests?&nbsp;My&nbsp;current&nbsp;configuration&nbsp;is&nbsp;included&nbsp;here:&lt;br&gt;&lt;br&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;0.0.0.1-0.255.255.255 &nbsp;#&nbsp;RFC&nbsp;1122&nbsp;&quot;this&quot;&nbsp;network&nbsp;(LAN)&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://10.0.0.0/8&quot;&gt;10.0.0.0/8&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://100.64.0.0/10&quot;&gt;100.64.0.0/10&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;6598&nbsp;shared&nbsp;address&nbsp;space&nbsp;(CGN)&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://169.254.0.0/16&quot;&gt;169.254.0.0/16&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;3927&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://172.16.0.0/12&quot;&gt;172.16.0.0/12&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.0/16&quot;&gt;192.168.0.0/16&lt;/a&gt; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;1918&nbsp;local&nbsp;private&nbsp;network&nbsp;(LAN)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fc00::/7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;RFC&nbsp;4193&nbsp;local&nbsp;private&nbsp;network&nbsp;range&lt;/div&gt;&lt;div&gt;acl&nbsp;localnet&nbsp;src&nbsp;fe80::/10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;RFC&nbsp;4291&nbsp;link-local&nbsp;(directly&nbsp;plugged)&nbsp;machines&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;acl&nbsp;SSL_ports&nbsp;port&nbsp;443&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;80 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;http&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;443 &nbsp; &nbsp; &nbsp; &nbsp; #&nbsp;https&lt;/div&gt;&lt;div&gt;acl&nbsp;Safe_ports&nbsp;port&nbsp;9191 &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;papercut&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;!Safe_ports&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&nbsp;manager&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;manager&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localnet&lt;/div&gt;&lt;div&gt;http_access&nbsp;allow&nbsp;localhost&lt;/div&gt;&lt;div&gt;http_access&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:3128&quot;&gt;0.0.0.0:3128&lt;/a&gt;&lt;/div&gt;&lt;div&gt;http_port&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:3129&quot;&gt;0.0.0.0:3129&lt;/a&gt;&lt;/div&gt;&lt;div&gt;cache&nbsp;deny&nbsp;all&lt;/div&gt;&lt;div&gt;coredump_dir&nbsp;/var/spool/squid&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^ftp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1440 &nbsp; &nbsp;20% &nbsp; &nbsp; 10080&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;^gopher: &nbsp; &nbsp; &nbsp; &nbsp;1440 &nbsp; &nbsp;0% &nbsp; &nbsp; &nbsp;1440&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;-i&nbsp;(/cgi-bin/|\?)&nbsp;0 &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp;0&lt;/div&gt;&lt;div&gt;refresh_pattern&nbsp;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; 20% &nbsp; &nbsp; 4320&lt;/div&gt;&lt;div&gt;debug_options&nbsp;rotate=1&nbsp;ALL,2&lt;/div&gt;&lt;div&gt;negative_dns_ttl&nbsp;0&nbsp;seconds&lt;/div&gt;&lt;div&gt;dns_timeout&nbsp;5&nbsp;seconds&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;any&nbsp;help&nbsp;that&nbsp;you&nbsp;can&nbsp;provide.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jason&nbsp;Marshall&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
