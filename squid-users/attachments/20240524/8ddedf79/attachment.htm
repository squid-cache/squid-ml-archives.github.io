<tt>
&lt;html&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;font-family:&nbsp;arial,helvetica,sans-serif;&nbsp;font-size:&nbsp;12pt;&nbsp;color:&nbsp;#000000&quot;&gt;&lt;div&nbsp;data-marker=&quot;__QUOTED_TEXT__&quot;&gt;&lt;div&nbsp;style=&quot;font-family:'arial'&nbsp;,&nbsp;'helvetica'&nbsp;,&nbsp;sans-serif;font-size:12pt;color:#000000&quot;&gt;&lt;div&gt;Hi,&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;We&nbsp;have&nbsp;2&nbsp;external&nbsp;ACLs&nbsp;that&nbsp;take&nbsp;a&nbsp;request's&nbsp;data&nbsp;(IP,&nbsp;authenticated&nbsp;username,&nbsp;URL,&nbsp;user-agent,&nbsp;etc)&nbsp;and&nbsp;uses&nbsp;that&nbsp;information&nbsp;to&nbsp;determine&nbsp;whether&nbsp;a&nbsp;user&nbsp;or&nbsp;host&nbsp;should&nbsp;be&nbsp;permitted&nbsp;to&nbsp;access&nbsp;that&nbsp;URL.&nbsp;&nbsp;&nbsp;It&nbsp;almost&nbsp;always&nbsp;works&nbsp;well,&nbsp;but&nbsp;we&nbsp;have&nbsp;a&nbsp;recurring&nbsp;occasional&nbsp;issue&nbsp;that&nbsp;I&nbsp;can't&nbsp;figure&nbsp;out.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;When&nbsp;it&nbsp;occurs,&nbsp;it's&nbsp;always&nbsp;around&nbsp;4AM.&nbsp;&nbsp;&nbsp;This&nbsp;particular&nbsp;request&nbsp;occurs&nbsp;often&nbsp;-&nbsp;averages&nbsp;about&nbsp;once&nbsp;a&nbsp;second&nbsp;throughout&nbsp;the&nbsp;day.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;What&nbsp;we&nbsp;see&nbsp;is&nbsp;a&nbsp;&quot;403&nbsp;forbidden&quot;&nbsp;for&nbsp;a&nbsp;(should&nbsp;be)&nbsp;permitted&nbsp;site&nbsp;from&nbsp;an&nbsp;authenticated&nbsp;user&nbsp;from&nbsp;the&nbsp;same&nbsp;IP/user&nbsp;and&nbsp;to&nbsp;the&nbsp;same&nbsp;site&nbsp;that&nbsp;gets&nbsp;a&nbsp;&quot;202&nbsp;connection&nbsp;established&quot;&nbsp;every&nbsp;other&nbsp;time.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;The&nbsp;difference&nbsp;I&nbsp;see&nbsp;in&nbsp;the&nbsp;logs:&nbsp;&nbsp;though&nbsp;all&nbsp;the&nbsp;digest&nbsp;auth&nbsp;info&nbsp;looks&nbsp;okay,&nbsp;the&nbsp;%un&nbsp;field&nbsp;in&nbsp;the&nbsp;log&nbsp;for&nbsp;the&nbsp;usual&nbsp;(successful)&nbsp;request&nbsp;is&nbsp;the&nbsp;authenticated&nbsp;username,&nbsp;while&nbsp;in&nbsp;the&nbsp;failed&nbsp;request,&nbsp;it's&nbsp;&quot;-&quot;.&nbsp;&nbsp;&nbsp;So&nbsp;though&nbsp;there&nbsp;hasn't&nbsp;been&nbsp;an&nbsp;authentication&nbsp;error&nbsp;or&nbsp;&quot;authentication&nbsp;required&quot;&nbsp;in&nbsp;the&nbsp;log&nbsp;-&nbsp;and&nbsp;the&nbsp;username&nbsp;is&nbsp;in&nbsp;the&nbsp;authentication&nbsp;details&nbsp;in&nbsp;the&nbsp;log&nbsp;entry&nbsp;-&nbsp;&nbsp;it&nbsp;seems&nbsp;like&nbsp;squid&nbsp;isn't&nbsp;recognizing&nbsp;that&nbsp;username&nbsp;as&nbsp;%un.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;My&nbsp;squid.conf&nbsp;first&nbsp;tests&nbsp;a&nbsp;request&nbsp;to&nbsp;see&nbsp;if&nbsp;an&nbsp;unauthenticated&nbsp;request&nbsp;from&nbsp;a&nbsp;particular&nbsp;host&nbsp;is&nbsp;permitted.&nbsp;&nbsp;That&nbsp;external&nbsp;ACL&nbsp;doesn't&nbsp;take&nbsp;a&nbsp;username&nbsp;as&nbsp;an&nbsp;argument.&nbsp;&nbsp;&nbsp;If&nbsp;that&nbsp;external&nbsp;ACL&nbsp;passes,&nbsp;the&nbsp;request&nbsp;is&nbsp;allowed.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;The&nbsp;next&nbsp;line&nbsp;in&nbsp;squid.conf&nbsp;is&nbsp;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;acl&nbsp;auth_users&nbsp;proxy_auth&nbsp;REQUIRED&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;...&nbsp;and&nbsp;after&nbsp;that,&nbsp;the&nbsp;external&nbsp;ACL&nbsp;that&nbsp;takes&nbsp;the&nbsp;username&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;other&nbsp;info.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;The&nbsp;filter&nbsp;has&nbsp;its&nbsp;own&nbsp;log.&nbsp;&nbsp;&nbsp;For&nbsp;most&nbsp;authenticated&nbsp;requests,&nbsp;we&nbsp;see&nbsp;four&nbsp;entries&nbsp;in&nbsp;that&nbsp;log&nbsp;for&nbsp;each&nbsp;of&nbsp;this&nbsp;particular&nbsp;request:&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;HostBasedRequest&lt;br&gt;&lt;/div&gt;&lt;div&gt;HostBasedResponse&lt;br&gt;&lt;/div&gt;&lt;div&gt;UserBasedRequest&lt;br&gt;&lt;/div&gt;&lt;div&gt;UserBasedResponse&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;When&nbsp;the&nbsp;issue&nbsp;occurs,&nbsp;we&nbsp;see&nbsp;a&nbsp;blip&nbsp;in&nbsp;the&nbsp;pattern&nbsp;when&nbsp;looking&nbsp;at&nbsp;only&nbsp;this&nbsp;particular&nbsp;request,&nbsp;like:&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&nbsp;&lt;div&gt;HostBasedRequest&lt;/div&gt;&lt;div&gt;HostBasedRespons&lt;/div&gt;&nbsp;&lt;/div&gt;&lt;div&gt;&nbsp;&lt;div&gt;HostBasedRequest&lt;/div&gt;&lt;div&gt;HostBasedResponse&lt;/div&gt;&lt;div&gt;UserBasedRequest&lt;/div&gt;&lt;div&gt;UserBasedResponse&lt;/div&gt;&lt;br&gt;&lt;div&gt;so&nbsp;it&nbsp;looks&nbsp;like&nbsp;the&nbsp;requests&nbsp;that&nbsp;experience&nbsp;the&nbsp;issue&nbsp;don't&nbsp;get&nbsp;past&nbsp;that&nbsp;&quot;acl&nbsp;auth_users&nbsp;proxy_auth&nbsp;REQUIRED&quot;&nbsp;directive.&lt;/div&gt;&lt;br&gt;&lt;div&gt;One&nbsp;more&nbsp;clue:&nbsp;&nbsp;The&nbsp;last&nbsp;morning&nbsp;the&nbsp;issue&nbsp;occurred,&nbsp;we&nbsp;saw&nbsp;8&nbsp;instances&nbsp;of&nbsp;&quot;403&nbsp;forbidden&quot;&nbsp;responses&nbsp;(out&nbsp;of&nbsp;roughly&nbsp;5800&nbsp;that&nbsp;hour).&nbsp;&nbsp;&nbsp;When&nbsp;I&nbsp;looked&nbsp;at&nbsp;the&nbsp;log&nbsp;entry&nbsp;for&nbsp;one&nbsp;of&nbsp;them&nbsp;(included&nbsp;below)&nbsp;and&nbsp;looked&nbsp;for&nbsp;other&nbsp;instances&nbsp;of&nbsp;the&nbsp;cnonce&nbsp;in&nbsp;the&nbsp;digest&nbsp;auth&nbsp;info,&nbsp;I&nbsp;saw&nbsp;that&nbsp;cnonce&nbsp;in&nbsp;five&nbsp;of&nbsp;the&nbsp;eight&nbsp;log&nbsp;entries&nbsp;showing&nbsp;the&nbsp;issue.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;Any&nbsp;ideas&nbsp;or&nbsp;suggestions?&nbsp;&nbsp;Here&nbsp;are&nbsp;two&nbsp;logs:&nbsp;one&nbsp;illustrating&nbsp;the&nbsp;issue&nbsp;and&nbsp;the&nbsp;other&nbsp;showing&nbsp;how&nbsp;a&nbsp;typical&nbsp;successful&nbsp;request&nbsp;is&nbsp;logged.&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;thanks!&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&nbsp;&lt;div&gt;&lt;div&gt;12.34.56.78&nbsp;-&nbsp;-&nbsp;[20/May/2024:04:00:00&nbsp;-0400]&nbsp;&quot;CONNECT&nbsp;abc.defg.net:443&nbsp;HTTP/1.1&quot;&nbsp;403&nbsp;4276&nbsp;&quot;-&quot;&nbsp;&quot;Java/21.0.1&quot;&nbsp;TCP_DENIED:HIER_NONE&nbsp;[User-Agent:&nbsp;Java/21.0.1\r\nAccept:&nbsp;*/*\r\nProxy-Connection:&nbsp;keep-alive\r\nProxy-Authorization:&nbsp;Digest&nbsp;username=&quot;service_uname&quot;,&nbsp;realm=&quot;squid&quot;,&nbsp;nonce=&quot;eca7c1c8831a2fc2b0afb3ee95862950&quot;,&nbsp;nc=00000035,&nbsp;uri=&quot;abc.defg.net:443&quot;,&nbsp;response=&quot;88f2110f926ba56c3b1a84a1321a051c&quot;,&nbsp;algorithm=MD5,&nbsp;cnonce=&quot;BHGEEDNBMEPIIMIDLABNJHJNAIEHLKPGGEDFCLHG&quot;,&nbsp;qop=auth\r\nHost:&nbsp;abc.defg.net:443\r\n]&nbsp;[HTTP/1.1&nbsp;403&nbsp;Forbidden\r\nServer:&nbsp;squid/5.7\r\nMime-Version:&nbsp;1.0\r\nDate:&nbsp;Mon,&nbsp;20&nbsp;May&nbsp;2024&nbsp;08:00:00&nbsp;GMT\r\nContent-Type:&nbsp;text/html;charset=utf-8\r\nContent-Length:&nbsp;3884\r\nX-Squid-Error:&nbsp;ERR_ACCESS_DENIED&nbsp;0\r\nVary:&nbsp;Accept-Language\r\nContent-Language:&nbsp;en\r\nX-Cache:&nbsp;MISS&nbsp;from&nbsp;proxy.acme.com\r\nX-Cache-Lookup:&nbsp;NONE&nbsp;from&nbsp;proxy.acme.com:3128\r\nVia:&nbsp;1.1&nbsp;proxy.acme.com&nbsp;(squid/5.7)\r\nConnection:&nbsp;keep-alive\r\n\r\n]&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;12.34.56.78&nbsp;-&nbsp;service_uname&nbsp;[20/May/2024:10:50:10&nbsp;-0400]&nbsp;&quot;CONNECT&nbsp;abc.defg.net:443&nbsp;HTTP/1.1&quot;&nbsp;200&nbsp;2939&nbsp;&quot;-&quot;&nbsp;&quot;Java/21.0.1&quot;&nbsp;TCP_TUNNEL:HIER_DIRECT&nbsp;[User-Agent:&nbsp;Java/21.0.1\r\nAccept:&nbsp;*/*\r\nProxy-Connection:&nbsp;keep-alive\r\nProxy-Authorization:&nbsp;Digest&nbsp;username=&quot;service_uname&quot;,&nbsp;realm=&quot;squid&quot;,&nbsp;nonce=&quot;3e30376ba9c74cb016b3d8cfe1bf8a81&quot;,&nbsp;nc=0000002f,&nbsp;uri=&quot;abc.defg.net:443&quot;,&nbsp;response=&quot;f8f720d4e2bb9324e1a90bcfafecd1c5&quot;,&nbsp;algorithm=MD5,&nbsp;cnonce=&quot;KDJPEGFBCHFLMCJMAPEBMEGJNKOHOBEDOAEINPKL&quot;,&nbsp;qop=auth\r\nHost:&nbsp;abc.defg.net:443\r\n]&nbsp;[HTTP/1.1&nbsp;200&nbsp;Connection&nbsp;established\r\n\r\n]&lt;/div&gt;&lt;/div&gt;&nbsp;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
