<tt>
&lt;html&gt;&lt;body&gt;&lt;div&nbsp;id=&quot;nine_body_n19103a-68fb8&quot;&nbsp;class=&quot;nine_body&nbsp;mceEditable&quot;&nbsp;dir=&quot;auto&quot;&nbsp;style=&quot;font-family:&nbsp;Calibri,&nbsp;Arial,&nbsp;Helvetica,&nbsp;sans-serif;&nbsp;font-size:&nbsp;12.0pt;&nbsp;line-height:&nbsp;1.3;&nbsp;color:&nbsp;#000000;&quot;&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;&lt;p&nbsp;style=&quot;color:&nbsp;#0c0d0e;&nbsp;background-color:&nbsp;#ffffff;&nbsp;font-weight:&nbsp;400;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;0px;&nbsp;margin:&nbsp;0px&nbsp;0px&nbsp;1.1em;&quot;&gt;I&nbsp;have&nbsp;a&nbsp;external&nbsp;proxy&nbsp;server&nbsp;connected&nbsp;by&nbsp;VPN&nbsp;(IPSEC)&nbsp;to&nbsp;my&nbsp;main&nbsp;branch,&nbsp;and&nbsp;i'm&nbsp;trying&nbsp;to&nbsp;redirect&nbsp;all&nbsp;users&nbsp;HTTP&nbsp;/&nbsp;HTTPS&nbsp;traffic&nbsp;to&nbsp;this&nbsp;proxy.&lt;/p&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;Scenario&nbsp;Users&nbsp;-&gt;&nbsp;Gateway&nbsp;(Main&nbsp;Branch)&nbsp;-&gt;&nbsp;IPSEC&nbsp;-&gt;&nbsp;Squid&nbsp;Proxy&nbsp;(transparent&nbsp;mode)&lt;/div&gt;&lt;p&nbsp;style=&quot;color:&nbsp;#0c0d0e;&nbsp;background-color:&nbsp;#ffffff;&nbsp;font-weight:&nbsp;400;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;0px;&nbsp;margin:&nbsp;0px&nbsp;0px&nbsp;1.1em;&quot;&gt;In&nbsp;my&nbsp;Gateway&nbsp;(Main&nbsp;Branch)&nbsp;I&nbsp;have&nbsp;this&nbsp;test&nbsp;iptables&nbsp;rule,&nbsp;that&nbsp;is&nbsp;forwarding&nbsp;all&nbsp;the&nbsp;TPC&nbsp;/&nbsp;UDP&nbsp;traffic&nbsp;to&nbsp;the&nbsp;Proxy&nbsp;server.&lt;/p&gt;&lt;pre&nbsp;style=&quot;color:&nbsp;#0c0d0e;&nbsp;background-color:&nbsp;var(--highlight-bg);&nbsp;font-weight:&nbsp;400;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;var(--su12);&nbsp;margin:&nbsp;0px&nbsp;0px&nbsp;calc(1.5em);&nbsp;width:&nbsp;auto;&nbsp;max-height:&nbsp;600px;&quot;&gt;&lt;code&nbsp;style=&quot;color:&nbsp;var(--black-600);&nbsp;background-color:&nbsp;transparent;&nbsp;font-weight:&nbsp;inherit;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;0px;&nbsp;margin:&nbsp;0px;&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-I&nbsp;PREROUTING&nbsp;-s&nbsp;192.168.60.90&nbsp;-p&nbsp;tcp&nbsp;-j&nbsp;DNAT&nbsp;--to-destination&nbsp;172.31.0.1<br>
iptables&nbsp;-t&nbsp;nat&nbsp;-I&nbsp;PREROUTING&nbsp;-s&nbsp;192.168.60.90&nbsp;-p&nbsp;udp&nbsp;-j&nbsp;DNAT&nbsp;--to-destination&nbsp;172.31.0.1<br>
&lt;/code&gt;&lt;/pre&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;In&nbsp;Squidd&nbsp;Proxy&nbsp;server&nbsp;I&nbsp;have&nbsp;the&nbsp;followed&nbsp;rules&lt;/div&gt;&lt;pre&nbsp;style=&quot;color:&nbsp;#0c0d0e;&nbsp;background-color:&nbsp;var(--highlight-bg);&nbsp;font-weight:&nbsp;400;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;var(--su12);&nbsp;margin:&nbsp;0px&nbsp;0px&nbsp;calc(1.5em);&nbsp;width:&nbsp;auto;&nbsp;max-height:&nbsp;600px;&quot;&gt;&lt;code&nbsp;style=&quot;color:&nbsp;var(--black-600);&nbsp;background-color:&nbsp;transparent;&nbsp;font-weight:&nbsp;inherit;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;0px;&nbsp;margin:&nbsp;0px;&quot;&gt;iptables&nbsp;-t&nbsp;nat&nbsp;-I&nbsp;PREROUTING&nbsp;-s&nbsp;192.168.60.90/32&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;443&nbsp;-m&nbsp;comment&nbsp;--comment&nbsp;ArticaSquidTransparent&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;8081<br>
iptables&nbsp;-t&nbsp;nat&nbsp;-I&nbsp;PREROUTING&nbsp;-s&nbsp;192.168.60.90/32&nbsp;-p&nbsp;tcp&nbsp;-m&nbsp;tcp&nbsp;--dport&nbsp;80&nbsp;-m&nbsp;comment&nbsp;--comment&nbsp;ArticaSquidTransparent&nbsp;-j&nbsp;REDIRECT&nbsp;--to-ports&nbsp;8080<br>
&lt;/code&gt;&lt;/pre&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;Everything&nbsp;is&nbsp;working&nbsp;correctly,&nbsp;HTTP&nbsp;traffic&nbsp;is&nbsp;ok,&nbsp;DNS&nbsp;are&nbsp;also&nbsp;working,&nbsp;the&nbsp;only&nbsp;exeption&nbsp;is&nbsp;the&nbsp;HTTPS&nbsp;traffic,&nbsp;I&nbsp;can&nbsp;see&nbsp;the&nbsp;HTTPS&nbsp;traffic&nbsp;inside&nbsp;the&nbsp;squid&nbsp;access.log&nbsp;but&nbsp;on&nbsp;client&nbsp;side&nbsp;I&nbsp;got&nbsp;a&nbsp;timeout&lt;/div&gt;&lt;pre&nbsp;style=&quot;color:&nbsp;#0c0d0e;&nbsp;background-color:&nbsp;var(--highlight-bg);&nbsp;font-weight:&nbsp;400;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;var(--su12);&nbsp;margin:&nbsp;0px&nbsp;0px&nbsp;calc(1.5em);&nbsp;width:&nbsp;auto;&nbsp;max-height:&nbsp;600px;&quot;&gt;&lt;code&nbsp;style=&quot;color:&nbsp;var(--black-600);&nbsp;background-color:&nbsp;transparent;&nbsp;font-weight:&nbsp;inherit;&nbsp;border:&nbsp;0px;&nbsp;padding:&nbsp;0px;&nbsp;margin:&nbsp;0px;&quot;&gt;1722265740.867&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;192.168.60.90&nbsp;TCP_TUNNEL/200&nbsp;0&nbsp;CONNECT&nbsp;cnn.com:443&nbsp;-&nbsp;HIER_DIRECT/51.210.183.2:443&nbsp;-&nbsp;mac=&quot;00:00:00:00:00:00&quot;&nbsp;webfilterpolicy:%200%0D%0A&nbsp;exterr=&quot;-|-&quot;<br>
&lt;/code&gt;&lt;/pre&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;Anyone&nbsp;can&nbsp;help&nbsp;me&nbsp;to&nbsp;understant&nbsp;if&nbsp;I'm&nbsp;missing&nbsp;so&nbsp;iptable&nbsp;rule&nbsp;to&nbsp;handle&nbsp;the&nbsp;HTTPS&nbsp;traffic?&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;nine-pg&nbsp;blank&nbsp;sign&quot;&nbsp;dir=&quot;auto&quot;&gt;&lt;br&nbsp;/&gt;&lt;/div&gt;&lt;div&nbsp;id=&quot;nine-sign-n19103a-68fb8&quot;&nbsp;class=&quot;nine_signature&quot;&nbsp;dir=&quot;auto&quot;&gt;&lt;div&nbsp;class=&quot;nine-pg&quot;&nbsp;dir=&quot;auto&quot;&gt;Sent&nbsp;from&nbsp;&lt;a&nbsp;style=&quot;text-decoration:&nbsp;none;&nbsp;color:&nbsp;#009bdf;&quot;&nbsp;href=&quot;http://www.9folders.com/&quot;&gt;Nine&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
