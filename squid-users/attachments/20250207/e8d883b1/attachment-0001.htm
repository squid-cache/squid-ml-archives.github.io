<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&#39;ve&nbsp;got&nbsp;a&nbsp;bit&nbsp;further&nbsp;with&nbsp;this&nbsp;and&nbsp;I&#39;m&nbsp;starting&nbsp;to&nbsp;understand&nbsp;ICAP&nbsp;talk.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;got&nbsp;a&nbsp;Go&nbsp;server&nbsp;working&nbsp;which&nbsp;I&nbsp;can&nbsp;talk&nbsp;to&nbsp;through&nbsp;netcat:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;$&nbsp;nc&nbsp;localhost&nbsp;1344&lt;br&gt;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7/&quot;&gt;192.168.0.7/&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;br&gt;Host:&nbsp;dvwa.test&lt;br&gt;Accept:&nbsp;text/html,&nbsp;text/plain,&nbsp;image/gif&lt;br&gt;Accept-Encoding:&nbsp;gzip,&nbsp;compress&lt;br&gt;&lt;br&gt;ICAP/1.0&nbsp;200&nbsp;OK&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=141&lt;br&gt;&lt;br&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;br&gt;Host:&nbsp;dvwa.test&lt;br&gt;Accept:&nbsp;text/html,&nbsp;text/plain,&nbsp;image/gif&lt;br&gt;Accept-Encoding:&nbsp;gzip,&nbsp;compress&lt;br&gt;X-Modified-By:&nbsp;Go&nbsp;ICAP&nbsp;Server&lt;br&gt;&lt;br&gt;&lt;br&gt;On&nbsp;the&nbsp;server&nbsp;side&nbsp;I&nbsp;see:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;the&nbsp;request&lt;br&gt;&lt;br&gt;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7/&quot;&gt;192.168.0.7/&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;&lt;br&gt;Received&nbsp;request:&nbsp;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7/&quot;&gt;192.168.0.7/&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;Original&nbsp;Request&nbsp;Headers:&lt;br&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;br&gt;Host:&nbsp;dvwa.test&lt;br&gt;Accept:&nbsp;text/html,&nbsp;text/plain,&nbsp;image/gif&lt;br&gt;Accept-Encoding:&nbsp;gzip,&nbsp;compress&lt;br&gt;&lt;br&gt;&lt;br&gt;Modified&nbsp;request&nbsp;sent&nbsp;back&lt;br&gt;&lt;br&gt;ICAP/1.0&nbsp;200&nbsp;OK&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=141&lt;br&gt;&lt;br&gt;GET&nbsp;/&nbsp;HTTP/1.1&lt;br&gt;Host:&nbsp;dvwa.test&lt;br&gt;Accept:&nbsp;text/html,&nbsp;text/plain,&nbsp;image/gif&lt;br&gt;Accept-Encoding:&nbsp;gzip,&nbsp;compress&lt;br&gt;X-Modified-By:&nbsp;Go&nbsp;ICAP&nbsp;Server&lt;br&gt;&lt;br&gt;&lt;br&gt;If&nbsp;I&nbsp;try&nbsp;to&nbsp;use&nbsp;curl&nbsp;through&nbsp;Squid&nbsp;pointing&nbsp;at&nbsp;that&nbsp;server:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;$&nbsp;curl&nbsp;&quot;&lt;a&nbsp;href=&quot;http://dvwa.test/a?xsa&quot;&gt;http://dvwa.test/a?xsa&lt;/a&gt;&quot;&nbsp;--proxy&nbsp;localhost:3128&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;dvwa.test&nbsp;is&nbsp;at&nbsp;192.168.0.42.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;get&nbsp;this&nbsp;in&nbsp;the&nbsp;ICAP&nbsp;server: &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;the&nbsp;request&lt;br&gt;&lt;br&gt;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/&quot;&gt;192.168.0.7:1344/&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;&lt;br&gt;Received&nbsp;request:&nbsp;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/&quot;&gt;192.168.0.7:1344/&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;Original&nbsp;Request&nbsp;Headers:&lt;br&gt;Host:&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.7:1344&quot;&gt;192.168.0.7:1344&lt;/a&gt;&lt;br&gt;Date:&nbsp;Fri,&nbsp;07&nbsp;Feb&nbsp;2025&nbsp;12:26:25&nbsp;GMT&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=93&lt;br&gt;Allow:&nbsp;204,&nbsp;trailers&lt;br&gt;&lt;br&gt;&lt;br&gt;Modified&nbsp;request&nbsp;sent&nbsp;back&lt;br&gt;&lt;br&gt;ICAP/1.0&nbsp;200&nbsp;OK&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=155&lt;br&gt;&lt;br&gt;Host:&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.7:1344&quot;&gt;192.168.0.7:1344&lt;/a&gt;&lt;br&gt;Date:&nbsp;Fri,&nbsp;07&nbsp;Feb&nbsp;2025&nbsp;12:26:25&nbsp;GMT&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=93&lt;br&gt;Allow:&nbsp;204,&nbsp;trailers&lt;br&gt;X-Modified-By:&nbsp;Go&nbsp;ICAP&nbsp;Server&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Squid&nbsp;then&nbsp;gives&nbsp;the&nbsp;same&nbsp;error&nbsp;as&nbsp;before, ERR_ICAP_FAILURE.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Robin&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&nbsp;gmail_quote_container&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Fri,&nbsp;7&nbsp;Feb&nbsp;2025&nbsp;at&nbsp;10:15,&nbsp;Robin&nbsp;Wood&nbsp;&lt;squid@digi.ninja&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&lt;div&gt;I&nbsp;want&nbsp;to&nbsp;write&nbsp;my&nbsp;own&nbsp;ICAP&nbsp;server,&nbsp;but&nbsp;all&nbsp;the&nbsp;sample&nbsp;code&nbsp;I&#39;ve&nbsp;found&nbsp;is&nbsp;failing,&nbsp;the&nbsp;majority&nbsp;with&nbsp;this&nbsp;error&nbsp;from&nbsp;squidclient:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;squidclient&nbsp;-h&nbsp;192.168.0.7&nbsp;-p&nbsp;1344&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/request_mod&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344/request_mod&lt;/a&gt;&lt;br&gt;ICAP/1.0&nbsp;400&nbsp;Bad&nbsp;Request&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;And&nbsp;this&nbsp;error when&nbsp;accessed&nbsp;through&nbsp;Squid&nbsp;itself:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ICAP&nbsp;protocol&nbsp;error.&lt;br&gt;&lt;br&gt;The&nbsp;system&nbsp;returned:&nbsp;[No&nbsp;Error]&lt;br&gt;&lt;br&gt;This&nbsp;means&nbsp;that&nbsp;some&nbsp;aspect&nbsp;of&nbsp;the&nbsp;ICAP&nbsp;communication&nbsp;failed.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;got&nbsp;this&nbsp;in&nbsp;my&nbsp;squid.conf:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#&nbsp;Enable&nbsp;ICAP&nbsp;for&nbsp;request&nbsp;and&nbsp;response&nbsp;modification&lt;br&gt;icap_enable&nbsp;on&lt;br&gt;icap_service&nbsp;service_req&nbsp;reqmod_precache&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/request_mod&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344/request_mod&lt;/a&gt;&lt;br&gt;icap_service&nbsp;service_resp&nbsp;respmod_precache&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/response_mod&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344/response_mod&lt;/a&gt;&lt;br&gt;&lt;br&gt;#&nbsp;ICAP&nbsp;adaptation&nbsp;rules&lt;br&gt;adaptation_access&nbsp;service_req&nbsp;allow&nbsp;all&lt;br&gt;adaptation_access&nbsp;service_resp&nbsp;allow&nbsp;all&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;I&#39;ve&nbsp;tried&nbsp;running&nbsp;both&nbsp;Python&nbsp;and&nbsp;Ruby&nbsp;servers&nbsp;taken&nbsp;from&nbsp;various&nbsp;places.&nbsp;A&nbsp;lot&nbsp;are&nbsp;logging&nbsp;that&nbsp;they&#39;ve&nbsp;received&nbsp;and&nbsp;replied&nbsp;to&nbsp;requests:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Received&nbsp;request:&nbsp;OPTIONS&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/request_mod&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344/request_mod&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;Responded&nbsp;to&nbsp;OPTIONS&nbsp;request&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;servers&nbsp;are&nbsp;all&nbsp;listening,&nbsp;I&#39;ve&nbsp;checked&nbsp;that:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;$&nbsp;ss&nbsp;-antp&nbsp;|&nbsp;grep&nbsp;1344&lt;br&gt;LISTEN&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 4096&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0:1344&quot;&nbsp;target=&quot;_blank&quot;&gt;0.0.0.0:1344&lt;/a&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:*&nbsp; &nbsp; &nbsp;users:((&quot;ruby&quot;,pid=563029,fd=5))&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;closest&nbsp;I&#39;ve&nbsp;got&nbsp;is&nbsp;this&nbsp;one:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://gist.github.com/digininja/a98b3567e0aeb218d37cdd337bb12f34&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/digininja/a98b3567e0aeb218d37cdd337bb12f34&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;be&nbsp;working&nbsp;as&nbsp;it&nbsp;sees&nbsp;the&nbsp;headers&nbsp;and&nbsp;says&nbsp;it&nbsp;has&nbsp;returned&nbsp;data:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Received&nbsp;request:&nbsp;REQMOD&nbsp;icap://&lt;a&nbsp;href=&quot;http://192.168.0.7:1344/request_mod&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344/request_mod&lt;/a&gt;&nbsp;ICAP/1.0&lt;br&gt;Original&nbsp;Headers:&lt;br&gt;Host:&nbsp;&lt;a&nbsp;href=&quot;http://192.168.0.7:1344&quot;&nbsp;target=&quot;_blank&quot;&gt;192.168.0.7:1344&lt;/a&gt;&lt;br&gt;Date:&nbsp;Fri,&nbsp;07&nbsp;Feb&nbsp;2025&nbsp;10:10:30&nbsp;GMT&lt;br&gt;Encapsulated:&nbsp;req-hdr=0,&nbsp;null-body=91&lt;br&gt;Preview:&nbsp;0&lt;br&gt;Allow:&nbsp;204,&nbsp;trailers&lt;br&gt;Modified&nbsp;request&nbsp;sent&nbsp;back&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;I&nbsp;still&nbsp;get&nbsp;errors.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;could&nbsp;be&nbsp;wrong?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;someone&nbsp;have&nbsp;some&nbsp;example&nbsp;server&nbsp;code&nbsp;they&nbsp;know&nbsp;works&nbsp;that&nbsp;I&nbsp;can&nbsp;test&nbsp;to&nbsp;help&nbsp;debug&nbsp;it?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Robin&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
