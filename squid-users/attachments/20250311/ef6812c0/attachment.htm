<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hello, &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&gt; &nbsp;FWIW,&nbsp;related&nbsp;future&nbsp;Squid&nbsp;improvements&nbsp;may&nbsp;include:&lt;br&gt;&lt;br&gt;&gt; &nbsp;*&nbsp;Detecting&nbsp;such&nbsp;shared&nbsp;memory&nbsp;segments&nbsp;clashes;&nbsp;refusing&nbsp;to&nbsp;start.&lt;br&gt;&gt; &nbsp;*&nbsp;Disabling&nbsp;shared&nbsp;memory&nbsp;use&nbsp;when&nbsp;caching&nbsp;is&nbsp;completely&nbsp;disabled.&lt;br&gt;&lt;br&gt;&gt; &nbsp;Quality&nbsp;pull&nbsp;requests&nbsp;welcome.&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;I&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;looked&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;at&nbsp;the&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;source&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;code&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;and&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;found&nbsp;the&nbsp;detection&nbsp;of&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;the&nbsp;presence&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;of&nbsp;old&nbsp;shared&nbsp;memory&nbsp;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;segments&nbsp;(&quot;src/ipc/mem/Segment.cc&quot;):&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;void&lt;br&gt;Ipc::Mem::Segment::create(const&nbsp;off_t&nbsp;aSize)&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;assert(aSize&nbsp;&gt;&nbsp;0);&lt;br&gt; &nbsp; &nbsp;assert(theFD&nbsp;&lt;&nbsp;0);&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;int&nbsp;xerrno&nbsp;=&nbsp;0;&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;//&nbsp;Why&nbsp;a&nbsp;brand&nbsp;new&nbsp;segment?&nbsp;A&nbsp;Squid&nbsp;crash&nbsp;may&nbsp;leave&nbsp;a&nbsp;reusable&nbsp;segment,&nbsp;but&lt;br&gt; &nbsp; &nbsp;//&nbsp;our&nbsp;placement-new&nbsp;code&nbsp;requires&nbsp;an&nbsp;all-0s&nbsp;segment.&nbsp;We&nbsp;could&nbsp;truncate&nbsp;and&lt;br&gt; &nbsp; &nbsp;//&nbsp;resize&nbsp;the&nbsp;old&nbsp;segment,&nbsp;but&nbsp;OS&nbsp;X&nbsp;does&nbsp;not&nbsp;allow&nbsp;using&nbsp;O_TRUNC&nbsp;with&lt;br&gt; &nbsp; &nbsp;//&nbsp;shm_open()&nbsp;and&nbsp;does&nbsp;not&nbsp;support&nbsp;ftruncate()&nbsp;for&nbsp;old&nbsp;segments.&lt;br&gt; &nbsp; &nbsp;if&nbsp;(!createFresh(xerrno)&nbsp;&amp;&amp;&nbsp;xerrno&nbsp;==&nbsp;EEXIST)&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;unlink();&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;createFresh(xerrno);&lt;br&gt; &nbsp; &nbsp;}&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;<br>
<br>
&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;But&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;,&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;as&lt;/span&gt;&nbsp;the&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;comment&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;says&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;,&lt;/span&gt;&nbsp;the&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;segments&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;may&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;remain&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;from&lt;/span&gt;&nbsp;the&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;previous&lt;/span&gt;&nbsp;Squid&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;crash&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;.&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;Thus&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;,&lt;/span&gt;&nbsp;in&nbsp;my&nbsp;opinion,&nbsp;it&nbsp;is&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;impractical&lt;/span&gt;&nbsp;to&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;refuse&lt;/span&gt;&nbsp;to&nbsp;launch&nbsp;the&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;program&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;.&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;I&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;think&lt;/span&gt;&nbsp;it&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;&#39;s&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;enough&lt;/span&gt;&nbsp;to&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;put&lt;/span&gt;&nbsp;a&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;warning&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;in&lt;/span&gt;&nbsp;the&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;code&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;when&lt;/span&gt;&nbsp;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;detecting&lt;/span&gt;&nbsp;old&nbsp;segments&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;Something&nbsp;like&nbsp;that:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;void&lt;br&gt;Ipc::Mem::Segment::create(const&nbsp;off_t&nbsp;aSize)&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;assert(aSize&nbsp;&gt;&nbsp;0);&lt;br&gt; &nbsp; &nbsp;assert(theFD&nbsp;&lt;&nbsp;0);&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;int&nbsp;xerrno&nbsp;=&nbsp;0;&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;//&nbsp;Why&nbsp;a&nbsp;brand&nbsp;new&nbsp;segment?&nbsp;A&nbsp;Squid&nbsp;crash&nbsp;may&nbsp;leave&nbsp;a&nbsp;reusable&nbsp;segment,&nbsp;but&lt;br&gt; &nbsp; &nbsp;//&nbsp;our&nbsp;placement-new&nbsp;code&nbsp;requires&nbsp;an&nbsp;all-0s&nbsp;segment.&nbsp;We&nbsp;could&nbsp;truncate&nbsp;and&lt;br&gt; &nbsp; &nbsp;//&nbsp;resize&nbsp;the&nbsp;old&nbsp;segment,&nbsp;but&nbsp;OS&nbsp;X&nbsp;does&nbsp;not&nbsp;allow&nbsp;using&nbsp;O_TRUNC&nbsp;with&lt;br&gt; &nbsp; &nbsp;//&nbsp;shm_open()&nbsp;and&nbsp;does&nbsp;not&nbsp;support&nbsp;ftruncate()&nbsp;for&nbsp;old&nbsp;segments.&lt;br&gt; &nbsp; &nbsp;if&nbsp;(!createFresh(xerrno)&nbsp;&amp;&amp;&nbsp;xerrno&nbsp;==&nbsp;EEXIST)&nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;&lt;b&gt;debugs(54,&nbsp;DBG_CRITICAL,&nbsp;&quot;WARNING:&nbsp;there&nbsp;is&nbsp;an&nbsp;old&nbsp;shared&nbsp;memory&nbsp;segment:&nbsp;&#39;&quot;&nbsp;&lt;&lt;&nbsp;theName&nbsp;&lt;&lt;&nbsp;&quot;&#39;.&nbsp;Perhaps&nbsp;it&nbsp;was&nbsp;left&nbsp;after&nbsp;the&nbsp;previous&nbsp;crash&nbsp;of&nbsp;the&nbsp;Squid.&nbsp;We&nbsp;will&nbsp;remove&nbsp;it.&nbsp;Or&nbsp;it&nbsp;may&nbsp;be&nbsp;a&nbsp;sign&nbsp;that&nbsp;another&nbsp;instance&nbsp;of&nbsp;the&nbsp;Squid&nbsp;is&nbsp;running. &nbsp;In&nbsp;this&nbsp;case,&nbsp;you&nbsp;must&nbsp;launch&nbsp;the&nbsp;program&nbsp;with&nbsp;the&nbsp;-n&nbsp;option&nbsp;and&nbsp;specify&nbsp;the&nbsp;unique&nbsp;name&nbsp;of&nbsp;the&nbsp;service.&quot;);&lt;/b&gt;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;unlink();&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;createFresh(xerrno);&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt;&lt;/font&gt;<br>
Kind&nbsp;regards,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;Ankor.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail-EzKURWReUAB5oZgtQNkl&quot;&nbsp;style=&quot;white-space-collapse:&nbsp;preserve;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&nbsp;gmail_quote_container&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;сб,&nbsp;8&nbsp;мар.&nbsp;2025 г.&nbsp;в&nbsp;08:14,&nbsp;Andrey&nbsp;K&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:ankor2023@gmail.com&quot;&gt;ankor2023@gmail.com&lt;/a&gt;&gt;:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;Alex,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;the&nbsp;analysis.&lt;/div&gt;&lt;div&gt;&lt;span&gt;Squid&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;only&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;allows&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;alphanumeric&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;characters&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt;&nbsp;the&nbsp;&lt;/span&gt;&lt;span&gt;service&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;name,&nbsp;&lt;/span&gt;&lt;span&gt;so&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;it&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;refuses&lt;/span&gt;&lt;span&gt;&nbsp;to&nbsp;&lt;/span&gt;&lt;span&gt;use&lt;/span&gt;&lt;span&gt;&nbsp;the&nbsp;&lt;/span&gt;&lt;span&gt;original&lt;/span&gt;&lt;span&gt;&nbsp;service&nbsp;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&nbsp;&lt;/span&gt;&lt;span&gt;in&nbsp;the&nbsp;&lt;font&nbsp;face=&quot;monospace&quot;&gt;-n&lt;/font&gt;&nbsp;option&nbsp;(&lt;font&nbsp;face=&quot;monospace&quot;&gt;-n&nbsp;squid.user.service)&lt;/font&gt;&lt;/span&gt;&lt;span&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;.&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;added&lt;font&nbsp;face=&quot;monospace&quot;&gt;&nbsp;-n&nbsp;squiduser&lt;/font&gt; option&nbsp;to&nbsp;the&nbsp;ExecStart&nbsp;string&nbsp;of&nbsp;the&nbsp;second&nbsp;instance.&lt;/div&gt;&lt;div&gt;Now&nbsp;it&nbsp;looks&nbsp;good:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;#&nbsp;the&nbsp;first&nbsp;instance&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;lsof&nbsp;-p&nbsp;3746105&nbsp;|&nbsp;grep&nbsp;shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp;525572&nbsp;1213614834&nbsp;/dev/shm/squid-cf__queues.shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; 136&nbsp;1213614835&nbsp;/dev/shm/squid-cf__readers.shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp; 8&nbsp;1213614833&nbsp;/dev/shm/squid-cf__metadata.shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; &nbsp; 7u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp; 8&nbsp;1213614833&nbsp;/dev/shm/squid-cf__metadata.shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; &nbsp; 8u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp;525572&nbsp;1213614834&nbsp;/dev/shm/squid-cf__queues.shm&lt;br&gt;squid&nbsp; &nbsp;3746105&nbsp;root&nbsp; &nbsp; 9u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; 136&nbsp;1213614835&nbsp;/dev/shm/squid-cf__readers.shm&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;monospace&quot;&gt;#&nbsp;the&nbsp;second&nbsp;instance&lt;br&gt;lsof&nbsp;-p&nbsp;3685356&nbsp;|&nbsp;grep&nbsp;shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp;2093368&nbsp;1212704041&nbsp;/dev/shm/squiduser-tls_session_cache.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; 525572&nbsp;1212704039&nbsp;/dev/shm/squiduser-cf__queues.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp;136&nbsp;1212704040&nbsp;/dev/shm/squiduser-cf__readers.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; mem&nbsp; &nbsp; REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8&nbsp;1212704038&nbsp;/dev/shm/squiduser-cf__metadata.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; &nbsp; 6u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8&nbsp;1212704038&nbsp;/dev/shm/squiduser-cf__metadata.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; &nbsp; 7u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; 525572&nbsp;1212704039&nbsp;/dev/shm/squiduser-cf__queues.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; &nbsp; 8u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp; &nbsp; &nbsp;136&nbsp;1212704040&nbsp;/dev/shm/squiduser-cf__readers.shm&lt;br&gt;squid.use&nbsp;3685356&nbsp;root&nbsp; &nbsp; 9u&nbsp; &nbsp;REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,23&nbsp; &nbsp;2093368&nbsp;1212704041&nbsp;/dev/shm/squiduser-tls_session_cache.shm&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Kind&nbsp;regards,&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; Ankor.&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;пт,&nbsp;7&nbsp;мар.&nbsp;2025 г.&nbsp;в&nbsp;17:48,&nbsp;Alex&nbsp;Rousskov&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:rousskov@measurement-factory.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rousskov@measurement-factory.com&lt;/a&gt;&gt;:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;2025-03-07&nbsp;06:50,&nbsp;Andrey&nbsp;K&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;Cache:&nbsp;Version&nbsp;6.13&lt;br&gt;<br>
&gt;&nbsp;Service&nbsp;Name:&nbsp;squid&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Squid&nbsp;Cache:&nbsp;Version&nbsp;6.10&lt;br&gt;<br>
&gt;&nbsp;Service&nbsp;Name:&nbsp;squid&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;the&nbsp;first&nbsp;instance&lt;br&gt;<br>
&gt;&nbsp;1318&nbsp;DEL &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30205&nbsp;/dev/shm/squid-cf__queues.shm&lt;br&gt;<br>
&gt;&nbsp;1318&nbsp;DEL &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30206&nbsp;/dev/shm/squid-cf__readers.shm&lt;br&gt;<br>
&gt;&nbsp;1318&nbsp;DEL &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30204&nbsp;/dev/shm/squid-cf__metadata.shm&lt;br&gt;<br>
&gt;&nbsp;1318 &nbsp; 8u&nbsp;... &nbsp; &nbsp; &nbsp;8 &nbsp; 30204&nbsp;/dev/shm/squid-cf__metadata.shm&nbsp;(deleted)&lt;br&gt;<br>
&gt;&nbsp;1318 &nbsp; 9u&nbsp;...&nbsp;525572 &nbsp; 30205&nbsp;/dev/shm/squid-cf__queues.shm&nbsp;(deleted)&lt;br&gt;<br>
&gt;&nbsp;1318 &nbsp;10u&nbsp;... &nbsp; &nbsp;136 &nbsp; 30206&nbsp;/dev/shm/squid-cf__readers.shm&nbsp;(deleted)&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;#&nbsp;the&nbsp;second&nbsp;instance&lt;br&gt;<br>
&gt;&nbsp;1514&nbsp;mem &nbsp;...&nbsp;2093368 &nbsp; 31497&nbsp;/dev/shm/squid-tls_session_cache.shm&lt;br&gt;<br>
&gt;&nbsp;1514&nbsp;mem &nbsp;... &nbsp;525572 &nbsp; 31495&nbsp;/dev/shm/squid-cf__queues.shm&lt;br&gt;<br>
&gt;&nbsp;1514&nbsp;mem &nbsp;... &nbsp; &nbsp; 136 &nbsp; 31496&nbsp;/dev/shm/squid-cf__readers.shm&lt;br&gt;<br>
&gt;&nbsp;1514&nbsp;mem &nbsp;... &nbsp; &nbsp; &nbsp; 8 &nbsp; 31494&nbsp;/dev/shm/squid-cf__metadata.shm&lt;br&gt;<br>
&gt;&nbsp;1514 &nbsp; 6u&nbsp;... &nbsp; &nbsp; &nbsp; 8 &nbsp; 31494&nbsp;/dev/shm/squid-cf__metadata.shm&lt;br&gt;<br>
&gt;&nbsp;1514 &nbsp; 7u&nbsp;... &nbsp;525572 &nbsp; 31495&nbsp;/dev/shm/squid-cf__queues.shm&lt;br&gt;<br>
&gt;&nbsp;1514 &nbsp; 8u&nbsp;... &nbsp; &nbsp; 136 &nbsp; 31496&nbsp;/dev/shm/squid-cf__readers.shm&lt;br&gt;<br>
&gt;&nbsp;1514 &nbsp; 9u&nbsp;...&nbsp;2093368 &nbsp; 31497&nbsp;/dev/shm/squid-tls_session_cache.shm&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;suspected,&nbsp;these&nbsp;two&nbsp;Squid&nbsp;instances&nbsp;use&nbsp;the&nbsp;same&nbsp;shared&nbsp;memory&nbsp;&lt;br&gt;<br>
segments&nbsp;(e.g.,&nbsp;/dev/shm/squid-cf*).&nbsp;Such&nbsp;shared&nbsp;use&nbsp;violates&nbsp;critical&nbsp;&lt;br&gt;<br>
code&nbsp;assumptions&nbsp;and&nbsp;results&nbsp;in&nbsp;undefined&nbsp;behavior.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;Maybe&nbsp;I&#39;m&nbsp;not&nbsp;experiencing&nbsp;any&nbsp;difficulties&nbsp;because&nbsp;I&nbsp;have&nbsp;caching&nbsp;turned&nbsp;off&nbsp;on&nbsp;&lt;br&gt;<br>
&gt;&nbsp;both&nbsp;instances?&lt;br&gt;<br>
&lt;br&gt;<br>
Well,&nbsp;you&nbsp;_are_&nbsp;experiencing&nbsp;at&nbsp;least&nbsp;one&nbsp;difficulty&nbsp;--&nbsp;the&nbsp;assertion&nbsp;&lt;br&gt;<br>
that&nbsp;started&nbsp;this&nbsp;email&nbsp;thread.&nbsp;If&nbsp;you&nbsp;have&nbsp;fully&nbsp;disabled&nbsp;caching,&nbsp;the&nbsp;&lt;br&gt;<br>
difficulties&nbsp;you&nbsp;experience&nbsp;should&nbsp;not&nbsp;include&nbsp;cache&nbsp;corruption.&nbsp;&lt;br&gt;<br>
However,&nbsp;it&nbsp;looks&nbsp;like&nbsp;at&nbsp;least&nbsp;one&nbsp;of&nbsp;the&nbsp;two&nbsp;instances&nbsp;does&nbsp;cache&nbsp;TLS&nbsp;&lt;br&gt;<br>
sessions&nbsp;(in&nbsp;/dev/shm/squid-tls_session_cache.shm).&nbsp;If&nbsp;both&nbsp;instances&nbsp;do&nbsp;&lt;br&gt;<br>
that,&nbsp;then&nbsp;all&nbsp;bets&nbsp;are&nbsp;off!&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
FWIW,&nbsp;related&nbsp;future&nbsp;Squid&nbsp;improvements&nbsp;may&nbsp;include:&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;Detecting&nbsp;such&nbsp;shared&nbsp;memory&nbsp;segments&nbsp;clashes;&nbsp;refusing&nbsp;to&nbsp;start.&lt;br&gt;<br>
*&nbsp;Disabling&nbsp;shared&nbsp;memory&nbsp;use&nbsp;when&nbsp;caching&nbsp;is&nbsp;completely&nbsp;disabled.&lt;br&gt;<br>
&lt;br&gt;<br>
Quality&nbsp;pull&nbsp;requests&nbsp;welcome.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers,&lt;br&gt;<br>
&lt;br&gt;<br>
Alex.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;чт,&nbsp;6&nbsp;мар.&nbsp;2025 г.&nbsp;в&nbsp;17:11,&nbsp;Alex&nbsp;Rousskov:&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; On&nbsp;2025-03-06&nbsp;08:59,&nbsp;Amos&nbsp;Jeffries&nbsp;wrote:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;On&nbsp;6/03/25&nbsp;19:17,&nbsp;Andrey&nbsp;K&nbsp;wrote:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;Hello,&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;similar configuration:&nbsp;two&nbsp;SMP&nbsp;squids&nbsp;running&nbsp;on&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; same&nbsp;OEL&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;host.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;They&nbsp;were&nbsp;built&nbsp;with&nbsp;different&nbsp;configurations:&nbsp;with&nbsp;different&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;installation&nbsp;path&nbsp;prefixes&nbsp;and&nbsp;different names&nbsp;of&nbsp;binary&nbsp;files:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; squid&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;and&nbsp;squid.user&nbsp;and&nbsp;they&nbsp;listen&nbsp;to&nbsp;different&nbsp;ports.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;They&nbsp;are&nbsp;launched from&nbsp;two&nbsp;different&nbsp;services:squid.service&nbsp;and&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;squid.user.service&nbsp;with&nbsp;the&nbsp;service&nbsp;Type=forking:&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;   &nbsp;ExecStart=/usr/sbin/squid&nbsp;-sYC&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;   &nbsp;ExecStart=/sbin/squid.user&nbsp;-f&nbsp;/etc/squid.user/squid.conf&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;I&nbsp;have&nbsp;not&nbsp;experienced&nbsp;any&nbsp;troubles&nbsp;with&nbsp;this&nbsp;configuration&nbsp;yet.&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;/&gt;&nbsp;Please&nbsp;be&nbsp;aware&nbsp;that&nbsp;&quot;squid&nbsp;-n&nbsp;...&quot;&nbsp;is&nbsp;a&nbsp;REQUIREMENT&nbsp;for&nbsp;running/&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;/multiple&nbsp;Squid&nbsp;instances&nbsp;on&nbsp;the&nbsp;same&nbsp;machine&nbsp;regardless&nbsp;of&nbsp;what&lt;br&gt;<br>
&gt; &nbsp; &nbsp; features&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;are&nbsp;used./&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;Could&nbsp;you&nbsp;please tell&nbsp;me&nbsp;if&nbsp;I&nbsp;should&nbsp;use&nbsp;the&nbsp;-n&nbsp;option&nbsp;in&nbsp;the&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;ExecStart&nbsp;strings?&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;The&nbsp;arguments&nbsp;of&nbsp;the&nbsp;options&nbsp;should&nbsp;be&nbsp;the&nbsp;service&nbsp;names?&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;   &nbsp;ExecStart=/usr/sbin/squid&nbsp;-sYC&nbsp;-n&nbsp;squid.service&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;   &nbsp;ExecStart=/sbin/squid.user&nbsp;-f&nbsp;/etc/squid.user/squid.conf&nbsp;-n&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&nbsp;   &nbsp;squid.user.service&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;Yes&nbsp;you&nbsp;should.&nbsp;The&nbsp;different&nbsp;./configure&nbsp;options&nbsp;has&nbsp;helped&nbsp;you&lt;br&gt;<br>
&gt; &nbsp; &nbsp; avoid&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &nbsp;&gt;&nbsp;major&nbsp;issues,&nbsp;but&nbsp;some&nbsp;may&nbsp;still&nbsp;appear.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; I&nbsp;agree.&nbsp;Moreover,&nbsp;I&nbsp;do&nbsp;not&nbsp;understand&nbsp;how&nbsp;your&nbsp;two&nbsp;SMP&nbsp;Squids&nbsp;could&lt;br&gt;<br>
&gt; &nbsp; &nbsp; work&nbsp;correctly&nbsp;without&nbsp;distinct&nbsp;service&nbsp;names&nbsp;because&nbsp;(on&nbsp;OEL)&nbsp;I&nbsp;would&lt;br&gt;<br>
&gt; &nbsp; &nbsp; expect&nbsp;them&nbsp;to&nbsp;share&nbsp;the&nbsp;same&nbsp;shared&nbsp;memory&nbsp;segments&nbsp;(which&nbsp;they&nbsp;must&lt;br&gt;<br>
&gt; &nbsp; &nbsp; not&nbsp;do&nbsp;to&nbsp;remain&nbsp;distinct&nbsp;instances).&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; What&nbsp;is&nbsp;your&nbsp;Squid&nbsp;version?&nbsp;Can&nbsp;you&nbsp;tell&nbsp;how&nbsp;your&nbsp;Squids&nbsp;name&nbsp;their&lt;br&gt;<br>
&gt; &nbsp; &nbsp; shared&nbsp;memory&nbsp;segment&nbsp;&quot;files&quot;?&nbsp;For&nbsp;example,&nbsp;on&nbsp;some&nbsp;Linux&nbsp;OSes,&nbsp;those&lt;br&gt;<br>
&gt; &nbsp; &nbsp; segments&nbsp;could&nbsp;be&nbsp;in&nbsp;/var/run/shm/&nbsp;with&nbsp;names&nbsp;like&lt;br&gt;<br>
&gt; &nbsp; &nbsp; squid-tr_map_anchors.shm &nbsp;and&nbsp;squid-tr_spaces.shm.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Thank&nbsp;you,&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; Alex.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; _______________________________________________&lt;br&gt;<br>
&gt; &nbsp; &nbsp; squid-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;mailto:&lt;a&nbsp;href=&quot;mailto:squid-users@lists.squid-cache.org&quot;&nbsp;target=&quot;_blank&quot;&gt;squid-users@lists.squid-cache.org&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;a&nbsp;href=&quot;https://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&lt;br&gt;<br>
&gt; &nbsp; &nbsp; &lt;&lt;a&nbsp;href=&quot;https://lists.squid-cache.org/listinfo/squid-users&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://lists.squid-cache.org/listinfo/squid-users&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
