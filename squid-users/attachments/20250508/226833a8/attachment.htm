<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;Hey&nbsp;Squid&nbsp;community,&lt;br&gt;&lt;br&gt;I&nbsp;would&nbsp;greatly&nbsp;appreciate&nbsp;a&nbsp;hint&nbsp;on&nbsp;how&nbsp;to&nbsp;configure&nbsp;Squid&nbsp;to&nbsp;achieve&nbsp;the&nbsp;following:&lt;br&gt;&lt;br&gt;Context&lt;br&gt;========&lt;br&gt;Transparent&nbsp;HTTP/S&nbsp;proxy&nbsp;(ideally&nbsp;no&nbsp;TLS&nbsp;re-encryption)&lt;br&gt;Domain&nbsp;allowlist&nbsp;acl&lt;br&gt;Squid&nbsp;v6.13&lt;br&gt;&lt;br&gt;Goal&lt;br&gt;========&lt;br&gt;Have&nbsp;Squid&nbsp;&quot;inspect&quot;&nbsp;HTTPS&nbsp;requests&nbsp;(as&nbsp;much&nbsp;as&nbsp;possible/needed&nbsp;with&nbsp;the&nbsp;actions&nbsp;provided&nbsp;by&nbsp;ssl_bump)&nbsp;and&nbsp;perform&nbsp;the&nbsp;host&nbsp;header&nbsp;forgery&nbsp;check&nbsp;in&nbsp;addition&nbsp;to&nbsp;checking&nbsp;if&nbsp;the&nbsp;host&nbsp;extracted&nbsp;from&nbsp;SNI&nbsp;matches&nbsp;the&nbsp;domain&nbsp;allowlist&nbsp;acl.&lt;br&gt;The&nbsp;configuration&nbsp;should&nbsp;basically&nbsp;prevent&nbsp;this:&nbsp;]$&nbsp;curl&nbsp;--insecure&nbsp;--resolve&nbsp;&lt;domain&nbsp;on&nbsp;allowlist&gt;:443:&lt;arbitrary&nbsp;IP&nbsp;not&nbsp;associated&nbsp;with&nbsp;domain&gt;&nbsp;https://&lt;domain&nbsp;on&nbsp;allowlist&gt;&lt;br&gt;&lt;br&gt;It&nbsp;seems&nbsp;like&nbsp;all&nbsp;the&nbsp;necessary&nbsp;tools&nbsp;are&nbsp;provided,&nbsp;and&nbsp;I&nbsp;see&nbsp;hints&nbsp;pointing&nbsp;to&nbsp;this&nbsp;possibility,&nbsp;e.g.&nbsp;&lt;a&nbsp;href=&quot;https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery&quot;&gt;https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery&lt;/a&gt;&nbsp;(the&nbsp;INFO&nbsp;box)&nbsp;but&nbsp;I&#39;m&nbsp;having&nbsp;trouble&nbsp;using&nbsp;them&nbsp;to&nbsp;accomplish&nbsp;the&nbsp;desired&nbsp;effect.&lt;br&gt;The&nbsp;host_verify_strict&nbsp;option&nbsp;seems&nbsp;to&nbsp;solve&nbsp;this&nbsp;for&nbsp;unencrypted&nbsp;HTTP&nbsp;and&nbsp;I&nbsp;got&nbsp;the&nbsp;domain&nbsp;allowlist&nbsp;to&nbsp;work&nbsp;for&nbsp;HTTP&nbsp;+&nbsp;HTTPS&nbsp;-&nbsp;it&#39;s&nbsp;just&nbsp;easily&nbsp;circumvented&nbsp;by&nbsp;the&nbsp;curl&nbsp;above&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;HTTPS.&lt;br&gt;&lt;br&gt;A&nbsp;rough&nbsp;idea&nbsp;about&nbsp;the&nbsp;order/placement&nbsp;of&nbsp;the&nbsp;acls&nbsp;involved&nbsp;(relative&nbsp;to&nbsp;the&nbsp;ssl_bump&nbsp;steps&nbsp;where&nbsp;applicable)&nbsp;would&nbsp;help&nbsp;a&nbsp;lot.&lt;br&gt;&lt;br&gt;Cheers,&lt;br&gt;Adrian&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
