<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;overflow-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;&lt;p&nbsp;data-start=&quot;1520&quot;&nbsp;data-end=&quot;1548&quot;&gt;Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;response.&lt;/p&gt;&lt;p&nbsp;data-start=&quot;1550&quot;&nbsp;data-end=&quot;1642&quot;&gt;Based&nbsp;on&nbsp;your&nbsp;reply,&nbsp;we&nbsp;have&nbsp;reviewed&nbsp;the&nbsp;configuration&nbsp;and&nbsp;observed&nbsp;the&nbsp;following&nbsp;behavior.&lt;/p&gt;&lt;h3&nbsp;data-start=&quot;1649&quot;&nbsp;data-end=&quot;1685&quot;&gt;■&nbsp;Relevant&nbsp;Configuration&nbsp;Snippet&lt;/h3&gt;&lt;pre&nbsp;class=&quot;overflow-visible!&quot;&nbsp;data-start=&quot;1687&quot;&nbsp;data-end=&quot;1865&quot;&gt;&lt;div&nbsp;class=&quot;contain-inline-size&nbsp;rounded-md&nbsp;border-[0.5px]&nbsp;border-token-border-medium&nbsp;relative&nbsp;bg-token-sidebar-surface-primary&quot;&gt;&lt;div&nbsp;class=&quot;flex&nbsp;items-center&nbsp;text-token-text-secondary&nbsp;px-4&nbsp;py-2&nbsp;text-xs&nbsp;font-sans&nbsp;justify-between&nbsp;h-9&nbsp;bg-token-sidebar-surface-primary&nbsp;dark:bg-token-main-surface-secondary&nbsp;select-none&nbsp;rounded-t-[5px]&quot;&gt;acl&nbsp;bump_targets&nbsp;ssl::server_name&nbsp;&quot;/home/user001/ssl_bump/ssl_bump_domain&quot;&lt;/div&gt;&lt;div&nbsp;class=&quot;overflow-y-auto&nbsp;p-4&quot;&nbsp;dir=&quot;ltr&quot;&gt;&lt;code&nbsp;class=&quot;whitespace-pre!&nbsp;language-squid&quot;&gt;ssl_bump&nbsp;stare&nbsp;step1<br>
ssl_bump&nbsp;bump&nbsp;step2&nbsp;bump_targets<br>
ssl_bump&nbsp;splice&nbsp;step2&nbsp;!bump_targets<br>
&lt;/code&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;p&nbsp;data-start=&quot;1867&quot;&nbsp;data-end=&quot;1931&quot;&gt;The&nbsp;&lt;code&nbsp;data-start=&quot;1871&quot;&nbsp;data-end=&quot;1911&quot;&gt;/home/user001/ssl_bump/ssl_bump_domain&lt;/code&gt;&nbsp;file&nbsp;includes&nbsp;only:&lt;/p&gt;&lt;pre&nbsp;class=&quot;overflow-visible!&quot;&nbsp;data-start=&quot;1933&quot;&nbsp;data-end=&quot;2017&quot;&gt;&lt;div&nbsp;class=&quot;contain-inline-size&nbsp;rounded-md&nbsp;border-[0.5px]&nbsp;border-token-border-medium&nbsp;relative&nbsp;bg-token-sidebar-surface-primary&quot;&gt;&lt;div&nbsp;class=&quot;overflow-y-auto&nbsp;p-4&quot;&nbsp;dir=&quot;ltr&quot;&gt;&lt;code&nbsp;class=&quot;whitespace-pre!&nbsp;language-bash&quot;&gt;[root@host&nbsp;squid]&lt;span&nbsp;class=&quot;hljs-comment&quot;&gt;#&nbsp;cat&nbsp;/home/user001/ssl_bump/ssl_bump_domain&lt;/span&gt;<br>
github.com&lt;/code&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div&gt;&lt;h3&nbsp;data-start=&quot;2024&quot;&nbsp;data-end=&quot;2043&quot;&gt;■&nbsp;Observed&nbsp;Logs&lt;/h3&gt;&lt;pre&nbsp;class=&quot;overflow-visible!&quot;&nbsp;data-start=&quot;2045&quot;&nbsp;data-end=&quot;2317&quot;&gt;&lt;div&nbsp;class=&quot;contain-inline-size&nbsp;rounded-md&nbsp;border-[0.5px]&nbsp;border-token-border-medium&nbsp;relative&nbsp;bg-token-sidebar-surface-primary&quot;&gt;&lt;div&nbsp;class=&quot;overflow-y-auto&nbsp;p-4&quot;&nbsp;dir=&quot;ltr&quot;&gt;&lt;code&nbsp;class=&quot;whitespace-pre!&nbsp;language-log&quot;&gt;26.56.128.144&nbsp;-&nbsp;-&nbsp;[28/May/2025:10:25:18&nbsp;+0900]&nbsp;&quot;CONNECT&nbsp;mariadb.org:443&nbsp;HTTP/1.1&quot;&nbsp;200&nbsp;0&nbsp;&quot;-&quot;&nbsp;&quot;curl/8.5.0&quot;&nbsp;TCP_DENIED:HIER_NONE<br>
26.56.128.144&nbsp;-&nbsp;-&nbsp;[28/May/2025:10:25:18&nbsp;+0900]&nbsp;&quot;GET&nbsp;https://mariadb.org/donate/&nbsp;HTTP/1.1&quot;&nbsp;403&nbsp;4076&nbsp;&quot;-&quot;&nbsp;&quot;curl/8.5.0&quot;&nbsp;NONE_NONE:HIER_NONE<br>
&lt;/code&gt;&lt;/div&gt;&lt;/div&gt;&lt;/pre&gt;&lt;p&nbsp;data-start=&quot;2319&quot;&nbsp;data-end=&quot;2532&quot;&gt;As&nbsp;&lt;code&nbsp;data-start=&quot;2322&quot;&nbsp;data-end=&quot;2335&quot;&gt;mariadb.org&lt;/code&gt;&nbsp;is&nbsp;&lt;strong&nbsp;data-start=&quot;2339&quot;&nbsp;data-end=&quot;2383&quot;&gt;not&nbsp;listed&nbsp;in&nbsp;the&nbsp;&lt;code&nbsp;data-start=&quot;2359&quot;&nbsp;data-end=&quot;2376&quot;&gt;ssl_bump_domain&lt;/code&gt;&nbsp;file&lt;/strong&gt;,&nbsp;we&nbsp;expected&nbsp;it&nbsp;to&nbsp;be&nbsp;spliced.&nbsp;However,&nbsp;the&nbsp;log&nbsp;indicates&nbsp;that&nbsp;Squid&nbsp;is&nbsp;able&nbsp;to&nbsp;see&nbsp;the&nbsp;full&nbsp;HTTPS&nbsp;URL,&nbsp;implying&nbsp;the&nbsp;connection&nbsp;was&nbsp;actually&nbsp;bumped.&lt;/p&gt;&lt;/div&gt;&lt;div&gt;&lt;h3&nbsp;data-start=&quot;2539&quot;&nbsp;data-end=&quot;2569&quot;&gt;■&nbsp;Main&nbsp;Clarification&nbsp;Point&lt;/h3&gt;&lt;p&nbsp;data-start=&quot;2571&quot;&nbsp;data-end=&quot;2613&quot;&gt;The&nbsp;key&nbsp;point&nbsp;we&nbsp;would&nbsp;like&nbsp;to&nbsp;confirm&nbsp;is:&lt;/p&gt;&lt;blockquote&nbsp;data-start=&quot;2615&quot;&nbsp;data-end=&quot;2896&quot;&gt;&lt;p&nbsp;data-start=&quot;2617&quot;&nbsp;data-end=&quot;2896&quot;&gt;&lt;strong&nbsp;data-start=&quot;2617&quot;&nbsp;data-end=&quot;2896&quot;&gt;In&nbsp;a&nbsp;configuration&nbsp;where&nbsp;&lt;code&nbsp;data-start=&quot;2644&quot;&nbsp;data-end=&quot;2654&quot;&gt;ssl_bump&lt;/code&gt;&nbsp;is&nbsp;enabled,&nbsp;does&nbsp;Squid&nbsp;still&nbsp;allow&nbsp;the&nbsp;initial&nbsp;CONNECT&nbsp;request&nbsp;(returning&nbsp;200)&nbsp;even&nbsp;for&nbsp;non-whitelisted&nbsp;domains,&nbsp;then&nbsp;wait&nbsp;for&nbsp;the&nbsp;client&nbsp;to&nbsp;send&nbsp;a&nbsp;follow-up&nbsp;HTTPS&nbsp;request&nbsp;(e.g.,&nbsp;GET),&nbsp;which&nbsp;is&nbsp;then&nbsp;bumped&nbsp;and&nbsp;blocked&nbsp;(e.g.,&nbsp;403)&nbsp;by&nbsp;Squid?&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&nbsp;data-start=&quot;2898&quot;&nbsp;data-end=&quot;2915&quot;&gt;Or&nbsp;alternatively:&lt;/p&gt;&lt;blockquote&nbsp;data-start=&quot;2917&quot;&nbsp;data-end=&quot;3091&quot;&gt;&lt;p&nbsp;data-start=&quot;2919&quot;&nbsp;data-end=&quot;3091&quot;&gt;&lt;strong&nbsp;data-start=&quot;2919&quot;&nbsp;data-end=&quot;3091&quot;&gt;Is&nbsp;Squid&nbsp;intentionally&nbsp;connecting&nbsp;to&nbsp;the&nbsp;origin&nbsp;server&nbsp;after&nbsp;CONNECT&nbsp;in&nbsp;order&nbsp;to&nbsp;generate&nbsp;an&nbsp;error&nbsp;page&nbsp;(403&nbsp;etc.)&nbsp;that&nbsp;can&nbsp;be&nbsp;properly&nbsp;displayed&nbsp;to&nbsp;the&nbsp;client&nbsp;browser?&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;p&nbsp;data-start=&quot;3093&quot;&nbsp;data-end=&quot;3199&quot;&gt;We&nbsp;would&nbsp;greatly&nbsp;appreciate&nbsp;clarification&nbsp;on&nbsp;the&nbsp;expected&nbsp;behavior&nbsp;and&nbsp;underlying&nbsp;mechanism&nbsp;in&nbsp;such&nbsp;cases.&lt;/p&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;2025/05/28&nbsp;1:19、Alex&nbsp;Rousskov&nbsp;&lt;rousskov@measurement-factory.com&gt;のメール:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&gt;&lt;div&gt;On&nbsp;2025-05-27&nbsp;10:37,&nbsp;Yves&nbsp;MARTIN&nbsp;wrote:&lt;br&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;My&nbsp;team&nbsp;expects&nbsp;to&nbsp;transparently&nbsp;rewrite&nbsp;requests&nbsp;through&nbsp;squid,&nbsp;replacing&nbsp;original&nbsp;URL/hostname&nbsp;by&nbsp;another&nbsp;target&nbsp;URL/host.&lt;br&gt;Main&nbsp;objective&nbsp;is&nbsp;to&nbsp;redirect&nbsp;original&nbsp;HTTPS&nbsp;requests&nbsp;triggered&nbsp;by&nbsp;“docker&nbsp;pull&nbsp;alpine”&nbsp;to&nbsp;a&nbsp;local&nbsp;mirrored&nbsp;registry&nbsp;without&nbsp;obvious&nbsp;information&nbsp;in&nbsp;user&nbsp;client&nbsp;that&nbsp;the&nbsp;obtained&nbsp;image&nbsp;comes&nbsp;from&nbsp;mirror:&nbsp;original&nbsp;image&nbsp;location&nbsp;is&nbsp;preserved,&nbsp;no&nbsp;specific&nbsp;proxy&nbsp;or&nbsp;mirror&nbsp;configuration&nbsp;in&nbsp;docker&nbsp;client/daemon&nbsp;to&nbsp;set.&lt;br&gt;To&nbsp;do&nbsp;so,&nbsp;we&nbsp;have&nbsp;used&nbsp;squid-urlrewrite&nbsp;and&nbsp;it&nbsp;works&nbsp;well&nbsp;for&nbsp;HTTP&nbsp;request,&nbsp;even&nbsp;if&nbsp;rewrite&nbsp;targets&nbsp;HTTPS&nbsp;URL.&lt;br&gt;But&nbsp;when&nbsp;original&nbsp;request&nbsp;is&nbsp;HTTPS,&nbsp;connection&nbsp;still&nbsp;goes&nbsp;to&nbsp;original&nbsp;URL/hostname&nbsp;IP&nbsp;address&nbsp;https://github.com/rchunping/squid-urlrewrite/issues/3&nbsp;According&nbsp;to&nbsp;debug&nbsp;logs,&nbsp;the&nbsp;original&nbsp;request&nbsp;hostname&nbsp;is&nbsp;resolved&nbsp;to&nbsp;IP&nbsp;early&nbsp;and&nbsp;kept&nbsp;in&nbsp;internal&nbsp;context&nbsp;after&nbsp;squid-urlrewrite&nbsp;is&nbsp;invoked.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;In&nbsp;most&nbsp;cases,&nbsp;when&nbsp;bumping&nbsp;connections&nbsp;from&nbsp;a&nbsp;TLS&nbsp;client&nbsp;to&nbsp;Squid&nbsp;and&nbsp;from&nbsp;Squid&nbsp;to&nbsp;TLS&nbsp;server,&nbsp;Squid&nbsp;&quot;pins&quot;&nbsp;(i.e.&nbsp;remembers)&nbsp;the&nbsp;Squid-to-server&nbsp;connection&nbsp;and&nbsp;then&nbsp;(re)uses&nbsp;that&nbsp;pinned&nbsp;connection&nbsp;for&nbsp;all&nbsp;requests&nbsp;received&nbsp;on&nbsp;the&nbsp;client-to-Squid&nbsp;connection.&lt;br&gt;&lt;br&gt;I&nbsp;have&nbsp;not&nbsp;checked,&nbsp;but&nbsp;speculate&nbsp;that&nbsp;rewriting&nbsp;request&nbsp;target&nbsp;does&nbsp;not&nbsp;trigger&nbsp;opening&nbsp;a&nbsp;new&nbsp;Squid-to-server&nbsp;TLS&nbsp;connection&nbsp;and&nbsp;re-pinning.&lt;br&gt;&lt;br&gt;IIRC,&nbsp;a&nbsp;Squid&nbsp;that&nbsp;is&nbsp;configured&nbsp;to&nbsp;bump&nbsp;during&nbsp;SslBump&nbsp;step1&nbsp;does&nbsp;not&nbsp;pin.&nbsp;Such&nbsp;a&nbsp;configuration&nbsp;is&nbsp;rarely&nbsp;usable&nbsp;on&nbsp;a&nbsp;modern&nbsp;internet,&nbsp;but&nbsp;YMMV.&lt;br&gt;&lt;br&gt;&lt;br&gt;HTH,&lt;br&gt;&lt;br&gt;Alex.&lt;br&gt;_______________________________________________&lt;br&gt;squid-users&nbsp;mailing&nbsp;list&lt;br&gt;squid-users@lists.squid-cache.org&lt;br&gt;https://lists.squid-cache.org/listinfo/squid-users&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
