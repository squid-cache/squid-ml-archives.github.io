<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;p&gt;Hello&nbsp;everyone,&lt;/p&gt;<br>
&lt;p&gt;I&nbsp;am&nbsp;currently&nbsp;deploying&nbsp;Squid&nbsp;3.5.12&nbsp;on&nbsp;Ubuntu&nbsp;Xenial&nbsp;for&nbsp;URL&nbsp;filtering&nbsp;over&nbsp;multiple&nbsp;VLANs&nbsp;using&nbsp;WCCP.&lt;/p&gt;<br>
&lt;p&gt;&lt;strong&gt;Context:&lt;/strong&gt;&lt;/p&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;HTTP&nbsp;traffic&nbsp;is&nbsp;successfully&nbsp;redirected&nbsp;from&nbsp;my&nbsp;Cisco&nbsp;router&nbsp;to&nbsp;Squid&nbsp;via&nbsp;WCCP&nbsp;(Service&nbsp;0).&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;HTTPS&nbsp;traffic&nbsp;is&nbsp;redirected&nbsp;via&nbsp;WCCP&nbsp;(Service&nbsp;70),&nbsp;GRE&nbsp;tunnel&nbsp;works,&nbsp;redirection&nbsp;appears&nbsp;fine&nbsp;on&nbsp;the&nbsp;router&nbsp;side.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;On&nbsp;my&nbsp;Squid&nbsp;box,&nbsp;iptables&nbsp;properly&nbsp;redirects:&lt;/p&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;TCP&nbsp;80&nbsp;→&nbsp;3127&nbsp;(intercept)&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;TCP&nbsp;443&nbsp;→&nbsp;3128&nbsp;(ssl-bump)&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;/ul&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;My&nbsp;Squid&nbsp;config&nbsp;listens&nbsp;properly&nbsp;on&nbsp;3127&nbsp;and&nbsp;3128&nbsp;with&nbsp;ssl-bump.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;/ul&gt;<br>
&lt;p&gt;&lt;strong&gt;Problem:&lt;/strong&gt;&lt;/p&gt;<br>
&lt;ul&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;HTTP&nbsp;filtering&nbsp;works&nbsp;perfectly&nbsp;via&nbsp;WCCP.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;HTTPS&nbsp;connections&nbsp;show&nbsp;&lt;strong&gt;no&nbsp;traffic&nbsp;hitting&nbsp;Squid&#39;s&nbsp;3128&nbsp;port&lt;/strong&gt;&nbsp;(confirmed&nbsp;via&nbsp;&lt;code&gt;access.log&lt;/code&gt;&nbsp;and&nbsp;&lt;code&gt;ss&nbsp;-tulnp&lt;/code&gt;).&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;Yet&nbsp;WCCP&nbsp;router&nbsp;counters&nbsp;show&nbsp;packets&nbsp;being&nbsp;redirected&nbsp;for&nbsp;HTTPS.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;If&nbsp;I&nbsp;manually&nbsp;configure&nbsp;the&nbsp;proxy&nbsp;on&nbsp;a&nbsp;browser,&nbsp;both&nbsp;HTTP&nbsp;and&nbsp;HTTPS&nbsp;are&nbsp;filtered&nbsp;correctly.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;If&nbsp;I&nbsp;disable&nbsp;ssl-bump&nbsp;and&nbsp;WCCP&nbsp;for&nbsp;HTTPS,&nbsp;normal&nbsp;navigation&nbsp;resumes.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;/ul&gt;<br>
&lt;p&gt;&lt;strong&gt;iptables&nbsp;NAT&nbsp;rules:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;REDIRECT&nbsp;tcp&nbsp;--&nbsp;gre1&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp;tcp&nbsp;dpt:80&nbsp;redir&nbsp;ports&nbsp;3127&nbsp; &lt;br&gt;REDIRECT&nbsp;tcp&nbsp;--&nbsp;gre1&nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp;&lt;a&nbsp;href=&quot;http://0.0.0.0/0&quot;&gt;0.0.0.0/0&lt;/a&gt;&nbsp;tcp&nbsp;dpt:443&nbsp;redir&nbsp;ports&nbsp;3128  &lt;br&gt;&lt;/p&gt;&lt;p&gt;Squid&nbsp;config&nbsp;(extract):&lt;/p&gt;&lt;p&gt; &nbsp;http_port&nbsp;3127&nbsp;intercept&lt;/p&gt;http_port&nbsp;3128&nbsp;ssl-bump&nbsp;cert=/etc/squid/ssl_sert/myCA.pem&nbsp;key=/etc/squid/ssl_sert/ca-key.pem&nbsp;generate-host-certificates=on&nbsp;dynamic_cert_mem_cache_size=4MB&lt;br&gt;sslcrtd_program&nbsp;/usr/libexec/ssl_crtd&nbsp;-s&nbsp;/var/lib/ssl_db&nbsp;-M&nbsp;4MB&lt;br&gt;&lt;br&gt;acl&nbsp;step1&nbsp;at_step&nbsp;SslBump1&lt;br&gt;ssl_bump&nbsp;peek&nbsp;step1&lt;br&gt;ssl_bump&nbsp;bump&nbsp;all&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;p&gt;&lt;strong&gt;Questions:&lt;/strong&gt;&lt;/p&gt;<br>
&lt;ol&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;Why&nbsp;does&nbsp;HTTPS&nbsp;via&nbsp;WCCP&nbsp;not&nbsp;reach&nbsp;Squid&nbsp;3128&nbsp;(ssl-bump)&nbsp;while&nbsp;HTTP&nbsp;works&nbsp;fine?&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;Is&nbsp;my&nbsp;WCCP&nbsp;setup&nbsp;wrong&nbsp;for&nbsp;HTTPS?&nbsp;I&nbsp;use&nbsp;service&nbsp;ID&nbsp;70&nbsp;with&nbsp;destination&nbsp;port&nbsp;443.&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;Could&nbsp;the&nbsp;lack&nbsp;of&nbsp;DNS&nbsp;resolution&nbsp;or&nbsp;browser&nbsp;certificate&nbsp;trust&nbsp;cause&nbsp;the&nbsp;traffic&nbsp;not&nbsp;to&nbsp;appear&nbsp;at&nbsp;all&nbsp;in&nbsp;Squid&nbsp;logs?&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;li&gt;<br>
&lt;p&gt;Am&nbsp;I&nbsp;missing&nbsp;something&nbsp;obvious&nbsp;between&nbsp;the&nbsp;router&nbsp;WCCP&nbsp;and&nbsp;Squid’s&nbsp;ssl-bump&nbsp;setup?&lt;/p&gt;<br>
&lt;/li&gt;<br>
&lt;/ol&gt;<br>
&lt;p&gt;Thank&nbsp;you&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;suggestions&nbsp;or&nbsp;troubleshooting&nbsp;steps.&lt;/p&gt;<br>
&lt;p&gt;Best&nbsp;regards,&lt;/p&gt;&lt;p&gt;Assoham&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;<br>
<br>
&lt;br&gt;<br>
&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-size:10pt;font-family:Arial&quot;&gt;******************************&lt;wbr&gt;******************************&lt;wbr&gt;******************&lt;br&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-size:8pt;font-family:Arial&quot;&gt;The&nbsp;information&nbsp;contained&nbsp;herein&nbsp;may&nbsp;be&nbsp;company&nbsp;confidential&nbsp;and&nbsp;proprietary.&nbsp;The&nbsp;information&nbsp;is&nbsp;intended&nbsp;only&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;named&nbsp;individual&nbsp;or&nbsp;entity.&nbsp;If&nbsp;you&nbsp;are&nbsp;not&nbsp;the&nbsp;intended&nbsp;recipient,&nbsp;the&nbsp;employee&nbsp;or&nbsp;agent&nbsp;responsible&nbsp;for&nbsp;delivering&nbsp;it&nbsp;to&nbsp;the&nbsp;intended&nbsp;recipient,&nbsp;you&nbsp;are&nbsp;hereby&nbsp;notified&nbsp;that&nbsp;any&nbsp;use,&nbsp;dissemination,&nbsp;distribution&nbsp;or&nbsp;copying&nbsp;of&nbsp;this&nbsp;communication&nbsp;is&nbsp;strictly&nbsp;prohibited.&nbsp;If&nbsp;you&nbsp;have&nbsp;received&nbsp;this&nbsp;communication&nbsp;in&nbsp;error,&nbsp;please&nbsp;notify&nbsp;the&nbsp;sender&nbsp;(and&nbsp;delete&nbsp;it&nbsp;from&nbsp;your&nbsp;systems)&nbsp;immediately.&nbsp;The&nbsp;information&nbsp;herein&nbsp;is&nbsp;not&nbsp;warranted&nbsp;to&nbsp;be&nbsp;free&nbsp;of&nbsp;virus&nbsp;or&nbsp;any&nbsp;other&nbsp;defect&nbsp;that&nbsp;may&nbsp;affect&nbsp;the&nbsp;recipient&#39;s&nbsp;computer&nbsp;system&nbsp;and&nbsp;it&nbsp;is&nbsp;your&nbsp;responsibility&nbsp;to&nbsp;carry&nbsp;out&nbsp;appropriate&nbsp;virus&nbsp;checks&nbsp;of&nbsp;this&nbsp;email&nbsp;and&nbsp;attachments&nbsp;(if&nbsp;any).&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-size:10pt;font-family:Arial&quot;&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small&quot;&gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-size:10pt;font-family:Arial&quot;&gt;******************************&lt;wbr&gt;******************************&lt;wbr&gt;******************&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small&quot;&gt;&lt;/span&gt;&lt;br&nbsp;style=&quot;color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small&quot;&gt;
</tt>
